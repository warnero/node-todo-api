<!DOCTYPE html><html><head><title>Coverage</title><script>

headings = [];

onload = function(){
  headings = document.querySelectorAll('h2');
};

onscroll = function(e){
  var heading = find(window.scrollY);
  if (!heading) return;
  var links = document.querySelectorAll('#menu a')
    , link;

  for (var i = 0, len = links.length; i < len; ++i) {
    link = links[i];
    link.className = link.getAttribute('href') == '#' + heading.id
      ? 'active'
      : '';
  }
};

function find(y) {
  var i = headings.length
    , heading;

  while (i--) {
    heading = headings[i];
    if (y >= heading.offsetTop) {
      return heading;
    }
  }
}
</script>
<style>

body {
  font: 14px/1.6 "Helvetica Neue", Helvetica, Arial, sans-serif;
  margin: 0;
  color: #2C2C2C;
  border-top: 2px solid #ddd;
}

#coverage {
  padding: 60px;
}

h1 a {
  color: inherit;
  font-weight: inherit;
}

h1 a:hover {
  text-decoration: none;
}

.onload h1 {
  opacity: 1;
}

h2 {
  width: 80%;
  margin-top: 80px;
  margin-bottom: 0;
  font-weight: 100;
  letter-spacing: 1px;
  border-bottom: 1px solid #eee;
}

a {
  color: #8A6343;
  font-weight: bold;
  text-decoration: none;
}

a:hover {
  text-decoration: underline;
}

ul {
  margin-top: 20px;
  padding: 0 15px;
  width: 100%;
}

ul li {
  float: left;
  width: 40%;
  margin-top: 5px;
  margin-right: 60px;
  list-style: none;
  border-bottom: 1px solid #eee;
  padding: 5px 0;
  font-size: 12px;
}

ul::after {
  content: '.';
  height: 0;
  display: block;
  visibility: hidden;
  clear: both;
}

code {
  font: 12px monaco, monospace;
}

pre {
  margin: 30px;
  padding: 30px;
  border: 1px solid #eee;
  border-bottom-color: #ddd;
  -webkit-border-radius: 2px;
  -moz-border-radius: 2px;
  -webkit-box-shadow: inset 0 0 10px #eee;
  -moz-box-shadow: inset 0 0 10px #eee;
  overflow-x: auto;
}

img {
  margin: 30px;
  padding: 1px;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
  -webkit-box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  -moz-box-shadow: 0 3px 10px #dedede, 0 1px 5px #888;
  max-width: 100%;
}

footer {
  background: #eee;
  width: 100%;
  padding: 50px 0;
  text-align: right;
  border-top: 1px solid #ddd;
}

footer span {
  display: block;
  margin-right: 30px;
  color: #888;
  font-size: 12px;
}

#menu {
  position: fixed;
  font-size: 12px;
  overflow-y: auto;
  top: 0;
  right: 0;
  margin: 0;
  height: 100%;
  padding: 15px 0;
  text-align: right;
  border-left: 1px solid #eee;
  -moz-box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  -webkit-box-shadow: 0 0 2px #888
     , inset 5px 0 20px rgba(0,0,0,.5)
     , inset 5px 0 3px rgba(0,0,0,.3);
  -webkit-font-smoothing: antialiased;
  background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGYAAABmCAMAAAAOARRQAAABelBMVEUjJSU6OzshIyM5OjoqKy02NjgsLS01NTYjJCUzNTUgISMlJSc0NTUvMDA6PDwlJyg1NjYoKis2NjYrLS02ODkpKyw0NDYrLC04ODovLzA4Ojo0NDUtLy86OjwjIyU4OTosLS82ODgtLS8hIyQvMTEnKCooKSsrKy0qLCwkJSUnKCkrLCwpKiwwMjIxMzMqLC0tLS0pKissLC00NTYwMDIwMTQpKysoKSovMDEtLzA2OTkxMzUrKywvLy8qKyszNTY5OzsqKiw6OjswMDExNDUoKiozNDUvMDIyNDY1Njg2Njk5OTozMzU0NjY4ODkiIyUiIyQ4OTkuMDEmKCowMjQwMTErLS4qKywwMTMhIiMpKiopKy0tLjAkJScxNDQvLzExNDYyNDQmKCk5OTslJig5OjskJSYxMzQrLS8gISIwMTIoKCk1NTUlJSUnJygwMDA4ODgiIiMhISI8PDw6Ojo5OTkpKSojIyQ7OzsyMjIpKSssLCw6Ozw1NjlrfLakAAAg2UlEQVR42jR6i3ea6rYvPgANIAhVXh8WvkQlioUiFlFcBtAmoiRNdzxqu9p0J7vrdK29zuPeex77nnvO/35n1r1ndHRktI0jTOacv/l7lCBK5UqVpOha/YxmWK7BC4TQFKVXrbYsnimqxuuMVlOQ0XltWjUdCwRJ1M+tC1KudOs9q6+da2adUewG0SC0SwELfHtgDds93VEuydEbl3QMWeNoYkR7b/0x1ZRobGI3mLwzAhePqTAwhg6aogjNsGy7/jwQ4rkdqe7CWLxF8k9LfMVFyRS7VJqtkrW8Vt/bkR8FZJao16ipknbC3Yw2lM7laO6HBEOadEZ2tpf65c4v8e3u7FyU6qbiNNyCuzXZ6pawgnwgmrpTT/Q7w2EZmiIJ0dzWDI7mhQ80IfRnMu2kzA5r5r1pIFoia+/d93HRYp1GV8TbrkWoU/+jdI0Ff6yGwTjT1Hn8J+8m1rKpGiYPuNiHnMtNMIv+zpsk84MYTNW1/+DpwXLvckdOCMYowVNPREe0QlM8xRHXXFhcNDzupwsSmb5pH+0t0RP2Qk+QtI7F1Qm6JRC6ZPBtPq/dq/kH+jxtCljn9TIpW6rQIgmSVyj6lPICIw4N/taka41PFUInth0je9+jO6Kt1G4/a7V2LEgG02B0pHVuCZrgltSKMuIl5SyufUv9mYuQi+mFgzbBEtFo2g+Dh4sSTrLNu8JPh00sQydpb00tqXBvqRN7Q7kqzcnIxCGnvZt/WmJacoOEO6Dcn8Qre03pOCSQxbMOXUuDNx9SxuLz4W1I18gvjViQ67zV0rxdWL8Te/TQkuo8STS41DR48W7L6YP2uWIqiUV8rd6Gbf/rnegKZeG8TpAM6afhGze9JAOxbLjsnUXEbrZ9vLYd7MT32cPF5mKKxmjy7huaoD9n62GOxni3iIJwv0IzZAZjdZkUtolCNLVfYZNaquFjGszVVf+J0vrz4CawoKdHnOzb0NMH7CDBOybfYNJ4rfeMyFNjkFYVTzMFs87rnPGXLUOeNKRVc0LnU7/UIgelzsy3CMuth0YfvnY0wsD3vODUL3eJcKqHQpm8yM3XZQWJxO6Un9iYloyyLpOwN2obHy6W6gbpcb44XmyC+mg+itAcaprGcrwZCqMj/GmtKn0zPvpTz/Cv1dw21XwP3cRupg3H3MF/S71eTKj1YrdwKdc2Mw0fRmb2sFf8lW3aU6JbIZSEPqvXvjM7G/aApyXlXeqKfMq0g/Su3rUGJPSPrtGElgknrZM3xUXqsAP6zMCNVn5u8aJnSNpJv2uru7t2jfRziW2+GuhqfldUNbPk71olwo+46ePUo1U3WKk/e5YK07F/wGRgcpODmQnIlVeHCWBE4puBi2jq28UKpqiN1/4UOrGz59TNYrrQHtd+11sG40BGD+pXdelNqGOg4NXe8W4eacJV/NS9/2Umtym6WQqveqR9xdCMElpxnbkalM4Vf9uaEcWZaKdyibEIjWKxJZPN95niCL3GiaXyssIrHxoLkqkzLCXULN46/f2h3tQJgyip+Tk9EAjJ9aJshq7t8X45aowSKspMSvPf7r9R8yxNptIaHS5ozuEm6luPDApugyNP8OaqiQ4BjaequXA54SLC83eHIY2r+CZp4409Xqw8Aa2oI7XkCrQi+in0w5AqF/kLNrcUz+qkl/lAobY1jSnx5OJNhyXIz3qfNFlXc0TKaglNwdWkWYt9QQ1Kr6W8zue21iNrdJk+N5oCr2O9nEtWKC7IS5J/zdDEYrmnAYfg6agCy+qcgz7ZofeDc4PbUWSvkshWuAc7OjiUyLkj+RAtdlwXJcjxdpkTTHDhK8lBCi8+JtvDVL1W6elmOM++YS0LuSlaP1oUvAeiW3cFnvTr8EbTz1tsSMYdGeZe40sRWu5uAfj7q+ZoKv2FNQ0p5XY1lmlcigHZqTPpabufEVrNuNPi165w3uCVQJHyJqmSJ7ZHnguqwtCmwViIJijj04ba2JNYtB+yORf5gg1/9t9iw4vUpeqiunSAbf+IBdj/b+iG2qrHvuNP0Vd/+ThVZT/lrvHYjjgDbbyxaqgHNM2uhxa1GW3UedZYhMMwM4mQhltouK+IV4NdbIQNM+8Yv311RZk9kT4tiYR4LkyFcuPpdcjuhUuFqBAWRZa11lcZ3gEBlXywsNhrt+plISZP5DlsV9l4EgY6J3yZPTUcMrgaWAT3oI79eSbGEbcJpr6BD8kyDiVt+G0/hXosQN4NFXKlfWIfsIs0BHODVok1/IGnKFHJYIquh8Xo+2+bkQNTGgWmN/fZ0Y33LSj6lr1GyV7mWIKg7ZTRZPGuhF/zjRNcQ1UPtSYgnWQxSs0yrVhwNDcdGMNSNe2JT3WuzbAM3HykyAajS3Uphf6STKEqxLas9EnmnhA/lyj9Uj+JoY7SVgVmGLl46Rm2u98sbkap2lzAdKBG4r6LgulQOSSjQv1GWdQ0jtDUK/mAaqM1Uqjpu4k3Rvfvxv7YTxLSK+wN3E5jVIzmF23uZ7hiH/sVP49D7tvoKp4S8b1LuvRlivVB/algbhcFITYVXvDpLzpDfplR2uD5V4XJFxpjmIpLc9Y5sB2TpBRix7Bme6GZIq+06v3XzNeTcA4obQIKxrnT4C2JpOqD92dbmSX8MGazly5EsZVMvSU1f4RZwyu8iQXbVdeLlZrjuTT1jrY1uk5c7iZ7RsvhhluqAkq4JpVQAg7RJFtSu+xgJ8Pv6O1j5DkLxT8mkbfyRW5DrQmG7hiDIjCgBsADbjuof6YHLGeV6a5Q1Smx9joUXPpdaaDx97A/Wq00oJkdR7ZYuQRfS533JtxO1erduqWOYIt3wh0wpbLuCNIYkwxbswbikCUu2CDCS+Q+7rgVtfRcm+SOcdKPRlZ/rE7wNVUEE39KTS5uvUKN1PUnkloPkyzhyGQ8qkouEjJ3H/VXdqG6asSRiw3ecMlBvDDt8dDhBHXMwZ2Cajzjr7/76T+IavqPYvz6r7//E/3X3+N//h/0QozbjPgPiir69P/8X3/9F/yv8b/827/++98WItPu5/Hvwd8YPf5bp/2/lX/T/+Of/0MJ/lYTa+L/Ef+d9vN/3/2T6P/+jyTzu/evf6U7vxN7B6pJkRtAF6jUr8I+P8RsP/ptGhfqFk+pQ/DgAy6NJtRYJdXmp4gK7WLqLKJ+MaKhGjOojvL+SnIWrkpy0SLHDe4QuyNzaEA15mLMCcmE8Em+4HdOihW4/ZWuppJEmzeAwcDtv7MuLc9y2V5atvxXNe3S4DUMt5/Qy2LM9kSYKiVWBuKlfp4nxTntpuW03JbIlkiRvBXmT23g1I2OYe6IizUHPIq6zm6mbfsbteKmi/sg9J+ocQBMctGFO7iljo8TPN+z3jxw4do+ZwfqoR9dkNTKHyM305GpTkfhcHexVkPVGEbUOjuo9f0UMPHBFlGEx0SLvJvVRKTwW7PSew5oPme+E42+frJa9cGt2njS3dK5kIif2eYbhuSEQXEqMVfUjhGIuin0G0/W5ezJyJQy3SpMLai4M0JUWb5u1k9tny5bd1pPwYBpQuDCXZl62xg4CdVEAtflXHs6JKmP/pH6mOl796Lgopj0o8d5kKh00hxG3OSdEE/QBo9Hgr8JJqAeLDwJohG5j/DGh61Rc/+tf22/8kEnxHNCEjo0ElvvGfESZkqmz2BDcKV1H1buSkhkdg7p1IMGs2s17nYjpblrWuE2K9WEO/hcRp5e9oOF/QBmOaDtgil+oaU6szPrdwW65fOB0KUTsVUn7LFU7J8e6cxJIl9+FHw5MQMzuQJ+4oxMH3iW/5GK+hWuG0T+gTLs+fAjdtUd58TmIUq04EeyRCYCjkldow234aIgR5bqwrtZosZ+6YEqAmDqatJ9lWasz4IquKALPtd92hGI3Z2BdzzZue+REl1Om4DIWD+RrtUTOJLI+S0jHowXXdAxsGLSd40zYNuEUlOGhrwL6c7tcOtUOvpJCP7QBQS19H+GvZn05ewjlVLz+IGKoC9TyfQjLMBNmXCuqqtTdOSukZW48B0HqgSTCBrBnlFvF4CG2Su7yFzqmJFURK3UmTT3ru050r0ptUpMilYnBJWfl2Bv6kPlUuE1kxxpdzui9AubsR2N2boVSu81OulAwBqoSr1LZ0LLYOomyZHmjqnXlP72s8LnDouEJjtodBvdHaG1jMySYO7crWd90MpCRyCG14vb5IE7Arupw/y/RcCm/Tm3zK6zYj8PYNaGldiUfkB/LHWcmf2lVM+mwyU27a0qq2tscrQ/vzBjN26DnntIrOyGizzXK35yKQdYnUABkyN4saz3WD/viF+eCcsXnIajdWYJWaYHRstIis9CS+tqnFGmz2j5uzfr3Z4prqgK4XOT/PyftvjZqIm8lhkfxJ7Ol3CJF1piYBGAG8wtAk56Drw1YwmOpcz+NdfkSpSLplRXLXHL0Rquj6YW/gabqgK7Dgr6NwtH0B/AN7XrN+MVJ6AmXmUuqmQulrNNYPmH0RoDogydOKLo/QbfYNARSQQKISRCzRXU+q9WWJFL3LZW6u34CkeG97xC0NNGaJ0bvK6SnZS3zPskr5EtuCgjMWR5o2x5BqhKmDWJPRe7JMEOyRb5uUKlHaGVtq5ivSOaSliSXp9SQm2qk8MRJh10MAp9QQ2H5t59J8rjiwSZtoIfMGjlLPVNdYl/LBR0AO6WLGDmkLkIPRE45Y9MftdAK/yNu1Hn6tzOQTesgQ+8fSzB19wO91vCnO23vOWQdwJ63SJrYjdfKFW6W281PKs2k8iT9ai1cgJ4sa3xqdvmtxR8/+D1B8AKc2u+6JftryRhMWSQtoSBgIyyQGyxcnELuAasXN12oSriU4RMz1DD6RL0TSV+om7i1Yt+jEE/jnawM8cX/UhN4nkiv/w9eALrzNhXuQfOzFL0Fi6SjF7/4Qn8rLYBoa85cvgAnkCEBP+HPbEnquVXCZsMS/yzYw2Vru60P/+nJPYKkzZFjmbykzUoEqV836T5q3fP/L383dF82tx18/AZgZczMAgyeWYKmSZIqtHL+e+O4ZRcq9VI3g/qPeCoiK4pcgEqdbS0S/Be54sbVQOuJVPNBblIghzeasNu7h/g+Sz1IdhI5lCwq1nUb3Ji4OCIcqQZqtqJ5w7rXrg/DA9IgVmEGhDgGecEwnCTHffXcXs0V3OCEVzYDKS1vp/oX+ng+6XVU86UjA6FMO2RXOOOrqY1GgPvrAk9HV/BXtCu5RuwF8qgdGDLsBcui4E33ymdBip1X8uKyhIWT8qNRDsXz+gvO9UiEC0d8RG4Tf2x8H4slljgHtCBcxHLTWOYJm5H/fCPCzOgf9qgOUxTRZ0Pc6ha5yLuLVT9ntvIa6gacE99mCovdUumTQdRP4RPsS9129eEe2uSvvGh0bV4Y3QPPhPZMqhZWSMa5R0Hc1SGO4IVOQc0FrirlibTVfKRrYkD8kz3b+X65/QkUNaZdrdl3mCap0Hf3YcCw/LiouJYNbqz88UqeDYv93yO7vvXtgl4XCyAO4ODkY6W+83+LZU//p3/zXNGGrUKClCiOnL27iJZbNWDF02XXAOeFlB7IaADoMH1Yqr+UP9biyZDEa/iJt4MDeIz6GKTdLVBfWGVtRN4fdT2rgReX8UXwF2zOrradm4J0nyTgdPnai3RvzpZvCKDUqjOwD/QA6EDaMCLewX6QWYVnHY1sx1bd8ovYnPm1ZvPH+rE20lWjOCnZ66/xDt0QAl15FjfBcZp+i9OU0RNPQ0t3x2pSNWo8eiYudwsnuP1Hq6iH1LJCJynkYsfgJ0p3pF6SoQk2l+jqE8CPk+ziGJRSKjs+W5AO185umPdkYzlK4wl7TC9NxyyDP7ZoyYVoXiuS6SjnInlLWrwz1i8bGTKXX0AVQWkSfIlglW3zRJRJ8bg5VgE6ZEnqNu9B++0GNQvDQJvFize4ESNKBJP+8vA3LM4AX5SIBq08Mob+7QMTCZx4nwP/64+4BnlZC+8WtlP/CXw6t1PwMwkJ3jhP1FiXLhDF/3I6FGUzO2DSi9ABxKyyL9paZxSEz40ZCPQToDAJu1959k7QdbVxgB4icsu2s4zsTPJhcEDo+N1GX4zSk/wriRh8AqwL62972i9HJHd1ydaLXVzvKvOfGGw5RVcUVMiKXFH4APdkQU/dc5BX0YfKTNZYXCW9mb8bc8mufoQP6BbdQmT99ZjoYfr/go4TgQX9IDgztim7wyFeGMfbNaeqj8Dzs38pgcqwSv2hbqB3oSGKWKy+sesY7p57wAHldqE6NDudk/W7s/zjrK4rZFlFvaGxnSZdHbc1y47qDN6xkoK8O3bfr2j41dlJZ71rB4dlDqapPFa8N6xBrprUdtenUCHwxKNhw1uuTBh+9uU45k4REpQABN2bAO9DSLqoIL26gNroWgup5pUMxHUNSq4Gyz47vBPvilpo5f9OYI2ddAqTqmnxXERxQJ3UK8fHbVE9HagHi3+tqNRoNsArdmAxHA5LwtQo9ZAaNKUTljnokljo2x8scqVpEEIPc01fPCdHOCg0DeWBz8D5TVAAfx8aRH5X2ZYNI3ebKDZdeJ+oBDAxmRqJ30Eh2/DaeAy5diVNMpEDmXiPDsGTzBLXy8eVDdJoIafgx/gxMyQi454QrW56nCyeELgSuNNEmYkflF+t3CZQOVRWjKhIuCclmQSlAXT3+4JGG75B4t/5hQ+ldMP4LsAW6z3XmU6IJJwpnGVnsgUZhoY1fZlwTR8wSU7xRejf2uCx9Z5trVTRRJP9KnEb134dEieil6eCOGWgboI7xsqsqM99jfJLTePjygKlH2CVxxsse9QRzTBFjD/Kjqitr/CCTBt/SJ6nLxz7cKP9pFqBpp0lN5y+adKNsZjrPuroemZauH9aTTFD3EKHW8S55XBLFQAt1jgxTQCTwxmx/JyfsZDN1RroN3VaxpSenpIX7K+ZbL8VdlQDcI4Cbzg3QJLa9yVqNxUelu+EtxLVqeekaAvSJkO6sSVqbUajxqhKshNpvZqoeApF0k/0P0ikkwUcbdwc4A1ejN7Oo0O15kG7hTMoK3hZRBCX7YYeLW0wvcXx/18n/u37yLgzBYVBUvORGli+sfRcX/74uD6P4hq+7xu54TlWJLFzT63uwUDwuEDdOjJQqx7JV+ZjaEAPi7t0MMrR4Q8Rkf18uxD6RK0RKh0hL8YU+DeL97i4pa5ZSyAfXKwZRS/8gXcxdZXm62RBDj8U3sN8x95b5PpPs/mCBKYvpaA50pN5Ct/499AFTtwQ5vgeSh+NHrKIi4NVpwM/XzRaNfJD856lPE6M21zWPguFsH7jbLVyEDfRmt4VwrhCJ5VTYmcSPfGgO5clfN+vbaDZ7sakU5+2vZ2WCDY031NxJarVytfDDVtiafcTGO2rJ/taoL3zChN2qmjxofczTOYQPPVQPh0JVtYgdUQINcSiNEEy58UdYXX1MpWUCEBx7LbcGtAm8XWRQTVOaoV3ySri4RShhs/B/0m4jX6OAwXOvcA09bNSG4czEGv/Wey6V/jbTCNTW6awXdNTcA1GsPe1E9fZdGl7R0vyoVpIdJtfC6d32NNErrvq/R+d65VG+YOwRXppXxOCYyGNSf1K3x6VxAW/vtz4EC1SgCOSPdN62sLsoIzuDfg8GwZAbquVO8HIuFP/ToVoeUB7nnwMF35a1wK1tI6fkrqFKhQdeJpwyls0pIy8AZde3/6LUUbFaYJthyUJSU/kqDXTLQElnn0Jr4B2RVghNrmNmoEn7pXIeshPguXVsvwoTdmClq49JJU3LWhHyWTrJL9bRP6VKv3tZoA/th77p5Jw++OEENvyvWy/pNeExiDUVQaXIRGh8xySZTI36yueFaSXo1uJY0RnXYgEOoWWOJHeaVuX/bGNhHsh2yinznl/++NJcE9j6fBPRcBdq9hb8awNw8U7Bl6GM7x69EDOIIbX/npZ++amlHR9L/35mE/2Ss4gb0xCcY4VyTFLRE796vHysLAamqcyO+aFQyJIDBNslbH2/MrAvZiSEIedc/cqjmv4fbda2pXbv+F5a2szSsdkm9noiNURXt8edUhGUF6fSZWd1IJaXKFwD+49R6eCXD4Bkef7j9tRtNMVgW8BhRz/Qpy1TmeYk0doyjZoJSbePOReVHgkFsCFuQJ+Lgc4BxeAsK/cOiNDRmdNw0ctYhn/nQ498dYI5znzGLoJi1rav7Cn88rL3wLePVtDK5gl77Tki3gHEsIAQ2+IKgarj7Y8W1IQzV5V9N+0TjLqbg68WfKcOmBCOj3JkwJhVIkwDhc+JorXuZEPMEh0vvH3x7iqf+VAwXgd4diZiaJD1zHL9Snx6Wfg4IugreyhabQkcir+y5XgDtdx3Avs7lkeeCBwDvZoTUCXx5QrZkcEqWfYEiEYRs/EphmRALSNGR1Iclgdr5VFoELpzF4++f35w3/j0t5ucW3n2ch4PQCLuUXupsPRR7UA5FjSKrMtPcKAZJfagO4lGE7FH3YKMjorpK0ZxAv+i2JkJhtAMWWWFej4RhPR/cJ3DxwocCvXDi4SGZU4cu+K32XndiFWgopAl+0GApcwf1XvymJcFs39jExIBO4yUjU9MExBLQYc9H+W7+IgdESPRpciT+rKZPebVtaVq+1GYO/5xTAL3HASjNTGIgMvdjWbgc7JvdE1zIFpuC0U9ESiZyzBixzxWxj4Kwh8My34q+FK3KNLtmsA1qyrmKSNQOXCPUZd+ONelBTvFoUI/CYsqa/RhtKiyMf2CgSFqEPk59Y3uqnlZ8gFpswfSYyko23yVZYxzKGxGm49Zqxg1l8oz5Ra9XaRwHkuxepmgyhm0SoNy2KlbcEqK+9QqS9PNx9Ihm9U7gsR55SSJ1FBDNnkuWKxIZ0SDpXuOGwZdoUbOMDPHP4vBAgz2VlSEJAHZGJVbYIg7l/FO5KfIVvxC8pPPxMGcNMoevFDeStt2iqztE10n2TA4dgJH76YS9HDhKHD3iCx6ieFX84BAI3QQnngh76f5ruPQVbr5qZmck/5UjDc26lfrOvUBWy0Ogl8bCoOkMOns81TnC3cuUS9KW8+9A+fe3XYZOFUPG1u5epSSmDLw0s5s2F0W30ANeo+zJkJQz9SPZgzwYpEoktofhGVfmLOAB20boCbW1QWq/NpET/hnMecw/uSyAH4NJc3ECOU4nnkK1fj3S/i5dwb3R7k00AqQQUwt7Ie1qV0aY/VQX0J8hLPy7eBNXMHYZYDNxHZ2Qh6AuXJxq+AeRec/Q+JLhZV6hpXwQEzw7bf5v9uUf2vpq3qlhmy0IIGTkwYdCfSAFmqbdo+3XvDTDjFJde0mbeQLcn2n31xaAqJ0ixO/CLsT4I4G4DoncVTgRGNBtsCcjISWT+oeXZ4Iedw/8OsJI1aPnNKLX/60VvcZb94uasRxCkqlPQ11u1Sa2hHvB80WQENxVyzjns0/PiEByyil21Te6oisk3mNCEMrhouCFO3yEZTHHOCMy9eb/4Tmi8cVf3Lf7P53SY2hX3PSN033As3ETIMLHWumWEO9JXHA2y2SIBlIPpLGG2qvNsCIlIr+B1SWAqRKm2w6Blf7U+zCSBwJrfHG5i8J5Gax/cVonMlon7aHJX/gSvucIncRP93XCqkv7D8IFKFsLiBgHqUpXhE3pYjEcV1dk/JD9zFVCfEaQIVX8Jmfz7IIofcBKQ4OaG+C3xC2veX9CD+iAFXDNaGg9eTVxvkbJRJlW4Nk9Wk13kn696jWppRDe/8pDrYMO9ZyxZ98ReKSz9kWKLLyk2zCZgAniCkLJVX3n1M9DYbomyahWiv/KixRIV9hj/oFz87I+HLznbPTjpa+D+bZQnMuRsljTpv90vQUt/pK7jCFnA30B/jtroSF2/m/gpWn1aQs5WeA6ghzF8SdqWI20fghdSeDOCSCmLgTkfaGgGDmw7nHFkRzGtag57IHS2na06I+gzEphXo1w/Zx2BM/jKL2nZoFjHggtFQjYi8nSVRSXIE58RPbBObXk7uuIL9+rs/5Zo7suJInEUxgsiZZAWS25iBtpEiZeBgDtghEoAE0sjcayNq85M4tbu/LF5h51335PsGzQ09O875+vUS89lkWMyNOFoip2PuyWyMP/iU2XIZdfCCJNDjebDoBLQdpy7QQZC7s9c0wjHJervQNDu2jWzBW5MSAJMr7bP+Iv92BkS/GGgzjEn7MF1IRKFwwzbjbS4/slGOmhx9cZrFu7HSEefojNv3r0UaKfKOWzXsq1zEugbzlMDFsacRJJI/iJlK3vtkZ+PLZIVMFlKA32wbq2Kd5T0uCLZ1CPkAfCdzkz2EYscjDcZq2AWfziN2covN4kXE1lQXPPLTNM1xx3tbiepcO/t3SWm4w87qfh99SL0ZnY+LKFPLPeXVM2mIIoVWt+9Nk0I7nY4O79iGYqxZ8RVz289an6NVdJWnSKZvJQCAuHNiVaDxPAFoH392t9wot5t0/qmU95eEWNbU2udUW5sN9JVqcYlvAIfLeYC33oUzzxZgSktsv21mA7Uly1FA5VnoJFh6N244Wmv3YJGFv/TCPryaw+ZORlpZjQdq/2DYXr3EZskfed0G61P09ipTKmlTQ1067Rg5+PAk5FlQ9e0SWbGf2B/08kqymOTMVOznsALHHNFH4LFRKl2F/NOiYFl9khNHnSu9Ak5sq26Ynl/i2fdTle29Y1ugqmR5Yj4YT9pvslFyYCbw0mNFr5rVQm1LvkG27QMq9ph3t8fmn6r6SQ4oSbr5tz+J1kIawGzDxb6VYOvvWhobDTXfBeNv3b4aNm5XUinsCGqG2q/45m3+LoCOsddFceYhRx1Tsss9PLdPfJdErFMjYd3gddjiP0+XQjcRadZP6bwNLySvunFf20Czy6JqdEW2a96KxdYdOryBv1BjbuUq2yCHeh+6sk7fGmmPi50pe/1l5TyPe5oHW9oPnhPswLyf2TFDdCyYlhwBCstv5C1HwlW7xWoGT9XZt4qVj5WryLPLLD6h/5cMLEjWzgCeAIKNsLak92aBqBsHl4AJwl2N4jfvbSkBExGimv0nFvv09uDScQbjx+w4kPQjgjlW+g9ws9VEJvI2k8N6XxVu0uIwovgTFdunG24gBtaDi+y1YLQwZ8mwbip5fVlO3k0n0AEr/ETbtu8Vjkm+nNSiEb7X/3fMjBL5A8PdgG+/FnbexbFFExmEfetXAnisEKy5z44WVPpQZjSy/jzeGn4yDRsFGqhh87QPaDBWhlo37IFbe/C0xynS91d2tP/AJoJS0sVF6iwAAAAAElFTkSuQmCC");
}

#menu::after {
  display: block;
  content: '';
  padding-top: 80px;
}

#logo {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background: rgba(255,255,255,.1);
  font-size: 11px;
  display: block;
  width: 20px;
  height: 20px;
  line-height: 20px;
  text-align: center;
  -webkit-border-radius: 20px;
  -moz-border-radius: 20px;
  -webkit-box-shadow: 0 0 3px rgba(0,0,0,.2);
  -moz-box-shadow: 0 0 3px rgba(0,0,0,.2);
  color: inherit;
}

#menu li a {
  display: block;
  color: white;
  padding: 0 35px 0 25px;
  -webkit-transition: background 300ms;
  -moz-transition: background 300ms;
}

#menu li {
  position: relative;
  list-style: none;
}

#menu a:hover,
#menu a.active {
  text-decoration: none;
  background: rgba(255,255,255,.1);
}

#menu li:hover .cov {
  opacity: 1;
}

#menu li .dirname {
  opacity: .60;
  padding-right: 2px;
}

#menu li .basename {
  opacity: 1;
}

#menu .cov {
  background: rgba(0,0,0,.4);
  position: absolute;
  top: 0;
  right: 8px;
  font-size: 9px;
  opacity: .6;
  text-align: left;
  width: 17px;
  -webkit-border-radius: 10px;
  -moz-border-radius: 10px;
  padding: 2px 3px;
  text-align: center;
}

#stats:nth-child(2n) {
  display: inline-block;
  margin-top: 15px;
  border: 1px solid #eee;
  padding: 10px;
  -webkit-box-shadow: inset 0 0 2px #eee;
  -moz-box-shadow: inset 0 0 2px #eee;
  -webkit-border-radius: 5px;
  -moz-border-radius: 5px;
}

#stats div {
  float: left;
  padding: 0 5px;
}

#stats::after {
  display: block;
  content: '';
  clear: both;
}

#stats .sloc::after {
  content: ' SLOC';
  color: #b6b6b6;
}

#stats .percentage::after {
  content: ' coverage';
  color: #b6b6b6;
}

#stats .hits,
#stats .misses {
  display: none;
}

.high {
  color: #00d4b4;
}
.medium {
  color: #e87d0d;
}
.low {
  color: #d4081a;
}
.terrible {
  color: #d4081a;
  font-weight: bold;
}

table {
  width: 80%;
  margin-top: 10px;
  border-collapse: collapse;
  border: 1px solid #cbcbcb;
  color: #363636;
  -webkit-border-radius: 3px;
  -moz-border-radius: 3px;
}

table thead {
  display: none;
}

table td.line,
table td.hits {
  width: 20px;
  background: #eaeaea;
  text-align: center;
  font-size: 11px;
  padding: 0 10px;
  color: #949494;
}

table td.hits {
  width: 10px;
  padding: 2px 5px;
  color: rgba(0,0,0,.2);
  background: #f0f0f0;
}

tr.miss td.line,
tr.miss td.hits {
  background: #e6c3c7;
}

tr.miss td {
  background: #f8d5d8;
}

td.source {
  padding-left: 15px;
  line-height: 15px;
  white-space: pre;
  font: 12px monaco, monospace;
}

code .comment { color: #ddd }
code .init { color: #2F6FAD }
code .string { color: #5890AD }
code .keyword { color: #8A6343 }
code .number { color: #2F6FAD }
</style></head><body><div id="coverage"><h1 id="overview">Coverage</h1><div id="menu"><li><a href="#overview">overview</a></li><li><span class="cov high">75</span><a href="#/Users/warner/code/clipppr/primeloop-api/config/errors.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/config/</span><span class="basename">errors.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/warner/code/clipppr/primeloop-api/config/index.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/config/</span><span class="basename">index.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/warner/code/clipppr/primeloop-api/config/permissions/client.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/config/permissions/</span><span class="basename">client.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/warner/code/clipppr/primeloop-api/config/permissions/notebook.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/config/permissions/</span><span class="basename">notebook.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/warner/code/clipppr/primeloop-api/config/permissions/user.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/config/permissions/</span><span class="basename">user.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/warner/code/clipppr/primeloop-api/config/redis.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/config/</span><span class="basename">redis.js</span></a></li><li><span class="cov high">89</span><a href="#/Users/warner/code/clipppr/primeloop-api/config/routes.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/config/</span><span class="basename">routes.js</span></a></li><li><span class="cov medium">68</span><a href="#/Users/warner/code/clipppr/primeloop-api/config/server.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/config/</span><span class="basename">server.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/warner/code/clipppr/primeloop-api/config/settings.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/config/</span><span class="basename">settings.js</span></a></li><li><span class="cov medium">51</span><a href="#/Users/warner/code/clipppr/primeloop-api/controllers/actions.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/controllers/</span><span class="basename">actions.js</span></a></li><li><span class="cov medium">73</span><a href="#/Users/warner/code/clipppr/primeloop-api/controllers/auth.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/controllers/</span><span class="basename">auth.js</span></a></li><li><span class="cov high">76</span><a href="#/Users/warner/code/clipppr/primeloop-api/controllers/billing.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/controllers/</span><span class="basename">billing.js</span></a></li><li><span class="cov high">78</span><a href="#/Users/warner/code/clipppr/primeloop-api/controllers/campaigns.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/controllers/</span><span class="basename">campaigns.js</span></a></li><li><span class="cov terrible">6</span><a href="#/Users/warner/code/clipppr/primeloop-api/controllers/clipps.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/controllers/</span><span class="basename">clipps.js</span></a></li><li><span class="cov low">43</span><a href="#/Users/warner/code/clipppr/primeloop-api/controllers/comments.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/controllers/</span><span class="basename">comments.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/warner/code/clipppr/primeloop-api/controllers/coupons.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/controllers/</span><span class="basename">coupons.js</span></a></li><li><span class="cov terrible">20</span><a href="#/Users/warner/code/clipppr/primeloop-api/controllers/errors.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/controllers/</span><span class="basename">errors.js</span></a></li><li><span class="cov terrible">13</span><a href="#/Users/warner/code/clipppr/primeloop-api/controllers/geico.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/controllers/</span><span class="basename">geico.js</span></a></li><li><span class="cov low">44</span><a href="#/Users/warner/code/clipppr/primeloop-api/controllers/google.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/controllers/</span><span class="basename">google.js</span></a></li><li><span class="cov terrible">6</span><a href="#/Users/warner/code/clipppr/primeloop-api/controllers/notebooks.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/controllers/</span><span class="basename">notebooks.js</span></a></li><li><span class="cov terrible">6</span><a href="#/Users/warner/code/clipppr/primeloop-api/controllers/pages.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/controllers/</span><span class="basename">pages.js</span></a></li><li><span class="cov high">82</span><a href="#/Users/warner/code/clipppr/primeloop-api/controllers/plans.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/controllers/</span><span class="basename">plans.js</span></a></li><li><span class="cov terrible">6</span><a href="#/Users/warner/code/clipppr/primeloop-api/controllers/reports.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/controllers/</span><span class="basename">reports.js</span></a></li><li><span class="cov medium">52</span><a href="#/Users/warner/code/clipppr/primeloop-api/controllers/stats.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/controllers/</span><span class="basename">stats.js</span></a></li><li><span class="cov terrible">11</span><a href="#/Users/warner/code/clipppr/primeloop-api/controllers/suggested_actions.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/controllers/</span><span class="basename">suggested_actions.js</span></a></li><li><span class="cov terrible">7</span><a href="#/Users/warner/code/clipppr/primeloop-api/controllers/suggested_clipps.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/controllers/</span><span class="basename">suggested_clipps.js</span></a></li><li><span class="cov low">41</span><a href="#/Users/warner/code/clipppr/primeloop-api/controllers/tracking.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/controllers/</span><span class="basename">tracking.js</span></a></li><li><span class="cov medium">53</span><a href="#/Users/warner/code/clipppr/primeloop-api/controllers/users.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/controllers/</span><span class="basename">users.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/action.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">action.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/activitylog.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">activitylog.js</span></a></li><li><span class="cov terrible">11</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/batch_import.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">batch_import.js</span></a></li><li><span class="cov high">90</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/client.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">client.js</span></a></li><li><span class="cov low">47</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/clipp.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">clipp.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/clipp_conversions.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">clipp_conversions.js</span></a></li><li><span class="cov medium">66</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/comment.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">comment.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/coupon.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">coupon.js</span></a></li><li><span class="cov medium">59</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/customer.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">customer.js</span></a></li><li><span class="cov high">90</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/email.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">email.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/emailactivitylog.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">emailactivitylog.js</span></a></li><li><span class="cov low">37</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/notebook.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">notebook.js</span></a></li><li><span class="cov medium">68</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/page.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">page.js</span></a></li><li><span class="cov high">88</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/page_engagement.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">page_engagement.js</span></a></li><li><span class="cov high">88</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/page_error.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">page_error.js</span></a></li><li><span class="cov low">25</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/payment.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">payment.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/plan.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">plan.js</span></a></li><li><span class="cov high">90</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/report_additions.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">report_additions.js</span></a></li><li><span class="cov medium">52</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/suggested_action.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">suggested_action.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/suggested_action_view_template.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">suggested_action_view_template.js</span></a></li><li><span class="cov terrible">7</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/suggested_batch_import.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">suggested_batch_import.js</span></a></li><li><span class="cov terrible">18</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/suggested_clipp.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">suggested_clipp.js</span></a></li><li><span class="cov low">44</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/suggested_clipp_error.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">suggested_clipp_error.js</span></a></li><li><span class="cov terrible">21</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/tracker.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">tracker.js</span></a></li><li><span class="cov medium">73</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/tracking_page.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">tracking_page.js</span></a></li><li><span class="cov high">96</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/tracking_url.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">tracking_url.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/tracking_url_activity.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">tracking_url_activity.js</span></a></li><li><span class="cov medium">72</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/user.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">user.js</span></a></li><li><span class="cov high">93</span><a href="#/Users/warner/code/clipppr/primeloop-api/models/user_waiting.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/models/</span><span class="basename">user_waiting.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/warner/code/clipppr/primeloop-api/test/utils/data.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/test/utils/</span><span class="basename">data.js</span></a></li><li><span class="cov terrible">19</span><a href="#/Users/warner/code/clipppr/primeloop-api/test/utils/helpers.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/test/utils/</span><span class="basename">helpers.js</span></a></li><li><span class="cov high">92</span><a href="#/Users/warner/code/clipppr/primeloop-api/utils/archive.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/utils/</span><span class="basename">archive.js</span></a></li><li><span class="cov high">78</span><a href="#/Users/warner/code/clipppr/primeloop-api/utils/array.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/utils/</span><span class="basename">array.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/warner/code/clipppr/primeloop-api/utils/auth.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/utils/</span><span class="basename">auth.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/warner/code/clipppr/primeloop-api/utils/errors.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/utils/</span><span class="basename">errors.js</span></a></li><li><span class="cov terrible">8</span><a href="#/Users/warner/code/clipppr/primeloop-api/utils/feed_parsing.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/utils/</span><span class="basename">feed_parsing.js</span></a></li><li><span class="cov medium">57</span><a href="#/Users/warner/code/clipppr/primeloop-api/utils/google.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/utils/</span><span class="basename">google.js</span></a></li><li><span class="cov medium">69</span><a href="#/Users/warner/code/clipppr/primeloop-api/utils/intercom.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/utils/</span><span class="basename">intercom.js</span></a></li><li><span class="cov high">88</span><a href="#/Users/warner/code/clipppr/primeloop-api/utils/json.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/utils/</span><span class="basename">json.js</span></a></li><li><span class="cov high">83</span><a href="#/Users/warner/code/clipppr/primeloop-api/utils/objects.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/utils/</span><span class="basename">objects.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/warner/code/clipppr/primeloop-api/utils/permissions.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/utils/</span><span class="basename">permissions.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/warner/code/clipppr/primeloop-api/utils/smart_quote_removal.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/utils/</span><span class="basename">smart_quote_removal.js</span></a></li><li><span class="cov medium">66</span><a href="#/Users/warner/code/clipppr/primeloop-api/utils/string.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/utils/</span><span class="basename">string.js</span></a></li><li><span class="cov high">75</span><a href="#/Users/warner/code/clipppr/primeloop-api/utils/urls.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/utils/</span><span class="basename">urls.js</span></a></li><li><span class="cov high">100</span><a href="#/Users/warner/code/clipppr/primeloop-api/utils/validations.js"><span class="dirname">/Users/warner/code/clipppr/primeloop-api/utils/</span><span class="basename">validations.js</span></a></li><a id="logo" href="http://visionmedia.github.com/mocha/">m</a></div><div id="stats" class="low"><div class="percentage">44%</div><div class="sloc">5918</div><div class="hits">2636</div><div class="misses">3282</div></div><div id="files"><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/config/errors.js">/Users/warner/code/clipppr/primeloop-api/config/errors.js</h2><div id="stats" class="high"><div class="percentage">75%</div><div class="sloc">24</div><div class="hits">18</div><div class="misses">6</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var util = require(&quot;util&quot;);</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">var CustomErrors = function(restify){</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">    //Custom errors</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">7</td><td class="hits">13</td><td class="source">    var TrailExpiredError = function(errors) {</td></tr><tr class="miss"><td class="line">8</td><td class="hits">0</td><td class="source">        restify.RestError.call(this, {</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">            restCode: 'TrailExpiredError',</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">            statusCode: 403,</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">            message: errors,</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">            constructorOpt: TrailExpiredError</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        });</td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="source">        this.name = 'TrailExpiredError';</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">17</td><td class="hits">13</td><td class="source">    var PlanLimitReachedError = function(errors) {</td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="source">        restify.RestError.call(this, {</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">            restCode: 'PlanLimitReachedError',</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">            statusCode: 402, //Payment Required status code</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">            message: errors,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">            constructorOpt: PlanLimitReachedError</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        });</td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">        this.name = 'PlanLimitReachedError';</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">28</td><td class="hits">13</td><td class="source">    var InvalidInputError = function(errors) {</td></tr><tr class="hit"><td class="line">29</td><td class="hits">17</td><td class="source">        restify.RestError.call(this, {</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">            restCode: 'InvalidInputError',</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">            statusCode: 400,</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">            message: errors,</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">            constructorOpt: InvalidInputError</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        });</td></tr><tr class="hit"><td class="line">35</td><td class="hits">17</td><td class="source">        this.name = 'InvalidInputError';</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">38</td><td class="hits">13</td><td class="source">    var NotPaidError = function(message) {</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">        restify.RestError.call(this, {</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">            restCode: 'NotPaidError',</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">            statusCode: 400,</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">            message: message,</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">            constructorOpt: NotPaidError</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">        });</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">        this.name = 'NotPaidError';</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">48</td><td class="hits">13</td><td class="source">    var UserRegisteredError = function(message) {</td></tr><tr class="hit"><td class="line">49</td><td class="hits">1</td><td class="source">        restify.RestError.call(this, {</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">            restCode: 'UserRegisteredError',</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">            statusCode: 400,</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">            message: message,</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">            constructorOpt: UserRegisteredError</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">        });</td></tr><tr class="hit"><td class="line">55</td><td class="hits">1</td><td class="source">        this.name = 'UserRegisteredError';</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">    </td></tr><tr class="hit"><td class="line">58</td><td class="hits">13</td><td class="source">    util.inherits(InvalidInputError, restify.RestError);</td></tr><tr class="hit"><td class="line">59</td><td class="hits">13</td><td class="source">    util.inherits(UserRegisteredError, restify.RestError);</td></tr><tr class="hit"><td class="line">60</td><td class="hits">13</td><td class="source">    util.inherits(NotPaidError, restify.RestError);</td></tr><tr class="hit"><td class="line">61</td><td class="hits">13</td><td class="source">    util.inherits(TrailExpiredError, restify.RestError);</td></tr><tr class="hit"><td class="line">62</td><td class="hits">13</td><td class="source">    util.inherits(PlanLimitReachedError, restify.RestError);</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">64</td><td class="hits">13</td><td class="source">    return {</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">        PlanLimitReachedError: PlanLimitReachedError,</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">        TrailExpiredError: TrailExpiredError,</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">        InvalidInputError: InvalidInputError,</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">        NotPaidError: NotPaidError,</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">        UserRegisteredError: UserRegisteredError</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">73</td><td class="hits">1</td><td class="source">module.exports = CustomErrors;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/config/index.js">/Users/warner/code/clipppr/primeloop-api/config/index.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">5</div><div class="hits">5</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var Config = function(server) {</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var server_config = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/./server&quot;)(server);</td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">    var routes = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/./routes&quot;)(server);</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">    </td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">    return require(&quot;/Users/warner/code/clipppr/primeloop-api/config/./settings&quot;);</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">module.exports = Config;</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/config/permissions/client.js">/Users/warner/code/clipppr/primeloop-api/config/permissions/client.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">1</div><div class="hits">1</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">module.exports =</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">{</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">    &quot;phoenix&quot;: {</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        &quot;permissions&quot;: [</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">           </td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        ]</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">    </td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">    &quot;falkor&quot; : {</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        &quot;permissions&quot;: [</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">            &quot;list_pages&quot;,</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">            &quot;add_page&quot;,</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">            &quot;update_page&quot;</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        ],</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        &quot;inherits&quot;: [&quot;phoenix&quot;]</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    &quot;geico&quot; : {</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        &quot;permissions&quot;: [</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">            &quot;view_all_accounts&quot;</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        ],</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        &quot;inherits&quot;: [&quot;phoenix&quot;, &quot;falkor&quot;]</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/config/permissions/notebook.js">/Users/warner/code/clipppr/primeloop-api/config/permissions/notebook.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">1</div><div class="hits">1</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">module.exports =</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">{</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">    &quot;owner&quot;: {</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        &quot;permissions&quot;: [</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">            &quot;delete_notebook&quot;,</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">            &quot;invite_owner&quot;,</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">            &quot;edit_editors&quot;,</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">            // &quot;edit_owners&quot;,</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">            &quot;purchase_notebook&quot;</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        ],</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        &quot;inherits&quot;: [&quot;editor&quot;, &quot;contributor&quot;, &quot;viewer&quot;]</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    &quot;editor&quot;: {</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        &quot;permissions&quot;: [</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">            &quot;edit_notebook&quot;,</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">            &quot;export_data&quot;,</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">            &quot;invite_users&quot;,</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">            &quot;edit_contributors&quot;,</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">            &quot;edit_viewers&quot;,</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">            &quot;edit_clipp&quot;,</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">            &quot;edit_clipp_tags&quot;,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">            &quot;archive_clipp&quot;,</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">            &quot;can_report&quot;,</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">            &quot;connect_analytics&quot;,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">            &quot;connect_analytics_invite&quot;</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        ],</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        &quot;inherits&quot;: [&quot;contributor&quot;, &quot;viewer&quot;]</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    &quot;contributor&quot;: {</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        &quot;permissions&quot;: [</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">            &quot;add_clipp_to_notebook&quot;,</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">            &quot;clipp_comment&quot;,</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">            &quot;edit_clipp_description&quot;,</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">            &quot;add_tags_to_clipp&quot;,</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">            &quot;add_to_report&quot;,</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">            &quot;view_suggested_actions_feed&quot;,</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">            &quot;take_suggested_action&quot;</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        ],</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">        &quot;inherits&quot;: [&quot;viewer&quot;]</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">    &quot;viewer&quot;: {</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">        &quot;permissions&quot;: [</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">            &quot;view_notebook_clipps&quot;,</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">            &quot;view_clipp_details&quot;,</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">            &quot;view_notebooks&quot;,</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">            &quot;pay_for_notebook&quot;,</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">            &quot;manage_payment_info&quot;,</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">            &quot;view_collaborators&quot;</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">        ]</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">    &quot;campaign_owner&quot;: {</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">        &quot;permissions&quot;: [</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">            &quot;edit_notebook&quot;,</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">            &quot;delete_notebook&quot;,</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">            &quot;invite_owner&quot;,</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">            &quot;edit_managers&quot;,</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">            // &quot;edit_owners&quot;,</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">            &quot;purchase_notebook&quot;</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">        ],</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">        &quot;inherits&quot;: [&quot;campaign_manager&quot;, &quot;campaign_collaborator&quot;]</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">    &quot;campaign_manager&quot; :{</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">        &quot;permissions&quot;: [</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">            &quot;export_data&quot;,</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">            &quot;invite_users&quot;,</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">            &quot;edit_collaborators&quot;,</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">            &quot;connect_analytics&quot;,</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">            &quot;connect_analytics_invite&quot;</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">        ],</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">        &quot;inherits&quot;: [&quot;campaign_collaborator&quot;]</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">    &quot;campaign_collaborator&quot;: {</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">        &quot;permissions&quot;: [</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">            &quot;view_notebooks&quot;,</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">            &quot;pay_for_notebook&quot;,</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">            &quot;manage_payment_info&quot;,</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">            &quot;view_collaborators&quot;,</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">            &quot;create_retargeting_url&quot;</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">        ]</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/config/permissions/user.js">/Users/warner/code/clipppr/primeloop-api/config/permissions/user.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">1</div><div class="hits">1</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">module.exports =</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">{</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">    &quot;general&quot;: {</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        &quot;permissions&quot;: [</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">            &quot;manage_notebooks&quot;,</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">            &quot;add_notebook&quot;,</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">            &quot;manage_profile&quot;,</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">            &quot;manage_account&quot;,</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">            &quot;feedback&quot;</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        ]</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    &quot;super-admin&quot; : {</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        &quot;permissions&quot;: [</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">            &quot;act_as_user&quot;</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        ],</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        &quot;inherits&quot;: [&quot;admin&quot;, &quot;contractor&quot;, &quot;general&quot;, &quot;caas&quot;]</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    &quot;admin&quot; : {</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        &quot;permissions&quot;: [</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">            &quot;list_plans&quot;,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">            &quot;edit_subscription&quot;,</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">            &quot;create_plans&quot;,</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">            &quot;remove_plans&quot;,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">            &quot;list_coupons&quot;,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">            &quot;create_coupons&quot;,</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">            &quot;remove_coupons&quot;,</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">            &quot;view_all_activity&quot;,</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">            &quot;view_all_accounts&quot;,</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">            &quot;add_all_account_types&quot;,</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">            &quot;view_reports&quot;,</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">            &quot;cancel_account&quot;,</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">            &quot;view_waiting_list&quot;,</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">            &quot;edit_waiting_list&quot;,</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">            &quot;add_page&quot;,</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">            &quot;update_page&quot;,</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">            &quot;view_page&quot;,</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">            &quot;view_notebook_page&quot;,</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">            &quot;import_links_to_account&quot;,</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">            &quot;add_new_account&quot;,</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">            &quot;edit_accounts&quot;,</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">            &quot;add_notebook_to_account&quot;,</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">            &quot;edit_notebook_on_account&quot;,</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">            &quot;update_clipp_counts&quot;,</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">            &quot;ghost_user&quot;,</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">            &quot;list_pages&quot;,</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">            &quot;update_errors&quot;,</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">            &quot;list_errors&quot;,</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">            &quot;add_contractor_to_account&quot;,</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">            &quot;view_admin_links&quot;,</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">            &quot;suggested_actions&quot;,</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">            &quot;view_all_suggested_actions&quot;</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">        ],</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">        &quot;inherits&quot;: [&quot;contractor&quot;, &quot;general&quot;, &quot;caas&quot;]</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">    &quot;caas&quot;: {</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">        &quot;permissions&quot;: [</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">            &quot;view_clipping_service&quot;,</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">            &quot;import_links_to_account&quot;</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">        ],</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">        &quot;inherits&quot;: [&quot;general&quot;]</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">    &quot;contractor&quot;: {</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">        &quot;permissions&quot;: [</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">            &quot;show_clipps&quot;,</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">            &quot;update_clipps&quot;</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">        ]</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">    &quot;reseller&quot;: {</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">        &quot;permissions&quot;: [</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">            &quot;list_plans&quot;,</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">            &quot;view_referred_accounts&quot;,</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">            &quot;add_new_account&quot;,</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">            &quot;view_referred_notebook_page&quot;,</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">            &quot;add_notebook_to_referred_account&quot;,</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">            &quot;import_links_to_referred_account&quot;,</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">            &quot;edit_notebook_on_referred_account&quot;,</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">            &quot;list_coupons&quot;,</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">            &quot;create_coupons&quot;,</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">            &quot;remove_coupons&quot;</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">        ],</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">        &quot;inherits&quot;: [&quot;general&quot;]</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/config/redis.js">/Users/warner/code/clipppr/primeloop-api/config/redis.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">6</div><div class="hits">6</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var Redis = function(){</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/./settings&quot;),</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        redis = require(&quot;redis&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        rclient = redis.createClient(</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">            Settings.redis.options.port, </td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">            Settings.redis.options.host, </td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">            Settings.redis.options</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        );</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">    redis.debug_mode = Settings.redis.debug;</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">    if(Settings.redis.options.pass) rclient.auth(Settings.redis.options.pass);</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">    return rclient;</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">module.exports = Redis;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/config/routes.js">/Users/warner/code/clipppr/primeloop-api/config/routes.js</h2><div id="stats" class="high"><div class="percentage">89%</div><div class="sloc">79</div><div class="hits">71</div><div class="misses">8</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var Routes = function(server) {</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/./settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        ErrorUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/../utils/errors&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        auth = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/../controllers/auth&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        notebooks = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/../controllers/notebooks&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        campaigns = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/../controllers/campaigns&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        stats = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/../controllers/stats&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        billing = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/../controllers/billing&quot;),</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        clipps = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/../controllers/clipps&quot;),</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        suggested_clipps = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/../controllers/suggested_clipps&quot;),</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        suggested_actions = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/../controllers/suggested_actions&quot;),</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        pages = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/../controllers/pages&quot;),</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        comments = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/../controllers/comments&quot;),</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        actions = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/../controllers/actions&quot;),</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        tracking = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/../controllers/tracking&quot;),</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        users = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/../controllers/users&quot;),</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        plans = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/../controllers/plans&quot;),</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        coupons = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/../controllers/coupons&quot;),</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        errors = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/../controllers/errors&quot;),</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        reports = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/../controllers/reports&quot;),</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        google = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/../controllers/google&quot;),</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        geico = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/../controllers/geico&quot;);</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">28</td><td class="hits">1</td><td class="source">    var ActionRoutes = function(){</td></tr><tr class="hit"><td class="line">29</td><td class="hits">1</td><td class="source">        server.post(&quot;/actions&quot;, auth.general, actions.add);</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        //auth.verifyMailgun,</td></tr><tr class="hit"><td class="line">31</td><td class="hits">1</td><td class="source">        server.post(&quot;/mailgun/actions&quot;, auth.verifyMailgun, actions.emailAction);</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">    }();</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">34</td><td class="hits">1</td><td class="source">    var WidgetRoutes = function() {</td></tr><tr class="hit"><td class="line">35</td><td class="hits">1</td><td class="source">        server.get(&quot;/widgets&quot;, function(req, res) {</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">            var data = Settings.widgets[req.params.type || req.params.widget_type];</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">            if(data) data.success = true;</td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">            else data = {success: false};</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">            return res.send(data);</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">    }();</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">44</td><td class="hits">1</td><td class="source">    var BillingRoutes = function(){</td></tr><tr class="hit"><td class="line">45</td><td class="hits">1</td><td class="source">        server.post(&quot;/plans&quot;, auth.clientOrUser, plans.create);</td></tr><tr class="hit"><td class="line">46</td><td class="hits">1</td><td class="source">        server.del(&quot;/plans/:id&quot;, auth.clientOrUser, plans.remove);</td></tr><tr class="hit"><td class="line">47</td><td class="hits">1</td><td class="source">        server.get(&quot;/plans/:id&quot;, plans.get); //public if the requester has the id</td></tr><tr class="hit"><td class="line">48</td><td class="hits">1</td><td class="source">        server.get(&quot;/plans&quot;, auth.clientOrUser, plans.list);</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">50</td><td class="hits">1</td><td class="source">        server.get(&quot;/coupons&quot;, auth.clientOrUser, coupons.list);</td></tr><tr class="hit"><td class="line">51</td><td class="hits">1</td><td class="source">        server.post(&quot;/coupons&quot;, auth.clientOrUser, coupons.create);</td></tr><tr class="hit"><td class="line">52</td><td class="hits">1</td><td class="source">        server.del(&quot;/coupons/:id&quot;, auth.clientOrUser, coupons.remove);</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">54</td><td class="hits">1</td><td class="source">        server.get(&quot;/billing/current-month&quot;, auth.general, billing.currentMonth);</td></tr><tr class="hit"><td class="line">55</td><td class="hits">1</td><td class="source">        server.get(&quot;/billing/invoices&quot;, auth.general, billing.invoices);</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">    }();</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">58</td><td class="hits">1</td><td class="source">    var GoogleRoutes = function(){</td></tr><tr class="hit"><td class="line">59</td><td class="hits">1</td><td class="source">        server.get(&quot;/google/auth-url&quot;, google.getAuthUrl);</td></tr><tr class="hit"><td class="line">60</td><td class="hits">1</td><td class="source">        server.post(&quot;/google/auth-token&quot;, google.getAuthTokenAndUserData);</td></tr><tr class="hit"><td class="line">61</td><td class="hits">1</td><td class="source">        server.get(&quot;/google/adwords/campaigns&quot;, auth.clientOrUser, google.getAdwordsCampaigns);</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">    }();</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">64</td><td class="hits">1</td><td class="source">    var UserRoutes = function(){</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">        // server.get(&quot;/user/sales&quot;, auth.general, users.sales);</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">        // server.put(&quot;/free-account&quot;, users.createFreeUser);</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">        // server.del(&quot;/users/:id&quot;, auth.general, users.cancel); //cancel's a user's account</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">        // server.post(&quot;/users&quot;, auth.general, users.add); //for admins to create users</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">        // server.get(&quot;/users&quot;, auth.general, users.list); //for admins to view accounts</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">        // server.get(&quot;/users/:id&quot;, auth.general, users.view); //for admins to view accounts</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">        // server.post(&quot;/users/:id/trial&quot;, auth.general, users.startATrial, auth.refreshSessionData);</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">        //Login</td></tr><tr class="hit"><td class="line">78</td><td class="hits">1</td><td class="source">        server.get(&quot;/user&quot;, auth.general, auth.refreshSessionData, users.current);</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">        //Find</td></tr><tr class="hit"><td class="line">81</td><td class="hits">1</td><td class="source">        server.get(&quot;/users/find&quot;, auth.superAdmin, users.find);</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">        //Registration endpoints</td></tr><tr class="hit"><td class="line">84</td><td class="hits">1</td><td class="source">        server.get(&quot;/invite/:id&quot;, users.invited);</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">        // server.post(&quot;/users/:id/register&quot;, users.register);</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">        // server.post(&quot;/users/register&quot;, users.registerNoInvite);</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">        // server.post(&quot;/users/register/prelim&quot;, users.prelimRegister);</td></tr><tr class="hit"><td class="line">88</td><td class="hits">1</td><td class="source">        server.post(&quot;/users/register/retarget&quot;, users.retargetRegisterNoInvite);</td></tr><tr class="hit"><td class="line">89</td><td class="hits">1</td><td class="source">        server.post(&quot;/users/register/retarget/prelim&quot;, users.retargetPrelimRegister);</td></tr><tr class="hit"><td class="line">90</td><td class="hits">1</td><td class="source">        server.post(&quot;/users/register/activate-retarget&quot;, users.retargetRegisterActivate);</td></tr><tr class="hit"><td class="line">91</td><td class="hits">1</td><td class="source">        server.post(&quot;/users/register/welcome&quot;, users.sendWelcomeEmail);</td></tr><tr class="hit"><td class="line">92</td><td class="hits">1</td><td class="source">        server.post(&quot;/users/:id/register/retarget&quot;, users.retargetRegister);</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">        //Updating users</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">        // server.put(&quot;/users/:id&quot;, auth.general, auth.refreshSessionData, users.update, auth.refreshSessionData);</td></tr><tr class="hit"><td class="line">96</td><td class="hits">1</td><td class="source">        server.post(&quot;/users/:id/settings&quot;, auth.general, auth.refreshSessionData, users.updateSettings, auth.refreshSessionData);</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">        // server.post(&quot;/users/:id/subscriptions&quot;, auth.general, users.subscribe, auth.refreshSessionData);</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">        // server.put(&quot;/users/:id/subscriptions&quot;, auth.general, users.subscriptionUpdate, auth.refreshSessionData);</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">        // server.del(&quot;/users/:id/subscriptions&quot;, auth.general, users.unsubscribe, auth.refreshSessionData);</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">101</td><td class="hits">1</td><td class="source">        server.post(&quot;/users/:id/retarget/subscriptions&quot;, auth.general, users.retargetSubscribe, auth.refreshSessionData);</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">104</td><td class="hits">1</td><td class="source">        server.post(&quot;/waiting/users&quot;, users.addToWaitingList);</td></tr><tr class="hit"><td class="line">105</td><td class="hits">1</td><td class="source">        server.put(&quot;/waiting/users/:id&quot;, users.updateWaitingListUser);</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">        // server.get(&quot;/waiting/users/:id/no-analytics-email&quot;, users.sendNoAnalyticsEmail);</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">        // server.put(&quot;/waiting/users/:id/demo&quot;, users.createDemoUser);</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">109</td><td class="hits">1</td><td class="source">        server.post(&quot;/waiting/users/:id/tags&quot;, auth.general, users.addWaitingListTag);</td></tr><tr class="hit"><td class="line">110</td><td class="hits">1</td><td class="source">        server.post(&quot;/waiting/users/invite/:id/tags&quot;, users.addWaitingListInviteTag);</td></tr><tr class="hit"><td class="line">111</td><td class="hits">1</td><td class="source">        server.del(&quot;/waiting/users/:id/tags&quot;, auth.general, users.removeWaitingListTag);</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">        // server.get(&quot;/waiting/users&quot;, auth.general, users.getWaitingList);</td></tr><tr class="hit"><td class="line">113</td><td class="hits">1</td><td class="source">        server.get(&quot;/waiting/users/:user_id&quot;, auth.general, users.getWaitingListUser);</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">        // server.get(&quot;/leads/:id&quot;, auth.general, users.getLead);</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">116</td><td class="hits">1</td><td class="source">        server.post(&quot;/reset/step1&quot;, users.resetPasswordStep1);</td></tr><tr class="hit"><td class="line">117</td><td class="hits">1</td><td class="source">        server.get(&quot;/reset/step2&quot;, users.validateEmailToken);</td></tr><tr class="hit"><td class="line">118</td><td class="hits">1</td><td class="source">        server.post(&quot;/reset/step2&quot;, users.resetPasswordStep2);</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">        // server.get(&quot;/inactive-report&quot;, auth.general, users.inactiveList);</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">        // server.get(&quot;/users/:id/activity&quot;, auth.general, users.activity);</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">        // server.get(&quot;/users/:id/tags&quot;, auth.general, users.getTags);</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">    }();</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">127</td><td class="hits">1</td><td class="source">    var CampaignRoutes = function(){</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">129</td><td class="hits">1</td><td class="source">        server.get(&quot;/campaigns&quot;, auth.general, campaigns.list);</td></tr><tr class="hit"><td class="line">130</td><td class="hits">1</td><td class="source">        server.get(&quot;/campaigns/:id&quot;, auth.anonymous, auth.refreshSessionData, campaigns.view);</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">132</td><td class="hits">1</td><td class="source">        server.post(&quot;/campaigns&quot;, auth.general, auth.refreshSessionData, campaigns.add);</td></tr><tr class="hit"><td class="line">133</td><td class="hits">1</td><td class="source">        server.post(&quot;/campaigns/:id&quot;, auth.general, campaigns.update);</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">135</td><td class="hits">1</td><td class="source">        server.post(&quot;/campaigns/:id/retarget-campaign&quot;, auth.general, campaigns.addRetargetCampaign);</td></tr><tr class="hit"><td class="line">136</td><td class="hits">1</td><td class="source">        server.put(&quot;/campaigns/:id/retarget-campaign/:campaignId&quot;, auth.general, campaigns.updateRetargetCampaign);</td></tr><tr class="hit"><td class="line">137</td><td class="hits">1</td><td class="source">        server.del(&quot;/campaigns/:id/retarget-campaign/:campaignId&quot;, auth.general, campaigns.removeRetargetCampaign);</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">139</td><td class="hits">1</td><td class="source">        server.post(&quot;/campaigns/:id/retarget-url&quot;, auth.general, campaigns.addShortUrl);</td></tr><tr class="hit"><td class="line">140</td><td class="hits">1</td><td class="source">        server.post(&quot;/campaigns/:id/tracking/:trackingId/activity&quot;, auth.clientOrUser, campaigns.addShortUrlActivity);</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">142</td><td class="hits">1</td><td class="source">        server.post(&quot;/campaigns/:id/users&quot;, auth.general, campaigns.invite);</td></tr><tr class="hit"><td class="line">143</td><td class="hits">1</td><td class="source">        server.del(&quot;/campaigns/:campaign/users/:id&quot;, auth.general, campaigns.removeUser, auth.refreshSessionData);</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">145</td><td class="hits">1</td><td class="source">        server.put(&quot;/campaigns/:campaign/waiting-user/:id&quot;, campaigns.updateCampaignForWaitingUser);</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">    }();</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">149</td><td class="hits">1</td><td class="source">    var StatsRoutes = function(){</td></tr><tr class="hit"><td class="line">150</td><td class="hits">1</td><td class="source">        server.get(&quot;/sharing/team-stats&quot;, auth.general, stats.teamStats);</td></tr><tr class="hit"><td class="line">151</td><td class="hits">1</td><td class="source">        server.get(&quot;/sharing/recent-stats&quot;, auth.general, stats.recentlyShared);</td></tr><tr class="hit"><td class="line">152</td><td class="hits">1</td><td class="source">        server.get(&quot;/sharing/popular-links&quot;, auth.general, stats.popularLinks);</td></tr><tr class="hit"><td class="line">153</td><td class="hits">1</td><td class="source">        server.get(&quot;/sharing/links-vs-clicks&quot;, auth.general, stats.linksVsClicks);</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">    }();</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">156</td><td class="hits">1</td><td class="source">    var SuperAdminRoutes = function() {</td></tr><tr class="hit"><td class="line">157</td><td class="hits">1</td><td class="source">        server.post(&quot;/admin/act-as-user&quot;, auth.superAdmin, auth.actAsUser, auth.refreshSessionData);</td></tr><tr class="hit"><td class="line">158</td><td class="hits">1</td><td class="source">        server.del(&quot;/admin/act-as-user&quot;, auth.superAdmin, auth.clearActAsUser, auth.refreshSessionData);</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">    }();</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">    // var NotebookRoutes = function(){</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">    //     server.post(&quot;/notebooks/:id/analytics-invite&quot;, auth.general, notebooks.analyticsInvite);</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">    //     server.get(&quot;/notebooks&quot;, auth.general, notebooks.list);</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">    //     server.get(&quot;/notebooks/:id&quot;, auth.anonymous, auth.refreshSessionData, notebooks.checkTrialStatus, notebooks.view);</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">    //     server.post(&quot;/notebooks/:id/request&quot;, auth.optional, notebooks.requestAccess);</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">    //     server.get(&quot;/notebooks/:id/tags&quot;, auth.general, auth.refreshSessionData, notebooks.checkTrialStatus, notebooks.getTags);</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">    //     server.post(&quot;/notebooks&quot;, auth.general, auth.refreshSessionData, notebooks.add);</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">    //     server.post(&quot;/notebooks/:id&quot;, auth.general, notebooks.checkTrialStatus, notebooks.update);</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">    //     server.del(&quot;/notebooks/:id&quot;, auth.general, notebooks.archive);</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">    //     server.post(&quot;/notebooks/:id/users&quot;, auth.general, notebooks.checkTrialStatus, notebooks.invite);</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">    //     server.del(&quot;/notebooks/:notebook/users/:id&quot;, auth.general, notebooks.removeUser, auth.refreshSessionData);</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">    //     server.put(&quot;/notebooks/:notebook/users/:id&quot;, auth.general, notebooks.updateUser, auth.refreshSessionData);</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">    //     server.get(&quot;/notebooks/:notebook/pages&quot;, auth.general, notebooks.checkTrialStatus, notebooks.pages);</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">    //     server.get(&quot;/notebooks/:notebook/pages/:id&quot;, auth.general, notebooks.checkTrialStatus, notebooks.page);</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">    //     server.get(&quot;/batches/:batch&quot;, auth.general, notebooks.getBatch);</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">    //     server.get(&quot;/admin/batches/:batch&quot;, auth.general, notebooks.getBatchAdmin);</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">    //     server.get(&quot;/expired-trial-report&quot;, auth.general, notebooks.expiredTrialList);</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">    //     server.post(&quot;/notebooks/:id/convert-to-free&quot;, auth.general, notebooks.convertNotebookToFree);</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">    //     server.get(&quot;/batches-suggested/:batch&quot;, auth.general, notebooks.getSuggestedBatch);</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">    //     server.get(&quot;/admin/batches-suggested/:batch&quot;, auth.general, notebooks.getSuggestedBatchAdmin);</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">    //     server.get(&quot;/admin/ga-notebooks&quot;, auth.general, notebooks.gaNotebookList);</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">    //     server.get(&quot;/admin/suggested-actions-notebooks&quot;, auth.general, notebooks.suggestedActionNotebookList);</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">    //     server.get(&quot;/admin/notebooks&quot;, auth.general, notebooks.allNotebooks );</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">    //     server.get(&quot;/admin/notebooks/:id&quot;, auth.general, notebooks.adminNotebookView);</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source">    //     server.post(&quot;/admin/notebooks/:id/features&quot;, auth.general, notebooks.addFeature);</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source">    //     server.get(&quot;/caas/notebooks&quot;, auth.general, notebooks.notebooksForCAAS );</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">    //     server.get(&quot;/caas/notebooks/:id&quot;, auth.general, notebooks.notebookForCAAS );</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">    //     server.post(&quot;/notebooks/:notebook/purchase/reporting&quot;, auth.general, notebooks.purchaseReporting);</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">    // }();</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">    // var ClippRoutes = function(){</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">    //     server.get(&quot;/clipps/:id/url&quot;, clipps.getPublicClipp);</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source">    //     server.get(&quot;/notebooks/:notebook/clipps&quot;, auth.anonymous, notebooks.checkTrialStatus, clipps.list);</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source">    //     server.get(&quot;/notebooks/:notebook/export&quot;, auth.general, clipps.exportData);</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">    //     server.get(&quot;/notebooks/:notebook/new-clipps&quot;, auth.general, notebooks.checkTrialStatus, clipps.listNewOnly);</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">    //     server.get(&quot;/notebooks/:notebook/clipps/:id&quot;, auth.anonymous, notebooks.checkTrialStatus, clipps.view);</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source">    //     server.get(&quot;/notebooks/:notebook/clipps/:id/url&quot;, clipps.viewURL);</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">    //     server.post(&quot;/notebooks/:notebook/clipps&quot;, auth.general, notebooks.checkTrialStatus, clipps.add);</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source">    //     server.put(&quot;/notebooks/:notebook_id/clipps/:id&quot;, auth.general, clipps.update);</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">    //     server.del(&quot;/notebooks/:notebook/clipps/:id&quot;, auth.general, notebooks.checkTrialStatus, clipps.archive);</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">    //     server.del(&quot;/notebooks/:notebook/clipps/:id/tags&quot;, auth.general, notebooks.checkTrialStatus, clipps.removeTag);</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">    //     server.get(&quot;/notebooks/:notebook/clipps/:id/actions&quot;, auth.general, actions.listClippActions);</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source">    //     // server.post(&quot;/notebooks/:notebook/clipps/:id/short-url&quot;, auth.general, clipps.addShortUrl);</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source">    //     // server.post(&quot;/notebooks/:notebook/clipps/short-url&quot;, auth.general, clipps.createClipAndShortUrl);</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source">    //     server.get(&quot;/caas/notebooks/:notebook/clipps&quot;, auth.general, clipps.adminCaasList );</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">    //     server.get(&quot;/admin/notebooks/:notebook/clipps&quot;, auth.general, clipps.adminList);</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source">    // }();</td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source">    // var SuggestedClippsRoutes = function() {</td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source">    //     server.post(&quot;/notebooks/:notebook/suggested-clipps&quot;, auth.general, suggested_clipps.importClipps);</td></tr><tr><td class="line">229</td><td class="hits"></td><td class="source">    //     server.get(&quot;/notebooks/:notebook/suggested-clipps&quot;, auth.general, notebooks.checkTrialStatus, suggested_clipps.list);</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">    //     server.get(&quot;/notebooks/:notebook/suggested-clipps/init&quot;, auth.general, suggested_clipps.init);</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">    //     server.del(&quot;/notebooks/:notebook/suggested-clipps&quot;, auth.general, suggested_clipps.archiveClipps);</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">    //     server.post(&quot;/notebooks/:notebook/suggested-clipps/move-to-nb&quot;, auth.general, suggested_clipps.addClippsToNotebook);</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">    //     server.get(&quot;/admin/notebooks/:notebook/suggested-clipps&quot;, auth.general, suggested_clipps.adminList);</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">    // }();</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source">    // var SuggestedActionsRoutes = function() {</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">    //     server.get(&quot;/suggested-actions&quot;, auth.general, suggested_actions.userList);</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source">    //     server.put(&quot;/suggested-actions/:id&quot;, auth.general, suggested_actions.doAction);</td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source">    //     server.get(&quot;/notebooks/:notebook/suggested-actions&quot;, auth.general, notebooks.checkTrialStatus, suggested_actions.list);</td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source">    //     server.post(&quot;/notebooks/:notebook/suggested-actions&quot;, auth.general, notebooks.checkTrialStatus, suggested_actions.add);</td></tr><tr><td class="line">243</td><td class="hits"></td><td class="source">    //     server.put(&quot;/notebooks/:notebook/suggested-actions/:action&quot;, auth.general, notebooks.checkTrialStatus, suggested_actions.update);</td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source">    // }();</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source">    // var PageRoutes = function(){</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">    //     server.get(&quot;/page-report&quot;, auth.general, pages.pageReport);</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source">    //     server.get(&quot;/pages&quot;, auth.clientOrUser, pages.list);</td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source">    //     server.get(&quot;/stream/pages&quot;, auth.clientOrUser, pages.listStream);</td></tr><tr><td class="line">253</td><td class="hits"></td><td class="source">    //     server.get(&quot;/stream/pages/comments&quot;, auth.clientOrUser, pages.listCommentStream);</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">    //     server.get(&quot;/manual/pages_count&quot;, auth.clientOrUser, pages.updateCount);</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source">    //     server.get(&quot;/manual/pages&quot;, auth.clientOrUser, pages.listForManualUpdating);</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source">    //     server.get(&quot;/pages/:id&quot;, auth.clientOrUser, pages.view);</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source">    //     server.post(&quot;/pages&quot;, auth.clientOrUser, pages.add);</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source">    //     server.put(&quot;/pages/:id&quot;, auth.clientOrUser, pages.update);</td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source">    //     server.get(&quot;/manual/pages/no_pub_date&quot;, auth.clientOrUser, pages.noPubDate);</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source">    //     server.get(&quot;/manual/pages/no_pub_date_to_be_updated&quot;, auth.clientOrUser, pages.noPubDateToBeUpdated);</td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source">    // }();</td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">267</td><td class="hits"></td><td class="source">    // var CommentRoutes = function(){</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source">    //     server.post(&quot;/comments&quot;, auth.clientOrUser, comments.upsertMany);</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">    // }();</td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source">    // var ErrorsRoutes = function() {</td></tr><tr><td class="line">272</td><td class="hits"></td><td class="source">    //     server.get(&quot;/errors/:type&quot;, auth.clientOrUser, errors.list);</td></tr><tr><td class="line">273</td><td class="hits"></td><td class="source">    //     server.get(&quot;/errors/:type/:id&quot;, auth.clientOrUser, errors.view);</td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source">    //     server.put(&quot;/errors/:type/:id&quot;, auth.clientOrUser, errors.update);</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source">    // }();</td></tr><tr><td class="line">276</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source">    // var GeicoRoutes = function() {</td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source">    //     //Big Metric</td></tr><tr><td class="line">279</td><td class="hits"></td><td class="source">    //     server.get(&quot;/geico/bigmetric&quot;, auth.clientOrUser, geico.bigMetric);</td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source">    //     server.get(&quot;/geico/new-paying-users-per-day&quot;, auth.clientOrUser, geico.newPayingUsersPerDay);</td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source">    //     server.get(&quot;/geico/dau&quot;, auth.clientOrUser, geico.dailyActiveUsers);</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source">    //     server.get(&quot;/geico/wau&quot;, auth.clientOrUser, geico.weeklyActiveUsers);</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source">    //     server.get(&quot;/geico/mau&quot;, auth.clientOrUser, geico.monthlyActiveUsers);</td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source">    //     server.get(&quot;/geico/cpd&quot;, auth.clientOrUser, geico.totalClippsPerDay);</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source">    //     server.get(&quot;/geico/conversion-by-demo-total&quot;, auth.clientOrUser, geico.conversionByDemoTotal);</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source">    //     server.get(&quot;/geico/conversion-by-14-day-trial-total&quot;, auth.clientOrUser, geico.conversionBy14DayTrialTotal);</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source">    // }();</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source">    // var ReportsRoutes = function(){</td></tr><tr><td class="line">292</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">293</td><td class="hits"></td><td class="source">    //     server.get(&quot;/notebooks/:id/report-highlights&quot;, auth.general, notebooks.checkTrialStatus, notebooks.getReportHighlights);</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source">    //</td></tr><tr><td class="line">295</td><td class="hits"></td><td class="source">    //     server.get(&quot;/reports/articles&quot;, auth.clientOrUser, reports.articles);</td></tr><tr><td class="line">296</td><td class="hits"></td><td class="source">    //     server.get(&quot;/reports/engagement&quot;, auth.clientOrUser, reports.engagementByChannel);</td></tr><tr><td class="line">297</td><td class="hits"></td><td class="source">    //     server.get(&quot;/reports/engagement/total&quot;, auth.clientOrUser, reports.engagementTotal);</td></tr><tr><td class="line">298</td><td class="hits"></td><td class="source">    //     server.get(&quot;/reports/engagement/domains&quot;, auth.clientOrUser, reports.averageEngagementByDomain);</td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source">    //     server.get(&quot;/reports/articles/count&quot;, auth.clientOrUser, reports.articleCount);</td></tr><tr><td class="line">300</td><td class="hits"></td><td class="source">    // }();</td></tr><tr><td class="line">301</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">302</td><td class="hits">1</td><td class="source">    var TrackingRoutes = function(){</td></tr><tr class="hit"><td class="line">303</td><td class="hits">1</td><td class="source">        server.post(&quot;/track&quot;, auth.general, tracking.track);</td></tr><tr><td class="line">304</td><td class="hits"></td><td class="source">    }();</td></tr><tr><td class="line">305</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">306</td><td class="hits"></td><td class="source">    //Error handling...</td></tr><tr><td class="line">307</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">308</td><td class="hits">1</td><td class="source">    server.get(&quot;/errortest&quot;, function(req, res, next){</td></tr><tr class="miss"><td class="line">309</td><td class="hits">0</td><td class="source">        throw new Error(&quot;API Error Test&quot;);</td></tr><tr><td class="line">310</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">311</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">312</td><td class="hits">1</td><td class="source">    server.get(&quot;/errortestnext&quot;, function(req, res, next){</td></tr><tr class="miss"><td class="line">313</td><td class="hits">0</td><td class="source">        next(new Error(&quot;API Error on Next Test&quot;));</td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">315</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">316</td><td class="hits">1</td><td class="source">    var raven = require(&quot;raven&quot;);</td></tr><tr class="hit"><td class="line">317</td><td class="hits">1</td><td class="source">    raven = new raven.Client(Settings.sentry.url);</td></tr><tr><td class="line">318</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">319</td><td class="hits">1</td><td class="source">    server.on(&quot;uncaughtException&quot;, function (req, res, route, err){</td></tr><tr><td class="line">320</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">321</td><td class="hits">0</td><td class="source">        raven.captureError(err, ErrorUtils.parseRequestForRaven(req));</td></tr><tr><td class="line">322</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">323</td><td class="hits">0</td><td class="source">        return res.send({</td></tr><tr><td class="line">324</td><td class="hits"></td><td class="source">            code: &quot;InternalError&quot;,</td></tr><tr><td class="line">325</td><td class="hits"></td><td class="source">            message: err.message</td></tr><tr><td class="line">326</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">327</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">328</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">329</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">330</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">331</td><td class="hits">1</td><td class="source">    return this;</td></tr><tr><td class="line">332</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">333</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">334</td><td class="hits">1</td><td class="source">module.exports = Routes;</td></tr><tr><td class="line">335</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/config/server.js">/Users/warner/code/clipppr/primeloop-api/config/server.js</h2><div id="stats" class="medium"><div class="percentage">68%</div><div class="sloc">25</div><div class="hits">17</div><div class="misses">8</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var ServerConfig = function(server) {</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/./settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        restify = require(&quot;restify&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        // restifyOAuth2 = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/../../../_modules/restify-oauth2&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        restifyOAuth2 = require(&quot;restify-oauth2&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        auth = require(&quot;/Users/warner/code/clipppr/primeloop-api/config/../controllers/auth&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        util = require(&quot;util&quot;);</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">    server.use(restify.bodyParser());</td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">    server.use(restify.queryParser());</td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">    server.use(restify.authorizationParser());</td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">    server.use(restify.fullResponse());</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">    restify.CORS.ALLOW_HEADERS.push('authorization');</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">    server.use(function(req, res, next){</td></tr><tr class="hit"><td class="line">19</td><td class="hits">148</td><td class="source">        req.body = req.params;</td></tr><tr class="hit"><td class="line">20</td><td class="hits">148</td><td class="source">        return next();</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">23</td><td class="hits">1</td><td class="source">    restifyOAuth2.ropc(server, {</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        tokenEndpoint: &quot;/token&quot;,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        hooks: auth.oauthHooks,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        tokenExpirationTime: Settings.auth.token.maxAge</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    /* Start CORS: All of this is required to get this working. */</td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">    function corsHandler(req, res, next) {</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        //TODO: Make sure this is a legit origin</td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">        res.setHeader('Access-Control-Allow-Origin', req.headers.origin);</td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">        res.setHeader('Access-Control-Allow-Headers', 'Origin, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version, X-Response-Time, X-PINGOTHER, X-CSRF-Token, Authorization');</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">        res.setHeader('Access-Control-Allow-Methods', 'PUT, GET, DELETE, POST');</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">        res.setHeader('Access-Control-Expose-Headers', 'X-Api-Version, X-Request-Id, X-Response-Time');</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">        res.setHeader('Access-Control-Max-Age', '1000');</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">        return next();</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">42</td><td class="hits">1</td><td class="source">    function optionsRoute(req, res, next) {</td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">        res.send(200);</td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">        return next();</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">47</td><td class="hits">1</td><td class="source">    server.opts('/.*/', corsHandler, optionsRoute);</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">    // server.pre(restify.CORS());</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">51</td><td class="hits">1</td><td class="source">    server.pre(restify.CORS({</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">        origins: ['http://127.0.0.1:9000','http://localhost:9000', 'http://loop.primeloop.com', 'https://primeloop.com', 'http://sun.primeloop.com'],</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">        credentials: true                  // defaults to false</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">    }));</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">    /* End CORS */</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">58</td><td class="hits">1</td><td class="source">    return this;</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">61</td><td class="hits">1</td><td class="source">module.exports = ServerConfig;</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/config/settings.js">/Users/warner/code/clipppr/primeloop-api/config/settings.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">11</div><div class="hits">11</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var Settings = {</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">    kaster: {</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">        region: process.env.KASTER_REGION || &quot;us-east-1&quot;,</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        namespace: process.env.KASTER_NAMESPACE || &quot;Phoenix.API&quot;,</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        topics: {</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">            data: process.env.KASTER_DATA_TOPIC || &quot;dev-data&quot;,</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">            activity: process.env.KASTER_ACTIVITY_TOPIC || &quot;dev-activity&quot;</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">    elasticsearch: {</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        protocol: process.env.ES_PROTOCOL || 'http',</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        host: process.env.ES_HOST || &quot;107.22.210.233&quot;,</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        port: process.env.ES_PORT || 8080,</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        user: process.env.ES_USER || &quot;uCkpcq9JXrmE3z5n58qRuNDj&quot;,</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        password: process.env.ES_PASSWORD || &quot;KpQ8jcR52bVMRLsyNEBptv22tWX2gYm8XSRWVZ7Ay3watdLe&quot;,</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        data_index: process.env.ES_DATA_INDEX || &quot;phoenix-api-dev-data&quot;</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    moz: {</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        access_id: process.env.MOZ_ACCESS_ID || &quot;member-d140b7f344&quot;,</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        secret: process.env.MOZ_SECRET || &quot;ab5f477a23050d62bfbc30386b5a5f2f&quot;</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    trial: {</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        tryit: {</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">            code: &quot;TRYIT&quot;,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">            days: process.env.TRIAL_DAYS || 45</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    analyzer: {</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        weekly: {</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">            day: process.env.ANALYZER_WEEK_DAY_RUN || 0</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">    mongo: {</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        url:</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">            process.env.MONGOHQ_URL ||</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">            process.env.MONGO_URL ||</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">            &quot;mongodb://localhost/primeloop-prod&quot;, //local key</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        debug: (process.env.MONGO_DEBUG == &quot;false&quot;) ? false : true</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    auth: {</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">        password_salt: &quot;Dz63N98f1BzJdpLjk9LVtCWkQS5M96mBCBIQuwfZ8lzw85ogiH8kDZNdkQkxC0kwUzC06yGRN5jGXgvDbaVMyaHcVUN1WYmI5CeJ&quot;,</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">        token: {</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">            maxAge: 60*60*1000*24*30,</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">            salt: &quot;alsdflajsdlf&quot;</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">    redis: {</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">        url: process.env.REDISTOGO_URL || process.env.REDIS_URL || &quot;redis://localhost&quot;,</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">        options: {},</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">        debug: (process.env.NODE_ENV != &quot;production&quot; &amp;&amp; process.env.REDIS_DEBUG == &quot;true&quot;) ? true : false,</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">        prefix: &quot;api:&quot;,</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">        loopTrackingPrefix: &quot;loop:track:&quot;,</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">        loopPagePrefix: &quot;loop:page:&quot;</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">    notebooks: {</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">        permissions: require(&quot;/Users/warner/code/clipppr/primeloop-api/config/./permissions/notebook&quot;)</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">    users: {</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">        permissions: require(&quot;/Users/warner/code/clipppr/primeloop-api/config/./permissions/user&quot;)</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">    clients: {</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">        permissions: require(&quot;/Users/warner/code/clipppr/primeloop-api/config/./permissions/client&quot;),</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">        phoenix: {</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">            auth: {</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">                user: process.env.PHOENIX_AUTH_USER || &quot;foo&quot;,</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">                pass: process.env.PHOENIX_AUTH_PASS || &quot;bar&quot;</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">        kuetee: {</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">            auth: {</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">                user: process.env.KUETEE_AUTH_USER || &quot;kuetee-magic-sauce&quot;,</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">                pass: process.env.KUETEE_AUTH_PASS || &quot;somethinglongandannoyinglyhardtoread&quot;</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">        geico: {</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">            auth: {</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">                user: process.env.GEICO_AUTH_USER || &quot;geico-magic-sauce&quot;,</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">                pass: process.env.GEICO_AUTH_PASS || &quot;somethinglongandannoyinglyhardtoreadagain&quot;</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">    sentry: {</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">        name: process.env.SENTRY_NAME || (process.env.SENTRY_NAME = &quot;Development: Phoenix API&quot;),</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">        site: process.env.SENTRY_SITE || (process.env.SENTRY_SITE = &quot;Development: ClippPR API&quot;),</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">        api_key: process.env.SENTRY_API_KEY || &quot;508e3c858ebc4f708674e6a89639567a&quot;,</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">        url: process.env.SENTRY_DSN || &quot;https://508e3c858ebc4f708674e6a89639567a:b3b98d7043554f04a9834def39c4d515@app.getsentry.com/11818&quot;</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">    mailgun: {</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">        api_key: process.env.MAILGUN_API_KEY || &quot;key-84rsupyxjys1j--0u2gmyjlqpe-p3-14&quot;, //staging key</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">        stmp: { //defaults to staging keys</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">            login: process.env.MAILGUN_SMTP_LOGIN || &quot;postmaster@app15035403.mailgun.org&quot;,</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">            password: process.env.MAILGUN_SMTP_PASSWORD || &quot;2ouky38iy6h7&quot;,</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">            port: process.env.MAILGUN_SMTP_PORT || &quot;587&quot;,</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">            server: process.env.MAILGUN_SMTP_SERVER || &quot;smtp.mailgun.org&quot;</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">        server: process.env.MAILGUN_SERVER || &quot;app15035403.mailgun.org&quot;,</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">        testmode: process.env.MAILGUN_TESTMODE || &quot;yes&quot;</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">    email: {</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">        from: &quot;Team Primeloop &lt;hello@primeloop.com&gt;&quot;,</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">        from_unsolicited: &quot;Team Primeloop &lt;hello@i.primeloop.com&gt;&quot;,</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">        new_engagement_weekly_day: process.env.EMAIL_NEW_ENGAGEMENT_WEEKLY_DAY || 1 //monday, 2=tuesday, so on..</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">    stripe: {</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">        secret_key: process.env.STRIPE_SECRET_KEY || &quot;l399bvrvPZh1aUYcvJ2JibUYSNKksrFU&quot;, //staging key</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">        pub_key: process.env.STRIPE_PUB_KEY || &quot;pk_E8njX1NKmMHF896Ji9fAEbYnQCKZg&quot; //staging key</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">    intercom: {</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">        api_secret : process.env.INTERCOM_API_SECRET || '9eCXTSsxCLvI-RKmzq3T4uqgIy3dGtPeF-fY_5W5', //staging secret</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">        app_id: process.env.INTERCOM_APP_ID || '491jsy5g', //staging id</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">        api_key: process.env.INTERCOM_API_KEY || 'a8d35ec9ce66924c0f72cede59af160b38c070b4' //staging key</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">    GOOGLE_API_KEYS: {</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">        apiKey: process.env.G_API_KEY || 'AIzaSyARaKUPG9_evGlXalhWKJwLxzrBtiDOkaY',</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">        clientSecret: process.env.G_CLIENT_SECRET || 'uEqiGNO1-eyq0dYx9t2JfSQb',</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">        clientId: process.env.G_CLIENT_ID || '234163328270-22jh3q3o8ibi32in0p88qcvesh9urb79.apps.googleusercontent.com',</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">        adDevToken: process.env.G_AD_DEV_TOKEN || &quot;juVUF_grxrhyPnNx7l_d8w&quot;,</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">        signupRedirectUrl: process.env.G_SIGNUP_REDIRECT_URL || 'http://127.0.0.1:9000/oauth2callback',</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">        settingsRedirectUrl: process.env.G_SETTINGS_REDIRECT_URL || 'http://127.0.0.1:9000/settings/oauth2callback'</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">    short_url: {</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">        seed: process.env.SHORT_URL_SEED || 997</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">    retarget: {</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">        destination_url: process.env.RETARGET_URL || 'http://l00p.co'</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">    redisq: {</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">        url: process.env.REDISQ_URL || &quot;redis://localhost/kuetee&quot;,</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">        options: {},</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">        debug: (process.env.NODE_ENV != &quot;production&quot; &amp;&amp; process.env.REDIS_DEBUG == &quot;true&quot;) ? true : false,</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">    jobs: {</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">        link_import: &quot;link import&quot;,</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">        suggested_link_import: &quot;suggested link import&quot;,</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">        suggested_feed_import: &quot;suggested feed import&quot;</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">    dataImport: {</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">        oldDB: process.env.DATA_IMPORT_FROM_MONGO_URL || &quot;mongodb://localhost:27017/clipppr&quot;,</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">        newDB: process.env.DATA_IMPORT_TO_MONGO_URL || &quot;mongodb://localhost:27017/clipppr-new-db-email-test&quot;</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">    defaultPlan: process.env.DEFAULT_PLAN || &quot;RTC&quot;,</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">    freePlan: process.env.FREE_PLAN || &quot;free&quot; ,</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">    slack: {</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">        webhook: process.env.SLACK_WEBHOOK</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">    },</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">    widgets: {</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">        chrome: {</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source">            version_latest: 132,</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">            version_disabled: 131</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">154</td><td class="hits">1</td><td class="source">var saveRedisDetails = function () {</td></tr><tr class="hit"><td class="line">155</td><td class="hits">1</td><td class="source">    var redis_url = require(&quot;url&quot;).parse(Settings.redis.url);</td></tr><tr class="hit"><td class="line">156</td><td class="hits">1</td><td class="source">    Settings.redis.options.host = redis_url.hostname;</td></tr><tr class="hit"><td class="line">157</td><td class="hits">1</td><td class="source">    Settings.redis.options.port = redis_url.port;</td></tr><tr class="hit"><td class="line">158</td><td class="hits">1</td><td class="source">    if(redis_url.auth) Settings.redis.options.pass = redis_url.auth.split(&quot;:&quot;)[1];</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">160</td><td class="hits">1</td><td class="source">    var redisq_url = require(&quot;url&quot;).parse(Settings.redisq.url);</td></tr><tr class="hit"><td class="line">161</td><td class="hits">1</td><td class="source">    Settings.redisq.options.host = redisq_url.hostname;</td></tr><tr class="hit"><td class="line">162</td><td class="hits">1</td><td class="source">    Settings.redisq.options.port = redisq_url.port;</td></tr><tr class="hit"><td class="line">163</td><td class="hits">1</td><td class="source">    if(redisq_url.auth) Settings.redisq.options.pass = redisq_url.auth.split(&quot;:&quot;)[1]</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">166</td><td class="hits">1</td><td class="source">module.exports = Settings;</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/controllers/actions.js">/Users/warner/code/clipppr/primeloop-api/controllers/actions.js</h2><div id="stats" class="medium"><div class="percentage">51%</div><div class="sloc">90</div><div class="hits">46</div><div class="misses">44</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var ActionsController = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        restify = require(&quot;restify&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        User = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/user&quot;).Model,</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        Action = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/action&quot;).Model,</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        EmailActivityLog = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/emailactivitylog&quot;).Model,</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        Notebook = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/notebook&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        Clipp = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/clipp&quot;).Model;</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">    var _list = function(req, res, next) {</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        // res.send({</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        //     status: &quot;failed&quot;,</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        //     message: &quot;Not yet implemented&quot;</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        // });</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">    var _listClippActions = function(req, res, next) {</td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">            clipp = req.params.id,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">            notebook = req.params.notebook, //for permissions</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">            page = parseInt(req.params.page || 1, 10),</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">            per_page = parseInt(req.params.per_page || 20, 10);</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">        Action</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">                clipp: clipp</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">            .populate(&quot;user&quot;, &quot;name&quot;)</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">            .limit(per_page)</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">            .skip((page-1)*per_page)</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">            .sort({&quot;created&quot;: -1})</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">            .exec(function(err, actions){</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">                res.send(actions);</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">42</td><td class="hits">1</td><td class="source">    var _add = function(req, res, next) {</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">44</td><td class="hits">2</td><td class="source">        var action = new Action(req.params);</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">46</td><td class="hits">2</td><td class="source">        action.save(function(err, res){</td></tr><tr class="hit"><td class="line">47</td><td class="hits">2</td><td class="source">            if(err) console.log(&quot;Error saving action:&quot;, err);</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">        // console.log(req.params, &quot;Starting action handler&quot;);</td></tr><tr class="hit"><td class="line">50</td><td class="hits">2</td><td class="source">        _handleAction(action, function(err, saved){</td></tr><tr class="hit"><td class="line">51</td><td class="hits">2</td><td class="source">            if(err) console.log(&quot;Error:&quot;, err);</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">            // console.log(&quot;Sending Response&quot;);</td></tr><tr class="hit"><td class="line">54</td><td class="hits">2</td><td class="source">            if(req.params.wait) return res.send({</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">                status: &quot;saved&quot;,</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">                code: 200</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">        //We want to respond ASAP because it doesn't matter to the user if we save this or not</td></tr><tr class="hit"><td class="line">61</td><td class="hits">4</td><td class="source">        if(!req.params.wait) return res.send({</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">            status: &quot;saved&quot;,</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">            code: 200</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">        // else console.log(&quot;Waiting&quot;);</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">68</td><td class="hits">1</td><td class="source">    var _handleAction = function(action, done){</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">        // console.log(action);</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">71</td><td class="hits">3</td><td class="source">        switch(action.action) {</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">            case &quot;viewed tweets&quot;: </td></tr><tr class="hit"><td class="line">73</td><td class="hits">1</td><td class="source">                _clearNotification(&quot;twitter&quot;, action, done);</td></tr><tr class="hit"><td class="line">74</td><td class="hits">1</td><td class="source">            break;</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">            case &quot;viewed facebook&quot;:</td></tr><tr class="hit"><td class="line">76</td><td class="hits">1</td><td class="source">                _clearNotification(&quot;facebook&quot;, action, done);</td></tr><tr class="hit"><td class="line">77</td><td class="hits">1</td><td class="source">            break;</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">            case &quot;viewed google plus&quot;:</td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">                _clearNotification(&quot;googleplus&quot;, action, done);</td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="source">            break;</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">            case &quot;viewed linkedin&quot;: </td></tr><tr class="hit"><td class="line">82</td><td class="hits">1</td><td class="source">                _clearNotification(&quot;linkedin&quot;, action, done);</td></tr><tr class="hit"><td class="line">83</td><td class="hits">1</td><td class="source">            break;</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">            case &quot;viewed comments&quot;: </td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="source">                _clearNotification(&quot;comments&quot;, action, done);</td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="source">            break;</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">            case &quot;viewed site counts&quot;: </td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="source">                _clearNotification(&quot;native_count&quot;, action, done);</td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="source">            break;</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">            case &quot;viewed link&quot;: </td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="source">            break;</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">            case &quot;viewed discussion&quot;:</td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="source">                _clearDiscussionNotification(&quot;discussion&quot;, action, done);</td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="source">            break;</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">            case &quot;cleared all notifications&quot;:</td></tr><tr class="miss"><td class="line">97</td><td class="hits">0</td><td class="source">                _clearAllNotificationsForNotebook(action, done);</td></tr><tr class="miss"><td class="line">98</td><td class="hits">0</td><td class="source">            break;</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">102</td><td class="hits">1</td><td class="source">    var _clearAllNotifications = function(action, done) {</td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="source">        var services = [</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">            &quot;twitter&quot;,</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">            &quot;facebook&quot;,</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">            &quot;googleplus&quot;,</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">            &quot;linkedin&quot;,</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">            &quot;native_count&quot;,</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">            &quot;comments&quot;</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">        ], </td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">        len = services.length;</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">113</td><td class="hits">0</td><td class="source">        Clipp</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">                _id: action.clipp</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">            .exec(function(err, clipp){</td></tr><tr class="miss"><td class="line">118</td><td class="hits">0</td><td class="source">                if(err) return console.log(&quot;Error updating clipp action:&quot;, err);</td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="source">                if(!clipp) return done();</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">121</td><td class="hits">0</td><td class="source">                return clipp.clearAllNotifications(services, done);</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">125</td><td class="hits">1</td><td class="source">    var _clearAllNotificationsForNotebook = function(action, done){</td></tr><tr class="miss"><td class="line">126</td><td class="hits">0</td><td class="source">        var services = [</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">            &quot;twitter&quot;,</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">            &quot;facebook&quot;,</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">            &quot;googleplus&quot;,</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">            &quot;linkedin&quot;,</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">            &quot;native_count&quot;,</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">            &quot;comments&quot;</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">        ]; </td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">135</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">                _id: action.notebook</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">            }, &quot;clipps&quot;)</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">            .populate(&quot;clipps.clipp&quot;)</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">141</td><td class="hits">0</td><td class="source">                if(err) return console.log(&quot;Error clearing all notifications&quot;, err.stack || err);</td></tr><tr class="miss"><td class="line">142</td><td class="hits">0</td><td class="source">                if(!notebook || notebook.clipps.length &lt;= 0) return done();</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">144</td><td class="hits">0</td><td class="source">                var </td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">                    clipps = notebook.clipps,</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">                    len = clipps.length,</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">                    _clearedNotifications = function(err, saved){</td></tr><tr class="miss"><td class="line">148</td><td class="hits">0</td><td class="source">                        return --len &gt; 0 || done();</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">                    };</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">                // console.log(clipps.length, len);</td></tr><tr class="miss"><td class="line">152</td><td class="hits">0</td><td class="source">                for(var i = 0; i &lt; clipps.length; i++){</td></tr><tr class="miss"><td class="line">153</td><td class="hits">0</td><td class="source">                    if(!clipps[i].clipp) {</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">                        // console.log(clipps.length, len);</td></tr><tr class="miss"><td class="line">155</td><td class="hits">0</td><td class="source">                        if(--len &gt; 0 ) continue;</td></tr><tr class="miss"><td class="line">156</td><td class="hits">0</td><td class="source">                        else return done(); </td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="source">                    clipps[i].clipp.clearAllNotifications(services, _clearedNotifications);</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">165</td><td class="hits">1</td><td class="source">    var _clearDiscussionNotification = function(type, action, done){</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">167</td><td class="hits">0</td><td class="source">        Clipp</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">                _id: action.clipp</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">            .exec(function(err, clipp){</td></tr><tr class="miss"><td class="line">172</td><td class="hits">0</td><td class="source">                if(err) console.log(&quot;Error updating clipp action:&quot;, err);</td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="source">                if(!clipp) return done();</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">175</td><td class="hits">0</td><td class="source">                User</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">                    .findOne({</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">                        _id: action.user</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">                    })</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">                    .exec(function(err, user){</td></tr><tr class="miss"><td class="line">180</td><td class="hits">0</td><td class="source">                        if(err) console.log(&quot;Error updating user action:&quot;, err);</td></tr><tr class="miss"><td class="line">181</td><td class="hits">0</td><td class="source">                        if(!user) return done();</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">183</td><td class="hits">0</td><td class="source">                        return user.clearNotification(clipp, done);</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">188</td><td class="hits">1</td><td class="source">    var _clearNotification = function(type, action, done){</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">190</td><td class="hits">3</td><td class="source">        Clipp</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">                _id: action.clipp</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">            .exec(function(err, clipp){</td></tr><tr class="hit"><td class="line">195</td><td class="hits">3</td><td class="source">                if(err) console.log(&quot;Error updating clipp action:&quot;, err);</td></tr><tr class="hit"><td class="line">196</td><td class="hits">4</td><td class="source">                if(!clipp) return done();</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">198</td><td class="hits">2</td><td class="source">                return clipp.clearNotification(type, done); </td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">203</td><td class="hits">1</td><td class="source">    var _emailAction = function(req, res, next) {</td></tr><tr class="hit"><td class="line">204</td><td class="hits">3</td><td class="source">        if(!req.params.recipient) return next(new restify.ResourceNotFoundError(&quot;User does not exist.&quot;));</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">206</td><td class="hits">3</td><td class="source">        var </td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">            url = req.params.url,</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">            //get action type from url</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source">            clipp = (url) ? url.substr(url.lastIndexOf(&quot;/&quot;)+1,url.length) : null,</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">            type = (url) ? url.substr(url.indexOf(&quot;/rd/&quot;)+4,url.length-(url.indexOf(&quot;/rd/&quot;)+clipp.length+5)) : null,</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">            action;</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source">        //https://www.clipppr.com/rd/twitter/1234</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">        // console.log(clipp, type);</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">218</td><td class="hits">3</td><td class="source">        User</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source">                email: req.params.recipient</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">            .exec(function(err, user){</td></tr><tr class="hit"><td class="line">224</td><td class="hits">3</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">226</td><td class="hits">3</td><td class="source">                if(user &amp;&amp; url &amp;&amp; url.indexOf(&quot;/rd/&quot;) &gt;= 0) //if it's a clipp action we want to show up in the activity logs</td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source">                {</td></tr><tr class="hit"><td class="line">228</td><td class="hits">1</td><td class="source">                    action = new Action({</td></tr><tr><td class="line">229</td><td class="hits"></td><td class="source">                        clipp: clipp,</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">                        user: user._id,</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">                        url: req.params.url,</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">                        action: _actionFromAct(type),</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">                        source: &quot;email&quot;</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">236</td><td class="hits">1</td><td class="source">                    _handleAction(action, function (err) {</td></tr><tr class="hit"><td class="line">237</td><td class="hits">1</td><td class="source">                        if(err) console.log(&quot;Error handling action&quot;, err, action);</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">                    });</td></tr><tr class="hit"><td class="line">239</td><td class="hits">1</td><td class="source">                    action.save();</td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source">                //log action</td></tr><tr class="hit"><td class="line">243</td><td class="hits">3</td><td class="source">                var activity = new EmailActivityLog({</td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source">                    user: (user) ? user._id : null,</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source">                    email: req.params.recipient,</td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source">                    url: req.params.url,</td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source">                    action: req.params.action,</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">250</td><td class="hits">3</td><td class="source">                activity.save();</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">253</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">254</td><td class="hits">3</td><td class="source">            return res.send({</td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">                code: 200,</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source">                message: &quot;success&quot;</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">260</td><td class="hits">1</td><td class="source">    var _actionFromAct = function (type) {</td></tr><tr class="hit"><td class="line">261</td><td class="hits">1</td><td class="source">        switch(type){</td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source">            case &quot;navtive_count&quot;:</td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">264</td><td class="hits">0</td><td class="source">            return &quot;viewed site counts&quot;;</td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source">            case &quot;facebook&quot;:</td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">267</td><td class="hits">1</td><td class="source">            return &quot;viewed facebook&quot;;</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">            case &quot;twitter&quot;: </td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">271</td><td class="hits">0</td><td class="source">            return &quot;viewed tweets&quot;;</td></tr><tr><td class="line">272</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">273</td><td class="hits"></td><td class="source">            case &quot;linkedin&quot;: </td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">275</td><td class="hits">0</td><td class="source">            return &quot;viewed linkedin&quot;;</td></tr><tr><td class="line">276</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source">            case &quot;googleplus&quot;: </td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">279</td><td class="hits">0</td><td class="source">            return &quot;viewed google plus&quot;;</td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source">            case &quot;comments&quot;:</td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">282</td><td class="hits">0</td><td class="source">            return &quot;viewed comments&quot;;</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">285</td><td class="hits">0</td><td class="source">        return &quot;viewed clipp&quot;;</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">288</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source">        list: _list,</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source">        listClippActions: _listClippActions,</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source">        add: _add,</td></tr><tr><td class="line">292</td><td class="hits"></td><td class="source">        emailAction: _emailAction</td></tr><tr><td class="line">293</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">295</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">296</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">297</td><td class="hits">1</td><td class="source">module.exports = ActionsController;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/controllers/auth.js">/Users/warner/code/clipppr/primeloop-api/controllers/auth.js</h2><div id="stats" class="medium"><div class="percentage">73%</div><div class="sloc">162</div><div class="hits">119</div><div class="misses">43</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var AuthController = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        User = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/user&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        ActivityLog = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/activitylog&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        Client = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/client&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        AuthUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/auth&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        JSONUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/json&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        crypto = require(&quot;crypto&quot;),</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        restify = require(&quot;restify&quot;),</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        intercom = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/intercom&quot;),</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        rclient = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/redis&quot;);</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">    var _getWorkingUser = function(user, done) {</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        //if user is a super-admin and currently spoofing someone we want to return that user and not the admin</td></tr><tr class="hit"><td class="line">17</td><td class="hits">51</td><td class="source">        if(user.permissions.indexOf(&quot;act_as_user&quot;) &gt;= 0) {</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">            //look up user record and see if they have a SA token</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">            User.Model</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">                .findOne({</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">                    _id: user._id</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">                .exec(function(err, dbUser){</td></tr><tr class="hit"><td class="line">25</td><td class="hits">1</td><td class="source">                    if(err) return done(null, user);</td></tr><tr class="hit"><td class="line">26</td><td class="hits">1</td><td class="source">                    if(dbUser.superAdmin &amp;&amp; dbUser.superAdmin.token) {</td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">                        _getTokenData(dbUser.superAdmin.token, function(err, data){</td></tr><tr class="hit"><td class="line">28</td><td class="hits">1</td><td class="source">                            return done(err, data);</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">                    } else {</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">                        return done(null, user);</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">            </td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"><td class="line">36</td><td class="hits">50</td><td class="source">            return done(null, user);</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">40</td><td class="hits">1</td><td class="source">    var _superAdmin = function(req, res, next) {</td></tr><tr class="hit"><td class="line">41</td><td class="hits">5</td><td class="source">        if ((!req.username &amp;&amp; !req.user) || !req.authorization || req.authorization.scheme !== &quot;Bearer&quot;) {</td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">            return res.sendUnauthorized();</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"><td class="line">44</td><td class="hits">5</td><td class="source">            req.user = req.user || req.username;</td></tr><tr class="hit"><td class="line">45</td><td class="hits">5</td><td class="source">            req.user.permissions = User.getPermissions(req.user);</td></tr><tr class="hit"><td class="line">46</td><td class="hits">5</td><td class="source">            if(req.user.role !== &quot;super-admin&quot;) {</td></tr><tr class="hit"><td class="line">47</td><td class="hits">1</td><td class="source">                return res.sendUnauthorized();</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="hit"><td class="line">49</td><td class="hits">4</td><td class="source">                User.Model.update({</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">                    _id: req.user._id</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">                }, {</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">                    &quot;lastAction&quot;: new Date()</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">                }).exec();</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">55</td><td class="hits">4</td><td class="source">                delete req.username;</td></tr><tr class="hit"><td class="line">56</td><td class="hits">4</td><td class="source">                return next();</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">61</td><td class="hits">1</td><td class="source">    var _general = function(req, res, next){</td></tr><tr class="hit"><td class="line">62</td><td class="hits">62</td><td class="source">        if ((!req.username &amp;&amp; !req.user) || !req.authorization || req.authorization.scheme !== &quot;Bearer&quot;) {</td></tr><tr class="hit"><td class="line">63</td><td class="hits">11</td><td class="source">            return res.sendUnauthorized();</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"><td class="line">65</td><td class="hits">51</td><td class="source">            req.user = req.user || req.username;</td></tr><tr class="hit"><td class="line">66</td><td class="hits">51</td><td class="source">            req.user.permissions = User.getPermissions(req.user);</td></tr><tr class="hit"><td class="line">67</td><td class="hits">51</td><td class="source">            _getWorkingUser(req.user, function(err, user) {</td></tr><tr class="hit"><td class="line">68</td><td class="hits">51</td><td class="source">                if(err) next(new restify.ResourceNotFoundError(&quot;Acts as User token not found &quot; + err));</td></tr><tr class="hit"><td class="line">69</td><td class="hits">51</td><td class="source">                req.user = user;</td></tr><tr class="hit"><td class="line">70</td><td class="hits">51</td><td class="source">                req.user.permissions = User.getPermissions(req.user);</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">72</td><td class="hits">51</td><td class="source">                User.Model.update({</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">                    _id: req.user._id</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">                }, {</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">                    &quot;lastAction&quot;: new Date()</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">                }).exec();</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">78</td><td class="hits">51</td><td class="source">                delete req.username;</td></tr><tr class="hit"><td class="line">79</td><td class="hits">51</td><td class="source">                return next();</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">84</td><td class="hits">1</td><td class="source">    var _actAsUser = function(req, res, next) {</td></tr><tr class="hit"><td class="line">85</td><td class="hits">2</td><td class="source">        if(req.user.permissions.indexOf(&quot;act_as_user&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="source">            return res.sendUnauthorized();</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"><td class="line">88</td><td class="hits">2</td><td class="source">            User.Model</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">                .findOne({</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">                    _id: req.params.userId</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">                .lean()</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">                .exec(function(err, user){</td></tr><tr class="hit"><td class="line">94</td><td class="hits">2</td><td class="source">                    if(err) return done(err, false);</td></tr><tr class="hit"><td class="line">95</td><td class="hits">2</td><td class="source">                    if(!user) {</td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="source">                        return next(new restify.ResourceNotFoundError(&quot;User does not exist&quot;));</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">99</td><td class="hits">2</td><td class="source">                    var token = _generateToken(user.email + &quot;:&quot; + user.hashedPassword);</td></tr><tr class="hit"><td class="line">100</td><td class="hits">2</td><td class="source">                    user.spoofed = true;</td></tr><tr class="hit"><td class="line">101</td><td class="hits">2</td><td class="source">                    _saveToken(token, user);</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">103</td><td class="hits">2</td><td class="source">                    User.Model.update({</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">                        _id: req.user._id</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">                    }, {</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">                        &quot;superAdmin.token&quot;: token,</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">                        &quot;superAdmin.user&quot;: user._id</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">                    }).exec(function(err, admin){</td></tr><tr class="hit"><td class="line">109</td><td class="hits">2</td><td class="source">                        if(err) return next(err);</td></tr><tr class="hit"><td class="line">110</td><td class="hits">2</td><td class="source">                        return res.send(&quot;Admin user acting as [&quot; + user.email + &quot;]&quot;);</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">                    </td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">119</td><td class="hits">1</td><td class="source">    var _clearActAsUser = function(req, res, next) {</td></tr><tr class="miss"><td class="line">120</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;act_as_user&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">121</td><td class="hits">0</td><td class="source">            return res.sendUnauthorized();</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">123</td><td class="hits">0</td><td class="source">            User.Model</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">                .findOne({</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">                    _id: req.user._id</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">                .lean()</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">                .exec(function(err, user){</td></tr><tr class="miss"><td class="line">129</td><td class="hits">0</td><td class="source">                    if(err) return done(err, false);</td></tr><tr class="miss"><td class="line">130</td><td class="hits">0</td><td class="source">                    if(!user) {</td></tr><tr class="miss"><td class="line">131</td><td class="hits">0</td><td class="source">                        return next(new restify.ResourceNotFoundError(&quot;User does not exist&quot;));</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">134</td><td class="hits">0</td><td class="source">                    var token = _clearTokenData(user.superAdmin.token);</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">                    </td></tr><tr class="miss"><td class="line">136</td><td class="hits">0</td><td class="source">                    User.Model.update({</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">                        _id: req.user._id</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">                    }, {</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">                        &quot;superAdmin.token&quot;: null,</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">                        &quot;superAdmin.user&quot;: null</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">                    }).exec(function(err, admin){</td></tr><tr class="miss"><td class="line">142</td><td class="hits">0</td><td class="source">                        if(err) return next(err);</td></tr><tr class="miss"><td class="line">143</td><td class="hits">0</td><td class="source">                        return res.send(&quot;Cleared Act As User session for [&quot; + user.email+ &quot;]&quot;);</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">149</td><td class="hits">1</td><td class="source">    var _anonymous = function(req, res, next) {</td></tr><tr class="hit"><td class="line">150</td><td class="hits">4</td><td class="source">        if ((!req.username &amp;&amp; !req.user) || !req.authorization || req.authorization.scheme !== &quot;Bearer&quot;) {</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">152</td><td class="hits">1</td><td class="source">            req.user = new User.Model({</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">                _id: &quot;anonymous&quot;,</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">                role: &quot;general&quot;,</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">                name: &quot;&quot;,</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">                email: &quot;anonymous@primeloop.com&quot;</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">159</td><td class="hits">1</td><td class="source">            req.user.permissions = User.getPermissions(req.user);</td></tr><tr class="hit"><td class="line">160</td><td class="hits">1</td><td class="source">            return next();</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"><td class="line">163</td><td class="hits">3</td><td class="source">            req.user = req.user || req.username;</td></tr><tr class="hit"><td class="line">164</td><td class="hits">3</td><td class="source">            req.user.permissions = User.getPermissions(req.user);</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">166</td><td class="hits">3</td><td class="source">            var log = new ActivityLog.Model({</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">                user: req.user._id,</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">                url: req.url</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">            });</td></tr><tr class="hit"><td class="line">170</td><td class="hits">3</td><td class="source">            log.save(function(err, saved){</td></tr><tr class="hit"><td class="line">171</td><td class="hits">3</td><td class="source">                if(err) console.log(&quot;error saving activity log: &quot; + err);</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">175</td><td class="hits">3</td><td class="source">            User.Model.update({</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">                _id: req.user._id</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">            }, {</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">                &quot;lastAction&quot;: new Date()</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">            }).exec();</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">181</td><td class="hits">3</td><td class="source">            delete req.username;</td></tr><tr class="hit"><td class="line">182</td><td class="hits">3</td><td class="source">            return next();</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">187</td><td class="hits">1</td><td class="source">    var _optional = function(req, res, next) {</td></tr><tr class="miss"><td class="line">188</td><td class="hits">0</td><td class="source">        if ((!req.username &amp;&amp; !req.user) || !req.authorization || req.authorization.scheme !== &quot;Bearer&quot;) {</td></tr><tr class="miss"><td class="line">189</td><td class="hits">0</td><td class="source">            return next();</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">191</td><td class="hits">0</td><td class="source">            req.user = req.user || req.username;</td></tr><tr class="miss"><td class="line">192</td><td class="hits">0</td><td class="source">            req.user.permissions = User.getPermissions(req.user);</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">194</td><td class="hits">0</td><td class="source">            var log = new ActivityLog.Model({</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source">                user: req.user._id,</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source">                url: req.url</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">            });</td></tr><tr class="miss"><td class="line">198</td><td class="hits">0</td><td class="source">            log.save(function(err, saved){</td></tr><tr class="miss"><td class="line">199</td><td class="hits">0</td><td class="source">                if(err) console.log(&quot;error saving activity log: &quot; + err);</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">203</td><td class="hits">0</td><td class="source">            User.Model.update({</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">                _id: req.user._id</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source">            }, {</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source">                &quot;lastAction&quot;: new Date()</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">            }).exec();</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">209</td><td class="hits">0</td><td class="source">            delete req.username;</td></tr><tr class="miss"><td class="line">210</td><td class="hits">0</td><td class="source">            return next();</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">215</td><td class="hits">1</td><td class="source">    var _clientOrUser = function(req, res, next) {</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">217</td><td class="hits">22</td><td class="source">        req.client = {</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">            permissions: []</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">221</td><td class="hits">22</td><td class="source">        req.user = {</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">            permissions: []</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">225</td><td class="hits">22</td><td class="source">        if (!req.username) {</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">227</td><td class="hits">0</td><td class="source">            if (</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source">                !req.authorization ||</td></tr><tr><td class="line">229</td><td class="hits"></td><td class="source">                req.authorization.scheme !== &quot;Basic&quot; ||</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">                !req.authorization.basic ||</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">                !req.authorization.basic.username ||</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">                !req.authorization.basic.password</td></tr><tr class="miss"><td class="line">233</td><td class="hits">0</td><td class="source">            ) return res.sendUnauthorized();</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">            // console.log(&quot;req.authorization&quot;, req.authorization.basic);</td></tr><tr class="miss"><td class="line">236</td><td class="hits">0</td><td class="source">            _validateClient(req.authorization.basic.username, req.authorization.basic.password, function(err, client){</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">238</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">240</td><td class="hits">0</td><td class="source">                if(client) {</td></tr><tr class="miss"><td class="line">241</td><td class="hits">0</td><td class="source">                    req.client = (client.toObject) ? client.toObject() : client;</td></tr><tr class="miss"><td class="line">242</td><td class="hits">0</td><td class="source">                    req.client.permissions = Client.getPermissions(client);</td></tr><tr class="miss"><td class="line">243</td><td class="hits">0</td><td class="source">                    return next();</td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">246</td><td class="hits">0</td><td class="source">                return res.sendUnauthorized();</td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"><td class="line">250</td><td class="hits">22</td><td class="source">            req.user = req.username;</td></tr><tr class="hit"><td class="line">251</td><td class="hits">22</td><td class="source">            req.user.permissions = User.getPermissions(req.user);</td></tr><tr class="hit"><td class="line">252</td><td class="hits">22</td><td class="source">            return next();</td></tr><tr><td class="line">253</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">256</td><td class="hits">1</td><td class="source">    var _verifyMailgun = function(req, res, next){</td></tr><tr class="miss"><td class="line">257</td><td class="hits">0</td><td class="source">        var params = req.params;</td></tr><tr class="miss"><td class="line">258</td><td class="hits">0</td><td class="source">        var sig = crypto.createHmac('sha256', Settings.mailgun.api_key).update(params.timestamp+params.token).digest('hex');</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source">        // console.log(sig, &quot;===&quot;, params[&quot;signature&quot;]);</td></tr><tr class="miss"><td class="line">260</td><td class="hits">0</td><td class="source">        if(sig === params.signature) return next();</td></tr><tr class="miss"><td class="line">261</td><td class="hits">0</td><td class="source">        return res.sendUnauthorized();</td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">264</td><td class="hits">1</td><td class="source">    var _generateToken = function(data){</td></tr><tr class="hit"><td class="line">265</td><td class="hits">29</td><td class="source">        var random = Math.floor(Math.random() * 100001);</td></tr><tr class="hit"><td class="line">266</td><td class="hits">29</td><td class="source">        var timestamp = (new Date()).getTime();</td></tr><tr class="hit"><td class="line">267</td><td class="hits">29</td><td class="source">        var sha256 = crypto.createHmac(&quot;sha256&quot;, random + Settings.auth.token.salt + timestamp);</td></tr><tr class="hit"><td class="line">268</td><td class="hits">29</td><td class="source">        return sha256.update(data).digest(&quot;base64&quot;);</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">271</td><td class="hits">1</td><td class="source">    var _saveToken = function(token, user, done) {</td></tr><tr class="hit"><td class="line">272</td><td class="hits">122</td><td class="source">        var</td></tr><tr><td class="line">273</td><td class="hits"></td><td class="source">            id = Settings.redis.prefix + token,</td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source">            maxAge = Settings.auth.token.maxAge;</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">276</td><td class="hits">122</td><td class="source">        user = JSON.stringify(user);</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">278</td><td class="hits">122</td><td class="source">        rclient.setex(id, maxAge, user, function(err){</td></tr><tr class="hit"><td class="line">279</td><td class="hits">122</td><td class="source">            return done &amp;&amp; done.apply(this, arguments);</td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">283</td><td class="hits">1</td><td class="source">    var _getTokenData = function(token, done) {</td></tr><tr class="hit"><td class="line">284</td><td class="hits">82</td><td class="source">        var id = Settings.redis.prefix + token;</td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">286</td><td class="hits">82</td><td class="source">        rclient.get(id, function(err, data){</td></tr><tr class="hit"><td class="line">287</td><td class="hits">82</td><td class="source">            if (err || !data) return done(err);</td></tr><tr class="hit"><td class="line">288</td><td class="hits">82</td><td class="source">            return JSONUtils.safeParse(data, done);</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">292</td><td class="hits">1</td><td class="source">    var _clearTokenData = function(token, done) {</td></tr><tr class="miss"><td class="line">293</td><td class="hits">0</td><td class="source">        var id = Settings.redis.prefix + token;</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">295</td><td class="hits">0</td><td class="source">        rclient.del(id, function(err, data){</td></tr><tr class="miss"><td class="line">296</td><td class="hits">0</td><td class="source">            if (err || !data) return done(err);</td></tr><tr class="miss"><td class="line">297</td><td class="hits">0</td><td class="source">            return done();</td></tr><tr><td class="line">298</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">300</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">301</td><td class="hits">1</td><td class="source">    var _validateClient = function(id, secret, done){</td></tr><tr class="hit"><td class="line">302</td><td class="hits">29</td><td class="source">        Client.Model</td></tr><tr><td class="line">303</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">304</td><td class="hits"></td><td class="source">                client_id: id,</td></tr><tr><td class="line">305</td><td class="hits"></td><td class="source">                client_secret: secret</td></tr><tr><td class="line">306</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">307</td><td class="hits"></td><td class="source">            .exec(function(err, client){</td></tr><tr class="hit"><td class="line">308</td><td class="hits">30</td><td class="source">                if(err || !client) return done(err, false);</td></tr><tr><td class="line">309</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">310</td><td class="hits">28</td><td class="source">                client.lastAuth = new Date();</td></tr><tr class="hit"><td class="line">311</td><td class="hits">28</td><td class="source">                client.save();</td></tr><tr class="hit"><td class="line">312</td><td class="hits">28</td><td class="source">                return done(err, client);</td></tr><tr><td class="line">313</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">315</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">316</td><td class="hits">1</td><td class="source">    var _grantUserToken = function(email, password, done){</td></tr><tr class="hit"><td class="line">317</td><td class="hits">28</td><td class="source">        var hashedPassword = AuthUtils.hashPassword(password);</td></tr><tr class="hit"><td class="line">318</td><td class="hits">28</td><td class="source">        User.Model</td></tr><tr><td class="line">319</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">320</td><td class="hits"></td><td class="source">                email: email.toLowerCase(),</td></tr><tr><td class="line">321</td><td class="hits"></td><td class="source">                enabled: true,</td></tr><tr><td class="line">322</td><td class="hits"></td><td class="source">                hashedPassword: hashedPassword</td></tr><tr><td class="line">323</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">324</td><td class="hits"></td><td class="source">            .exec(function(err, user){</td></tr><tr class="hit"><td class="line">325</td><td class="hits">29</td><td class="source">                if(err || !user) return done(err, false);</td></tr><tr><td class="line">326</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">327</td><td class="hits">27</td><td class="source">                var token = _generateToken(email + &quot;:&quot; + password);</td></tr><tr><td class="line">328</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">329</td><td class="hits">27</td><td class="source">                _saveToken(token, user);</td></tr><tr><td class="line">330</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">331</td><td class="hits">27</td><td class="source">                user.tokens.push(token);</td></tr><tr class="hit"><td class="line">332</td><td class="hits">27</td><td class="source">                user.markModified(&quot;tokens&quot;);</td></tr><tr><td class="line">333</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">334</td><td class="hits">27</td><td class="source">                user.save(function(err, saved){</td></tr><tr class="hit"><td class="line">335</td><td class="hits">27</td><td class="source">                    if(err) console.log(&quot;Error saving user tokens:&quot;, err);</td></tr><tr><td class="line">336</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">337</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">338</td><td class="hits">27</td><td class="source">                return done(null, token);</td></tr><tr><td class="line">339</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">340</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">341</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">342</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">343</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">344</td><td class="hits">1</td><td class="source">    var _authenticateToken = function(token, done) {</td></tr><tr class="hit"><td class="line">345</td><td class="hits">81</td><td class="source">        _getTokenData(token, function(err, data){</td></tr><tr class="hit"><td class="line">346</td><td class="hits">81</td><td class="source">            return done(err, data);</td></tr><tr><td class="line">347</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">348</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">349</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">350</td><td class="hits">1</td><td class="source">    var _refreshSessionData = function(req, res, next){</td></tr><tr class="hit"><td class="line">351</td><td class="hits">16</td><td class="source">        return _refreshSessionForUser(req.user, function(err, user){</td></tr><tr class="hit"><td class="line">352</td><td class="hits">16</td><td class="source">            req.user = user;</td></tr><tr class="hit"><td class="line">353</td><td class="hits">16</td><td class="source">            req.user.permissions = User.getPermissions(req.user);</td></tr><tr class="hit"><td class="line">354</td><td class="hits">16</td><td class="source">            return next();</td></tr><tr><td class="line">355</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">356</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">357</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">358</td><td class="hits">1</td><td class="source">    var _refreshSessionForUser = function(user, done) {</td></tr><tr><td class="line">359</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">360</td><td class="hits">20</td><td class="source">        if(user._id == &quot;anonymous&quot;) return done(null, user);</td></tr><tr class="hit"><td class="line">361</td><td class="hits">18</td><td class="source">        var spoofed = false;</td></tr><tr class="hit"><td class="line">362</td><td class="hits">18</td><td class="source">        if(user.spoofed) {</td></tr><tr class="miss"><td class="line">363</td><td class="hits">0</td><td class="source">            spoofed = true;</td></tr><tr><td class="line">364</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">365</td><td class="hits">18</td><td class="source">        User.Model</td></tr><tr><td class="line">366</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">367</td><td class="hits"></td><td class="source">                _id: user._id || user</td></tr><tr><td class="line">368</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">369</td><td class="hits"></td><td class="source">            .populate(&quot;superAdmin.user&quot;)</td></tr><tr><td class="line">370</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">371</td><td class="hits"></td><td class="source">            .exec(function(err, user){</td></tr><tr class="hit"><td class="line">372</td><td class="hits">18</td><td class="source">                if(err) return done(err);</td></tr><tr><td class="line">373</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">374</td><td class="hits">18</td><td class="source">                if(!user || !user.tokens) return done(err, user);</td></tr><tr><td class="line">375</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">376</td><td class="hits">18</td><td class="source">                for(var i in user.tokens) {</td></tr><tr class="hit"><td class="line">377</td><td class="hits">93</td><td class="source">                    _saveToken(user.tokens[i], user);</td></tr><tr><td class="line">378</td><td class="hits"></td><td class="source">                }</td></tr><tr class="hit"><td class="line">379</td><td class="hits">18</td><td class="source">                if(spoofed) {</td></tr><tr class="miss"><td class="line">380</td><td class="hits">0</td><td class="source">                    user.spoofed = spoofed;</td></tr><tr><td class="line">381</td><td class="hits"></td><td class="source">                }</td></tr><tr class="hit"><td class="line">382</td><td class="hits">18</td><td class="source">                return done(err, user);</td></tr><tr><td class="line">383</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">384</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">385</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">386</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">387</td><td class="hits"></td><td class="source">        general: _general,</td></tr><tr><td class="line">388</td><td class="hits"></td><td class="source">        superAdmin : _superAdmin,</td></tr><tr><td class="line">389</td><td class="hits"></td><td class="source">        actAsUser : _actAsUser,</td></tr><tr><td class="line">390</td><td class="hits"></td><td class="source">        clearActAsUser :_clearActAsUser,</td></tr><tr><td class="line">391</td><td class="hits"></td><td class="source">        anonymous: _anonymous,</td></tr><tr><td class="line">392</td><td class="hits"></td><td class="source">        oauthHooks: {</td></tr><tr><td class="line">393</td><td class="hits"></td><td class="source">            authenticateToken: _authenticateToken,</td></tr><tr><td class="line">394</td><td class="hits"></td><td class="source">            validateClient: _validateClient,</td></tr><tr><td class="line">395</td><td class="hits"></td><td class="source">            grantUserToken: _grantUserToken</td></tr><tr><td class="line">396</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">397</td><td class="hits"></td><td class="source">        clientOrUser: _clientOrUser,</td></tr><tr><td class="line">398</td><td class="hits"></td><td class="source">        refreshSessionData: _refreshSessionData,</td></tr><tr><td class="line">399</td><td class="hits"></td><td class="source">        refreshSessionForUser: _refreshSessionForUser,</td></tr><tr><td class="line">400</td><td class="hits"></td><td class="source">        verifyMailgun: _verifyMailgun,</td></tr><tr><td class="line">401</td><td class="hits"></td><td class="source">        optional: _optional</td></tr><tr><td class="line">402</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">403</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">404</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">405</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">406</td><td class="hits">1</td><td class="source">module.exports = AuthController;</td></tr><tr><td class="line">407</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/controllers/billing.js">/Users/warner/code/clipppr/primeloop-api/controllers/billing.js</h2><div id="stats" class="high"><div class="percentage">76%</div><div class="sloc">81</div><div class="hits">62</div><div class="misses">19</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var BillingController = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        restify = require(&quot;restify&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        moment = require(&quot;moment&quot;);</td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">        ArrayUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/array&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        JSONUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/json&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        _ = require(&quot;underscore&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        User = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/user&quot;).Model,</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        TrackingUrl = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/tracking_url&quot;).Model,</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        Customer = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/customer&quot;),</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        Campaign = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/notebook&quot;),</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        TrackingUrlActivity = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/tracking_url_activity&quot;).Model;</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">17</td><td class="hits">1</td><td class="source">    var _currentMonth = function(req, res, next) {</td></tr><tr class="hit"><td class="line">18</td><td class="hits">2</td><td class="source">        var filter = req.params.filter || {campaigns: []};</td></tr><tr class="hit"><td class="line">19</td><td class="hits">2</td><td class="source">        var billing_summary = {</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">            total_clicks: 0,</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">            amount_owed: 0,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">            due_on: new moment().endOf('month').toDate(),</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">            discount: 0,</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">            active_campaigns: false,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">            days_until: &quot;0 days&quot;</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        };</td></tr><tr class="hit"><td class="line">27</td><td class="hits">2</td><td class="source">        var customer;</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">29</td><td class="hits">2</td><td class="source">        var trackingIds = [];</td></tr><tr class="hit"><td class="line">30</td><td class="hits">2</td><td class="source">        var trackingPromise;</td></tr><tr class="hit"><td class="line">31</td><td class="hits">2</td><td class="source">        var customerPromise;</td></tr><tr class="hit"><td class="line">32</td><td class="hits">2</td><td class="source">        var trackingAggregateSumClickPromise;</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">34</td><td class="hits">2</td><td class="source">        var query = {</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">            &quot;users.user&quot;: {</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">                $in:[req.user._id]</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        };</td></tr><tr class="hit"><td class="line">39</td><td class="hits">2</td><td class="source">        var newFilter = JSONUtils.tryParseJSON(filter);</td></tr><tr class="hit"><td class="line">40</td><td class="hits">2</td><td class="source">        if(newFilter !== false) {</td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">            filter = newFilter;</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">44</td><td class="hits">2</td><td class="source">        if(!filter.campaigns) {</td></tr><tr class="hit"><td class="line">45</td><td class="hits">1</td><td class="source">            filter.campaigns = [];</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">48</td><td class="hits">2</td><td class="source">        var promise =</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">            Campaign.Model</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">                .find(query)</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">                .populate(&quot;users.user&quot;, &quot;firstName lastName email trial trialStart gravatarHash&quot;)</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">                .exec();</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">54</td><td class="hits">2</td><td class="source">        promise.then(function(campaigns){</td></tr><tr class="hit"><td class="line">55</td><td class="hits">2</td><td class="source">            if(!campaigns || campaigns.length === 0) {</td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">                throw new Error('abort promise chain');</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">                // return res.send(billing_summary);</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">            //this gives me all the campaigns a user is a part of</td></tr><tr class="hit"><td class="line">60</td><td class="hits">2</td><td class="source">            var idx = -1;</td></tr><tr class="hit"><td class="line">61</td><td class="hits">2</td><td class="source">            for(var i = 0; i &lt; campaigns.length; i++) {</td></tr><tr class="hit"><td class="line">62</td><td class="hits">6</td><td class="source">                var campaign = campaigns[i];</td></tr><tr class="hit"><td class="line">63</td><td class="hits">6</td><td class="source">                if(campaign.enabled === true) {</td></tr><tr class="hit"><td class="line">64</td><td class="hits">6</td><td class="source">                    billing_summary.active_campaigns = true;</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">                }</td></tr><tr class="hit"><td class="line">66</td><td class="hits">6</td><td class="source">                idx = ArrayUtils.inArray(req.user._id, campaign.users, &quot;user._id&quot;);</td></tr><tr class="hit"><td class="line">67</td><td class="hits">6</td><td class="source">                if(idx &gt;= 0 &amp;&amp; campaign.users[idx].role == &quot;campaign_owner&quot;) {</td></tr><tr class="hit"><td class="line">68</td><td class="hits">6</td><td class="source">                    filter.campaigns.push(campaign._id);</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">71</td><td class="hits">2</td><td class="source">            promise.complete();</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">        }).then(function(){</td></tr><tr class="hit"><td class="line">73</td><td class="hits">2</td><td class="source">            customerPromise = </td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">                Customer.Model</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">                    .find({user:req.user._id})</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">                    .populate(&quot;plan coupon&quot;)</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">                    .exec();</td></tr><tr class="hit"><td class="line">78</td><td class="hits">2</td><td class="source">            return customerPromise;</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">        }).then(function(customers){</td></tr><tr class="hit"><td class="line">80</td><td class="hits">2</td><td class="source">            if(!customers || customers.length &gt; 1) {</td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="source">                throw new Error('No customer record found!');</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">            //TODO: make this reliant on the plan they are a part of</td></tr><tr class="hit"><td class="line">84</td><td class="hits">2</td><td class="source">            customer = customers[0];</td></tr><tr class="hit"><td class="line">85</td><td class="hits">2</td><td class="source">            if(!filter.date_range) {</td></tr><tr class="hit"><td class="line">86</td><td class="hits">1</td><td class="source">                filter.date_range = {</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">                    from: new moment().startOf('month').toDate(),</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">                    to: new moment().endOf('month').toDate()</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">            </td></tr><tr class="hit"><td class="line">92</td><td class="hits">2</td><td class="source">            customerPromise.complete();</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">        }).then(function() {</td></tr><tr class="hit"><td class="line">94</td><td class="hits">2</td><td class="source">            var trackingQuery = {};</td></tr><tr class="hit"><td class="line">95</td><td class="hits">2</td><td class="source">            if(filter.campaigns) {</td></tr><tr class="hit"><td class="line">96</td><td class="hits">2</td><td class="source">                trackingQuery.campaign = {</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">                    $in: filter.campaigns</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">100</td><td class="hits">2</td><td class="source">            trackingPromise =</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">                TrackingUrl</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">                    .find(trackingQuery)</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">                    .exec();</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">105</td><td class="hits">2</td><td class="source">            return trackingPromise;</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">        }).then(function(urls){</td></tr><tr class="hit"><td class="line">107</td><td class="hits">2</td><td class="source">            if(!urls || urls.length === 0) {</td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="source">                throw new Error('abort promise chain');</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">110</td><td class="hits">2</td><td class="source">            for(var k = 0; k &lt; urls.length; k++){</td></tr><tr class="hit"><td class="line">111</td><td class="hits">42</td><td class="source">                trackingIds.push(urls[k]._id);</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">113</td><td class="hits">2</td><td class="source">            trackingPromise.complete();</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">        }).then(function(){</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">            //now we just need to add all the clicks into our object and calculate the charges for this month</td></tr><tr class="hit"><td class="line">117</td><td class="hits">2</td><td class="source">            trackingAggregateSumClickPromise =</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">                TrackingUrlActivity</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">                    .aggregate(</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">                        [{</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">                            $match: {</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">                                trackingId: {</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">                                    $in:trackingIds</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">                                },</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">                                isBot:false,</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">                                $or:[</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">                                    {inactive:false},</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">                                    {inactive: { $exists: false }}</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">                                ], </td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">                                created : {</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">                                    &quot;$gte&quot;: filter.date_range.from, </td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">                                    &quot;$lte&quot;: filter.date_range.to</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">                                }</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">                        },</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">                        {</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">                            $group: {</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">                                _id: null,</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">                                total_clicks: {$sum:1}</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">                        }]</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">                    )</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">                    .exec();</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">145</td><td class="hits">2</td><td class="source">            return trackingAggregateSumClickPromise;</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">        }).then(function(sumActivities){</td></tr><tr class="hit"><td class="line">147</td><td class="hits">2</td><td class="source">            if(sumActivities &amp;&amp; sumActivities.length &gt; 0) {</td></tr><tr class="hit"><td class="line">148</td><td class="hits">1</td><td class="source">                billing_summary.total_clicks = sumActivities[0].total_clicks;</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="hit"><td class="line">150</td><td class="hits">1</td><td class="source">                billing_summary.total_clicks = 0;</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">153</td><td class="hits">2</td><td class="source">            trackingAggregateSumClickPromise.complete();</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">        }).then(function() {</td></tr><tr class="hit"><td class="line">155</td><td class="hits">2</td><td class="source">            if(customer.coupon) {</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">                //set the discount here</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">                // billing_summary.discount = customer.</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">159</td><td class="hits">2</td><td class="source">            var bill_clicks = 0;</td></tr><tr class="hit"><td class="line">160</td><td class="hits">2</td><td class="source">            if(customer.plan.metadata.freeClicks &gt; 0) {</td></tr><tr class="miss"><td class="line">161</td><td class="hits">0</td><td class="source">                var total_clicks = 0;</td></tr><tr class="miss"><td class="line">162</td><td class="hits">0</td><td class="source">                if(customer.invoices.length &gt; 0) {</td></tr><tr class="miss"><td class="line">163</td><td class="hits">0</td><td class="source">                    for(var i = 0; i &lt; customer.invoices.length; i++) {</td></tr><tr class="miss"><td class="line">164</td><td class="hits">0</td><td class="source">                        total_clicks += customer.invoices[i].totalClicks;</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">166</td><td class="hits">0</td><td class="source">                    if(total_clicks &lt;= customer.plan.metadata.freeClicks) {</td></tr><tr class="miss"><td class="line">167</td><td class="hits">0</td><td class="source">                        billing_summary.amount_owed = 0;</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">                    } else {</td></tr><tr class="miss"><td class="line">169</td><td class="hits">0</td><td class="source">                        var overage = 5000 - total_clicks;</td></tr><tr class="miss"><td class="line">170</td><td class="hits">0</td><td class="source">                        if(overage &gt; billing_summary.total_clicks) {</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">                            //assume they already got charged and just bill for this month</td></tr><tr class="miss"><td class="line">172</td><td class="hits">0</td><td class="source">                            bill_clicks = Math.ceil(billing_summary.total_clicks/1000);</td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="source">                        } else if (overage &lt; billing_summary.total_clicks){</td></tr><tr class="miss"><td class="line">174</td><td class="hits">0</td><td class="source">                            bill_clicks = Math.ceil((billing_summary.total_clicks - overage)/1000);</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">                        } </td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">                //need to go through past invoices to calculate what's currently owed</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">            } else {</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">                //first we need to take total clicks/1000, rounded up to nearest thousand</td></tr><tr class="hit"><td class="line">181</td><td class="hits">2</td><td class="source">                bill_clicks = Math.ceil(billing_summary.total_clicks/1000);</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">184</td><td class="hits">2</td><td class="source">            billing_summary.amount_owed = customer.plan.metadata.chargePerThousandClicks * bill_clicks;</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">            //TODO: implement coupon stuff</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">            // if(customer.coupon) {</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">            //     if(customer.coupon.)</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">            // }</td></tr><tr class="hit"><td class="line">189</td><td class="hits">2</td><td class="source">            var today = moment();</td></tr><tr class="hit"><td class="line">190</td><td class="hits">2</td><td class="source">            var billDue = moment(customer.nextBillDue);</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">            </td></tr><tr class="hit"><td class="line">192</td><td class="hits">2</td><td class="source">            billing_summary.due_on = {</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">                date:customer.nextBillDue,</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">                days_until: billDue.diff(today, 'days') + &quot; days&quot;</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source">            };</td></tr><tr class="hit"><td class="line">196</td><td class="hits">2</td><td class="source">            return res.send(billing_summary);</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">        }).then(null, function(err){</td></tr><tr class="miss"><td class="line">198</td><td class="hits">0</td><td class="source">            if (err.message === 'abort promise chain') {</td></tr><tr class="miss"><td class="line">199</td><td class="hits">0</td><td class="source">                return res.send(billing_summary);</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">            else {</td></tr><tr class="miss"><td class="line">202</td><td class="hits">0</td><td class="source">                console.log(&quot;we got an error somewhere along the way&quot;, err);</td></tr><tr class="miss"><td class="line">203</td><td class="hits">0</td><td class="source">                next(err);</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">            } </td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">210</td><td class="hits">1</td><td class="source">    var _invoices = function(req, res, next) {</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">214</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">        currentMonth: _currentMonth,</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">        invoices: _invoices</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">221</td><td class="hits">1</td><td class="source">module.exports = BillingController;</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/controllers/campaigns.js">/Users/warner/code/clipppr/primeloop-api/controllers/campaigns.js</h2><div id="stats" class="high"><div class="percentage">78%</div><div class="sloc">307</div><div class="hits">242</div><div class="misses">65</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var CampaignsController = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        ArrayUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/array&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        restify = require(&quot;restify&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        Notebook = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/notebook&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        ReportAdditions = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/report_additions&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        Email = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/email&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        Page = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/page&quot;),</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        Clipp = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/clipp&quot;),</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        SuggestedClipp = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/suggested_clipp&quot;),</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        SuggestedAction = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/suggested_action&quot;),</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        User = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/user&quot;),</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        Customer = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/customer&quot;),</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        BatchImport = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/batch_import&quot;),</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        TrackingUrl = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/tracking_url&quot;),</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        TrackingUrlActivity = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/tracking_url_activity&quot;),</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        SuggestedBatchImport  =require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/suggested_batch_import&quot;),</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        restifyErrors = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/errors&quot;)(restify),</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        moment = require(&quot;moment&quot;),</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        AuthController = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/./auth&quot;),</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        FeedParsingUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/feed_parsing&quot;),</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        SmartQuoteRemovalUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/smart_quote_removal&quot;),</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        Validations = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/validations&quot;),</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        async = require(&quot;async&quot;),</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        redisq = require('redisq'),</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        check = require('validator').check,</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        cheerio = require(&quot;cheerio&quot;),</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        uaParser = require(&quot;ua-parser&quot;),</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        _ = require(&quot;underscore&quot;);</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">33</td><td class="hits">1</td><td class="source">    var PER_PAGE = 20;</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">35</td><td class="hits">1</td><td class="source">    var _list = function(req, res, next) {</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">37</td><td class="hits">2</td><td class="source">        var</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">            page = parseInt(req.params.page || 1, 10),</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">            per_page = parseInt(req.params.per_page || PER_PAGE, 10),</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">            user_id = req.params.user_id;</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">42</td><td class="hits">2</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">                &quot;users.user&quot; : req.user._id</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">            .populate(&quot;users.user&quot;, &quot;firstName lastName email trial trialStart gravatarHash&quot;)</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">            .limit(per_page)</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">            .skip((page-1)*per_page)</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">            .exec(function(err, notebooks){</td></tr><tr class="hit"><td class="line">50</td><td class="hits">2</td><td class="source">                if(err) return next(err);</td></tr><tr class="hit"><td class="line">51</td><td class="hits">2</td><td class="source">                notebooks = Notebook.prepareMultipleForOutput(notebooks, req.user);</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">53</td><td class="hits">2</td><td class="source">                return res.send({</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">                    notebooks: notebooks || [],</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">                    per_page: per_page,</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">                    page: page</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">62</td><td class="hits">1</td><td class="source">    var _view = function(req, res, next) {</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">64</td><td class="hits">4</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">                _id: req.params.id,</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">                // &quot;users.user&quot; : req.user._id</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">            }, &quot;name _id users created trial trialStart enabled demo type canReport google_analytics.username features siteUrls anonymousAccess alertsTracking retarget&quot;)</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">            .populate(&quot;users.user&quot;, &quot;firstName lastName email gravatarHash lastAction enabled trial trialStart&quot;)</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="hit"><td class="line">72</td><td class="hits">4</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">                // console.log(&quot;notebook users %j&quot;, notebook.users);</td></tr><tr class="hit"><td class="line">75</td><td class="hits">4</td><td class="source">                if(!notebook) {</td></tr><tr class="hit"><td class="line">76</td><td class="hits">1</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;Campaign does not exist&quot;));</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">79</td><td class="hits">3</td><td class="source">                var anonymousAccess = (req.user._id == &quot;anonymous&quot; &amp;&amp; notebook.anonymousAccess === true);</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">                // console.log(req.user._id, notebook.anonymousAccess);</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">                //TODO: if teh user doesn't have permission to view the collaborators remove them!</td></tr><tr class="hit"><td class="line">82</td><td class="hits">3</td><td class="source">                if(notebook.getPermissions(req.user).indexOf(&quot;view_notebooks&quot;) &lt; 0 &amp;&amp; !anonymousAccess &amp;&amp; req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="hit"><td class="line">83</td><td class="hits">2</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to view this campaign&quot;));</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">                // console.log(notebook.users);</td></tr><tr class="hit"><td class="line">86</td><td class="hits">1</td><td class="source">                notebook = Notebook.prepareForOutput(notebook, req.user);</td></tr><tr class="hit"><td class="line">87</td><td class="hits">1</td><td class="source">                return res.send(notebook);</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">91</td><td class="hits">1</td><td class="source">    var _add = function(req, res, next) {</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">93</td><td class="hits">5</td><td class="source">        var</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">            _user = req.user,</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">            user = {</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">                _id : req.params.user_id</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">            };</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">99</td><td class="hits">5</td><td class="source">        if(_user.permissions.indexOf(&quot;add_notebook&quot;) &lt; 0) {</td></tr><tr class="hit"><td class="line">100</td><td class="hits">1</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permissions to add a campaign&quot;));</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">104</td><td class="hits">4</td><td class="source">        if(user._id &amp;&amp; _user._id != user._id &amp;&amp; (_user.permissions.indexOf(&quot;add_notebook_to_account&quot;) &gt;= 0 || _user.permissions.indexOf(&quot;add_notebook_to_referred_account&quot;) &gt;= 0)) {</td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="source">            User.Model</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">                .findOne({</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">                    _id: user._id</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">                .lean()</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">                .exec(function(err, usr){</td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr class="miss"><td class="line">112</td><td class="hits">0</td><td class="source">                    if(!usr) return next(new restify.ResourceNotFoundError(&quot;User does not exist&quot;));</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="source">                    if(_user.permissions.indexOf(&quot;add_notebook_to_referred_account&quot;) &gt;= 0 &amp;&amp; usr.refBy != _user._id) {</td></tr><tr class="miss"><td class="line">116</td><td class="hits">0</td><td class="source">                        return next(new restify.NotAuthorizedError(&quot;You don't have permissions to add a campaign to this user's account.&quot;));</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="source">                    user = usr;</td></tr><tr class="miss"><td class="line">120</td><td class="hits">0</td><td class="source">                    return createNotebook();</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"><td class="line">123</td><td class="hits">4</td><td class="source">            user = _user;</td></tr><tr class="hit"><td class="line">124</td><td class="hits">4</td><td class="source">            return createNotebook();</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">127</td><td class="hits">0</td><td class="source">        function createNotebook(){</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">129</td><td class="hits">4</td><td class="source">            var notebook = new Notebook.Model(req.params);</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">131</td><td class="hits">4</td><td class="source">            notebook.users.push({</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">                user: user._id,</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">                role: &quot;campaign_owner&quot;</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">137</td><td class="hits">4</td><td class="source">            notebook.save(function(err, saved){</td></tr><tr class="hit"><td class="line">138</td><td class="hits">4</td><td class="source">                if(err &amp;&amp; err.errors) {</td></tr><tr class="hit"><td class="line">139</td><td class="hits">1</td><td class="source">                    return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">                }</td></tr><tr class="hit"><td class="line">141</td><td class="hits">3</td><td class="source">                else if(err) return next(err);</td></tr><tr class="hit"><td class="line">142</td><td class="hits">3</td><td class="source">                if(notebook.enabled === true) {</td></tr><tr class="hit"><td class="line">143</td><td class="hits">2</td><td class="source">                    Customer.updateCustomer(user, notebook, function(err, customer){</td></tr><tr class="hit"><td class="line">144</td><td class="hits">2</td><td class="source">                        if(err) console.log(&quot;there was an error updating customer record for %s&quot;, user.email, err);</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">                //Refresh user session here</td></tr><tr class="hit"><td class="line">148</td><td class="hits">3</td><td class="source">                AuthController.refreshSessionForUser(user, function(err, result){</td></tr><tr class="hit"><td class="line">149</td><td class="hits">3</td><td class="source">                    if(err) console.log(&quot;Error refreshing session after creating notebook:&quot;, err);</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">152</td><td class="hits">3</td><td class="source">                return res.send(saved);</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">160</td><td class="hits">1</td><td class="source">    var _update = function(req, res, next) {</td></tr><tr class="hit"><td class="line">161</td><td class="hits">5</td><td class="source">        var query = {</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">            _id: req.params.id,</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">            &quot;users.user&quot;: req.user._id</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">        }, analyticsInvite = false;</td></tr><tr class="hit"><td class="line">165</td><td class="hits">5</td><td class="source">        if(req.user.permissions.indexOf(&quot;edit_notebook_on_account&quot;) &gt;= 0) {</td></tr><tr class="hit"><td class="line">166</td><td class="hits">5</td><td class="source">            delete query[&quot;users.user&quot;];</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">169</td><td class="hits">5</td><td class="source">        var data = req.params;</td></tr><tr class="hit"><td class="line">170</td><td class="hits">5</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">            .findOne(query)</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="hit"><td class="line">173</td><td class="hits">5</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">175</td><td class="hits">5</td><td class="source">                if(!notebook) {</td></tr><tr class="hit"><td class="line">176</td><td class="hits">2</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;Campaign not found&quot;));</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">179</td><td class="hits">3</td><td class="source">                var idx = ArrayUtils.inArray(req.user._id, notebook.users, &quot;user._id&quot;);</td></tr><tr class="hit"><td class="line">180</td><td class="hits">3</td><td class="source">                var owner = false;</td></tr><tr class="hit"><td class="line">181</td><td class="hits">3</td><td class="source">                if(idx &gt;= 0 &amp;&amp; notebook.users[idx].role == &quot;campaign_owner&quot;) {</td></tr><tr class="hit"><td class="line">182</td><td class="hits">3</td><td class="source">                    owner = true;</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">                }</td></tr><tr class="hit"><td class="line">184</td><td class="hits">3</td><td class="source">                if(notebook.getPermissions(req.user).indexOf(&quot;edit_notebook&quot;) &lt; 0 &amp;&amp; req.user.permissions.indexOf(&quot;edit_notebook_on_account&quot;) &lt; 0) {</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">                    //Exception for people invite to connect google analytics</td></tr><tr class="miss"><td class="line">186</td><td class="hits">0</td><td class="source">                    if(ArrayUtils.inArray(req.user._id, notebook.google_analytics.invites) &gt;= 0) {</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">                        //only allow them to edit google analytics things</td></tr><tr class="miss"><td class="line">188</td><td class="hits">0</td><td class="source">                        analyticsInvite = true;</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">190</td><td class="hits">0</td><td class="source">                        req.params = {</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">                            google_analytics: req.params.google_analytics</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">                        };</td></tr><tr class="miss"><td class="line">193</td><td class="hits">0</td><td class="source">                    } else return next(new restify.NotAuthorizedError(&quot;You don't have permissions to edit this campaign&quot;));</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source">                //before we set the params we need to do some data munging</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source">                </td></tr><tr class="hit"><td class="line">197</td><td class="hits">3</td><td class="source">                notebook.setAll(req.params);</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">                </td></tr><tr class="hit"><td class="line">199</td><td class="hits">3</td><td class="source">                var campaignInactive = false;</td></tr><tr class="hit"><td class="line">200</td><td class="hits">3</td><td class="source">                if(req.params.type &amp;&amp; notebook.enabled) {</td></tr><tr class="miss"><td class="line">201</td><td class="hits">0</td><td class="source">                    if(req.params.type == &quot;paused&quot; || req.params.type == &quot;archived&quot;) {</td></tr><tr class="miss"><td class="line">202</td><td class="hits">0</td><td class="source">                        campaignInactive = true;</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">206</td><td class="hits">3</td><td class="source">                if(req.params.google_analytics &amp;&amp; req.params.google_analytics.goals) notebook.google_analytics.goals = req.params.google_analytics.goals;</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">208</td><td class="hits">3</td><td class="source">                if(campaignInactive) {</td></tr><tr class="miss"><td class="line">209</td><td class="hits">0</td><td class="source">                    TrackingUrl.updateTrackingUrlsWithRetargetedCampaigns(notebook._id, notebook.retarget.campaigns, campaignInactive, function(err){</td></tr><tr class="miss"><td class="line">210</td><td class="hits">0</td><td class="source">                        if(err) return next(new restifyErrors.InvalidInputError(err));</td></tr><tr class="miss"><td class="line">211</td><td class="hits">0</td><td class="source">                        _saveNotebook(notebook);</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="hit"><td class="line">214</td><td class="hits">3</td><td class="source">                    _saveNotebook(notebook);</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">                </td></tr><tr class="hit"><td class="line">217</td><td class="hits">3</td><td class="source">                function _saveNotebook(notebook) {</td></tr><tr class="hit"><td class="line">218</td><td class="hits">3</td><td class="source">                    if(owner &amp;&amp; notebook.enabled) {</td></tr><tr class="hit"><td class="line">219</td><td class="hits">3</td><td class="source">                        Customer.updateCustomer(req.user, notebook, function(err, customer){</td></tr><tr class="hit"><td class="line">220</td><td class="hits">3</td><td class="source">                            console.log(&quot;updating customer record %s&quot;, req.user.email);</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">                    </td></tr><tr class="hit"><td class="line">224</td><td class="hits">3</td><td class="source">                    notebook.save(function(err, saved){</td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">226</td><td class="hits">3</td><td class="source">                        if(err &amp;&amp; err.errors) {</td></tr><tr class="hit"><td class="line">227</td><td class="hits">1</td><td class="source">                            return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source">                        }</td></tr><tr class="hit"><td class="line">229</td><td class="hits">2</td><td class="source">                        else if(err) return next(err);</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">231</td><td class="hits">2</td><td class="source">                        saved = Notebook.prepareForOutput(saved, req.user);</td></tr><tr class="hit"><td class="line">232</td><td class="hits">2</td><td class="source">                        res.send(saved);</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">                        //if they invited someone to connect then we need to send an update email to owner</td></tr><tr class="hit"><td class="line">234</td><td class="hits">2</td><td class="source">                        if(analyticsInvite) {</td></tr><tr class="miss"><td class="line">235</td><td class="hits">0</td><td class="source">                            Notebook.getOwnerForNotebook(saved, function(err, owner){</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source">                                // console.log(&quot;returned owner %j&quot;, owner);</td></tr><tr class="miss"><td class="line">237</td><td class="hits">0</td><td class="source">                                if(owner) {</td></tr><tr class="miss"><td class="line">238</td><td class="hits">0</td><td class="source">                                    var from = Settings.email.from;</td></tr><tr class="miss"><td class="line">239</td><td class="hits">0</td><td class="source">                                    var email = new Email.Model({</td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source">                                        to: owner.user.email,</td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source">                                        from: from,</td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source">                                        subject: &quot;Your Google Analytics account is now connected to Primeloop&quot;,</td></tr><tr><td class="line">243</td><td class="hits"></td><td class="source">                                        template: {</td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source">                                            name: &quot;analytics_connected.mu&quot;,</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source">                                            contentType: &quot;html&quot;,</td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source">                                            data: {</td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source">                                                invitee: req.user,</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source">                                                user: owner.user</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">                                            }</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source">                                        }</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source">                                    });</td></tr><tr class="miss"><td class="line">252</td><td class="hits">0</td><td class="source">                                    email.send(function(err, result){</td></tr><tr class="miss"><td class="line">253</td><td class="hits">0</td><td class="source">                                        if(err) console.log(&quot;Error sending notebook invite email:&quot;, err);</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source">                                    });</td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">                                }</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source">                </td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">266</td><td class="hits">1</td><td class="source">    var _invite = function(req, res, next) {</td></tr><tr><td class="line">267</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">268</td><td class="hits">11</td><td class="source">        var query = {</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">            _id: req.params.id,</td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source">            &quot;users.user&quot;: req.user._id</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">272</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">273</td><td class="hits">11</td><td class="source">        if(req.user.permissions.indexOf(&quot;edit_notebook_on_account&quot;) &gt;= 0) {</td></tr><tr class="hit"><td class="line">274</td><td class="hits">9</td><td class="source">            delete query[&quot;users.user&quot;];</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">276</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">277</td><td class="hits">11</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source">            .findOne(query)</td></tr><tr><td class="line">279</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="hit"><td class="line">280</td><td class="hits">11</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">282</td><td class="hits">11</td><td class="source">                if(!notebook) {</td></tr><tr class="hit"><td class="line">283</td><td class="hits">1</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;Campaign not found&quot;));</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">286</td><td class="hits">10</td><td class="source">                if(notebook.getPermissions(req.user).indexOf(&quot;invite_users&quot;) &lt; 0 &amp;&amp; req.user.permissions.indexOf(&quot;edit_notebook_on_account&quot;) &lt; 0) {</td></tr><tr class="hit"><td class="line">287</td><td class="hits">2</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to invite people to this campaign&quot;));</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source">                /*</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source">                    TODO: What other roles should we be caring about people inviting?</td></tr><tr><td class="line">292</td><td class="hits"></td><td class="source">                    We should add a can_invite array to the permissions notebook.canInvite(req.user, &quot;role&quot;)</td></tr><tr><td class="line">293</td><td class="hits"></td><td class="source">                */</td></tr><tr class="hit"><td class="line">294</td><td class="hits">8</td><td class="source">                if(req.params.role == &quot;campaign_owner&quot; &amp;&amp; notebook.getPermissions(req.user).indexOf(&quot;invite_owner&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">295</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to invite owners to this campaign&quot;));</td></tr><tr><td class="line">296</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">297</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">298</td><td class="hits">8</td><td class="source">                req.params.role = req.params.role || &quot;campaign_collaborator&quot;;</td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source">                // console.log(&quot;invite params %j&quot;, req.params);</td></tr><tr class="hit"><td class="line">300</td><td class="hits">8</td><td class="source">                notebook.inviteUser(req.params, function(err, invitedUser, isNew){</td></tr><tr><td class="line">301</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">302</td><td class="hits">8</td><td class="source">                    if(err &amp;&amp; err.errors) {</td></tr><tr class="hit"><td class="line">303</td><td class="hits">2</td><td class="source">                        return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">304</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="hit"><td class="line">305</td><td class="hits">6</td><td class="source">                    else if(err) return next(err);</td></tr><tr><td class="line">306</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">307</td><td class="hits">6</td><td class="source">                    var from = Settings.email.from;</td></tr><tr class="hit"><td class="line">308</td><td class="hits">6</td><td class="source">                    if(isNew) {</td></tr><tr class="hit"><td class="line">309</td><td class="hits">4</td><td class="source">                        from = Settings.email.from_unsolicited;</td></tr><tr><td class="line">310</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="hit"><td class="line">311</td><td class="hits">6</td><td class="source">                    var data = {</td></tr><tr><td class="line">312</td><td class="hits"></td><td class="source">                        invitee: invitedUser,</td></tr><tr><td class="line">313</td><td class="hits"></td><td class="source">                        notebook: notebook,</td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source">                        user: req.user</td></tr><tr><td class="line">315</td><td class="hits"></td><td class="source">                    };</td></tr><tr class="hit"><td class="line">316</td><td class="hits">6</td><td class="source">                    var email = new Email.Model({</td></tr><tr><td class="line">317</td><td class="hits"></td><td class="source">                        to: invitedUser.email,</td></tr><tr><td class="line">318</td><td class="hits"></td><td class="source">                        from: from,</td></tr><tr><td class="line">319</td><td class="hits"></td><td class="source">                        subject: req.user.firstName + &quot; &quot; + req.user.lastName + &quot; has invited you to join their team at Primeloop - Retargeted Conversations&quot;</td></tr><tr><td class="line">320</td><td class="hits"></td><td class="source">                    });</td></tr><tr class="hit"><td class="line">321</td><td class="hits">6</td><td class="source">                    var template = (!invitedUser.enabled) ? &quot;notebook_invite_new_user.mu&quot; : &quot;notebook_invite.mu&quot;;</td></tr><tr class="hit"><td class="line">322</td><td class="hits">6</td><td class="source">                    email.renderTemplate(data, template, &quot;html&quot;, function(err, html){</td></tr><tr class="hit"><td class="line">323</td><td class="hits">6</td><td class="source">                        console.log(&quot;Email sent to:&quot;, invitedUser.email);</td></tr><tr class="hit"><td class="line">324</td><td class="hits">6</td><td class="source">                        email.send(function(err, result){</td></tr><tr class="hit"><td class="line">325</td><td class="hits">6</td><td class="source">                            if(err) console.log(&quot;Error sending notebook invite email:&quot;, err);</td></tr><tr><td class="line">326</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">327</td><td class="hits"></td><td class="source">                    } );</td></tr><tr><td class="line">328</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">329</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">330</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">331</td><td class="hits">6</td><td class="source">                    notebook.save(function(err, saved){</td></tr><tr><td class="line">332</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">333</td><td class="hits">6</td><td class="source">                        if(err) return next(err);</td></tr><tr><td class="line">334</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">335</td><td class="hits">6</td><td class="source">                        saved = Notebook.prepareForOutput(saved, req.user);</td></tr><tr><td class="line">336</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">337</td><td class="hits">6</td><td class="source">                        saved.newUser = User.prepareForOutput(invitedUser);</td></tr><tr class="hit"><td class="line">338</td><td class="hits">6</td><td class="source">                        saved.newUser.role = req.params.role;</td></tr><tr class="hit"><td class="line">339</td><td class="hits">6</td><td class="source">                        return res.send(saved);</td></tr><tr><td class="line">340</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">341</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">342</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">343</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">344</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">345</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">346</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">347</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">348</td><td class="hits"></td><td class="source">        TODO:</td></tr><tr><td class="line">349</td><td class="hits"></td><td class="source">            1. check permissions vs. role to see if the person can remove the other person</td></tr><tr><td class="line">350</td><td class="hits"></td><td class="source">            2. Notify the user that they have been removed (if it's not a demo notebook and if they didn't take the action)</td></tr><tr><td class="line">351</td><td class="hits"></td><td class="source">     */</td></tr><tr class="hit"><td class="line">352</td><td class="hits">1</td><td class="source">    var _removeUser = function(req, res, next) {</td></tr><tr class="hit"><td class="line">353</td><td class="hits">1</td><td class="source">        var</td></tr><tr><td class="line">354</td><td class="hits"></td><td class="source">            user_id = req.params.id || req.user._id;</td></tr><tr><td class="line">355</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">356</td><td class="hits">1</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">357</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">358</td><td class="hits"></td><td class="source">                _id: req.params.campaign</td></tr><tr><td class="line">359</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">360</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="hit"><td class="line">361</td><td class="hits">1</td><td class="source">                if(err) return next(err);</td></tr><tr class="hit"><td class="line">362</td><td class="hits">1</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Campaign not found&quot;));</td></tr><tr><td class="line">363</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">364</td><td class="hits">1</td><td class="source">                var</td></tr><tr><td class="line">365</td><td class="hits"></td><td class="source">                    idx = ArrayUtils.inArray(user_id, notebook.users, &quot;user&quot;);</td></tr><tr><td class="line">366</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">367</td><td class="hits">1</td><td class="source">                if(idx &lt; 0) return next(new restifyErrors.InvalidInputError(&quot;You've already been removed from this campaign&quot;));</td></tr><tr class="hit"><td class="line">368</td><td class="hits">1</td><td class="source">                if(user_id != req.user._id &amp;&amp; notebook.demo ===  false){</td></tr><tr class="hit"><td class="line">369</td><td class="hits">1</td><td class="source">                    var</td></tr><tr><td class="line">370</td><td class="hits"></td><td class="source">                        role = notebook.users[idx].role;</td></tr><tr><td class="line">371</td><td class="hits"></td><td class="source">                    // console.log(&quot;remove user %s, by %s, with role %s on notebook %s&quot;,user_id, req.user._id, role, notebook._id);</td></tr><tr class="hit"><td class="line">372</td><td class="hits">1</td><td class="source">                    if(role == &quot;campaign_owner&quot;) return next(new restifyErrors.InvalidInputError(&quot;You cannot remove the owner of this campaign.&quot;));</td></tr><tr class="hit"><td class="line">373</td><td class="hits">1</td><td class="source">                    if(role == &quot;campaign_manager&quot; &amp;&amp; notebook.getPermissions(req.user).indexOf(&quot;edit_managers&quot;) &lt; 0) return next(new restify.NotAuthorizedError(&quot;You don't have permission to edit this person&quot;));</td></tr><tr class="hit"><td class="line">374</td><td class="hits">1</td><td class="source">                    if(role == &quot;campaign_collaborator&quot; &amp;&amp; notebook.getPermissions(req.user).indexOf(&quot;edit_collaborators&quot;) &lt; 0) return next(new restify.NotAuthorizedError(&quot;You don't have permission to edit this person&quot;));</td></tr><tr><td class="line">375</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">376</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">377</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">378</td><td class="hits">1</td><td class="source">                notebook.removeUser(user_id, function(err, saved){</td></tr><tr class="hit"><td class="line">379</td><td class="hits">1</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">380</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">381</td><td class="hits">1</td><td class="source">                    if(user_id != req.user._id) {</td></tr><tr><td class="line">382</td><td class="hits"></td><td class="source">                        //send email to user, if they're enabled</td></tr><tr class="hit"><td class="line">383</td><td class="hits">1</td><td class="source">                        User.Model</td></tr><tr><td class="line">384</td><td class="hits"></td><td class="source">                            .findOne({</td></tr><tr><td class="line">385</td><td class="hits"></td><td class="source">                                _id: user_id,</td></tr><tr><td class="line">386</td><td class="hits"></td><td class="source">                                enabled: true</td></tr><tr><td class="line">387</td><td class="hits"></td><td class="source">                            }, &quot;email firstName lastName&quot;)</td></tr><tr><td class="line">388</td><td class="hits"></td><td class="source">                            .lean()</td></tr><tr><td class="line">389</td><td class="hits"></td><td class="source">                            .exec(function(err, user){</td></tr><tr class="hit"><td class="line">390</td><td class="hits">1</td><td class="source">                                if(err) return console.log(&quot;Error emailing user:&quot;, err.stack || err);</td></tr><tr class="hit"><td class="line">391</td><td class="hits">1</td><td class="source">                                if(!user) return;</td></tr><tr><td class="line">392</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">393</td><td class="hits">1</td><td class="source">                                var email = new Email.Model({</td></tr><tr><td class="line">394</td><td class="hits"></td><td class="source">                                    to: user.email,</td></tr><tr><td class="line">395</td><td class="hits"></td><td class="source">                                    subject: &quot;You've been removed from &quot; + saved.name,</td></tr><tr><td class="line">396</td><td class="hits"></td><td class="source">                                    template: {</td></tr><tr><td class="line">397</td><td class="hits"></td><td class="source">                                        name: &quot;removed_from_notebook.mu&quot;,</td></tr><tr><td class="line">398</td><td class="hits"></td><td class="source">                                        contentType: &quot;text&quot;,</td></tr><tr><td class="line">399</td><td class="hits"></td><td class="source">                                        data: {</td></tr><tr><td class="line">400</td><td class="hits"></td><td class="source">                                            user: user,</td></tr><tr><td class="line">401</td><td class="hits"></td><td class="source">                                            notebook: notebook</td></tr><tr><td class="line">402</td><td class="hits"></td><td class="source">                                        }</td></tr><tr><td class="line">403</td><td class="hits"></td><td class="source">                                    }</td></tr><tr><td class="line">404</td><td class="hits"></td><td class="source">                                });</td></tr><tr><td class="line">405</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">406</td><td class="hits">1</td><td class="source">                                email.send(function(err){</td></tr><tr class="hit"><td class="line">407</td><td class="hits">1</td><td class="source">                                    if(err) return console.log(&quot;Error email user:&quot;, err.stack || err);</td></tr><tr><td class="line">408</td><td class="hits"></td><td class="source">                                });</td></tr><tr><td class="line">409</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">410</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">411</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">412</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">413</td><td class="hits">1</td><td class="source">                    next();</td></tr><tr class="hit"><td class="line">414</td><td class="hits">1</td><td class="source">                    return res.send({</td></tr><tr><td class="line">415</td><td class="hits"></td><td class="source">                        _id: saved._id,</td></tr><tr><td class="line">416</td><td class="hits"></td><td class="source">                        status: &quot;success&quot;,</td></tr><tr><td class="line">417</td><td class="hits"></td><td class="source">                        message: &quot;You've been removed from the &quot; + saved.name + &quot; notebook.&quot;</td></tr><tr><td class="line">418</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">419</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">420</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">421</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">422</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">423</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">424</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">425</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">426</td><td class="hits">1</td><td class="source">    var _addShortUrl = function(req, res, next) {</td></tr><tr class="hit"><td class="line">427</td><td class="hits">7</td><td class="source">        var</td></tr><tr><td class="line">428</td><td class="hits"></td><td class="source">            campaign_id = req.params.id,</td></tr><tr><td class="line">429</td><td class="hits"></td><td class="source">            user_id = req.user._id,</td></tr><tr><td class="line">430</td><td class="hits"></td><td class="source">            channel = req.params.channel,</td></tr><tr><td class="line">431</td><td class="hits"></td><td class="source">            url = req.params.url;</td></tr><tr><td class="line">432</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">433</td><td class="hits">7</td><td class="source">        if(!campaign_id) return next(new restify.ResourceNotFoundError(&quot;Campaign not found&quot;));</td></tr><tr class="hit"><td class="line">434</td><td class="hits">7</td><td class="source">        try {</td></tr><tr class="hit"><td class="line">435</td><td class="hits">7</td><td class="source">            check(url).notNull().isUrl();</td></tr><tr><td class="line">436</td><td class="hits"></td><td class="source">        } catch (e) {</td></tr><tr class="hit"><td class="line">437</td><td class="hits">1</td><td class="source">            console.log(e.message); //Invalid integer</td></tr><tr class="hit"><td class="line">438</td><td class="hits">1</td><td class="source">            return next(new restifyErrors.InvalidInputError(e.message));</td></tr><tr><td class="line">439</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">440</td><td class="hits">6</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">441</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">442</td><td class="hits"></td><td class="source">                _id: campaign_id,</td></tr><tr><td class="line">443</td><td class="hits"></td><td class="source">                &quot;users.user&quot; : req.user._id</td></tr><tr><td class="line">444</td><td class="hits"></td><td class="source">            }, &quot;users name created siteUrls retarget enabled&quot;)</td></tr><tr><td class="line">445</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="hit"><td class="line">446</td><td class="hits">6</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">447</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">448</td><td class="hits">6</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Campaign not found&quot;));</td></tr><tr><td class="line">449</td><td class="hits"></td><td class="source">                // console.log(&quot;notebook %s, enabled %s&quot;, notebook._id, notebook.enabled);</td></tr><tr class="hit"><td class="line">450</td><td class="hits">7</td><td class="source">                if(!notebook.enabled) return next(new restifyErrors.InvalidInputError(&quot;You can only create retargeting urls on Live Campaigns.&quot;));</td></tr><tr><td class="line">451</td><td class="hits"></td><td class="source">                </td></tr><tr class="hit"><td class="line">452</td><td class="hits">5</td><td class="source">                if(!notebook.retarget || !notebook.retarget.campaigns || notebook.retarget.campaigns.length &lt;= 0){</td></tr><tr class="hit"><td class="line">453</td><td class="hits">1</td><td class="source">                    return next(new restifyErrors.InvalidInputError(&quot;Retargeting campaigns are not setup correctly.&quot;));</td></tr><tr><td class="line">454</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">455</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">456</td><td class="hits">4</td><td class="source">                notebook.addRetargetShortUrl(user_id, url, channel, function(err, saved) {</td></tr><tr class="hit"><td class="line">457</td><td class="hits">6</td><td class="source">                    if(err) return next(new restifyErrors.InvalidInputError(err));</td></tr><tr class="hit"><td class="line">458</td><td class="hits">2</td><td class="source">                    return res.send(saved);</td></tr><tr><td class="line">459</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">460</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">461</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">462</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">463</td><td class="hits">1</td><td class="source">    var _addShortUrlActivity = function(req, res, next) {</td></tr><tr class="hit"><td class="line">464</td><td class="hits">2</td><td class="source">        var</td></tr><tr><td class="line">465</td><td class="hits"></td><td class="source">            campaignId = req.params.id,</td></tr><tr><td class="line">466</td><td class="hits"></td><td class="source">            trackingId = req.params.trackingId,</td></tr><tr><td class="line">467</td><td class="hits"></td><td class="source">            blacklist = [</td></tr><tr><td class="line">468</td><td class="hits"></td><td class="source">                &quot;facebookbot&quot;,</td></tr><tr><td class="line">469</td><td class="hits"></td><td class="source">                &quot;twitterbot&quot;,</td></tr><tr><td class="line">470</td><td class="hits"></td><td class="source">                &quot;googlebot&quot;,</td></tr><tr><td class="line">471</td><td class="hits"></td><td class="source">                &quot;phantomjs&quot;,</td></tr><tr><td class="line">472</td><td class="hits"></td><td class="source">                &quot;slurp&quot;,</td></tr><tr><td class="line">473</td><td class="hits"></td><td class="source">                &quot;yandexbot&quot;,</td></tr><tr><td class="line">474</td><td class="hits"></td><td class="source">                &quot;python requests&quot;</td></tr><tr><td class="line">475</td><td class="hits"></td><td class="source">            ];</td></tr><tr><td class="line">476</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">477</td><td class="hits">2</td><td class="source">        var activity = TrackingUrlActivity.Model({</td></tr><tr><td class="line">478</td><td class="hits"></td><td class="source">            trackingId: trackingId,</td></tr><tr><td class="line">479</td><td class="hits"></td><td class="source">            campaign: campaignId,</td></tr><tr><td class="line">480</td><td class="hits"></td><td class="source">            data: req.params.data</td></tr><tr><td class="line">481</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">482</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">483</td><td class="hits"></td><td class="source">        //before we save we need to check if this is a bot</td></tr><tr class="hit"><td class="line">484</td><td class="hits">2</td><td class="source">        var isBot = false;</td></tr><tr class="hit"><td class="line">485</td><td class="hits">2</td><td class="source">        if(activity.data &amp;&amp; activity.data.agent) {</td></tr><tr class="hit"><td class="line">486</td><td class="hits">2</td><td class="source">            var parsedAgent = uaParser.parse(activity.data.agent);</td></tr><tr class="hit"><td class="line">487</td><td class="hits">2</td><td class="source">            var family = parsedAgent.ua.family.toLowerCase();</td></tr><tr class="hit"><td class="line">488</td><td class="hits">2</td><td class="source">            var device = parsedAgent.device.family.toLowerCase();</td></tr><tr><td class="line">489</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">490</td><td class="hits">2</td><td class="source">            if(device == &quot;spider&quot; || (device == &quot;other&quot; &amp;&amp; family == &quot;other&quot;)) {</td></tr><tr class="hit"><td class="line">491</td><td class="hits">1</td><td class="source">                isBot = true;</td></tr><tr class="hit"><td class="line">492</td><td class="hits">1</td><td class="source">            } else if(device == &quot;other&quot;) {</td></tr><tr class="hit"><td class="line">493</td><td class="hits">1</td><td class="source">                if(_.contains(blacklist, family) || family.indexOf(&quot;bot&quot;) &gt;= 0) {</td></tr><tr class="miss"><td class="line">494</td><td class="hits">0</td><td class="source">                    isBot = true;</td></tr><tr><td class="line">495</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">496</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">497</td><td class="hits"></td><td class="source">        } else {</td></tr><tr><td class="line">498</td><td class="hits"></td><td class="source">            //no user agent so it is probably a bot</td></tr><tr class="miss"><td class="line">499</td><td class="hits">0</td><td class="source">            isBot = true;</td></tr><tr><td class="line">500</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">501</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">502</td><td class="hits">2</td><td class="source">        activity.isBot = isBot;</td></tr><tr><td class="line">503</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">504</td><td class="hits"></td><td class="source">        //before save we need to look up current tracking info and flag any we don't want to count as clicks</td></tr><tr class="hit"><td class="line">505</td><td class="hits">2</td><td class="source">        TrackingUrl.Model</td></tr><tr><td class="line">506</td><td class="hits"></td><td class="source">            .findOne({_id:trackingId})</td></tr><tr><td class="line">507</td><td class="hits"></td><td class="source">            .exec(function(err, tracking){</td></tr><tr class="hit"><td class="line">508</td><td class="hits">2</td><td class="source">                if(err) {</td></tr><tr class="miss"><td class="line">509</td><td class="hits">0</td><td class="source">                    _saveActivity(activity);</td></tr><tr><td class="line">510</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="hit"><td class="line">511</td><td class="hits">2</td><td class="source">                    activity.inactive = tracking.campaignInactive;</td></tr><tr class="hit"><td class="line">512</td><td class="hits">2</td><td class="source">                    _saveActivity(activity);</td></tr><tr><td class="line">513</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">514</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">515</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">516</td><td class="hits">2</td><td class="source">        function _saveActivity(activity) {</td></tr><tr class="hit"><td class="line">517</td><td class="hits">2</td><td class="source">            activity.save(function(err, saved){</td></tr><tr class="hit"><td class="line">518</td><td class="hits">2</td><td class="source">                if(err) return next(err);</td></tr><tr class="hit"><td class="line">519</td><td class="hits">2</td><td class="source">                return res.send(saved);</td></tr><tr><td class="line">520</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">521</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">522</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">523</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">524</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">525</td><td class="hits">1</td><td class="source">    var _addRetargetCampaign = function(req, res, next) {</td></tr><tr class="hit"><td class="line">526</td><td class="hits">3</td><td class="source">        var query = {</td></tr><tr><td class="line">527</td><td class="hits"></td><td class="source">            _id: req.params.id,</td></tr><tr><td class="line">528</td><td class="hits"></td><td class="source">            &quot;users.user&quot;: req.user._id</td></tr><tr><td class="line">529</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">530</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">531</td><td class="hits">3</td><td class="source">        if(req.user.permissions.indexOf(&quot;edit_notebook_on_account&quot;) &gt;= 0) {</td></tr><tr class="hit"><td class="line">532</td><td class="hits">3</td><td class="source">            delete query[&quot;users.user&quot;];</td></tr><tr><td class="line">533</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">534</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">535</td><td class="hits">3</td><td class="source">        var data = req.params;</td></tr><tr class="hit"><td class="line">536</td><td class="hits">3</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">537</td><td class="hits"></td><td class="source">            .findOne(query)</td></tr><tr><td class="line">538</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="hit"><td class="line">539</td><td class="hits">3</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">540</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">541</td><td class="hits">3</td><td class="source">                if(!notebook) {</td></tr><tr class="miss"><td class="line">542</td><td class="hits">0</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;Campaign not found&quot;));</td></tr><tr><td class="line">543</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">544</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">545</td><td class="hits">3</td><td class="source">                if(notebook.getPermissions(req.user).indexOf(&quot;edit_notebook&quot;) &lt; 0 &amp;&amp; req.user.permissions.indexOf(&quot;edit_notebook_on_account&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">546</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to edit this campaign&quot;));</td></tr><tr><td class="line">547</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">548</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">549</td><td class="hits"></td><td class="source">                </td></tr><tr class="hit"><td class="line">550</td><td class="hits">3</td><td class="source">                if(!notebook.retarget || !notebook.retarget.campaigns) {</td></tr><tr class="miss"><td class="line">551</td><td class="hits">0</td><td class="source">                    notebook.retarget = {campaigns: []};</td></tr><tr><td class="line">552</td><td class="hits"></td><td class="source">                }</td></tr><tr class="hit"><td class="line">553</td><td class="hits">3</td><td class="source">                if(req.params.retargetList) {</td></tr><tr class="miss"><td class="line">554</td><td class="hits">0</td><td class="source">                    for(var i = 0; i &lt; req.params.retargetList.length; i++) {</td></tr><tr class="miss"><td class="line">555</td><td class="hits">0</td><td class="source">                        req.params.retargetList[i].retarget_code = SmartQuoteRemovalUtils.sqRemove(req.params.retargetList[i].retarget_code);</td></tr><tr class="miss"><td class="line">556</td><td class="hits">0</td><td class="source">                        notebook.retarget.campaigns.push(req.params.retargetList[i]);</td></tr><tr><td class="line">557</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">558</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="hit"><td class="line">559</td><td class="hits">3</td><td class="source">                    delete req.params.id;</td></tr><tr class="hit"><td class="line">560</td><td class="hits">3</td><td class="source">                    req.params.retarget_code = SmartQuoteRemovalUtils.sqRemove(req.params.retarget_code);</td></tr><tr class="hit"><td class="line">561</td><td class="hits">3</td><td class="source">                    notebook.retarget.campaigns.push(req.params);</td></tr><tr><td class="line">562</td><td class="hits"></td><td class="source">                }</td></tr><tr class="hit"><td class="line">563</td><td class="hits">3</td><td class="source">                var campaignInactive = false;</td></tr><tr class="hit"><td class="line">564</td><td class="hits">3</td><td class="source">                if(notebook.type == &quot;paused&quot; || notebook.type == &quot;archived&quot;) {</td></tr><tr class="miss"><td class="line">565</td><td class="hits">0</td><td class="source">                    campaignInactive = true;</td></tr><tr><td class="line">566</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">567</td><td class="hits"></td><td class="source">                </td></tr><tr class="hit"><td class="line">568</td><td class="hits">3</td><td class="source">                notebook.markModified(&quot;retarget&quot;);</td></tr><tr class="hit"><td class="line">569</td><td class="hits">3</td><td class="source">                TrackingUrl.updateTrackingUrlsWithRetargetedCampaigns(notebook._id, notebook.retarget.campaigns, campaignInactive, function(err){</td></tr><tr class="hit"><td class="line">570</td><td class="hits">3</td><td class="source">                    if(err) return next(new restifyErrors.InvalidInputError(err));</td></tr><tr class="hit"><td class="line">571</td><td class="hits">3</td><td class="source">                    notebook.save(function(err, saved){</td></tr><tr class="hit"><td class="line">572</td><td class="hits">3</td><td class="source">                        if(err &amp;&amp; err.errors) {</td></tr><tr class="miss"><td class="line">573</td><td class="hits">0</td><td class="source">                            return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">574</td><td class="hits"></td><td class="source">                        }</td></tr><tr class="hit"><td class="line">575</td><td class="hits">3</td><td class="source">                        else if(err) return next(err);</td></tr><tr><td class="line">576</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">577</td><td class="hits">3</td><td class="source">                        saved = Notebook.prepareForOutput(saved, req.user);</td></tr><tr class="hit"><td class="line">578</td><td class="hits">3</td><td class="source">                        res.send(saved);</td></tr><tr><td class="line">579</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">580</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">581</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">582</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">583</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">584</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">585</td><td class="hits">1</td><td class="source">    var _updateRetargetCampaign = function(req, res, next) {</td></tr><tr class="hit"><td class="line">586</td><td class="hits">1</td><td class="source">        var query = {</td></tr><tr><td class="line">587</td><td class="hits"></td><td class="source">            _id: req.params.id,</td></tr><tr><td class="line">588</td><td class="hits"></td><td class="source">            &quot;users.user&quot;: req.user._id</td></tr><tr><td class="line">589</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">590</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">591</td><td class="hits">1</td><td class="source">        if(req.user.permissions.indexOf(&quot;edit_notebook_on_account&quot;) &gt;= 0) {</td></tr><tr class="hit"><td class="line">592</td><td class="hits">1</td><td class="source">            delete query[&quot;users.user&quot;];</td></tr><tr><td class="line">593</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">594</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">595</td><td class="hits">1</td><td class="source">        var data = req.params;</td></tr><tr class="hit"><td class="line">596</td><td class="hits">1</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">597</td><td class="hits"></td><td class="source">            .findOne(query)</td></tr><tr><td class="line">598</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="hit"><td class="line">599</td><td class="hits">1</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">600</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">601</td><td class="hits">1</td><td class="source">                if(!notebook) {</td></tr><tr class="miss"><td class="line">602</td><td class="hits">0</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;Campaign not found&quot;));</td></tr><tr><td class="line">603</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">604</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">605</td><td class="hits">1</td><td class="source">                if(notebook.getPermissions(req.user).indexOf(&quot;edit_notebook&quot;) &lt; 0 &amp;&amp; req.user.permissions.indexOf(&quot;edit_notebook_on_account&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">606</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to edit this campaign&quot;));</td></tr><tr><td class="line">607</td><td class="hits"></td><td class="source">                }</td></tr><tr class="hit"><td class="line">608</td><td class="hits">1</td><td class="source">                if(!notebook.retarget || !notebook.retarget.campaigns || notebook.retarget.campaigns.length &lt;= 0) {</td></tr><tr class="miss"><td class="line">609</td><td class="hits">0</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;Retargeting campaign not found&quot;));</td></tr><tr><td class="line">610</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">611</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">612</td><td class="hits">1</td><td class="source">                var retargetCampaign = _.findWhere(notebook.retarget.campaigns, {_id: req.params.campaignId});</td></tr><tr class="hit"><td class="line">613</td><td class="hits">1</td><td class="source">                if(!retargetCampaign) {</td></tr><tr class="miss"><td class="line">614</td><td class="hits">0</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;Retargeting campaign not found&quot;));</td></tr><tr><td class="line">615</td><td class="hits"></td><td class="source">                }</td></tr><tr class="hit"><td class="line">616</td><td class="hits">1</td><td class="source">                retargetCampaign.name = req.params.name || retargetCampaign.name;</td></tr><tr class="hit"><td class="line">617</td><td class="hits">1</td><td class="source">                retargetCampaign.retarget_code = req.params.retarget_code || retargetCampaign.retarget_code;</td></tr><tr class="hit"><td class="line">618</td><td class="hits">1</td><td class="source">                retargetCampaign.retarget_type = req.params.retarget_type || retargetCampaign.retarget_type;</td></tr><tr class="hit"><td class="line">619</td><td class="hits">1</td><td class="source">                if(req.params.hasOwnProperty('enabled')) {</td></tr><tr class="hit"><td class="line">620</td><td class="hits">1</td><td class="source">                    retargetCampaign.enabled = req.params.enabled;</td></tr><tr><td class="line">621</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">622</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">623</td><td class="hits">1</td><td class="source">                var campaignInactive = false;</td></tr><tr class="hit"><td class="line">624</td><td class="hits">1</td><td class="source">                if(notebook.type == &quot;paused&quot; || notebook.type == &quot;archived&quot;) {</td></tr><tr class="miss"><td class="line">625</td><td class="hits">0</td><td class="source">                    campaignInactive = true;</td></tr><tr><td class="line">626</td><td class="hits"></td><td class="source">                }</td></tr><tr class="hit"><td class="line">627</td><td class="hits">1</td><td class="source">                notebook.markModified(&quot;retarget&quot;);</td></tr><tr class="hit"><td class="line">628</td><td class="hits">1</td><td class="source">                TrackingUrl.updateTrackingUrlsWithRetargetedCampaigns(notebook._id, notebook.retarget.campaigns, campaignInactive, function(err){</td></tr><tr class="hit"><td class="line">629</td><td class="hits">1</td><td class="source">                    if(err) return next(new restifyErrors.InvalidInputError(err));</td></tr><tr class="hit"><td class="line">630</td><td class="hits">1</td><td class="source">                    notebook.save(function(err, saved){</td></tr><tr class="hit"><td class="line">631</td><td class="hits">1</td><td class="source">                        if(err &amp;&amp; err.errors) {</td></tr><tr class="miss"><td class="line">632</td><td class="hits">0</td><td class="source">                            return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">633</td><td class="hits"></td><td class="source">                        }</td></tr><tr class="hit"><td class="line">634</td><td class="hits">1</td><td class="source">                        else if(err) return next(err);</td></tr><tr><td class="line">635</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">636</td><td class="hits">1</td><td class="source">                        saved = Notebook.prepareForOutput(saved, req.user);</td></tr><tr class="hit"><td class="line">637</td><td class="hits">1</td><td class="source">                        res.send(saved);</td></tr><tr><td class="line">638</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">639</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">640</td><td class="hits"></td><td class="source">                </td></tr><tr><td class="line">641</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">642</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">643</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">644</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">645</td><td class="hits">1</td><td class="source">    var _updateCampaignForWaitingUser = function(req, res, next) {</td></tr><tr class="miss"><td class="line">646</td><td class="hits">0</td><td class="source">        var query = {</td></tr><tr><td class="line">647</td><td class="hits"></td><td class="source">            _id: req.params.campaign,</td></tr><tr><td class="line">648</td><td class="hits"></td><td class="source">            &quot;users.user&quot;: req.params.id</td></tr><tr><td class="line">649</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">650</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">651</td><td class="hits"></td><td class="source">        // if(req.user.permissions.indexOf(&quot;edit_notebook_on_account&quot;) &gt;= 0) {</td></tr><tr><td class="line">652</td><td class="hits"></td><td class="source">        //     delete query[&quot;users.user&quot;];</td></tr><tr><td class="line">653</td><td class="hits"></td><td class="source">        // }</td></tr><tr><td class="line">654</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">655</td><td class="hits">0</td><td class="source">        var data = req.params;</td></tr><tr class="miss"><td class="line">656</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">657</td><td class="hits"></td><td class="source">            .findOne(query)</td></tr><tr><td class="line">658</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">659</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">660</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">661</td><td class="hits">0</td><td class="source">                if(!notebook) {</td></tr><tr class="miss"><td class="line">662</td><td class="hits">0</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;Campaign not found&quot;));</td></tr><tr><td class="line">663</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">664</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">665</td><td class="hits">0</td><td class="source">                var owner = _.findWhere(notebook.users, {user: req.params.id, role:&quot;campaign_owner&quot;});</td></tr><tr class="miss"><td class="line">666</td><td class="hits">0</td><td class="source">                if(!owner) {</td></tr><tr class="miss"><td class="line">667</td><td class="hits">0</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;User not owner of Campaign&quot;));</td></tr><tr><td class="line">668</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">669</td><td class="hits">0</td><td class="source">                if(req.params.name) {</td></tr><tr class="miss"><td class="line">670</td><td class="hits">0</td><td class="source">                    notebook.name = req.params.name;</td></tr><tr class="miss"><td class="line">671</td><td class="hits">0</td><td class="source">                    notebook.markModified(&quot;name&quot;);</td></tr><tr><td class="line">672</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="miss"><td class="line">673</td><td class="hits">0</td><td class="source">                    return res.send(notebook);</td></tr><tr><td class="line">674</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">675</td><td class="hits">0</td><td class="source">                notebook.save(function(err, saved){</td></tr><tr class="miss"><td class="line">676</td><td class="hits">0</td><td class="source">                    if(err &amp;&amp; err.errors) {</td></tr><tr class="miss"><td class="line">677</td><td class="hits">0</td><td class="source">                        return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">678</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">679</td><td class="hits">0</td><td class="source">                    else if(err) return next(err);</td></tr><tr><td class="line">680</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">681</td><td class="hits">0</td><td class="source">                    res.send({name:saved.name, _id:saved._id});</td></tr><tr><td class="line">682</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">683</td><td class="hits"></td><td class="source">                </td></tr><tr><td class="line">684</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">685</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">686</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">687</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">688</td><td class="hits">1</td><td class="source">    var _removeRetargetCampaign = function(req, res, next) {</td></tr><tr class="hit"><td class="line">689</td><td class="hits">1</td><td class="source">        var query = {</td></tr><tr><td class="line">690</td><td class="hits"></td><td class="source">            _id: req.params.id,</td></tr><tr><td class="line">691</td><td class="hits"></td><td class="source">            &quot;users.user&quot;: req.user._id</td></tr><tr><td class="line">692</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">693</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">694</td><td class="hits">1</td><td class="source">        if(req.user.permissions.indexOf(&quot;edit_notebook_on_account&quot;) &gt;= 0) {</td></tr><tr class="hit"><td class="line">695</td><td class="hits">1</td><td class="source">            delete query[&quot;users.user&quot;];</td></tr><tr><td class="line">696</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">697</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">698</td><td class="hits">1</td><td class="source">        var data = req.params;</td></tr><tr class="hit"><td class="line">699</td><td class="hits">1</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">700</td><td class="hits"></td><td class="source">            .findOne(query)</td></tr><tr><td class="line">701</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="hit"><td class="line">702</td><td class="hits">1</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">703</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">704</td><td class="hits">1</td><td class="source">                if(!notebook) {</td></tr><tr class="miss"><td class="line">705</td><td class="hits">0</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;Campaign not found&quot;));</td></tr><tr><td class="line">706</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">707</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">708</td><td class="hits">1</td><td class="source">                if(notebook.getPermissions(req.user).indexOf(&quot;edit_notebook&quot;) &lt; 0 &amp;&amp; req.user.permissions.indexOf(&quot;edit_notebook_on_account&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">709</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to edit this campaign&quot;));</td></tr><tr><td class="line">710</td><td class="hits"></td><td class="source">                }</td></tr><tr class="hit"><td class="line">711</td><td class="hits">1</td><td class="source">                if(!notebook.retarget || !notebook.retarget.campaigns || notebook.retarget.campaigns.length &lt;= 0) {</td></tr><tr class="miss"><td class="line">712</td><td class="hits">0</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;Retargeting campaign not found&quot;));</td></tr><tr><td class="line">713</td><td class="hits"></td><td class="source">                }</td></tr><tr class="hit"><td class="line">714</td><td class="hits">1</td><td class="source">                var idx = -1;</td></tr><tr class="hit"><td class="line">715</td><td class="hits">1</td><td class="source">                for(var i = 0; i &lt; notebook.retarget.campaigns.length; i++) {</td></tr><tr class="hit"><td class="line">716</td><td class="hits">2</td><td class="source">                    var retargetCampaign = notebook.retarget.campaigns[i];</td></tr><tr class="hit"><td class="line">717</td><td class="hits">2</td><td class="source">                    if(retargetCampaign._id == req.params.campaignId) {</td></tr><tr class="hit"><td class="line">718</td><td class="hits">1</td><td class="source">                        idx = i;</td></tr><tr><td class="line">719</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">720</td><td class="hits"></td><td class="source">                }</td></tr><tr class="hit"><td class="line">721</td><td class="hits">1</td><td class="source">                if(idx &lt; 0) {</td></tr><tr class="miss"><td class="line">722</td><td class="hits">0</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;Retargeting campaign not found&quot;));</td></tr><tr><td class="line">723</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">724</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">725</td><td class="hits">1</td><td class="source">                notebook.retarget.campaigns.splice(idx, 1);</td></tr><tr class="hit"><td class="line">726</td><td class="hits">1</td><td class="source">                notebook.markModified(&quot;retarget&quot;);</td></tr><tr class="hit"><td class="line">727</td><td class="hits">1</td><td class="source">                var campaignInactive = false;</td></tr><tr class="hit"><td class="line">728</td><td class="hits">1</td><td class="source">                if(notebook.type == &quot;paused&quot; || notebook.type == &quot;archived&quot;) {</td></tr><tr class="miss"><td class="line">729</td><td class="hits">0</td><td class="source">                    campaignInactive = true;</td></tr><tr><td class="line">730</td><td class="hits"></td><td class="source">                }</td></tr><tr class="hit"><td class="line">731</td><td class="hits">1</td><td class="source">                TrackingUrl.updateTrackingUrlsWithRetargetedCampaigns(notebook._id, notebook.retarget.campaigns,campaignInactive,  function(err){</td></tr><tr class="hit"><td class="line">732</td><td class="hits">1</td><td class="source">                    if(err) return next(new restifyErrors.InvalidInputError(err));</td></tr><tr class="hit"><td class="line">733</td><td class="hits">1</td><td class="source">                    notebook.save(function(err, saved){</td></tr><tr><td class="line">734</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">735</td><td class="hits">1</td><td class="source">                        if(err &amp;&amp; err.errors) {</td></tr><tr class="miss"><td class="line">736</td><td class="hits">0</td><td class="source">                            return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">737</td><td class="hits"></td><td class="source">                        }</td></tr><tr class="hit"><td class="line">738</td><td class="hits">1</td><td class="source">                        else if(err) return next(err);</td></tr><tr><td class="line">739</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">740</td><td class="hits">1</td><td class="source">                        saved = Notebook.prepareForOutput(saved, req.user);</td></tr><tr class="hit"><td class="line">741</td><td class="hits">1</td><td class="source">                        res.send(saved);</td></tr><tr><td class="line">742</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">743</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">744</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">745</td><td class="hits"></td><td class="source">                </td></tr><tr><td class="line">746</td><td class="hits"></td><td class="source">                </td></tr><tr><td class="line">747</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">748</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">749</td><td class="hits"></td><td class="source">    };</td></tr><tr class="hit"><td class="line">750</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">751</td><td class="hits"></td><td class="source">        list: _list,</td></tr><tr><td class="line">752</td><td class="hits"></td><td class="source">        view: _view,</td></tr><tr><td class="line">753</td><td class="hits"></td><td class="source">        add: _add,</td></tr><tr><td class="line">754</td><td class="hits"></td><td class="source">        update: _update,</td></tr><tr><td class="line">755</td><td class="hits"></td><td class="source">        invite: _invite,</td></tr><tr><td class="line">756</td><td class="hits"></td><td class="source">        removeUser: _removeUser,</td></tr><tr><td class="line">757</td><td class="hits"></td><td class="source">        addShortUrl: _addShortUrl,</td></tr><tr><td class="line">758</td><td class="hits"></td><td class="source">        addShortUrlActivity: _addShortUrlActivity,</td></tr><tr><td class="line">759</td><td class="hits"></td><td class="source">        addRetargetCampaign: _addRetargetCampaign,</td></tr><tr><td class="line">760</td><td class="hits"></td><td class="source">        updateRetargetCampaign: _updateRetargetCampaign,</td></tr><tr><td class="line">761</td><td class="hits"></td><td class="source">        updateCampaignForWaitingUser: _updateCampaignForWaitingUser,</td></tr><tr><td class="line">762</td><td class="hits"></td><td class="source">        removeRetargetCampaign: _removeRetargetCampaign</td></tr><tr><td class="line">763</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">764</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">765</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">766</td><td class="hits">1</td><td class="source">module.exports = CampaignsController;</td></tr><tr><td class="line">767</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/controllers/clipps.js">/Users/warner/code/clipppr/primeloop-api/controllers/clipps.js</h2><div id="stats" class="terrible"><div class="percentage">6%</div><div class="sloc">360</div><div class="hits">22</div><div class="misses">338</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var ClippsController = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        restify = require(&quot;restify&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        Page = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/page&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        PageError = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/page_error&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        Clipp = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/clipp&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        TrackingUrl = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/tracking_url&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        SuggestedClipp = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/suggested_clipp&quot;),</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        BatchImport = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/batch_import&quot;),</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        SuggestedBatchImport = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/suggested_batch_import&quot;),</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        ArrayUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/array&quot;),</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        StringUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/string&quot;),</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        ArchiveUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/archive&quot;),</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        Notebook = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/notebook&quot;).Model,</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        PageEngagement = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/page_engagement&quot;),</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        moment = require(&quot;moment&quot;),</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;),</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        request = require(&quot;request&quot;),</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        cheerio = require(&quot;cheerio&quot;),</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        json2csv = require(&quot;json2csv&quot;),</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        restifyErrors = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/errors&quot;)(restify),</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        redisq = require('redisq'),</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        check = require('validator').check;</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">    var _buildNotebookQuery = function(params, newOnly, analyticsOnly){</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">            notebook = params.notebook,</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">            tag = params.tag,</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">            domain = params.domain,</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">            query = {};</td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">            query.$and = [];</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">        query.$and.push({notebook : notebook._id});</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">        if(tag) query.$and.push({tags : new RegExp(&quot;^&quot;+tag+&quot;$&quot;, &quot;i&quot;)}); //tags shouldn't be case senstive</td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">        if(domain) query.$and.push({&quot;site.domain_url&quot; : domain});</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">        if(analyticsOnly) query.$and.push({&quot;conversion.conversion&quot; : {$exists: true}});</td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">        if(newOnly) {</td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">            var orQuery = [</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">                { 'notifications.engagement.facebook': { '$gt': 0 } },</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">                { 'notifications.engagement.twitter': { '$gt': 0 } },</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">                { 'notifications.engagement.twitter': { '$gt': 0 } },</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">                { 'notifications.engagement.linkedin': { '$gt': 0 } },</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">                { 'notifications.engagement.googleplus': { '$gt': 0 } },</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">                { 'notifications.engagement.reddit': { '$gt': 0 } },</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">                { 'notifications.engagement.comments': { '$gt': 0 } },</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">                { 'notifications.engagement.stumbleupon': { '$gt': 0 } },</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">                { 'notifications.engagement.pinterest': { '$gt': 0 } },</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">                { &quot;comments.0&quot;: { '$exists': true } }</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">            ];</td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="source">            query.$and.push({&quot;$or&quot;: orQuery});</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">            // console.log(&quot;query we should be running: &quot; + JSON.stringify(query));</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">        return query;</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">59</td><td class="hits">1</td><td class="source">    var _buildNotebookSort = function(params) {</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">            sort = {};</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="source">        if(params.sort == &quot;analytics&quot;) params.sort = &quot;conversion.visitors&quot;;</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">            sort_by = [params.sort || &quot;clippRank&quot;],</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">            sort_direction = params.sortdir || 1;</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="source">        if(sort_by[0].indexOf(&quot;,&quot;) &gt;= 0) sort_by = sort_by[0].split(&quot;,&quot;);</td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">        for(var i in sort_by) sort[sort_by[i]] = sort_direction;</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="source">        return sort;</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">77</td><td class="hits">1</td><td class="source">    var _list = function(req, res, next) {</td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">            notebook = req.params.notebook,</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">            page = parseInt(req.params.page || 1, 10),</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">            per_page = parseInt(req.params.per_page || 20, 10);</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="source">        if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="source">        if(req.params.filter == &quot;new&quot;) return _listNewOnly(req, res, next);</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="source">        var notebook_query = {</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">            _id: notebook,</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">            &quot;users.user&quot; : req.user._id</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &gt;= 0 || req.user._id === &quot;anonymous&quot;) notebook_query = {</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">            _id: notebook</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="source">        Notebook</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">            .findOne(notebook_query, &quot;users name created anonymousAccess&quot;)</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">            // .populate(&quot;clipps.clipp&quot;, null, null, { sort: {&quot;engagement.rank.current&quot; : -1}, limit: per_page, skip: (page-1)*per_page })</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="source">                if(notebook.getPermissions(req.user).indexOf(&quot;view_notebook_clipps&quot;) &lt; 0 &amp;&amp; req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to view this notebooks clipps&quot;));</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="source">                Clipp.Model</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">                    .find(_buildNotebookQuery({</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">                        notebook: notebook,</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">                        tag: req.params.tag,</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">                        domain: req.params.domain</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">                    }, false))</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">                    .sort(_buildNotebookSort(req.params))</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">                    .limit(per_page)</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">                    .skip((page-1)*per_page)</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">                    .populate(&quot;page&quot;, &quot;published updated error&quot;)</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">                    .exec(function(err, clipps){</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">123</td><td class="hits">0</td><td class="source">                        if(err) return next(err);</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">125</td><td class="hits">0</td><td class="source">                        Clipp.Model.populate(clipps,</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">                            {path: 'page.error', model: PageError.Model}, function(err, populated) {</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">                                // console.log(&quot;clipps before calling prepare&quot; + JSON.stringify(populated));</td></tr><tr class="miss"><td class="line">129</td><td class="hits">0</td><td class="source">                                clipps = Clipp.prepareMultipleForOutput(populated, req.user);</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">131</td><td class="hits">0</td><td class="source">                                return res.send({</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">                                    clipps: clipps,</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">                                    notebook: notebook,</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">                                    permissions: notebook.getPermissions(req.user),</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">                                    page: page,</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">                                    per_page: per_page,</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">                                    sort: &quot;rank&quot;</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">                                });</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">145</td><td class="hits">1</td><td class="source">    var _exportData = function(req, res, next) {</td></tr><tr class="miss"><td class="line">146</td><td class="hits">0</td><td class="source">        var notebook = req.params.notebook;</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">148</td><td class="hits">0</td><td class="source">        if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">150</td><td class="hits">0</td><td class="source">         Notebook</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">                _id: notebook,</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">                &quot;users.user&quot; : req.user._id</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">            }, &quot;users name created&quot;)</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">            // .populate(&quot;clipps.clipp&quot;, null, null, { sort: {&quot;engagement.rank.current&quot; : -1}, limit: per_page, skip: (page-1)*per_page })</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">157</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">161</td><td class="hits">0</td><td class="source">                if(notebook.getPermissions(req.user).indexOf(&quot;view_notebook_clipps&quot;) &lt; 0 || notebook.getPermissions(req.user).indexOf(&quot;export_data&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">162</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to export data from this notebook.&quot;));</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">165</td><td class="hits">0</td><td class="source">                Clipp.Model</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">                    .find({</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">                        notebook: notebook</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">                    }, &quot;title engagement url tags description published created clippRank&quot;)</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">                    .sort({&quot;clippRank&quot;: 1, &quot;published&quot;: -1})</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">                    .lean()</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">                    .exec(function(err, clipps){</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="source">                        if(err) return next(err);</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">175</td><td class="hits">0</td><td class="source">                        var</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">                            fields = [&quot;Rank&quot;, &quot;Title&quot;, &quot;Description&quot;, &quot;Url&quot;, &quot;Notebook&quot;, &quot;Published&quot;, &quot;Created&quot;],</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">                            formatEngagementChannel = {</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">                                &quot;googleplus&quot;: &quot;Google Plus&quot;,</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">                                &quot;native_count&quot;: &quot;On Site&quot;</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">                            };</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">184</td><td class="hits">0</td><td class="source">                        for(var c in clipps) {</td></tr><tr class="miss"><td class="line">185</td><td class="hits">0</td><td class="source">                            for( var e in clipps[c].engagement)</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">                            {</td></tr><tr class="miss"><td class="line">187</td><td class="hits">0</td><td class="source">                                if(PageEngagement.pointFilter.indexOf(e) &gt;= 0){</td></tr><tr class="miss"><td class="line">188</td><td class="hits">0</td><td class="source">                                    clipps[c][formatEngagementChannel[e] || e] = clipps[c].engagement[e];</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">                                }</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">                            }</td></tr><tr class="miss"><td class="line">191</td><td class="hits">0</td><td class="source">                            clipps[c].rank = clipps[c].clippRank;</td></tr><tr class="miss"><td class="line">192</td><td class="hits">0</td><td class="source">                            clipps[c].tags = clipps[c].tags.toString();</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">194</td><td class="hits">0</td><td class="source">                            delete clipps[c].clippRank;</td></tr><tr class="miss"><td class="line">195</td><td class="hits">0</td><td class="source">                            delete clipps[c].engagement;</td></tr><tr class="miss"><td class="line">196</td><td class="hits">0</td><td class="source">                            delete clipps[c]._id;</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">198</td><td class="hits">0</td><td class="source">                            clipps[c].notebook = notebook.name;</td></tr><tr class="miss"><td class="line">199</td><td class="hits">0</td><td class="source">                            clipps[c].published = (clipps[c].published) ? moment(clipps[c].published).format(&quot;YYYY-MM-DD&quot;) : &quot;&quot;;</td></tr><tr class="miss"><td class="line">200</td><td class="hits">0</td><td class="source">                            clipps[c].created = (clipps[c].created) ? moment(clipps[c].created).format(&quot;YYYY-MM-DD&quot;) : &quot;&quot;;</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">202</td><td class="hits">0</td><td class="source">                            if(clipps[c].tags == &quot;-1&quot;) clipps[c].tags = &quot;&quot;;</td></tr><tr class="miss"><td class="line">203</td><td class="hits">0</td><td class="source">                            if(clipps[c].description == &quot;Anything you want.&quot;) clipps[c].description = &quot;&quot;;</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">205</td><td class="hits">0</td><td class="source">                            for(var f in clipps[c]) {</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">207</td><td class="hits">0</td><td class="source">                                if(f != StringUtils.toProperCase(f)) {</td></tr><tr class="miss"><td class="line">208</td><td class="hits">0</td><td class="source">                                    clipps[c][StringUtils.toProperCase(f)] = clipps[c][f] || &quot;&quot;;</td></tr><tr class="miss"><td class="line">209</td><td class="hits">0</td><td class="source">                                    delete clipps[c][f];</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">                                }</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">212</td><td class="hits">0</td><td class="source">                                fields.push(StringUtils.toProperCase(f));</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">216</td><td class="hits">0</td><td class="source">                        fields = ArrayUtils.uniqueArray(fields).map(function(str){</td></tr><tr class="miss"><td class="line">217</td><td class="hits">0</td><td class="source">                            return StringUtils.toProperCase(str);</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">222</td><td class="hits">0</td><td class="source">                        json2csv({data: clipps, fields: fields}, function(err, csv) {</td></tr><tr class="miss"><td class="line">223</td><td class="hits">0</td><td class="source">                            if (err) return next(err);</td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">225</td><td class="hits">0</td><td class="source">                            res.setHeader(&quot;Content-Type&quot;, &quot;text/csv&quot;);</td></tr><tr class="miss"><td class="line">226</td><td class="hits">0</td><td class="source">                            res.setHeader(&quot;Content-Disposition&quot;, &quot;attachment;filename=&quot;+notebook.name+&quot; &quot; + moment(Date.now()).format(&quot;YYYY-MM-DD&quot;)+&quot;.csv&quot;);</td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">229</td><td class="hits">0</td><td class="source">                            return res.send(csv);</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">236</td><td class="hits">1</td><td class="source">    var _listNewOnly = function(req, res, next) {</td></tr><tr class="miss"><td class="line">237</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">            notebook = req.params.notebook,</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source">            page = parseInt(req.params.page || 1, 10),</td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source">            per_page = parseInt(req.params.per_page || 20, 10);</td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">242</td><td class="hits">0</td><td class="source">        if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">243</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">244</td><td class="hits">0</td><td class="source">        var notebook_query = {</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source">            _id: notebook,</td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source">            &quot;users.user&quot; : req.user._id</td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">249</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &gt;= 0 || req.user._id === &quot;anonymous&quot;) notebook_query = {</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source">            _id: notebook</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">253</td><td class="hits">0</td><td class="source">        Notebook</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source">            .findOne(notebook_query, &quot;users name created anonymousAccess&quot;)</td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">            // .populate(&quot;clipps.clipp&quot;, null, null, { sort: {&quot;engagement.rank.current&quot; : -1}, limit: per_page, skip: (page-1)*per_page })</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">257</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">259</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">261</td><td class="hits">0</td><td class="source">                if(notebook.getPermissions(req.user).indexOf(&quot;view_notebook_clipps&quot;) &lt; 0 &amp;&amp; req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">262</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to view this notebooks clipps&quot;));</td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source">                /* query</td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source">                    db.clipps.find({</td></tr><tr><td class="line">267</td><td class="hits"></td><td class="source">                        &quot;notebook&quot; : &quot;9d47f249-b4b4-4675-8847-ceb4f459ec99&quot;,</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source">                        &quot;notifications&quot; : {$elemMatch: {</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">                            &quot;user&quot;:&quot;dc811edf-3943-40f3-aeb7-369d4c02b3c1&quot;,</td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source">                            $or : [</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source">                                {'engagement.facebook': {$gt: 0}},</td></tr><tr><td class="line">272</td><td class="hits"></td><td class="source">                                {'engagement.twitter': {$gt: 0}},</td></tr><tr><td class="line">273</td><td class="hits"></td><td class="source">                                {'engagement.twitter': {$gt: 0}},</td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source">                                {'engagement.linkedin': {$gt: 0}},</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source">                                {'engagement.googleplus': {$gt: 0}},</td></tr><tr><td class="line">276</td><td class="hits"></td><td class="source">                                {'engagement.reddit': {$gt: 0}},</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source">                                {'engagement.comments': {$gt: 0}},</td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source">                                {'engagement.stumbleupon': {$gt: 0}},</td></tr><tr><td class="line">279</td><td class="hits"></td><td class="source">                                {'engagement.pinterest': {$gt: 0}}</td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source">                            ]</td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source">                    })</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source">                */</td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">286</td><td class="hits">0</td><td class="source">                Clipp.Model</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source">                    .find(_buildNotebookQuery({</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">                        notebook: notebook,</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source">                        tag: req.params.tag,</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source">                        domain: req.params.domain</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source">                    }, true))</td></tr><tr><td class="line">292</td><td class="hits"></td><td class="source">                    .sort(_buildNotebookSort(req.params))</td></tr><tr><td class="line">293</td><td class="hits"></td><td class="source">                    .limit(per_page)</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source">                    .skip((page-1)*per_page)</td></tr><tr><td class="line">295</td><td class="hits"></td><td class="source">                    .populate(&quot;page&quot;, &quot;published updated error&quot;)</td></tr><tr><td class="line">296</td><td class="hits"></td><td class="source">                    .exec(function(err, clipps){</td></tr><tr class="miss"><td class="line">297</td><td class="hits">0</td><td class="source">                        if(err) return next(err);</td></tr><tr class="miss"><td class="line">298</td><td class="hits">0</td><td class="source">                        Clipp.Model.populate(clipps,</td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source">                            {path: 'page.error', model: PageError.Model}, function(err, populated) {</td></tr><tr><td class="line">300</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">301</td><td class="hits"></td><td class="source">                                // console.log(&quot;clipps before calling prepare&quot; + JSON.stringify(populated));</td></tr><tr class="miss"><td class="line">302</td><td class="hits">0</td><td class="source">                                clipps = Clipp.prepareMultipleForOutput(populated, req.user);</td></tr><tr class="miss"><td class="line">303</td><td class="hits">0</td><td class="source">                                var</td></tr><tr><td class="line">304</td><td class="hits"></td><td class="source">                                    engagementCount = 0,</td></tr><tr><td class="line">305</td><td class="hits"></td><td class="source">                                    clippsActuallyNew = [];</td></tr><tr><td class="line">306</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">307</td><td class="hits">0</td><td class="source">                                for(var i = 0; i &lt; clipps.length; i++){</td></tr><tr class="miss"><td class="line">308</td><td class="hits">0</td><td class="source">                                    engagementCount = clipps[i].notifications.engagements ? 0 : clipps[i].notifications.engagement.total;</td></tr><tr class="miss"><td class="line">309</td><td class="hits">0</td><td class="source">                                    if((clipps[i].notifications.discussion &gt; 0) || (engagementCount) &gt; 0){</td></tr><tr class="miss"><td class="line">310</td><td class="hits">0</td><td class="source">                                        clippsActuallyNew.push(clipps[i]);</td></tr><tr><td class="line">311</td><td class="hits"></td><td class="source">                                    }</td></tr><tr><td class="line">312</td><td class="hits"></td><td class="source">                                }</td></tr><tr><td class="line">313</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">314</td><td class="hits">0</td><td class="source">                                return res.send({</td></tr><tr><td class="line">315</td><td class="hits"></td><td class="source">                                    clipps: clippsActuallyNew,</td></tr><tr><td class="line">316</td><td class="hits"></td><td class="source">                                    notebook: notebook,</td></tr><tr><td class="line">317</td><td class="hits"></td><td class="source">                                    permissions: notebook.getPermissions(req.user),</td></tr><tr><td class="line">318</td><td class="hits"></td><td class="source">                                    page: page,</td></tr><tr><td class="line">319</td><td class="hits"></td><td class="source">                                    per_page: per_page,</td></tr><tr><td class="line">320</td><td class="hits"></td><td class="source">                                    sort: &quot;rank&quot;</td></tr><tr><td class="line">321</td><td class="hits"></td><td class="source">                                });</td></tr><tr><td class="line">322</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">323</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">324</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">325</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">326</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">327</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">328</td><td class="hits">1</td><td class="source">    var _viewURL = function(req, res, next) {</td></tr><tr class="miss"><td class="line">329</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">330</td><td class="hits"></td><td class="source">            id = req.params.id;</td></tr><tr><td class="line">331</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">332</td><td class="hits">0</td><td class="source">        if(!id) return next(new restify.ResourceNotFoundError(&quot;Clipp not found&quot;));</td></tr><tr><td class="line">333</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">334</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">335</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">336</td><td class="hits">0</td><td class="source">        Clipp.Model</td></tr><tr><td class="line">337</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">338</td><td class="hits"></td><td class="source">                _id: id</td></tr><tr><td class="line">339</td><td class="hits"></td><td class="source">            }, &quot;url&quot;)</td></tr><tr><td class="line">340</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">341</td><td class="hits"></td><td class="source">            .exec(function(err, clipp){</td></tr><tr class="miss"><td class="line">342</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr class="miss"><td class="line">343</td><td class="hits">0</td><td class="source">                return res.send({clipp: clipp});</td></tr><tr><td class="line">344</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">345</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">346</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">347</td><td class="hits">1</td><td class="source">    var _view = function(req, res, next) {</td></tr><tr class="miss"><td class="line">348</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">349</td><td class="hits"></td><td class="source">            notebook = req.params.notebook,</td></tr><tr><td class="line">350</td><td class="hits"></td><td class="source">            id = req.params.id,</td></tr><tr><td class="line">351</td><td class="hits"></td><td class="source">            permissions = [];</td></tr><tr><td class="line">352</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">353</td><td class="hits">0</td><td class="source">        if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr class="miss"><td class="line">354</td><td class="hits">0</td><td class="source">        if(!id) return next(new restify.ResourceNotFoundError(&quot;Clipp not found&quot;));</td></tr><tr><td class="line">355</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">356</td><td class="hits">0</td><td class="source">        var notebookQuery = {</td></tr><tr><td class="line">357</td><td class="hits"></td><td class="source">            _id: notebook,</td></tr><tr><td class="line">358</td><td class="hits"></td><td class="source">            &quot;clipps.clipp&quot;: id,</td></tr><tr><td class="line">359</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">360</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">361</td><td class="hits">0</td><td class="source">        Notebook</td></tr><tr><td class="line">362</td><td class="hits"></td><td class="source">            .findOne(notebookQuery)</td></tr><tr><td class="line">363</td><td class="hits"></td><td class="source">            .populate({</td></tr><tr><td class="line">364</td><td class="hits"></td><td class="source">                path: &quot;clipps.clipp&quot;,</td></tr><tr><td class="line">365</td><td class="hits"></td><td class="source">                match: { _id: id}</td></tr><tr><td class="line">366</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">367</td><td class="hits"></td><td class="source">            // .populate(&quot;clipps.page&quot;, &quot;published&quot;)</td></tr><tr><td class="line">368</td><td class="hits"></td><td class="source">            //.populate(&quot;clipps.page&quot;) //TODO: Determine if we need to populate the page when looking at clipp details</td></tr><tr><td class="line">369</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">370</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">371</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">372</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Clipp not found&quot;));</td></tr><tr><td class="line">373</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">374</td><td class="hits">0</td><td class="source">                permissions = notebook.getPermissions(req.user);</td></tr><tr><td class="line">375</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">376</td><td class="hits">0</td><td class="source">                if(permissions.indexOf(&quot;view_clipp_details&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">377</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to view this clipp's details&quot;));</td></tr><tr><td class="line">378</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">379</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">380</td><td class="hits">0</td><td class="source">                var clipp;</td></tr><tr class="miss"><td class="line">381</td><td class="hits">0</td><td class="source">                for(var i in notebook.clipps){</td></tr><tr><td class="line">382</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">383</td><td class="hits">0</td><td class="source">                    if(notebook.clipps[i].clipp) {</td></tr><tr class="miss"><td class="line">384</td><td class="hits">0</td><td class="source">                        clipp = notebook.clipps[i].toObject();</td></tr><tr><td class="line">385</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">386</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">387</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">388</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">389</td><td class="hits">0</td><td class="source">                if(!clipp) return next(new restify.ResourceNotFoundError(&quot;Clipp not found&quot;));</td></tr><tr><td class="line">390</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">391</td><td class="hits">0</td><td class="source">                Clipp.Model</td></tr><tr><td class="line">392</td><td class="hits"></td><td class="source">                    .findOne({</td></tr><tr><td class="line">393</td><td class="hits"></td><td class="source">                        _id: clipp.clipp._id</td></tr><tr><td class="line">394</td><td class="hits"></td><td class="source">                    })</td></tr><tr><td class="line">395</td><td class="hits"></td><td class="source">                    .populate(&quot;page&quot;, &quot;published error&quot;)</td></tr><tr><td class="line">396</td><td class="hits"></td><td class="source">                    .populate(&quot;comments.user&quot;, &quot;name gravatarHash&quot;)</td></tr><tr><td class="line">397</td><td class="hits"></td><td class="source">                    .lean()</td></tr><tr><td class="line">398</td><td class="hits"></td><td class="source">                    .exec(function(err, clipp){</td></tr><tr class="miss"><td class="line">399</td><td class="hits">0</td><td class="source">                        if(err) return next(err);</td></tr><tr class="miss"><td class="line">400</td><td class="hits">0</td><td class="source">                        Clipp.Model.populate(clipp,</td></tr><tr><td class="line">401</td><td class="hits"></td><td class="source">                                {path: 'page.error', model: PageError.Model},</td></tr><tr><td class="line">402</td><td class="hits"></td><td class="source">                            function(err, populated) {</td></tr><tr class="miss"><td class="line">403</td><td class="hits">0</td><td class="source">                                clipp = Clipp.prepareForOutput(populated, req.user);</td></tr><tr class="miss"><td class="line">404</td><td class="hits">0</td><td class="source">                                return res.send({</td></tr><tr><td class="line">405</td><td class="hits"></td><td class="source">                                    clipp: clipp,</td></tr><tr><td class="line">406</td><td class="hits"></td><td class="source">                                    permissions: permissions</td></tr><tr><td class="line">407</td><td class="hits"></td><td class="source">                                });</td></tr><tr><td class="line">408</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">409</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">410</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">411</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">412</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">413</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">414</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">415</td><td class="hits">1</td><td class="source">    var _getPublicClipp = function  (req, res ,next) {</td></tr><tr class="miss"><td class="line">416</td><td class="hits">0</td><td class="source">        Clipp.Model</td></tr><tr><td class="line">417</td><td class="hits"></td><td class="source">            .findOne({_id: req.params.id}, &quot;url notebook&quot;)</td></tr><tr><td class="line">418</td><td class="hits"></td><td class="source">            .exec(function (err, clipp) {</td></tr><tr class="miss"><td class="line">419</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">420</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">421</td><td class="hits">0</td><td class="source">                return res.send(clipp);</td></tr><tr><td class="line">422</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">423</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">424</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">425</td><td class="hits">1</td><td class="source">    var _add = function(req, res, next) {</td></tr><tr class="miss"><td class="line">426</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">427</td><td class="hits"></td><td class="source">            notebook = req.params.notebook,</td></tr><tr><td class="line">428</td><td class="hits"></td><td class="source">            clipp;</td></tr><tr class="miss"><td class="line">429</td><td class="hits">0</td><td class="source">        if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">430</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">431</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;import_links_to_account&quot;) &gt;= 0 &amp;&amp; req.params.urls) return _importClipps(req, res, next);</td></tr><tr><td class="line">432</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">433</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;edit_notebook_on_referred_account&quot;) &gt;= 0 &amp;&amp; req.params.urls) {</td></tr><tr><td class="line">434</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">435</td><td class="hits">0</td><td class="source">            return Notebook.findOne({</td></tr><tr><td class="line">436</td><td class="hits"></td><td class="source">                _id: notebook</td></tr><tr><td class="line">437</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">438</td><td class="hits"></td><td class="source">            .populate(&quot;users.user&quot;, &quot;refBy&quot;)</td></tr><tr><td class="line">439</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">440</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">441</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr class="miss"><td class="line">442</td><td class="hits">0</td><td class="source">                var owner;</td></tr><tr class="miss"><td class="line">443</td><td class="hits">0</td><td class="source">                notebook.users.map(function(user){</td></tr><tr class="miss"><td class="line">444</td><td class="hits">0</td><td class="source">                    if(user.role == &quot;owner&quot;) owner = user.user;</td></tr><tr><td class="line">445</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">446</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">447</td><td class="hits">0</td><td class="source">                if(!owner) {</td></tr><tr class="miss"><td class="line">448</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to add a clipp to this notebook&quot;));</td></tr><tr><td class="line">449</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">450</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">451</td><td class="hits">0</td><td class="source">                if(owner.refBy != req.user._id &amp;&amp; owner._id != req.user._id){</td></tr><tr class="miss"><td class="line">452</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to add a clipp to this notebook&quot;));</td></tr><tr><td class="line">453</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">454</td><td class="hits">0</td><td class="source">                return _importClipps(req, res, next);</td></tr><tr><td class="line">455</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">456</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">457</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">458</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">459</td><td class="hits">0</td><td class="source">        Notebook</td></tr><tr><td class="line">460</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">461</td><td class="hits"></td><td class="source">                _id: notebook,</td></tr><tr><td class="line">462</td><td class="hits"></td><td class="source">                &quot;users.user&quot; : req.user._id</td></tr><tr><td class="line">463</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">464</td><td class="hits"></td><td class="source">            .populate(&quot;clipps.clipp&quot;, &quot;url&quot;)</td></tr><tr><td class="line">465</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">466</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">467</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">468</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr class="miss"><td class="line">469</td><td class="hits">0</td><td class="source">                if(req.params.urls &amp;&amp; notebook.getPermissions(req.user).indexOf(&quot;add_clipp_to_notebook&quot;) &gt;= 0) {</td></tr><tr><td class="line">470</td><td class="hits"></td><td class="source">                    //they are uploading multiple clipps</td></tr><tr class="miss"><td class="line">471</td><td class="hits">0</td><td class="source">                    return _importClipps(req, res, next);</td></tr><tr><td class="line">472</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">473</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">474</td><td class="hits">0</td><td class="source">                if(notebook.getPermissions(req.user).indexOf(&quot;add_clipp_to_notebook&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">475</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to add a clipp to this notebook&quot;));</td></tr><tr><td class="line">476</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">477</td><td class="hits"></td><td class="source">                //first we need to grab as much as we can about the clipp first, then save it</td></tr><tr class="miss"><td class="line">478</td><td class="hits">0</td><td class="source">                Page.getMetaInfo(req.params.url, {}, function(err, results){</td></tr><tr class="miss"><td class="line">479</td><td class="hits">0</td><td class="source">                    clipp = new Clipp.Model(req.params);</td></tr><tr class="miss"><td class="line">480</td><td class="hits">0</td><td class="source">                    if(!err) {</td></tr><tr class="miss"><td class="line">481</td><td class="hits">0</td><td class="source">                        clipp.url = results.url;</td></tr><tr class="miss"><td class="line">482</td><td class="hits">0</td><td class="source">                        if(!clipp.title) clipp.title = results.title;</td></tr><tr class="miss"><td class="line">483</td><td class="hits">0</td><td class="source">                        if(!clipp.description) clipp.description = results.description;</td></tr><tr><td class="line">484</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">485</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">486</td><td class="hits">0</td><td class="source">                    clipp.notebook = notebook._id;</td></tr><tr><td class="line">487</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">488</td><td class="hits">0</td><td class="source">                    if(Clipp.isDuplicate(clipp, notebook)) return next(new restifyErrors.InvalidInputError(&quot;Clipp already exists in this notebook&quot;));</td></tr><tr><td class="line">489</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">490</td><td class="hits">0</td><td class="source">                    clipp.creator = req.user._id;</td></tr><tr><td class="line">491</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">492</td><td class="hits">0</td><td class="source">                    clipp.save(function(err, saved){</td></tr><tr class="miss"><td class="line">493</td><td class="hits">0</td><td class="source">                        if(err) console.log(&quot;error saving clipp:&quot;, err);</td></tr><tr class="miss"><td class="line">494</td><td class="hits">0</td><td class="source">                        if(err &amp;&amp; err.errors) {</td></tr><tr class="miss"><td class="line">495</td><td class="hits">0</td><td class="source">                            return next(new restifyErrors.InvalidInputError(err));</td></tr><tr><td class="line">496</td><td class="hits"></td><td class="source">                        }</td></tr><tr class="miss"><td class="line">497</td><td class="hits">0</td><td class="source">                        else if(err) return next(err);</td></tr><tr><td class="line">498</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">499</td><td class="hits">0</td><td class="source">                        notebook.clipps.push({</td></tr><tr><td class="line">500</td><td class="hits"></td><td class="source">                            clipp: clipp,</td></tr><tr><td class="line">501</td><td class="hits"></td><td class="source">                            page: clipp.page</td></tr><tr><td class="line">502</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">503</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">504</td><td class="hits">0</td><td class="source">                        notebook.save(function(err, nbs){</td></tr><tr class="miss"><td class="line">505</td><td class="hits">0</td><td class="source">                            if(err) console.log(&quot;Error saving notebook:&quot;, err);</td></tr><tr><td class="line">506</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">507</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">508</td><td class="hits">0</td><td class="source">                        return res.send(saved);</td></tr><tr><td class="line">509</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">510</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">511</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">512</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">513</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">514</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">515</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">516</td><td class="hits">1</td><td class="source">    var _createClipAndShortUrl = function(req, res, next) {</td></tr><tr class="miss"><td class="line">517</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">518</td><td class="hits"></td><td class="source">            notebook_id = req.params.notebook,</td></tr><tr><td class="line">519</td><td class="hits"></td><td class="source">            clip_id = null, // clip creating now</td></tr><tr><td class="line">520</td><td class="hits"></td><td class="source">            user_id = req.user._id,</td></tr><tr><td class="line">521</td><td class="hits"></td><td class="source">            channel = req.params.channel,</td></tr><tr><td class="line">522</td><td class="hits"></td><td class="source">            url = req.params.url,</td></tr><tr><td class="line">523</td><td class="hits"></td><td class="source">            from = req.params.from;</td></tr><tr><td class="line">524</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">525</td><td class="hits">0</td><td class="source">        if(!notebook_id) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr class="miss"><td class="line">526</td><td class="hits">0</td><td class="source">        try {</td></tr><tr class="miss"><td class="line">527</td><td class="hits">0</td><td class="source">            check(url).notNull().isUrl();</td></tr><tr class="miss"><td class="line">528</td><td class="hits">0</td><td class="source">            check(from).notNull().isUrl();</td></tr><tr><td class="line">529</td><td class="hits"></td><td class="source">        } catch (e) {</td></tr><tr class="miss"><td class="line">530</td><td class="hits">0</td><td class="source">            console.log(e.message); //Invalid integer</td></tr><tr class="miss"><td class="line">531</td><td class="hits">0</td><td class="source">            return next(new restifyErrors.InvalidInputError(e.message));</td></tr><tr><td class="line">532</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">533</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">534</td><td class="hits">0</td><td class="source">        Notebook</td></tr><tr><td class="line">535</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">536</td><td class="hits"></td><td class="source">                _id: notebook_id,</td></tr><tr><td class="line">537</td><td class="hits"></td><td class="source">                &quot;users.user&quot; : req.user._id</td></tr><tr><td class="line">538</td><td class="hits"></td><td class="source">            }, &quot;users name created siteUrls retarget clipps&quot;)</td></tr><tr><td class="line">539</td><td class="hits"></td><td class="source">            .populate(&quot;clipps.clipp&quot;)</td></tr><tr><td class="line">540</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">541</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">542</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">543</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">544</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">545</td><td class="hits">0</td><td class="source">                if(notebook.getPermissions(req.user).indexOf(&quot;view_notebook_clipps&quot;) &lt; 0 &amp;&amp; req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">546</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to view this notebooks clipps&quot;));</td></tr><tr><td class="line">547</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">548</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">549</td><td class="hits">0</td><td class="source">                if(notebook.getPermissions(req.user).indexOf(&quot;add_clipp_to_notebook&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">550</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to add a clipp to this notebook&quot;));</td></tr><tr><td class="line">551</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">552</td><td class="hits"></td><td class="source">                //first we need to grab as much as we can about the clipp first, then save it</td></tr><tr class="miss"><td class="line">553</td><td class="hits">0</td><td class="source">                Page.getMetaInfo(from, {}, function(err, results){</td></tr><tr class="miss"><td class="line">554</td><td class="hits">0</td><td class="source">                    clipp = new Clipp.Model(req.params);</td></tr><tr class="miss"><td class="line">555</td><td class="hits">0</td><td class="source">                    if(!err) {</td></tr><tr class="miss"><td class="line">556</td><td class="hits">0</td><td class="source">                        clipp.url = results.url;</td></tr><tr class="miss"><td class="line">557</td><td class="hits">0</td><td class="source">                        if(!clipp.title) clipp.title = results.title;</td></tr><tr class="miss"><td class="line">558</td><td class="hits">0</td><td class="source">                        if(!clipp.description) clipp.description = results.description;</td></tr><tr><td class="line">559</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">560</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">561</td><td class="hits">0</td><td class="source">                    clipp.notebook = notebook._id;</td></tr><tr><td class="line">562</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">563</td><td class="hits">0</td><td class="source">                    if(Clipp.isDuplicate(clipp, notebook)) {</td></tr><tr class="miss"><td class="line">564</td><td class="hits">0</td><td class="source">                        return notebook.addShortUrl(clipp._id, user_id, url, channel, function(err, shortUrlSaved) {</td></tr><tr class="miss"><td class="line">565</td><td class="hits">0</td><td class="source">                            if(err) return next(err);</td></tr><tr class="miss"><td class="line">566</td><td class="hits">0</td><td class="source">                            return res.send(shortUrlSaved);</td></tr><tr><td class="line">567</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">568</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">569</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">570</td><td class="hits">0</td><td class="source">                    clipp.creator = req.user._id;</td></tr><tr><td class="line">571</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">572</td><td class="hits">0</td><td class="source">                    clipp.save(function(err, saved){</td></tr><tr class="miss"><td class="line">573</td><td class="hits">0</td><td class="source">                        if(err) console.log(&quot;error saving clipp:&quot;, err);</td></tr><tr class="miss"><td class="line">574</td><td class="hits">0</td><td class="source">                        if(err &amp;&amp; err.errors) {</td></tr><tr class="miss"><td class="line">575</td><td class="hits">0</td><td class="source">                            return next(new restifyErrors.InvalidInputError(err));</td></tr><tr><td class="line">576</td><td class="hits"></td><td class="source">                        }</td></tr><tr class="miss"><td class="line">577</td><td class="hits">0</td><td class="source">                        else if(err) return next(err);</td></tr><tr><td class="line">578</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">579</td><td class="hits">0</td><td class="source">                        notebook.clipps.push({</td></tr><tr><td class="line">580</td><td class="hits"></td><td class="source">                            clipp: clipp,</td></tr><tr><td class="line">581</td><td class="hits"></td><td class="source">                            page: clipp.page</td></tr><tr><td class="line">582</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">583</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">584</td><td class="hits">0</td><td class="source">                        notebook.save(function(err, nbs){</td></tr><tr class="miss"><td class="line">585</td><td class="hits">0</td><td class="source">                            if(err) console.log(&quot;Error saving notebook:&quot;, err);</td></tr><tr><td class="line">586</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">587</td><td class="hits">0</td><td class="source">                            notebook.addShortUrl(saved._id, user_id, url, channel, function(err, shortUrlSaved) {</td></tr><tr class="miss"><td class="line">588</td><td class="hits">0</td><td class="source">                                if(err) return next(err);</td></tr><tr class="miss"><td class="line">589</td><td class="hits">0</td><td class="source">                                return res.send(shortUrlSaved);</td></tr><tr><td class="line">590</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">591</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">592</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">593</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">594</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">595</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">596</td><td class="hits"></td><td class="source">    </td></tr><tr class="hit"><td class="line">597</td><td class="hits">1</td><td class="source">    var _addShortUrl = function(req, res, next) {</td></tr><tr class="miss"><td class="line">598</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">599</td><td class="hits"></td><td class="source">            notebook_id = req.params.notebook,</td></tr><tr><td class="line">600</td><td class="hits"></td><td class="source">            clip_id = req.params.id,</td></tr><tr><td class="line">601</td><td class="hits"></td><td class="source">            user_id = req.user._id,</td></tr><tr><td class="line">602</td><td class="hits"></td><td class="source">            channel = req.params.channel,</td></tr><tr><td class="line">603</td><td class="hits"></td><td class="source">            url = req.params.url;</td></tr><tr><td class="line">604</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">605</td><td class="hits">0</td><td class="source">        if(!notebook_id) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr class="miss"><td class="line">606</td><td class="hits">0</td><td class="source">        if(!clip_id) return next(new restify.ResourceNotFoundError(&quot;Clipp not found&quot;));</td></tr><tr class="miss"><td class="line">607</td><td class="hits">0</td><td class="source">        try {</td></tr><tr class="miss"><td class="line">608</td><td class="hits">0</td><td class="source">            check(url).notNull().isUrl();</td></tr><tr><td class="line">609</td><td class="hits"></td><td class="source">        } catch (e) {</td></tr><tr class="miss"><td class="line">610</td><td class="hits">0</td><td class="source">            console.log(e.message); //Invalid integer</td></tr><tr class="miss"><td class="line">611</td><td class="hits">0</td><td class="source">            return next(new restifyErrors.InvalidInputError(e.message));</td></tr><tr><td class="line">612</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">613</td><td class="hits">0</td><td class="source">        Notebook</td></tr><tr><td class="line">614</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">615</td><td class="hits"></td><td class="source">                _id: notebook_id,</td></tr><tr><td class="line">616</td><td class="hits"></td><td class="source">                &quot;users.user&quot; : req.user._id</td></tr><tr><td class="line">617</td><td class="hits"></td><td class="source">            }, &quot;users name created siteUrls retarget&quot;)</td></tr><tr><td class="line">618</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">619</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">620</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">621</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">622</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">623</td><td class="hits">0</td><td class="source">                if(notebook.getPermissions(req.user).indexOf(&quot;view_notebook_clipps&quot;) &lt; 0 &amp;&amp; req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">624</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to view this notebooks clipps&quot;));</td></tr><tr><td class="line">625</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">626</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">627</td><td class="hits">0</td><td class="source">                notebook.addShortUrl(clip_id, user_id, url, channel, function(err, saved) {</td></tr><tr class="miss"><td class="line">628</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr class="miss"><td class="line">629</td><td class="hits">0</td><td class="source">                    return res.send(saved);</td></tr><tr><td class="line">630</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">631</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">632</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">633</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">634</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">635</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">636</td><td class="hits">1</td><td class="source">    var _update = function(req, res, next) {</td></tr><tr class="miss"><td class="line">637</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">638</td><td class="hits"></td><td class="source">            notebook = req.params.notebook_id,</td></tr><tr><td class="line">639</td><td class="hits"></td><td class="source">            clipp,</td></tr><tr><td class="line">640</td><td class="hits"></td><td class="source">            permissions = [],</td></tr><tr><td class="line">641</td><td class="hits"></td><td class="source">            can_edit;</td></tr><tr><td class="line">642</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">643</td><td class="hits">0</td><td class="source">        delete req.params.notebook_id;</td></tr><tr><td class="line">644</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">645</td><td class="hits">0</td><td class="source">        if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">646</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">647</td><td class="hits">0</td><td class="source">        Notebook</td></tr><tr><td class="line">648</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">649</td><td class="hits"></td><td class="source">                _id: notebook,</td></tr><tr><td class="line">650</td><td class="hits"></td><td class="source">                &quot;users.user&quot; : req.user._id,</td></tr><tr><td class="line">651</td><td class="hits"></td><td class="source">                &quot;clipps.clipp&quot;: req.params.id</td></tr><tr><td class="line">652</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">653</td><td class="hits"></td><td class="source">            .populate(&quot;clipps.clipp&quot;)</td></tr><tr><td class="line">654</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">655</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">656</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">657</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">658</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">659</td><td class="hits">0</td><td class="source">                permissions = notebook.getPermissions(req.user);</td></tr><tr class="miss"><td class="line">660</td><td class="hits">0</td><td class="source">                can_edit = (permissions.indexOf(&quot;edit_clipp&quot;) &gt;= 0);</td></tr><tr><td class="line">661</td><td class="hits"></td><td class="source">                // console.log(permissions);</td></tr><tr class="miss"><td class="line">662</td><td class="hits">0</td><td class="source">                if(!can_edit &amp;&amp; (req.params.tags) &amp;&amp; permissions.indexOf(&quot;edit_clipp_tags&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">663</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to edit tags&quot;));</td></tr><tr><td class="line">664</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">665</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">666</td><td class="hits">0</td><td class="source">                if(!can_edit &amp;&amp; (req.params.tag) &amp;&amp; permissions.indexOf(&quot;add_tags_to_clipp&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">667</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to add tags&quot;));</td></tr><tr><td class="line">668</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">669</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">670</td><td class="hits">0</td><td class="source">                if(!can_edit &amp;&amp; (req.params.description) &amp;&amp; permissions.indexOf(&quot;edit_clipp_description&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">671</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to edit the description&quot;));</td></tr><tr><td class="line">672</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">673</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">674</td><td class="hits">0</td><td class="source">                if(!can_edit &amp;&amp; (req.params.comment || req.params.commments) &amp;&amp; permissions.indexOf(&quot;clipp_comment&quot;) &lt; 0){</td></tr><tr class="miss"><td class="line">675</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to comment on this clipp&quot;));</td></tr><tr><td class="line">676</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">677</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">678</td><td class="hits">0</td><td class="source">                if(!can_edit) {</td></tr><tr class="miss"><td class="line">679</td><td class="hits">0</td><td class="source">                    var ok = [&quot;tags&quot;, &quot;tag&quot;, &quot;description&quot;, &quot;comment&quot;, &quot;comments&quot;, &quot;id&quot;];</td></tr><tr><td class="line">680</td><td class="hits"></td><td class="source">                    // console.log(req.params);</td></tr><tr class="miss"><td class="line">681</td><td class="hits">0</td><td class="source">                    for(var j in req.params){</td></tr><tr class="miss"><td class="line">682</td><td class="hits">0</td><td class="source">                        if(ok.indexOf(j) &lt; 0) return next(new restify.NotAuthorizedError(&quot;You don't have permissions to edit the &quot; + j + &quot; on this clipp&quot;));</td></tr><tr><td class="line">683</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">684</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">685</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">686</td><td class="hits">0</td><td class="source">                for(var i in notebook.clipps){</td></tr><tr class="miss"><td class="line">687</td><td class="hits">0</td><td class="source">                    if(notebook.clipps[i].clipp &amp;&amp; notebook.clipps[i].clipp._id == req.params.id) {</td></tr><tr class="miss"><td class="line">688</td><td class="hits">0</td><td class="source">                        clipp = notebook.clipps[i].clipp;</td></tr><tr class="miss"><td class="line">689</td><td class="hits">0</td><td class="source">                        break;</td></tr><tr><td class="line">690</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">691</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">692</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">693</td><td class="hits">0</td><td class="source">                if(!clipp) return next(new restify.ResourceNotFoundError(&quot;Clipp not found&quot;));</td></tr><tr><td class="line">694</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">695</td><td class="hits">0</td><td class="source">                clipp.setAll(req.params, req.user);</td></tr><tr><td class="line">696</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">697</td><td class="hits">0</td><td class="source">                clipp.save(function(err, saved){</td></tr><tr class="miss"><td class="line">698</td><td class="hits">0</td><td class="source">                    if(err &amp;&amp; err.errors) {</td></tr><tr class="miss"><td class="line">699</td><td class="hits">0</td><td class="source">                        return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">700</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">701</td><td class="hits">0</td><td class="source">                    else if(err) return next(err);</td></tr><tr><td class="line">702</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">703</td><td class="hits">0</td><td class="source">                    return res.send(saved);</td></tr><tr><td class="line">704</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">705</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">706</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">707</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">708</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">709</td><td class="hits">1</td><td class="source">    var _removeTag = function(req, res, next) {</td></tr><tr class="miss"><td class="line">710</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">711</td><td class="hits"></td><td class="source">            notebook = req.params.notebook,</td></tr><tr><td class="line">712</td><td class="hits"></td><td class="source">            clipp,</td></tr><tr><td class="line">713</td><td class="hits"></td><td class="source">            permissions = [],</td></tr><tr><td class="line">714</td><td class="hits"></td><td class="source">            can_edit,</td></tr><tr><td class="line">715</td><td class="hits"></td><td class="source">            tag = req.params.tag;</td></tr><tr><td class="line">716</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">717</td><td class="hits">0</td><td class="source">        if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">718</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">719</td><td class="hits">0</td><td class="source">        Notebook</td></tr><tr><td class="line">720</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">721</td><td class="hits"></td><td class="source">                _id: notebook,</td></tr><tr><td class="line">722</td><td class="hits"></td><td class="source">                &quot;users.user&quot; : req.user._id,</td></tr><tr><td class="line">723</td><td class="hits"></td><td class="source">                &quot;clipps.clipp&quot;: req.params.id</td></tr><tr><td class="line">724</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">725</td><td class="hits"></td><td class="source">            .populate(&quot;clipps.clipp&quot;)</td></tr><tr><td class="line">726</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">727</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">728</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">729</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">730</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">731</td><td class="hits">0</td><td class="source">                permissions = notebook.getPermissions(req.user);</td></tr><tr class="miss"><td class="line">732</td><td class="hits">0</td><td class="source">                can_edit = (permissions.indexOf(&quot;edit_clipp&quot;) &gt;= 0);</td></tr><tr><td class="line">733</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">734</td><td class="hits">0</td><td class="source">                if(!can_edit &amp;&amp; permissions.indexOf(&quot;edit_clipp_tags&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">735</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to edit tags&quot;));</td></tr><tr><td class="line">736</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">737</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">738</td><td class="hits">0</td><td class="source">                for(var i in notebook.clipps){</td></tr><tr class="miss"><td class="line">739</td><td class="hits">0</td><td class="source">                    if(notebook.clipps[i].clipp &amp;&amp; notebook.clipps[i].clipp._id == req.params.id) {</td></tr><tr class="miss"><td class="line">740</td><td class="hits">0</td><td class="source">                        clipp = notebook.clipps[i].clipp;</td></tr><tr class="miss"><td class="line">741</td><td class="hits">0</td><td class="source">                        break;</td></tr><tr><td class="line">742</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">743</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">744</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">745</td><td class="hits">0</td><td class="source">                if(!clipp) return next(new restify.ResourceNotFoundError(&quot;Clipp not found&quot;));</td></tr><tr><td class="line">746</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">747</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">748</td><td class="hits">0</td><td class="source">                clipp.tags = ArrayUtils.removeElement(clipp.tags, tag);</td></tr><tr class="miss"><td class="line">749</td><td class="hits">0</td><td class="source">                clipp.markModified(&quot;tags&quot;);</td></tr><tr><td class="line">750</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">751</td><td class="hits">0</td><td class="source">                clipp.save(function(err, saved){</td></tr><tr class="miss"><td class="line">752</td><td class="hits">0</td><td class="source">                    if(err &amp;&amp; err.errors) {</td></tr><tr class="miss"><td class="line">753</td><td class="hits">0</td><td class="source">                        return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">754</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">755</td><td class="hits">0</td><td class="source">                    else if(err) return next(err);</td></tr><tr><td class="line">756</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">757</td><td class="hits">0</td><td class="source">                    return res.send(saved);</td></tr><tr><td class="line">758</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">759</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">760</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">761</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">762</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">763</td><td class="hits">1</td><td class="source">    var _archive = function(req, res, next) {</td></tr><tr><td class="line">764</td><td class="hits"></td><td class="source">        /*</td></tr><tr><td class="line">765</td><td class="hits"></td><td class="source">            Clipp Archive</td></tr><tr><td class="line">766</td><td class="hits"></td><td class="source">            1. remove clipp from notebook</td></tr><tr><td class="line">767</td><td class="hits"></td><td class="source">            2. remove clipp from page</td></tr><tr><td class="line">768</td><td class="hits"></td><td class="source">            3. move clipp to archive clipps</td></tr><tr><td class="line">769</td><td class="hits"></td><td class="source">         */</td></tr><tr><td class="line">770</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">771</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">772</td><td class="hits"></td><td class="source">            notebook = req.params.notebook,</td></tr><tr><td class="line">773</td><td class="hits"></td><td class="source">            clipp,</td></tr><tr><td class="line">774</td><td class="hits"></td><td class="source">            permissions = [],</td></tr><tr><td class="line">775</td><td class="hits"></td><td class="source">            can_edit;</td></tr><tr><td class="line">776</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">777</td><td class="hits">0</td><td class="source">        if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">778</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">779</td><td class="hits"></td><td class="source">        //check to see if they're an admin</td></tr><tr class="miss"><td class="line">780</td><td class="hits">0</td><td class="source">        var query;</td></tr><tr class="miss"><td class="line">781</td><td class="hits">0</td><td class="source">        if(req.user.role == &quot;admin&quot; || req.user.role == &quot;reseller&quot;) {</td></tr><tr class="miss"><td class="line">782</td><td class="hits">0</td><td class="source">            query = {</td></tr><tr><td class="line">783</td><td class="hits"></td><td class="source">                _id: notebook,</td></tr><tr><td class="line">784</td><td class="hits"></td><td class="source">                &quot;clipps.clipp&quot;: req.params.id</td></tr><tr><td class="line">785</td><td class="hits"></td><td class="source">            };</td></tr><tr><td class="line">786</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">787</td><td class="hits">0</td><td class="source">            query = {</td></tr><tr><td class="line">788</td><td class="hits"></td><td class="source">                _id: notebook,</td></tr><tr><td class="line">789</td><td class="hits"></td><td class="source">                &quot;users.user&quot; : req.user._id,</td></tr><tr><td class="line">790</td><td class="hits"></td><td class="source">                &quot;clipps.clipp&quot;: req.params.id</td></tr><tr><td class="line">791</td><td class="hits"></td><td class="source">            };</td></tr><tr><td class="line">792</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">793</td><td class="hits">0</td><td class="source">        Notebook</td></tr><tr><td class="line">794</td><td class="hits"></td><td class="source">            .findOne(query)</td></tr><tr><td class="line">795</td><td class="hits"></td><td class="source">            .populate(&quot;clipps.clipp&quot;)</td></tr><tr><td class="line">796</td><td class="hits"></td><td class="source">            .populate(&quot;users.user&quot;, &quot;refBy&quot;)</td></tr><tr><td class="line">797</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">798</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">799</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">800</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">801</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">802</td><td class="hits">0</td><td class="source">                permissions = notebook.getPermissions(req.user);</td></tr><tr><td class="line">803</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">804</td><td class="hits">0</td><td class="source">                if(permissions.indexOf(&quot;archive_clipp&quot;) &lt; 0 &amp;&amp; req.user.permissions.indexOf(&quot;edit_notebook_on_account&quot;) &lt; 0 &amp;&amp; req.user.role != &quot;admin&quot;) {</td></tr><tr><td class="line">805</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">806</td><td class="hits">0</td><td class="source">                    if(req.user.permissions.indexOf(&quot;edit_notebook_on_referred_account&quot;) &gt;= 0){</td></tr><tr class="miss"><td class="line">807</td><td class="hits">0</td><td class="source">                        for(var u = 0; u &lt; notebook.users.length; u++){</td></tr><tr class="miss"><td class="line">808</td><td class="hits">0</td><td class="source">                            if(notebook.users[u].role == &quot;owner&quot; &amp;&amp; notebook.users[u].user.refBy != req.user._id) {</td></tr><tr class="miss"><td class="line">809</td><td class="hits">0</td><td class="source">                                return next(new restify.NotAuthorizedError(&quot;You don't have permissions to delete this clipp&quot;));</td></tr><tr><td class="line">810</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">811</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">812</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">813</td><td class="hits">0</td><td class="source">                    else return next(new restify.NotAuthorizedError(&quot;You don't have permissions to delete this clipp&quot;));</td></tr><tr><td class="line">814</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">815</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">816</td><td class="hits">0</td><td class="source">                for(var i in notebook.clipps){</td></tr><tr class="miss"><td class="line">817</td><td class="hits">0</td><td class="source">                    if(notebook.clipps[i].clipp &amp;&amp; notebook.clipps[i].clipp._id == req.params.id) {</td></tr><tr class="miss"><td class="line">818</td><td class="hits">0</td><td class="source">                        clipp = notebook.clipps[i].clipp;</td></tr><tr class="miss"><td class="line">819</td><td class="hits">0</td><td class="source">                        break;</td></tr><tr><td class="line">820</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">821</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">822</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">823</td><td class="hits">0</td><td class="source">                if(!clipp) return next(new restify.ResourceNotFoundError(&quot;Clipp not found&quot;));</td></tr><tr><td class="line">824</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">825</td><td class="hits"></td><td class="source">                //Calling new utility method instead of doing it directly</td></tr><tr><td class="line">826</td><td class="hits"></td><td class="source">                //console.log(&quot;attempting to archive clipp: &quot; + clipp._id);</td></tr><tr class="miss"><td class="line">827</td><td class="hits">0</td><td class="source">                ArchiveUtils.archiveClipp(clipp, function(err, data) {</td></tr><tr class="miss"><td class="line">828</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">829</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">830</td><td class="hits">0</td><td class="source">                    return res.send({</td></tr><tr><td class="line">831</td><td class="hits"></td><td class="source">                        status: &quot;archived&quot;,</td></tr><tr><td class="line">832</td><td class="hits"></td><td class="source">                        message: &quot;Your clipp has been deleted&quot;,</td></tr><tr><td class="line">833</td><td class="hits"></td><td class="source">                        code: 200</td></tr><tr><td class="line">834</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">835</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">836</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">837</td><td class="hits"></td><td class="source">                /*</td></tr><tr><td class="line">838</td><td class="hits"></td><td class="source">                Clipp.Archive.add(clipp, function(err, result){</td></tr><tr><td class="line">839</td><td class="hits"></td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">840</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">841</td><td class="hits"></td><td class="source">                    return res.send({</td></tr><tr><td class="line">842</td><td class="hits"></td><td class="source">                        status: &quot;archived&quot;,</td></tr><tr><td class="line">843</td><td class="hits"></td><td class="source">                        message: &quot;Your clipp has been deleted&quot;,</td></tr><tr><td class="line">844</td><td class="hits"></td><td class="source">                        code: 200</td></tr><tr><td class="line">845</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">846</td><td class="hits"></td><td class="source">                });*/</td></tr><tr><td class="line">847</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">848</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">849</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">850</td><td class="hits">1</td><td class="source">    var _unarchive = function(req, res, next) {</td></tr><tr><td class="line">851</td><td class="hits"></td><td class="source">        /*</td></tr><tr><td class="line">852</td><td class="hits"></td><td class="source">            TODO: (N) Clipp Unarchive</td></tr><tr><td class="line">853</td><td class="hits"></td><td class="source">            1. move archived clipp back to clipps</td></tr><tr><td class="line">854</td><td class="hits"></td><td class="source">            2. add clipp to notebook (if it doesn't exist)</td></tr><tr><td class="line">855</td><td class="hits"></td><td class="source">            3. add clipp to page and save (for propagation and such)</td></tr><tr><td class="line">856</td><td class="hits"></td><td class="source">         */</td></tr><tr><td class="line">857</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">858</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">859</td><td class="hits">1</td><td class="source">    var _importClipps = function(req, res, next) {</td></tr><tr class="miss"><td class="line">860</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">861</td><td class="hits"></td><td class="source">            urls = req.params.urls,</td></tr><tr><td class="line">862</td><td class="hits"></td><td class="source">            notebook = req.params.notebook,</td></tr><tr><td class="line">863</td><td class="hits"></td><td class="source">            batch = new BatchImport.Model();</td></tr><tr><td class="line">864</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">865</td><td class="hits">0</td><td class="source">        redisq.options({</td></tr><tr><td class="line">866</td><td class="hits"></td><td class="source">            &quot;redis&quot;: {</td></tr><tr><td class="line">867</td><td class="hits"></td><td class="source">                &quot;host&quot;: Settings.redisq.options.host,</td></tr><tr><td class="line">868</td><td class="hits"></td><td class="source">                &quot;port&quot;: Settings.redisq.options.port,</td></tr><tr><td class="line">869</td><td class="hits"></td><td class="source">                &quot;password&quot;: Settings.redisq.options.pass</td></tr><tr><td class="line">870</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">871</td><td class="hits"></td><td class="source">        });</td></tr><tr class="miss"><td class="line">872</td><td class="hits">0</td><td class="source">        var link_import_queue = redisq.queue(Settings.jobs.link_import);</td></tr><tr><td class="line">873</td><td class="hits"></td><td class="source">        //assume that we've gotten this far with proper permissions since this method is not exposed publicly</td></tr><tr class="miss"><td class="line">874</td><td class="hits">0</td><td class="source">        if(!urls) return next(new restifyErrors.InvalidInputError(&quot;urls parameter is required&quot;));</td></tr><tr class="miss"><td class="line">875</td><td class="hits">0</td><td class="source">        if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">876</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">877</td><td class="hits"></td><td class="source">        //only unique urls and non-empty lines</td></tr><tr class="miss"><td class="line">878</td><td class="hits">0</td><td class="source">        urls = ArrayUtils.nonEmptyElements(urls);</td></tr><tr class="miss"><td class="line">879</td><td class="hits">0</td><td class="source">        var validatedUrls = ArrayUtils.sanitizeAndValidateArray(urls);</td></tr><tr class="miss"><td class="line">880</td><td class="hits">0</td><td class="source">        urls = validatedUrls[0];</td></tr><tr class="miss"><td class="line">881</td><td class="hits">0</td><td class="source">        var badUrls = validatedUrls[1];</td></tr><tr class="miss"><td class="line">882</td><td class="hits">0</td><td class="source">        urls = ArrayUtils.uniqueArray(urls);</td></tr><tr><td class="line">883</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">884</td><td class="hits">0</td><td class="source">        res.send({</td></tr><tr><td class="line">885</td><td class="hits"></td><td class="source">            batch: batch._id,</td></tr><tr><td class="line">886</td><td class="hits"></td><td class="source">            count: urls.length</td></tr><tr><td class="line">887</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">888</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">889</td><td class="hits">0</td><td class="source">        var jobUrls = [];</td></tr><tr class="miss"><td class="line">890</td><td class="hits">0</td><td class="source">        var firstBatch;</td></tr><tr><td class="line">891</td><td class="hits"></td><td class="source">        //initially we only care about the first 5, the rest are going to get chunked and added as jobs</td></tr><tr class="miss"><td class="line">892</td><td class="hits">0</td><td class="source">        jobUrls = ArrayUtils.sliceIntoGroups(urls, 5);</td></tr><tr><td class="line">893</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">894</td><td class="hits"></td><td class="source">        //now that we have these created we just need to dump them into the batch</td></tr><tr class="miss"><td class="line">895</td><td class="hits">0</td><td class="source">        batch.notebook = notebook;</td></tr><tr class="miss"><td class="line">896</td><td class="hits">0</td><td class="source">        batch.user = req.user._id;</td></tr><tr class="miss"><td class="line">897</td><td class="hits">0</td><td class="source">        batch.jobSize = 5;</td></tr><tr class="miss"><td class="line">898</td><td class="hits">0</td><td class="source">        batch.numJobs = jobUrls.length;</td></tr><tr class="miss"><td class="line">899</td><td class="hits">0</td><td class="source">        batch.totalToBeProcessed = urls.length;</td></tr><tr class="miss"><td class="line">900</td><td class="hits">0</td><td class="source">        batch.totalProcessed = 0;</td></tr><tr class="miss"><td class="line">901</td><td class="hits">0</td><td class="source">        batch.problemUrls = badUrls;</td></tr><tr class="miss"><td class="line">902</td><td class="hits">0</td><td class="source">        for(var j in jobUrls) {</td></tr><tr class="miss"><td class="line">903</td><td class="hits">0</td><td class="source">            var job = jobUrls[j];</td></tr><tr class="miss"><td class="line">904</td><td class="hits">0</td><td class="source">            batch.jobs.push({urls: job});</td></tr><tr><td class="line">905</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">906</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">907</td><td class="hits"></td><td class="source">        //console.log(&quot;batch import: &quot; + JSON.stringify(batch));</td></tr><tr><td class="line">908</td><td class="hits"></td><td class="source">        //save the batch, then start processing</td></tr><tr class="miss"><td class="line">909</td><td class="hits">0</td><td class="source">        batch.save(function(err, saved){</td></tr><tr class="miss"><td class="line">910</td><td class="hits">0</td><td class="source">            if(err) return console.log(&quot;error saving batch: &quot; +err);//bail before processing</td></tr><tr><td class="line">911</td><td class="hits"></td><td class="source">            //console.log(&quot;batch import saved&quot;);</td></tr><tr class="miss"><td class="line">912</td><td class="hits">0</td><td class="source">            firstBatch = saved.jobs[0].urls;</td></tr><tr class="miss"><td class="line">913</td><td class="hits">0</td><td class="source">            BatchImport.processChunk(saved, firstBatch, function(er, results){</td></tr><tr class="miss"><td class="line">914</td><td class="hits">0</td><td class="source">                if(er) console.log(&quot;there was a problem processing batch: &quot; + er);</td></tr><tr class="miss"><td class="line">915</td><td class="hits">0</td><td class="source">                console.log(&quot;url logs: %j&quot;, results.logs);</td></tr><tr class="miss"><td class="line">916</td><td class="hits">0</td><td class="source">                for(var k = 1;  k&lt;saved.numJobs; k++) {</td></tr><tr class="miss"><td class="line">917</td><td class="hits">0</td><td class="source">                    var job = {</td></tr><tr><td class="line">918</td><td class="hits"></td><td class="source">                        batch: saved._id,</td></tr><tr><td class="line">919</td><td class="hits"></td><td class="source">                        idx: k,</td></tr><tr><td class="line">920</td><td class="hits"></td><td class="source">                        id: saved.jobs[k]._id</td></tr><tr><td class="line">921</td><td class="hits"></td><td class="source">                    };</td></tr><tr><td class="line">922</td><td class="hits"></td><td class="source">                    //console.log(&quot;pushing job onto stack: &quot; + JSON.stringify(job));</td></tr><tr class="miss"><td class="line">923</td><td class="hits">0</td><td class="source">                    link_import_queue.push(job, pushJob);</td></tr><tr><td class="line">924</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">925</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">926</td><td class="hits">0</td><td class="source">                var pushJob = function(err, res) {</td></tr><tr class="miss"><td class="line">927</td><td class="hits">0</td><td class="source">                    if(err) console.log(&quot;Error scheduling link import job&quot;, err);</td></tr><tr><td class="line">928</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">929</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">930</td><td class="hits">0</td><td class="source">                if(saved.jobs.length &lt;= 1) {</td></tr><tr><td class="line">931</td><td class="hits"></td><td class="source">                    //mark and save the batch as processed</td></tr><tr class="miss"><td class="line">932</td><td class="hits">0</td><td class="source">                    saved.processed = true;</td></tr><tr class="miss"><td class="line">933</td><td class="hits">0</td><td class="source">                    saved.totalProcessed = firstBatch.length;</td></tr><tr class="miss"><td class="line">934</td><td class="hits">0</td><td class="source">                    saved.logs = results.logs;</td></tr><tr class="miss"><td class="line">935</td><td class="hits">0</td><td class="source">                    saved.save(function(er) {</td></tr><tr class="miss"><td class="line">936</td><td class="hits">0</td><td class="source">                        if(er) console.log(&quot;error occurred updating batch&quot;, er);</td></tr><tr><td class="line">937</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">938</td><td class="hits"></td><td class="source">                }  else {</td></tr><tr class="miss"><td class="line">939</td><td class="hits">0</td><td class="source">                    BatchImport.Model</td></tr><tr><td class="line">940</td><td class="hits"></td><td class="source">                        .update(</td></tr><tr><td class="line">941</td><td class="hits"></td><td class="source">                            {_id: saved._id},</td></tr><tr><td class="line">942</td><td class="hits"></td><td class="source">                            {</td></tr><tr><td class="line">943</td><td class="hits"></td><td class="source">                                $inc: {totalProcessed: firstBatch.length},</td></tr><tr><td class="line">944</td><td class="hits"></td><td class="source">                                $push: { logs: { $each: results.logs }}</td></tr><tr><td class="line">945</td><td class="hits"></td><td class="source">                            }, function(er) {</td></tr><tr class="miss"><td class="line">946</td><td class="hits">0</td><td class="source">                                if(er) console.log(&quot;error occurred updating batch&quot;, er);</td></tr><tr><td class="line">947</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">948</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">949</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">950</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">951</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">952</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">953</td><td class="hits">1</td><td class="source">    var _adminCaasList = function(req, res, next) {</td></tr><tr><td class="line">954</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">955</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">956</td><td class="hits"></td><td class="source">            page = parseInt(req.params.page || 1, 10),</td></tr><tr><td class="line">957</td><td class="hits"></td><td class="source">            per_page = parseInt(req.params.per_page || PER_PAGE, 10),</td></tr><tr><td class="line">958</td><td class="hits"></td><td class="source">            notebook = req.params.notebook;</td></tr><tr><td class="line">959</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">960</td><td class="hits">0</td><td class="source">        if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">961</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">962</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;view_clipping_service&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">963</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permisison to view this&quot;));</td></tr><tr><td class="line">964</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">965</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">966</td><td class="hits">0</td><td class="source">        Clipp.Model</td></tr><tr><td class="line">967</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">968</td><td class="hits"></td><td class="source">                notebook:notebook</td></tr><tr><td class="line">969</td><td class="hits"></td><td class="source">            }, &quot;title url page notebook created&quot;)</td></tr><tr><td class="line">970</td><td class="hits"></td><td class="source">            .populate(&quot;page notebook&quot;)</td></tr><tr><td class="line">971</td><td class="hits"></td><td class="source">            .limit(per_page)</td></tr><tr><td class="line">972</td><td class="hits"></td><td class="source">            .skip((page-1)*per_page)</td></tr><tr><td class="line">973</td><td class="hits"></td><td class="source">            .exec(function(err, clipps){</td></tr><tr class="miss"><td class="line">974</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr class="miss"><td class="line">975</td><td class="hits">0</td><td class="source">                res.send(clipps);</td></tr><tr><td class="line">976</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">977</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">978</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">979</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">980</td><td class="hits">1</td><td class="source">    var _adminList = function(req, res, next) {</td></tr><tr class="miss"><td class="line">981</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">982</td><td class="hits"></td><td class="source">            page = parseInt(req.params.page || 1, 10),</td></tr><tr><td class="line">983</td><td class="hits"></td><td class="source">            per_page = parseInt(req.params.per_page || PER_PAGE, 10),</td></tr><tr><td class="line">984</td><td class="hits"></td><td class="source">            notebook = req.params.notebook;</td></tr><tr><td class="line">985</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">986</td><td class="hits">0</td><td class="source">        if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">987</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">988</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">989</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permisison to view another user's notebooks&quot;));</td></tr><tr><td class="line">990</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">991</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">992</td><td class="hits">0</td><td class="source">        Clipp.Model</td></tr><tr><td class="line">993</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">994</td><td class="hits"></td><td class="source">                notebook:notebook</td></tr><tr><td class="line">995</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">996</td><td class="hits"></td><td class="source">            .populate(&quot;page notebook&quot;)</td></tr><tr><td class="line">997</td><td class="hits"></td><td class="source">            .limit(per_page)</td></tr><tr><td class="line">998</td><td class="hits"></td><td class="source">            .skip((page-1)*per_page)</td></tr><tr><td class="line">999</td><td class="hits"></td><td class="source">            .exec(function(err, clipps){</td></tr><tr class="miss"><td class="line">1000</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr class="miss"><td class="line">1001</td><td class="hits">0</td><td class="source">                res.send({</td></tr><tr><td class="line">1002</td><td class="hits"></td><td class="source">                    clipps: clipps,</td></tr><tr><td class="line">1003</td><td class="hits"></td><td class="source">                    page: page,</td></tr><tr><td class="line">1004</td><td class="hits"></td><td class="source">                    per_page: per_page</td></tr><tr><td class="line">1005</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">1006</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1007</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1008</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1009</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">1010</td><td class="hits"></td><td class="source">        list: _list,</td></tr><tr><td class="line">1011</td><td class="hits"></td><td class="source">        listNewOnly: _listNewOnly,</td></tr><tr><td class="line">1012</td><td class="hits"></td><td class="source">        view: _view,</td></tr><tr><td class="line">1013</td><td class="hits"></td><td class="source">        viewURL: _viewURL,</td></tr><tr><td class="line">1014</td><td class="hits"></td><td class="source">        add: _add,</td></tr><tr><td class="line">1015</td><td class="hits"></td><td class="source">        createClipAndShortUrl: _createClipAndShortUrl,</td></tr><tr><td class="line">1016</td><td class="hits"></td><td class="source">        addShortUrl: _addShortUrl,</td></tr><tr><td class="line">1017</td><td class="hits"></td><td class="source">        update: _update,</td></tr><tr><td class="line">1018</td><td class="hits"></td><td class="source">        archive: _archive,</td></tr><tr><td class="line">1019</td><td class="hits"></td><td class="source">        unarchive: _unarchive,</td></tr><tr><td class="line">1020</td><td class="hits"></td><td class="source">        adminCaasList: _adminCaasList,</td></tr><tr><td class="line">1021</td><td class="hits"></td><td class="source">        adminList: _adminList,</td></tr><tr><td class="line">1022</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1023</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1024</td><td class="hits"></td><td class="source">        getPublicClipp: _getPublicClipp,</td></tr><tr><td class="line">1025</td><td class="hits"></td><td class="source">        removeTag: _removeTag,</td></tr><tr><td class="line">1026</td><td class="hits"></td><td class="source">        exportData: _exportData</td></tr><tr><td class="line">1027</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1028</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1029</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">1030</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1031</td><td class="hits">1</td><td class="source">module.exports = ClippsController;</td></tr><tr><td class="line">1032</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/controllers/comments.js">/Users/warner/code/clipppr/primeloop-api/controllers/comments.js</h2><div id="stats" class="low"><div class="percentage">43%</div><div class="sloc">16</div><div class="hits">7</div><div class="misses">9</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var CommentsController = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        restify = require(&quot;restify&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        ArrayUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/array&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        Comment = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/comment&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        request = require(&quot;request&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        restifyErrors = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/errors&quot;)(restify);</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">    var _upsert = function(req, res, next) {</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        //TODO: </td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">    var _upsertMany = function(req, res, next) {</td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="source">        console.log(&quot;Upserting many!&quot;);</td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">            len = 0,</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">            comments = req.params.comments || [req.params.comment], </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">            doneUpdatingDoc = function(err, data){</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">                if(err) console.log(err);</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">                return --len || function(){</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">                    res.send({</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">                        message: &quot;Successfully upserted &quot; + comments.length + &quot; comments&quot;,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">                        code: 200</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">                }();</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">            };</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">        len = comments.length;</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">        if(len &lt;= 0) return res.send({message: &quot;No comments to upsert.&quot;, code: 200});</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">        for(var i in comments){</td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">            Comment.Model.update(</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">                { id: comments[i].id, page: comments[i].page }, // find query</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">                {</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">                    $set: comments[i]</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">                }, </td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">                {upsert: true},</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">                doneUpdatingDoc</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">            );</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">46</td><td class="hits">1</td><td class="source">    var _upsertStream = function(req, res, next) {</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">50</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">        upsertMany: _upsertMany</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">56</td><td class="hits">1</td><td class="source">module.exports = CommentsController;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/controllers/coupons.js">/Users/warner/code/clipppr/primeloop-api/controllers/coupons.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">32</div><div class="hits">32</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var CouponsController = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        Coupon = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/coupon&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        restify = require(&quot;restify&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        restifyErrors = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/errors&quot;)(restify);</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">    var PER_PAGE = 20;</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">    var _list = function(req, res, next) {</td></tr><tr class="hit"><td class="line">12</td><td class="hits">2</td><td class="source">        if(req.user.permissions.indexOf(&quot;list_coupons&quot;) &lt; 0 &amp;&amp; req.client.permissions.indexOf(&quot;list_coupons&quot;) &lt; 0) {</td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to view coupons&quot;));</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">        var </td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">            page = parseInt(req.params.page, 10) || 1,</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">            per_page = PER_PAGE,</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">            sort = { created: 1 };</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">  </td></tr><tr class="hit"><td class="line">21</td><td class="hits">1</td><td class="source">        Coupon.Model</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">            .find({})</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">            .limit(per_page)</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">            .skip((page-1)*per_page)</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">            .sort(sort)</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">            .populate(&quot;creator&quot;)</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">            .exec(function(err, coupons){</td></tr><tr class="hit"><td class="line">28</td><td class="hits">1</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">                return res.send(coupons);    </td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">35</td><td class="hits">1</td><td class="source">    var _create = function(req, res, next) {</td></tr><tr class="hit"><td class="line">36</td><td class="hits">7</td><td class="source">        if(req.user.permissions.indexOf(&quot;create_coupons&quot;) &lt; 0 &amp;&amp; req.client.permissions.indexOf(&quot;create_coupons&quot;) &lt; 0) {</td></tr><tr class="hit"><td class="line">37</td><td class="hits">1</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to create coupons&quot;));</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">40</td><td class="hits">6</td><td class="source">        var coupon = new Coupon.Model(req.params);</td></tr><tr class="hit"><td class="line">41</td><td class="hits">6</td><td class="source">        coupon.creator = req.user._id;</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">43</td><td class="hits">6</td><td class="source">        coupon.save(function(err, resp){</td></tr><tr class="hit"><td class="line">44</td><td class="hits">9</td><td class="source">            if(err) return next(err);</td></tr><tr class="hit"><td class="line">45</td><td class="hits">3</td><td class="source">            res.send(resp);</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">49</td><td class="hits">1</td><td class="source">    var _remove = function(req, res, next) {</td></tr><tr class="hit"><td class="line">50</td><td class="hits">5</td><td class="source">        if(req.user.permissions.indexOf(&quot;remove_coupons&quot;) &lt; 0 &amp;&amp; req.client.permissions.indexOf(&quot;remove_coupons&quot;) &lt; 0) {</td></tr><tr class="hit"><td class="line">51</td><td class="hits">1</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to remove coupons&quot;));</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">53</td><td class="hits">4</td><td class="source">        var query = {name: req.params.id};</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">55</td><td class="hits">4</td><td class="source">        if(req.user.role === &quot;reseller&quot;) {</td></tr><tr class="hit"><td class="line">56</td><td class="hits">1</td><td class="source">            query.creator = req.user._id;</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">59</td><td class="hits">4</td><td class="source">        Coupon.Model</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">            .findOne(query)</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">            .exec(function(err, coupon){</td></tr><tr class="hit"><td class="line">62</td><td class="hits">4</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">64</td><td class="hits">5</td><td class="source">                if(!coupon) return next(new restify.ResourceNotFoundError(&quot;Coupon not found or you didn't create it.&quot;));</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">66</td><td class="hits">3</td><td class="source">                coupon.remove(function(err, status){</td></tr><tr class="hit"><td class="line">67</td><td class="hits">3</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">69</td><td class="hits">3</td><td class="source">                    res.send(status);</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">74</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">        create: _create,</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">        list: _list,</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">        remove: _remove</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">82</td><td class="hits">1</td><td class="source">module.exports = CouponsController;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/controllers/errors.js">/Users/warner/code/clipppr/primeloop-api/controllers/errors.js</h2><div id="stats" class="terrible"><div class="percentage">20%</div><div class="sloc">39</div><div class="hits">8</div><div class="misses">31</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var ErrorsController = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        Page = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/page&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        PageErrors = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/page_error&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        restify = require(&quot;restify&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        restifyErrors = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/errors&quot;)(restify);</td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">    var PER_PAGE = 20;</td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    var _list = function(req, res, next) {</td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;list_errors&quot;) &lt; 0 &amp;&amp; req.client.permissions.indexOf(&quot;list_errors&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">12</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to view errors&quot;));</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">            page = parseInt(req.params.page, 10) || 1,</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">            per_page = PER_PAGE,</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">            type = req.params.type,</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">            fields = req.params.fields || {},</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">            query = {},</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">            sort = { created: 1 },</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">            q = {};</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">        if(type == &quot;page&quot;) {</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">            //query on the page error collection and get those back</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">            // { errorType: {$not: {$in: [&quot;http_error&quot;]}}}</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">            query.errorType = {};</td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">            query.errorType.$not = {};</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">            query.errorType.$not.$in = [&quot;http_error&quot;];</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">            query.reviewed = false;</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">            PageErrors.Model</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">                .find(query)</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">                .limit(per_page)</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">                .skip((page-1)*per_page)</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">                .sort(sort)</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">                .populate(&quot;page&quot;)</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">                .exec(function(err, pages){</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">                    return res.send(pages);    </td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">48</td><td class="hits">1</td><td class="source">    var _view = function(req, res, next) {</td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;list_errors&quot;) &lt; 0 &amp;&amp; req.client.permissions.indexOf(&quot;list_errors&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to view errors&quot;));</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">            type = req.params.type,</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">            id = req.params.id;</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">        if(type == &quot;page&quot;) {</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">            </td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">            PageErrors.Model</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">                .findOne({_id: id})</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">                .populate(&quot;page&quot;)</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">                .exec(function(err, page){</td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="source">                    if(!page) return next(new restify.ResourceNotFoundError(&quot;PageError does not exist [&quot; + id +&quot;]&quot;));</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">                    return res.send(page);   </td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">71</td><td class="hits">1</td><td class="source">    var _update = function(req, res, next) {</td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;update_errors&quot;) &lt; 0 &amp;&amp; req.client.permissions.indexOf(&quot;update_errors&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to update errors&quot;));</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">            type = req.params.type,</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">            id = req.params.id;</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">        if(type == &quot;page&quot;) {</td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="source">            PageErrors.Model</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">                .findOne({</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">                    _id: id</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">                .exec(function(err, error){</td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="source">                    if(!error) {</td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="source">                        return next(new restify.ResourceNotFoundError(&quot;PageError does not exist [&quot; + id +&quot;]&quot;));</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">                    }   </td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="source">                    error.setAll(req.params);</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="source">                    error.save(function(err, saved){</td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="source">                        if(err) return next(err);</td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="source">                        return res.send(error);   </td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">102</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">        list: _list,</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">        view: _view,</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">        update: _update</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">109</td><td class="hits">1</td><td class="source">module.exports = ErrorsController;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/controllers/geico.js">/Users/warner/code/clipppr/primeloop-api/controllers/geico.js</h2><div id="stats" class="terrible"><div class="percentage">13%</div><div class="sloc">114</div><div class="hits">15</div><div class="misses">99</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var GeicoController = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        ArrayUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/array&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        restify = require(&quot;restify&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        moment = require('moment'),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        ActivityLog = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/activitylog&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        Clipp = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/clipp&quot;),</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        User = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/user&quot;),</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        WaitingUser = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/user_waiting&quot;),</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        Payment = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/payment&quot;),</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        restifyErrors = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/errors&quot;)(restify),</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        stripe = require(&quot;stripe&quot;),</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        request = require('request'),</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        es = require(&quot;event-stream&quot;);</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">    stripe = stripe(settings.stripe.secret_key);</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">21</td><td class="hits">1</td><td class="source">    var _bigMetric = function(req, res, next) {</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">            dPoints = 3,</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">            data = {},</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">            from = req.params.from || Date.now()-1000*60*60*24*30,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">            to = req.params.to || Date.now();</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">        var respond = function(err){</td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">            if(err) console.log(err);</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">            if(dPoints &gt; 0) return;</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">            res.send(data);</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">        User.Model.count({</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">            totalMonthlyFee: {$gt: 0},</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">            &quot;cutomer.delinquent&quot;: {$ne: true}</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">        }, function(err, count){</td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">            data.total = count;</td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">            dPoints--;</td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">            return respond(err);</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">        User.Model.find({</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">            totalMonthlyFee: {$gt: 0},</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">            &quot;cutomer.delinquent&quot;: {$ne: true},</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">            &quot;customer.subscription.start&quot;: {$gt: from/1000, $lt: to/1000},</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">            &quot;customer.subscription.status&quot;: &quot;active&quot;</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">        }, &quot;_id customer.subscription.start totalMonthlyFee&quot;)</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">        .lean()</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">        .exec(function(err, users){</td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="source">            data.users = users;</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">            dPoints--;</td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">            return respond(err);</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">        User.Model.find({</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">            &quot;trialStart&quot;: {$gt: from, $lt: to},</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">        }, &quot;_id trialStart&quot;)</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">        .lean()</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">        .exec(function(err, users){</td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="source">            if(err) console.log(err);</td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="source">            data.trialUsers = users;</td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="source">            dPoints--;</td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">            return respond(err);</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">70</td><td class="hits">1</td><td class="source">    var _dailyActiveUsers = function(req, res, next) {</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">        if(req.client.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to view user accounts&quot;));</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="source">        var endDate = moment().hour(23).minute(59).second(59); //all the way up to midnight tonight</td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="source">        var startDate = moment().subtract('days', 6).hour(0).minute(0).second(0); //a minute after midnight 7 days ago</td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="source">        _getAdminIds(function(err, users) {</td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="source">            ActivityLog.Model</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">                .find({</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">                    activityTime:{&quot;$gte&quot;: startDate.toDate(), &quot;$lte&quot;: endDate.toDate()},</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">                    user: {&quot;$nin&quot;: users}</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">                .lean()</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">                .sort('activityTime')</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">                .exec(function(err, log){</td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="source">                    return res.send(log);</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">93</td><td class="hits">1</td><td class="source">    var _weeklyActiveUsers = function(req, res, next) {</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="source">        if(req.client.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to view user accounts&quot;));</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">98</td><td class="hits">0</td><td class="source">        var endDate = moment().day(7).hour(23).minute(59).second(59); //all the way up to midnight sunday</td></tr><tr class="miss"><td class="line">99</td><td class="hits">0</td><td class="source">        var startDate = moment().day(-21).hour(0).minute(0).second(0); //3 sundays ago (should be 4 weeks total, I think)</td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="source">        _getAdminIds(function(err, users) {</td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="source">            ActivityLog.Model</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">                .find({</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">                    activityTime:{&quot;$gte&quot;: startDate.toDate(), &quot;$lte&quot;: endDate.toDate()},</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">                    user: {&quot;$nin&quot;: users}</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">                .lean()</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">                .sort('activityTime')</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">                .exec(function(err, log){</td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="source">                    return res.send(log);</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">116</td><td class="hits">1</td><td class="source">    var _monthlyActiveUsers = function(req, res, next) {</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">118</td><td class="hits">0</td><td class="source">        if(req.client.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to view user accounts&quot;));</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">121</td><td class="hits">0</td><td class="source">        var endDate = moment().endOf('month'); //all the way up to midnight for the last day of the month</td></tr><tr class="miss"><td class="line">122</td><td class="hits">0</td><td class="source">        var startDate = moment().subtract('month',2).startOf('month'); //3 months total</td></tr><tr class="miss"><td class="line">123</td><td class="hits">0</td><td class="source">        _getAdminIds(function(err, users) {</td></tr><tr class="miss"><td class="line">124</td><td class="hits">0</td><td class="source">            ActivityLog.Model</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">                .find({</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">                    activityTime:{&quot;$gte&quot;: startDate.toDate(), &quot;$lte&quot;: endDate.toDate()},</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">                    user: {&quot;$nin&quot;: users}</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">                .lean()</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">                .sort('activityTime')</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">                .exec(function(err, log){</td></tr><tr class="miss"><td class="line">132</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">134</td><td class="hits">0</td><td class="source">                    return res.send(log);</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">139</td><td class="hits">1</td><td class="source">    var _totalClippsPerDay = function(req, res, next) {</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">141</td><td class="hits">0</td><td class="source">        if(req.client.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">142</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to view user accounts&quot;));</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">144</td><td class="hits">0</td><td class="source">        var endDate = moment().hour(23).minute(59).second(59); //all the way up to midnight tonight</td></tr><tr class="miss"><td class="line">145</td><td class="hits">0</td><td class="source">        var startDate = moment().subtract('days', 6).hour(0).minute(0).second(0); //a minute after midnight 7 days ago</td></tr><tr class="miss"><td class="line">146</td><td class="hits">0</td><td class="source">        _getAdminIds(function(err, users) {</td></tr><tr class="miss"><td class="line">147</td><td class="hits">0</td><td class="source">            Clipp.Model</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source">                .find({</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">                    created:{&quot;$gte&quot;: startDate.toDate(), &quot;$lte&quot;: endDate.toDate()},</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">                    creator: { $nin: users}</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">                .lean()</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">                .sort('created')</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">                .exec(function(err, clipps){</td></tr><tr class="miss"><td class="line">155</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">157</td><td class="hits">0</td><td class="source">                    return res.send(clipps);</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">163</td><td class="hits">1</td><td class="source">    var _getAdminIds = function(done) {</td></tr><tr class="miss"><td class="line">164</td><td class="hits">0</td><td class="source">        User.Model</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">                role: &quot;admin&quot;</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">            .select(&quot;_id&quot;)</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">            .exec(function(err, users) {</td></tr><tr class="miss"><td class="line">171</td><td class="hits">0</td><td class="source">                if(err) return done(err);</td></tr><tr class="miss"><td class="line">172</td><td class="hits">0</td><td class="source">                var arr = [];</td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="source">                for(var i=0; i &lt; users.length; i++) {</td></tr><tr class="miss"><td class="line">174</td><td class="hits">0</td><td class="source">                    arr.push(users[i]._id);</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">176</td><td class="hits">0</td><td class="source">                return done(null, arr);</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">181</td><td class="hits">1</td><td class="source">    var _getStripeCustomers = function(data, emit, done){</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">183</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">            reqs = 0,</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">            len,</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">            total;</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">        //https://api.stripe.com/v1/customers</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">        //var auth = 'Basic ' + new Buffer(api_key + &quot;:&quot;).toString('base64');</td></tr><tr class="miss"><td class="line">191</td><td class="hits">0</td><td class="source">        request({</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">            url: &quot;https://api.stripe.com/v1/customers&quot;,</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">            method: &quot;GET&quot;,</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">            json: true,</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source">            qs: data,</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source">            headers: {</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">                &quot;Authorization&quot;: &quot;Basic &quot; + new Buffer(settings.stripe.secret_key+&quot;:&quot;).toString(&quot;base64&quot;)</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">        }, function(err, resp, customers){</td></tr><tr class="miss"><td class="line">200</td><td class="hits">0</td><td class="source">            if(err) return done(err);</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">202</td><td class="hits">0</td><td class="source">            total = customers.count;</td></tr><tr class="miss"><td class="line">203</td><td class="hits">0</td><td class="source">            customers = customers.data;</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">205</td><td class="hits">0</td><td class="source">            if(data.offset === 0) {</td></tr><tr class="miss"><td class="line">206</td><td class="hits">0</td><td class="source">                reqs = Math.ceil(total/data.count);</td></tr><tr class="miss"><td class="line">207</td><td class="hits">0</td><td class="source">                len = reqs;</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">            // console.log(&quot;returned&quot;,customers.length,&quot;customers&quot;);</td></tr><tr class="miss"><td class="line">211</td><td class="hits">0</td><td class="source">            console.log(resp.statusCode, customers);</td></tr><tr class="miss"><td class="line">212</td><td class="hits">0</td><td class="source">            console.log(total);</td></tr><tr class="miss"><td class="line">213</td><td class="hits">0</td><td class="source">            emit(err, customers);</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">215</td><td class="hits">0</td><td class="source">            if(reqs &lt;= 1 || !total) return done();</td></tr><tr class="miss"><td class="line">216</td><td class="hits">0</td><td class="source">            var _onComplete = function(){</td></tr><tr class="miss"><td class="line">217</td><td class="hits">0</td><td class="source">                    return --len || done();</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">                };</td></tr><tr class="miss"><td class="line">219</td><td class="hits">0</td><td class="source">            for(var i = reqs; reqs &gt; 0; reqs--) {</td></tr><tr class="miss"><td class="line">220</td><td class="hits">0</td><td class="source">                data.offset += data.count;</td></tr><tr class="miss"><td class="line">221</td><td class="hits">0</td><td class="source">                _getStripeCustomers(data, emit, _onComplete);</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">226</td><td class="hits">1</td><td class="source">    var _newPayingUsersPerDay = function(req, res, next) {</td></tr><tr class="miss"><td class="line">227</td><td class="hits">0</td><td class="source">        if(req.client.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">228</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to view user accounts&quot;));</td></tr><tr><td class="line">229</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">231</td><td class="hits">0</td><td class="source">        var data = {</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">            created: {</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">                gt: parseInt((new Date().getTime()-1000*60*60*24*7)/1000,10)</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">            count: 100,</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source">            offset: 0</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source">        /* </td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source">            We're going to stream this because we don't want a bunch of records </td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source">            sitting in memory while we hit the stripe api some uknown number of times</td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source">        */</td></tr><tr class="miss"><td class="line">243</td><td class="hits">0</td><td class="source">        es.pipeline(</td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source">            es.readable(function(count, callback){</td></tr><tr class="miss"><td class="line">245</td><td class="hits">0</td><td class="source">                var that = this;</td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">247</td><td class="hits">0</td><td class="source">                _getStripeCustomers(data, function(err, customers){</td></tr><tr class="miss"><td class="line">248</td><td class="hits">0</td><td class="source">                    if(err) return that.emit(&quot;error&quot;, err);</td></tr><tr class="miss"><td class="line">249</td><td class="hits">0</td><td class="source">                    console.log(&quot;emitting...&quot;);</td></tr><tr class="miss"><td class="line">250</td><td class="hits">0</td><td class="source">                    return that.emit(&quot;data&quot;, customers);</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source">                }, function(err){</td></tr><tr class="miss"><td class="line">252</td><td class="hits">0</td><td class="source">                    if(err) that.emit(&quot;error&quot;, err);</td></tr><tr class="miss"><td class="line">253</td><td class="hits">0</td><td class="source">                    res.end();</td></tr><tr class="miss"><td class="line">254</td><td class="hits">0</td><td class="source">                    console.log(&quot;done&quot;);</td></tr><tr class="miss"><td class="line">255</td><td class="hits">0</td><td class="source">                    return that.emit(&quot;end&quot;);</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source">            }),</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source">            es.map(function(data, callback){</td></tr><tr class="miss"><td class="line">259</td><td class="hits">0</td><td class="source">                for(var i in data) {</td></tr><tr class="miss"><td class="line">260</td><td class="hits">0</td><td class="source">                    data[i] = {</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source">                        created: data[i].created * 1000, //need it in millaseconds</td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source">                        plan: (data[i].subscription) ? data[i].subscription.plan.id : null</td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source">                    };</td></tr><tr class="miss"><td class="line">264</td><td class="hits">0</td><td class="source">                    callback(null, data[i]);</td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source">            }),</td></tr><tr><td class="line">267</td><td class="hits"></td><td class="source">            es.stringify(),</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source">            res    </td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">        );</td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">272</td><td class="hits">1</td><td class="source">    var _conversionBy14DayTrialTotal = function(req, res, next) {</td></tr><tr class="miss"><td class="line">273</td><td class="hits">0</td><td class="source">        if(req.client.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">274</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to view user accounts&quot;));</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">276</td><td class="hits">0</td><td class="source">        WaitingUser.Model</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source">                conversionDate: {&quot;$exists&quot; : true},</td></tr><tr><td class="line">279</td><td class="hits"></td><td class="source">                tags: &quot;trial&quot;</td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source">            .sort('conversionDate')</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source">            .exec(function(err, users) {</td></tr><tr class="miss"><td class="line">284</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">286</td><td class="hits">0</td><td class="source">                return res.send(users);</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">291</td><td class="hits">1</td><td class="source">    var _conversionByDemoTotal = function(req, res, next) {</td></tr><tr class="miss"><td class="line">292</td><td class="hits">0</td><td class="source">        if(req.client.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">293</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to view user accounts&quot;));</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">295</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">296</td><td class="hits">0</td><td class="source">        WaitingUser.Model</td></tr><tr><td class="line">297</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">298</td><td class="hits"></td><td class="source">                &quot;$and&quot;: </td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source">                    [{conversionDate: {&quot;$exists&quot; : true}},</td></tr><tr><td class="line">300</td><td class="hits"></td><td class="source">                    {tags: &quot;dunkindemo&quot;},</td></tr><tr><td class="line">301</td><td class="hits"></td><td class="source">                    {tags: {&quot;$nin&quot;: [&quot;trial&quot;]}}]</td></tr><tr><td class="line">302</td><td class="hits"></td><td class="source">                </td></tr><tr><td class="line">303</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">304</td><td class="hits"></td><td class="source">            .sort('conversionDate')</td></tr><tr><td class="line">305</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">306</td><td class="hits"></td><td class="source">            .exec(function(err, users) {</td></tr><tr class="miss"><td class="line">307</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">308</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">309</td><td class="hits">0</td><td class="source">                return res.send(users);</td></tr><tr><td class="line">310</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">311</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">312</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">313</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">314</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">315</td><td class="hits"></td><td class="source">        dailyActiveUsers: _dailyActiveUsers,</td></tr><tr><td class="line">316</td><td class="hits"></td><td class="source">        weeklyActiveUsers: _weeklyActiveUsers,</td></tr><tr><td class="line">317</td><td class="hits"></td><td class="source">        monthlyActiveUsers: _monthlyActiveUsers,</td></tr><tr><td class="line">318</td><td class="hits"></td><td class="source">        totalClippsPerDay: _totalClippsPerDay,</td></tr><tr><td class="line">319</td><td class="hits"></td><td class="source">        newPayingUsersPerDay: _newPayingUsersPerDay,</td></tr><tr><td class="line">320</td><td class="hits"></td><td class="source">        conversionBy14DayTrialTotal: _conversionBy14DayTrialTotal,</td></tr><tr><td class="line">321</td><td class="hits"></td><td class="source">        conversionByDemoTotal:_conversionByDemoTotal,</td></tr><tr><td class="line">322</td><td class="hits"></td><td class="source">        bigMetric: _bigMetric</td></tr><tr><td class="line">323</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">324</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">325</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">326</td><td class="hits">1</td><td class="source">module.exports = GeicoController;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/controllers/google.js">/Users/warner/code/clipppr/primeloop-api/controllers/google.js</h2><div id="stats" class="low"><div class="percentage">44%</div><div class="sloc">25</div><div class="hits">11</div><div class="misses">14</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var GoogleController = function(){</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">    var</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/settings&quot;),</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        restify = require(&quot;restify&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        googleapis = require('googleapis'),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        OAuth2Client = googleapis.OAuth2Client,</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        soap = require(&quot;soap&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        GoogleOAuthSecurity = require('../utils/google'),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        adwordsCampaignUrl = 'https://adwords.google.com/api/adwords/cm/v201406/CampaignService?wsdl',</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        adwordsConversionTrackerUrl = 'https://adwords.google.com/api/adwords/cm/v201406/ConversionTrackerService?wsdl',</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        oauth2Client,</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        plusClient;</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">    oauth2Client = new OAuth2Client(</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        Settings.GOOGLE_API_KEYS.clientId, </td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        Settings.GOOGLE_API_KEYS.clientSecret, </td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        Settings.GOOGLE_API_KEYS.signupRedirectUrl</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    );</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">    googleapis.discover(&quot;plus&quot;, &quot;v1&quot;).execute(function(err, client){</td></tr><tr class="hit"><td class="line">21</td><td class="hits">1</td><td class="source">        if(err) console.log(err);</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">23</td><td class="hits">1</td><td class="source">        plusClient = client;</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">26</td><td class="hits">1</td><td class="source">    var _getAuthUrl = function(req, res, next) {</td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="source">        var authUrl = oauth2Client.generateAuthUrl({</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">            access_type: 'offline',</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">            approval_prompt: &quot;auto&quot;,</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">            scope: 'https://adwords.google.com/api/adwords profile email'</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        });</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">        return res.send({authUrl: authUrl});</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">35</td><td class="hits">1</td><td class="source">    var _getAuthTokenAndUserData = function(req, res, next) {</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">            code = req.params.code,</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">            tokens;</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">        oauth2Client.getToken(code, function(err, tokens) {</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">            </td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">            if(err) {</td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">                console.log(&quot;err %j&quot;, err);</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">                //chances are this access code has already been used</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">                return next(new restify.ResourceNotFoundError(&quot;That authorization code from Google has either already been used or is invalid.&quot;));</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">            // if(err) return next(err);</td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="source">            tokens = tokens;</td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">            oauth2Client.credentials = tokens;</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">            plusClient.plus.people</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">                .get({userId:'me'})</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">                .withAuthClient(oauth2Client)</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">                .execute(function(err, profile){</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">                    if(err) {</td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">                        return next(new restify.ResourceNotFoundError(&quot;There was a problem retrieving your info from Google: &quot; + err));</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">                    return res.send({tokens: tokens, profile: profile});</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">63</td><td class="hits">1</td><td class="source">    var _getAdwordsCampaigns = function(req, res, next) {</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">        // soap.createClient(adwordsCampaignUrl, function(err, adwordsCampaign) {</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">        //     adwordsCampaign.setSecurity(new GoogleOAuthSecurity(&quot;ya29.ZwAL7F2oxFUBOR0AAAB09tvJOx745DcReX2TNgc4R3DrQ6aQF91tuBgdtRm6LQ&quot;));</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">        //     //when I make sure this works, try it without the clientCustomerId as I shouldn't need it</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">        //     var content = {</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">        //         &quot;clientCustomerId&quot;: &quot;977-851-1955&quot;,</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">        //         &quot;developerToken&quot;: Settings.GOOGLE_API_KEYS.adDevToken,</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">        //         &quot;userAgent&quot;: &quot;Primeloop&quot;,</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">        //         &quot;validateOnly&quot;: false,</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">        //         &quot;partialFailure&quot;: false</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">        //     };</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">        //     adwordsCampaign.addSoapHeader({&quot;RequestHeader&quot;:content}, null, &quot;ns1&quot;, &quot;https://adwords.google.com/api/adwords/cm/v201406&quot;);</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">            </td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">        //     console.log(&quot;headers: %j&quot;, adwordsCampaign.getSoapHeaders());</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">        //     adwordsCampaign.get({serviceSelector:{fields: ['CampaignName']}}, function(err, results) {</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">        //         console.log(&quot;err and results&quot;, err, results);</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">        //         return res.send(results);</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">        // });</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">        // soap.createClient(adwordsConversionTrackerUrl, function(err, adwordsConversionTracker) {</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">        //     adwordsConversionTracker.setSecurity(new GoogleOAuthSecurity(&quot;ya29.aAAFaZCoZb3KNB0AAAA9lL1zOsjwXjv-oHaBwxDjXPHOCyVCF45YIrj9ODdInQ&quot;));</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">        //     //when I make sure this works, try it without the clientCustomerId as I shouldn't need it</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">        //     var content = {</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">        //         &quot;clientCustomerId&quot;: &quot;977-851-1955&quot;,</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">        //         &quot;developerToken&quot;: Settings.GOOGLE_API_KEYS.adDevToken,</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">        //         &quot;userAgent&quot;: &quot;Primeloop&quot;,</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">        //         &quot;validateOnly&quot;: false,</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">        //         &quot;partialFailure&quot;: false</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">        //     };</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">        //     adwordsConversionTracker.addSoapHeader({&quot;RequestHeader&quot;:content}, null, &quot;ns1&quot;, &quot;https://adwords.google.com/api/adwords/cm/v201406&quot;);</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">            </td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">        //     console.log(&quot;headers: %j&quot;, adwordsConversionTracker.getSoapHeaders());</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">        //     adwordsConversionTracker.get({serviceSelector:{fields: ['Name']}}, function(err, results) {</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">        //         console.log(&quot;err and results&quot;, err, results);</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">        //         console.log(adwordsConversionTracker.lastRequest);</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">        //         return res.send(results);</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">        // });</td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="source">        return res.send({});</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">104</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">        getAuthUrl: _getAuthUrl,</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">        getAuthTokenAndUserData: _getAuthTokenAndUserData,</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">        getAdwordsCampaigns: _getAdwordsCampaigns</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">111</td><td class="hits">1</td><td class="source">module.exports = GoogleController;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/controllers/notebooks.js">/Users/warner/code/clipppr/primeloop-api/controllers/notebooks.js</h2><div id="stats" class="terrible"><div class="percentage">6%</div><div class="sloc">600</div><div class="hits">39</div><div class="misses">561</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var NotebooksController = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        ArrayUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/array&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        restify = require(&quot;restify&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        Notebook = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/notebook&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        ReportAdditions = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/report_additions&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        Email = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/email&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        Page = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/page&quot;),</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        Clipp = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/clipp&quot;),</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        SuggestedClipp = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/suggested_clipp&quot;),</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        SuggestedAction = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/suggested_action&quot;),</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        User = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/user&quot;),</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        Payment = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/payment&quot;),</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        BatchImport = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/batch_import&quot;),</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        SuggestedBatchImport  =require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/suggested_batch_import&quot;),</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        restifyErrors = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/errors&quot;)(restify),</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        moment = require(&quot;moment&quot;),</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        AuthController = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/./auth&quot;),</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        FeedParsingUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/feed_parsing&quot;),</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        Validations = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/validations&quot;),</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        async = require(&quot;async&quot;),</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        redisq = require('redisq');</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">26</td><td class="hits">1</td><td class="source">    var PER_PAGE = 20;</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">28</td><td class="hits">1</td><td class="source">    var _list = function(req, res, next) {</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">            page = parseInt(req.params.page || 1, 10),</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">            per_page = parseInt(req.params.per_page || PER_PAGE, 10),</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">            user_id = req.params.user_id;</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">        if(user_id &amp;&amp; req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permisison to view another user's notebooks&quot;));</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">        if(user_id) return _adminList(req, res, next);</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">                &quot;users.user&quot; : user_id || req.user._id</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">            .populate(&quot;users.user&quot;, &quot;name email trial trialStart gravatarHash&quot;)</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">            .limit(per_page)</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">            .skip((page-1)*per_page)</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">            .exec(function(err, notebooks){</td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">                notebooks = Notebook.prepareMultipleForOutput(notebooks, req.user);</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">                notebooks = notebooks.map(function(notebook){</td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="source">                    var owner;</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">                    notebook.users.map(function(obj){</td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">                        if(obj.role == &quot;owner&quot;) owner = obj.user;</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">                    });</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">                    if(owner &amp;&amp; owner.trial &amp;&amp; User.trialDaysLeft(owner) &lt; 0) return {</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">                        _id: notebook._id,</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">                        message: &quot;Your trial has expired.&quot;,</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">                        users: notebook.users</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">                    };</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="source">                    return notebook;</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">                return res.send({</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">                    notebooks: notebooks || [],</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">                    per_page: per_page,</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">                    page: page</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">            // This is the streaming way, the way of the stream</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">            // .stream({ transform: JSON.stringify })</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">            // .pipe(res);</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">78</td><td class="hits">1</td><td class="source">    var _pages = function(req, res, next) {</td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">            notebook = req.params.notebook,</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">            page = parseInt(req.params.page || 1, 10),</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">            per_page = parseInt(req.params.per_page || 20, 10);</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;view_notebook_page&quot;) &lt; 0 &amp;&amp; req.user.permissions.indexOf(&quot;view_referred_notebook_page&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permisison to view another user's notebook clipps&quot;));</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">                _id: notebook</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">            }, &quot;users name created&quot;)</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">            .populate(&quot;users.user&quot;, &quot;refBy&quot;)</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">98</td><td class="hits">0</td><td class="source">                if(req.user.permissions.indexOf(&quot;view_referred_notebook_page&quot;) &gt;= 0){</td></tr><tr class="miss"><td class="line">99</td><td class="hits">0</td><td class="source">                    for(var i = 0; i &lt; notebook.users.length; i++){</td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="source">                        if(notebook.users[i].role == &quot;owner&quot; &amp;&amp; notebook.users[i].user.refBy != req.user._id) {</td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="source">                            return next(new restify.NotAuthorizedError(&quot;You don't have permissions to view this notebook&quot;));</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="source">                Clipp.Model</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">                    .find({</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">                        notebook: notebook._id</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">                    }, &quot;page&quot;)</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">                    .lean()</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">                    .exec(function(err, clipps){</td></tr><tr class="miss"><td class="line">112</td><td class="hits">0</td><td class="source">                        if(err) return next(err);</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="source">                        var clipp_ids = [];</td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="source">                        for(var i in clipps){</td></tr><tr class="miss"><td class="line">116</td><td class="hits">0</td><td class="source">                            clipp_ids.push(clipps[i]._id);</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="source">                        Page.Model</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">                            .find({</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">                                clipps: {$in: clipp_ids}</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">                                // &quot;updated.comment&quot; : {$lt: new Date().getTime()-1000*60*60*8}</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">                            })</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">                            .limit(per_page)</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">                            .skip((page-1)*per_page)</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">                            .sort({&quot;updated.comment&quot;:1, &quot;updated.social&quot;: 1})</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">                            .lean()</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">                            .exec(function(err, pages){</td></tr><tr class="miss"><td class="line">129</td><td class="hits">0</td><td class="source">                                if(err) return next(err);</td></tr><tr class="miss"><td class="line">130</td><td class="hits">0</td><td class="source">                                for(var i in pages) {</td></tr><tr class="miss"><td class="line">131</td><td class="hits">0</td><td class="source">                                    for (var j in clipp_ids) {</td></tr><tr class="miss"><td class="line">132</td><td class="hits">0</td><td class="source">                                        if(ArrayUtils.inArray(clipp_ids[j], pages[i].clipps) &gt; -1) {</td></tr><tr class="miss"><td class="line">133</td><td class="hits">0</td><td class="source">                                            pages[i].clippId = clipp_ids[j];</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">                                        }</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">                                    }</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">                                }</td></tr><tr class="miss"><td class="line">137</td><td class="hits">0</td><td class="source">                                return res.send({</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">                                    pages: pages,</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">                                    notebook: notebook,</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">                                    page: page,</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">                                    per_page: per_page</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">                                });</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">149</td><td class="hits">1</td><td class="source">    var _page = function(req, res, next) {</td></tr><tr class="miss"><td class="line">150</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">            notebook = req.params.notebook;</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">153</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;view_notebook_page&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">154</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permisison to view another user's notebook pages&quot;));</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">157</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">                _id: notebook</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">            }, &quot;users name created&quot;)</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">162</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">164</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">166</td><td class="hits">0</td><td class="source">                Clipp.Model</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">                    .find({</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">                        notebook: notebook._id</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">                    }, &quot;page&quot;)</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">                    .lean()</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">                    .exec(function(err, clipps){</td></tr><tr class="miss"><td class="line">172</td><td class="hits">0</td><td class="source">                        if(err) return next(err);</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">174</td><td class="hits">0</td><td class="source">                        var clipp_ids = [];</td></tr><tr class="miss"><td class="line">175</td><td class="hits">0</td><td class="source">                        for(var i in clipps){</td></tr><tr class="miss"><td class="line">176</td><td class="hits">0</td><td class="source">                            clipp_ids.push(clipps[i]._id);</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">179</td><td class="hits">0</td><td class="source">                        Page.Model</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">                            .find({</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">                                clipps: {$in: clipp_ids},</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">                                &quot;updated.comment&quot; : {$lt: new Date().getTime()-1000*60*60*8}</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">                                // &quot;updated.social&quot; : {$lt: new Date().getTime()-1000*60*60*8}</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">                            })</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">                            .sort({&quot;updated.comment&quot;:1, &quot;updated.social&quot;: 1})</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">                            .lean()</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">                            .exec(function(err, pages){</td></tr><tr class="miss"><td class="line">188</td><td class="hits">0</td><td class="source">                                if(err) return next(err);</td></tr><tr class="miss"><td class="line">189</td><td class="hits">0</td><td class="source">                                var prevPage, nextPage, page;</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">191</td><td class="hits">0</td><td class="source">                                for(var i in pages){</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">193</td><td class="hits">0</td><td class="source">                                    if(pages[i]._id == req.params.id) {</td></tr><tr class="miss"><td class="line">194</td><td class="hits">0</td><td class="source">                                        page = pages[i];</td></tr><tr class="miss"><td class="line">195</td><td class="hits">0</td><td class="source">                                        nextPage = (i &lt; pages.length &amp;&amp; pages[parseInt(i,10)+1]) ? pages[parseInt(i,10)+1] : null;</td></tr><tr class="miss"><td class="line">196</td><td class="hits">0</td><td class="source">                                        break;</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">                                    }</td></tr><tr class="miss"><td class="line">198</td><td class="hits">0</td><td class="source">                                    prevPage = pages[i]._id;</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">                                }</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">201</td><td class="hits">0</td><td class="source">                                if(!page) return next(new restify.ResourceNotFoundError(&quot;Page not found in this notebook&quot;));</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">203</td><td class="hits">0</td><td class="source">                                page.next_page = nextPage;</td></tr><tr class="miss"><td class="line">204</td><td class="hits">0</td><td class="source">                                page.prev_page = prevPage;</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">206</td><td class="hits">0</td><td class="source">                                return res.send(page);</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">    //TODO: Make this admin query cleaner</td></tr><tr class="hit"><td class="line">215</td><td class="hits">1</td><td class="source">    var _adminList = function(req, res, next) {</td></tr><tr class="miss"><td class="line">216</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">            page = parseInt(req.params.page || 1, 10),</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">            per_page = parseInt(req.params.per_page || PER_PAGE, 10),</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source">            user_id = req.params.user_id,</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source">            idx,</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source">            nbs = [];</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">224</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source">                &quot;users.user&quot;: user_id</td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source">            .populate({</td></tr><tr><td class="line">229</td><td class="hits"></td><td class="source">                path: &quot;clipps.page&quot;,</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">                match: {</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">                    $or: [</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">                        { &quot;updated.social&quot;: { $lt: new Date().getTime() - (1000*60*60*16)} }, //TODO: Make this 24 hours?</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">                        { &quot;updated.comment&quot;: { $lt: new Date().getTime() - (1000*60*60*16)} },</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source">                        { &quot;updated.social&quot;: { $exists: false} },</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">                        { &quot;updated.comment&quot;: { $exists: false} }</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source">                    ]</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source">            .populate(&quot;clipps.clipp&quot;)</td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source">            .limit(per_page)</td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source">            .skip((page-1)*per_page)</td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source">            .exec(function(err, notebooks){</td></tr><tr class="miss"><td class="line">243</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">245</td><td class="hits">0</td><td class="source">                for(var i in notebooks) {</td></tr><tr class="miss"><td class="line">246</td><td class="hits">0</td><td class="source">                    idx = ArrayUtils.inArray(user_id, notebooks[i].users, &quot;user&quot;);</td></tr><tr class="miss"><td class="line">247</td><td class="hits">0</td><td class="source">                    if(idx &lt; 0 || notebooks[i].users[idx].role != &quot;owner&quot;) {</td></tr><tr class="miss"><td class="line">248</td><td class="hits">0</td><td class="source">                        continue;</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">251</td><td class="hits">0</td><td class="source">                    notebooks[i] = Notebook.prepareForOutput(notebooks[i], req.user);</td></tr><tr class="miss"><td class="line">252</td><td class="hits">0</td><td class="source">                    notebooks[i].pageCount = 0;</td></tr><tr class="miss"><td class="line">253</td><td class="hits">0</td><td class="source">                    for(var j in notebooks[i].clipps) {</td></tr><tr class="miss"><td class="line">254</td><td class="hits">0</td><td class="source">                        if(</td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">                            notebooks[i].clipps[j].clipp &amp;&amp;</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source">                            notebooks[i].clipps[j].clipp._id &amp;&amp;</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source">                            notebooks[i].clipps[j].page &amp;&amp;</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source">                            notebooks[i].clipps[j].page._id</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source">                        ){</td></tr><tr class="miss"><td class="line">260</td><td class="hits">0</td><td class="source">                            notebooks[i].pageCount++;</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">264</td><td class="hits">0</td><td class="source">                    nbs.push(notebooks[i]);</td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">267</td><td class="hits">0</td><td class="source">                return res.send({</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source">                    notebooks: nbs,</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">                    page: page,</td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source">                    per_page: per_page</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">272</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">273</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">276</td><td class="hits">1</td><td class="source">    var _getBatch = function(req, res, next) {</td></tr><tr class="miss"><td class="line">277</td><td class="hits">0</td><td class="source">        if(!req.params.batch) return next(new restifyErrors.InvalidInputError(&quot;Batch id required&quot;));</td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source">        //grab the notebook id</td></tr><tr><td class="line">279</td><td class="hits"></td><td class="source">        // console.log(&quot;should have a notebook id: &quot; + JSON.stringify(req.params));</td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">281</td><td class="hits">0</td><td class="source">        if(req.params.notebook) {</td></tr><tr class="miss"><td class="line">282</td><td class="hits">0</td><td class="source">            Notebook.Model</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source">                .findOne({</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source">                    _id: req.params.notebook,</td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source">                    &quot;users.user&quot; : req.user._id</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source">                .populate(&quot;clipps.clipp&quot;, &quot;url&quot;)</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">                .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">289</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">291</td><td class="hits">0</td><td class="source">                    if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr class="miss"><td class="line">292</td><td class="hits">0</td><td class="source">                    if(notebook.getPermissions(req.user).indexOf(&quot;add_clipp_to_notebook&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">293</td><td class="hits">0</td><td class="source">                        return next(new restify.NotAuthorizedError(&quot;You don't have permissions to add a clipp to this notebook&quot;));</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">295</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">296</td><td class="hits">0</td><td class="source">                    BatchImport.Model</td></tr><tr><td class="line">297</td><td class="hits"></td><td class="source">                        .findOne({</td></tr><tr><td class="line">298</td><td class="hits"></td><td class="source">                            _id: req.params.batch</td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source">                        })</td></tr><tr><td class="line">300</td><td class="hits"></td><td class="source">                        .lean()</td></tr><tr><td class="line">301</td><td class="hits"></td><td class="source">                        .exec(function (err, batch) {</td></tr><tr class="miss"><td class="line">302</td><td class="hits">0</td><td class="source">                            if(err) return next(err);</td></tr><tr class="miss"><td class="line">303</td><td class="hits">0</td><td class="source">                            var totalProcessed = batch.totalProcessed;</td></tr><tr class="miss"><td class="line">304</td><td class="hits">0</td><td class="source">                            var totalToBeProcessed = batch.totalToBeProcessed;</td></tr><tr class="miss"><td class="line">305</td><td class="hits">0</td><td class="source">                            return res.send({totalProcessed: totalProcessed, totalToBeProcessed:totalToBeProcessed});</td></tr><tr><td class="line">306</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">307</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">308</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">309</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">310</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">311</td><td class="hits">1</td><td class="source">    var _getBatchAdmin = function(req, res, next) {</td></tr><tr><td class="line">312</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">313</td><td class="hits">0</td><td class="source">        if(!req.params.batch) return next(new restifyErrors.InvalidInputError(&quot;Batch id required&quot;));</td></tr><tr class="miss"><td class="line">314</td><td class="hits">0</td><td class="source">        if(req.params.notebook) {</td></tr><tr class="miss"><td class="line">315</td><td class="hits">0</td><td class="source">            Notebook.Model</td></tr><tr><td class="line">316</td><td class="hits"></td><td class="source">                .findOne({</td></tr><tr><td class="line">317</td><td class="hits"></td><td class="source">                    _id: req.params.notebook,</td></tr><tr><td class="line">318</td><td class="hits"></td><td class="source">                    &quot;users.user&quot; : req.user._id</td></tr><tr><td class="line">319</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">320</td><td class="hits"></td><td class="source">                .populate(&quot;clipps.clipp&quot;, &quot;url&quot;)</td></tr><tr><td class="line">321</td><td class="hits"></td><td class="source">                .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">322</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">323</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">324</td><td class="hits">0</td><td class="source">                    if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr class="miss"><td class="line">325</td><td class="hits">0</td><td class="source">                    if(notebook.getPermissions(req.user).indexOf(&quot;add_clipp_to_notebook&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">326</td><td class="hits">0</td><td class="source">                        return next(new restify.NotAuthorizedError(&quot;You don't have permissions to add a clipp to this notebook&quot;));</td></tr><tr><td class="line">327</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">328</td><td class="hits">0</td><td class="source">                    BatchImport.Model</td></tr><tr><td class="line">329</td><td class="hits"></td><td class="source">                        .findOne({</td></tr><tr><td class="line">330</td><td class="hits"></td><td class="source">                            _id: req.params.batch</td></tr><tr><td class="line">331</td><td class="hits"></td><td class="source">                        })</td></tr><tr><td class="line">332</td><td class="hits"></td><td class="source">                        .lean()</td></tr><tr><td class="line">333</td><td class="hits"></td><td class="source">                        .exec(function(err, batch){</td></tr><tr class="miss"><td class="line">334</td><td class="hits">0</td><td class="source">                            if(err) return next(err);</td></tr><tr><td class="line">335</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">336</td><td class="hits">0</td><td class="source">                            return res.send(batch.logs);</td></tr><tr><td class="line">337</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">338</td><td class="hits"></td><td class="source">                    // Clipp.Model</td></tr><tr><td class="line">339</td><td class="hits"></td><td class="source">                    //     .find({</td></tr><tr><td class="line">340</td><td class="hits"></td><td class="source">                    //         batch: req.params.batch</td></tr><tr><td class="line">341</td><td class="hits"></td><td class="source">                    //     }, &quot;title url error created&quot;)</td></tr><tr><td class="line">342</td><td class="hits"></td><td class="source">                    //     .lean()</td></tr><tr><td class="line">343</td><td class="hits"></td><td class="source">                    //     .exec(function(err, clipps){</td></tr><tr><td class="line">344</td><td class="hits"></td><td class="source">                    //         if(err) return next(err);</td></tr><tr><td class="line">345</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">346</td><td class="hits"></td><td class="source">                    //         return res.send(clipps);</td></tr><tr><td class="line">347</td><td class="hits"></td><td class="source">                    //     });</td></tr><tr><td class="line">348</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">349</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">350</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">351</td><td class="hits">0</td><td class="source">            if(req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0 &amp;&amp; req.user.permissions.indexOf(&quot;view_referred_accounts&quot;) &lt; 0 &amp;&amp; req.user.permissions.indexOf(&quot;import_links_to_account&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">352</td><td class="hits">0</td><td class="source">                return next(new restify.NotAuthorizedError(&quot;You don't have permisison to view another user's notebook&quot;));</td></tr><tr><td class="line">353</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">354</td><td class="hits">0</td><td class="source">            BatchImport.Model</td></tr><tr><td class="line">355</td><td class="hits"></td><td class="source">                .findOne({</td></tr><tr><td class="line">356</td><td class="hits"></td><td class="source">                    _id: req.params.batch</td></tr><tr><td class="line">357</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">358</td><td class="hits"></td><td class="source">                .lean()</td></tr><tr><td class="line">359</td><td class="hits"></td><td class="source">                .exec(function(err, batch){</td></tr><tr class="miss"><td class="line">360</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">361</td><td class="hits"></td><td class="source">                    // console.log(&quot;logs: %j&quot;, batch.logs);</td></tr><tr><td class="line">362</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">363</td><td class="hits">0</td><td class="source">                    return res.send(batch.logs);</td></tr><tr><td class="line">364</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">365</td><td class="hits"></td><td class="source">            // Clipp.Model</td></tr><tr><td class="line">366</td><td class="hits"></td><td class="source">            //     .find({</td></tr><tr><td class="line">367</td><td class="hits"></td><td class="source">            //         batch: req.params.batch</td></tr><tr><td class="line">368</td><td class="hits"></td><td class="source">            //     }, &quot;title url error created&quot;)</td></tr><tr><td class="line">369</td><td class="hits"></td><td class="source">            //     .lean()</td></tr><tr><td class="line">370</td><td class="hits"></td><td class="source">            //     .exec(function(err, clipps){</td></tr><tr><td class="line">371</td><td class="hits"></td><td class="source">            //         if(err) return next(err);</td></tr><tr><td class="line">372</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">373</td><td class="hits"></td><td class="source">            //         return res.send(clipps);</td></tr><tr><td class="line">374</td><td class="hits"></td><td class="source">            //     });</td></tr><tr><td class="line">375</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">376</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">377</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">378</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">379</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">380</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">381</td><td class="hits">1</td><td class="source">    var _getSuggestedBatch = function(req, res, next) {</td></tr><tr class="miss"><td class="line">382</td><td class="hits">0</td><td class="source">        if(!req.params.batch) return next(new restifyErrors.InvalidInputError(&quot;Batch id required&quot;));</td></tr><tr><td class="line">383</td><td class="hits"></td><td class="source">        //grab the notebook id</td></tr><tr><td class="line">384</td><td class="hits"></td><td class="source">        // console.log(&quot;should have a notebook id: &quot; + JSON.stringify(req.params));</td></tr><tr><td class="line">385</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">386</td><td class="hits">0</td><td class="source">        if(req.params.notebook) {</td></tr><tr class="miss"><td class="line">387</td><td class="hits">0</td><td class="source">            Notebook.Model</td></tr><tr><td class="line">388</td><td class="hits"></td><td class="source">                .findOne({</td></tr><tr><td class="line">389</td><td class="hits"></td><td class="source">                    _id: req.params.notebook,</td></tr><tr><td class="line">390</td><td class="hits"></td><td class="source">                    &quot;users.user&quot; : req.user._id</td></tr><tr><td class="line">391</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">392</td><td class="hits"></td><td class="source">                .populate(&quot;clipps.clipp&quot;, &quot;url&quot;)</td></tr><tr><td class="line">393</td><td class="hits"></td><td class="source">                .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">394</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">395</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">396</td><td class="hits">0</td><td class="source">                    if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr class="miss"><td class="line">397</td><td class="hits">0</td><td class="source">                    if(notebook.getPermissions(req.user).indexOf(&quot;add_clipp_to_notebook&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">398</td><td class="hits">0</td><td class="source">                        return next(new restify.NotAuthorizedError(&quot;You don't have permissions to add a clipp to this notebook&quot;));</td></tr><tr><td class="line">399</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">400</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">401</td><td class="hits">0</td><td class="source">                    SuggestedBatchImport.Model</td></tr><tr><td class="line">402</td><td class="hits"></td><td class="source">                        .findOne({</td></tr><tr><td class="line">403</td><td class="hits"></td><td class="source">                            _id: req.params.batch</td></tr><tr><td class="line">404</td><td class="hits"></td><td class="source">                        })</td></tr><tr><td class="line">405</td><td class="hits"></td><td class="source">                        .lean()</td></tr><tr><td class="line">406</td><td class="hits"></td><td class="source">                        .exec(function (err, batch) {</td></tr><tr class="miss"><td class="line">407</td><td class="hits">0</td><td class="source">                            if(err) return next(err);</td></tr><tr class="miss"><td class="line">408</td><td class="hits">0</td><td class="source">                            var totalProcessed = batch.totalProcessed;</td></tr><tr class="miss"><td class="line">409</td><td class="hits">0</td><td class="source">                            var totalToBeProcessed = batch.totalToBeProcessed;</td></tr><tr class="miss"><td class="line">410</td><td class="hits">0</td><td class="source">                            return res.send({totalProcessed: totalProcessed, totalToBeProcessed:totalToBeProcessed});</td></tr><tr><td class="line">411</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">412</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">413</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">414</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">415</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">416</td><td class="hits">1</td><td class="source">    var _getSuggestedBatchAdmin = function(req, res, next) {</td></tr><tr class="miss"><td class="line">417</td><td class="hits">0</td><td class="source">        if(!req.params.batch) return next(new restifyErrors.InvalidInputError(&quot;Batch id required&quot;));</td></tr><tr><td class="line">418</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">419</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;import_links_to_account&quot;) &lt; 0 &amp;&amp; req.user.permissions.indexOf(&quot;view_referred_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">420</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permisison to view another user's notebook&quot;));</td></tr><tr><td class="line">421</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">422</td><td class="hits">0</td><td class="source">        SuggestedBatchImport.Model</td></tr><tr><td class="line">423</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">424</td><td class="hits"></td><td class="source">                _id: req.params.batch</td></tr><tr><td class="line">425</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">426</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">427</td><td class="hits"></td><td class="source">            .exec(function(err, batch){</td></tr><tr class="miss"><td class="line">428</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">429</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">430</td><td class="hits">0</td><td class="source">                return res.send(batch.logs);</td></tr><tr><td class="line">431</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">432</td><td class="hits"></td><td class="source">        // SuggestedClipp.Model</td></tr><tr><td class="line">433</td><td class="hits"></td><td class="source">        //     .find({</td></tr><tr><td class="line">434</td><td class="hits"></td><td class="source">        //         batch: req.params.batch</td></tr><tr><td class="line">435</td><td class="hits"></td><td class="source">        //     }, &quot;title url error created&quot;)</td></tr><tr><td class="line">436</td><td class="hits"></td><td class="source">        //     .populate(&quot;error&quot;)</td></tr><tr><td class="line">437</td><td class="hits"></td><td class="source">        //     .lean()</td></tr><tr><td class="line">438</td><td class="hits"></td><td class="source">        //     .exec(function(err, clipps){</td></tr><tr><td class="line">439</td><td class="hits"></td><td class="source">        //         if(err) return next(err);</td></tr><tr><td class="line">440</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">441</td><td class="hits"></td><td class="source">        //         return res.send(clipps);</td></tr><tr><td class="line">442</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">443</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">444</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">445</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">446</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">447</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">448</td><td class="hits">1</td><td class="source">    var _checkTrialStatus = function(req, res, next) {</td></tr><tr class="miss"><td class="line">449</td><td class="hits">0</td><td class="source">        var notebook_id = req.params.notebook || req.params.id;</td></tr><tr><td class="line">450</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">451</td><td class="hits"></td><td class="source">        // console.log(&quot;Checking trial status of notebook&quot;, notebook_id);</td></tr><tr><td class="line">452</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">453</td><td class="hits">0</td><td class="source">        Notebook.Model.findOne({</td></tr><tr><td class="line">454</td><td class="hits"></td><td class="source">                _id: notebook_id,</td></tr><tr><td class="line">455</td><td class="hits"></td><td class="source">                &quot;users.user&quot; : req.user._id</td></tr><tr><td class="line">456</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">457</td><td class="hits"></td><td class="source">            }, &quot;name _id users created trial trialStart enabled demo type canReport google_analytics.username features siteUrls&quot;)</td></tr><tr><td class="line">458</td><td class="hits"></td><td class="source">            .populate(&quot;users.user&quot;, &quot;name email gravatarHash lastAction enabled trial trialStart&quot;)</td></tr><tr><td class="line">459</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">460</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">461</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">462</td><td class="hits">0</td><td class="source">                if(!notebook) return next();</td></tr><tr><td class="line">463</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">464</td><td class="hits">0</td><td class="source">                var owner;</td></tr><tr class="miss"><td class="line">465</td><td class="hits">0</td><td class="source">                notebook.users.map(function(obj){</td></tr><tr class="miss"><td class="line">466</td><td class="hits">0</td><td class="source">                    if(obj.role == &quot;owner&quot;) owner = obj.user;</td></tr><tr><td class="line">467</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">468</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">469</td><td class="hits">0</td><td class="source">                var trialDaysLeft;</td></tr><tr class="miss"><td class="line">470</td><td class="hits">0</td><td class="source">                if(owner &amp;&amp; owner.trial) {</td></tr><tr class="miss"><td class="line">471</td><td class="hits">0</td><td class="source">                    trialDaysLeft = User.trialDaysLeft(owner);</td></tr><tr class="miss"><td class="line">472</td><td class="hits">0</td><td class="source">                    if(trialDaysLeft&lt;=0) {</td></tr><tr class="miss"><td class="line">473</td><td class="hits">0</td><td class="source">                        return next(new restifyErrors.TrailExpiredError(&quot;Trial expired&quot;));</td></tr><tr><td class="line">474</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">475</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">476</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">477</td><td class="hits">0</td><td class="source">                return next();</td></tr><tr><td class="line">478</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">479</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">480</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">481</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">482</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">483</td><td class="hits">1</td><td class="source">    var _view = function(req, res, next) {</td></tr><tr><td class="line">484</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">485</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">486</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">487</td><td class="hits"></td><td class="source">                _id: req.params.id,</td></tr><tr><td class="line">488</td><td class="hits"></td><td class="source">                // &quot;users.user&quot; : req.user._id</td></tr><tr><td class="line">489</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">490</td><td class="hits"></td><td class="source">            }, &quot;name _id users created trial trialStart enabled demo type canReport google_analytics.username features siteUrls anonymousAccess alertsTracking retarget&quot;)</td></tr><tr><td class="line">491</td><td class="hits"></td><td class="source">            .populate(&quot;users.user&quot;, &quot;name email gravatarHash lastAction enabled trial trialStart&quot;)</td></tr><tr><td class="line">492</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">493</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">494</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">495</td><td class="hits">0</td><td class="source">                if(!notebook) {</td></tr><tr class="miss"><td class="line">496</td><td class="hits">0</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;Notebook does not exist&quot;));</td></tr><tr><td class="line">497</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">498</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">499</td><td class="hits">0</td><td class="source">                var anonymousAccess = (req.user._id == &quot;anonymous&quot; &amp;&amp; notebook.anonymousAccess === true);</td></tr><tr><td class="line">500</td><td class="hits"></td><td class="source">                // console.log(req.user._id, notebook.anonymousAccess);</td></tr><tr><td class="line">501</td><td class="hits"></td><td class="source">                //TODO: if teh user doesn't have permission to view the collaborators remove them!</td></tr><tr class="miss"><td class="line">502</td><td class="hits">0</td><td class="source">                if(notebook.getPermissions(req.user).indexOf(&quot;view_notebooks&quot;) &lt; 0 &amp;&amp; !anonymousAccess &amp;&amp; req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">503</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to view this notebook&quot;));</td></tr><tr><td class="line">504</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">505</td><td class="hits"></td><td class="source">                // console.log(notebook.users);</td></tr><tr class="miss"><td class="line">506</td><td class="hits">0</td><td class="source">                notebook = Notebook.prepareForOutput(notebook, req.user);</td></tr><tr class="miss"><td class="line">507</td><td class="hits">0</td><td class="source">                return res.send(notebook);</td></tr><tr><td class="line">508</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">509</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">510</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">511</td><td class="hits">1</td><td class="source">    var _add = function(req, res, next) {</td></tr><tr><td class="line">512</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">513</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">514</td><td class="hits"></td><td class="source">            _user = req.user,</td></tr><tr><td class="line">515</td><td class="hits"></td><td class="source">            user = {</td></tr><tr><td class="line">516</td><td class="hits"></td><td class="source">                _id : req.params.user_id</td></tr><tr><td class="line">517</td><td class="hits"></td><td class="source">            };</td></tr><tr><td class="line">518</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">519</td><td class="hits">0</td><td class="source">        if(_user.permissions.indexOf(&quot;add_notebook&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">520</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permissions to add a notebook&quot;));</td></tr><tr><td class="line">521</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">522</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">523</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">524</td><td class="hits">0</td><td class="source">        if(user._id &amp;&amp; _user._id != user._id &amp;&amp; (_user.permissions.indexOf(&quot;add_notebook_to_account&quot;) &gt;= 0 || _user.permissions.indexOf(&quot;add_notebook_to_referred_account&quot;) &gt;= 0)) {</td></tr><tr class="miss"><td class="line">525</td><td class="hits">0</td><td class="source">            User.Model</td></tr><tr><td class="line">526</td><td class="hits"></td><td class="source">                .findOne({</td></tr><tr><td class="line">527</td><td class="hits"></td><td class="source">                    _id: user._id</td></tr><tr><td class="line">528</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">529</td><td class="hits"></td><td class="source">                .lean()</td></tr><tr><td class="line">530</td><td class="hits"></td><td class="source">                .exec(function(err, usr){</td></tr><tr class="miss"><td class="line">531</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr class="miss"><td class="line">532</td><td class="hits">0</td><td class="source">                    if(!usr) return next(new restify.ResourceNotFoundError(&quot;User does not exist&quot;));</td></tr><tr><td class="line">533</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">534</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">535</td><td class="hits">0</td><td class="source">                    if(_user.permissions.indexOf(&quot;add_notebook_to_referred_account&quot;) &gt;= 0 &amp;&amp; usr.refBy != _user._id) {</td></tr><tr class="miss"><td class="line">536</td><td class="hits">0</td><td class="source">                        return next(new restify.NotAuthorizedError(&quot;You don't have permissions to add a notebook to this user's account.&quot;));</td></tr><tr><td class="line">537</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">538</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">539</td><td class="hits">0</td><td class="source">                    user = usr;</td></tr><tr class="miss"><td class="line">540</td><td class="hits">0</td><td class="source">                    return createNotebook();</td></tr><tr><td class="line">541</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">542</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">543</td><td class="hits">0</td><td class="source">            user = _user;</td></tr><tr class="miss"><td class="line">544</td><td class="hits">0</td><td class="source">            return createNotebook();</td></tr><tr><td class="line">545</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">546</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">547</td><td class="hits">0</td><td class="source">        function createNotebook(){</td></tr><tr><td class="line">548</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">549</td><td class="hits">0</td><td class="source">            Notebook.ownedNotebooks(user, function(err, count){</td></tr><tr class="miss"><td class="line">550</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">551</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">552</td><td class="hits">0</td><td class="source">                var max_owned_notebooks = 0;</td></tr><tr><td class="line">553</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">554</td><td class="hits">0</td><td class="source">                if(</td></tr><tr><td class="line">555</td><td class="hits"></td><td class="source">                    user &amp;&amp;</td></tr><tr><td class="line">556</td><td class="hits"></td><td class="source">                    user.customer &amp;&amp;</td></tr><tr><td class="line">557</td><td class="hits"></td><td class="source">                    user.customer.subscription &amp;&amp;</td></tr><tr><td class="line">558</td><td class="hits"></td><td class="source">                    user.customer.subscription.plan &amp;&amp;</td></tr><tr><td class="line">559</td><td class="hits"></td><td class="source">                    user.customer.subscription.plan.metadata.max_owned_notebooks !== null</td></tr><tr><td class="line">560</td><td class="hits"></td><td class="source">                ) {</td></tr><tr class="miss"><td class="line">561</td><td class="hits">0</td><td class="source">                    max_owned_notebooks = user.customer.subscription.plan.metadata.max_owned_notebooks;</td></tr><tr><td class="line">562</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">563</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">564</td><td class="hits"></td><td class="source">                //If the user isn't an admin then they must have already paid for the nth notebook</td></tr><tr class="miss"><td class="line">565</td><td class="hits">0</td><td class="source">                if(</td></tr><tr><td class="line">566</td><td class="hits"></td><td class="source">                    _user.permissions.indexOf(&quot;add_notebook_to_account&quot;) &lt; 0 &amp;&amp;</td></tr><tr><td class="line">567</td><td class="hits"></td><td class="source">                    _user.permissions.indexOf(&quot;add_notebook_to_referred_account&quot;) &lt; 0 &amp;&amp;</td></tr><tr><td class="line">568</td><td class="hits"></td><td class="source">                    (</td></tr><tr><td class="line">569</td><td class="hits"></td><td class="source">                        !user.customer ||</td></tr><tr><td class="line">570</td><td class="hits"></td><td class="source">                        !user.customer.subscription ||</td></tr><tr><td class="line">571</td><td class="hits"></td><td class="source">                        parseInt(max_owned_notebooks, 10) &lt;= parseInt(count, 10)</td></tr><tr><td class="line">572</td><td class="hits"></td><td class="source">                    )</td></tr><tr><td class="line">573</td><td class="hits"></td><td class="source">                )</td></tr><tr><td class="line">574</td><td class="hits"></td><td class="source">                {</td></tr><tr class="miss"><td class="line">575</td><td class="hits">0</td><td class="source">                    return next(new restifyErrors.PlanLimitReachedError(&quot;You must upgrade your plan to add notebooks.&quot;));</td></tr><tr><td class="line">576</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">577</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">578</td><td class="hits">0</td><td class="source">                var notebook = new Notebook.Model(req.params);</td></tr><tr><td class="line">579</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">580</td><td class="hits">0</td><td class="source">                notebook.users.push({</td></tr><tr><td class="line">581</td><td class="hits"></td><td class="source">                    user: user._id,</td></tr><tr><td class="line">582</td><td class="hits"></td><td class="source">                    role: &quot;owner&quot;</td></tr><tr><td class="line">583</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">584</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">585</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">586</td><td class="hits">0</td><td class="source">                notebook.save(function(err, saved){</td></tr><tr class="miss"><td class="line">587</td><td class="hits">0</td><td class="source">                    if(err &amp;&amp; err.errors) {</td></tr><tr class="miss"><td class="line">588</td><td class="hits">0</td><td class="source">                        return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">589</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">590</td><td class="hits">0</td><td class="source">                    else if(err) return next(err);</td></tr><tr><td class="line">591</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">592</td><td class="hits"></td><td class="source">                    //Refresh user session here</td></tr><tr class="miss"><td class="line">593</td><td class="hits">0</td><td class="source">                    AuthController.refreshSessionForUser(user, function(err, result){</td></tr><tr class="miss"><td class="line">594</td><td class="hits">0</td><td class="source">                        if(err) console.log(&quot;Error refreshing session after creating notebook:&quot;, err);</td></tr><tr><td class="line">595</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">596</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">597</td><td class="hits">0</td><td class="source">                    return res.send(saved);</td></tr><tr><td class="line">598</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">599</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">600</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">601</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">602</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">603</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">604</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">605</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">606</td><td class="hits">1</td><td class="source">    var _update = function(req, res, next) {</td></tr><tr class="miss"><td class="line">607</td><td class="hits">0</td><td class="source">        console.log(&quot;calling update notebook with %j&quot;, req.params);</td></tr><tr class="miss"><td class="line">608</td><td class="hits">0</td><td class="source">        var query = {</td></tr><tr><td class="line">609</td><td class="hits"></td><td class="source">            _id: req.params.id,</td></tr><tr><td class="line">610</td><td class="hits"></td><td class="source">            &quot;users.user&quot;: req.user._id</td></tr><tr><td class="line">611</td><td class="hits"></td><td class="source">        }, analyticsInvite = false;</td></tr><tr><td class="line">612</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">613</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;edit_notebook_on_account&quot;) &gt;= 0) {</td></tr><tr class="miss"><td class="line">614</td><td class="hits">0</td><td class="source">            delete query[&quot;users.user&quot;];</td></tr><tr><td class="line">615</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">616</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">617</td><td class="hits">0</td><td class="source">        var data = req.params;</td></tr><tr class="miss"><td class="line">618</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">619</td><td class="hits"></td><td class="source">            .findOne(query)</td></tr><tr><td class="line">620</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">621</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">622</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">623</td><td class="hits">0</td><td class="source">                if(!notebook) {</td></tr><tr class="miss"><td class="line">624</td><td class="hits">0</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">625</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">626</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">627</td><td class="hits">0</td><td class="source">                if(notebook.getPermissions(req.user).indexOf(&quot;edit_notebook&quot;) &lt; 0 &amp;&amp; req.user.permissions.indexOf(&quot;edit_notebook_on_account&quot;) &lt; 0) {</td></tr><tr><td class="line">628</td><td class="hits"></td><td class="source">                    //Exception for people invite to connect google analytics</td></tr><tr class="miss"><td class="line">629</td><td class="hits">0</td><td class="source">                    if(ArrayUtils.inArray(req.user._id, notebook.google_analytics.invites) &gt;= 0) {</td></tr><tr><td class="line">630</td><td class="hits"></td><td class="source">                        //only allow them to edit google analytics things</td></tr><tr class="miss"><td class="line">631</td><td class="hits">0</td><td class="source">                        analyticsInvite = true;</td></tr><tr><td class="line">632</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">633</td><td class="hits">0</td><td class="source">                        req.params = {</td></tr><tr><td class="line">634</td><td class="hits"></td><td class="source">                            google_analytics: req.params.google_analytics</td></tr><tr><td class="line">635</td><td class="hits"></td><td class="source">                        };</td></tr><tr class="miss"><td class="line">636</td><td class="hits">0</td><td class="source">                    } else return next(new restify.NotAuthorizedError(&quot;You don't have permissions to edit this notebook&quot;));</td></tr><tr><td class="line">637</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">638</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">639</td><td class="hits">0</td><td class="source">                notebook.setAll(req.params);</td></tr><tr><td class="line">640</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">641</td><td class="hits">0</td><td class="source">                if(req.params.google_analytics &amp;&amp; req.params.google_analytics.goals) notebook.google_analytics.goals = req.params.google_analytics.goals;</td></tr><tr><td class="line">642</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">643</td><td class="hits">0</td><td class="source">                notebook.save(function(err, saved){</td></tr><tr><td class="line">644</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">645</td><td class="hits">0</td><td class="source">                    if(err &amp;&amp; err.errors) {</td></tr><tr class="miss"><td class="line">646</td><td class="hits">0</td><td class="source">                        return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">647</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">648</td><td class="hits">0</td><td class="source">                    else if(err) return next(err);</td></tr><tr><td class="line">649</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">650</td><td class="hits">0</td><td class="source">                    saved = Notebook.prepareForOutput(saved, req.user);</td></tr><tr class="miss"><td class="line">651</td><td class="hits">0</td><td class="source">                    res.send(saved);</td></tr><tr><td class="line">652</td><td class="hits"></td><td class="source">                    //if they invited someone to connect then we need to send an update email to owner</td></tr><tr class="miss"><td class="line">653</td><td class="hits">0</td><td class="source">                    if(analyticsInvite) {</td></tr><tr class="miss"><td class="line">654</td><td class="hits">0</td><td class="source">                        Notebook.getOwnerForNotebook(saved, function(err, owner){</td></tr><tr class="miss"><td class="line">655</td><td class="hits">0</td><td class="source">                            console.log(&quot;returned owner %j&quot;, owner);</td></tr><tr class="miss"><td class="line">656</td><td class="hits">0</td><td class="source">                            if(owner) {</td></tr><tr class="miss"><td class="line">657</td><td class="hits">0</td><td class="source">                                var from = Settings.email.from;</td></tr><tr class="miss"><td class="line">658</td><td class="hits">0</td><td class="source">                                var email = new Email.Model({</td></tr><tr><td class="line">659</td><td class="hits"></td><td class="source">                                    to: owner.user.email,</td></tr><tr><td class="line">660</td><td class="hits"></td><td class="source">                                    from: from,</td></tr><tr><td class="line">661</td><td class="hits"></td><td class="source">                                    subject: &quot;Your Google Analytics account is now connected to Primeloop&quot;,</td></tr><tr><td class="line">662</td><td class="hits"></td><td class="source">                                    template: {</td></tr><tr><td class="line">663</td><td class="hits"></td><td class="source">                                        name: &quot;analytics_connected.mu&quot;,</td></tr><tr><td class="line">664</td><td class="hits"></td><td class="source">                                        contentType: &quot;html&quot;,</td></tr><tr><td class="line">665</td><td class="hits"></td><td class="source">                                        data: {</td></tr><tr><td class="line">666</td><td class="hits"></td><td class="source">                                            invitee: req.user,</td></tr><tr><td class="line">667</td><td class="hits"></td><td class="source">                                            user: owner.user</td></tr><tr><td class="line">668</td><td class="hits"></td><td class="source">                                        }</td></tr><tr><td class="line">669</td><td class="hits"></td><td class="source">                                    }</td></tr><tr><td class="line">670</td><td class="hits"></td><td class="source">                                });</td></tr><tr class="miss"><td class="line">671</td><td class="hits">0</td><td class="source">                                email.send(function(err, result){</td></tr><tr class="miss"><td class="line">672</td><td class="hits">0</td><td class="source">                                    if(err) console.log(&quot;Error sending notebook invite email:&quot;, err);</td></tr><tr><td class="line">673</td><td class="hits"></td><td class="source">                                });</td></tr><tr><td class="line">674</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">675</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">676</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">677</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">678</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">679</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">680</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">681</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">682</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">683</td><td class="hits">1</td><td class="source">    var _invite = function(req, res, next) {</td></tr><tr><td class="line">684</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">685</td><td class="hits">0</td><td class="source">        var query = {</td></tr><tr><td class="line">686</td><td class="hits"></td><td class="source">            _id: req.params.id,</td></tr><tr><td class="line">687</td><td class="hits"></td><td class="source">            &quot;users.user&quot;: req.user._id</td></tr><tr><td class="line">688</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">689</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">690</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;edit_notebook_on_account&quot;) &gt;= 0) {</td></tr><tr class="miss"><td class="line">691</td><td class="hits">0</td><td class="source">            delete query[&quot;users.user&quot;];</td></tr><tr><td class="line">692</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">693</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">694</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">695</td><td class="hits"></td><td class="source">            .findOne(query)</td></tr><tr><td class="line">696</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">697</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">698</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">699</td><td class="hits">0</td><td class="source">                if(!notebook) {</td></tr><tr class="miss"><td class="line">700</td><td class="hits">0</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">701</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">702</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">703</td><td class="hits">0</td><td class="source">                if(notebook.getPermissions(req.user).indexOf(&quot;invite_users&quot;) &lt; 0 &amp;&amp; req.user.permissions.indexOf(&quot;edit_notebook_on_account&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">704</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to invite people to this notebook&quot;));</td></tr><tr><td class="line">705</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">706</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">707</td><td class="hits"></td><td class="source">                /*</td></tr><tr><td class="line">708</td><td class="hits"></td><td class="source">                    TODO: What other roles should we be caring about people inviting?</td></tr><tr><td class="line">709</td><td class="hits"></td><td class="source">                    We should add a can_invite array to the permissions notebook.canInvite(req.user, &quot;role&quot;)</td></tr><tr><td class="line">710</td><td class="hits"></td><td class="source">                */</td></tr><tr class="miss"><td class="line">711</td><td class="hits">0</td><td class="source">                if(req.params.role == &quot;owner&quot; &amp;&amp; notebook.getPermissions(req.user).indexOf(&quot;invite_owner&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">712</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to invite owners to this notebook&quot;));</td></tr><tr><td class="line">713</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">714</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">715</td><td class="hits">0</td><td class="source">                req.params.role = req.params.role || &quot;contributor&quot;;</td></tr><tr><td class="line">716</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">717</td><td class="hits">0</td><td class="source">                notebook.inviteUser(req.params, function(err, invitedUser, isNew){</td></tr><tr><td class="line">718</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">719</td><td class="hits">0</td><td class="source">                    if(err &amp;&amp; err.errors) {</td></tr><tr class="miss"><td class="line">720</td><td class="hits">0</td><td class="source">                        return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">721</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">722</td><td class="hits">0</td><td class="source">                    else if(err) return next(err);</td></tr><tr><td class="line">723</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">724</td><td class="hits">0</td><td class="source">                    var from = Settings.email.from;</td></tr><tr class="miss"><td class="line">725</td><td class="hits">0</td><td class="source">                    if(isNew) {</td></tr><tr class="miss"><td class="line">726</td><td class="hits">0</td><td class="source">                        from = Settings.email.from_unsolicited;</td></tr><tr><td class="line">727</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">728</td><td class="hits">0</td><td class="source">                    var email = new Email.Model({</td></tr><tr><td class="line">729</td><td class="hits"></td><td class="source">                        to: invitedUser.email,</td></tr><tr><td class="line">730</td><td class="hits"></td><td class="source">                        from: from,</td></tr><tr><td class="line">731</td><td class="hits"></td><td class="source">                        subject: req.user.name + &quot; invited you to &quot; + notebook.name + &quot; on Primeloop&quot;,</td></tr><tr><td class="line">732</td><td class="hits"></td><td class="source">                        template: {</td></tr><tr><td class="line">733</td><td class="hits"></td><td class="source">                            name: (!invitedUser.enabled) ? &quot;notebook_invite_new_user&quot; : &quot;notebook_invite&quot;,</td></tr><tr><td class="line">734</td><td class="hits"></td><td class="source">                            contentType: &quot;text&quot;,</td></tr><tr><td class="line">735</td><td class="hits"></td><td class="source">                            data: {</td></tr><tr><td class="line">736</td><td class="hits"></td><td class="source">                                invitee: invitedUser,</td></tr><tr><td class="line">737</td><td class="hits"></td><td class="source">                                notebook: notebook,</td></tr><tr><td class="line">738</td><td class="hits"></td><td class="source">                                user: req.user</td></tr><tr><td class="line">739</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">740</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">741</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">742</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">743</td><td class="hits">0</td><td class="source">                    email.send(function(err, result){</td></tr><tr class="miss"><td class="line">744</td><td class="hits">0</td><td class="source">                        if(err) console.log(&quot;Error sending notebook invite email:&quot;, err);</td></tr><tr><td class="line">745</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">746</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">747</td><td class="hits">0</td><td class="source">                    notebook.save(function(err, saved){</td></tr><tr><td class="line">748</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">749</td><td class="hits">0</td><td class="source">                        if(err) return next(err);</td></tr><tr><td class="line">750</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">751</td><td class="hits">0</td><td class="source">                        saved = Notebook.prepareForOutput(saved, req.user);</td></tr><tr><td class="line">752</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">753</td><td class="hits">0</td><td class="source">                        saved.newUser = User.prepareForOutput(invitedUser);</td></tr><tr class="miss"><td class="line">754</td><td class="hits">0</td><td class="source">                        saved.newUser.role = req.params.role;</td></tr><tr class="miss"><td class="line">755</td><td class="hits">0</td><td class="source">                        return res.send(saved);</td></tr><tr><td class="line">756</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">757</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">758</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">759</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">760</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">761</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">762</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">763</td><td class="hits">1</td><td class="source">    var _analyticsInvite = function(req, res, next) {</td></tr><tr class="miss"><td class="line">764</td><td class="hits">0</td><td class="source">        var user = req.user;</td></tr><tr><td class="line">765</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">766</td><td class="hits">0</td><td class="source">        if(!req.params.email) return next(new restifyErrors.InvalidInputError(&quot;A valid email address is required.&quot;));</td></tr><tr><td class="line">767</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">768</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">769</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">770</td><td class="hits"></td><td class="source">                _id: req.params.id,</td></tr><tr><td class="line">771</td><td class="hits"></td><td class="source">                &quot;users.user&quot;: req.user._id</td></tr><tr><td class="line">772</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">773</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">774</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">775</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">776</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">777</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">778</td><td class="hits">0</td><td class="source">                if(notebook.getPermissions(req.user).indexOf(&quot;connect_analytics_invite&quot;) &lt; 0) return next(new restify.NotAuthorizedError(&quot;You don't have permission to do that.&quot;));</td></tr><tr><td class="line">779</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">780</td><td class="hits">0</td><td class="source">                if(notebook.getPermissions(req.user).indexOf(&quot;invite_users&quot;) &lt; 0 &amp;&amp; req.user.permissions.indexOf(&quot;edit_notebook_on_account&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">781</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to invite people to this notebook&quot;));</td></tr><tr><td class="line">782</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">783</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">784</td><td class="hits">0</td><td class="source">                req.params.role = &quot;viewer&quot;;</td></tr><tr><td class="line">785</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">786</td><td class="hits">0</td><td class="source">                notebook.inviteUser(req.params, function(err, invitedUser, isNew){</td></tr><tr><td class="line">787</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">788</td><td class="hits">0</td><td class="source">                    if(err &amp;&amp; err.errors) {</td></tr><tr class="miss"><td class="line">789</td><td class="hits">0</td><td class="source">                        return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">790</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">791</td><td class="hits">0</td><td class="source">                    else if(err) return next(err);</td></tr><tr><td class="line">792</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">793</td><td class="hits">0</td><td class="source">                    var from = (isNew) ? Settings.email.from_unsolicited : Settings.email.from;</td></tr><tr><td class="line">794</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">795</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">796</td><td class="hits">0</td><td class="source">                    var email = new Email.Model({</td></tr><tr><td class="line">797</td><td class="hits"></td><td class="source">                        to: invitedUser.email,</td></tr><tr><td class="line">798</td><td class="hits"></td><td class="source">                        from: from,</td></tr><tr><td class="line">799</td><td class="hits"></td><td class="source">                        subject: req.user.name + &quot; invited you to connect Google Analytics to &quot; + notebook.name + &quot; on Primeloop&quot;,</td></tr><tr><td class="line">800</td><td class="hits"></td><td class="source">                        template: {</td></tr><tr><td class="line">801</td><td class="hits"></td><td class="source">                            name: (!invitedUser.enabled) ? &quot;notebook_analytics_invite_new_user.mu&quot; : &quot;notebook_analytics_invite.mu&quot;,</td></tr><tr><td class="line">802</td><td class="hits"></td><td class="source">                            contentType: &quot;html&quot;,</td></tr><tr><td class="line">803</td><td class="hits"></td><td class="source">                            data: {</td></tr><tr><td class="line">804</td><td class="hits"></td><td class="source">                                invitee: invitedUser,</td></tr><tr><td class="line">805</td><td class="hits"></td><td class="source">                                notebook: notebook,</td></tr><tr><td class="line">806</td><td class="hits"></td><td class="source">                                user: req.user</td></tr><tr><td class="line">807</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">808</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">809</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">810</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">811</td><td class="hits">0</td><td class="source">                    email.send(function(err, result){</td></tr><tr class="miss"><td class="line">812</td><td class="hits">0</td><td class="source">                        if(err) console.log(&quot;Error sending notebook invite email:&quot;, err);</td></tr><tr><td class="line">813</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">814</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">815</td><td class="hits">0</td><td class="source">                    notebook.google_analytics.invites = notebook.google_analytics.invites.concat([invitedUser._id]);</td></tr><tr class="miss"><td class="line">816</td><td class="hits">0</td><td class="source">                    notebook.markModified(&quot;google_analytics&quot;);</td></tr><tr><td class="line">817</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">818</td><td class="hits">0</td><td class="source">                    notebook.save(function(err, saved){</td></tr><tr><td class="line">819</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">820</td><td class="hits">0</td><td class="source">                        if(err) return next(err);</td></tr><tr><td class="line">821</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">822</td><td class="hits">0</td><td class="source">                        saved = Notebook.prepareForOutput(saved, req.user);</td></tr><tr><td class="line">823</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">824</td><td class="hits">0</td><td class="source">                        saved.newUser = User.prepareForOutput(invitedUser);</td></tr><tr class="miss"><td class="line">825</td><td class="hits">0</td><td class="source">                        saved.newUser.role = req.params.role;</td></tr><tr class="miss"><td class="line">826</td><td class="hits">0</td><td class="source">                        return res.send(saved);</td></tr><tr><td class="line">827</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">828</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">829</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">830</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">831</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">832</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">833</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">834</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">835</td><td class="hits">1</td><td class="source">    var _archive = function(req, res, next) {</td></tr><tr class="miss"><td class="line">836</td><td class="hits">0</td><td class="source">        var query = {</td></tr><tr><td class="line">837</td><td class="hits"></td><td class="source">            _id: req.params.id,</td></tr><tr><td class="line">838</td><td class="hits"></td><td class="source">            &quot;users.user&quot;: req.user._id</td></tr><tr><td class="line">839</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">840</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">841</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;edit_notebook_on_account&quot;) &gt;= 0) {</td></tr><tr class="miss"><td class="line">842</td><td class="hits">0</td><td class="source">            delete query[&quot;users.user&quot;];</td></tr><tr><td class="line">843</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">844</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">845</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">846</td><td class="hits"></td><td class="source">            .findOne(query)</td></tr><tr><td class="line">847</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">848</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">849</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">850</td><td class="hits">0</td><td class="source">                if(!notebook) {</td></tr><tr class="miss"><td class="line">851</td><td class="hits">0</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">852</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">853</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">854</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">855</td><td class="hits">0</td><td class="source">                if(notebook.getPermissions(req.user).indexOf(&quot;delete_notebook&quot;) &lt; 0 &amp;&amp; req.user.permissions.indexOf(&quot;edit_notebook_on_account&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">856</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to delete this notebook&quot;));</td></tr><tr><td class="line">857</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">858</td><td class="hits">0</td><td class="source">                Notebook.Archive.add(notebook, function(err, result){</td></tr><tr class="miss"><td class="line">859</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">860</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">861</td><td class="hits">0</td><td class="source">                    return res.send({</td></tr><tr><td class="line">862</td><td class="hits"></td><td class="source">                        code: 200,</td></tr><tr><td class="line">863</td><td class="hits"></td><td class="source">                        status: &quot;archived&quot;,</td></tr><tr><td class="line">864</td><td class="hits"></td><td class="source">                        message: &quot;Your notebook has been archived&quot;</td></tr><tr><td class="line">865</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">866</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">867</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">868</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">869</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">870</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">871</td><td class="hits">1</td><td class="source">    var _unarchive = function(req, res, next) {</td></tr><tr><td class="line">872</td><td class="hits"></td><td class="source">        /*</td></tr><tr><td class="line">873</td><td class="hits"></td><td class="source">            TODO: (N) Notebook Unarchive</td></tr><tr><td class="line">874</td><td class="hits"></td><td class="source">            1. move archived notebook back to notebooks</td></tr><tr><td class="line">875</td><td class="hits"></td><td class="source">            2. run clipp.unarchive on all clipps</td></tr><tr><td class="line">876</td><td class="hits"></td><td class="source">         */</td></tr><tr><td class="line">877</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">878</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">879</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">880</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">881</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">882</td><td class="hits"></td><td class="source">    /*</td></tr><tr><td class="line">883</td><td class="hits"></td><td class="source">        TODO:</td></tr><tr><td class="line">884</td><td class="hits"></td><td class="source">            1. check permissions vs. role to see if the person can remove the other person</td></tr><tr><td class="line">885</td><td class="hits"></td><td class="source">            2. Notify the user that they have been removed (if it's not a demo notebook and if they didn't take the action)</td></tr><tr><td class="line">886</td><td class="hits"></td><td class="source">     */</td></tr><tr class="hit"><td class="line">887</td><td class="hits">1</td><td class="source">    var _removeUser = function(req, res, next) {</td></tr><tr class="miss"><td class="line">888</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">889</td><td class="hits"></td><td class="source">            user_id = req.params.id || req.user._id;</td></tr><tr><td class="line">890</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">891</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">892</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">893</td><td class="hits"></td><td class="source">                _id: req.params.notebook</td></tr><tr><td class="line">894</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">895</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">896</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr class="miss"><td class="line">897</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">898</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">899</td><td class="hits">0</td><td class="source">                var</td></tr><tr><td class="line">900</td><td class="hits"></td><td class="source">                    idx = ArrayUtils.inArray(user_id, notebook.users, &quot;user&quot;);</td></tr><tr><td class="line">901</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">902</td><td class="hits">0</td><td class="source">                if(idx &lt; 0) return next(new restifyErrors.InvalidInputError(&quot;You've already been removed from this notebook&quot;));</td></tr><tr class="miss"><td class="line">903</td><td class="hits">0</td><td class="source">                if(user_id != req.user._id &amp;&amp; notebook.demo ===  false){</td></tr><tr class="miss"><td class="line">904</td><td class="hits">0</td><td class="source">                    var</td></tr><tr><td class="line">905</td><td class="hits"></td><td class="source">                        role = notebook.users[idx].role;</td></tr><tr><td class="line">906</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">907</td><td class="hits">0</td><td class="source">                    if(role == &quot;owner&quot;) return next(new restifyErrors.InvalidInputError(&quot;You cannot remove the owner of this notebook.&quot;));</td></tr><tr class="miss"><td class="line">908</td><td class="hits">0</td><td class="source">                    if(role == &quot;editor&quot; &amp;&amp; notebook.getPermissions(req.user).indexOf(&quot;edit_editors&quot;) &lt; 0) return next(new restify.NotAuthorizedError(&quot;You don't have permission to edit this person&quot;));</td></tr><tr class="miss"><td class="line">909</td><td class="hits">0</td><td class="source">                    if(role == &quot;contributor&quot; &amp;&amp; notebook.getPermissions(req.user).indexOf(&quot;edit_contributors&quot;) &lt; 0) return next(new restify.NotAuthorizedError(&quot;You don't have permission to edit this person&quot;));</td></tr><tr class="miss"><td class="line">910</td><td class="hits">0</td><td class="source">                    if(role == &quot;viewer&quot; &amp;&amp; notebook.getPermissions(req.user).indexOf(&quot;edit_viewers&quot;) &lt; 0) return next(new restify.NotAuthorizedError(&quot;You don't have permission to edit this person&quot;));</td></tr><tr><td class="line">911</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">912</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">913</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">914</td><td class="hits">0</td><td class="source">                notebook.removeUser(user_id, function(err, saved){</td></tr><tr class="miss"><td class="line">915</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">916</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">917</td><td class="hits">0</td><td class="source">                    if(user_id != req.user._id) {</td></tr><tr><td class="line">918</td><td class="hits"></td><td class="source">                        //send email to user, if they're enabled</td></tr><tr class="miss"><td class="line">919</td><td class="hits">0</td><td class="source">                        User.Model</td></tr><tr><td class="line">920</td><td class="hits"></td><td class="source">                            .findOne({</td></tr><tr><td class="line">921</td><td class="hits"></td><td class="source">                                _id: user_id,</td></tr><tr><td class="line">922</td><td class="hits"></td><td class="source">                                enabled: true</td></tr><tr><td class="line">923</td><td class="hits"></td><td class="source">                            }, &quot;email name&quot;)</td></tr><tr><td class="line">924</td><td class="hits"></td><td class="source">                            .lean()</td></tr><tr><td class="line">925</td><td class="hits"></td><td class="source">                            .exec(function(err, user){</td></tr><tr class="miss"><td class="line">926</td><td class="hits">0</td><td class="source">                                if(err) return console.log(&quot;Error emailing user:&quot;, err.stack || err);</td></tr><tr class="miss"><td class="line">927</td><td class="hits">0</td><td class="source">                                if(!user) return;</td></tr><tr><td class="line">928</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">929</td><td class="hits">0</td><td class="source">                                var email = new Email.Model({</td></tr><tr><td class="line">930</td><td class="hits"></td><td class="source">                                    to: user.email,</td></tr><tr><td class="line">931</td><td class="hits"></td><td class="source">                                    subject: &quot;You've been removed from &quot; + saved.name,</td></tr><tr><td class="line">932</td><td class="hits"></td><td class="source">                                    template: {</td></tr><tr><td class="line">933</td><td class="hits"></td><td class="source">                                        name: &quot;removed_from_notebook.mu&quot;,</td></tr><tr><td class="line">934</td><td class="hits"></td><td class="source">                                        contentType: &quot;text&quot;,</td></tr><tr><td class="line">935</td><td class="hits"></td><td class="source">                                        data: {</td></tr><tr><td class="line">936</td><td class="hits"></td><td class="source">                                            user: user,</td></tr><tr><td class="line">937</td><td class="hits"></td><td class="source">                                            notebook: notebook</td></tr><tr><td class="line">938</td><td class="hits"></td><td class="source">                                        }</td></tr><tr><td class="line">939</td><td class="hits"></td><td class="source">                                    }</td></tr><tr><td class="line">940</td><td class="hits"></td><td class="source">                                });</td></tr><tr><td class="line">941</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">942</td><td class="hits">0</td><td class="source">                                email.send(function(err){</td></tr><tr class="miss"><td class="line">943</td><td class="hits">0</td><td class="source">                                    if(err) return console.log(&quot;Error email user:&quot;, err.stack || err);</td></tr><tr><td class="line">944</td><td class="hits"></td><td class="source">                                });</td></tr><tr><td class="line">945</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">946</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">947</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">948</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">949</td><td class="hits">0</td><td class="source">                    next();</td></tr><tr class="miss"><td class="line">950</td><td class="hits">0</td><td class="source">                    return res.send({</td></tr><tr><td class="line">951</td><td class="hits"></td><td class="source">                        _id: saved._id,</td></tr><tr><td class="line">952</td><td class="hits"></td><td class="source">                        status: &quot;success&quot;,</td></tr><tr><td class="line">953</td><td class="hits"></td><td class="source">                        message: &quot;You've been removed from the &quot; + saved.name + &quot; notebook.&quot;</td></tr><tr><td class="line">954</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">955</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">956</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">957</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">958</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">959</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">960</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">961</td><td class="hits">1</td><td class="source">    var _updateUser = function(req, res, next) {</td></tr><tr class="miss"><td class="line">962</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">963</td><td class="hits"></td><td class="source">            user_id = req.params.id || req.user._id,</td></tr><tr><td class="line">964</td><td class="hits"></td><td class="source">            role = req.params.role;</td></tr><tr><td class="line">965</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">966</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">967</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">968</td><td class="hits"></td><td class="source">                _id: req.params.notebook</td></tr><tr><td class="line">969</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">970</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">971</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr class="miss"><td class="line">972</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">973</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">974</td><td class="hits">0</td><td class="source">                var</td></tr><tr><td class="line">975</td><td class="hits"></td><td class="source">                    idx = ArrayUtils.inArray(user_id, notebook.users, &quot;user&quot;);</td></tr><tr><td class="line">976</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">977</td><td class="hits">0</td><td class="source">                if(idx &lt; 0) return next(new restifyErrors.InvalidInputError(&quot;This person is no longer in the notebook&quot;));</td></tr><tr><td class="line">978</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">979</td><td class="hits">0</td><td class="source">                var</td></tr><tr><td class="line">980</td><td class="hits"></td><td class="source">                    current_role = notebook.users[idx].role;</td></tr><tr><td class="line">981</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">982</td><td class="hits">0</td><td class="source">                if(current_role == &quot;owner&quot;) return next(new restifyErrors.InvalidInputError(&quot;You cannot edit the owner's role&quot;));</td></tr><tr class="miss"><td class="line">983</td><td class="hits">0</td><td class="source">                if(current_role == &quot;editor&quot; &amp;&amp; notebook.getPermissions(req.user).indexOf(&quot;edit_editors&quot;) &lt; 0) return next(new restify.NotAuthorizedError(&quot;You don't have permission to edit this person&quot;));</td></tr><tr class="miss"><td class="line">984</td><td class="hits">0</td><td class="source">                if(current_role == &quot;contributor&quot; &amp;&amp; notebook.getPermissions(req.user).indexOf(&quot;edit_contributors&quot;) &lt; 0) return next(new restify.NotAuthorizedError(&quot;You don't have permission to edit this person&quot;));</td></tr><tr class="miss"><td class="line">985</td><td class="hits">0</td><td class="source">                if(current_role == &quot;viewer&quot; &amp;&amp; notebook.getPermissions(req.user).indexOf(&quot;edit_viewers&quot;) &lt; 0) return next(new restify.NotAuthorizedError(&quot;You don't have permission to edit this person&quot;));</td></tr><tr><td class="line">986</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">987</td><td class="hits">0</td><td class="source">                notebook.users[idx].role = role;</td></tr><tr class="miss"><td class="line">988</td><td class="hits">0</td><td class="source">                notebook.markModified(&quot;users&quot;);</td></tr><tr><td class="line">989</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">990</td><td class="hits">0</td><td class="source">                notebook.save(function(err, saved){</td></tr><tr class="miss"><td class="line">991</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr class="miss"><td class="line">992</td><td class="hits">0</td><td class="source">                    next();</td></tr><tr class="miss"><td class="line">993</td><td class="hits">0</td><td class="source">                    return res.send({</td></tr><tr><td class="line">994</td><td class="hits"></td><td class="source">                        _id: saved._id,</td></tr><tr><td class="line">995</td><td class="hits"></td><td class="source">                        status: &quot;success&quot;,</td></tr><tr><td class="line">996</td><td class="hits"></td><td class="source">                        message: &quot;Role has been updated to &quot; + role</td></tr><tr><td class="line">997</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">998</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">999</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1000</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1001</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1002</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1003</td><td class="hits">1</td><td class="source">    var _expiredTrialList = function(req, res, next) {</td></tr><tr class="miss"><td class="line">1004</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">1005</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permisison to view another user's notebooks&quot;));</td></tr><tr><td class="line">1006</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">1007</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1008</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">1009</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">1010</td><td class="hits"></td><td class="source">                trial: {$exists:true},</td></tr><tr><td class="line">1011</td><td class="hits"></td><td class="source">                trialStart: {$exists:true},</td></tr><tr><td class="line">1012</td><td class="hits"></td><td class="source">                type: {$ne: &quot;free&quot;},</td></tr><tr><td class="line">1013</td><td class="hits"></td><td class="source">                $where: function() {</td></tr><tr class="miss"><td class="line">1014</td><td class="hits">0</td><td class="source">                    var days = (Date.now() - new Date(this.trialStart).getTime()) / (1000*60*60*24);</td></tr><tr class="miss"><td class="line">1015</td><td class="hits">0</td><td class="source">                    if (this.trial - days &gt;= 0) {</td></tr><tr class="miss"><td class="line">1016</td><td class="hits">0</td><td class="source">                        return false;</td></tr><tr><td class="line">1017</td><td class="hits"></td><td class="source">                    } else {</td></tr><tr class="miss"><td class="line">1018</td><td class="hits">0</td><td class="source">                        return true;</td></tr><tr><td class="line">1019</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">1020</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">1021</td><td class="hits"></td><td class="source">            }, &quot;name trial trialStart created users clipps&quot;)</td></tr><tr><td class="line">1022</td><td class="hits"></td><td class="source">            .sort({trialStart:1})</td></tr><tr><td class="line">1023</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">1024</td><td class="hits"></td><td class="source">            .exec(function(err, notebooks){</td></tr><tr class="miss"><td class="line">1025</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr class="miss"><td class="line">1026</td><td class="hits">0</td><td class="source">                return res.send(notebooks);</td></tr><tr><td class="line">1027</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1028</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1029</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1030</td><td class="hits">1</td><td class="source">    var _convertNotebookToFree = function(req, res, next){</td></tr><tr class="miss"><td class="line">1031</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">1032</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permisison to view another user's notebooks&quot;));</td></tr><tr><td class="line">1033</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">1034</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">1035</td><td class="hits"></td><td class="source">            id = req.params.id,</td></tr><tr><td class="line">1036</td><td class="hits"></td><td class="source">            customerWasCanceled = false;</td></tr><tr><td class="line">1037</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1038</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">1039</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">1040</td><td class="hits"></td><td class="source">                _id: id</td></tr><tr><td class="line">1041</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">1042</td><td class="hits"></td><td class="source">            .populate(&quot;users.user&quot;)</td></tr><tr><td class="line">1043</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">1044</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">1045</td><td class="hits"></td><td class="source">                //grab the owner first</td></tr><tr class="miss"><td class="line">1046</td><td class="hits">0</td><td class="source">                var owner = null;</td></tr><tr class="miss"><td class="line">1047</td><td class="hits">0</td><td class="source">                for(var i = 0; i &lt; notebook.users.length; i++) {</td></tr><tr class="miss"><td class="line">1048</td><td class="hits">0</td><td class="source">                    var user = notebook.users[i];</td></tr><tr class="miss"><td class="line">1049</td><td class="hits">0</td><td class="source">                    if(user.role === &quot;owner&quot;) {</td></tr><tr class="miss"><td class="line">1050</td><td class="hits">0</td><td class="source">                        owner = user.user;</td></tr><tr><td class="line">1051</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">1052</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">1053</td><td class="hits">0</td><td class="source">                if(owner) {</td></tr><tr class="miss"><td class="line">1054</td><td class="hits">0</td><td class="source">                    Payment.getCustomer(owner, function(err, stripeCustomer) {</td></tr><tr class="miss"><td class="line">1055</td><td class="hits">0</td><td class="source">                        if (err || typeof stripeCustomer === 'undefined' || typeof stripeCustomer.subscription === 'undefined') {</td></tr><tr class="miss"><td class="line">1056</td><td class="hits">0</td><td class="source">                            console.log(&quot;Error retrieving customer: &quot;, err);</td></tr><tr class="miss"><td class="line">1057</td><td class="hits">0</td><td class="source">                            return next(new restify.ResourceNotFoundError(&quot;Customer resource for payment not found for user.&quot;));</td></tr><tr><td class="line">1058</td><td class="hits"></td><td class="source">                        }</td></tr><tr class="miss"><td class="line">1059</td><td class="hits">0</td><td class="source">                        User.Model</td></tr><tr><td class="line">1060</td><td class="hits"></td><td class="source">                            .findOne({</td></tr><tr><td class="line">1061</td><td class="hits"></td><td class="source">                                _id: owner</td></tr><tr><td class="line">1062</td><td class="hits"></td><td class="source">                            })</td></tr><tr><td class="line">1063</td><td class="hits"></td><td class="source">                            .exec(function(err, nbuser){</td></tr><tr class="miss"><td class="line">1064</td><td class="hits">0</td><td class="source">                                if(err) next(err);</td></tr><tr class="miss"><td class="line">1065</td><td class="hits">0</td><td class="source">                                notebook.type = &quot;free&quot;;</td></tr><tr><td class="line">1066</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1067</td><td class="hits">0</td><td class="source">                                if (stripeCustomer.subscription.status == &quot;canceled&quot;) {</td></tr><tr class="miss"><td class="line">1068</td><td class="hits">0</td><td class="source">                                    nbuser.customer = stripeCustomer;</td></tr><tr class="miss"><td class="line">1069</td><td class="hits">0</td><td class="source">                                    customerWasCanceled = true;</td></tr><tr><td class="line">1070</td><td class="hits"></td><td class="source">                                }</td></tr><tr><td class="line">1071</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1072</td><td class="hits">0</td><td class="source">                                notebook.save(function(err, savednb){</td></tr><tr class="miss"><td class="line">1073</td><td class="hits">0</td><td class="source">                                    if(err) console.log(err.stack || err);</td></tr><tr class="miss"><td class="line">1074</td><td class="hits">0</td><td class="source">                                    console.log(&quot;updated notebook &quot; + notebook.name + &quot; and clipps to free&quot;);</td></tr><tr class="miss"><td class="line">1075</td><td class="hits">0</td><td class="source">                                    if(nbuser.customer &amp;&amp; nbuser.customer.subscription &amp;&amp; nbuser.customer.subscription.plan &amp;&amp; !customerWasCanceled) {</td></tr><tr class="miss"><td class="line">1076</td><td class="hits">0</td><td class="source">                                        Payment.decreaseSubscription(nbuser.customer, nbuser.customer.subscription.plan.id, -1, function(err, subscription){</td></tr><tr class="miss"><td class="line">1077</td><td class="hits">0</td><td class="source">                                            if(err) return next(err);</td></tr><tr class="miss"><td class="line">1078</td><td class="hits">0</td><td class="source">                                            var customer = nbuser.customer;</td></tr><tr class="miss"><td class="line">1079</td><td class="hits">0</td><td class="source">                                            customer.subscription = subscription;</td></tr><tr><td class="line">1080</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1081</td><td class="hits">0</td><td class="source">                                            nbuser.customer = customer;</td></tr><tr><td class="line">1082</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1083</td><td class="hits">0</td><td class="source">                                            nbuser.save(function(err, saved){</td></tr><tr class="miss"><td class="line">1084</td><td class="hits">0</td><td class="source">                                                if(err) return next(err);</td></tr><tr class="miss"><td class="line">1085</td><td class="hits">0</td><td class="source">                                                return res.send(savednb);</td></tr><tr><td class="line">1086</td><td class="hits"></td><td class="source">                                            });</td></tr><tr><td class="line">1087</td><td class="hits"></td><td class="source">                                        });</td></tr><tr><td class="line">1088</td><td class="hits"></td><td class="source">                                    } else {</td></tr><tr class="miss"><td class="line">1089</td><td class="hits">0</td><td class="source">                                        return res.send(savednb);</td></tr><tr><td class="line">1090</td><td class="hits"></td><td class="source">                                    }</td></tr><tr><td class="line">1091</td><td class="hits"></td><td class="source">                                });</td></tr><tr><td class="line">1092</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">1093</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">1094</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">1095</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1096</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1097</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1098</td><td class="hits">1</td><td class="source">    var _gaNotebookList = function(req, res, next) {</td></tr><tr class="miss"><td class="line">1099</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">1100</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permisison to view another user's notebooks&quot;));</td></tr><tr><td class="line">1101</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">1102</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1103</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">1104</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">1105</td><td class="hits"></td><td class="source">                $and:[</td></tr><tr><td class="line">1106</td><td class="hits"></td><td class="source">                    {&quot;google_analytics.accountId&quot;: {$exists: true}},</td></tr><tr><td class="line">1107</td><td class="hits"></td><td class="source">                    {&quot;google_analytics.accountId&quot;: {$ne: null}}</td></tr><tr><td class="line">1108</td><td class="hits"></td><td class="source">                ]</td></tr><tr><td class="line">1109</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">1110</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">1111</td><td class="hits"></td><td class="source">            .populate(&quot;users.user&quot;)</td></tr><tr><td class="line">1112</td><td class="hits"></td><td class="source">            .exec(function(err, notebooks){</td></tr><tr class="miss"><td class="line">1113</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr class="miss"><td class="line">1114</td><td class="hits">0</td><td class="source">                return res.send(notebooks);</td></tr><tr><td class="line">1115</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1116</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1117</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1118</td><td class="hits">1</td><td class="source">    var _suggestedActionNotebookList = function(req, res, next) {</td></tr><tr class="miss"><td class="line">1119</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">1120</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permisison to view another user's notebooks&quot;));</td></tr><tr><td class="line">1121</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">1122</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1123</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">1124</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">1125</td><td class="hits"></td><td class="source">                features: &quot;suggested_actions&quot;</td></tr><tr><td class="line">1126</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">1127</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">1128</td><td class="hits"></td><td class="source">            .sort({&quot;name&quot;:1})</td></tr><tr><td class="line">1129</td><td class="hits"></td><td class="source">            .populate(&quot;users.user&quot;)</td></tr><tr><td class="line">1130</td><td class="hits"></td><td class="source">            .exec(function(err, notebooks){</td></tr><tr class="miss"><td class="line">1131</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr class="miss"><td class="line">1132</td><td class="hits">0</td><td class="source">                return res.send(notebooks);</td></tr><tr><td class="line">1133</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1134</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1135</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1136</td><td class="hits">1</td><td class="source">    var _allNotebooks = function(req, res, next) {</td></tr><tr class="miss"><td class="line">1137</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">1138</td><td class="hits"></td><td class="source">            page = parseInt(req.params.page || 1, 10),</td></tr><tr><td class="line">1139</td><td class="hits"></td><td class="source">            per_page = parseInt(req.params.per_page || PER_PAGE, 10);</td></tr><tr><td class="line">1140</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1141</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">1142</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permisison to view another user's notebooks&quot;));</td></tr><tr><td class="line">1143</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">1144</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1145</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">1146</td><td class="hits"></td><td class="source">            .find()</td></tr><tr><td class="line">1147</td><td class="hits"></td><td class="source">            .populate(&quot;users.user&quot;, &quot;name email&quot;)</td></tr><tr><td class="line">1148</td><td class="hits"></td><td class="source">            .sort({&quot;name&quot;:1})</td></tr><tr><td class="line">1149</td><td class="hits"></td><td class="source">            .limit(per_page)</td></tr><tr><td class="line">1150</td><td class="hits"></td><td class="source">            .skip((page-1)*per_page)</td></tr><tr><td class="line">1151</td><td class="hits"></td><td class="source">            .exec(function(err, notebooks){</td></tr><tr class="miss"><td class="line">1152</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr class="miss"><td class="line">1153</td><td class="hits">0</td><td class="source">                notebooks = Notebook.prepareMultipleForOutput(notebooks, req.user);</td></tr><tr class="miss"><td class="line">1154</td><td class="hits">0</td><td class="source">                return res.send({</td></tr><tr><td class="line">1155</td><td class="hits"></td><td class="source">                    notebooks: notebooks || [],</td></tr><tr><td class="line">1156</td><td class="hits"></td><td class="source">                    per_page: per_page,</td></tr><tr><td class="line">1157</td><td class="hits"></td><td class="source">                    page: page</td></tr><tr><td class="line">1158</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">1159</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1160</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1161</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1162</td><td class="hits">1</td><td class="source">    var _adminNotebookView = function(req, res, next) {</td></tr><tr class="miss"><td class="line">1163</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">1164</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permisison to view another user's notebooks&quot;));</td></tr><tr><td class="line">1165</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">1166</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">1167</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">1168</td><td class="hits"></td><td class="source">                _id: req.params.id</td></tr><tr><td class="line">1169</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">1170</td><td class="hits"></td><td class="source">            .populate(&quot;users.user&quot;, &quot;name email&quot;)</td></tr><tr><td class="line">1171</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">1172</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">1173</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1174</td><td class="hits">0</td><td class="source">                if(!notebook) {</td></tr><tr class="miss"><td class="line">1175</td><td class="hits">0</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;Notebook does not exist&quot;));</td></tr><tr><td class="line">1176</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">1177</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1178</td><td class="hits"></td><td class="source">                //notebook = Notebook.prepareForOutput(notebook, req.user);</td></tr><tr class="miss"><td class="line">1179</td><td class="hits">0</td><td class="source">                return res.send(notebook);</td></tr><tr><td class="line">1180</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1181</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1182</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1183</td><td class="hits">1</td><td class="source">    var _addFeature = function(req, res, next) {</td></tr><tr class="miss"><td class="line">1184</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">1185</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permisison to view another user's notebooks&quot;));</td></tr><tr><td class="line">1186</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">1187</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">1188</td><td class="hits"></td><td class="source">            id = req.params.id,</td></tr><tr><td class="line">1189</td><td class="hits"></td><td class="source">            feature = req.params.feature,</td></tr><tr><td class="line">1190</td><td class="hits"></td><td class="source">            adminNotes = req.params.admin_notes;</td></tr><tr><td class="line">1191</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1192</td><td class="hits"></td><td class="source">        // console.log(&quot;admin notes: %j&quot;, adminNotes);</td></tr><tr class="miss"><td class="line">1193</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">1194</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">1195</td><td class="hits"></td><td class="source">                _id: id</td></tr><tr><td class="line">1196</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">1197</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">1198</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">1199</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1200</td><td class="hits">0</td><td class="source">                if(!notebook){</td></tr><tr class="miss"><td class="line">1201</td><td class="hits">0</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">1202</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">1203</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1204</td><td class="hits"></td><td class="source">                //check to see if this feature is already there</td></tr><tr class="miss"><td class="line">1205</td><td class="hits">0</td><td class="source">                var features = notebook.features;</td></tr><tr class="miss"><td class="line">1206</td><td class="hits">0</td><td class="source">                var modified = false;</td></tr><tr class="miss"><td class="line">1207</td><td class="hits">0</td><td class="source">                if(features.indexOf(feature) &lt; 0 ) {</td></tr><tr><td class="line">1208</td><td class="hits"></td><td class="source">                    //add it</td></tr><tr class="miss"><td class="line">1209</td><td class="hits">0</td><td class="source">                    features.push(feature);</td></tr><tr class="miss"><td class="line">1210</td><td class="hits">0</td><td class="source">                    notebook.markModified(&quot;features&quot;);</td></tr><tr class="miss"><td class="line">1211</td><td class="hits">0</td><td class="source">                    if(adminNotes) {</td></tr><tr class="miss"><td class="line">1212</td><td class="hits">0</td><td class="source">                        notebook.admin.notes = adminNotes;</td></tr><tr class="miss"><td class="line">1213</td><td class="hits">0</td><td class="source">                        notebook.markModified(&quot;admin.notes&quot;);</td></tr><tr><td class="line">1214</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">1215</td><td class="hits">0</td><td class="source">                    modified = true;</td></tr><tr class="miss"><td class="line">1216</td><td class="hits">0</td><td class="source">                } else if(adminNotes) {</td></tr><tr><td class="line">1217</td><td class="hits"></td><td class="source">                    //Just update the admin notes if that exists</td></tr><tr class="miss"><td class="line">1218</td><td class="hits">0</td><td class="source">                    notebook.admin.notes = adminNotes;</td></tr><tr class="miss"><td class="line">1219</td><td class="hits">0</td><td class="source">                    notebook.markModified(&quot;admin.notes&quot;);</td></tr><tr class="miss"><td class="line">1220</td><td class="hits">0</td><td class="source">                    modified = true;</td></tr><tr><td class="line">1221</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">1222</td><td class="hits">0</td><td class="source">                if(modified) {</td></tr><tr class="miss"><td class="line">1223</td><td class="hits">0</td><td class="source">                    notebook.save(function(err, saved){</td></tr><tr class="miss"><td class="line">1224</td><td class="hits">0</td><td class="source">                        if(err) return next(err);</td></tr><tr><td class="line">1225</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1226</td><td class="hits">0</td><td class="source">                        saved.setFeatureSettingsForUsers(feature, function(err){</td></tr><tr class="miss"><td class="line">1227</td><td class="hits">0</td><td class="source">                            if(err) console.log(err.stack || err);</td></tr><tr><td class="line">1228</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">1229</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1230</td><td class="hits">0</td><td class="source">                        return res.send(saved);</td></tr><tr><td class="line">1231</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">1232</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="miss"><td class="line">1233</td><td class="hits">0</td><td class="source">                    return res.send(&quot;Notebook already had that feature&quot;);</td></tr><tr><td class="line">1234</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">1235</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1236</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1237</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1238</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1239</td><td class="hits">1</td><td class="source">    var _notebooksForCAAS = function(req, res, next) {</td></tr><tr class="miss"><td class="line">1240</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">1241</td><td class="hits"></td><td class="source">            page = parseInt(req.params.page || 1, 10),</td></tr><tr><td class="line">1242</td><td class="hits"></td><td class="source">            per_page = parseInt(req.params.per_page || PER_PAGE, 10);</td></tr><tr><td class="line">1243</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1244</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1245</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;view_clipping_service&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">1246</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permisison to view this&quot;));</td></tr><tr><td class="line">1247</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">1248</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1249</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">1250</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">1251</td><td class="hits"></td><td class="source">                $or: [</td></tr><tr><td class="line">1252</td><td class="hits"></td><td class="source">                    {features: &quot;clipps_as_service&quot;},</td></tr><tr><td class="line">1253</td><td class="hits"></td><td class="source">                    {features: &quot;sugg_clipps_as_service&quot;}</td></tr><tr><td class="line">1254</td><td class="hits"></td><td class="source">                ]</td></tr><tr><td class="line">1255</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">1256</td><td class="hits"></td><td class="source">            .sort({&quot;name&quot;:1})</td></tr><tr><td class="line">1257</td><td class="hits"></td><td class="source">            .limit(per_page)</td></tr><tr><td class="line">1258</td><td class="hits"></td><td class="source">            .skip((page-1)*per_page)</td></tr><tr><td class="line">1259</td><td class="hits"></td><td class="source">            .exec(function(err, notebooks){</td></tr><tr class="miss"><td class="line">1260</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr class="miss"><td class="line">1261</td><td class="hits">0</td><td class="source">                notebooks = Notebook.prepareMultipleForOutput(notebooks, req.user);</td></tr><tr><td class="line">1262</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1263</td><td class="hits">0</td><td class="source">                return res.send({</td></tr><tr><td class="line">1264</td><td class="hits"></td><td class="source">                    notebooks: notebooks || [],</td></tr><tr><td class="line">1265</td><td class="hits"></td><td class="source">                    per_page: per_page,</td></tr><tr><td class="line">1266</td><td class="hits"></td><td class="source">                    page: page</td></tr><tr><td class="line">1267</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">1268</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1269</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1270</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1271</td><td class="hits">1</td><td class="source">    var _notebookForCAAS = function(req, res, next) {</td></tr><tr class="miss"><td class="line">1272</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">1273</td><td class="hits"></td><td class="source">            id = req.params.id;</td></tr><tr class="miss"><td class="line">1274</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;view_clipping_service&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">1275</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permisison to view this&quot;));</td></tr><tr><td class="line">1276</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">1277</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1278</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">1279</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">1280</td><td class="hits"></td><td class="source">                _id: id</td></tr><tr><td class="line">1281</td><td class="hits"></td><td class="source">            }, &quot;name features admin&quot;)</td></tr><tr><td class="line">1282</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">1283</td><td class="hits">0</td><td class="source">                if(err) next(err);</td></tr><tr class="miss"><td class="line">1284</td><td class="hits">0</td><td class="source">                return res.send(notebook);</td></tr><tr><td class="line">1285</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1286</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1287</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1288</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">1289</td><td class="hits"></td><td class="source">     * TODO: remove this when we're sure it's no longer needed</td></tr><tr><td class="line">1290</td><td class="hits"></td><td class="source">     */</td></tr><tr class="hit"><td class="line">1291</td><td class="hits">1</td><td class="source">    var _purchaseReporting = function(req, res, next) {</td></tr><tr><td class="line">1292</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1293</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1294</td><td class="hits"></td><td class="source">       // notebook.getPermissions(req.user).indexOf(&quot;can_purchase&quot;) &lt; 0</td></tr><tr><td class="line">1295</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1296</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1297</td><td class="hits">0</td><td class="source">        Notebook.Model.findOne({</td></tr><tr><td class="line">1298</td><td class="hits"></td><td class="source">            _id: req.params.notebook</td></tr><tr><td class="line">1299</td><td class="hits"></td><td class="source">        })</td></tr><tr><td class="line">1300</td><td class="hits"></td><td class="source">        .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">1301</td><td class="hits">0</td><td class="source">            if(err) return next(err);</td></tr><tr><td class="line">1302</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1303</td><td class="hits">0</td><td class="source">            if(notebook.getPermissions(req.user).indexOf(&quot;purchase_notebook&quot;) &lt; 0) return res.send(new restify.NotAuthorizedError(&quot;You don't haver permission to do that.&quot;));</td></tr><tr><td class="line">1304</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1305</td><td class="hits">0</td><td class="source">            notebook.canReport = true;</td></tr><tr><td class="line">1306</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1307</td><td class="hits">0</td><td class="source">            User.Model</td></tr><tr><td class="line">1308</td><td class="hits"></td><td class="source">                .findOne({</td></tr><tr><td class="line">1309</td><td class="hits"></td><td class="source">                    _id: req.user._id</td></tr><tr><td class="line">1310</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">1311</td><td class="hits"></td><td class="source">                .exec(function(err, user){</td></tr><tr class="miss"><td class="line">1312</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">1313</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1314</td><td class="hits">0</td><td class="source">                    if(!user) return next(new restify.ResourceNotFoundError(&quot;User not found&quot;));</td></tr><tr><td class="line">1315</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1316</td><td class="hits">0</td><td class="source">                    if(user.customer &amp;&amp; user.customer.subscription) { //Update the subscription for a current customer</td></tr><tr class="miss"><td class="line">1317</td><td class="hits">0</td><td class="source">                        return res.send({</td></tr><tr><td class="line">1318</td><td class="hits"></td><td class="source">                            code: 200,</td></tr><tr><td class="line">1319</td><td class="hits"></td><td class="source">                            status: &quot;success&quot;,</td></tr><tr><td class="line">1320</td><td class="hits"></td><td class="source">                            message: &quot;You've successfully added reporting to the &quot; + notebook.name + &quot; notebook.&quot;</td></tr><tr><td class="line">1321</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">1322</td><td class="hits"></td><td class="source">                        // Payment.increaseSubscription(user.customer, user.customer.subscription.plan.id, 1, null, function(err, subscription){</td></tr><tr><td class="line">1323</td><td class="hits"></td><td class="source">                        //     if(err) return next(err);</td></tr><tr><td class="line">1324</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1325</td><td class="hits"></td><td class="source">                        //     user.customer.subscription = subscription;</td></tr><tr><td class="line">1326</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1327</td><td class="hits"></td><td class="source">                        //     user.save();</td></tr><tr><td class="line">1328</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1329</td><td class="hits"></td><td class="source">                        //     notebook.save(function(err){</td></tr><tr><td class="line">1330</td><td class="hits"></td><td class="source">                        //         if(err) return next(err);</td></tr><tr><td class="line">1331</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1332</td><td class="hits"></td><td class="source">                        //         return res.send({</td></tr><tr><td class="line">1333</td><td class="hits"></td><td class="source">                        //             code: 200,</td></tr><tr><td class="line">1334</td><td class="hits"></td><td class="source">                        //             status: &quot;success&quot;,</td></tr><tr><td class="line">1335</td><td class="hits"></td><td class="source">                        //             message: &quot;You've successfully added reporting to the &quot; + notebook.name + &quot; notebook.&quot;</td></tr><tr><td class="line">1336</td><td class="hits"></td><td class="source">                        //         });</td></tr><tr><td class="line">1337</td><td class="hits"></td><td class="source">                        //     });</td></tr><tr><td class="line">1338</td><td class="hits"></td><td class="source">                        // });</td></tr><tr><td class="line">1339</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1340</td><td class="hits">0</td><td class="source">                    } else return next(new restify.ResourceNotFoundError(&quot;You do not own paid notebook to add reports to.&quot;));</td></tr><tr><td class="line">1341</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">1342</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">1343</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1344</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1345</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1346</td><td class="hits">1</td><td class="source">    var _requestAccess = function(req, res, next) {</td></tr><tr><td class="line">1347</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1348</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">1349</td><td class="hits"></td><td class="source">            name = req.params.name,</td></tr><tr><td class="line">1350</td><td class="hits"></td><td class="source">            emailAddress = req.params.email;</td></tr><tr><td class="line">1351</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1352</td><td class="hits">0</td><td class="source">        if(req.user){</td></tr><tr class="miss"><td class="line">1353</td><td class="hits">0</td><td class="source">            name = req.user.name || name;</td></tr><tr class="miss"><td class="line">1354</td><td class="hits">0</td><td class="source">            emailAddress = req.user.email || emailAddress;</td></tr><tr><td class="line">1355</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">1356</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1357</td><td class="hits">0</td><td class="source">        if(!name || !emailAddress) return next(new restifyErrors.InvalidInputError(&quot;Name and email address required.&quot;));</td></tr><tr><td class="line">1358</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1359</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">1360</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">1361</td><td class="hits"></td><td class="source">                _id: req.params.id</td></tr><tr><td class="line">1362</td><td class="hits"></td><td class="source">            }, &quot;name users&quot;)</td></tr><tr><td class="line">1363</td><td class="hits"></td><td class="source">            .populate(&quot;users.user&quot;, &quot;email name&quot;)</td></tr><tr><td class="line">1364</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">1365</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">1366</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">1367</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1368</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">1369</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1370</td><td class="hits">0</td><td class="source">                var owner;</td></tr><tr><td class="line">1371</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1372</td><td class="hits">0</td><td class="source">                notebook.users.map(function(user){</td></tr><tr class="miss"><td class="line">1373</td><td class="hits">0</td><td class="source">                    if(user.role == &quot;owner&quot;) owner = user.user;</td></tr><tr><td class="line">1374</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">1375</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1376</td><td class="hits">0</td><td class="source">                if(!owner) return next(new restify.ResourceNotFoundError(&quot;Owner not found.&quot;));</td></tr><tr><td class="line">1377</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1378</td><td class="hits">0</td><td class="source">                var email = new Email.Model({</td></tr><tr><td class="line">1379</td><td class="hits"></td><td class="source">                    to: owner.email,</td></tr><tr><td class="line">1380</td><td class="hits"></td><td class="source">                    subject: name + &quot; has requested access to &quot; + notebook.name,</td></tr><tr><td class="line">1381</td><td class="hits"></td><td class="source">                    bcc: Settings.email.from,</td></tr><tr><td class="line">1382</td><td class="hits"></td><td class="source">                    template: {</td></tr><tr><td class="line">1383</td><td class="hits"></td><td class="source">                        name: &quot;requested_notebook_access.mu&quot;,</td></tr><tr><td class="line">1384</td><td class="hits"></td><td class="source">                        contentType: &quot;html&quot;,</td></tr><tr><td class="line">1385</td><td class="hits"></td><td class="source">                        data: {</td></tr><tr><td class="line">1386</td><td class="hits"></td><td class="source">                            user: {</td></tr><tr><td class="line">1387</td><td class="hits"></td><td class="source">                                name: name,</td></tr><tr><td class="line">1388</td><td class="hits"></td><td class="source">                                email: emailAddress</td></tr><tr><td class="line">1389</td><td class="hits"></td><td class="source">                            },</td></tr><tr><td class="line">1390</td><td class="hits"></td><td class="source">                            owner: owner,</td></tr><tr><td class="line">1391</td><td class="hits"></td><td class="source">                            notebook: notebook</td></tr><tr><td class="line">1392</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">1393</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">1394</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">1395</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1396</td><td class="hits">0</td><td class="source">                email.send(function(err){</td></tr><tr class="miss"><td class="line">1397</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">1398</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1399</td><td class="hits">0</td><td class="source">                    return res.send({</td></tr><tr><td class="line">1400</td><td class="hits"></td><td class="source">                        status: &quot;success&quot;,</td></tr><tr><td class="line">1401</td><td class="hits"></td><td class="source">                        code: 200</td></tr><tr><td class="line">1402</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">1403</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">1404</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1405</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1406</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1407</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1408</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1409</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1410</td><td class="hits">1</td><td class="source">    var _additionToPlainText = function(addition){</td></tr><tr class="miss"><td class="line">1411</td><td class="hits">0</td><td class="source">        return SuggestedAction.getPlainText(addition.action);</td></tr><tr><td class="line">1412</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1413</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1414</td><td class="hits">1</td><td class="source">    var _getReportHighlights = function(req, res, next) {</td></tr><tr><td class="line">1415</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1416</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">1417</td><td class="hits"></td><td class="source">            highlights = [],</td></tr><tr><td class="line">1418</td><td class="hits"></td><td class="source">            reportDate = moment(req.params.month_range,&quot;YYYY-MM&quot;),</td></tr><tr><td class="line">1419</td><td class="hits"></td><td class="source">            start = moment(reportDate),</td></tr><tr><td class="line">1420</td><td class="hits"></td><td class="source">            end = reportDate.endOf('month');</td></tr><tr><td class="line">1421</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1422</td><td class="hits"></td><td class="source">        // console.log(&quot;monthRange&quot;, req.params.month_range, &quot;reportDate&quot;, reportDate.toString(), &quot;Start:&quot;, start.toString(), &quot;end:&quot;, end.toString());</td></tr><tr class="miss"><td class="line">1423</td><td class="hits">0</td><td class="source">        ReportAdditions.Model</td></tr><tr><td class="line">1424</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">1425</td><td class="hits"></td><td class="source">                notebook: req.params.id,</td></tr><tr><td class="line">1426</td><td class="hits"></td><td class="source">                created: { $gt: start, $lt: end }</td></tr><tr><td class="line">1427</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">1428</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">1429</td><td class="hits"></td><td class="source">            .exec(function(err, additions){</td></tr><tr class="miss"><td class="line">1430</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">1431</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1432</td><td class="hits">0</td><td class="source">                for(var i = 0; i &lt; additions.length; i++) {</td></tr><tr class="miss"><td class="line">1433</td><td class="hits">0</td><td class="source">                    highlights.push({</td></tr><tr><td class="line">1434</td><td class="hits"></td><td class="source">                        _id: additions[i]._id,</td></tr><tr><td class="line">1435</td><td class="hits"></td><td class="source">                        text: _additionToPlainText(additions[i])</td></tr><tr><td class="line">1436</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">1437</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">1438</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1439</td><td class="hits">0</td><td class="source">                return res.send({</td></tr><tr><td class="line">1440</td><td class="hits"></td><td class="source">                    highlights: highlights</td></tr><tr><td class="line">1441</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">1442</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1443</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1444</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1445</td><td class="hits">1</td><td class="source">    var _getTags = function(req, res, next) {</td></tr><tr class="miss"><td class="line">1446</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">1447</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">1448</td><td class="hits"></td><td class="source">                _id: req.params.id,</td></tr><tr><td class="line">1449</td><td class="hits"></td><td class="source">                &quot;users.user&quot; : req.user._id</td></tr><tr><td class="line">1450</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1451</td><td class="hits"></td><td class="source">            }, &quot;name _id users created&quot;)</td></tr><tr><td class="line">1452</td><td class="hits"></td><td class="source">            .populate(&quot;users.user&quot;, &quot;name email gravatarHash lastAction enabled&quot;)</td></tr><tr><td class="line">1453</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">1454</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">1455</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1456</td><td class="hits">0</td><td class="source">                if(!notebook) {</td></tr><tr class="miss"><td class="line">1457</td><td class="hits">0</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;Notebook does not exist&quot;));</td></tr><tr><td class="line">1458</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">1459</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1460</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1461</td><td class="hits">0</td><td class="source">                if(notebook.getPermissions(req.user).indexOf(&quot;view_notebooks&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">1462</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to view this notebook&quot;));</td></tr><tr><td class="line">1463</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">1464</td><td class="hits">0</td><td class="source">                Notebook.getTagsForNotebook(notebook._id, function(err, tags){</td></tr><tr class="miss"><td class="line">1465</td><td class="hits">0</td><td class="source">                    return res.send(tags);</td></tr><tr><td class="line">1466</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">1467</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1468</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1469</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1470</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1471</td><td class="hits">1</td><td class="source">    var _addSuggestedFeedUrl = function(req, res, next) {</td></tr><tr class="miss"><td class="line">1472</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">1473</td><td class="hits"></td><td class="source">            notebook = req.params.notebook,</td></tr><tr><td class="line">1474</td><td class="hits"></td><td class="source">            feedUrl = req.params.feedUrl;</td></tr><tr><td class="line">1475</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1476</td><td class="hits">0</td><td class="source">        if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">1477</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1478</td><td class="hits">0</td><td class="source">        if(!feedUrl) return next(new restifyErrors.InvalidInputError(&quot;feedUrl parameter is required&quot;));</td></tr><tr class="miss"><td class="line">1479</td><td class="hits">0</td><td class="source">        try {</td></tr><tr class="miss"><td class="line">1480</td><td class="hits">0</td><td class="source">            Validations.checkUrl(feedUrl);</td></tr><tr><td class="line">1481</td><td class="hits"></td><td class="source">        } catch (e) {</td></tr><tr class="miss"><td class="line">1482</td><td class="hits">0</td><td class="source">            return next(new restifyErrors.InvalidInputError(&quot;Feed url doesn't appear to be a valid url.&quot;));</td></tr><tr><td class="line">1483</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">1484</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">1485</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">1486</td><td class="hits"></td><td class="source">                _id: notebook,</td></tr><tr><td class="line">1487</td><td class="hits"></td><td class="source">                &quot;users.user&quot; : req.user._id</td></tr><tr><td class="line">1488</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">1489</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">1490</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">1491</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1492</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">1493</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1494</td><td class="hits">0</td><td class="source">                _validateFeedAndImport(req.user, notebook, feedUrl, function(error, data) {</td></tr><tr class="miss"><td class="line">1495</td><td class="hits">0</td><td class="source">                    if(error) console.log(error);</td></tr><tr class="miss"><td class="line">1496</td><td class="hits">0</td><td class="source">                    if(error) return next(new restify.InternalError(error.message));</td></tr><tr class="miss"><td class="line">1497</td><td class="hits">0</td><td class="source">                    return res.send(data);</td></tr><tr><td class="line">1498</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">1499</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1500</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1501</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1502</td><td class="hits">1</td><td class="source">    var _validateFeedAndImport = function(user, notebook, feedUrl, done) {</td></tr><tr class="miss"><td class="line">1503</td><td class="hits">0</td><td class="source">        var errorMessages = [];</td></tr><tr><td class="line">1504</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1505</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1506</td><td class="hits">0</td><td class="source">        FeedParsingUtils.parseNewFeedAndReturnPosts(user, notebook._id, feedUrl, function(errors, postsToProcess, failedPosts, feedData) {</td></tr><tr class="miss"><td class="line">1507</td><td class="hits">0</td><td class="source">            var validFeed = true;</td></tr><tr class="miss"><td class="line">1508</td><td class="hits">0</td><td class="source">            if(errors.length &gt;0) {</td></tr><tr class="miss"><td class="line">1509</td><td class="hits">0</td><td class="source">                for(i = 0; i &lt; errors.length; i++) {</td></tr><tr class="miss"><td class="line">1510</td><td class="hits">0</td><td class="source">                     errorMessages.push(&quot;type: &quot; + errors[i].type + &quot;, error:&quot; + errors[i].error);</td></tr><tr class="miss"><td class="line">1511</td><td class="hits">0</td><td class="source">                    if(errors[i].error &amp;&amp; (errors[i].error === &quot;Not a feed&quot; || errors[i].error === &quot;Bad status code : 404&quot; || errors[i].error === &quot;getaddrinfo ENOTFOUND&quot;)) {</td></tr><tr class="miss"><td class="line">1512</td><td class="hits">0</td><td class="source">                        validFeed = false;</td></tr><tr><td class="line">1513</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">1514</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">1515</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">1516</td><td class="hits">0</td><td class="source">            if(feedData) {</td></tr><tr class="miss"><td class="line">1517</td><td class="hits">0</td><td class="source">                feedData.valid = validFeed;</td></tr><tr class="miss"><td class="line">1518</td><td class="hits">0</td><td class="source">                if(errorMessages.length &gt; 0) {</td></tr><tr class="miss"><td class="line">1519</td><td class="hits">0</td><td class="source">                    feedData.errorMessages = errorMessages;</td></tr><tr><td class="line">1520</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">1521</td><td class="hits">0</td><td class="source">                _addFeedToNotebook(feedData, function() {</td></tr><tr class="miss"><td class="line">1522</td><td class="hits">0</td><td class="source">                    if(errors.length === 0) {</td></tr><tr><td class="line">1523</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1524</td><td class="hits">0</td><td class="source">                    notebook.save(function(error, saved){</td></tr><tr class="miss"><td class="line">1525</td><td class="hits">0</td><td class="source">                        if(error) return done(error);</td></tr><tr class="miss"><td class="line">1526</td><td class="hits">0</td><td class="source">                        done(null, {notebook:saved, posts: postsToProcess, errors: errors});</td></tr><tr class="miss"><td class="line">1527</td><td class="hits">0</td><td class="source">                        if(postsToProcess.length &gt; 0) {</td></tr><tr class="miss"><td class="line">1528</td><td class="hits">0</td><td class="source">                            return _createNewSuggestedClippsBatch(saved, user._id, feedData.feedUrl, postsToProcess);</td></tr><tr><td class="line">1529</td><td class="hits"></td><td class="source">                        } else {</td></tr><tr class="miss"><td class="line">1530</td><td class="hits">0</td><td class="source">                            return;</td></tr><tr><td class="line">1531</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">1532</td><td class="hits"></td><td class="source">                    });</td></tr><tr class="miss"><td class="line">1533</td><td class="hits">0</td><td class="source">                } else if(errors.length &gt; 0 &amp;&amp; !validFeed) {</td></tr><tr><td class="line">1534</td><td class="hits"></td><td class="source">                    // bad feed should have already been saved</td></tr><tr class="miss"><td class="line">1535</td><td class="hits">0</td><td class="source">                    notebook.save(function(error, saved){</td></tr><tr class="miss"><td class="line">1536</td><td class="hits">0</td><td class="source">                        if(error) return done(error);</td></tr><tr class="miss"><td class="line">1537</td><td class="hits">0</td><td class="source">                        return done(null, {notebook:saved, posts: postsToProcess, errors: errors});</td></tr><tr><td class="line">1538</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">1539</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="miss"><td class="line">1540</td><td class="hits">0</td><td class="source">                    return done(null, {posts: postsToProcess, errors: errors});</td></tr><tr><td class="line">1541</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">1542</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">1543</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="miss"><td class="line">1544</td><td class="hits">0</td><td class="source">                return done(null, {posts: postsToProcess, errors: errors});</td></tr><tr><td class="line">1545</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">1546</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">1547</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1548</td><td class="hits">0</td><td class="source">        function _addFeedToNotebook(feedData, done) {</td></tr><tr class="miss"><td class="line">1549</td><td class="hits">0</td><td class="source">            var found = false;</td></tr><tr class="miss"><td class="line">1550</td><td class="hits">0</td><td class="source">            if(notebook.suggestedImportFeeds &amp;&amp; notebook.suggestedImportFeeds.length &gt; 0) {</td></tr><tr><td class="line">1551</td><td class="hits"></td><td class="source">                // console.log(&quot;notebook has feeds&quot;);</td></tr><tr class="miss"><td class="line">1552</td><td class="hits">0</td><td class="source">                var</td></tr><tr><td class="line">1553</td><td class="hits"></td><td class="source">                    nbFeedUrl,</td></tr><tr><td class="line">1554</td><td class="hits"></td><td class="source">                    nbUrl;</td></tr><tr><td class="line">1555</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1556</td><td class="hits">0</td><td class="source">                for(var i = 0; i &lt; notebook.suggestedImportFeeds.length; i++) {</td></tr><tr class="miss"><td class="line">1557</td><td class="hits">0</td><td class="source">                    nbFeedUrl = notebook.suggestedImportFeeds[i].feedUrl;</td></tr><tr class="miss"><td class="line">1558</td><td class="hits">0</td><td class="source">                    nbUrl = notebook.suggestedImportFeeds[i].url;</td></tr><tr class="miss"><td class="line">1559</td><td class="hits">0</td><td class="source">                    if(nbFeedUrl !== feedData.feedUrl &amp;&amp; nbUrl === feedData.url) {</td></tr><tr class="miss"><td class="line">1560</td><td class="hits">0</td><td class="source">                        found = true;</td></tr><tr class="miss"><td class="line">1561</td><td class="hits">0</td><td class="source">                        notebook.suggestedImportFeeds[i].feedUrl = feedData.feedUrl;</td></tr><tr class="miss"><td class="line">1562</td><td class="hits">0</td><td class="source">                        notebook.suggestedImportFeeds[i].lastUpdated = feedData.lastUpdated;</td></tr><tr class="miss"><td class="line">1563</td><td class="hits">0</td><td class="source">                        notebook.markModified(&quot;suggestedImportFeeds&quot;);</td></tr><tr class="miss"><td class="line">1564</td><td class="hits">0</td><td class="source">                        return done();</td></tr><tr class="miss"><td class="line">1565</td><td class="hits">0</td><td class="source">                    } else if(nbFeedUrl === feedData.feedUrl &amp;&amp; nbUrl === feedData.url) {</td></tr><tr class="miss"><td class="line">1566</td><td class="hits">0</td><td class="source">                        found = true;</td></tr><tr class="miss"><td class="line">1567</td><td class="hits">0</td><td class="source">                        notebook.suggestedImportFeeds[i].lastUpdated = feedData.lastUpdated;</td></tr><tr class="miss"><td class="line">1568</td><td class="hits">0</td><td class="source">                        notebook.markModified(&quot;suggestedImportFeeds&quot;);</td></tr><tr class="miss"><td class="line">1569</td><td class="hits">0</td><td class="source">                        return done();</td></tr><tr><td class="line">1570</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">1571</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">1572</td><td class="hits"></td><td class="source">            } else {</td></tr><tr><td class="line">1573</td><td class="hits"></td><td class="source">                // console.log(&quot;no feeds pushing new feed on %j&quot;, feedData);</td></tr><tr class="miss"><td class="line">1574</td><td class="hits">0</td><td class="source">                notebook.suggestedImportFeeds = [];</td></tr><tr class="miss"><td class="line">1575</td><td class="hits">0</td><td class="source">                notebook.suggestedImportFeeds.push(feedData);</td></tr><tr class="miss"><td class="line">1576</td><td class="hits">0</td><td class="source">                notebook.markModified(&quot;suggestedImportFeeds&quot;);</td></tr><tr class="miss"><td class="line">1577</td><td class="hits">0</td><td class="source">                return done();</td></tr><tr><td class="line">1578</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">1579</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1580</td><td class="hits">0</td><td class="source">            if(!found) {</td></tr><tr><td class="line">1581</td><td class="hits"></td><td class="source">                // console.log(&quot;they have feeds but they didn't match %j&quot;, feedData);</td></tr><tr class="miss"><td class="line">1582</td><td class="hits">0</td><td class="source">                notebook.suggestedImportFeeds.push(feedData);</td></tr><tr class="miss"><td class="line">1583</td><td class="hits">0</td><td class="source">                notebook.markModified(&quot;suggestedImportFeeds&quot;);</td></tr><tr class="miss"><td class="line">1584</td><td class="hits">0</td><td class="source">                return done();</td></tr><tr><td class="line">1585</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">1586</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1587</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">1588</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1589</td><td class="hits">0</td><td class="source">        function _createNewSuggestedClippsBatch(notebook, userId, sourceURL, postsToProcess, done) {</td></tr><tr class="miss"><td class="line">1590</td><td class="hits">0</td><td class="source">            var batch = new SuggestedBatchImport.Model();</td></tr><tr><td class="line">1591</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1592</td><td class="hits">0</td><td class="source">            redisq.options({</td></tr><tr><td class="line">1593</td><td class="hits"></td><td class="source">                &quot;redis&quot;: {</td></tr><tr><td class="line">1594</td><td class="hits"></td><td class="source">                    &quot;host&quot;: Settings.redisq.options.host,</td></tr><tr><td class="line">1595</td><td class="hits"></td><td class="source">                    &quot;port&quot;: Settings.redisq.options.port,</td></tr><tr><td class="line">1596</td><td class="hits"></td><td class="source">                    &quot;password&quot;: Settings.redisq.options.pass</td></tr><tr><td class="line">1597</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">1598</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1599</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1600</td><td class="hits">0</td><td class="source">            var suggested_link_import_queue = redisq.queue(Settings.jobs.suggested_link_import);</td></tr><tr><td class="line">1601</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1602</td><td class="hits"></td><td class="source">            //only unique urls and non-empty lines</td></tr><tr class="miss"><td class="line">1603</td><td class="hits">0</td><td class="source">            var urls = ArrayUtils.nonEmptyElements(postsToProcess);</td></tr><tr class="miss"><td class="line">1604</td><td class="hits">0</td><td class="source">            var validatedUrls = ArrayUtils.sanitizeAndValidateArray(urls);</td></tr><tr class="miss"><td class="line">1605</td><td class="hits">0</td><td class="source">            urls = validatedUrls[0];</td></tr><tr class="miss"><td class="line">1606</td><td class="hits">0</td><td class="source">            var badUrls = validatedUrls[1];</td></tr><tr class="miss"><td class="line">1607</td><td class="hits">0</td><td class="source">            urls = ArrayUtils.uniqueArray(urls);</td></tr><tr><td class="line">1608</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1609</td><td class="hits"></td><td class="source">            // res.send({</td></tr><tr><td class="line">1610</td><td class="hits"></td><td class="source">            //     batch: batch._id,</td></tr><tr><td class="line">1611</td><td class="hits"></td><td class="source">            //     count: urls.length</td></tr><tr><td class="line">1612</td><td class="hits"></td><td class="source">            // });</td></tr><tr><td class="line">1613</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1614</td><td class="hits">0</td><td class="source">            var jobUrls = [];</td></tr><tr class="miss"><td class="line">1615</td><td class="hits">0</td><td class="source">            var firstBatch;</td></tr><tr><td class="line">1616</td><td class="hits"></td><td class="source">            //initially we only care about the first 5, the rest are going to get chunked and added as jobs</td></tr><tr class="miss"><td class="line">1617</td><td class="hits">0</td><td class="source">            jobUrls = ArrayUtils.sliceIntoGroups(urls, 5);</td></tr><tr><td class="line">1618</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1619</td><td class="hits"></td><td class="source">            //now that we have these created we just need to dump them into the batch</td></tr><tr class="miss"><td class="line">1620</td><td class="hits">0</td><td class="source">            batch.notebook = notebook._id;</td></tr><tr class="miss"><td class="line">1621</td><td class="hits">0</td><td class="source">            batch.user = userId;</td></tr><tr class="miss"><td class="line">1622</td><td class="hits">0</td><td class="source">            batch.jobSize = 5;</td></tr><tr class="miss"><td class="line">1623</td><td class="hits">0</td><td class="source">            batch.numJobs = jobUrls.length;</td></tr><tr class="miss"><td class="line">1624</td><td class="hits">0</td><td class="source">            batch.totalToBeProcessed = urls.length;</td></tr><tr class="miss"><td class="line">1625</td><td class="hits">0</td><td class="source">            batch.totalProcessed = 0;</td></tr><tr class="miss"><td class="line">1626</td><td class="hits">0</td><td class="source">            batch.problemUrls = badUrls;</td></tr><tr class="miss"><td class="line">1627</td><td class="hits">0</td><td class="source">            batch.source = &quot;feed&quot;;</td></tr><tr class="miss"><td class="line">1628</td><td class="hits">0</td><td class="source">            batch.sourceURL = sourceURL;</td></tr><tr class="miss"><td class="line">1629</td><td class="hits">0</td><td class="source">            for(var j in jobUrls) {</td></tr><tr class="miss"><td class="line">1630</td><td class="hits">0</td><td class="source">                var job = jobUrls[j];</td></tr><tr class="miss"><td class="line">1631</td><td class="hits">0</td><td class="source">                batch.jobs.push({urls: job});</td></tr><tr><td class="line">1632</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">1633</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1634</td><td class="hits"></td><td class="source">            //console.log(&quot;batch import: &quot; + JSON.stringify(batch));</td></tr><tr><td class="line">1635</td><td class="hits"></td><td class="source">            //save the batch, then start processing</td></tr><tr class="miss"><td class="line">1636</td><td class="hits">0</td><td class="source">            batch.save(function(err, saved) {</td></tr><tr class="miss"><td class="line">1637</td><td class="hits">0</td><td class="source">                if(err) return console.log(&quot;error saving batch: &quot; +err);//bail before processing</td></tr><tr><td class="line">1638</td><td class="hits"></td><td class="source">                //console.log(&quot;batch import saved&quot;);</td></tr><tr class="miss"><td class="line">1639</td><td class="hits">0</td><td class="source">                firstBatch = saved.jobs[0].urls;</td></tr><tr class="miss"><td class="line">1640</td><td class="hits">0</td><td class="source">                SuggestedBatchImport.processChunk(saved, firstBatch, function(er, results){</td></tr><tr class="miss"><td class="line">1641</td><td class="hits">0</td><td class="source">                    if(er) console.log(&quot;there was a problem processing batch: &quot; + er);</td></tr><tr class="miss"><td class="line">1642</td><td class="hits">0</td><td class="source">                    for(var k = 1;  k&lt;saved.numJobs; k++) {</td></tr><tr class="miss"><td class="line">1643</td><td class="hits">0</td><td class="source">                        var job = {</td></tr><tr><td class="line">1644</td><td class="hits"></td><td class="source">                            batch: saved._id,</td></tr><tr><td class="line">1645</td><td class="hits"></td><td class="source">                            idx: k,</td></tr><tr><td class="line">1646</td><td class="hits"></td><td class="source">                            id: saved.jobs[k]._id</td></tr><tr><td class="line">1647</td><td class="hits"></td><td class="source">                        };</td></tr><tr><td class="line">1648</td><td class="hits"></td><td class="source">                        //console.log(&quot;pushing job onto stack: &quot; + JSON.stringify(job));</td></tr><tr class="miss"><td class="line">1649</td><td class="hits">0</td><td class="source">                        suggested_link_import_queue.push(job, pushJob);</td></tr><tr><td class="line">1650</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">1651</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1652</td><td class="hits">0</td><td class="source">                    var pushJob = function(err, res) {</td></tr><tr class="miss"><td class="line">1653</td><td class="hits">0</td><td class="source">                        if(err) console.log(&quot;Error scheduling link import job&quot;, err);</td></tr><tr><td class="line">1654</td><td class="hits"></td><td class="source">                    };</td></tr><tr><td class="line">1655</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1656</td><td class="hits">0</td><td class="source">                    if(saved.jobs.length &lt;= 1) {</td></tr><tr><td class="line">1657</td><td class="hits"></td><td class="source">                        //mark and save the batch as processed</td></tr><tr class="miss"><td class="line">1658</td><td class="hits">0</td><td class="source">                        saved.processed = true;</td></tr><tr class="miss"><td class="line">1659</td><td class="hits">0</td><td class="source">                        saved.totalProcessed = firstBatch.length;</td></tr><tr class="miss"><td class="line">1660</td><td class="hits">0</td><td class="source">                        saved.logs = results.logs;</td></tr><tr class="miss"><td class="line">1661</td><td class="hits">0</td><td class="source">                        saved.save(function(er) {</td></tr><tr class="miss"><td class="line">1662</td><td class="hits">0</td><td class="source">                            if(er) console.log(&quot;error occurred updating batch&quot;, er);</td></tr><tr><td class="line">1663</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">1664</td><td class="hits"></td><td class="source">                    }  else {</td></tr><tr class="miss"><td class="line">1665</td><td class="hits">0</td><td class="source">                        SuggestedBatchImport.Model</td></tr><tr><td class="line">1666</td><td class="hits"></td><td class="source">                            .update(</td></tr><tr><td class="line">1667</td><td class="hits"></td><td class="source">                                {_id: saved._id},</td></tr><tr><td class="line">1668</td><td class="hits"></td><td class="source">                                {</td></tr><tr><td class="line">1669</td><td class="hits"></td><td class="source">                                    $inc: {totalProcessed: firstBatch.length},</td></tr><tr><td class="line">1670</td><td class="hits"></td><td class="source">                                    $push: { logs: { $each: results.logs }}</td></tr><tr><td class="line">1671</td><td class="hits"></td><td class="source">                                }, function(er) {</td></tr><tr class="miss"><td class="line">1672</td><td class="hits">0</td><td class="source">                                    if(er) console.log(&quot;error occurred updating batch&quot;, er);</td></tr><tr><td class="line">1673</td><td class="hits"></td><td class="source">                                });</td></tr><tr><td class="line">1674</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">1675</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">1676</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1677</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">1678</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1679</td><td class="hits"></td><td class="source">        // function _createNewSuggestedClipps(postsToProcess, done) {</td></tr><tr><td class="line">1680</td><td class="hits"></td><td class="source">        //     // console.log(&quot;posts %d&quot;, postsToProcess.length);</td></tr><tr><td class="line">1681</td><td class="hits"></td><td class="source">        //     async.each(postsToProcess, createSuggestedClippAndSave, function(err){</td></tr><tr><td class="line">1682</td><td class="hits"></td><td class="source">        //         if(err) console.log(&quot;error creating suggested clipps: %j&quot;, err);</td></tr><tr><td class="line">1683</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">1684</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1685</td><td class="hits"></td><td class="source">        //     function createSuggestedClippAndSave(data, callback) {</td></tr><tr><td class="line">1686</td><td class="hits"></td><td class="source">        //         var suggestedClipp = new SuggestedClipp.Model({</td></tr><tr><td class="line">1687</td><td class="hits"></td><td class="source">        //             notebook: notebook._id,</td></tr><tr><td class="line">1688</td><td class="hits"></td><td class="source">        //             url: data.url,</td></tr><tr><td class="line">1689</td><td class="hits"></td><td class="source">        //             title: data.title,</td></tr><tr><td class="line">1690</td><td class="hits"></td><td class="source">        //             description: data.description,</td></tr><tr><td class="line">1691</td><td class="hits"></td><td class="source">        //             source: data.source,</td></tr><tr><td class="line">1692</td><td class="hits"></td><td class="source">        //             sourceURL: data.sourceURL</td></tr><tr><td class="line">1693</td><td class="hits"></td><td class="source">        //          });</td></tr><tr><td class="line">1694</td><td class="hits"></td><td class="source">        //         // console.log(&quot;processing %s:%s&quot;, suggestedClipp.title, suggestedClipp.url);</td></tr><tr><td class="line">1695</td><td class="hits"></td><td class="source">        //         SuggestedClipp.checkForDuplicatesAndSave(notebook._id, suggestedClipp, notebook.clipps, function(err, data){</td></tr><tr><td class="line">1696</td><td class="hits"></td><td class="source">        //             // console.log(&quot;saved %s:%s&quot;, data.title, data.url);</td></tr><tr><td class="line">1697</td><td class="hits"></td><td class="source">        //             callback(err);</td></tr><tr><td class="line">1698</td><td class="hits"></td><td class="source">        //         });</td></tr><tr><td class="line">1699</td><td class="hits"></td><td class="source">        //     }</td></tr><tr><td class="line">1700</td><td class="hits"></td><td class="source">        //     if(done) done();</td></tr><tr><td class="line">1701</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1702</td><td class="hits"></td><td class="source">        // }</td></tr><tr><td class="line">1703</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1704</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1705</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1706</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">1707</td><td class="hits"></td><td class="source">        list: _list,</td></tr><tr><td class="line">1708</td><td class="hits"></td><td class="source">        view: _view,</td></tr><tr><td class="line">1709</td><td class="hits"></td><td class="source">        add: _add,</td></tr><tr><td class="line">1710</td><td class="hits"></td><td class="source">        update: _update,</td></tr><tr><td class="line">1711</td><td class="hits"></td><td class="source">        archive: _archive,</td></tr><tr><td class="line">1712</td><td class="hits"></td><td class="source">        unarchive: _unarchive,</td></tr><tr><td class="line">1713</td><td class="hits"></td><td class="source">        invite: _invite,</td></tr><tr><td class="line">1714</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1715</td><td class="hits"></td><td class="source">        pages: _pages,</td></tr><tr><td class="line">1716</td><td class="hits"></td><td class="source">        page: _page,</td></tr><tr><td class="line">1717</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1718</td><td class="hits"></td><td class="source">        getBatch: _getBatch,</td></tr><tr><td class="line">1719</td><td class="hits"></td><td class="source">        getBatchAdmin: _getBatchAdmin,</td></tr><tr><td class="line">1720</td><td class="hits"></td><td class="source">        getSuggestedBatch: _getSuggestedBatch,</td></tr><tr><td class="line">1721</td><td class="hits"></td><td class="source">        getSuggestedBatchAdmin: _getSuggestedBatchAdmin,</td></tr><tr><td class="line">1722</td><td class="hits"></td><td class="source">        removeUser: _removeUser,</td></tr><tr><td class="line">1723</td><td class="hits"></td><td class="source">        updateUser: _updateUser,</td></tr><tr><td class="line">1724</td><td class="hits"></td><td class="source">        expiredTrialList: _expiredTrialList,</td></tr><tr><td class="line">1725</td><td class="hits"></td><td class="source">        gaNotebookList: _gaNotebookList,</td></tr><tr><td class="line">1726</td><td class="hits"></td><td class="source">        suggestedActionNotebookList: _suggestedActionNotebookList,</td></tr><tr><td class="line">1727</td><td class="hits"></td><td class="source">        convertNotebookToFree: _convertNotebookToFree,</td></tr><tr><td class="line">1728</td><td class="hits"></td><td class="source">        allNotebooks: _allNotebooks,</td></tr><tr><td class="line">1729</td><td class="hits"></td><td class="source">        adminNotebookView: _adminNotebookView,</td></tr><tr><td class="line">1730</td><td class="hits"></td><td class="source">        addFeature: _addFeature,</td></tr><tr><td class="line">1731</td><td class="hits"></td><td class="source">        notebooksForCAAS: _notebooksForCAAS,</td></tr><tr><td class="line">1732</td><td class="hits"></td><td class="source">        notebookForCAAS: _notebookForCAAS,</td></tr><tr><td class="line">1733</td><td class="hits"></td><td class="source">        purchaseReporting: _purchaseReporting,</td></tr><tr><td class="line">1734</td><td class="hits"></td><td class="source">        requestAccess: _requestAccess,</td></tr><tr><td class="line">1735</td><td class="hits"></td><td class="source">        analyticsInvite: _analyticsInvite,</td></tr><tr><td class="line">1736</td><td class="hits"></td><td class="source">        getReportHighlights: _getReportHighlights,</td></tr><tr><td class="line">1737</td><td class="hits"></td><td class="source">        getTags: _getTags,</td></tr><tr><td class="line">1738</td><td class="hits"></td><td class="source">        checkTrialStatus: _checkTrialStatus</td></tr><tr><td class="line">1739</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1740</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">1741</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1742</td><td class="hits">1</td><td class="source">module.exports = NotebooksController;</td></tr><tr><td class="line">1743</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/controllers/pages.js">/Users/warner/code/clipppr/primeloop-api/controllers/pages.js</h2><div id="stats" class="terrible"><div class="percentage">6%</div><div class="sloc">229</div><div class="hits">16</div><div class="misses">213</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var PagesController = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        Page = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/page&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        // Notebook = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/notebook&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        Clipp = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/clipp&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        restify = require(&quot;restify&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        restifyErrors = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/errors&quot;)(restify),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        check = require(&quot;validator&quot;).check;</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">    var PER_PAGE = 20;</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">    var _list = function(req, res, next) {</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;list_pages&quot;) &lt; 0 &amp;&amp; req.client.permissions.indexOf(&quot;list_pages&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to view pages&quot;));</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">            page = parseInt(req.params.page, 10) || 1,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">            per_page = req.params.per_page || PER_PAGE,</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">            since = req.params.since,</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">            type = req.params.type,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">            status = req.params.status,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">            fields = req.params.fields || {},</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">            query = {},</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">            sort = { created: 1 },</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">            q = {};</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">         if(since &amp;&amp; type) {</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">            query.$or = [];</td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">            q[&quot;updated.&quot;+type] = { $lt: since };</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">            query.$or.push(q);</td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">            q = {};</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">            q[&quot;updated.&quot;+type] = { $exists: false };</td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">            query.$or.push(q);</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">            q = {};</td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">            q[&quot;updated.&quot;+type] = null;</td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">            query.$or.push(q);</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">            sort[&quot;updated.&quot;+type] = 1;</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">            if(status) {</td></tr><tr class="miss"><td class="line">46</td><td class="hits">0</td><td class="source">                query.$and = [];</td></tr><tr class="miss"><td class="line">47</td><td class="hits">0</td><td class="source">                q={};</td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="source">                q[&quot;status.&quot;+type] = status;</td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">                query.$and.push(q);</td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">                query.$and.push({$or: query.$or});</td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="source">                delete query.$or;</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">            if(type == &quot;comment&quot;) {</td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">                q = { paymentType: {$ne: &quot;free&quot;} };</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">                if(query.$and) query.$and.push(q);</td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">                else query.$and = [q];</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">        // console.log(JSON.stringify(query));</td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="source">        Page.Model</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">            .find(query, fields)</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">            .limit(per_page)</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">            .skip((page-1)*per_page)</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">            .sort(sort)</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">            .exec(function(err, pages){</td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="source">                return res.send(pages);    </td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">77</td><td class="hits">1</td><td class="source">    var _listStream = function(req, res, next) {</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;list_pages&quot;) &lt; 0 &amp;&amp; req.client.permissions.indexOf(&quot;list_pages&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to view pages&quot;));</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">            since = req.params.since,</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">            type = req.params.type,</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">            query = {},</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">            sort = {},</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">            q = {},</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">            status = req.params.status,</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">            fields = req.params.fields || {},</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">            set = {},</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">            page_ids = [];</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="source">        if(since &amp;&amp; type) {</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="source">            query.$or = [];</td></tr><tr class="miss"><td class="line">97</td><td class="hits">0</td><td class="source">            q[&quot;updated.&quot;+type] = { $lt: since };</td></tr><tr class="miss"><td class="line">98</td><td class="hits">0</td><td class="source">            query.$or.push(q);</td></tr><tr class="miss"><td class="line">99</td><td class="hits">0</td><td class="source">            q = {};</td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="source">            q[&quot;updated.&quot;+type] = { $exists: false };</td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="source">            query.$or.push(q);</td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="source">            q = {};</td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="source">            q[&quot;updated.&quot;+type] = null;</td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="source">            query.$or.push(q);</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="source">            sort[&quot;updated.&quot;+type] = 1;</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="source">            if(status) {</td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="source">                query.$and = [];</td></tr><tr class="miss"><td class="line">110</td><td class="hits">0</td><td class="source">                q={};</td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="source">                q[&quot;status.&quot;+type] = status;</td></tr><tr class="miss"><td class="line">112</td><td class="hits">0</td><td class="source">                query.$and.push(q);</td></tr><tr class="miss"><td class="line">113</td><td class="hits">0</td><td class="source">                query.$and.push({$or: query.$or});</td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="source">                delete query.$or;</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="source">            if(type == &quot;comment&quot;) {</td></tr><tr class="miss"><td class="line">118</td><td class="hits">0</td><td class="source">                q = { paymentType: {$ne: &quot;free&quot;} };</td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="source">                if(query.$and) query.$and.push(q);</td></tr><tr class="miss"><td class="line">120</td><td class="hits">0</td><td class="source">                else query.$and = [q];</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">124</td><td class="hits">0</td><td class="source">        Page.Model</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">            .find(query, fields)</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">            .sort(sort)</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">            .stream({ transform: JSON.stringify })</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">            .on(&quot;error&quot;, function(err){</td></tr><tr class="miss"><td class="line">130</td><td class="hits">0</td><td class="source">                return next(err);</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">            .on(&quot;data&quot;, function(page){</td></tr><tr class="miss"><td class="line">133</td><td class="hits">0</td><td class="source">                page = JSON.parse(page);</td></tr><tr class="miss"><td class="line">134</td><td class="hits">0</td><td class="source">                if(page._id) page_ids.push(page._id);</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">            .on(&quot;end&quot;, function(err){</td></tr><tr class="miss"><td class="line">137</td><td class="hits">0</td><td class="source">                if(status &amp;&amp; since &amp;&amp; type){</td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="source">                    set[&quot;status.&quot;+type] = &quot;processing&quot;;</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">                    // console.log(&quot;pages:&quot;,page_ids.length);</td></tr><tr class="miss"><td class="line">140</td><td class="hits">0</td><td class="source">                    Page.Model.update({_id: {$in : page_ids}}, set, {multi: true}, function(err, res){</td></tr><tr class="miss"><td class="line">141</td><td class="hits">0</td><td class="source">                        if(err) console.log(err);</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">                }     </td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">            .pipe(res);   </td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">148</td><td class="hits">1</td><td class="source">    var _listCommentStream = function(req, res, next) {</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">150</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;list_pages&quot;) &lt; 0 &amp;&amp; req.client.permissions.indexOf(&quot;list_pages&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">151</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to view pages&quot;));</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">154</td><td class="hits">0</td><td class="source">        var page_ids = [];</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">156</td><td class="hits">0</td><td class="source">        var since = new Date(new Date().getTime()-(1000*60*60*req.params.since)).toString();</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">158</td><td class="hits">0</td><td class="source">        Page.Model</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">                &quot;comments.url&quot;: {$ne: null},</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">                    </td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">                $or: [</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">                    {&quot;comments.updated&quot;: {$lt: since}},</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">                    {&quot;comments.updated&quot;: null}</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">                ]</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">                    </td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">            }, &quot;_id comments&quot;)</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">            .sort({&quot;comments.updated&quot;: 1})</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">            .stream({ transform: JSON.stringify })</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">            .on(&quot;error&quot;, function(err){</td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="source">                return next(err);</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">            .on(&quot;data&quot;, function(page){</td></tr><tr class="miss"><td class="line">176</td><td class="hits">0</td><td class="source">                try {</td></tr><tr class="miss"><td class="line">177</td><td class="hits">0</td><td class="source">                    page = JSON.parse(page);</td></tr><tr class="miss"><td class="line">178</td><td class="hits">0</td><td class="source">                    if(page._id) page_ids.push(page._id);</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">                } catch (e){</td></tr><tr class="miss"><td class="line">180</td><td class="hits">0</td><td class="source">                    console.log(e, e.stack);</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">                </td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">            .on(&quot;end&quot;, function(err){</td></tr><tr class="miss"><td class="line">185</td><td class="hits">0</td><td class="source">                Page.Model.update({_id: {$in : page_ids}}, {$set: { &quot;comments.updated&quot;: new Date() } }, {multi: true}, function(err, res){</td></tr><tr class="miss"><td class="line">186</td><td class="hits">0</td><td class="source">                    if(err) console.log(err);</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">            .pipe(res);   </td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">192</td><td class="hits">1</td><td class="source">    var _updateCount = function(req, res, next) {</td></tr><tr class="miss"><td class="line">193</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;list_pages&quot;) &lt; 0 &amp;&amp; req.client.permissions.indexOf(&quot;list_pages&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">194</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to view pages&quot;));</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">197</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">            query = {},</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">            closed_comments = req.params.closed_comments,</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">            since = req.params.since,</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">            q = {},</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">            type = req.params.type;</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">204</td><td class="hits">0</td><td class="source">        if(since &amp;&amp; type) {</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">206</td><td class="hits">0</td><td class="source">            query.$or = [];</td></tr><tr class="miss"><td class="line">207</td><td class="hits">0</td><td class="source">            q[&quot;updated.&quot;+type] = { $lt: since };</td></tr><tr class="miss"><td class="line">208</td><td class="hits">0</td><td class="source">            query.$or.push(q);</td></tr><tr class="miss"><td class="line">209</td><td class="hits">0</td><td class="source">            q = {};</td></tr><tr class="miss"><td class="line">210</td><td class="hits">0</td><td class="source">            q[&quot;updated.&quot;+type] = { $exists: false };</td></tr><tr class="miss"><td class="line">211</td><td class="hits">0</td><td class="source">            query.$or.push(q);</td></tr><tr class="miss"><td class="line">212</td><td class="hits">0</td><td class="source">            q = {};</td></tr><tr class="miss"><td class="line">213</td><td class="hits">0</td><td class="source">            q[&quot;updated.&quot;+type] = null;</td></tr><tr class="miss"><td class="line">214</td><td class="hits">0</td><td class="source">            query.$or.push(q);</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">218</td><td class="hits">0</td><td class="source">        if(closed_comments &amp;&amp; closed_comments == &quot;false&quot;) {</td></tr><tr class="miss"><td class="line">219</td><td class="hits">0</td><td class="source">            query.commentsClosed = { $ne: true };</td></tr><tr class="miss"><td class="line">220</td><td class="hits">0</td><td class="source">            query.commentSystem = {$ne: &quot;none&quot;};</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">        //Exclude free only pages</td></tr><tr class="miss"><td class="line">224</td><td class="hits">0</td><td class="source">        query.paymentType = { $ne: &quot;free&quot; };</td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">226</td><td class="hits">0</td><td class="source">        Page.Model</td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source">            .count(query)</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source">            .exec(function(err, count){</td></tr><tr class="miss"><td class="line">229</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">                // console.log(&quot;count is: &quot; + JSON.stringify(count));</td></tr><tr class="miss"><td class="line">231</td><td class="hits">0</td><td class="source">                return res.send({count: count});</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">235</td><td class="hits">1</td><td class="source">    var _listForManualUpdating = function(req, res, next) {</td></tr><tr class="miss"><td class="line">236</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;list_pages&quot;) &lt; 0 &amp;&amp; req.client.permissions.indexOf(&quot;list_pages&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">237</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to view pages&quot;));</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">240</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source">            query = {},</td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source">            fields = req.params.fields || &quot;&quot;,</td></tr><tr><td class="line">243</td><td class="hits"></td><td class="source">            closed_comments = req.params.closed_comments,</td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source">            sort = req.params.sort || {url: 1},</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source">            page = parseInt(req.params.page || 0, 10) || null,</td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source">            per_page = parseInt(req.params.per_page || 0, 10) || null,</td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source">            since = req.params.since,</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source">            q = {},</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">            type = req.params.type;</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">251</td><td class="hits">0</td><td class="source">        if(since &amp;&amp; type) {</td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">253</td><td class="hits">0</td><td class="source">            query.$or = [];</td></tr><tr class="miss"><td class="line">254</td><td class="hits">0</td><td class="source">            q[&quot;updated.&quot;+type] = { $lt: since };</td></tr><tr class="miss"><td class="line">255</td><td class="hits">0</td><td class="source">            query.$or.push(q);</td></tr><tr class="miss"><td class="line">256</td><td class="hits">0</td><td class="source">            q = {};</td></tr><tr class="miss"><td class="line">257</td><td class="hits">0</td><td class="source">            q[&quot;updated.&quot;+type] = { $exists: false };</td></tr><tr class="miss"><td class="line">258</td><td class="hits">0</td><td class="source">            query.$or.push(q);</td></tr><tr class="miss"><td class="line">259</td><td class="hits">0</td><td class="source">            q = {};</td></tr><tr class="miss"><td class="line">260</td><td class="hits">0</td><td class="source">            q[&quot;updated.&quot;+type] = null;</td></tr><tr class="miss"><td class="line">261</td><td class="hits">0</td><td class="source">            query.$or.push(q);</td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">263</td><td class="hits">0</td><td class="source">            sort[&quot;updated.&quot;+type] = 1;</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">267</td><td class="hits">0</td><td class="source">        if(closed_comments &amp;&amp; closed_comments == &quot;false&quot;) {</td></tr><tr class="miss"><td class="line">268</td><td class="hits">0</td><td class="source">            query.commentsClosed = { $ne: true };</td></tr><tr class="miss"><td class="line">269</td><td class="hits">0</td><td class="source">            query.commentSystem = {$ne: &quot;none&quot;};</td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">272</td><td class="hits"></td><td class="source">        //Exclude free only pages</td></tr><tr class="miss"><td class="line">273</td><td class="hits">0</td><td class="source">        query.paymentType = { $ne: &quot;free&quot; };</td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">276</td><td class="hits">0</td><td class="source">        Page.Model</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source">            .find(query, fields)</td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source">            .sort(sort)</td></tr><tr><td class="line">279</td><td class="hits"></td><td class="source">            .limit(per_page)</td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source">            .skip((page-1)*per_page)</td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source">            .exec(function(err, pages){</td></tr><tr class="miss"><td class="line">283</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">285</td><td class="hits">0</td><td class="source">                res.send(pages);</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">289</td><td class="hits">1</td><td class="source">    var _view = function(req, res, next) {</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">291</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;list_pages&quot;) &lt; 0 &amp;&amp; req.client.permissions.indexOf(&quot;list_pages&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">292</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to view pages&quot;));</td></tr><tr><td class="line">293</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">295</td><td class="hits">0</td><td class="source">        Page.Model</td></tr><tr><td class="line">296</td><td class="hits"></td><td class="source">            .findOne({_id: req.params.id})</td></tr><tr><td class="line">297</td><td class="hits"></td><td class="source">            .populate(&quot;engagementHistory&quot;) //TODO: make sure page engagement history is needed on page details</td></tr><tr><td class="line">298</td><td class="hits"></td><td class="source">            .populate(&quot;clipps&quot;) //TODO: Make sure clipps are needed on page details</td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">300</td><td class="hits"></td><td class="source">            .exec(function(err, page){</td></tr><tr class="miss"><td class="line">301</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">302</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">303</td><td class="hits">0</td><td class="source">                if(!page) return next(new restify.ResourceNotFoundError(&quot;Page does not exist&quot;));</td></tr><tr><td class="line">304</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">305</td><td class="hits">0</td><td class="source">                return res.send(page);</td></tr><tr><td class="line">306</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">307</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">308</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">309</td><td class="hits">1</td><td class="source">    var _add = function(req, res, next) {</td></tr><tr><td class="line">310</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">311</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;add_page&quot;) &lt; 0 &amp;&amp; req.client.permissions.indexOf(&quot;add_page&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">312</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to add pages&quot;));</td></tr><tr><td class="line">313</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">315</td><td class="hits">0</td><td class="source">        Page.Model</td></tr><tr><td class="line">316</td><td class="hits"></td><td class="source">            .findOne({url: req.params.url})</td></tr><tr><td class="line">317</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">318</td><td class="hits"></td><td class="source">            .exec(function(err, page){</td></tr><tr><td class="line">319</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">320</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr class="miss"><td class="line">321</td><td class="hits">0</td><td class="source">                if(page) return res.send(page);</td></tr><tr><td class="line">322</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">323</td><td class="hits">0</td><td class="source">                page = new Page.Model(req.params);</td></tr><tr><td class="line">324</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">325</td><td class="hits">0</td><td class="source">                page.save(function(err, saved){</td></tr><tr><td class="line">326</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">327</td><td class="hits">0</td><td class="source">                    if(err &amp;&amp; err.errors) {</td></tr><tr class="miss"><td class="line">328</td><td class="hits">0</td><td class="source">                        return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">329</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">330</td><td class="hits">0</td><td class="source">                    else if(err) return next(err);</td></tr><tr><td class="line">331</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">332</td><td class="hits">0</td><td class="source">                    return res.send(saved);</td></tr><tr><td class="line">333</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">334</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">335</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">336</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">337</td><td class="hits">1</td><td class="source">    var _update = function(req, res, next) {</td></tr><tr><td class="line">338</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">339</td><td class="hits"></td><td class="source">        //TODO: Add edit clipp counts permission</td></tr><tr><td class="line">340</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">341</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;update_page&quot;) &lt; 0 &amp;&amp; req.client.permissions.indexOf(&quot;update_page&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">342</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to add pages&quot;));</td></tr><tr><td class="line">343</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">344</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">345</td><td class="hits"></td><td class="source">            data = req.params,</td></tr><tr><td class="line">346</td><td class="hits"></td><td class="source">            errors = [];</td></tr><tr><td class="line">347</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">348</td><td class="hits"></td><td class="source">        //need to validate all the updated params</td></tr><tr class="miss"><td class="line">349</td><td class="hits">0</td><td class="source">        if(data.engagement) {</td></tr><tr><td class="line">350</td><td class="hits"></td><td class="source">            //validate that all numbers are actually numbers</td></tr><tr><td class="line">351</td><td class="hits"></td><td class="source">            //have to wrap each one because if the property doesn't exist it fails validation and I don't get each error separately</td></tr><tr class="miss"><td class="line">352</td><td class="hits">0</td><td class="source">            if(data.engagement.facebook) {</td></tr><tr class="miss"><td class="line">353</td><td class="hits">0</td><td class="source">                try {</td></tr><tr class="miss"><td class="line">354</td><td class="hits">0</td><td class="source">                    check(data.engagement.facebook,'Please enter a valid integer for facebook').isInt();</td></tr><tr><td class="line">355</td><td class="hits"></td><td class="source">                } catch (e) {</td></tr><tr class="miss"><td class="line">356</td><td class="hits">0</td><td class="source">                    errors.push(e.message);</td></tr><tr><td class="line">357</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">358</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">359</td><td class="hits">0</td><td class="source">            if(data.engagement.comments) {</td></tr><tr class="miss"><td class="line">360</td><td class="hits">0</td><td class="source">                try {</td></tr><tr class="miss"><td class="line">361</td><td class="hits">0</td><td class="source">                    check(data.engagement.comments,'Please enter a valid integer for comments').isInt();</td></tr><tr><td class="line">362</td><td class="hits"></td><td class="source">                } catch (e) {</td></tr><tr class="miss"><td class="line">363</td><td class="hits">0</td><td class="source">                    errors.push(e.message);</td></tr><tr><td class="line">364</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">365</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">366</td><td class="hits">0</td><td class="source">            if(data.engagement.twitter) {</td></tr><tr class="miss"><td class="line">367</td><td class="hits">0</td><td class="source">                try {</td></tr><tr class="miss"><td class="line">368</td><td class="hits">0</td><td class="source">                    check(data.engagement.twitter,'Please enter a valid integer for twitter').isInt();</td></tr><tr><td class="line">369</td><td class="hits"></td><td class="source">                } catch (e) {</td></tr><tr class="miss"><td class="line">370</td><td class="hits">0</td><td class="source">                    errors.push(e.message);</td></tr><tr><td class="line">371</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">372</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">373</td><td class="hits">0</td><td class="source">            if(data.engagement.linkedin) {</td></tr><tr class="miss"><td class="line">374</td><td class="hits">0</td><td class="source">                try {</td></tr><tr class="miss"><td class="line">375</td><td class="hits">0</td><td class="source">                    check(data.engagement.linkedin,'Please enter a valid integer for linkedin').isInt();</td></tr><tr><td class="line">376</td><td class="hits"></td><td class="source">                } catch (e) {</td></tr><tr class="miss"><td class="line">377</td><td class="hits">0</td><td class="source">                    errors.push(e.message);</td></tr><tr><td class="line">378</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">379</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">380</td><td class="hits">0</td><td class="source">            if(data.engagement.googleplus) {</td></tr><tr class="miss"><td class="line">381</td><td class="hits">0</td><td class="source">                try {</td></tr><tr class="miss"><td class="line">382</td><td class="hits">0</td><td class="source">                    check(data.engagement.googleplus,'Please enter a valid integer for googleplus').isInt();</td></tr><tr><td class="line">383</td><td class="hits"></td><td class="source">                } catch (e) {</td></tr><tr class="miss"><td class="line">384</td><td class="hits">0</td><td class="source">                    errors.push(e.message);</td></tr><tr><td class="line">385</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">386</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">387</td><td class="hits">0</td><td class="source">            if(data.engagement.native_count) {</td></tr><tr class="miss"><td class="line">388</td><td class="hits">0</td><td class="source">                try {</td></tr><tr class="miss"><td class="line">389</td><td class="hits">0</td><td class="source">                    check(data.engagement.native_count,'Please enter a valid integer for native_count').isInt();</td></tr><tr><td class="line">390</td><td class="hits"></td><td class="source">                } catch (e) {</td></tr><tr class="miss"><td class="line">391</td><td class="hits">0</td><td class="source">                    errors.push(e.message);</td></tr><tr><td class="line">392</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">393</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">394</td><td class="hits">0</td><td class="source">            if(data.engagement.stumbleupon) {</td></tr><tr class="miss"><td class="line">395</td><td class="hits">0</td><td class="source">                try {</td></tr><tr class="miss"><td class="line">396</td><td class="hits">0</td><td class="source">                    check(data.engagement.stumbleupon,'Please enter a valid integer for stumbleupon').isInt();</td></tr><tr><td class="line">397</td><td class="hits"></td><td class="source">                } catch (e) {</td></tr><tr class="miss"><td class="line">398</td><td class="hits">0</td><td class="source">                    errors.push(e.message);</td></tr><tr><td class="line">399</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">400</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">401</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">402</td><td class="hits">0</td><td class="source">        if(errors.length &gt; 0) next(new restifyErrors.InvalidInputError(errors));</td></tr><tr class="miss"><td class="line">403</td><td class="hits">0</td><td class="source">        Page.Model</td></tr><tr><td class="line">404</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">405</td><td class="hits"></td><td class="source">                _id: req.params.id</td></tr><tr><td class="line">406</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">407</td><td class="hits"></td><td class="source">            .exec(function(err, page){</td></tr><tr class="miss"><td class="line">408</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">409</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">410</td><td class="hits">0</td><td class="source">                if(!page) {</td></tr><tr class="miss"><td class="line">411</td><td class="hits">0</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;Page does not exist&quot;));</td></tr><tr><td class="line">412</td><td class="hits"></td><td class="source">                }   </td></tr><tr><td class="line">413</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">414</td><td class="hits">0</td><td class="source">                page.setAll(req.params);</td></tr><tr><td class="line">415</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">416</td><td class="hits"></td><td class="source">                //TODO: Handle saving comments</td></tr><tr><td class="line">417</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">418</td><td class="hits">0</td><td class="source">                page.save(function(err, saved){</td></tr><tr class="miss"><td class="line">419</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr class="miss"><td class="line">420</td><td class="hits">0</td><td class="source">                    return res.send(page);</td></tr><tr><td class="line">421</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">422</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">423</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">424</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">425</td><td class="hits">1</td><td class="source">    var _noPubDate = function(req, res, next) {</td></tr><tr class="miss"><td class="line">426</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;list_pages&quot;) &lt; 0 &amp;&amp; req.client.permissions.indexOf(&quot;list_pages&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">427</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to view pages&quot;));</td></tr><tr><td class="line">428</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">429</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">430</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">431</td><td class="hits"></td><td class="source">            page = parseInt(req.params.page, 10) || 1,</td></tr><tr><td class="line">432</td><td class="hits"></td><td class="source">            per_page = req.params.per_page || PER_PAGE,</td></tr><tr><td class="line">433</td><td class="hits"></td><td class="source">            fields = req.params.fields || {},</td></tr><tr><td class="line">434</td><td class="hits"></td><td class="source">            query = {},</td></tr><tr><td class="line">435</td><td class="hits"></td><td class="source">            sort = { created: 1 },</td></tr><tr><td class="line">436</td><td class="hits"></td><td class="source">            q = {};</td></tr><tr><td class="line">437</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">438</td><td class="hits"></td><td class="source">        /**</td></tr><tr><td class="line">439</td><td class="hits"></td><td class="source">        db.pages.find({</td></tr><tr><td class="line">440</td><td class="hits"></td><td class="source">            $and : [</td></tr><tr><td class="line">441</td><td class="hits"></td><td class="source">                {published: null},</td></tr><tr><td class="line">442</td><td class="hits"></td><td class="source">                {$or : [</td></tr><tr><td class="line">443</td><td class="hits"></td><td class="source">                    {noPubDate:false},</td></tr><tr><td class="line">444</td><td class="hits"></td><td class="source">                    {noPubDate:{$exists:false}}</td></tr><tr><td class="line">445</td><td class="hits"></td><td class="source">                ]}</td></tr><tr><td class="line">446</td><td class="hits"></td><td class="source">            ]</td></tr><tr><td class="line">447</td><td class="hits"></td><td class="source">        })</td></tr><tr><td class="line">448</td><td class="hits"></td><td class="source">        */</td></tr><tr class="miss"><td class="line">449</td><td class="hits">0</td><td class="source">        query.$and = [];</td></tr><tr class="miss"><td class="line">450</td><td class="hits">0</td><td class="source">        q.published = null;</td></tr><tr class="miss"><td class="line">451</td><td class="hits">0</td><td class="source">        query.$and.push(q);</td></tr><tr class="miss"><td class="line">452</td><td class="hits">0</td><td class="source">        q = {};</td></tr><tr class="miss"><td class="line">453</td><td class="hits">0</td><td class="source">        q.$or = [];</td></tr><tr class="miss"><td class="line">454</td><td class="hits">0</td><td class="source">        q.$or.push({noPubDate:false});</td></tr><tr class="miss"><td class="line">455</td><td class="hits">0</td><td class="source">        q.$or.push({noPubDate:{$exists:false}});</td></tr><tr class="miss"><td class="line">456</td><td class="hits">0</td><td class="source">        query.$and.push(q);</td></tr><tr><td class="line">457</td><td class="hits"></td><td class="source">     </td></tr><tr class="miss"><td class="line">458</td><td class="hits">0</td><td class="source">        Page.Model</td></tr><tr><td class="line">459</td><td class="hits"></td><td class="source">            .find(query, fields)</td></tr><tr><td class="line">460</td><td class="hits"></td><td class="source">            .limit(per_page)</td></tr><tr><td class="line">461</td><td class="hits"></td><td class="source">            .skip((page-1)*per_page)</td></tr><tr><td class="line">462</td><td class="hits"></td><td class="source">            .sort(sort)</td></tr><tr><td class="line">463</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">464</td><td class="hits"></td><td class="source">            .exec(function(err, pages){</td></tr><tr class="miss"><td class="line">465</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr class="miss"><td class="line">466</td><td class="hits">0</td><td class="source">                return res.send(pages);    </td></tr><tr><td class="line">467</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">468</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">469</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">470</td><td class="hits">1</td><td class="source">    var _noPubDateToBeUpdated = function(req, res, next) {</td></tr><tr class="miss"><td class="line">471</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;list_pages&quot;) &lt; 0 &amp;&amp; req.client.permissions.indexOf(&quot;list_pages&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">472</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to view pages&quot;));</td></tr><tr><td class="line">473</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">474</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">475</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">476</td><td class="hits"></td><td class="source">            sort = { created: 1 },</td></tr><tr><td class="line">477</td><td class="hits"></td><td class="source">            query = {},</td></tr><tr><td class="line">478</td><td class="hits"></td><td class="source">            q = {};</td></tr><tr><td class="line">479</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">480</td><td class="hits"></td><td class="source">        /**</td></tr><tr><td class="line">481</td><td class="hits"></td><td class="source">        db.pages.find({</td></tr><tr><td class="line">482</td><td class="hits"></td><td class="source">            $and : [</td></tr><tr><td class="line">483</td><td class="hits"></td><td class="source">                {published: null},</td></tr><tr><td class="line">484</td><td class="hits"></td><td class="source">                {$or : [</td></tr><tr><td class="line">485</td><td class="hits"></td><td class="source">                    {noPubDate:false},</td></tr><tr><td class="line">486</td><td class="hits"></td><td class="source">                    {noPubDate:{$exists:false}}</td></tr><tr><td class="line">487</td><td class="hits"></td><td class="source">                ]}</td></tr><tr><td class="line">488</td><td class="hits"></td><td class="source">            ]</td></tr><tr><td class="line">489</td><td class="hits"></td><td class="source">        })</td></tr><tr><td class="line">490</td><td class="hits"></td><td class="source">        */</td></tr><tr class="miss"><td class="line">491</td><td class="hits">0</td><td class="source">        query.$and = [];</td></tr><tr class="miss"><td class="line">492</td><td class="hits">0</td><td class="source">        q.published = null;</td></tr><tr class="miss"><td class="line">493</td><td class="hits">0</td><td class="source">        query.$and.push(q);</td></tr><tr class="miss"><td class="line">494</td><td class="hits">0</td><td class="source">        q = {};</td></tr><tr class="miss"><td class="line">495</td><td class="hits">0</td><td class="source">        q.$or = [];</td></tr><tr class="miss"><td class="line">496</td><td class="hits">0</td><td class="source">        q.$or.push({noPubDate:false});</td></tr><tr class="miss"><td class="line">497</td><td class="hits">0</td><td class="source">        q.$or.push({noPubDate:{$exists:false}});</td></tr><tr class="miss"><td class="line">498</td><td class="hits">0</td><td class="source">        query.$and.push(q);</td></tr><tr><td class="line">499</td><td class="hits"></td><td class="source">     </td></tr><tr class="miss"><td class="line">500</td><td class="hits">0</td><td class="source">        Page.Model</td></tr><tr><td class="line">501</td><td class="hits"></td><td class="source">            .find(query, {&quot;_id&quot;: 1 })</td></tr><tr><td class="line">502</td><td class="hits"></td><td class="source">            .sort(sort)</td></tr><tr><td class="line">503</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">504</td><td class="hits"></td><td class="source">            .exec(function(err, pages){</td></tr><tr class="miss"><td class="line">505</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr class="miss"><td class="line">506</td><td class="hits">0</td><td class="source">                return res.send(pages);    </td></tr><tr><td class="line">507</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">508</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">509</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">510</td><td class="hits">1</td><td class="source">    var _pageReport = function(req, res, next){</td></tr><tr class="miss"><td class="line">511</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;view_reports&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">512</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permissions to view this data&quot;));</td></tr><tr><td class="line">513</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">514</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">515</td><td class="hits">0</td><td class="source">        Page.Model</td></tr><tr><td class="line">516</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">517</td><td class="hits"></td><td class="source">                // $or: [</td></tr><tr><td class="line">518</td><td class="hits"></td><td class="source">                //     // {commentSystem: null},</td></tr><tr><td class="line">519</td><td class="hits"></td><td class="source">                //     {commentSystem: null},</td></tr><tr><td class="line">520</td><td class="hits"></td><td class="source">                //     {commentSystem: &quot;other&quot;}</td></tr><tr><td class="line">521</td><td class="hits"></td><td class="source">                // ],</td></tr><tr><td class="line">522</td><td class="hits"></td><td class="source">                commentsClosed: {$ne: true},</td></tr><tr><td class="line">523</td><td class="hits"></td><td class="source">                &quot;updated.comment&quot;: {$lt: Date.now()-(1000*60*60*24)}</td></tr><tr><td class="line">524</td><td class="hits"></td><td class="source">            })  </td></tr><tr><td class="line">525</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">526</td><td class="hits"></td><td class="source">            .exec(function(err, pages){</td></tr><tr class="miss"><td class="line">527</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr class="miss"><td class="line">528</td><td class="hits">0</td><td class="source">                var domains = {}, parsedURL, domains_arr = [], host;</td></tr><tr><td class="line">529</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">530</td><td class="hits">0</td><td class="source">                for(var i in pages) {</td></tr><tr class="miss"><td class="line">531</td><td class="hits">0</td><td class="source">                    host = require(&quot;url&quot;).parse(pages[i].url).host.replace(&quot;www.&quot;, &quot;&quot;);</td></tr><tr><td class="line">532</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">533</td><td class="hits">0</td><td class="source">                    domains[host] = (domains[host] || 0) + 1;</td></tr><tr><td class="line">534</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">535</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">536</td><td class="hits">0</td><td class="source">                for(var j in domains){</td></tr><tr class="miss"><td class="line">537</td><td class="hits">0</td><td class="source">                    domains_arr.push({domain: j, count: domains[j]});</td></tr><tr><td class="line">538</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">539</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">540</td><td class="hits">0</td><td class="source">                domains_arr.sort(function(a, b){</td></tr><tr class="miss"><td class="line">541</td><td class="hits">0</td><td class="source">                    return b.count - a.count;</td></tr><tr><td class="line">542</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">543</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">544</td><td class="hits">0</td><td class="source">                return res.send(domains_arr);</td></tr><tr><td class="line">545</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">546</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">547</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">548</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">549</td><td class="hits"></td><td class="source">        list: _list,</td></tr><tr><td class="line">550</td><td class="hits"></td><td class="source">        listStream: _listStream,</td></tr><tr><td class="line">551</td><td class="hits"></td><td class="source">        view: _view,</td></tr><tr><td class="line">552</td><td class="hits"></td><td class="source">        add: _add,</td></tr><tr><td class="line">553</td><td class="hits"></td><td class="source">        update: _update,</td></tr><tr><td class="line">554</td><td class="hits"></td><td class="source">        updateCount: _updateCount,</td></tr><tr><td class="line">555</td><td class="hits"></td><td class="source">        listForManualUpdating: _listForManualUpdating,</td></tr><tr><td class="line">556</td><td class="hits"></td><td class="source">        noPubDate: _noPubDate,</td></tr><tr><td class="line">557</td><td class="hits"></td><td class="source">        noPubDateToBeUpdated: _noPubDateToBeUpdated,</td></tr><tr><td class="line">558</td><td class="hits"></td><td class="source">        pageReport: _pageReport,</td></tr><tr><td class="line">559</td><td class="hits"></td><td class="source">        listCommentStream: _listCommentStream</td></tr><tr><td class="line">560</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">561</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">562</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">563</td><td class="hits">1</td><td class="source">module.exports = PagesController;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/controllers/plans.js">/Users/warner/code/clipppr/primeloop-api/controllers/plans.js</h2><div id="stats" class="high"><div class="percentage">82%</div><div class="sloc">35</div><div class="hits">29</div><div class="misses">6</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var PlansController = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        Plan = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/plan&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        restify = require(&quot;restify&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        restifyErrors = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/errors&quot;)(restify);</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">    var PER_PAGE = 20;</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">    var _get = function(req, res, next) {</td></tr><tr class="miss"><td class="line">12</td><td class="hits">0</td><td class="source">         Plan.Model</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">            .findOne({id: req.params.id})</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">            .exec(function(err, plan){</td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="source">                if(!plan) return next(new restify.ResourceNotFoundError(&quot;Plan not found&quot;));</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">                </td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="source">                if(plan.toObject) plan = plan.toObject();</td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">                if(plan.metadata.features) plan.features = plan.metadata.features.split(&quot;,&quot;);</td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="source">                return res.send(plan);    </td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">24</td><td class="hits">1</td><td class="source">    var _list = function(req, res, next) {</td></tr><tr class="hit"><td class="line">25</td><td class="hits">2</td><td class="source">        if(req.user.permissions.indexOf(&quot;list_plans&quot;) &lt; 0 &amp;&amp; req.client.permissions.indexOf(&quot;list_plans&quot;) &lt; 0) {</td></tr><tr class="hit"><td class="line">26</td><td class="hits">1</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to view plans&quot;));</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">29</td><td class="hits">1</td><td class="source">        var </td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">            page = parseInt(req.params.page, 10) || 1,</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">            per_page = PER_PAGE,</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">            sort = { created: 1 };</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">  </td></tr><tr class="hit"><td class="line">34</td><td class="hits">1</td><td class="source">        Plan.Model</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">            .find({})</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">            .limit(per_page)</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">            .skip((page-1)*per_page)</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">            .sort(sort)</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">            .exec(function(err, plans){</td></tr><tr class="hit"><td class="line">40</td><td class="hits">1</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">42</td><td class="hits">1</td><td class="source">                return res.send(plans);    </td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">47</td><td class="hits">1</td><td class="source">    var _create = function(req, res, next) {</td></tr><tr class="hit"><td class="line">48</td><td class="hits">2</td><td class="source">        if(req.user.permissions.indexOf(&quot;create_plans&quot;) &lt; 0 &amp;&amp; req.client.permissions.indexOf(&quot;create_plans&quot;) &lt; 0) {</td></tr><tr class="hit"><td class="line">49</td><td class="hits">1</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to create plans&quot;));</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">52</td><td class="hits">1</td><td class="source">        var plan = new Plan.Model(req.params);</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">54</td><td class="hits">1</td><td class="source">        plan.save(function(err, resp){</td></tr><tr class="hit"><td class="line">55</td><td class="hits">1</td><td class="source">            if(err) return next(err);</td></tr><tr class="hit"><td class="line">56</td><td class="hits">1</td><td class="source">            res.send(resp);</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">60</td><td class="hits">1</td><td class="source">    var _remove = function(req, res, next) {</td></tr><tr class="hit"><td class="line">61</td><td class="hits">2</td><td class="source">        if(req.user.permissions.indexOf(&quot;remove_plans&quot;) &lt; 0 &amp;&amp; req.client.permissions.indexOf(&quot;remove_plans&quot;) &lt; 0) {</td></tr><tr class="hit"><td class="line">62</td><td class="hits">1</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to remove plans&quot;));</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">65</td><td class="hits">1</td><td class="source">        Plan.Model</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">            .findOne({id: req.params.id})</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">            .exec(function(err, plan){</td></tr><tr class="hit"><td class="line">68</td><td class="hits">1</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">70</td><td class="hits">1</td><td class="source">                if(!plan) return next(new restify.ResourceNotFoundError(&quot;Plan not found&quot;));</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">72</td><td class="hits">1</td><td class="source">                plan.remove(function(err, status){</td></tr><tr class="hit"><td class="line">73</td><td class="hits">1</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">75</td><td class="hits">1</td><td class="source">                    res.send(status);</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">80</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">        create: _create,</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">        get: _get,</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">        list: _list,</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">        remove: _remove</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">89</td><td class="hits">1</td><td class="source">module.exports = PlansController;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/controllers/reports.js">/Users/warner/code/clipppr/primeloop-api/controllers/reports.js</h2><div id="stats" class="terrible"><div class="percentage">6%</div><div class="sloc">188</div><div class="hits">13</div><div class="misses">175</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var ReportsController = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        Page = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/page&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        Notebook = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/notebook&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        ReportAdditions = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/report_additions&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        Clipp = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/clipp&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        PageEngagement = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/page_engagement&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        ArrayUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/array&quot;),</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        ObjectUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/objects&quot;),</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        URLUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/urls&quot;),</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        restify = require(&quot;restify&quot;),</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        moment = require('moment'),</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        restifyErrors = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/errors&quot;)(restify),</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        dateSorter = function(a,b){</td></tr><tr class="miss"><td class="line">17</td><td class="hits">0</td><td class="source">            return new Date(b).getTime() - new Date(a).getTime();</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">    var _articles = function(req, res, next) {</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">            notebook = req.params.notebook,</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">            start_date = req.params.start || new Date(Date.now() - 1000*60*60*24*30),</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">            end_date = req.params.end || new Date(Date.now());</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="source">        Clipp.Model.find({</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">            notebook: notebook,</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">            $or: [</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">                {published: {$gt: start_date, $lt: end_date}},</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">                {created: {$gt: start_date, $lt: end_date}, published: null},</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">                {&quot;engagement.points.lastPointIncrease&quot;: {$gt: start_date, $lt: end_date}}</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">            ]</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        })</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        .sort({clippRank: 1})</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">        .lean()</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        .exec(function(err, clipps){</td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">            if(err) return next(err);</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">            </td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">            var engagedWith = [];</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">            clipps = clipps.filter(function(clipp){</td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">                if( </td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">                    (</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">                        new Date(clipp.published).getTime() &gt; new Date(start_date).getTime() &amp;&amp; </td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">                        new Date(clipp.published).getTime() &lt; new Date(end_date).getTime() </td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">                    ) ||</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">                    (</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">                        new Date(clipp.created).getTime() &gt; new Date(start_date).getTime() &amp;&amp; </td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">                        new Date(clipp.created).getTime() &lt; new Date(end_date).getTime() &amp;&amp; </td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">                        !clipp.published </td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">                    ) </td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">                ){</td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">                    return clipp;</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">                    engagedWith.push(clipp);</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="source">            Notebook.Model</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">                .findOne({</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">                    _id: notebook</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">                .lean()</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">                .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">                    </td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="source">                    return _getAdditions(req.params.additions, function(err, additions){</td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">                        if(err) return next(err);</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="source">                        return res.send({</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">                            start: start_date, </td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">                            end: end_date,</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">                            notebook: notebook,</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">                            articles: clipps,</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">                            engagedArticles: engagedWith,</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">                            additions: additions</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">                </td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">        });    </td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">89</td><td class="hits">1</td><td class="source">    var _getAdditions = function(addition_ids, done) {</td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="source">        if(!addition_ids || addition_ids.length &lt;= 0) return process.nextTick(done);</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">        //TODO: Actually get up-to-date clipp information</td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="source">        ReportAdditions.Model</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">                _id: {$in: addition_ids}</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">            .exec(done);</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">101</td><td class="hits">1</td><td class="source">    var _engagedArticles = function(req, res, next) {</td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">            notebook = req.params.notebook,</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">            start_date = req.params.start_date || new Date(Date.now() - 1000*60*60*24*30),</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">            end_date = req.params.end_date || new Date(Date.now());</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="source">        console.log(start_date, end_date, notebook);</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="source">        Clipp.Model.find({</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">            notebook: notebook</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">        })</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">        .exec(function(err, clipps){</td></tr><tr class="miss"><td class="line">113</td><td class="hits">0</td><td class="source">            if(err) return next(err);</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="source">            return res.send({</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">                start_date: start_date, </td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">                end_date: end_date,</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">                notebook: notebook,</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">                articles: clipps</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">125</td><td class="hits">1</td><td class="source">    var _engagementByChannel = function(req, res, next) {</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">127</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">            notebook = req.params.notebook,</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">            start_date = req.params.start || new Date(Date.now() - 1000*60*60*24*30),</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">            end_date = req.params.end || new Date(Date.now()+1),</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">            interval = req.params.interval || 1000*60*60*24*7;</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">133</td><td class="hits">0</td><td class="source">        Clipp.Model.find({</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">            notebook: notebook</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">        })</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">        .lean()</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">        .exec(function(err, clipps){</td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="source">            if(err) return next(err);</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">140</td><td class="hits">0</td><td class="source">            var pages = ObjectUtils.toFlatArray(clipps, &quot;page&quot;);</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">142</td><td class="hits">0</td><td class="source">            Page.Model.find({</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">                _id: { $in: pages },</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">                &quot;engagement.points.lastPointIncrease&quot;: {$gt: start_date, $lt: end_date}</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">            }, &quot;engagementHistory created engagement&quot;)</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">            .exec(function(err, pages){</td></tr><tr class="miss"><td class="line">148</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">150</td><td class="hits">0</td><td class="source">                var </td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">                    pageEngagementsMatrix = ObjectUtils.toFlatArray(pages, &quot;engagementHistory&quot;),</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">                    pageEngagements = [];</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">                </td></tr><tr class="miss"><td class="line">154</td><td class="hits">0</td><td class="source">                for(var i = 0; i &lt; pageEngagementsMatrix.length; i++) {</td></tr><tr class="miss"><td class="line">155</td><td class="hits">0</td><td class="source">                    for(var j = 0; j &lt; pageEngagementsMatrix[i].length; j++){</td></tr><tr class="miss"><td class="line">156</td><td class="hits">0</td><td class="source">                        pageEngagements.push(pageEngagementsMatrix[i][j]);</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">160</td><td class="hits">0</td><td class="source">                pageEngagementsMatrix = null;</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">162</td><td class="hits">0</td><td class="source">                PageEngagement.Model.find({</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">                    _id: {$in: pageEngagements},</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">                    created: {$gt: start_date, $lt: end_date},</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">                    &quot;points.lastPointIncrease&quot;: {$gt: start_date, $lt: end_date}</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">                .sort({&quot;created&quot;: 1})</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">                .lean()</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">                .exec(function(err, pageEngagements){</td></tr><tr class="miss"><td class="line">170</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">172</td><td class="hits">0</td><td class="source">                    pageEnagements = pageEngagements.map(function(pe){</td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="source">                        var idx = -1;</td></tr><tr class="miss"><td class="line">174</td><td class="hits">0</td><td class="source">                        for(var p = 0; p &lt; pages.length; p++) {</td></tr><tr class="miss"><td class="line">175</td><td class="hits">0</td><td class="source">                            idx = ArrayUtils.inArray(pe._id, pages[p].engagementHistory);</td></tr><tr class="miss"><td class="line">176</td><td class="hits">0</td><td class="source">                            if(idx &lt; 0) continue;</td></tr><tr class="miss"><td class="line">177</td><td class="hits">0</td><td class="source">                            pe.page = pages[p]._id;</td></tr><tr class="miss"><td class="line">178</td><td class="hits">0</td><td class="source">                            return pe;</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">182</td><td class="hits">0</td><td class="source">                    var engagementBuckets = _groupByTime({</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">                        array: pageEngagements,</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">                        interval: interval,</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">                        start: start_date,</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">                        end: end_date,</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">                        field: &quot;created&quot;</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">                    //in each bucket</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">                    //pick lastest page engagement for each page (remove others)</td></tr><tr class="miss"><td class="line">192</td><td class="hits">0</td><td class="source">                    var engagementsByPage = {};</td></tr><tr class="miss"><td class="line">193</td><td class="hits">0</td><td class="source">                    for(var b = 0; b &lt; engagementBuckets.length; b++) {</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">195</td><td class="hits">0</td><td class="source">                        for(var d = 0; d &lt; engagementBuckets[b].data.length; d++){</td></tr><tr class="miss"><td class="line">196</td><td class="hits">0</td><td class="source">                            if(!engagementsByPage[engagementBuckets[b].data[d].page]){</td></tr><tr class="miss"><td class="line">197</td><td class="hits">0</td><td class="source">                                engagementsByPage[engagementBuckets[b].data[d].page] = [];</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">                            }</td></tr><tr class="miss"><td class="line">199</td><td class="hits">0</td><td class="source">                            engagementsByPage[engagementBuckets[b].data[d].page].push(engagementBuckets[b].data[d]);</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">                        </td></tr><tr class="miss"><td class="line">202</td><td class="hits">0</td><td class="source">                        engagementBuckets[b].data = [];</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">204</td><td class="hits">0</td><td class="source">                        for(var pg in engagementsByPage) {</td></tr><tr class="miss"><td class="line">205</td><td class="hits">0</td><td class="source">                            engagementsByPage[pg] = engagementsByPage[pg].sort(dateSorter);</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">207</td><td class="hits">0</td><td class="source">                            engagementBuckets[b].data.push(engagementsByPage[pg][0]);</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">211</td><td class="hits">0</td><td class="source">                    var sums = {}, engagement;</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">213</td><td class="hits">0</td><td class="source">                    for(var channel in PageEngagement.pointFilter){</td></tr><tr class="miss"><td class="line">214</td><td class="hits">0</td><td class="source">                        sums[PageEngagement.pointFilter[channel]] = 0;</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">217</td><td class="hits">0</td><td class="source">                    for(var j = 0; j &lt; engagementBuckets.length; j++) {</td></tr><tr class="miss"><td class="line">218</td><td class="hits">0</td><td class="source">                        for(var k = 0; k &lt; engagementBuckets[j].data.length; k++){</td></tr><tr class="miss"><td class="line">219</td><td class="hits">0</td><td class="source">                            engagement = engagementBuckets[j].data[k];</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">221</td><td class="hits">0</td><td class="source">                            for(var prop in sums){</td></tr><tr class="miss"><td class="line">222</td><td class="hits">0</td><td class="source">                                sums[prop] += engagement[prop] || 0;</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">226</td><td class="hits">0</td><td class="source">                        engagementBuckets[j].data = {};</td></tr><tr class="miss"><td class="line">227</td><td class="hits">0</td><td class="source">                        ObjectUtils.copyAllProperties(sums, engagementBuckets[j].data);</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">229</td><td class="hits">0</td><td class="source">                        for(var s in sums){</td></tr><tr class="miss"><td class="line">230</td><td class="hits">0</td><td class="source">                            sums[s] = 0;</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">                    }  </td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">235</td><td class="hits">0</td><td class="source">                    return res.send({</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source">                        engagements: engagementBuckets, </td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source">                        start: start_date,</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">                        end: end_date</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">243</td><td class="hits"></td><td class="source">        });    </td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">246</td><td class="hits">1</td><td class="source">    var _engagementTotal = function(req, res, next) {</td></tr><tr class="miss"><td class="line">247</td><td class="hits">0</td><td class="source">        return res.send({message: &quot;Not yet implemented&quot;});</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">251</td><td class="hits">1</td><td class="source">    var _averageEngagementByDomain = function(req, res, next) {</td></tr><tr class="miss"><td class="line">252</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">253</td><td class="hits"></td><td class="source">            notebook = req.params.notebook,</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source">            start_date = req.params.start || new Date(Date.now() - 1000*60*60*24*30),</td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">            end_date = req.params.end || new Date(Date.now()),</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source">            interval = req.params.interval || 1000*60*60*24*7;</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">258</td><td class="hits">0</td><td class="source">        Clipp.Model.find({</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source">            notebook: notebook</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source">        })</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source">        .lean()</td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source">        .exec(function(err, clipps){</td></tr><tr class="miss"><td class="line">263</td><td class="hits">0</td><td class="source">            if(err) return next(err);</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">265</td><td class="hits">0</td><td class="source">            var pages = ObjectUtils.toFlatArray(clipps, &quot;page&quot;);</td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">267</td><td class="hits">0</td><td class="source">            Page.Model.find({</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source">                _id: { $in: pages },</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">                &quot;engagement.points.lastPointIncrease&quot;: {$gt: start_date, $lt: end_date}</td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source">            }, &quot;engagementHistory created engagement url&quot;)</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">272</td><td class="hits"></td><td class="source">            .exec(function(err, pages){</td></tr><tr class="miss"><td class="line">273</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">275</td><td class="hits">0</td><td class="source">                var </td></tr><tr><td class="line">276</td><td class="hits"></td><td class="source">                    pageEngagementsMatrix = ObjectUtils.toFlatArray(pages, &quot;engagementHistory&quot;),</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source">                    pageEngagements = [];</td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source">                </td></tr><tr class="miss"><td class="line">279</td><td class="hits">0</td><td class="source">                for(var i = 0; i &lt; pageEngagementsMatrix.length; i++) {</td></tr><tr class="miss"><td class="line">280</td><td class="hits">0</td><td class="source">                    for(var j = 0; j &lt; pageEngagementsMatrix[i].length; j++){</td></tr><tr class="miss"><td class="line">281</td><td class="hits">0</td><td class="source">                        pageEngagements.push(pageEngagementsMatrix[i][j]);</td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">285</td><td class="hits">0</td><td class="source">                pageEngagementsMatrix = null;</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">287</td><td class="hits">0</td><td class="source">                PageEngagement.Model.find({</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">                    _id: {$in: pageEngagements},</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source">                    created: {$gt: start_date, $lt: end_date},</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source">                    &quot;points.lastPointIncrease&quot;: {$gt: start_date, $lt: end_date}</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">292</td><td class="hits"></td><td class="source">                .sort({&quot;created&quot;: 1})</td></tr><tr><td class="line">293</td><td class="hits"></td><td class="source">                .lean()</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source">                .exec(function(err, pageEngagements){</td></tr><tr class="miss"><td class="line">295</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">296</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">297</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">298</td><td class="hits"></td><td class="source">                    //Attach domain to the page engagements</td></tr><tr class="miss"><td class="line">299</td><td class="hits">0</td><td class="source">                    var idx;</td></tr><tr class="miss"><td class="line">300</td><td class="hits">0</td><td class="source">                    for(var k = 0; k &lt; pages.length; k++) {</td></tr><tr class="miss"><td class="line">301</td><td class="hits">0</td><td class="source">                        for(var j = 0; j &lt; pageEngagements.length; j++) {</td></tr><tr class="miss"><td class="line">302</td><td class="hits">0</td><td class="source">                            idx = ArrayUtils.inArray(pageEngagements[j]._id, pages[k].engagementHistory);</td></tr><tr class="miss"><td class="line">303</td><td class="hits">0</td><td class="source">                            if(idx &gt;= 0 &amp;&amp; pages[k].url)  {</td></tr><tr class="miss"><td class="line">304</td><td class="hits">0</td><td class="source">                                pages[k].domain = pageEngagements[j].domain = URLUtils.getNakedDomain(pages[k].url); </td></tr><tr class="miss"><td class="line">305</td><td class="hits">0</td><td class="source">                                pageEngagements[j].page = pages[k]._id;</td></tr><tr><td class="line">306</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">307</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">308</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">309</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">310</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">311</td><td class="hits">0</td><td class="source">                    var </td></tr><tr><td class="line">312</td><td class="hits"></td><td class="source">                        topDomains = _sumByDomain(pageEngagements);</td></tr><tr><td class="line">313</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source">                    //Get the top X domains</td></tr><tr class="miss"><td class="line">315</td><td class="hits">0</td><td class="source">                    topDomains.sort(function(a,b){ return b.points - a.points; });</td></tr><tr class="miss"><td class="line">316</td><td class="hits">0</td><td class="source">                    topDomains = topDomains.splice(0,req.params.domains || 5);</td></tr><tr><td class="line">317</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">318</td><td class="hits">0</td><td class="source">                    pageEngagements = pageEngagements.filter(function(item){</td></tr><tr class="miss"><td class="line">319</td><td class="hits">0</td><td class="source">                        return (ArrayUtils.inArray(item.domain, topDomains, &quot;domain&quot;) &gt;= 0);</td></tr><tr><td class="line">320</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">321</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">322</td><td class="hits">0</td><td class="source">                    pages = pages.filter(function(page){</td></tr><tr class="miss"><td class="line">323</td><td class="hits">0</td><td class="source">                        return (ArrayUtils.inArray(URLUtils.getNakedDomain(page.url), topDomains, &quot;domain&quot;) &gt;= 0);</td></tr><tr><td class="line">324</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">325</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">326</td><td class="hits">0</td><td class="source">                    for(var p = 0; p &lt; pages.length; p++) {</td></tr><tr class="miss"><td class="line">327</td><td class="hits">0</td><td class="source">                        idx = ArrayUtils.inArray(pages[p].domain, topDomains, &quot;domain&quot;);</td></tr><tr class="miss"><td class="line">328</td><td class="hits">0</td><td class="source">                        if(idx &lt; 0) continue;</td></tr><tr class="miss"><td class="line">329</td><td class="hits">0</td><td class="source">                        if(!topDomains[idx].pages) topDomains[idx].pages = 0;</td></tr><tr class="miss"><td class="line">330</td><td class="hits">0</td><td class="source">                        topDomains[idx].pages++;</td></tr><tr><td class="line">331</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">332</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">333</td><td class="hits">0</td><td class="source">                    pageEngagements = pageEngagements.map(function(item){</td></tr><tr class="miss"><td class="line">334</td><td class="hits">0</td><td class="source">                        var indx = ArrayUtils.inArray(item.domain, topDomains, &quot;domain&quot;);</td></tr><tr class="miss"><td class="line">335</td><td class="hits">0</td><td class="source">                        if(indx &gt; -1) item.points.current = item.points.current / topDomains[indx].pages;</td></tr><tr class="miss"><td class="line">336</td><td class="hits">0</td><td class="source">                        return item;</td></tr><tr><td class="line">337</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">338</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">339</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">340</td><td class="hits">0</td><td class="source">                    var engagementBuckets = _groupByTime({</td></tr><tr><td class="line">341</td><td class="hits"></td><td class="source">                        array: pageEngagements,</td></tr><tr><td class="line">342</td><td class="hits"></td><td class="source">                        interval: interval,</td></tr><tr><td class="line">343</td><td class="hits"></td><td class="source">                        start: start_date,</td></tr><tr><td class="line">344</td><td class="hits"></td><td class="source">                        end: end_date,</td></tr><tr><td class="line">345</td><td class="hits"></td><td class="source">                        field: &quot;created&quot;</td></tr><tr><td class="line">346</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">347</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">348</td><td class="hits"></td><td class="source">                    //in each bucket</td></tr><tr><td class="line">349</td><td class="hits"></td><td class="source">                    //pick lastest page engagement for each page (remove others)</td></tr><tr class="miss"><td class="line">350</td><td class="hits">0</td><td class="source">                    var engagementsByPage = {};</td></tr><tr class="miss"><td class="line">351</td><td class="hits">0</td><td class="source">                    for(var b = 0; b &lt; engagementBuckets.length; b++) {</td></tr><tr><td class="line">352</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">353</td><td class="hits">0</td><td class="source">                        for(var d = 0; d &lt; engagementBuckets[b].data.length; d++){</td></tr><tr class="miss"><td class="line">354</td><td class="hits">0</td><td class="source">                            if(!engagementsByPage[engagementBuckets[b].data[d].page]){</td></tr><tr class="miss"><td class="line">355</td><td class="hits">0</td><td class="source">                                engagementsByPage[engagementBuckets[b].data[d].page] = [];</td></tr><tr><td class="line">356</td><td class="hits"></td><td class="source">                            }</td></tr><tr class="miss"><td class="line">357</td><td class="hits">0</td><td class="source">                            engagementsByPage[engagementBuckets[b].data[d].page].push(engagementBuckets[b].data[d]);</td></tr><tr><td class="line">358</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">359</td><td class="hits"></td><td class="source">                        </td></tr><tr class="miss"><td class="line">360</td><td class="hits">0</td><td class="source">                        engagementBuckets[b].data = [];</td></tr><tr><td class="line">361</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">362</td><td class="hits">0</td><td class="source">                        for(var pg in engagementsByPage) {</td></tr><tr class="miss"><td class="line">363</td><td class="hits">0</td><td class="source">                            engagementsByPage[pg] = engagementsByPage[pg].sort(dateSorter);</td></tr><tr class="miss"><td class="line">364</td><td class="hits">0</td><td class="source">                            engagementBuckets[b].data.push(engagementsByPage[pg][0]);</td></tr><tr><td class="line">365</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">366</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">367</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">368</td><td class="hits">0</td><td class="source">                    var pointSorter = function(a, b){</td></tr><tr class="miss"><td class="line">369</td><td class="hits">0</td><td class="source">                        return b.points - a.points;</td></tr><tr><td class="line">370</td><td class="hits"></td><td class="source">                    };</td></tr><tr><td class="line">371</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">372</td><td class="hits">0</td><td class="source">                    for(var s = 0; s &lt; engagementBuckets.length; s++){</td></tr><tr class="miss"><td class="line">373</td><td class="hits">0</td><td class="source">                        engagementBuckets[s].data = _sumByDomain(engagementBuckets[s].data); </td></tr><tr class="miss"><td class="line">374</td><td class="hits">0</td><td class="source">                        engagementBuckets[s].data.sort(pointSorter); </td></tr><tr><td class="line">375</td><td class="hits"></td><td class="source">                    } </td></tr><tr><td class="line">376</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">377</td><td class="hits">0</td><td class="source">                    return res.send({</td></tr><tr><td class="line">378</td><td class="hits"></td><td class="source">                        engagements: engagementBuckets, </td></tr><tr><td class="line">379</td><td class="hits"></td><td class="source">                        domains: topDomains,</td></tr><tr><td class="line">380</td><td class="hits"></td><td class="source">                        start: start_date,</td></tr><tr><td class="line">381</td><td class="hits"></td><td class="source">                        end: end_date</td></tr><tr><td class="line">382</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">383</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">384</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">385</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">386</td><td class="hits"></td><td class="source">        });    </td></tr><tr><td class="line">387</td><td class="hits"></td><td class="source">    };  </td></tr><tr><td class="line">388</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">389</td><td class="hits">1</td><td class="source">    var _sumByDomain = function(pageEngagements) {</td></tr><tr class="miss"><td class="line">390</td><td class="hits">0</td><td class="source">        var domains = {}, domain, sums = {}, engagement;</td></tr><tr><td class="line">391</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">392</td><td class="hits">0</td><td class="source">        for(var channel in PageEngagement.pointFilter){</td></tr><tr class="miss"><td class="line">393</td><td class="hits">0</td><td class="source">            sums[PageEngagement.pointFilter[channel]] = 0;</td></tr><tr><td class="line">394</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">395</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">396</td><td class="hits">0</td><td class="source">        for(var i = 0; i &lt; pageEngagements.length; i++) {</td></tr><tr><td class="line">397</td><td class="hits"></td><td class="source">            </td></tr><tr class="miss"><td class="line">398</td><td class="hits">0</td><td class="source">            engagement = pageEngagements[i];</td></tr><tr class="miss"><td class="line">399</td><td class="hits">0</td><td class="source">            domain = engagement.domain; </td></tr><tr><td class="line">400</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">401</td><td class="hits">0</td><td class="source">            if(!domains[domain]) {</td></tr><tr class="miss"><td class="line">402</td><td class="hits">0</td><td class="source">                domains[domain] = {</td></tr><tr><td class="line">403</td><td class="hits"></td><td class="source">                    points: 0,</td></tr><tr><td class="line">404</td><td class="hits"></td><td class="source">                    domain: domain</td></tr><tr><td class="line">405</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">406</td><td class="hits"></td><td class="source">                // ObjectUtils.copyAllProperties(sums, domains[domain]);</td></tr><tr><td class="line">407</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">408</td><td class="hits"></td><td class="source">            </td></tr><tr class="miss"><td class="line">409</td><td class="hits">0</td><td class="source">            domains[domain].points = engagement.points.current;</td></tr><tr><td class="line">410</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">411</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">412</td><td class="hits">0</td><td class="source">        var arr = [];</td></tr><tr class="miss"><td class="line">413</td><td class="hits">0</td><td class="source">        for(var d in domains) {</td></tr><tr class="miss"><td class="line">414</td><td class="hits">0</td><td class="source">            arr.push(domains[d]);</td></tr><tr><td class="line">415</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">416</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">417</td><td class="hits">0</td><td class="source">        return arr;</td></tr><tr><td class="line">418</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">419</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">420</td><td class="hits">1</td><td class="source">    var _groupByTime = function(opts) {</td></tr><tr><td class="line">421</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">422</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">423</td><td class="hits"></td><td class="source">            array = opts.array,</td></tr><tr><td class="line">424</td><td class="hits"></td><td class="source">            interval = opts.interval,</td></tr><tr><td class="line">425</td><td class="hits"></td><td class="source">            field = opts.field;</td></tr><tr><td class="line">426</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">427</td><td class="hits">0</td><td class="source">        if(array.length &lt; 1) return array;</td></tr><tr><td class="line">428</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">429</td><td class="hits">0</td><td class="source">        array = array.sort(function(a, b){</td></tr><tr class="miss"><td class="line">430</td><td class="hits">0</td><td class="source">            return new Date(a[field]).getTime() - new Date(b[field]).getTime();</td></tr><tr><td class="line">431</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">432</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">433</td><td class="hits"></td><td class="source">        // console.log(&quot;array sort checksum:&quot;,require(&quot;crypto&quot;).createHash('md5').update(JSON.stringify(array)).digest(&quot;hex&quot;));</td></tr><tr><td class="line">434</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">435</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">436</td><td class="hits"></td><td class="source">            start = new Date(opts.start).getTime() || new Date(array[0][field]).getTime(),</td></tr><tr><td class="line">437</td><td class="hits"></td><td class="source">            end = new Date(opts.end).getTime() || new Date(array[array.length-1][field]).getTime(),</td></tr><tr><td class="line">438</td><td class="hits"></td><td class="source">            buckets = [];</td></tr><tr><td class="line">439</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">440</td><td class="hits">0</td><td class="source">        for(var d = end; d-interval &gt;= start; d-=interval) {</td></tr><tr class="miss"><td class="line">441</td><td class="hits">0</td><td class="source">            buckets.push({</td></tr><tr><td class="line">442</td><td class="hits"></td><td class="source">                interval: {</td></tr><tr><td class="line">443</td><td class="hits"></td><td class="source">                    from: d,</td></tr><tr><td class="line">444</td><td class="hits"></td><td class="source">                    to: d-interval</td></tr><tr><td class="line">445</td><td class="hits"></td><td class="source">                },</td></tr><tr><td class="line">446</td><td class="hits"></td><td class="source">                data: []</td></tr><tr><td class="line">447</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">448</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">449</td><td class="hits">0</td><td class="source">        buckets.reverse();</td></tr><tr><td class="line">450</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">451</td><td class="hits">0</td><td class="source">        var time;</td></tr><tr><td class="line">452</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">453</td><td class="hits">0</td><td class="source">        for(var i in array) {</td></tr><tr class="miss"><td class="line">454</td><td class="hits">0</td><td class="source">            time = new Date(array[i][field]).getTime();</td></tr><tr class="miss"><td class="line">455</td><td class="hits">0</td><td class="source">            for(var b in buckets) {</td></tr><tr class="miss"><td class="line">456</td><td class="hits">0</td><td class="source">                if(</td></tr><tr><td class="line">457</td><td class="hits"></td><td class="source">                    time &gt;= buckets[b].interval.to &amp;&amp; </td></tr><tr><td class="line">458</td><td class="hits"></td><td class="source">                    time &lt; buckets[b].interval.from</td></tr><tr><td class="line">459</td><td class="hits"></td><td class="source">                ) {</td></tr><tr class="miss"><td class="line">460</td><td class="hits">0</td><td class="source">                    buckets[b].data.push(array[i]);</td></tr><tr><td class="line">461</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">462</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">463</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">464</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">465</td><td class="hits">0</td><td class="source">        return buckets;</td></tr><tr><td class="line">466</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">467</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">468</td><td class="hits">1</td><td class="source">    var _articleCount = function(req, res, next) {</td></tr><tr class="miss"><td class="line">469</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">470</td><td class="hits"></td><td class="source">            notebook = req.params.notebook;</td></tr><tr><td class="line">471</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">472</td><td class="hits">0</td><td class="source">        Clipp.Model.find({</td></tr><tr><td class="line">473</td><td class="hits"></td><td class="source">            notebook: notebook,</td></tr><tr><td class="line">474</td><td class="hits"></td><td class="source">        })</td></tr><tr><td class="line">475</td><td class="hits"></td><td class="source">        .sort({published: -1})</td></tr><tr><td class="line">476</td><td class="hits"></td><td class="source">        .lean()</td></tr><tr><td class="line">477</td><td class="hits"></td><td class="source">        .exec(function(err, clipps){</td></tr><tr><td class="line">478</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">479</td><td class="hits"></td><td class="source">            //sort these first</td></tr><tr class="miss"><td class="line">480</td><td class="hits">0</td><td class="source">            clipps = clipps.sort(function(a, b){</td></tr><tr class="miss"><td class="line">481</td><td class="hits">0</td><td class="source">                if(b.published &amp;&amp; a.published) {</td></tr><tr class="miss"><td class="line">482</td><td class="hits">0</td><td class="source">                    return new Date(b.published).getTime() - new Date(a.published).getTime();</td></tr><tr class="miss"><td class="line">483</td><td class="hits">0</td><td class="source">                } else if (b.published &amp;&amp; a.created) {</td></tr><tr class="miss"><td class="line">484</td><td class="hits">0</td><td class="source">                    return new Date(b.published).getTime() - new Date(a.created).getTime();</td></tr><tr class="miss"><td class="line">485</td><td class="hits">0</td><td class="source">                } else if(b.created &amp;&amp; a.published) {</td></tr><tr class="miss"><td class="line">486</td><td class="hits">0</td><td class="source">                    return new Date(b.created).getTime() - new Date(a.published).getTime();</td></tr><tr class="miss"><td class="line">487</td><td class="hits">0</td><td class="source">                } else if(b.created &amp;&amp; a.created) {</td></tr><tr class="miss"><td class="line">488</td><td class="hits">0</td><td class="source">                    return new Date(b.created).getTime() - new Date(a.created).getTime();</td></tr><tr><td class="line">489</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">490</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">491</td><td class="hits"></td><td class="source">            //we need to group these by date and count them to return back the counts per month/year combo</td></tr><tr><td class="line">492</td><td class="hits"></td><td class="source">            //grab the first one</td></tr><tr class="miss"><td class="line">493</td><td class="hits">0</td><td class="source">            var firstDate = moment();</td></tr><tr class="miss"><td class="line">494</td><td class="hits">0</td><td class="source">            var monthYearMap = {};</td></tr><tr class="miss"><td class="line">495</td><td class="hits">0</td><td class="source">            var currentYear = firstDate.year();</td></tr><tr class="miss"><td class="line">496</td><td class="hits">0</td><td class="source">            var currentMonth = firstDate.month();</td></tr><tr class="miss"><td class="line">497</td><td class="hits">0</td><td class="source">            for(var i = 0; i &lt; clipps.length; i++) {</td></tr><tr class="miss"><td class="line">498</td><td class="hits">0</td><td class="source">                var clipp = clipps[i];</td></tr><tr class="miss"><td class="line">499</td><td class="hits">0</td><td class="source">                var date = null;</td></tr><tr class="miss"><td class="line">500</td><td class="hits">0</td><td class="source">                if(clipp.published) {</td></tr><tr class="miss"><td class="line">501</td><td class="hits">0</td><td class="source">                    date = moment(clipp.published);</td></tr><tr><td class="line">502</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="miss"><td class="line">503</td><td class="hits">0</td><td class="source">                    date = moment(clipp.created);</td></tr><tr><td class="line">504</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">505</td><td class="hits">0</td><td class="source">                var key = date.year() + '-' + (date.month()+1);</td></tr><tr class="miss"><td class="line">506</td><td class="hits">0</td><td class="source">                if(monthYearMap[key]) {</td></tr><tr class="miss"><td class="line">507</td><td class="hits">0</td><td class="source">                    var count = monthYearMap[key].count;</td></tr><tr class="miss"><td class="line">508</td><td class="hits">0</td><td class="source">                    count++;</td></tr><tr class="miss"><td class="line">509</td><td class="hits">0</td><td class="source">                    monthYearMap[key].count = count;</td></tr><tr><td class="line">510</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="miss"><td class="line">511</td><td class="hits">0</td><td class="source">                    monthYearMap[key] = {count:1, label: date.format(&quot;MMM, YYYY&quot;), key:key};</td></tr><tr><td class="line">512</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">513</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">514</td><td class="hits">0</td><td class="source">            return res.send({</td></tr><tr><td class="line">515</td><td class="hits"></td><td class="source">                ranges: monthYearMap</td></tr><tr><td class="line">516</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">517</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">518</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">519</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">520</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">521</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">522</td><td class="hits"></td><td class="source">        articles: _articles,</td></tr><tr><td class="line">523</td><td class="hits"></td><td class="source">        engagementByChannel: _engagementByChannel,</td></tr><tr><td class="line">524</td><td class="hits"></td><td class="source">        averageEngagementByDomain: _averageEngagementByDomain,</td></tr><tr><td class="line">525</td><td class="hits"></td><td class="source">        engagementTotal: _engagementTotal,</td></tr><tr><td class="line">526</td><td class="hits"></td><td class="source">        articleCount: _articleCount</td></tr><tr><td class="line">527</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">528</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">529</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">530</td><td class="hits">1</td><td class="source">module.exports = ReportsController;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/controllers/stats.js">/Users/warner/code/clipppr/primeloop-api/controllers/stats.js</h2><div id="stats" class="medium"><div class="percentage">52%</div><div class="sloc">404</div><div class="hits">213</div><div class="misses">191</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var StatsController = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        restify = require(&quot;restify&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        moment = require(&quot;moment&quot;);</td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">        ArrayUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/array&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        JSONUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/json&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        _ = require(&quot;underscore&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        User = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/user&quot;).Model,</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        TrackingUrl = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/tracking_url&quot;).Model,</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        Campaign = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/notebook&quot;),</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        TrackingPage = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/tracking_page&quot;).Model,</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        TrackingUrlActivity = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/tracking_url_activity&quot;).Model;</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">17</td><td class="hits">1</td><td class="source">    var _teamStats = function(req, res, next) {</td></tr><tr class="hit"><td class="line">18</td><td class="hits">5</td><td class="source">        var filter = req.params.filter || {};</td></tr><tr class="hit"><td class="line">19</td><td class="hits">5</td><td class="source">        var stats_summary = {</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">            total_shared: 0,</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">            total_clicks: 0,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">            top_links: [],</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">            user_top_links: [],</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">            user_summary: {</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">                total_clicks: 0,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">                total_shares: 0,</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">            active_campaigns: false</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        };</td></tr><tr class="hit"><td class="line">30</td><td class="hits">5</td><td class="source">        var team_stats = [];</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        //Data structure that we return should look something like:</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        //stats_summary: {total_shared:xx, total_clicks:xx, top_links:[{url:url, title:title, clicks:xx, shared:date, users:[name:name, etc.]}]}</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        //team_stats:[{user: user_id, total_shared:xxx, total_clicked:xx, top_links:[{url:url, title:title, clicks:xx, shared:date}]}]</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">36</td><td class="hits">5</td><td class="source">        var team = [];</td></tr><tr class="hit"><td class="line">37</td><td class="hits">5</td><td class="source">        var teamIds = [];</td></tr><tr class="hit"><td class="line">38</td><td class="hits">5</td><td class="source">        var trackingUrls = [];</td></tr><tr class="hit"><td class="line">39</td><td class="hits">5</td><td class="source">        var trackingIds = [];</td></tr><tr class="hit"><td class="line">40</td><td class="hits">5</td><td class="source">        var trackingPromise;</td></tr><tr class="hit"><td class="line">41</td><td class="hits">5</td><td class="source">        var trackingAggregateUserTotalClickPromise;</td></tr><tr class="hit"><td class="line">42</td><td class="hits">5</td><td class="source">        var trackingAggregateTotalClickPromise;</td></tr><tr class="hit"><td class="line">43</td><td class="hits">5</td><td class="source">        var trackingAggregateSumClickPromise;</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">45</td><td class="hits">5</td><td class="source">        var query = {</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">            &quot;users.user&quot;: {</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">                $in:[req.user._id]</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">        };</td></tr><tr class="hit"><td class="line">50</td><td class="hits">5</td><td class="source">        var newFilter = JSONUtils.tryParseJSON(filter);</td></tr><tr class="hit"><td class="line">51</td><td class="hits">5</td><td class="source">        if(newFilter !== false) {</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">            filter = newFilter;</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">54</td><td class="hits">5</td><td class="source">        if(filter) {</td></tr><tr class="hit"><td class="line">55</td><td class="hits">5</td><td class="source">            if(filter.users) {</td></tr><tr class="hit"><td class="line">56</td><td class="hits">1</td><td class="source">                query[&quot;users.user&quot;] = {</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">                    $in:filter.users</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">60</td><td class="hits">5</td><td class="source">            if(filter.campaigns) {</td></tr><tr class="hit"><td class="line">61</td><td class="hits">1</td><td class="source">                query._id = {</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">                    $in: filter.campaigns</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">66</td><td class="hits">5</td><td class="source">        var promise =</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">            Campaign.Model</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">                .find(query)</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">                .populate(&quot;users.user&quot;, &quot;firstName lastName email trial trialStart gravatarHash&quot;)</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">                .exec();</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">72</td><td class="hits">5</td><td class="source">        promise.then(function(campaigns){</td></tr><tr class="hit"><td class="line">73</td><td class="hits">5</td><td class="source">            if(!campaigns || campaigns.length === 0) {</td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="source">                stats_summary.team_stats = team_stats;</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">                </td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="source">                throw new Error('abort promise chain');</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">                // return res.send(stats_summary);</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">            //this gives me all the campaigns a user is a part of</td></tr><tr class="hit"><td class="line">80</td><td class="hits">5</td><td class="source">            for(var i = 0; i &lt; campaigns.length; i++) {</td></tr><tr class="hit"><td class="line">81</td><td class="hits">13</td><td class="source">                var campaign = campaigns[i];</td></tr><tr class="hit"><td class="line">82</td><td class="hits">13</td><td class="source">                if(campaign.enabled === true) {</td></tr><tr class="hit"><td class="line">83</td><td class="hits">13</td><td class="source">                    stats_summary.active_campaigns = true;</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">                }</td></tr><tr class="hit"><td class="line">85</td><td class="hits">13</td><td class="source">                for(var j = 0; j &lt; campaign.users.length; j++) {</td></tr><tr class="hit"><td class="line">86</td><td class="hits">14</td><td class="source">                    if(filter.users) {</td></tr><tr class="hit"><td class="line">87</td><td class="hits">3</td><td class="source">                        if(campaign.users[j].user &amp;&amp; campaign.users[j].user) {</td></tr><tr class="hit"><td class="line">88</td><td class="hits">3</td><td class="source">                            var found = _.findWhere(filter.users, campaign.users[j].user._id);</td></tr><tr class="hit"><td class="line">89</td><td class="hits">3</td><td class="source">                            if(found) {</td></tr><tr class="hit"><td class="line">90</td><td class="hits">3</td><td class="source">                                team.push(campaign.users[j]);</td></tr><tr class="hit"><td class="line">91</td><td class="hits">3</td><td class="source">                                teamIds.push(campaign.users[j].user._id); </td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">                    } else {</td></tr><tr class="hit"><td class="line">95</td><td class="hits">11</td><td class="source">                       if(campaign.users[j].user) {</td></tr><tr class="hit"><td class="line">96</td><td class="hits">11</td><td class="source">                            team.push(campaign.users[j]);</td></tr><tr class="hit"><td class="line">97</td><td class="hits">11</td><td class="source">                            teamIds.push(campaign.users[j].user._id);</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">                        } </td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">                    </td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">                    </td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">104</td><td class="hits">5</td><td class="source">            team = ArrayUtils.uniqueArray(team);</td></tr><tr class="hit"><td class="line">105</td><td class="hits">5</td><td class="source">            teamIds = ArrayUtils.uniqueArray(teamIds);</td></tr><tr class="hit"><td class="line">106</td><td class="hits">5</td><td class="source">            promise.complete();</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">        }).then(function() {</td></tr><tr class="hit"><td class="line">108</td><td class="hits">5</td><td class="source">            var trackingQuery = {</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">                user: {</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">                    $in:teamIds</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">            };</td></tr><tr class="hit"><td class="line">113</td><td class="hits">5</td><td class="source">            if(filter.campaigns) {</td></tr><tr class="hit"><td class="line">114</td><td class="hits">1</td><td class="source">                trackingQuery.campaign = {</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">                    $in: filter.campaigns</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">118</td><td class="hits">5</td><td class="source">            if(filter.date_range) {</td></tr><tr class="hit"><td class="line">119</td><td class="hits">1</td><td class="source">                trackingQuery.created = {</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">                    &quot;$gte&quot;: moment(filter.date_range.from).toDate(), </td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">                    &quot;$lte&quot;: moment(filter.date_range.to).toDate()</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">124</td><td class="hits">5</td><td class="source">            trackingPromise =</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">                TrackingUrl</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">                    .find(trackingQuery)</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">                    .populate(&quot;trackingPage&quot;, &quot;title url&quot;)</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">                    .populate(&quot;user&quot;, &quot;firstName lastName email trial trialStart gravatarHash&quot;)</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">                    .exec();</td></tr><tr class="hit"><td class="line">130</td><td class="hits">5</td><td class="source">            return trackingPromise;</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">        }).then(function(urls){</td></tr><tr class="hit"><td class="line">132</td><td class="hits">5</td><td class="source">            if(!urls || urls.length === 0) {</td></tr><tr class="hit"><td class="line">133</td><td class="hits">1</td><td class="source">                stats_summary.team_stats = team_stats;</td></tr><tr class="hit"><td class="line">134</td><td class="hits">1</td><td class="source">                throw new Error('abort promise chain');</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">                // return res.send(stats_summary);</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">137</td><td class="hits">4</td><td class="source">            stats_summary.total_shared = urls.length;</td></tr><tr class="hit"><td class="line">138</td><td class="hits">4</td><td class="source">            for(var k = 0; k &lt; urls.length; k++){</td></tr><tr class="hit"><td class="line">139</td><td class="hits">72</td><td class="source">                trackingUrls.push(urls[k]);</td></tr><tr class="hit"><td class="line">140</td><td class="hits">72</td><td class="source">                trackingIds.push(urls[k]._id);</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">142</td><td class="hits">4</td><td class="source">            trackingPromise.complete();</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">        }).then(function(){</td></tr><tr class="hit"><td class="line">144</td><td class="hits">4</td><td class="source">            trackingAggregateTotalClickPromise =</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">                TrackingUrlActivity</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">                    .aggregate(</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">                        [{</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source">                            $match: {</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">                                trackingId: {</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">                                    $in:trackingIds</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">                                },</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">                                isBot:false</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">                        },</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">                        {</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">                            $group: {</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">                                _id: '$trackingId',</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">                                clicks: {$sum:1}</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">                        }]</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">                    )</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">                    .sort({&quot;clicks&quot;: -1})</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">                    .exec();</td></tr><tr class="hit"><td class="line">164</td><td class="hits">4</td><td class="source">            return trackingAggregateTotalClickPromise;</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">        }).then(function(activities){</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">            //now we need to match up ids and populate the rest of the object</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">            //top_links:[{url:url, title:title, clicks:xx, shared:date, users:[name:name, etc.]}]</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">            //loop through sorted activites list and populate from there</td></tr><tr class="hit"><td class="line">170</td><td class="hits">4</td><td class="source">            if(trackingUrls &amp;&amp; trackingUrls.length &gt; 0) {</td></tr><tr class="hit"><td class="line">171</td><td class="hits">4</td><td class="source">                var tracking;</td></tr><tr class="hit"><td class="line">172</td><td class="hits">4</td><td class="source">                var urlIdx = -1;</td></tr><tr class="hit"><td class="line">173</td><td class="hits">4</td><td class="source">                for(var i = 0; i &lt; trackingUrls.length; i++) {</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">                    // console.log(&quot;should be pushing data %s, %s&quot;,activities[i]._id, activities[i].clicks);</td></tr><tr class="hit"><td class="line">175</td><td class="hits">72</td><td class="source">                    tracking = trackingUrls[i];</td></tr><tr class="hit"><td class="line">176</td><td class="hits">72</td><td class="source">                    urlIdx = ArrayUtils.inArray(tracking._id, activities, &quot;_id&quot;);</td></tr><tr class="hit"><td class="line">177</td><td class="hits">72</td><td class="source">                    var obj = {</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">                        id: tracking._id,</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">                        url:tracking.url,</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">                        title: tracking.url,</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">                        clicks: 0,</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">                        created:tracking.created,</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">                        createdFormatted: moment(tracking.created).fromNow(),</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">                        users:[tracking.user],</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">                        trackingPage: 0</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">                    };</td></tr><tr class="hit"><td class="line">187</td><td class="hits">72</td><td class="source">                    if(tracking.trackingPage) {</td></tr><tr class="hit"><td class="line">188</td><td class="hits">72</td><td class="source">                        obj.trackingPage = tracking.trackingPage._id;</td></tr><tr class="hit"><td class="line">189</td><td class="hits">72</td><td class="source">                        obj.title = tracking.trackingPage.title;</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="hit"><td class="line">191</td><td class="hits">72</td><td class="source">                    if(urlIdx &gt;= 0) {</td></tr><tr class="hit"><td class="line">192</td><td class="hits">70</td><td class="source">                        obj.clicks = activities[urlIdx].clicks;</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="hit"><td class="line">194</td><td class="hits">72</td><td class="source">                    stats_summary.top_links.push(obj);</td></tr><tr class="hit"><td class="line">195</td><td class="hits">72</td><td class="source">                    addIncrementUserShares(obj.users[0], obj.clicks);</td></tr><tr class="hit"><td class="line">196</td><td class="hits">72</td><td class="source">                    if(obj.users[0]._id == req.user._id) {</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">                        // addTopLink(obj);</td></tr><tr class="hit"><td class="line">198</td><td class="hits">51</td><td class="source">                        stats_summary.user_top_links.push(obj);</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="hit"><td class="line">200</td><td class="hits">72</td><td class="source">                    urlIdx = -1;</td></tr><tr class="hit"><td class="line">201</td><td class="hits">72</td><td class="source">                    tracking = null;</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">205</td><td class="hits">4</td><td class="source">            trackingAggregateSumClickPromise =</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source">                TrackingUrlActivity</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">                    .aggregate(</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">                        [{</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source">                            $match: {</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">                                trackingId: {</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">                                    $in:trackingIds</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">                                },</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source">                                isBot:false</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">                        },</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">                        {</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">                            $group: {</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">                                _id: null,</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source">                                total_clicks: {$sum:1}</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source">                        }]</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">                    )</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">                    .exec();</td></tr><tr class="hit"><td class="line">224</td><td class="hits">4</td><td class="source">            return trackingAggregateSumClickPromise;</td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source">        }).then(function(sumActivities){</td></tr><tr class="hit"><td class="line">226</td><td class="hits">4</td><td class="source">            if(sumActivities &amp;&amp; sumActivities.length &gt; 0) {</td></tr><tr class="hit"><td class="line">227</td><td class="hits">4</td><td class="source">                stats_summary.total_clicks = sumActivities[0].total_clicks;</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="miss"><td class="line">229</td><td class="hits">0</td><td class="source">                stats_summary.total_clicks = 0;</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">232</td><td class="hits">4</td><td class="source">            trackingAggregateSumClickPromise.complete();</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">        }).then(function() {</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source">            //return data structure</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">            //add team stats in after sorting</td></tr><tr class="hit"><td class="line">236</td><td class="hits">4</td><td class="source">            if(team_stats &amp;&amp; team_stats.length &gt; 0) {</td></tr><tr class="hit"><td class="line">237</td><td class="hits">4</td><td class="source">                team_stats.sort(_sortByClicks);</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">240</td><td class="hits">4</td><td class="source">            if(stats_summary.top_links.length &gt; 0) {</td></tr><tr class="hit"><td class="line">241</td><td class="hits">4</td><td class="source">                stats_summary.top_links = _dedupeSharedLinks(stats_summary.top_links);</td></tr><tr class="hit"><td class="line">242</td><td class="hits">4</td><td class="source">                stats_summary.top_links.sort(_sortByClicks);</td></tr><tr><td class="line">243</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">245</td><td class="hits">4</td><td class="source">            if(stats_summary.user_top_links.length &gt; 0) {</td></tr><tr class="hit"><td class="line">246</td><td class="hits">3</td><td class="source">                stats_summary.user_top_links.sort(_sortByClicks);</td></tr><tr class="hit"><td class="line">247</td><td class="hits">3</td><td class="source">                if(stats_summary.user_top_links.length &gt; 5) {</td></tr><tr class="hit"><td class="line">248</td><td class="hits">3</td><td class="source">                    stats_summary.user_top_links = _.first(stats_summary.user_top_links, 5);</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">252</td><td class="hits">4</td><td class="source">            stats_summary.team_stats = team_stats;</td></tr><tr><td class="line">253</td><td class="hits"></td><td class="source">            // if(stats_summary.top_links.length &gt; 10) {</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source">            //     stats_summary.top_links = _.first(stats_summary.top_links, 10);</td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">            // }</td></tr><tr class="hit"><td class="line">256</td><td class="hits">4</td><td class="source">            return res.send(stats_summary);</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source">        }).then(null, function(err){</td></tr><tr class="hit"><td class="line">258</td><td class="hits">1</td><td class="source">            if (err.message === 'abort promise chain') {</td></tr><tr class="hit"><td class="line">259</td><td class="hits">1</td><td class="source">                return res.send(stats_summary);</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source">            else {</td></tr><tr class="miss"><td class="line">262</td><td class="hits">0</td><td class="source">                console.log(&quot;we got an error somewhere along the way&quot;, err);</td></tr><tr class="miss"><td class="line">263</td><td class="hits">0</td><td class="source">                next(err);</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source">            } </td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">267</td><td class="hits">5</td><td class="source">        function addTopLink(linkData) {</td></tr><tr class="miss"><td class="line">268</td><td class="hits">0</td><td class="source">            if(stats_summary.user_top_link &amp;&amp; stats_summary.user_top_link.clicks &amp;&amp; linkData.clicks) {</td></tr><tr class="miss"><td class="line">269</td><td class="hits">0</td><td class="source">                if(stats_summary.user_top_link.clicks &lt; linkData.clicks) {</td></tr><tr class="miss"><td class="line">270</td><td class="hits">0</td><td class="source">                    stats_summary.user_top_link = linkData;</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">272</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="miss"><td class="line">273</td><td class="hits">0</td><td class="source">                stats_summary.user_top_link = linkData;</td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">276</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">277</td><td class="hits">5</td><td class="source">        function addIncrementUserShares(user, clicks) {</td></tr><tr class="hit"><td class="line">278</td><td class="hits">72</td><td class="source">            var userIdx = ArrayUtils.inArray(user._id, team_stats, &quot;user._id&quot;);</td></tr><tr class="hit"><td class="line">279</td><td class="hits">72</td><td class="source">            if(userIdx &lt; 0) {</td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source">                //insert</td></tr><tr class="hit"><td class="line">281</td><td class="hits">4</td><td class="source">                var obj = {</td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source">                    user: user,</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source">                    total_clicks: clicks,</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source">                    total_shares: 1,</td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source">                    current_user: false</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source">                };</td></tr><tr class="hit"><td class="line">287</td><td class="hits">4</td><td class="source">                if(req.user._id == user._id) {</td></tr><tr class="hit"><td class="line">288</td><td class="hits">3</td><td class="source">                    obj.current_user = true;</td></tr><tr class="hit"><td class="line">289</td><td class="hits">3</td><td class="source">                    stats_summary.user_summary = obj;</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source">                }</td></tr><tr class="hit"><td class="line">291</td><td class="hits">4</td><td class="source">                team_stats.push(obj);</td></tr><tr><td class="line">292</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="hit"><td class="line">293</td><td class="hits">68</td><td class="source">                team_stats[userIdx].total_clicks += clicks;</td></tr><tr class="hit"><td class="line">294</td><td class="hits">68</td><td class="source">                team_stats[userIdx].total_shares += 1;</td></tr><tr class="hit"><td class="line">295</td><td class="hits">68</td><td class="source">                if(req.user._id == user._id) {</td></tr><tr class="hit"><td class="line">296</td><td class="hits">48</td><td class="source">                    stats_summary.user_summary.total_clicks = team_stats[userIdx].total_clicks;</td></tr><tr class="hit"><td class="line">297</td><td class="hits">48</td><td class="source">                    stats_summary.user_summary.total_shares = team_stats[userIdx].total_shares;</td></tr><tr><td class="line">298</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">300</td><td class="hits">72</td><td class="source">            userIdx = -1;</td></tr><tr><td class="line">301</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">302</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">303</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">304</td><td class="hits">1</td><td class="source">    var _recentlyShared = function(req, res, next) {</td></tr><tr class="hit"><td class="line">305</td><td class="hits">2</td><td class="source">        var</td></tr><tr><td class="line">306</td><td class="hits"></td><td class="source">            from,</td></tr><tr><td class="line">307</td><td class="hits"></td><td class="source">            to,</td></tr><tr><td class="line">308</td><td class="hits"></td><td class="source">            filter = req.params.filter || {};</td></tr><tr><td class="line">309</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">310</td><td class="hits">2</td><td class="source">        var newFilter = JSONUtils.tryParseJSON(filter);</td></tr><tr class="hit"><td class="line">311</td><td class="hits">2</td><td class="source">        if(newFilter !== false) {</td></tr><tr class="miss"><td class="line">312</td><td class="hits">0</td><td class="source">            filter = newFilter;</td></tr><tr><td class="line">313</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">314</td><td class="hits">2</td><td class="source">        if(!filter.range) {</td></tr><tr class="hit"><td class="line">315</td><td class="hits">2</td><td class="source">            filter.range = {</td></tr><tr><td class="line">316</td><td class="hits"></td><td class="source">                start : 0,</td></tr><tr><td class="line">317</td><td class="hits"></td><td class="source">                limit:5</td></tr><tr><td class="line">318</td><td class="hits"></td><td class="source">            };</td></tr><tr><td class="line">319</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">320</td><td class="hits">2</td><td class="source">        var</td></tr><tr><td class="line">321</td><td class="hits"></td><td class="source">            recently_shared = [],</td></tr><tr><td class="line">322</td><td class="hits"></td><td class="source">            teamIds = [],</td></tr><tr><td class="line">323</td><td class="hits"></td><td class="source">            recentTrackingUrls = [],</td></tr><tr><td class="line">324</td><td class="hits"></td><td class="source">            recentTrackingIds = [],</td></tr><tr><td class="line">325</td><td class="hits"></td><td class="source">            allTrackingUrls = [],</td></tr><tr><td class="line">326</td><td class="hits"></td><td class="source">            allTrackingIds = [],</td></tr><tr><td class="line">327</td><td class="hits"></td><td class="source">            trackingPromise,</td></tr><tr><td class="line">328</td><td class="hits"></td><td class="source">            trackingAllPromise;</td></tr><tr><td class="line">329</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">330</td><td class="hits">2</td><td class="source">        var query = {</td></tr><tr><td class="line">331</td><td class="hits"></td><td class="source">            &quot;users.user&quot;: req.user._id</td></tr><tr><td class="line">332</td><td class="hits"></td><td class="source">        };</td></tr><tr class="hit"><td class="line">333</td><td class="hits">2</td><td class="source">        if(filter) {</td></tr><tr class="hit"><td class="line">334</td><td class="hits">2</td><td class="source">            if(filter.users) {</td></tr><tr class="miss"><td class="line">335</td><td class="hits">0</td><td class="source">                query[&quot;users.user&quot;] = {</td></tr><tr><td class="line">336</td><td class="hits"></td><td class="source">                    $in:filter.users</td></tr><tr><td class="line">337</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">338</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">339</td><td class="hits">2</td><td class="source">            if(filter.campaigns) {</td></tr><tr class="miss"><td class="line">340</td><td class="hits">0</td><td class="source">                query._id = {</td></tr><tr><td class="line">341</td><td class="hits"></td><td class="source">                    $in: filter.campaigns</td></tr><tr><td class="line">342</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">343</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">344</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">345</td><td class="hits">2</td><td class="source">        var promise =</td></tr><tr><td class="line">346</td><td class="hits"></td><td class="source">            Campaign.Model</td></tr><tr><td class="line">347</td><td class="hits"></td><td class="source">                .find(query)</td></tr><tr><td class="line">348</td><td class="hits"></td><td class="source">                .populate(&quot;users.user&quot;, &quot;firstName lastName email trial trialStart gravatarHash&quot;)</td></tr><tr><td class="line">349</td><td class="hits"></td><td class="source">                .exec();</td></tr><tr><td class="line">350</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">351</td><td class="hits">2</td><td class="source">        promise.then(function(campaigns){</td></tr><tr><td class="line">352</td><td class="hits"></td><td class="source">            //this gives me all the campaigns a user is a part of</td></tr><tr class="hit"><td class="line">353</td><td class="hits">2</td><td class="source">            if(!campaigns || campaigns.length === 0) {</td></tr><tr class="miss"><td class="line">354</td><td class="hits">0</td><td class="source">                throw new Error('abort promise chain');</td></tr><tr><td class="line">355</td><td class="hits"></td><td class="source">                // return res.send(recently_shared);</td></tr><tr><td class="line">356</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">357</td><td class="hits">2</td><td class="source">            for(var i = 0; i &lt; campaigns.length; i++) {</td></tr><tr class="hit"><td class="line">358</td><td class="hits">6</td><td class="source">                var campaign = campaigns[i];</td></tr><tr class="hit"><td class="line">359</td><td class="hits">6</td><td class="source">                for(var j = 0; j &lt; campaign.users.length; j++) {</td></tr><tr class="hit"><td class="line">360</td><td class="hits">7</td><td class="source">                    if(filter.users) {</td></tr><tr class="miss"><td class="line">361</td><td class="hits">0</td><td class="source">                        if(campaign.users[j].user &amp;&amp; campaign.users[j].user) {</td></tr><tr class="miss"><td class="line">362</td><td class="hits">0</td><td class="source">                            var found = _.findWhere(filter.users, campaign.users[j].user._id);</td></tr><tr class="miss"><td class="line">363</td><td class="hits">0</td><td class="source">                            if(found) {</td></tr><tr class="miss"><td class="line">364</td><td class="hits">0</td><td class="source">                                teamIds.push(campaign.users[j].user._id); </td></tr><tr><td class="line">365</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">366</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">367</td><td class="hits"></td><td class="source">                    } else {</td></tr><tr class="hit"><td class="line">368</td><td class="hits">7</td><td class="source">                       if(campaign.users[j].user) {</td></tr><tr class="hit"><td class="line">369</td><td class="hits">7</td><td class="source">                            teamIds.push(campaign.users[j].user._id);</td></tr><tr><td class="line">370</td><td class="hits"></td><td class="source">                        } </td></tr><tr><td class="line">371</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">372</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">373</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">374</td><td class="hits">2</td><td class="source">            teamIds = ArrayUtils.uniqueArray(teamIds);</td></tr><tr class="hit"><td class="line">375</td><td class="hits">2</td><td class="source">            promise.complete();</td></tr><tr><td class="line">376</td><td class="hits"></td><td class="source">        }).then(function() {</td></tr><tr class="hit"><td class="line">377</td><td class="hits">2</td><td class="source">            var recentTrackingQuery = {</td></tr><tr><td class="line">378</td><td class="hits"></td><td class="source">                user: {</td></tr><tr><td class="line">379</td><td class="hits"></td><td class="source">                    $in:teamIds</td></tr><tr><td class="line">380</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">381</td><td class="hits"></td><td class="source">            };</td></tr><tr class="hit"><td class="line">382</td><td class="hits">2</td><td class="source">            if(filter.campaigns) {</td></tr><tr class="miss"><td class="line">383</td><td class="hits">0</td><td class="source">                recentTrackingQuery.campaign = {</td></tr><tr><td class="line">384</td><td class="hits"></td><td class="source">                    $in: filter.campaigns</td></tr><tr><td class="line">385</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">386</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">387</td><td class="hits">2</td><td class="source">            if(filter.date_range) {</td></tr><tr class="miss"><td class="line">388</td><td class="hits">0</td><td class="source">                recentTrackingQuery.created = {</td></tr><tr><td class="line">389</td><td class="hits"></td><td class="source">                    &quot;$gte&quot;: moment(filter.date_range.from).toDate(), </td></tr><tr><td class="line">390</td><td class="hits"></td><td class="source">                    &quot;$lte&quot;: moment(filter.date_range.to).toDate()</td></tr><tr><td class="line">391</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">392</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">393</td><td class="hits">2</td><td class="source">            trackingPromise =</td></tr><tr><td class="line">394</td><td class="hits"></td><td class="source">                TrackingUrl</td></tr><tr><td class="line">395</td><td class="hits"></td><td class="source">                    .find(recentTrackingQuery)</td></tr><tr><td class="line">396</td><td class="hits"></td><td class="source">                    .sort({&quot;created&quot;: -1})</td></tr><tr><td class="line">397</td><td class="hits"></td><td class="source">                    .limit(filter.range.limit)</td></tr><tr><td class="line">398</td><td class="hits"></td><td class="source">                    .populate(&quot;trackingPage&quot;, &quot;title url&quot;)</td></tr><tr><td class="line">399</td><td class="hits"></td><td class="source">                    .populate(&quot;user&quot;, &quot;firstName lastName email trial trialStart gravatarHash&quot;)</td></tr><tr><td class="line">400</td><td class="hits"></td><td class="source">                    .exec();</td></tr><tr class="hit"><td class="line">401</td><td class="hits">2</td><td class="source">            return trackingPromise;</td></tr><tr><td class="line">402</td><td class="hits"></td><td class="source">        }).then(function(urls){</td></tr><tr class="hit"><td class="line">403</td><td class="hits">2</td><td class="source">            if(!urls || urls.length === 0) {</td></tr><tr class="hit"><td class="line">404</td><td class="hits">1</td><td class="source">                throw new Error('abort promise chain');</td></tr><tr><td class="line">405</td><td class="hits"></td><td class="source">                // return res.send(recently_shared);</td></tr><tr><td class="line">406</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">407</td><td class="hits">1</td><td class="source">            for(var k = 0; k &lt; urls.length; k++){</td></tr><tr class="hit"><td class="line">408</td><td class="hits">5</td><td class="source">                recentTrackingUrls.push(urls[k]);</td></tr><tr class="hit"><td class="line">409</td><td class="hits">5</td><td class="source">                recentTrackingIds.push(urls[k]._id);</td></tr><tr><td class="line">410</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">411</td><td class="hits">1</td><td class="source">            trackingPromise.complete();</td></tr><tr><td class="line">412</td><td class="hits"></td><td class="source">        }).then(function() {</td></tr><tr><td class="line">413</td><td class="hits"></td><td class="source">            //this finds all of the tracked urls so that we can get an accurate count of clicks</td></tr><tr class="hit"><td class="line">414</td><td class="hits">1</td><td class="source">            var trackingAllQuery = {</td></tr><tr><td class="line">415</td><td class="hits"></td><td class="source">                user: {</td></tr><tr><td class="line">416</td><td class="hits"></td><td class="source">                    $in:teamIds</td></tr><tr><td class="line">417</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">418</td><td class="hits"></td><td class="source">            };</td></tr><tr class="hit"><td class="line">419</td><td class="hits">1</td><td class="source">            if(filter.campaigns) {</td></tr><tr class="miss"><td class="line">420</td><td class="hits">0</td><td class="source">                trackingAllQuery.campaign = {</td></tr><tr><td class="line">421</td><td class="hits"></td><td class="source">                    $in: filter.campaigns</td></tr><tr><td class="line">422</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">423</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">424</td><td class="hits">1</td><td class="source">            trackingAllPromise =</td></tr><tr><td class="line">425</td><td class="hits"></td><td class="source">                TrackingUrl</td></tr><tr><td class="line">426</td><td class="hits"></td><td class="source">                    .find(trackingAllQuery)</td></tr><tr><td class="line">427</td><td class="hits"></td><td class="source">                    .populate(&quot;trackingPage&quot;, &quot;title url&quot;)</td></tr><tr><td class="line">428</td><td class="hits"></td><td class="source">                    .populate(&quot;user&quot;, &quot;firstName lastName email trial trialStart gravatarHash&quot;)</td></tr><tr><td class="line">429</td><td class="hits"></td><td class="source">                    .exec();</td></tr><tr class="hit"><td class="line">430</td><td class="hits">1</td><td class="source">            return trackingAllPromise;</td></tr><tr><td class="line">431</td><td class="hits"></td><td class="source">        }).then(function(allUrls){</td></tr><tr class="hit"><td class="line">432</td><td class="hits">1</td><td class="source">            if(!allUrls || allUrls.length === 0) {</td></tr><tr class="miss"><td class="line">433</td><td class="hits">0</td><td class="source">                throw new Error('abort promise chain');</td></tr><tr><td class="line">434</td><td class="hits"></td><td class="source">                // return res.send(recently_shared);</td></tr><tr><td class="line">435</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">436</td><td class="hits">1</td><td class="source">            for(var k = 0; k &lt; allUrls.length; k++){</td></tr><tr class="hit"><td class="line">437</td><td class="hits">23</td><td class="source">                allTrackingUrls.push(allUrls[k]);</td></tr><tr class="hit"><td class="line">438</td><td class="hits">23</td><td class="source">                allTrackingIds.push(allUrls[k]._id);</td></tr><tr><td class="line">439</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">440</td><td class="hits">1</td><td class="source">            trackingAllPromise.complete();</td></tr><tr><td class="line">441</td><td class="hits"></td><td class="source">        }).then(function(){</td></tr><tr class="hit"><td class="line">442</td><td class="hits">1</td><td class="source">            var clickAggregateQuery = [{</td></tr><tr><td class="line">443</td><td class="hits"></td><td class="source">                $match: {</td></tr><tr><td class="line">444</td><td class="hits"></td><td class="source">                    trackingId: {</td></tr><tr><td class="line">445</td><td class="hits"></td><td class="source">                        $in:allTrackingIds</td></tr><tr><td class="line">446</td><td class="hits"></td><td class="source">                    },</td></tr><tr><td class="line">447</td><td class="hits"></td><td class="source">                    isBot:false</td></tr><tr><td class="line">448</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">449</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">450</td><td class="hits"></td><td class="source">            {</td></tr><tr><td class="line">451</td><td class="hits"></td><td class="source">                $group: {</td></tr><tr><td class="line">452</td><td class="hits"></td><td class="source">                    _id: '$trackingId',</td></tr><tr><td class="line">453</td><td class="hits"></td><td class="source">                    clicks: {$sum:1}</td></tr><tr><td class="line">454</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">455</td><td class="hits"></td><td class="source">            }];</td></tr><tr class="hit"><td class="line">456</td><td class="hits">1</td><td class="source">            trackingAggregateTotalClickPromise =</td></tr><tr><td class="line">457</td><td class="hits"></td><td class="source">                TrackingUrlActivity</td></tr><tr><td class="line">458</td><td class="hits"></td><td class="source">                    .aggregate(clickAggregateQuery)</td></tr><tr><td class="line">459</td><td class="hits"></td><td class="source">                    .sort({&quot;clicks&quot;: -1})</td></tr><tr><td class="line">460</td><td class="hits"></td><td class="source">                    .exec();</td></tr><tr class="hit"><td class="line">461</td><td class="hits">1</td><td class="source">            return trackingAggregateTotalClickPromise;</td></tr><tr><td class="line">462</td><td class="hits"></td><td class="source">        }).then(function(activities){</td></tr><tr><td class="line">463</td><td class="hits"></td><td class="source">            //loop through sorted activites list and populate from there</td></tr><tr class="hit"><td class="line">464</td><td class="hits">1</td><td class="source">            if(recentTrackingUrls &amp;&amp; recentTrackingUrls.length &gt; 0) {</td></tr><tr class="hit"><td class="line">465</td><td class="hits">1</td><td class="source">                var tracking;</td></tr><tr class="hit"><td class="line">466</td><td class="hits">1</td><td class="source">                var urlIdx = -1;</td></tr><tr class="hit"><td class="line">467</td><td class="hits">1</td><td class="source">                var pageUrlIdx = -1;</td></tr><tr class="hit"><td class="line">468</td><td class="hits">1</td><td class="source">                for(var i = 0; i &lt; recentTrackingUrls.length; i++) {</td></tr><tr class="hit"><td class="line">469</td><td class="hits">5</td><td class="source">                    tracking = recentTrackingUrls[i];</td></tr><tr class="hit"><td class="line">470</td><td class="hits">5</td><td class="source">                    urlIdx = ArrayUtils.inArray(tracking._id, activities, &quot;_id&quot;);</td></tr><tr class="hit"><td class="line">471</td><td class="hits">5</td><td class="source">                    var obj = {</td></tr><tr><td class="line">472</td><td class="hits"></td><td class="source">                        id: tracking._id,</td></tr><tr><td class="line">473</td><td class="hits"></td><td class="source">                        url:tracking.url,</td></tr><tr><td class="line">474</td><td class="hits"></td><td class="source">                        title:tracking.url,</td></tr><tr><td class="line">475</td><td class="hits"></td><td class="source">                        clicks: 0,</td></tr><tr><td class="line">476</td><td class="hits"></td><td class="source">                        created:tracking.created,</td></tr><tr><td class="line">477</td><td class="hits"></td><td class="source">                        createdFormatted: moment(tracking.created).fromNow(),</td></tr><tr><td class="line">478</td><td class="hits"></td><td class="source">                        users:[tracking.user],</td></tr><tr><td class="line">479</td><td class="hits"></td><td class="source">                        trackingPage: 0</td></tr><tr><td class="line">480</td><td class="hits"></td><td class="source">                    };</td></tr><tr class="hit"><td class="line">481</td><td class="hits">5</td><td class="source">                    if(tracking.trackingPage) {</td></tr><tr class="hit"><td class="line">482</td><td class="hits">5</td><td class="source">                        obj.trackingPage = tracking.trackingPage._id;</td></tr><tr class="hit"><td class="line">483</td><td class="hits">5</td><td class="source">                        obj.title = tracking.trackingPage.title;</td></tr><tr><td class="line">484</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="hit"><td class="line">485</td><td class="hits">5</td><td class="source">                    if(urlIdx &gt;= 0) {</td></tr><tr class="hit"><td class="line">486</td><td class="hits">3</td><td class="source">                        obj.clicks = activities[urlIdx].clicks;</td></tr><tr><td class="line">487</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">488</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">489</td><td class="hits">5</td><td class="source">                    recently_shared.push(obj);</td></tr><tr><td class="line">490</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">491</td><td class="hits">5</td><td class="source">                    urlIdx = -1;</td></tr><tr class="hit"><td class="line">492</td><td class="hits">5</td><td class="source">                    tracking = null;</td></tr><tr><td class="line">493</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">494</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">495</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">496</td><td class="hits"></td><td class="source">        }).then(function() {</td></tr><tr><td class="line">497</td><td class="hits"></td><td class="source">            //return data structure</td></tr><tr><td class="line">498</td><td class="hits"></td><td class="source">            //dedupe and sort links by clicks</td></tr><tr class="hit"><td class="line">499</td><td class="hits">1</td><td class="source">            recently_shared = _dedupeSharedLinks(recently_shared);</td></tr><tr><td class="line">500</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">501</td><td class="hits"></td><td class="source">            //now we need to go through the recent de-dupes and add back in all the clicks that are missing</td></tr><tr class="hit"><td class="line">502</td><td class="hits">1</td><td class="source">            if(recently_shared.length &gt; 0) {</td></tr><tr class="hit"><td class="line">503</td><td class="hits">1</td><td class="source">                var matches = [];</td></tr><tr class="hit"><td class="line">504</td><td class="hits">1</td><td class="source">                for(var j = 0; j &lt; recently_shared.length; j++) {</td></tr><tr class="hit"><td class="line">505</td><td class="hits">2</td><td class="source">                    matches = _.where(allTrackingUrls, {&quot;trackingPage._id&quot;: recently_shared[j].trackingPage});</td></tr><tr class="hit"><td class="line">506</td><td class="hits">2</td><td class="source">                    for (var k = 0; k &lt; matches.length; k++) {</td></tr><tr class="miss"><td class="line">507</td><td class="hits">0</td><td class="source">                        if(recently_shared.id != matches[k]._id) {</td></tr><tr class="miss"><td class="line">508</td><td class="hits">0</td><td class="source">                            var pageObj = {</td></tr><tr><td class="line">509</td><td class="hits"></td><td class="source">                                id: matches[k]._id,</td></tr><tr><td class="line">510</td><td class="hits"></td><td class="source">                                url:matches[k].url,</td></tr><tr><td class="line">511</td><td class="hits"></td><td class="source">                                title: matches[k].trackingPage.title,</td></tr><tr><td class="line">512</td><td class="hits"></td><td class="source">                                clicks: matches[k].clicks,</td></tr><tr><td class="line">513</td><td class="hits"></td><td class="source">                                created: matches[k].created,</td></tr><tr><td class="line">514</td><td class="hits"></td><td class="source">                                createdFormatted: moment(matches[k].created).fromNow(),</td></tr><tr><td class="line">515</td><td class="hits"></td><td class="source">                                users:[matches[k].user],</td></tr><tr><td class="line">516</td><td class="hits"></td><td class="source">                                trackingPage: matches[k].trackingPage._id</td></tr><tr><td class="line">517</td><td class="hits"></td><td class="source">                            };</td></tr><tr class="miss"><td class="line">518</td><td class="hits">0</td><td class="source">                            recently_shared.push(pageObj);</td></tr><tr><td class="line">519</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">520</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">521</td><td class="hits"></td><td class="source">                }</td></tr><tr class="hit"><td class="line">522</td><td class="hits">1</td><td class="source">                matches = [];</td></tr><tr><td class="line">523</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">524</td><td class="hits">1</td><td class="source">            recently_shared = _dedupeSharedLinks(recently_shared);</td></tr><tr class="hit"><td class="line">525</td><td class="hits">1</td><td class="source">            return res.send(recently_shared);</td></tr><tr><td class="line">526</td><td class="hits"></td><td class="source">        }).then(null, function(err){</td></tr><tr class="hit"><td class="line">527</td><td class="hits">1</td><td class="source">            if (err.message === 'abort promise chain') {</td></tr><tr class="hit"><td class="line">528</td><td class="hits">1</td><td class="source">                return res.send(recently_shared);</td></tr><tr><td class="line">529</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">530</td><td class="hits"></td><td class="source">            else {</td></tr><tr class="miss"><td class="line">531</td><td class="hits">0</td><td class="source">                console.log(&quot;we got an error somewhere along the way&quot;, err);</td></tr><tr class="miss"><td class="line">532</td><td class="hits">0</td><td class="source">                next(err);</td></tr><tr><td class="line">533</td><td class="hits"></td><td class="source">            } </td></tr><tr><td class="line">534</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">535</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">536</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">537</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">538</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">539</td><td class="hits">1</td><td class="source">    var _popularLinks = function(req, res, next) {</td></tr><tr class="miss"><td class="line">540</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">541</td><td class="hits"></td><td class="source">            filter = req.params.filter || {};</td></tr><tr><td class="line">542</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">543</td><td class="hits">0</td><td class="source">        var newFilter = JSONUtils.tryParseJSON(filter);</td></tr><tr class="miss"><td class="line">544</td><td class="hits">0</td><td class="source">        if(newFilter !== false) {</td></tr><tr class="miss"><td class="line">545</td><td class="hits">0</td><td class="source">            filter = newFilter;</td></tr><tr><td class="line">546</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">547</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">548</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">549</td><td class="hits"></td><td class="source">            popular_links = [],</td></tr><tr><td class="line">550</td><td class="hits"></td><td class="source">            teamIds = [],</td></tr><tr><td class="line">551</td><td class="hits"></td><td class="source">            trackingUrls = [],</td></tr><tr><td class="line">552</td><td class="hits"></td><td class="source">            trackingIds = [],</td></tr><tr><td class="line">553</td><td class="hits"></td><td class="source">            allTrackingUrls = [],</td></tr><tr><td class="line">554</td><td class="hits"></td><td class="source">            allTrackingIds = [],</td></tr><tr><td class="line">555</td><td class="hits"></td><td class="source">            trackingPromise,</td></tr><tr><td class="line">556</td><td class="hits"></td><td class="source">            trackingAllPromise;</td></tr><tr><td class="line">557</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">558</td><td class="hits">0</td><td class="source">        var query = {</td></tr><tr><td class="line">559</td><td class="hits"></td><td class="source">            &quot;users.user&quot;: req.user._id</td></tr><tr><td class="line">560</td><td class="hits"></td><td class="source">        };</td></tr><tr class="miss"><td class="line">561</td><td class="hits">0</td><td class="source">        if(filter) {</td></tr><tr class="miss"><td class="line">562</td><td class="hits">0</td><td class="source">            if(filter.users) {</td></tr><tr class="miss"><td class="line">563</td><td class="hits">0</td><td class="source">                query[&quot;users.user&quot;] = {</td></tr><tr><td class="line">564</td><td class="hits"></td><td class="source">                    $in:filter.users</td></tr><tr><td class="line">565</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">566</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">567</td><td class="hits">0</td><td class="source">            if(filter.campaigns) {</td></tr><tr class="miss"><td class="line">568</td><td class="hits">0</td><td class="source">                query._id = {</td></tr><tr><td class="line">569</td><td class="hits"></td><td class="source">                    $in: filter.campaigns</td></tr><tr><td class="line">570</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">571</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">572</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">573</td><td class="hits">0</td><td class="source">        var promise =</td></tr><tr><td class="line">574</td><td class="hits"></td><td class="source">            Campaign.Model</td></tr><tr><td class="line">575</td><td class="hits"></td><td class="source">                .find(query)</td></tr><tr><td class="line">576</td><td class="hits"></td><td class="source">                .populate(&quot;users.user&quot;, &quot;firstName lastName email trial trialStart gravatarHash&quot;)</td></tr><tr><td class="line">577</td><td class="hits"></td><td class="source">                .exec();</td></tr><tr><td class="line">578</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">579</td><td class="hits">0</td><td class="source">        promise.then(function(campaigns){</td></tr><tr><td class="line">580</td><td class="hits"></td><td class="source">            //this gives me all the campaigns a user is a part of</td></tr><tr class="miss"><td class="line">581</td><td class="hits">0</td><td class="source">            if(!campaigns || campaigns.length === 0) {</td></tr><tr class="miss"><td class="line">582</td><td class="hits">0</td><td class="source">                throw new Error('abort promise chain');</td></tr><tr><td class="line">583</td><td class="hits"></td><td class="source">                // return res.send(recently_shared);</td></tr><tr><td class="line">584</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">585</td><td class="hits">0</td><td class="source">            for(var i = 0; i &lt; campaigns.length; i++) {</td></tr><tr class="miss"><td class="line">586</td><td class="hits">0</td><td class="source">                var campaign = campaigns[i];</td></tr><tr class="miss"><td class="line">587</td><td class="hits">0</td><td class="source">                for(var j = 0; j &lt; campaign.users.length; j++) {</td></tr><tr class="miss"><td class="line">588</td><td class="hits">0</td><td class="source">                    if(filter.users) {</td></tr><tr class="miss"><td class="line">589</td><td class="hits">0</td><td class="source">                        if(campaign.users[j].user &amp;&amp; campaign.users[j].user) {</td></tr><tr class="miss"><td class="line">590</td><td class="hits">0</td><td class="source">                            var found = _.findWhere(filter.users, campaign.users[j].user._id);</td></tr><tr class="miss"><td class="line">591</td><td class="hits">0</td><td class="source">                            if(found) {</td></tr><tr class="miss"><td class="line">592</td><td class="hits">0</td><td class="source">                                teamIds.push(campaign.users[j].user._id); </td></tr><tr><td class="line">593</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">594</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">595</td><td class="hits"></td><td class="source">                    } else {</td></tr><tr class="miss"><td class="line">596</td><td class="hits">0</td><td class="source">                       if(campaign.users[j].user) {</td></tr><tr class="miss"><td class="line">597</td><td class="hits">0</td><td class="source">                            teamIds.push(campaign.users[j].user._id);</td></tr><tr><td class="line">598</td><td class="hits"></td><td class="source">                        } </td></tr><tr><td class="line">599</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">600</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">601</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">602</td><td class="hits">0</td><td class="source">            teamIds = ArrayUtils.uniqueArray(teamIds);</td></tr><tr class="miss"><td class="line">603</td><td class="hits">0</td><td class="source">            promise.complete();</td></tr><tr><td class="line">604</td><td class="hits"></td><td class="source">        }).then(function() {</td></tr><tr class="miss"><td class="line">605</td><td class="hits">0</td><td class="source">            var trackingQuery = {</td></tr><tr><td class="line">606</td><td class="hits"></td><td class="source">                user: {</td></tr><tr><td class="line">607</td><td class="hits"></td><td class="source">                    $in:teamIds</td></tr><tr><td class="line">608</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">609</td><td class="hits"></td><td class="source">            };</td></tr><tr class="miss"><td class="line">610</td><td class="hits">0</td><td class="source">            if(filter.date_range) {</td></tr><tr class="miss"><td class="line">611</td><td class="hits">0</td><td class="source">                trackingQuery.created = {</td></tr><tr><td class="line">612</td><td class="hits"></td><td class="source">                    &quot;$gte&quot;: moment(filter.date_range.from).toDate(), </td></tr><tr><td class="line">613</td><td class="hits"></td><td class="source">                    &quot;$lte&quot;: moment(filter.date_range.to).toDate()</td></tr><tr><td class="line">614</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">615</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">616</td><td class="hits">0</td><td class="source">            if(filter.campaigns) {</td></tr><tr class="miss"><td class="line">617</td><td class="hits">0</td><td class="source">                trackingQuery.campaign = {</td></tr><tr><td class="line">618</td><td class="hits"></td><td class="source">                    $in: filter.campaigns</td></tr><tr><td class="line">619</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">620</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">621</td><td class="hits">0</td><td class="source">            trackingPromise =</td></tr><tr><td class="line">622</td><td class="hits"></td><td class="source">                TrackingUrl</td></tr><tr><td class="line">623</td><td class="hits"></td><td class="source">                    .find(trackingQuery)</td></tr><tr><td class="line">624</td><td class="hits"></td><td class="source">                    .sort({&quot;created&quot;: -1})</td></tr><tr><td class="line">625</td><td class="hits"></td><td class="source">                    .populate(&quot;trackingPage&quot;, &quot;title url&quot;)</td></tr><tr><td class="line">626</td><td class="hits"></td><td class="source">                    .populate(&quot;user&quot;, &quot;firstName lastName email trial trialStart gravatarHash&quot;)</td></tr><tr><td class="line">627</td><td class="hits"></td><td class="source">                    .exec();</td></tr><tr class="miss"><td class="line">628</td><td class="hits">0</td><td class="source">            return trackingPromise;</td></tr><tr><td class="line">629</td><td class="hits"></td><td class="source">        }).then(function(urls){</td></tr><tr class="miss"><td class="line">630</td><td class="hits">0</td><td class="source">            if(!urls || urls.length === 0) {</td></tr><tr class="miss"><td class="line">631</td><td class="hits">0</td><td class="source">                throw new Error('abort promise chain');</td></tr><tr><td class="line">632</td><td class="hits"></td><td class="source">                // return res.send(recently_shared);</td></tr><tr><td class="line">633</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">634</td><td class="hits">0</td><td class="source">            for(var k = 0; k &lt; urls.length; k++){</td></tr><tr class="miss"><td class="line">635</td><td class="hits">0</td><td class="source">                trackingUrls.push(urls[k]);</td></tr><tr class="miss"><td class="line">636</td><td class="hits">0</td><td class="source">                trackingIds.push(urls[k]._id);</td></tr><tr><td class="line">637</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">638</td><td class="hits">0</td><td class="source">            trackingPromise.complete();</td></tr><tr><td class="line">639</td><td class="hits"></td><td class="source">        }).then(function() {</td></tr><tr><td class="line">640</td><td class="hits"></td><td class="source">            //this finds all of the tracked urls so that we can get an accurate count of clicks</td></tr><tr class="miss"><td class="line">641</td><td class="hits">0</td><td class="source">            var trackingAllQuery = {</td></tr><tr><td class="line">642</td><td class="hits"></td><td class="source">                user: {</td></tr><tr><td class="line">643</td><td class="hits"></td><td class="source">                    $in:teamIds</td></tr><tr><td class="line">644</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">645</td><td class="hits"></td><td class="source">            };</td></tr><tr class="miss"><td class="line">646</td><td class="hits">0</td><td class="source">            if(filter.campaigns) {</td></tr><tr class="miss"><td class="line">647</td><td class="hits">0</td><td class="source">                trackingAllQuery.campaign = {</td></tr><tr><td class="line">648</td><td class="hits"></td><td class="source">                    $in: filter.campaigns</td></tr><tr><td class="line">649</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">650</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">651</td><td class="hits">0</td><td class="source">            trackingAllPromise =</td></tr><tr><td class="line">652</td><td class="hits"></td><td class="source">                TrackingUrl</td></tr><tr><td class="line">653</td><td class="hits"></td><td class="source">                    .find(trackingAllQuery)</td></tr><tr><td class="line">654</td><td class="hits"></td><td class="source">                    .populate(&quot;trackingPage&quot;, &quot;title url&quot;)</td></tr><tr><td class="line">655</td><td class="hits"></td><td class="source">                    .populate(&quot;user&quot;, &quot;firstName lastName email trial trialStart gravatarHash&quot;)</td></tr><tr><td class="line">656</td><td class="hits"></td><td class="source">                    .exec();</td></tr><tr class="miss"><td class="line">657</td><td class="hits">0</td><td class="source">            return trackingAllPromise;</td></tr><tr><td class="line">658</td><td class="hits"></td><td class="source">        }).then(function(allUrls){</td></tr><tr class="miss"><td class="line">659</td><td class="hits">0</td><td class="source">            if(!allUrls || allUrls.length === 0) {</td></tr><tr class="miss"><td class="line">660</td><td class="hits">0</td><td class="source">                throw new Error('abort promise chain');</td></tr><tr><td class="line">661</td><td class="hits"></td><td class="source">                // return res.send(recently_shared);</td></tr><tr><td class="line">662</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">663</td><td class="hits">0</td><td class="source">            for(var k = 0; k &lt; allUrls.length; k++){</td></tr><tr class="miss"><td class="line">664</td><td class="hits">0</td><td class="source">                allTrackingUrls.push(allUrls[k]);</td></tr><tr class="miss"><td class="line">665</td><td class="hits">0</td><td class="source">                allTrackingIds.push(allUrls[k]._id);</td></tr><tr><td class="line">666</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">667</td><td class="hits">0</td><td class="source">            trackingAllPromise.complete();</td></tr><tr><td class="line">668</td><td class="hits"></td><td class="source">        }).then(function(){</td></tr><tr class="miss"><td class="line">669</td><td class="hits">0</td><td class="source">            trackingAggregateTotalClickPromise =</td></tr><tr><td class="line">670</td><td class="hits"></td><td class="source">                TrackingUrlActivity</td></tr><tr><td class="line">671</td><td class="hits"></td><td class="source">                    .aggregate(</td></tr><tr><td class="line">672</td><td class="hits"></td><td class="source">                        [{</td></tr><tr><td class="line">673</td><td class="hits"></td><td class="source">                            $match: {</td></tr><tr><td class="line">674</td><td class="hits"></td><td class="source">                                trackingId: {</td></tr><tr><td class="line">675</td><td class="hits"></td><td class="source">                                    $in:allTrackingIds</td></tr><tr><td class="line">676</td><td class="hits"></td><td class="source">                                },</td></tr><tr><td class="line">677</td><td class="hits"></td><td class="source">                                isBot:false</td></tr><tr><td class="line">678</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">679</td><td class="hits"></td><td class="source">                        },</td></tr><tr><td class="line">680</td><td class="hits"></td><td class="source">                        {</td></tr><tr><td class="line">681</td><td class="hits"></td><td class="source">                            $group: {</td></tr><tr><td class="line">682</td><td class="hits"></td><td class="source">                                _id: '$trackingId',</td></tr><tr><td class="line">683</td><td class="hits"></td><td class="source">                                clicks: {$sum:1}</td></tr><tr><td class="line">684</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">685</td><td class="hits"></td><td class="source">                        }]</td></tr><tr><td class="line">686</td><td class="hits"></td><td class="source">                    )</td></tr><tr><td class="line">687</td><td class="hits"></td><td class="source">                    .sort({&quot;clicks&quot;: -1})</td></tr><tr><td class="line">688</td><td class="hits"></td><td class="source">                    .exec();</td></tr><tr class="miss"><td class="line">689</td><td class="hits">0</td><td class="source">            return trackingAggregateTotalClickPromise;</td></tr><tr><td class="line">690</td><td class="hits"></td><td class="source">        }).then(function(activities){</td></tr><tr><td class="line">691</td><td class="hits"></td><td class="source">            //loop through sorted activites list and populate from there</td></tr><tr class="miss"><td class="line">692</td><td class="hits">0</td><td class="source">            if(trackingUrls &amp;&amp; trackingUrls.length &gt; 0) {</td></tr><tr class="miss"><td class="line">693</td><td class="hits">0</td><td class="source">                var tracking;</td></tr><tr class="miss"><td class="line">694</td><td class="hits">0</td><td class="source">                var urlIdx = -1;</td></tr><tr class="miss"><td class="line">695</td><td class="hits">0</td><td class="source">                var pageUrlIdx = -1;</td></tr><tr class="miss"><td class="line">696</td><td class="hits">0</td><td class="source">                for(var i = 0; i &lt; trackingUrls.length; i++) {</td></tr><tr class="miss"><td class="line">697</td><td class="hits">0</td><td class="source">                    tracking = trackingUrls[i];</td></tr><tr class="miss"><td class="line">698</td><td class="hits">0</td><td class="source">                    urlIdx = ArrayUtils.inArray(tracking._id, activities, &quot;_id&quot;);</td></tr><tr class="miss"><td class="line">699</td><td class="hits">0</td><td class="source">                    var obj = {</td></tr><tr><td class="line">700</td><td class="hits"></td><td class="source">                        id: tracking._id,</td></tr><tr><td class="line">701</td><td class="hits"></td><td class="source">                        url:tracking.url,</td></tr><tr><td class="line">702</td><td class="hits"></td><td class="source">                        title:tracking.url,</td></tr><tr><td class="line">703</td><td class="hits"></td><td class="source">                        clicks: 0,</td></tr><tr><td class="line">704</td><td class="hits"></td><td class="source">                        created:tracking.created,</td></tr><tr><td class="line">705</td><td class="hits"></td><td class="source">                        createdFormatted: moment(tracking.created).fromNow(),</td></tr><tr><td class="line">706</td><td class="hits"></td><td class="source">                        users:[tracking.user],</td></tr><tr><td class="line">707</td><td class="hits"></td><td class="source">                        trackingPage: 0</td></tr><tr><td class="line">708</td><td class="hits"></td><td class="source">                    };</td></tr><tr class="miss"><td class="line">709</td><td class="hits">0</td><td class="source">                    if(tracking.trackingPage) {</td></tr><tr class="miss"><td class="line">710</td><td class="hits">0</td><td class="source">                        obj.trackingPage = tracking.trackingPage._id;</td></tr><tr class="miss"><td class="line">711</td><td class="hits">0</td><td class="source">                        obj.title = tracking.trackingPage.title;</td></tr><tr><td class="line">712</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">713</td><td class="hits">0</td><td class="source">                    if(urlIdx &gt;= 0) {</td></tr><tr class="miss"><td class="line">714</td><td class="hits">0</td><td class="source">                        obj.clicks = activities[urlIdx].clicks;</td></tr><tr><td class="line">715</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">716</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">717</td><td class="hits">0</td><td class="source">                    popular_links.push(obj);</td></tr><tr><td class="line">718</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">719</td><td class="hits">0</td><td class="source">                    urlIdx = -1;</td></tr><tr class="miss"><td class="line">720</td><td class="hits">0</td><td class="source">                    tracking = null;</td></tr><tr><td class="line">721</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">722</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">723</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">724</td><td class="hits"></td><td class="source">        }).then(function() {</td></tr><tr><td class="line">725</td><td class="hits"></td><td class="source">            //return data structure</td></tr><tr><td class="line">726</td><td class="hits"></td><td class="source">            //dedupe and sort links by clicks</td></tr><tr class="miss"><td class="line">727</td><td class="hits">0</td><td class="source">            popular_links = _dedupeSharedLinks(popular_links);</td></tr><tr class="miss"><td class="line">728</td><td class="hits">0</td><td class="source">            popular_links.sort(_sortByClicks);</td></tr><tr class="miss"><td class="line">729</td><td class="hits">0</td><td class="source">            return res.send(popular_links);</td></tr><tr><td class="line">730</td><td class="hits"></td><td class="source">        }).then(null, function(err){</td></tr><tr class="miss"><td class="line">731</td><td class="hits">0</td><td class="source">            if (err.message === 'abort promise chain') {</td></tr><tr class="miss"><td class="line">732</td><td class="hits">0</td><td class="source">                return res.send(popular_links);</td></tr><tr><td class="line">733</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">734</td><td class="hits"></td><td class="source">            else {</td></tr><tr class="miss"><td class="line">735</td><td class="hits">0</td><td class="source">                console.log(&quot;we got an error somewhere along the way&quot;, err);</td></tr><tr class="miss"><td class="line">736</td><td class="hits">0</td><td class="source">                next(err);</td></tr><tr><td class="line">737</td><td class="hits"></td><td class="source">            } </td></tr><tr><td class="line">738</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">739</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">740</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">741</td><td class="hits">1</td><td class="source">    var _linksVsClicks = function(req, res, next) {</td></tr><tr><td class="line">742</td><td class="hits"></td><td class="source">        //think about the data structure a bit</td></tr><tr><td class="line">743</td><td class="hits"></td><td class="source">        //clicks_vs_links:[{date: 10/06/14, clicks_total:16, links_total:5}]</td></tr><tr><td class="line">744</td><td class="hits"></td><td class="source">        //we're going to need a date filter</td></tr><tr><td class="line">745</td><td class="hits"></td><td class="source">        //need to group by date</td></tr><tr><td class="line">746</td><td class="hits"></td><td class="source">        //two queries</td></tr><tr><td class="line">747</td><td class="hits"></td><td class="source">        //get all links created between two date ranges</td></tr><tr><td class="line">748</td><td class="hits"></td><td class="source">        //get all clicks between two date ranges</td></tr><tr><td class="line">749</td><td class="hits"></td><td class="source">        //grouped by day</td></tr><tr><td class="line">750</td><td class="hits"></td><td class="source">        //same filters as before</td></tr><tr class="miss"><td class="line">751</td><td class="hits">0</td><td class="source">        var filter = req.params.filter || {};</td></tr><tr class="miss"><td class="line">752</td><td class="hits">0</td><td class="source">        var to, from;</td></tr><tr class="miss"><td class="line">753</td><td class="hits">0</td><td class="source">        var clicks_vs_links = {</td></tr><tr><td class="line">754</td><td class="hits"></td><td class="source">            raw_data : [],</td></tr><tr><td class="line">755</td><td class="hits"></td><td class="source">            labels: [],</td></tr><tr><td class="line">756</td><td class="hits"></td><td class="source">            clicks : [],</td></tr><tr><td class="line">757</td><td class="hits"></td><td class="source">            links : []</td></tr><tr><td class="line">758</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">759</td><td class="hits"></td><td class="source">        //nvd3 format</td></tr><tr><td class="line">760</td><td class="hits"></td><td class="source">        // var clicks_vs_links = {</td></tr><tr><td class="line">761</td><td class="hits"></td><td class="source">        //     raw_data : [],</td></tr><tr><td class="line">762</td><td class="hits"></td><td class="source">        //     clicks : {key: &quot;Clicks&quot;, values:[]},</td></tr><tr><td class="line">763</td><td class="hits"></td><td class="source">        //     links : {key: &quot;Links&quot;, values:[]}</td></tr><tr><td class="line">764</td><td class="hits"></td><td class="source">        // };</td></tr><tr class="miss"><td class="line">765</td><td class="hits">0</td><td class="source">        var teamIds = [];</td></tr><tr class="miss"><td class="line">766</td><td class="hits">0</td><td class="source">        var trackingUrls = [];</td></tr><tr class="miss"><td class="line">767</td><td class="hits">0</td><td class="source">        var trackingIds = [];</td></tr><tr class="miss"><td class="line">768</td><td class="hits">0</td><td class="source">        var trackingPromise;</td></tr><tr class="miss"><td class="line">769</td><td class="hits">0</td><td class="source">        var trackingAggregateUserTotalClickPromise;</td></tr><tr class="miss"><td class="line">770</td><td class="hits">0</td><td class="source">        var trackingAggregateTotalClickPromise;</td></tr><tr class="miss"><td class="line">771</td><td class="hits">0</td><td class="source">        var trackingAggregateTotalLinkPromise;</td></tr><tr><td class="line">772</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">773</td><td class="hits">0</td><td class="source">        var newFilter = JSONUtils.tryParseJSON(filter);</td></tr><tr class="miss"><td class="line">774</td><td class="hits">0</td><td class="source">        if(newFilter !== false) {</td></tr><tr class="miss"><td class="line">775</td><td class="hits">0</td><td class="source">            filter = newFilter;</td></tr><tr><td class="line">776</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">777</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">778</td><td class="hits">0</td><td class="source">        if(filter.date_range) {</td></tr><tr class="miss"><td class="line">779</td><td class="hits">0</td><td class="source">            from = moment(filter.date_range.from).startOf('day');</td></tr><tr class="miss"><td class="line">780</td><td class="hits">0</td><td class="source">            to = moment(filter.date_range.to).endOf('day');</td></tr><tr><td class="line">781</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">782</td><td class="hits">0</td><td class="source">            from = moment().subtract(10, 'days').startOf('day');</td></tr><tr class="miss"><td class="line">783</td><td class="hits">0</td><td class="source">            to = moment().endOf('day');</td></tr><tr><td class="line">784</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">785</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">786</td><td class="hits"></td><td class="source">        //first we need to setup our array properly</td></tr><tr><td class="line">787</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">788</td><td class="hits">0</td><td class="source">        for (var m = moment(from); m.isBefore(to); m.add('days', 1)) {</td></tr><tr class="miss"><td class="line">789</td><td class="hits">0</td><td class="source">            clicks_vs_links.raw_data.push({day: m.dayOfYear(), formattedDate: m.format(&quot;MM/DD&quot;), clicks:0, links:0});</td></tr><tr class="miss"><td class="line">790</td><td class="hits">0</td><td class="source">            clicks_vs_links.labels.push(m.format(&quot;MM/DD&quot;));</td></tr><tr class="miss"><td class="line">791</td><td class="hits">0</td><td class="source">            clicks_vs_links.clicks.push(0);</td></tr><tr class="miss"><td class="line">792</td><td class="hits">0</td><td class="source">            clicks_vs_links.links.push(0);</td></tr><tr><td class="line">793</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">794</td><td class="hits">0</td><td class="source">        var query = {</td></tr><tr><td class="line">795</td><td class="hits"></td><td class="source">            &quot;users.user&quot;: {</td></tr><tr><td class="line">796</td><td class="hits"></td><td class="source">                $in:[req.user._id]</td></tr><tr><td class="line">797</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">798</td><td class="hits"></td><td class="source">        };</td></tr><tr class="miss"><td class="line">799</td><td class="hits">0</td><td class="source">        if(filter) {</td></tr><tr class="miss"><td class="line">800</td><td class="hits">0</td><td class="source">            if(filter.users) {</td></tr><tr class="miss"><td class="line">801</td><td class="hits">0</td><td class="source">                query[&quot;users.user&quot;] = {</td></tr><tr><td class="line">802</td><td class="hits"></td><td class="source">                    $in:filter.users</td></tr><tr><td class="line">803</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">804</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">805</td><td class="hits">0</td><td class="source">            if(filter.campaigns) {</td></tr><tr class="miss"><td class="line">806</td><td class="hits">0</td><td class="source">                query._id = {</td></tr><tr><td class="line">807</td><td class="hits"></td><td class="source">                    $in: filter.campaigns</td></tr><tr><td class="line">808</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">809</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">810</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">811</td><td class="hits">0</td><td class="source">        var promise =</td></tr><tr><td class="line">812</td><td class="hits"></td><td class="source">            Campaign.Model</td></tr><tr><td class="line">813</td><td class="hits"></td><td class="source">                .find(query)</td></tr><tr><td class="line">814</td><td class="hits"></td><td class="source">                .populate(&quot;users.user&quot;, &quot;firstName lastName email trial trialStart gravatarHash&quot;)</td></tr><tr><td class="line">815</td><td class="hits"></td><td class="source">                .exec();</td></tr><tr><td class="line">816</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">817</td><td class="hits">0</td><td class="source">        promise.then(function(campaigns){</td></tr><tr class="miss"><td class="line">818</td><td class="hits">0</td><td class="source">            if(!campaigns || campaigns.length === 0) {</td></tr><tr class="miss"><td class="line">819</td><td class="hits">0</td><td class="source">                throw new Error('abort promise chain');</td></tr><tr><td class="line">820</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">821</td><td class="hits"></td><td class="source">            //this gives me all the campaigns a user is a part of</td></tr><tr class="miss"><td class="line">822</td><td class="hits">0</td><td class="source">            for(var i = 0; i &lt; campaigns.length; i++) {</td></tr><tr class="miss"><td class="line">823</td><td class="hits">0</td><td class="source">                var campaign = campaigns[i];</td></tr><tr class="miss"><td class="line">824</td><td class="hits">0</td><td class="source">                for(var j = 0; j &lt; campaign.users.length; j++) {</td></tr><tr class="miss"><td class="line">825</td><td class="hits">0</td><td class="source">                    if(filter.users) {</td></tr><tr class="miss"><td class="line">826</td><td class="hits">0</td><td class="source">                        if(campaign.users[j].user &amp;&amp; campaign.users[j].user) {</td></tr><tr class="miss"><td class="line">827</td><td class="hits">0</td><td class="source">                            var found = _.findWhere(filter.users, campaign.users[j].user._id);</td></tr><tr class="miss"><td class="line">828</td><td class="hits">0</td><td class="source">                            if(found) {</td></tr><tr class="miss"><td class="line">829</td><td class="hits">0</td><td class="source">                                teamIds.push(campaign.users[j].user._id); </td></tr><tr><td class="line">830</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">831</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">832</td><td class="hits"></td><td class="source">                    } else {</td></tr><tr class="miss"><td class="line">833</td><td class="hits">0</td><td class="source">                       if(campaign.users[j].user) {</td></tr><tr class="miss"><td class="line">834</td><td class="hits">0</td><td class="source">                            teamIds.push(campaign.users[j].user._id);</td></tr><tr><td class="line">835</td><td class="hits"></td><td class="source">                        } </td></tr><tr><td class="line">836</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">837</td><td class="hits"></td><td class="source">                    </td></tr><tr><td class="line">838</td><td class="hits"></td><td class="source">                    </td></tr><tr><td class="line">839</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">840</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">841</td><td class="hits">0</td><td class="source">            teamIds = ArrayUtils.uniqueArray(teamIds);</td></tr><tr class="miss"><td class="line">842</td><td class="hits">0</td><td class="source">            promise.complete();</td></tr><tr><td class="line">843</td><td class="hits"></td><td class="source">        }).then(function() {</td></tr><tr class="miss"><td class="line">844</td><td class="hits">0</td><td class="source">            var trackingQuery = {</td></tr><tr><td class="line">845</td><td class="hits"></td><td class="source">                user: {</td></tr><tr><td class="line">846</td><td class="hits"></td><td class="source">                    $in:teamIds</td></tr><tr><td class="line">847</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">848</td><td class="hits"></td><td class="source">            };</td></tr><tr class="miss"><td class="line">849</td><td class="hits">0</td><td class="source">            if(filter.campaigns) {</td></tr><tr class="miss"><td class="line">850</td><td class="hits">0</td><td class="source">                trackingQuery.campaign = {</td></tr><tr><td class="line">851</td><td class="hits"></td><td class="source">                    $in: filter.campaigns</td></tr><tr><td class="line">852</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">853</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">854</td><td class="hits">0</td><td class="source">            if(filter.date_range) {</td></tr><tr class="miss"><td class="line">855</td><td class="hits">0</td><td class="source">                trackingQuery.created = {</td></tr><tr><td class="line">856</td><td class="hits"></td><td class="source">                    &quot;$gte&quot;: from.toDate(), </td></tr><tr><td class="line">857</td><td class="hits"></td><td class="source">                    &quot;$lte&quot;: to.toDate()</td></tr><tr><td class="line">858</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">859</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">860</td><td class="hits"></td><td class="source">            // console.log(&quot;trackingQuery %j&quot;, trackingQuery);</td></tr><tr class="miss"><td class="line">861</td><td class="hits">0</td><td class="source">            trackingPromise =</td></tr><tr><td class="line">862</td><td class="hits"></td><td class="source">                TrackingUrl</td></tr><tr><td class="line">863</td><td class="hits"></td><td class="source">                    .find(trackingQuery)</td></tr><tr><td class="line">864</td><td class="hits"></td><td class="source">                    .populate(&quot;trackingPage&quot;, &quot;title url&quot;)</td></tr><tr><td class="line">865</td><td class="hits"></td><td class="source">                    .populate(&quot;user&quot;, &quot;firstName lastName email trial trialStart gravatarHash&quot;)</td></tr><tr><td class="line">866</td><td class="hits"></td><td class="source">                    .exec();</td></tr><tr class="miss"><td class="line">867</td><td class="hits">0</td><td class="source">            return trackingPromise;</td></tr><tr><td class="line">868</td><td class="hits"></td><td class="source">        }).then(function(urls){</td></tr><tr><td class="line">869</td><td class="hits"></td><td class="source">            // console.log(&quot;found urls %j&quot;, urls.length);</td></tr><tr class="miss"><td class="line">870</td><td class="hits">0</td><td class="source">            if(!urls || urls.length === 0) {</td></tr><tr class="miss"><td class="line">871</td><td class="hits">0</td><td class="source">                throw new Error('abort promise chain');</td></tr><tr><td class="line">872</td><td class="hits"></td><td class="source">                // return res.send(stats_summary);</td></tr><tr><td class="line">873</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">874</td><td class="hits">0</td><td class="source">            for(var k = 0; k &lt; urls.length; k++){</td></tr><tr class="miss"><td class="line">875</td><td class="hits">0</td><td class="source">                trackingIds.push(urls[k]._id);</td></tr><tr><td class="line">876</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">877</td><td class="hits">0</td><td class="source">            trackingPromise.complete();</td></tr><tr><td class="line">878</td><td class="hits"></td><td class="source">        }).then(function(){</td></tr><tr><td class="line">879</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">880</td><td class="hits">0</td><td class="source">            var trackingAggregateTotalClickQuery = [</td></tr><tr><td class="line">881</td><td class="hits"></td><td class="source">            {</td></tr><tr><td class="line">882</td><td class="hits"></td><td class="source">                $match: {</td></tr><tr><td class="line">883</td><td class="hits"></td><td class="source">                    trackingId: {</td></tr><tr><td class="line">884</td><td class="hits"></td><td class="source">                        $in:trackingIds</td></tr><tr><td class="line">885</td><td class="hits"></td><td class="source">                    },</td></tr><tr><td class="line">886</td><td class="hits"></td><td class="source">                    isBot:false,</td></tr><tr><td class="line">887</td><td class="hits"></td><td class="source">                    created : {</td></tr><tr><td class="line">888</td><td class="hits"></td><td class="source">                        &quot;$gte&quot;: from.toDate(), </td></tr><tr><td class="line">889</td><td class="hits"></td><td class="source">                        &quot;$lte&quot;: to.toDate()</td></tr><tr><td class="line">890</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">891</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">892</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">893</td><td class="hits"></td><td class="source">            {</td></tr><tr><td class="line">894</td><td class="hits"></td><td class="source">                $group: {</td></tr><tr><td class="line">895</td><td class="hits"></td><td class="source">                    _id: {$dayOfYear: &quot;$created&quot;},</td></tr><tr><td class="line">896</td><td class="hits"></td><td class="source">                    clicks: {$sum:1},</td></tr><tr><td class="line">897</td><td class="hits"></td><td class="source">                    first: {$min: &quot;$created&quot;}</td></tr><tr><td class="line">898</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">899</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">900</td><td class="hits"></td><td class="source">            { $sort: {_id: 1}}</td></tr><tr><td class="line">901</td><td class="hits"></td><td class="source">            ];</td></tr><tr><td class="line">902</td><td class="hits"></td><td class="source">            // console.log(&quot;aggregate query for clicks by day %j&quot;, trackingAggregateTotalClickQuery);</td></tr><tr class="miss"><td class="line">903</td><td class="hits">0</td><td class="source">            trackingAggregateTotalClickPromise =</td></tr><tr><td class="line">904</td><td class="hits"></td><td class="source">                TrackingUrlActivity</td></tr><tr><td class="line">905</td><td class="hits"></td><td class="source">                    .aggregate(trackingAggregateTotalClickQuery)</td></tr><tr><td class="line">906</td><td class="hits"></td><td class="source">                    .exec();</td></tr><tr class="miss"><td class="line">907</td><td class="hits">0</td><td class="source">            return trackingAggregateTotalClickPromise;</td></tr><tr><td class="line">908</td><td class="hits"></td><td class="source">        }).then(function(activities){</td></tr><tr class="miss"><td class="line">909</td><td class="hits">0</td><td class="source">            for(var i = 0; i &lt; clicks_vs_links.raw_data.length; i++) {</td></tr><tr class="miss"><td class="line">910</td><td class="hits">0</td><td class="source">                var activity = _.findWhere(activities, {_id:clicks_vs_links.raw_data[i].day});</td></tr><tr class="miss"><td class="line">911</td><td class="hits">0</td><td class="source">                if(activity) {</td></tr><tr class="miss"><td class="line">912</td><td class="hits">0</td><td class="source">                    clicks_vs_links.raw_data[i].clicks = activity.clicks;</td></tr><tr class="miss"><td class="line">913</td><td class="hits">0</td><td class="source">                    clicks_vs_links.clicks[i] = activity.clicks;</td></tr><tr><td class="line">914</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">915</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">916</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">917</td><td class="hits">0</td><td class="source">            var trackingAggregateTotalLinkQuery = [</td></tr><tr><td class="line">918</td><td class="hits"></td><td class="source">            {</td></tr><tr><td class="line">919</td><td class="hits"></td><td class="source">                $match: {</td></tr><tr><td class="line">920</td><td class="hits"></td><td class="source">                    _id: {</td></tr><tr><td class="line">921</td><td class="hits"></td><td class="source">                        $in:trackingIds</td></tr><tr><td class="line">922</td><td class="hits"></td><td class="source">                    },</td></tr><tr><td class="line">923</td><td class="hits"></td><td class="source">                    created : {</td></tr><tr><td class="line">924</td><td class="hits"></td><td class="source">                        &quot;$gte&quot;: from.toDate(), </td></tr><tr><td class="line">925</td><td class="hits"></td><td class="source">                        &quot;$lte&quot;: to.toDate()</td></tr><tr><td class="line">926</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">927</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">928</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">929</td><td class="hits"></td><td class="source">            {</td></tr><tr><td class="line">930</td><td class="hits"></td><td class="source">                $group: {</td></tr><tr><td class="line">931</td><td class="hits"></td><td class="source">                    _id: {$dayOfYear: &quot;$created&quot;},</td></tr><tr><td class="line">932</td><td class="hits"></td><td class="source">                    links: {$sum:1},</td></tr><tr><td class="line">933</td><td class="hits"></td><td class="source">                    first: {$min: &quot;$created&quot;}</td></tr><tr><td class="line">934</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">935</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">936</td><td class="hits"></td><td class="source">            { $sort: {_id: 1}}</td></tr><tr><td class="line">937</td><td class="hits"></td><td class="source">            ];</td></tr><tr><td class="line">938</td><td class="hits"></td><td class="source">            // console.log(&quot;aggregate query for clicks by day %j&quot;, trackingAggregateTotalLinkQuery);</td></tr><tr class="miss"><td class="line">939</td><td class="hits">0</td><td class="source">            trackingAggregateTotalLinkPromise =</td></tr><tr><td class="line">940</td><td class="hits"></td><td class="source">                TrackingUrl</td></tr><tr><td class="line">941</td><td class="hits"></td><td class="source">                    .aggregate(trackingAggregateTotalLinkQuery)</td></tr><tr><td class="line">942</td><td class="hits"></td><td class="source">                    .exec();</td></tr><tr class="miss"><td class="line">943</td><td class="hits">0</td><td class="source">            return trackingAggregateTotalLinkPromise;</td></tr><tr><td class="line">944</td><td class="hits"></td><td class="source">            // return res.send(activities);</td></tr><tr><td class="line">945</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">946</td><td class="hits"></td><td class="source">        }).then(function(links){</td></tr><tr class="miss"><td class="line">947</td><td class="hits">0</td><td class="source">            for(var i = 0; i &lt; clicks_vs_links.raw_data.length; i++) {</td></tr><tr class="miss"><td class="line">948</td><td class="hits">0</td><td class="source">                var link = _.findWhere(links, {_id:clicks_vs_links.raw_data[i].day});</td></tr><tr class="miss"><td class="line">949</td><td class="hits">0</td><td class="source">                if(link) {</td></tr><tr class="miss"><td class="line">950</td><td class="hits">0</td><td class="source">                    clicks_vs_links.raw_data[i].links = link.links;</td></tr><tr class="miss"><td class="line">951</td><td class="hits">0</td><td class="source">                    clicks_vs_links.links[i] = link.links;</td></tr><tr><td class="line">952</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">953</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">954</td><td class="hits"></td><td class="source">            // console.log(&quot;clicks_vs_links %j&quot;, clicks_vs_links);</td></tr><tr class="miss"><td class="line">955</td><td class="hits">0</td><td class="source">            return res.send(clicks_vs_links);</td></tr><tr><td class="line">956</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">957</td><td class="hits"></td><td class="source">        }).then(null, function(err){</td></tr><tr class="miss"><td class="line">958</td><td class="hits">0</td><td class="source">            if (err.message === 'abort promise chain') {</td></tr><tr class="miss"><td class="line">959</td><td class="hits">0</td><td class="source">                return res.send(clicks_vs_links);</td></tr><tr><td class="line">960</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">961</td><td class="hits"></td><td class="source">            else {</td></tr><tr class="miss"><td class="line">962</td><td class="hits">0</td><td class="source">                console.log(&quot;we got an error somewhere along the way&quot;, err);</td></tr><tr class="miss"><td class="line">963</td><td class="hits">0</td><td class="source">                next(err);</td></tr><tr><td class="line">964</td><td class="hits"></td><td class="source">            } </td></tr><tr><td class="line">965</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">966</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">967</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">968</td><td class="hits">1</td><td class="source">    var _dedupeSharedLinks = function(links) {</td></tr><tr><td class="line">969</td><td class="hits"></td><td class="source">        //need to do two loops through the same collection</td></tr><tr class="hit"><td class="line">970</td><td class="hits">6</td><td class="source">        var</td></tr><tr><td class="line">971</td><td class="hits"></td><td class="source">            newLinks = [],</td></tr><tr><td class="line">972</td><td class="hits"></td><td class="source">            dupeLinks = [],</td></tr><tr><td class="line">973</td><td class="hits"></td><td class="source">            aLink,</td></tr><tr><td class="line">974</td><td class="hits"></td><td class="source">            bLink,</td></tr><tr><td class="line">975</td><td class="hits"></td><td class="source">            foundLinks = [];</td></tr><tr><td class="line">976</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">977</td><td class="hits">6</td><td class="source">        for(var i = 0; i &lt; links.length; i++) {</td></tr><tr class="hit"><td class="line">978</td><td class="hits">79</td><td class="source">            aLink = links[i];</td></tr><tr class="hit"><td class="line">979</td><td class="hits">79</td><td class="source">            foundLinks = _.where(links, {trackingPage: aLink.trackingPage});</td></tr><tr class="hit"><td class="line">980</td><td class="hits">79</td><td class="source">            if(foundLinks &amp;&amp; foundLinks.length == 1) {</td></tr><tr class="hit"><td class="line">981</td><td class="hits">9</td><td class="source">                newLinks.push(foundLinks[0]);</td></tr><tr class="hit"><td class="line">982</td><td class="hits">70</td><td class="source">            } else if(foundLinks &amp;&amp; foundLinks.length &gt; 1) {</td></tr><tr class="hit"><td class="line">983</td><td class="hits">70</td><td class="source">                bLink = foundLinks[0];</td></tr><tr class="hit"><td class="line">984</td><td class="hits">70</td><td class="source">                if(!_.contains(dupeLinks, bLink.trackingPage)) {</td></tr><tr class="hit"><td class="line">985</td><td class="hits">24</td><td class="source">                    dupeLinks.push(bLink.trackingPage);</td></tr><tr class="hit"><td class="line">986</td><td class="hits">24</td><td class="source">                    for(var j = 1; j &lt; foundLinks.length; j++) {</td></tr><tr class="hit"><td class="line">987</td><td class="hits">46</td><td class="source">                        bLink.clicks += foundLinks[j].clicks;</td></tr><tr><td class="line">988</td><td class="hits"></td><td class="source">                        //find users</td></tr><tr class="hit"><td class="line">989</td><td class="hits">46</td><td class="source">                        if(bLink.users.length === 1) {</td></tr><tr class="hit"><td class="line">990</td><td class="hits">46</td><td class="source">                            var foundUser = _.findWhere(foundLinks[j].users, {&quot;_id&quot;: bLink.users[0]._id});</td></tr><tr class="hit"><td class="line">991</td><td class="hits">46</td><td class="source">                            if(foundUser &amp;&amp; foundUser.length === 0) {</td></tr><tr class="miss"><td class="line">992</td><td class="hits">0</td><td class="source">                                bLink.users.push(foundLinks[j].users[0]);</td></tr><tr><td class="line">993</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">994</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">995</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">996</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="hit"><td class="line">997</td><td class="hits">24</td><td class="source">                    newLinks.push(bLink);</td></tr><tr><td class="line">998</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">999</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="miss"><td class="line">1000</td><td class="hits">0</td><td class="source">                newLinks.push(aLink);</td></tr><tr><td class="line">1001</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">1002</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">1003</td><td class="hits">6</td><td class="source">        return newLinks;</td></tr><tr><td class="line">1004</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1005</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1006</td><td class="hits">1</td><td class="source">    var _sortByClicks = function(a, b) {</td></tr><tr class="hit"><td class="line">1007</td><td class="hits">106</td><td class="source">        if(a.total_clicks &gt;= 0) {</td></tr><tr class="miss"><td class="line">1008</td><td class="hits">0</td><td class="source">            if(a.total_clicks &gt; b.total_clicks) {</td></tr><tr class="miss"><td class="line">1009</td><td class="hits">0</td><td class="source">                return -1;</td></tr><tr><td class="line">1010</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">1011</td><td class="hits">0</td><td class="source">            if(a.total_clicks &lt; b.total_clicks) {</td></tr><tr class="miss"><td class="line">1012</td><td class="hits">0</td><td class="source">                return 1;</td></tr><tr><td class="line">1013</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">1014</td><td class="hits">0</td><td class="source">            if(a.total_shares &gt; b.total_shares) {</td></tr><tr class="miss"><td class="line">1015</td><td class="hits">0</td><td class="source">                return -1;</td></tr><tr><td class="line">1016</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">1017</td><td class="hits">0</td><td class="source">            if(a.total_shares &lt; b.total_shares) {</td></tr><tr class="miss"><td class="line">1018</td><td class="hits">0</td><td class="source">                return 1;</td></tr><tr><td class="line">1019</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">1020</td><td class="hits">106</td><td class="source">        } else if(a.clicks &gt;= 0) {</td></tr><tr class="hit"><td class="line">1021</td><td class="hits">106</td><td class="source">            if(a.clicks &gt; b.clicks) {</td></tr><tr class="hit"><td class="line">1022</td><td class="hits">31</td><td class="source">                return -1;</td></tr><tr><td class="line">1023</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">1024</td><td class="hits">75</td><td class="source">            if(a.clicks &lt; b.clicks) {</td></tr><tr class="hit"><td class="line">1025</td><td class="hits">17</td><td class="source">                return 1;</td></tr><tr><td class="line">1026</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">1027</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">1028</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1029</td><td class="hits">58</td><td class="source">        return 0;</td></tr><tr><td class="line">1030</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1031</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1032</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1033</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">1034</td><td class="hits"></td><td class="source">        teamStats: _teamStats,</td></tr><tr><td class="line">1035</td><td class="hits"></td><td class="source">        recentlyShared: _recentlyShared,</td></tr><tr><td class="line">1036</td><td class="hits"></td><td class="source">        popularLinks : _popularLinks,</td></tr><tr><td class="line">1037</td><td class="hits"></td><td class="source">        linksVsClicks: _linksVsClicks</td></tr><tr><td class="line">1038</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1039</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1040</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">1041</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1042</td><td class="hits">1</td><td class="source">module.exports = StatsController;</td></tr><tr><td class="line">1043</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/controllers/suggested_actions.js">/Users/warner/code/clipppr/primeloop-api/controllers/suggested_actions.js</h2><div id="stats" class="terrible"><div class="percentage">11%</div><div class="sloc">100</div><div class="hits">11</div><div class="misses">89</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var SuggestedActionsController = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        restify = require(&quot;restify&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        Clipp = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/clipp&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        ReportAdditions = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/report_additions&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        Email = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/email&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        SuggestedAction = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/suggested_action&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        SuggestedClipp = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/suggested_clipp&quot;),</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        ArrayUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/array&quot;),</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        Notebook = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/notebook&quot;),</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        ObjectUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/objects&quot;),</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        PermissionUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/permissions&quot;),</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;),</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        request = require(&quot;request&quot;),</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        restifyErrors = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/errors&quot;)(restify);</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">    var _list = function(req, res, next) {</td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">            notebook = req.params.notebook,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">            page = parseInt(req.params.page || 1, 10),</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">            per_page = parseInt(req.params.per_page || 20, 10),</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">            status_filter = req.params.status || &quot;admin&quot;,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">            type_filter = req.params.type || &quot;all&quot;;</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">            </td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="source">        if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">29</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;view_all_suggested_actions&quot;) &lt; 0) return next(new restify.NotAuthorizedError(&quot;You don't have permission to do that.&quot;));</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">                _id: notebook</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">            }, &quot;users name created&quot;)</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">            .populate(&quot;users.user&quot;)</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">                if(req.user.permissions.indexOf(&quot;suggested_actions&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to work with suggested actions&quot;));</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">                var query = {</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">                    status: status_filter,</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">                    notebook: notebook._id</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">                };</td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="source">                if(type_filter != &quot;all&quot;) {</td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">                    query.action_type = type_filter;</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">                SuggestedAction.Model</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">                    .find(query)</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">                    .limit(per_page)</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">                    .skip((page-1)*per_page)</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">                    .sort({created: -1})</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">                    .exec(function(err, actions){</td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">                        if(err) return next(err);</td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">                        return res.send({</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">                            suggested_actions: actions, </td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">                            notebook: notebook,</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">                            permissions: notebook.getPermissions(req.user),</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">                            page: page,</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">                            per_page: per_page</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">                </td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">            });     </td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">72</td><td class="hits">1</td><td class="source">    var _userList = function(req, res, next) {</td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="source">        var notebook_ids = [];</td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="source">        Notebook.getNotebooksForUser(req.user, function(err, notebooks){</td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="source">            notebooks = notebooks.filter(function(nb){</td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="source">                return PermissionUtils.getNotebookPermissionsForRole(nb.role).indexOf(&quot;view_suggested_actions_feed&quot;) &gt;= 0;</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">            notebook_ids = ObjectUtils.toFlatArray(notebooks, &quot;_id&quot;);</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="source">            SuggestedAction.Model</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">                .find({</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">                    status: &quot;current&quot;,</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">                    notebook: { $in : notebook_ids }</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">                .sort({sortValue: -1})</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">                .lean()</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">                .exec(function(err, actions){</td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">                    </td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">                    // for(var i = 0; i &lt; actions.length; i++){</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">                    //     actions[i].priority = actions[i].priority;</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">                    //     actions[i].save();</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">                    // }</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="source">                    return res.send({</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">                        actions: actions</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">104</td><td class="hits">1</td><td class="source">    var _add = function(req, res, next) {</td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">            suggAction = new SuggestedAction.Model(),</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">            notebook = req.params.notebook;</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">            </td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="source">        if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">                _id: notebook</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">            }, &quot;users name created&quot;)</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">            .populate(&quot;users.user&quot;)</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">121</td><td class="hits">0</td><td class="source">                if(req.user.permissions.indexOf(&quot;suggested_actions&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">122</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to work with suggested actions&quot;));</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">124</td><td class="hits">0</td><td class="source">                suggAction.setAll(req.params);</td></tr><tr class="miss"><td class="line">125</td><td class="hits">0</td><td class="source">                suggAction.save(function(err, saved){</td></tr><tr class="miss"><td class="line">126</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr class="miss"><td class="line">127</td><td class="hits">0</td><td class="source">                    return res.send(saved);</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">132</td><td class="hits">1</td><td class="source">    var _update = function(req, res, next) {</td></tr><tr class="miss"><td class="line">133</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">            notebook = req.params.notebook,</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">            action_id = req.params.action;</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">137</td><td class="hits">0</td><td class="source">        delete req.params.action; //this was updating the .action field to the id...</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">            </td></tr><tr class="miss"><td class="line">139</td><td class="hits">0</td><td class="source">        if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">141</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">                _id: notebook</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">            }, &quot;users name created&quot;)</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">            .populate(&quot;users.user&quot;)</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">147</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">149</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">151</td><td class="hits">0</td><td class="source">                if(req.user.permissions.indexOf(&quot;suggested_actions&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">152</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to work with suggested actions&quot;));</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">154</td><td class="hits">0</td><td class="source">                SuggestedAction.Model</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">                    .findOne({</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">                        _id:action_id</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">                    })</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">                    .exec(function(err, suggAction){</td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="source">                        if(err) return next(err);</td></tr><tr class="miss"><td class="line">160</td><td class="hits">0</td><td class="source">                        suggAction.setAll(req.params);</td></tr><tr class="miss"><td class="line">161</td><td class="hits">0</td><td class="source">                        suggAction.save(function(err, saved){</td></tr><tr class="miss"><td class="line">162</td><td class="hits">0</td><td class="source">                            if(err) return next(err);</td></tr><tr class="miss"><td class="line">163</td><td class="hits">0</td><td class="source">                            return res.send(saved);</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">                </td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">170</td><td class="hits">1</td><td class="source">    var _doAction = function(req, res, next) {</td></tr><tr class="miss"><td class="line">171</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">            id = req.params.id,</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">            status = req.params.status || &quot;completed&quot;,</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">            actionHandler;</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">177</td><td class="hits">0</td><td class="source">        SuggestedAction.Model</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">                _id: id,</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">                status: &quot;current&quot;</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">            .populate(&quot;notebook&quot;)</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">            .exec(function(err, action){</td></tr><tr class="miss"><td class="line">184</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">186</td><td class="hits">0</td><td class="source">                if(!action) return next(restify.ResourceNotFoundError(&quot;Action not found.&quot;));</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">188</td><td class="hits">0</td><td class="source">                if(status &amp;&amp; status != &quot;completed&quot;){ </td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">                    //Make sure user has permissions</td></tr><tr class="miss"><td class="line">190</td><td class="hits">0</td><td class="source">                    if(action.notebook.getPermissions(req.user).indexOf(&quot;take_suggested_action&quot;) &lt; 0) return next(new restify.NotAuthorizedError(&quot;You don't have permission to do that.&quot;));</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">                //figure out what the action is</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">                //check user permission for the action</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source">                </td></tr><tr class="miss"><td class="line">196</td><td class="hits">0</td><td class="source">                if(status != &quot;completed&quot;) actionHandler = _getActionHandler(req.user, action.notebook, action.action_type + &quot;_&quot; + status, action.action + &quot;_&quot; + status);</td></tr><tr class="miss"><td class="line">197</td><td class="hits">0</td><td class="source">                else actionHandler = _getActionHandler(req.user, action.notebook, action.action_type, action.action);</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">199</td><td class="hits">0</td><td class="source">                if(!actionHandler) return next(&quot;Action not found...&quot;);</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">                //do the action if there is something to do (like add to report)</td></tr><tr class="miss"><td class="line">202</td><td class="hits">0</td><td class="source">                actionHandler(action, function(err, result){</td></tr><tr class="miss"><td class="line">203</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">205</td><td class="hits">0</td><td class="source">                    action.completedBy = req.user._id;</td></tr><tr class="miss"><td class="line">206</td><td class="hits">0</td><td class="source">                    action.status = status;</td></tr><tr class="miss"><td class="line">207</td><td class="hits">0</td><td class="source">                    action.markModified(&quot;status&quot;);</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">209</td><td class="hits">0</td><td class="source">                    action.save(function(err, saved){</td></tr><tr class="miss"><td class="line">210</td><td class="hits">0</td><td class="source">                        if(err) return next(err);</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">212</td><td class="hits">0</td><td class="source">                        res.send({</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source">                            code: 200,</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">                            message: &quot;Action &quot; + status</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source">                </td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">223</td><td class="hits">1</td><td class="source">    var _actionHandler = function(user, notebook){</td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">225</td><td class="hits">0</td><td class="source">        var _addToReport = function(action, done) {</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">227</td><td class="hits">0</td><td class="source">            if(notebook.getPermissions(user).indexOf(&quot;add_to_report&quot;) &lt; 0) return done(new restify.NotAuthorizedError(&quot;You don't have permission to do that.&quot;));</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">229</td><td class="hits">0</td><td class="source">            var addition = new ReportAdditions.Model({</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">                action: action,</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">                addedBy: user._id,</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">                notebook: notebook._id || notebook,</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">                clipp: (action.data.clipp) ? action.data.clipp._id : null,</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">236</td><td class="hits">0</td><td class="source">            addition.save(done);</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">239</td><td class="hits">0</td><td class="source">        var _createNotebook = function(action, done){</td></tr><tr class="miss"><td class="line">240</td><td class="hits">0</td><td class="source">            var company = action.data.company || null;</td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">242</td><td class="hits">0</td><td class="source">            var email = new Email.Model({</td></tr><tr><td class="line">243</td><td class="hits"></td><td class="source">                from: Settings.email.from,</td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source">                cc: &quot;hello@primeloop.com&quot;,</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source">                to: user.email,</td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source">                subject: (company &amp;&amp; company.name) ? company.name + &quot; Notebook Request&quot; : &quot;Competitor Notebook Request&quot;,</td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source">                template: {</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source">                    contentType: &quot;text&quot;, </td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">                    name: &quot;request_notebook.mu&quot;,</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source">                    data: {</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source">                        user: user,</td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source">                        company: company</td></tr><tr><td class="line">253</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">257</td><td class="hits">0</td><td class="source">            email.renderTemplate(null, null, null, function(err, text){</td></tr><tr class="miss"><td class="line">258</td><td class="hits">0</td><td class="source">                return email.send(done);</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">262</td><td class="hits">0</td><td class="source">        var _addSuggestedClipp = function(action, done){</td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">264</td><td class="hits">0</td><td class="source">            if(notebook.getPermissions(user).indexOf(&quot;add_clipp_to_notebook&quot;) &lt; 0) return done(new restify.NotAuthorizedError(&quot;You don't have permission to do that.&quot;));</td></tr><tr class="miss"><td class="line">265</td><td class="hits">0</td><td class="source">            SuggestedClipp.convertToNormalClippsMany(notebook, [action.data.suggested_clipp._id], done);</td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">267</td><td class="hits"></td><td class="source">            //User clipped it yo</td></tr><tr class="miss"><td class="line">268</td><td class="hits">0</td><td class="source">            SuggestedClipp.Model.findOne({</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">                _id: action.data.suggested_clipp._id</td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source">            }, function(err, sclipp){</td></tr><tr class="miss"><td class="line">271</td><td class="hits">0</td><td class="source">                if(err) return console.log(&quot;Error archiving suggested clipp:&quot;, err);</td></tr><tr class="miss"><td class="line">272</td><td class="hits">0</td><td class="source">                sclipp.userClipped = true;</td></tr><tr class="miss"><td class="line">273</td><td class="hits">0</td><td class="source">                SuggestedClipp.Archive.add(sclipp, function(err){</td></tr><tr class="miss"><td class="line">274</td><td class="hits">0</td><td class="source">                    if(err) console.log(&quot;Error archving suggested clipp&quot;, err);</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">276</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">279</td><td class="hits">0</td><td class="source">        var _archiveSuggestedClipp = function(action, done) {</td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">281</td><td class="hits">0</td><td class="source">            if(notebook.getPermissions(user).indexOf(&quot;add_clipp_to_notebook&quot;) &lt; 0) return done(new restify.NotAuthorizedError(&quot;You don't have permission to do that.&quot;));</td></tr><tr class="miss"><td class="line">282</td><td class="hits">0</td><td class="source">            SuggestedClipp.Archive.addMany([action.data.suggested_clipp._id], done);</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">285</td><td class="hits">0</td><td class="source">        return {</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source">            types: { //take action by type</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source">                &quot;add_to_report&quot;: _addToReport,</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">                &quot;create_notebook&quot;: _createNotebook</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source">            names: { //more specific actions</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source">                &quot;suggested_clipp&quot;: _addSuggestedClipp,</td></tr><tr><td class="line">292</td><td class="hits"></td><td class="source">                &quot;suggested_clipp_ignored&quot;: _archiveSuggestedClipp</td></tr><tr><td class="line">293</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">295</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">296</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">297</td><td class="hits">1</td><td class="source">    var _getActionHandler = function(user, notebook, actionType, actionName) {</td></tr><tr class="miss"><td class="line">298</td><td class="hits">0</td><td class="source">        var handler = new _actionHandler(user, notebook).types[actionType]; //check type first</td></tr><tr class="miss"><td class="line">299</td><td class="hits">0</td><td class="source">        if(!handler &amp;&amp; actionName) handler = new _actionHandler(user, notebook).names[actionName];</td></tr><tr class="miss"><td class="line">300</td><td class="hits">0</td><td class="source">        if(!handler) handler = function(action, done){ return process.nextTick(done); };</td></tr><tr class="miss"><td class="line">301</td><td class="hits">0</td><td class="source">        return handler;</td></tr><tr><td class="line">302</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">303</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">304</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">305</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">306</td><td class="hits"></td><td class="source">        list: _list,</td></tr><tr><td class="line">307</td><td class="hits"></td><td class="source">        userList: _userList,</td></tr><tr><td class="line">308</td><td class="hits"></td><td class="source">        add: _add,</td></tr><tr><td class="line">309</td><td class="hits"></td><td class="source">        update: _update,</td></tr><tr><td class="line">310</td><td class="hits"></td><td class="source">        doAction: _doAction</td></tr><tr><td class="line">311</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">312</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">313</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">315</td><td class="hits">1</td><td class="source">module.exports = SuggestedActionsController;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/controllers/suggested_clipps.js">/Users/warner/code/clipppr/primeloop-api/controllers/suggested_clipps.js</h2><div id="stats" class="terrible"><div class="percentage">7%</div><div class="sloc">146</div><div class="hits">11</div><div class="misses">135</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var SuggestedClippsController = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        restify = require(&quot;restify&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        Clipp = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/clipp&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        SuggestedClipp = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/suggested_clipp&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        SuggestedBatchImport = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/suggested_batch_import&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        ArrayUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/array&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        Notebook = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/notebook&quot;),</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;),</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        request = require(&quot;request&quot;),</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        cheerio = require(&quot;cheerio&quot;),</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        restifyErrors = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/errors&quot;)(restify),</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        redisq = require('redisq'),</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        Moz = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../moz&quot;)(Settings.moz.access_id, Settings.moz.secret);</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">    var _list = function(req, res, next) {</td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">            notebook = req.params.notebook,</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">            page = parseInt(req.params.page || 1, 10),</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">            per_page = parseInt(req.params.per_page || 20, 10);</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">            </td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">        if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">                _id: notebook,</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">                &quot;users.user&quot; : req.user._id</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">            }, &quot;users name created&quot;)</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">            // .populate(&quot;clipps.clipp&quot;, null, null, { sort: {&quot;engagement.rank.current&quot; : -1}, limit: per_page, skip: (page-1)*per_page }) </td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">            .populate(&quot;users.user&quot;, &quot;refBy&quot;)</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">40</td><td class="hits">0</td><td class="source">                if(notebook.getPermissions(req.user).indexOf(&quot;view_notebook_clipps&quot;) &lt; 0 &amp;&amp; req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">                    </td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">                    if(req.user.permissions.indexOf(&quot;view_referred_accounts&quot;) &lt; 0){</td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">                        var owner;</td></tr><tr class="miss"><td class="line">44</td><td class="hits">0</td><td class="source">                        notebook.users.map(function(user){</td></tr><tr class="miss"><td class="line">45</td><td class="hits">0</td><td class="source">                            if(user.role == &quot;owner&quot;) owner = user.user;</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="source">                        if(!owner) {</td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">                            return next(new restify.NotAuthorizedError(&quot;You don't have permissions to add a clipp to this notebook&quot;));</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">                        if(owner.refBy != req.user._id){</td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="source">                            return next(new restify.NotAuthorizedError(&quot;You don't have permissions to add a clipp to this notebook&quot;));</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">                    else return next(new restify.NotAuthorizedError(&quot;You don't have permissions to view this notebooks clipps&quot;));</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">                SuggestedClipp.Model</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">                    .find({</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">                        notebook:notebook._id,</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">                        userClipped: false</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">                    })</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">                    .limit(per_page)</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">                    .skip((page-1)*per_page)</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">                    .exec(function(err, clipps){</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="source">                        if(err) return next(err);</td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="source">                        return res.send({</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">                            clipps: clipps, </td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">                            notebook: notebook,</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">                            permissions: notebook.getPermissions(req.user),</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">                            page: page,</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">                            per_page: per_page</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">                        //TODO: see how we're logging errors for suggested clipps</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">                        /*SuggestedClipp.Model.populate(clipps, </td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">                            {path: 'page.error', model: PageError.Model}, function(err, populated) {</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">                                // console.log(&quot;clipps before calling prepare&quot; + JSON.stringify(populated));</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">                                clipps = Clipp.prepareMultipleForOutput(populated, req.user);</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">                                </td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">                                return res.send({</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">                                    clipps: clipps, </td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">                                    notebook: notebook,</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">                                    permissions: notebook.getPermissions(req.user),</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">                                    page: page,</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">                                    per_page: per_page,</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">                                    sort: &quot;rank&quot;</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">                                });</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">                            });*/</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">                        </td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">            });     </td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">97</td><td class="hits">1</td><td class="source">   var _adminList = function(req, res, next) {</td></tr><tr class="miss"><td class="line">98</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">            notebook = req.params.notebook,</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">            page = parseInt(req.params.page || 1, 10),</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">            per_page = parseInt(req.params.per_page || 20, 10);</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">            </td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="source">        if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permisison to view another user's notebooks&quot;));</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="source">        SuggestedClipp.Model</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">                notebook:notebook,</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">                userClipped: false</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">            .limit(per_page)</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">            .populate(&quot;error notebook&quot;)</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">            .skip((page-1)*per_page)</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">            .exec(function(err, clipps){</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr class="miss"><td class="line">118</td><td class="hits">0</td><td class="source">                return res.send({</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">                    clipps: clipps, </td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">                    page: page,</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">                    per_page: per_page</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">                </td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">127</td><td class="hits">1</td><td class="source">    var _importClipps = function(req, res, next) {</td></tr><tr class="miss"><td class="line">128</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">            urls = req.params.urls,</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">            notebook = req.params.notebook,</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">            batch = new SuggestedBatchImport.Model();</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">133</td><td class="hits">0</td><td class="source">        redisq.options({</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">            &quot;redis&quot;: {</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">                &quot;host&quot;: Settings.redisq.options.host,</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">                &quot;port&quot;: Settings.redisq.options.port,</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">                &quot;password&quot;: Settings.redisq.options.pass</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">        });</td></tr><tr class="miss"><td class="line">140</td><td class="hits">0</td><td class="source">        var suggested_link_import_queue = redisq.queue(Settings.jobs.suggested_link_import);</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">142</td><td class="hits">0</td><td class="source">        if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr class="miss"><td class="line">143</td><td class="hits">0</td><td class="source">        if(!urls) return next(new restifyErrors.InvalidInputError(&quot;urls parameter is required&quot;));</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">145</td><td class="hits">0</td><td class="source">        var nbquery = {</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">            _id: notebook</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">        };</td></tr><tr class="miss"><td class="line">148</td><td class="hits">0</td><td class="source">        var permToAddSuggestedLinks = false;</td></tr><tr class="miss"><td class="line">149</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;import_links_to_account&quot;) &gt;= 0 || req.user.permissions.indexOf(&quot;edit_notebook_on_referred_account&quot;) &gt;= 0) {</td></tr><tr class="miss"><td class="line">150</td><td class="hits">0</td><td class="source">            permToAddSuggestedLinks = true;</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">152</td><td class="hits">0</td><td class="source">            nbquery[&quot;users.user&quot;] = req.user._id;</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">155</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">            .findOne(nbquery)</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">158</td><td class="hits">0</td><td class="source">                if(err) console.log(err);</td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">161</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr class="miss"><td class="line">162</td><td class="hits">0</td><td class="source">                if(!permToAddSuggestedLinks) {</td></tr><tr class="miss"><td class="line">163</td><td class="hits">0</td><td class="source">                    permToAddSuggestedLinks = notebook.getPermissions(req.user).indexOf(&quot;add_clipp_to_notebook&quot;) &lt; 0;</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">165</td><td class="hits">0</td><td class="source">                if(!permToAddSuggestedLinks) { </td></tr><tr class="miss"><td class="line">166</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to add a clipp to this notebook&quot;));</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">                //only unique urls and non-empty lines</td></tr><tr class="miss"><td class="line">169</td><td class="hits">0</td><td class="source">                urls = ArrayUtils.nonEmptyElements(urls);</td></tr><tr class="miss"><td class="line">170</td><td class="hits">0</td><td class="source">                var validatedUrls = ArrayUtils.sanitizeAndValidateArray(urls);</td></tr><tr class="miss"><td class="line">171</td><td class="hits">0</td><td class="source">                urls = validatedUrls[0];</td></tr><tr class="miss"><td class="line">172</td><td class="hits">0</td><td class="source">                var badUrls = validatedUrls[1];</td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="source">                urls = ArrayUtils.uniqueArray(urls);</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">175</td><td class="hits">0</td><td class="source">                res.send({</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">                    batch: batch._id,</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">                    count: urls.length</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">180</td><td class="hits">0</td><td class="source">                var jobUrls = [];</td></tr><tr class="miss"><td class="line">181</td><td class="hits">0</td><td class="source">                var firstBatch;</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">                //initially we only care about the first 5, the rest are going to get chunked and added as jobs</td></tr><tr class="miss"><td class="line">183</td><td class="hits">0</td><td class="source">                jobUrls = ArrayUtils.sliceIntoGroups(urls, 5);</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">                //now that we have these created we just need to dump them into the batch</td></tr><tr class="miss"><td class="line">186</td><td class="hits">0</td><td class="source">                batch.notebook = notebook;</td></tr><tr class="miss"><td class="line">187</td><td class="hits">0</td><td class="source">                batch.user = req.user._id;</td></tr><tr class="miss"><td class="line">188</td><td class="hits">0</td><td class="source">                batch.jobSize = 5;</td></tr><tr class="miss"><td class="line">189</td><td class="hits">0</td><td class="source">                batch.numJobs = jobUrls.length;</td></tr><tr class="miss"><td class="line">190</td><td class="hits">0</td><td class="source">                batch.totalToBeProcessed = urls.length;</td></tr><tr class="miss"><td class="line">191</td><td class="hits">0</td><td class="source">                batch.totalProcessed = 0;</td></tr><tr class="miss"><td class="line">192</td><td class="hits">0</td><td class="source">                batch.problemUrls = badUrls;</td></tr><tr class="miss"><td class="line">193</td><td class="hits">0</td><td class="source">                for(var j in jobUrls) {</td></tr><tr class="miss"><td class="line">194</td><td class="hits">0</td><td class="source">                    var job = jobUrls[j];</td></tr><tr class="miss"><td class="line">195</td><td class="hits">0</td><td class="source">                    batch.jobs.push({urls: job});</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">                //console.log(&quot;batch import: &quot; + JSON.stringify(batch));</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">                //save the batch, then start processing</td></tr><tr class="miss"><td class="line">200</td><td class="hits">0</td><td class="source">                batch.save(function(err, saved){</td></tr><tr class="miss"><td class="line">201</td><td class="hits">0</td><td class="source">                    if(err) return console.log(&quot;error saving batch: &quot; +err);//bail before processing</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">                    //console.log(&quot;batch import saved&quot;);</td></tr><tr class="miss"><td class="line">203</td><td class="hits">0</td><td class="source">                    firstBatch = saved.jobs[0].urls;</td></tr><tr class="miss"><td class="line">204</td><td class="hits">0</td><td class="source">                    SuggestedBatchImport.processChunk(saved, firstBatch, function(er, results){</td></tr><tr class="miss"><td class="line">205</td><td class="hits">0</td><td class="source">                        if(er) console.log(&quot;there was a problem processing batch: &quot; + er);</td></tr><tr class="miss"><td class="line">206</td><td class="hits">0</td><td class="source">                        for(var k = 1;  k&lt;saved.numJobs; k++) {</td></tr><tr class="miss"><td class="line">207</td><td class="hits">0</td><td class="source">                            var job = {</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">                                batch: saved._id,</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source">                                idx: k,</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">                                id: saved.jobs[k]._id</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">                            };</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">                            //console.log(&quot;pushing job onto stack: &quot; + JSON.stringify(job));</td></tr><tr class="miss"><td class="line">213</td><td class="hits">0</td><td class="source">                            suggested_link_import_queue.push(job, pushJob);</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">216</td><td class="hits">0</td><td class="source">                        var pushJob = function(err, res) {</td></tr><tr class="miss"><td class="line">217</td><td class="hits">0</td><td class="source">                            if(err) console.log(&quot;Error scheduling link import job&quot;, err);</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">                        };</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">220</td><td class="hits">0</td><td class="source">                        if(saved.jobs.length &lt;= 1) {</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source">                            //mark and save the batch as processed</td></tr><tr class="miss"><td class="line">222</td><td class="hits">0</td><td class="source">                            saved.processed = true;</td></tr><tr class="miss"><td class="line">223</td><td class="hits">0</td><td class="source">                            saved.totalProcessed = firstBatch.length;</td></tr><tr class="miss"><td class="line">224</td><td class="hits">0</td><td class="source">                            saved.logs = results.logs;</td></tr><tr class="miss"><td class="line">225</td><td class="hits">0</td><td class="source">                            saved.save(function(er) {</td></tr><tr class="miss"><td class="line">226</td><td class="hits">0</td><td class="source">                                if(er) console.log(&quot;error occurred updating batch&quot;, er);</td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source">                        }  else {</td></tr><tr class="miss"><td class="line">229</td><td class="hits">0</td><td class="source">                            SuggestedBatchImport.Model</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">                                .update(</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">                                    {_id: saved._id}, </td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">                                    {</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">                                        $inc: {totalProcessed: firstBatch.length},</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source">                                        $push: { logs: { $each: results.logs }}</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">                                    }, function(er) {</td></tr><tr class="miss"><td class="line">236</td><td class="hits">0</td><td class="source">                                        if(er) console.log(&quot;error occurred updating batch&quot;, er);</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source">                                    });</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">243</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">244</td><td class="hits">1</td><td class="source">    var _archiveClipps = function(req, res, next) {</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source">        //console.log(&quot;calling archiveClipps&quot;);</td></tr><tr class="miss"><td class="line">246</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source">            notebook = req.params.notebook,</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source">            clipps = req.params.clipps, </td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">            permissions = [],</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source">            can_edit;</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">252</td><td class="hits">0</td><td class="source">        if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr class="miss"><td class="line">253</td><td class="hits">0</td><td class="source">        if(!clipps) return next(new restify.InvalidInputError(&quot;No clipps to archive sent&quot;));</td></tr><tr class="miss"><td class="line">254</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source">                _id: notebook</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source">                // &quot;users.user&quot; : req.user._id </td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source">            .populate(&quot;clipps.clipp&quot;, &quot;url&quot;)</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">261</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr class="miss"><td class="line">262</td><td class="hits">0</td><td class="source">                console.log(&quot;found notebook associated with clipps&quot;);</td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">264</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr class="miss"><td class="line">265</td><td class="hits">0</td><td class="source">                if(notebook.getPermissions(req.user).indexOf(&quot;add_clipp_to_notebook&quot;) &lt; 0 &amp;&amp; req.user.permissions.indexOf(&quot;edit_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">266</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to add a clipp to this notebook&quot;));</td></tr><tr><td class="line">267</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">                //now we need to pull many and archive them - nope already have a function :)</td></tr><tr class="miss"><td class="line">270</td><td class="hits">0</td><td class="source">                SuggestedClipp.Archive</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source">                    .addMany(clipps, function(err, saved){</td></tr><tr><td class="line">272</td><td class="hits"></td><td class="source">                        //console.log(&quot;attempting to archive suggested clipps&quot;);</td></tr><tr class="miss"><td class="line">273</td><td class="hits">0</td><td class="source">                        if(err) return next(err);</td></tr><tr class="miss"><td class="line">274</td><td class="hits">0</td><td class="source">                        return res.send({ count: saved });</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">276</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">279</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">280</td><td class="hits">1</td><td class="source">    var _addClippsToNotebook = function(req, res, next) {</td></tr><tr class="miss"><td class="line">281</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source">            notebook = req.params.notebook,</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source">            clipps = req.params.clipps, </td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source">            permissions = [],</td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source">            can_edit;</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">287</td><td class="hits">0</td><td class="source">        if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr class="miss"><td class="line">288</td><td class="hits">0</td><td class="source">        if(!clipps) return next(new restify.InvalidInputError(&quot;No clipps to move sent&quot;));</td></tr><tr class="miss"><td class="line">289</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source">                _id: notebook,</td></tr><tr><td class="line">292</td><td class="hits"></td><td class="source">                &quot;users.user&quot; : req.user._id</td></tr><tr><td class="line">293</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source">            .populate(&quot;clipps.clipp&quot;, &quot;url&quot;)</td></tr><tr><td class="line">295</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">296</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">297</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">298</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr class="miss"><td class="line">299</td><td class="hits">0</td><td class="source">                if(notebook.getPermissions(req.user).indexOf(&quot;add_clipp_to_notebook&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">300</td><td class="hits">0</td><td class="source">                    return next(new restify.NotAuthorizedError(&quot;You don't have permissions to add a clipp to this notebook&quot;));</td></tr><tr><td class="line">301</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">302</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">303</td><td class="hits"></td><td class="source">                //first we need to convert the suggested clipps to actual clipps</td></tr><tr class="miss"><td class="line">304</td><td class="hits">0</td><td class="source">                SuggestedClipp.convertToNormalClippsMany(notebook, clipps, function(err){</td></tr><tr class="miss"><td class="line">305</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr class="miss"><td class="line">306</td><td class="hits">0</td><td class="source">                    SuggestedClipp.Archive</td></tr><tr><td class="line">307</td><td class="hits"></td><td class="source">                        .addMany(clipps, function(err, saved){</td></tr><tr class="miss"><td class="line">308</td><td class="hits">0</td><td class="source">                            if(err) return next(err);</td></tr><tr class="miss"><td class="line">309</td><td class="hits">0</td><td class="source">                            return res.send(saved);</td></tr><tr><td class="line">310</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">311</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">312</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">313</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">315</td><td class="hits">1</td><td class="source">    var _init = function(req, res, next) {</td></tr><tr class="miss"><td class="line">316</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">317</td><td class="hits"></td><td class="source">            mozLinkLimit = parseInt(req.params.mozLimit || 25, 10),</td></tr><tr><td class="line">318</td><td class="hits"></td><td class="source">            suggestedClipLimit = parseInt(req.params.limit || 10, 10),</td></tr><tr><td class="line">319</td><td class="hits"></td><td class="source">            domain,</td></tr><tr><td class="line">320</td><td class="hits"></td><td class="source">            notebookId = req.params.notebook,</td></tr><tr><td class="line">321</td><td class="hits"></td><td class="source">            email = req.user.email,</td></tr><tr><td class="line">322</td><td class="hits"></td><td class="source">            atIndex = email.indexOf(&quot;@&quot;);</td></tr><tr><td class="line">323</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">324</td><td class="hits">0</td><td class="source">        if(!notebookId) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr class="miss"><td class="line">325</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">326</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">327</td><td class="hits"></td><td class="source">                _id: notebookId</td></tr><tr><td class="line">328</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">329</td><td class="hits"></td><td class="source">            .populate(&quot;alertsTracking googleAnalytics&quot;)</td></tr><tr><td class="line">330</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">331</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">332</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">333</td><td class="hits">0</td><td class="source">                if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">334</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">335</td><td class="hits">0</td><td class="source">                if(notebook.alertsTracking &amp;&amp; notebook.alertsTracking.sites){ </td></tr><tr class="miss"><td class="line">336</td><td class="hits">0</td><td class="source">                    domain = notebook.alertsTracking.sites[0];</td></tr><tr><td class="line">337</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">338</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">339</td><td class="hits">0</td><td class="source">                domain = domain || email.slice((atIndex + 1), email.length);</td></tr><tr><td class="line">340</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">341</td><td class="hits">0</td><td class="source">                Moz.api({</td></tr><tr><td class="line">342</td><td class="hits"></td><td class="source">                    resource: &quot;linkscape&quot;,</td></tr><tr><td class="line">343</td><td class="hits"></td><td class="source">                    endpoint: &quot;links&quot;,</td></tr><tr><td class="line">344</td><td class="hits"></td><td class="source">                    targetUrl: domain,</td></tr><tr><td class="line">345</td><td class="hits"></td><td class="source">                    params: {</td></tr><tr><td class="line">346</td><td class="hits"></td><td class="source">                        &quot;Scope&quot;: &quot;page_to_domain&quot;,</td></tr><tr><td class="line">347</td><td class="hits"></td><td class="source">                        &quot;Sort&quot;: &quot;domains_linking_page&quot;,</td></tr><tr><td class="line">348</td><td class="hits"></td><td class="source">                        &quot;Limit&quot;: mozLinkLimit,</td></tr><tr><td class="line">349</td><td class="hits"></td><td class="source">                        &quot;LinkCols&quot;: 8,</td></tr><tr><td class="line">350</td><td class="hits"></td><td class="source">                        &quot;TargetCols&quot;: 4,</td></tr><tr><td class="line">351</td><td class="hits"></td><td class="source">                        &quot;sourceCols&quot;: 4,</td></tr><tr><td class="line">352</td><td class="hits"></td><td class="source">                        &quot;Filter&quot;: &quot;external&quot;</td></tr><tr><td class="line">353</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">354</td><td class="hits"></td><td class="source">                }, function(err, links){</td></tr><tr class="miss"><td class="line">355</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr class="miss"><td class="line">356</td><td class="hits">0</td><td class="source">                    if(typeof links === &quot;undefined&quot; || links.length === 0) {</td></tr><tr class="miss"><td class="line">357</td><td class="hits">0</td><td class="source">                        return next(new restify.ResourceNotFoundError(&quot;No links found.&quot;));</td></tr><tr><td class="line">358</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">359</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">360</td><td class="hits">0</td><td class="source">                    var</td></tr><tr><td class="line">361</td><td class="hits"></td><td class="source">                        linksRemaining,</td></tr><tr><td class="line">362</td><td class="hits"></td><td class="source">                        linksToProcess = [],</td></tr><tr><td class="line">363</td><td class="hits"></td><td class="source">                        suggestedClipsSaved = [],</td></tr><tr><td class="line">364</td><td class="hits"></td><td class="source">                        permissions = notebook.getPermissions(req.user),</td></tr><tr><td class="line">365</td><td class="hits"></td><td class="source">                        checkAndFinishClips = function(err, data) {</td></tr><tr class="miss"><td class="line">366</td><td class="hits">0</td><td class="source">                            if(err) return next(err);</td></tr><tr class="miss"><td class="line">367</td><td class="hits">0</td><td class="source">                            suggestedClipsSaved.push(data);</td></tr><tr class="miss"><td class="line">368</td><td class="hits">0</td><td class="source">                            if(--linksRemaining === 0) return res.send({</td></tr><tr><td class="line">369</td><td class="hits"></td><td class="source">                                notebook: notebook,</td></tr><tr><td class="line">370</td><td class="hits"></td><td class="source">                                clips: suggestedClipsSaved,</td></tr><tr><td class="line">371</td><td class="hits"></td><td class="source">                                permissions: permissions</td></tr><tr><td class="line">372</td><td class="hits"></td><td class="source">                                });</td></tr><tr><td class="line">373</td><td class="hits"></td><td class="source">                        };</td></tr><tr><td class="line">374</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">375</td><td class="hits">0</td><td class="source">                    for (var i = 0; i &lt; links.length &amp;&amp; linksToProcess.length &lt; suggestedClipLimit; i++) {</td></tr><tr class="miss"><td class="line">376</td><td class="hits">0</td><td class="source">                        if(!links[i]) break;</td></tr><tr><td class="line">377</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">378</td><td class="hits">0</td><td class="source">                        var linkToCheck = links[i].luuu;</td></tr><tr class="miss"><td class="line">379</td><td class="hits">0</td><td class="source">                        if(typeof linkToCheck === &quot;undefined&quot; || typeof links[i].ut === &quot;undefined&quot;) continue;</td></tr><tr><td class="line">380</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">381</td><td class="hits"></td><td class="source">                        // just domain, no path</td></tr><tr class="miss"><td class="line">382</td><td class="hits">0</td><td class="source">                        if(linkToCheck.indexOf(&quot;/&quot;) &lt; 0 || ((linkToCheck.split(&quot;/&quot;).length - 1 === 1) &amp;&amp; (linkToCheck.charAt(linkToCheck.length -1)))) continue;</td></tr><tr class="miss"><td class="line">383</td><td class="hits">0</td><td class="source">                        linksToProcess.push(links[i]);</td></tr><tr><td class="line">384</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">385</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">386</td><td class="hits">0</td><td class="source">                    linksRemaining = linksToProcess.length;</td></tr><tr><td class="line">387</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">388</td><td class="hits">0</td><td class="source">                    if(linksRemaining === 0) {</td></tr><tr class="miss"><td class="line">389</td><td class="hits">0</td><td class="source">                        return next(new restify.ResourceNotFoundError(&quot;No links found.&quot;));</td></tr><tr><td class="line">390</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">391</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">392</td><td class="hits">0</td><td class="source">                    for (var j = 0; j &lt; linksToProcess.length; j++) {</td></tr><tr class="miss"><td class="line">393</td><td class="hits">0</td><td class="source">                        _createSuggestedClippAndSave({</td></tr><tr><td class="line">394</td><td class="hits"></td><td class="source">                            notebook: notebook,</td></tr><tr><td class="line">395</td><td class="hits"></td><td class="source">                            url: &quot;http://&quot; + linksToProcess[j].luuu, // source url</td></tr><tr><td class="line">396</td><td class="hits"></td><td class="source">                            title: linksToProcess[j].ut // target title</td></tr><tr><td class="line">397</td><td class="hits"></td><td class="source">                        }, checkAndFinishClips);</td></tr><tr><td class="line">398</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">399</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">400</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">401</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">402</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">403</td><td class="hits">1</td><td class="source">    function _createSuggestedClippAndSave(data, callback) {</td></tr><tr class="miss"><td class="line">404</td><td class="hits">0</td><td class="source">        var suggestedClipp = new SuggestedClipp.Model({</td></tr><tr><td class="line">405</td><td class="hits"></td><td class="source">             notebook: data.notebook._id,</td></tr><tr><td class="line">406</td><td class="hits"></td><td class="source">             url: data.url,</td></tr><tr><td class="line">407</td><td class="hits"></td><td class="source">             title: data.title</td></tr><tr><td class="line">408</td><td class="hits"></td><td class="source">          });</td></tr><tr class="miss"><td class="line">409</td><td class="hits">0</td><td class="source">         SuggestedClipp.checkForDuplicatesAndSave(data.notebook._id, suggestedClipp, data.notebook.clipps, function(err, data){</td></tr><tr class="miss"><td class="line">410</td><td class="hits">0</td><td class="source">             callback(err, data);</td></tr><tr><td class="line">411</td><td class="hits"></td><td class="source">         });</td></tr><tr><td class="line">412</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">413</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">414</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">415</td><td class="hits"></td><td class="source">        list: _list,</td></tr><tr><td class="line">416</td><td class="hits"></td><td class="source">        adminList: _adminList,</td></tr><tr><td class="line">417</td><td class="hits"></td><td class="source">        importClipps: _importClipps,</td></tr><tr><td class="line">418</td><td class="hits"></td><td class="source">        archiveClipps: _archiveClipps,</td></tr><tr><td class="line">419</td><td class="hits"></td><td class="source">        addClippsToNotebook: _addClippsToNotebook,</td></tr><tr><td class="line">420</td><td class="hits"></td><td class="source">        init: _init</td></tr><tr><td class="line">421</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">422</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">423</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">424</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">425</td><td class="hits">1</td><td class="source">module.exports = SuggestedClippsController;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/controllers/tracking.js">/Users/warner/code/clipppr/primeloop-api/controllers/tracking.js</h2><div id="stats" class="low"><div class="percentage">41%</div><div class="sloc">12</div><div class="hits">5</div><div class="misses">7</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var TrackingController = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        restify = require(&quot;restify&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        User = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/user&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        Tracker = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/tracker&quot;);</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">    var _track = function(req, res, next) {</td></tr><tr class="miss"><td class="line">10</td><td class="hits">0</td><td class="source">        var tracker = new Tracker(req.params);</td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="source">        tracker.created = Date.now();</td></tr><tr class="miss"><td class="line">12</td><td class="hits">0</td><td class="source">        tracker.user = {</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">            _id: req.user._id,</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">            email: req.user.email,</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">            name: req.user.name,</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">            role: req.user.role</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        // console.log(&quot;tracking %j&quot;,tracker);</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        //Do not send admin events to kafka</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">        if(req.user.role == &quot;admin&quot;) return res.send(tracker);</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">        tracker.save(function(err, data){</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">            if(err) console.log(&quot;error saving tracker&quot;, err.stck || err);</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">            // else console.log(&quot;Tracker:&quot;, data);</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        });</td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">        return res.send(tracker);</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">   </td></tr><tr class="hit"><td class="line">31</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        track: _track </td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">37</td><td class="hits">1</td><td class="source">module.exports = TrackingController;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/controllers/users.js">/Users/warner/code/clipppr/primeloop-api/controllers/users.js</h2><div id="stats" class="medium"><div class="percentage">53%</div><div class="sloc">441</div><div class="hits">237</div><div class="misses">204</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var UsersController = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        ArrayUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/array&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        async = require('async'),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        restify = require(&quot;restify&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        Email = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/email&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        User = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/user&quot;),</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        Customer = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/customer&quot;),</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        UserWaiting = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/user_waiting&quot;),</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        Notebook = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/notebook&quot;),</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        ActivityLog = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../models/activitylog&quot;),</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;),</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        nock = require(&quot;nock&quot;),</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        JSONUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/json&quot;),</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        ObjectUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../utils/objects&quot;),</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        request = require(&quot;request&quot;),</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        restifyErrors = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/errors&quot;)(restify),</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        rclient = require(&quot;/Users/warner/code/clipppr/primeloop-api/controllers/../config/redis&quot;),</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        _ = require(&quot;underscore&quot;);</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">24</td><td class="hits">1</td><td class="source">    var CURRENT_PLAN = &quot;MarchBeta&quot;;</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">26</td><td class="hits">1</td><td class="source">    var _list = function(req, res, next) {</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">       /*</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">            This is for admin account listings</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        */</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        // var</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        //     page = parseInt(req.params.page || 1, 10),</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        //     per_page = parseInt(req.params.per_page || 20, 10);</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        // if(req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        //     return next(new restify.NotAuthorizedError(&quot;You don't have permission to view user accounts&quot;));</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">        // }</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">        // User.Model</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">        //     .find({</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">        //     })</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">        //     .limit(per_page)</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">        //     .skip((page-1)*per_page)</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">        //     .sort({&quot;lastAction&quot;: -1, created: -1})</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        //     .lean()</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">        //     .exec(function(err, users){</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">        //         if(err) return next(err);</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">        //         //TODO: Get clipp numbers that need to be updated?</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">        //         users = User.prepareMultipleForAdminOutput(users);</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">        //         return res.send(users);</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">        //         /*var query = {</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">        //             $or: [</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">        //                 { &quot;updated.social&quot;: { $lt: new Date().getTime() - (1000*60*60*16)} },</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">        //                 { &quot;updated.comment&quot;: { $lt: new Date().getTime() - (1000*60*60*16)} }</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">        //                 // { &quot;updated.social&quot;: { $exists: false} },</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">        //                 // { &quot;updated.comment&quot;: { $exists: false} }</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">        //             ]</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">        //         };</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">        //         Notebook.populatePagesForMultipleUsers(users, query, function(err, users){</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">        //             return res.send(users);</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">        //         });*/</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">70</td><td class="hits">1</td><td class="source">    var _find = function(req, res, next) {</td></tr><tr class="hit"><td class="line">71</td><td class="hits">2</td><td class="source">        if(req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permission to view user accounts&quot;));</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">75</td><td class="hits">2</td><td class="source">        var query = req.params.query || '';</td></tr><tr class="hit"><td class="line">76</td><td class="hits">2</td><td class="source">        var regex = new RegExp(&quot;.*&quot; + query.toLowerCase() + &quot;.*&quot;, &quot;i&quot;);</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">        </td></tr><tr class="hit"><td class="line">78</td><td class="hits">2</td><td class="source">        User.Model</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">                $or: [</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">                    {firstName: regex},</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">                    {lastName: regex},</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">                    {email: regex},</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">                    {&quot;job.company.name&quot;: regex}</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">                ]</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">            .exec(function(err, users){</td></tr><tr class="hit"><td class="line">89</td><td class="hits">2</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">        </td></tr><tr class="hit"><td class="line">91</td><td class="hits">2</td><td class="source">                users = User.prepareMultipleForAdminOutput(users);</td></tr><tr class="hit"><td class="line">92</td><td class="hits">2</td><td class="source">                return res.send(users);</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">96</td><td class="hits">1</td><td class="source">    var _view = function(req, res, next) {</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">        // if(req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0 &amp;&amp; req.user.permissions.indexOf(&quot;view_referred_accounts&quot;) &lt; 0 &amp;&amp; req.params.id != req.user._id) {</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">        //     return next(new restify.NotAuthorizedError(&quot;You don't have permission to view user accounts&quot;));</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">        // }</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">        // User.Model</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">        //     .findOne({</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">        //         _id: req.params.id</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">        //     })</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">        //     .lean()</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">        //     .exec(function(err, user){</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">        //         if(err) return next(err);</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">        //         if(!user) {</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">        //             return next(new restify.ResourceNotFoundError(&quot;User not found&quot;));</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">        //         }</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">        //         if(req.user.permissions.indexOf(&quot;view_referred_accounts&quot;) &gt;= 0 &amp;&amp; user.refBy != req.user._id &amp;&amp; user._id != req.user._id) {</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">        //             return next(new restify.NotAuthorizedError(&quot;You don't have permission to this account&quot;));</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">        //         }</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">        //         //TODO: Expose one of the valid tokens?</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">        //         user = User.prepareForAdminOutput(user);</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">        //         Notebook.getNotebooksForUser(user, function(err, notebooks){</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">        //             if(err) return next(err);</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">        //             user.notebooks = notebooks;</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">        //             return res.send(user);</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">        //         });</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">133</td><td class="hits">1</td><td class="source">    var _update = function(req, res, next) {</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">        // var notebooks, user_id = req.params.id;</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">        // if(user_id != req.user._id &amp;&amp; req.user.permissions.indexOf(&quot;edit_accounts&quot;) &lt; 0) {</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">        //     return next(new restify.NotAuthorizedError(&quot;You don't have permisison to do that.&quot;));</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">        // }</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">        // if(req.params.stripeToken) {</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">        //     if(req.user.permissions.indexOf(&quot;manage_account&quot;) &lt; 0) {</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">        //         return next(new restify.NotAuthorizedError(&quot;You don't have permissions to update this credit card&quot;));</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">        //     }</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">        //     var updates = {</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">        //         card: req.params.stripeToken,</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">        //         coupon: req.params.coupon || null</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source">        //     };</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">        //     if(!req.user.customer || !req.user.customer.id) return next(new restifyErrors.InvalidInputError(&quot;You currently do not have a paid account.&quot;));</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">        //     Payment.updateCreditCard(req.user.customer.id, updates, function(err, customer){</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">        //         if(err &amp;&amp; err.name == &quot;card_error&quot;) {</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">        //             return next(new restifyErrors.InvalidInputError(&quot;The credit card information you entered is invalid&quot;));</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">        //         } else if(err) return next(err);</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">        //         User.Model</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">        //             .findOne({_id: req.user._id})</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">        //             .exec(function(err, user){</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">        //                 if(err) return;</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">        //                 user.customer = customer;</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">        //                 user.save();</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">        //                 return next();</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">        //             });</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">        //         return res.send(customer);</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">        // } else {</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">        //     User.Model</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">        //         .findOne({_id: user_id})</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">        //         .exec(function(err, user){</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">        //             if(err) return next(err);</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">        //             if(!user) return next(restify.ResourceNotFoundError(&quot;User not found.&quot;));</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">        //             user.setAll(req.params);</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">        //             notebooks = (req.params.settings) ? req.params.settings.notebooks : null ;</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">        //             if(notebooks){</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">        //                 var</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">        //                     len = 0,</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">        //                     _updateUserNotebookSettingsDone = function(err, notebook) {</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">        //                         if(err) console.log(&quot;Error:&quot;,err);</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">        //                         return --len || respond();</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">        //                     };</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">        //                 for(var i in notebooks) {</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">        //                     len++;</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">        //                     _updateUserNotebookSettings(i, notebooks[i].settings, user, _updateUserNotebookSettingsDone);</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">        //                 }</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">        //                 if(len === 0) respond();</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">        //             } else respond();</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source">        //             function respond() {</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">        //                 user.save(function(err, saved){</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">        //                     if(err) console.log(&quot;Error saving user:&quot;, err.stack || err);</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">        //                     if(err) return next(err);</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">        //                     //refresh the user session - calling the next in chain</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">        //                     next();</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">        //                     saved = User.prepareForOutput(saved);</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">        //                     Notebook.getNotebooksForUser(saved, function(err, notebooks){</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">        //                         if(err) return next(err);</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source">        //                         saved.notebooks = notebooks;</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">        //                         return res.send(saved);</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">        //                     });</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">        //                 });</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">        //             }</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">        //         });</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">        // }</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">220</td><td class="hits">1</td><td class="source">    var _updateSettings = function(req, res, next) {</td></tr><tr class="hit"><td class="line">221</td><td class="hits">3</td><td class="source">        var notebooks, user_id = req.params.id;</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">223</td><td class="hits">3</td><td class="source">        if(user_id != req.user._id &amp;&amp; req.user.permissions.indexOf(&quot;edit_accounts&quot;) &lt; 0) {</td></tr><tr class="hit"><td class="line">224</td><td class="hits">1</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permisison to do that.&quot;));</td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source">        //grab user</td></tr><tr class="hit"><td class="line">228</td><td class="hits">2</td><td class="source">        User.Model</td></tr><tr><td class="line">229</td><td class="hits"></td><td class="source">            .findOne({_id: user_id})</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">            .exec(function(err, user){</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">232</td><td class="hits">2</td><td class="source">                if(err) return next(err);</td></tr><tr class="hit"><td class="line">233</td><td class="hits">2</td><td class="source">                if(!user) return next(restify.ResourceNotFoundError(&quot;User not found.&quot;));</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">                //special cases</td></tr><tr class="hit"><td class="line">236</td><td class="hits">2</td><td class="source">                if((req.params.password1 &amp;&amp; !req.params.password2) || (req.params.password1 != req.params.password2)) {</td></tr><tr class="miss"><td class="line">237</td><td class="hits">0</td><td class="source">                    return next(new restifyErrors.InvalidInputError(&quot;To change your password your password and confirmed password must match.&quot;));</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">                }</td></tr><tr class="hit"><td class="line">239</td><td class="hits">2</td><td class="source">                if(req.params.password1) {</td></tr><tr class="miss"><td class="line">240</td><td class="hits">0</td><td class="source">                    user.password = req.params.password1;</td></tr><tr class="miss"><td class="line">241</td><td class="hits">0</td><td class="source">                    delete req.params.password1;</td></tr><tr class="miss"><td class="line">242</td><td class="hits">0</td><td class="source">                    delete req.params.password2;</td></tr><tr><td class="line">243</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">245</td><td class="hits">2</td><td class="source">                user.setAll(req.params);</td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source">                // console.log(&quot;user after setting params and preparing to save %j&quot;, user);</td></tr><tr class="hit"><td class="line">247</td><td class="hits">2</td><td class="source">                respond();</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">250</td><td class="hits">2</td><td class="source">                function respond() {</td></tr><tr class="hit"><td class="line">251</td><td class="hits">2</td><td class="source">                    user.save(function(err, saved){</td></tr><tr class="hit"><td class="line">252</td><td class="hits">2</td><td class="source">                        if(err) console.log(&quot;Error saving user:&quot;, err.stack || err);</td></tr><tr class="hit"><td class="line">253</td><td class="hits">2</td><td class="source">                        if(err) return next(err);</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">                        //refresh the user session - calling the next in chain</td></tr><tr class="hit"><td class="line">256</td><td class="hits">2</td><td class="source">                        next();</td></tr><tr class="hit"><td class="line">257</td><td class="hits">2</td><td class="source">                        saved = User.prepareForOutput(saved);</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">259</td><td class="hits">2</td><td class="source">                        Notebook.getNotebooksForUser(saved, function(err, notebooks){</td></tr><tr class="hit"><td class="line">260</td><td class="hits">2</td><td class="source">                            if(err) return next(err);</td></tr><tr class="hit"><td class="line">261</td><td class="hits">2</td><td class="source">                            saved.notebooks = notebooks;</td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">263</td><td class="hits">2</td><td class="source">                            return res.send(saved);</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">267</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">271</td><td class="hits">1</td><td class="source">    var _updateUserNotebookSettings = function(id, settings, user, done){</td></tr><tr><td class="line">272</td><td class="hits"></td><td class="source">        // var idx;</td></tr><tr><td class="line">273</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source">        // // console.log(&quot;updating notebook user settings&quot;, id, settings);</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source">        // Notebook.Model</td></tr><tr><td class="line">276</td><td class="hits"></td><td class="source">        //     .findOne({</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source">        //         _id: id</td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source">        //     })</td></tr><tr><td class="line">279</td><td class="hits"></td><td class="source">        //     .exec(function(err, notebook){</td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source">        //         if(err) return done(err);</td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source">        //         // console.log(&quot;Notebook, Users:&quot;, notebook, notebook.users);</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source">        //         idx = ArrayUtils.inArray(user._id, notebook.users, &quot;user&quot;);</td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source">        //         if(idx &lt; 0) return done();</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">        //         notebook.users[idx].settings = settings;</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source">        //         notebook.markModified(&quot;users&quot;);</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source">        //         notebook.save(function(err, notebook){</td></tr><tr><td class="line">292</td><td class="hits"></td><td class="source">        //             // console.log(settings, notebook.users[idx]);</td></tr><tr><td class="line">293</td><td class="hits"></td><td class="source">        //             return done(err, notebook);</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source">        //         });</td></tr><tr><td class="line">295</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">296</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">297</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">298</td><td class="hits">1</td><td class="source">    var _add = function(req, res, next) {</td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source">        /*</td></tr><tr><td class="line">300</td><td class="hits"></td><td class="source">            We're going to add a new user to the system,</td></tr><tr><td class="line">301</td><td class="hits"></td><td class="source">            this is where admins can create users or you can</td></tr><tr><td class="line">302</td><td class="hits"></td><td class="source">            send invites from when we have that</td></tr><tr><td class="line">303</td><td class="hits"></td><td class="source">         */</td></tr><tr><td class="line">304</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">305</td><td class="hits"></td><td class="source">        // if(req.user.permissions.indexOf(&quot;add_new_account&quot;) &lt; 0) {</td></tr><tr><td class="line">306</td><td class="hits"></td><td class="source">        //     return next(new restify.NotAuthorizedError(&quot;You don't have permissions to create a user&quot;));</td></tr><tr><td class="line">307</td><td class="hits"></td><td class="source">        // }</td></tr><tr><td class="line">308</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">309</td><td class="hits"></td><td class="source">        // if(req.params.role !== &quot;general&quot; &amp;&amp; req.user.permissions.indexOf(&quot;add_all_account_types&quot;) &lt; 0){</td></tr><tr><td class="line">310</td><td class="hits"></td><td class="source">        //     return next(new restify.NotAuthorizedError(&quot;You don't have permissions to create a &quot;+req.params.role+&quot; user&quot;));</td></tr><tr><td class="line">311</td><td class="hits"></td><td class="source">        // }</td></tr><tr><td class="line">312</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">313</td><td class="hits"></td><td class="source">        // User.findOrInvite({</td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source">        //     email: req.params.email,</td></tr><tr><td class="line">315</td><td class="hits"></td><td class="source">        //     name: req.params.name,</td></tr><tr><td class="line">316</td><td class="hits"></td><td class="source">        //     job: req.params.job,</td></tr><tr><td class="line">317</td><td class="hits"></td><td class="source">        //     role: req.params.role,</td></tr><tr><td class="line">318</td><td class="hits"></td><td class="source">        //     refBy: req.user._id</td></tr><tr><td class="line">319</td><td class="hits"></td><td class="source">        // }, function(err, saved){</td></tr><tr><td class="line">320</td><td class="hits"></td><td class="source">        //     if(err &amp;&amp; err.errors) {</td></tr><tr><td class="line">321</td><td class="hits"></td><td class="source">        //         return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">322</td><td class="hits"></td><td class="source">        //     }</td></tr><tr><td class="line">323</td><td class="hits"></td><td class="source">        //     else if(err) return next(err);</td></tr><tr><td class="line">324</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">325</td><td class="hits"></td><td class="source">        //     saved = User.prepareForOutput(saved);</td></tr><tr><td class="line">326</td><td class="hits"></td><td class="source">        //     return res.send(saved);</td></tr><tr><td class="line">327</td><td class="hits"></td><td class="source">        // });</td></tr><tr><td class="line">328</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">329</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">330</td><td class="hits">1</td><td class="source">    var _registerNoInvite = function(req, res, next) {</td></tr><tr><td class="line">331</td><td class="hits"></td><td class="source">        /*</td></tr><tr><td class="line">332</td><td class="hits"></td><td class="source">            This is where a user self-registers,</td></tr><tr><td class="line">333</td><td class="hits"></td><td class="source">            email, password</td></tr><tr><td class="line">334</td><td class="hits"></td><td class="source">        */</td></tr><tr><td class="line">335</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">336</td><td class="hits"></td><td class="source">        // var coupon = req.params.coupon;</td></tr><tr><td class="line">337</td><td class="hits"></td><td class="source">        // delete req.params.coupon;</td></tr><tr><td class="line">338</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">339</td><td class="hits"></td><td class="source">        // if(!req.params.email) {</td></tr><tr><td class="line">340</td><td class="hits"></td><td class="source">        //     return next(new restifyErrors.InvalidInputError(&quot;Email Required&quot;));</td></tr><tr><td class="line">341</td><td class="hits"></td><td class="source">        // }</td></tr><tr><td class="line">342</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">343</td><td class="hits"></td><td class="source">        // if(!req.params.password) {</td></tr><tr><td class="line">344</td><td class="hits"></td><td class="source">        //     return next(new restifyErrors.InvalidInputError(&quot;Password required&quot;));</td></tr><tr><td class="line">345</td><td class="hits"></td><td class="source">        // }</td></tr><tr><td class="line">346</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">347</td><td class="hits"></td><td class="source">        // User.Model.count({ //Need to make sure that there isn't someone else with that email address</td></tr><tr><td class="line">348</td><td class="hits"></td><td class="source">        //     email: req.params.email</td></tr><tr><td class="line">349</td><td class="hits"></td><td class="source">        // }, function(err, count){</td></tr><tr><td class="line">350</td><td class="hits"></td><td class="source">        //     if(err) return next(err);</td></tr><tr><td class="line">351</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">352</td><td class="hits"></td><td class="source">        //     if(count &gt; 0) {</td></tr><tr><td class="line">353</td><td class="hits"></td><td class="source">        //         return next(new restifyErrors.InvalidInputError(&quot;This email address is already in use&quot;));</td></tr><tr><td class="line">354</td><td class="hits"></td><td class="source">        //     }</td></tr><tr><td class="line">355</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">356</td><td class="hits"></td><td class="source">        //     var nbName = req.params.name + &quot;'s Notebook&quot;;</td></tr><tr><td class="line">357</td><td class="hits"></td><td class="source">        //     var user = new User.Model();</td></tr><tr><td class="line">358</td><td class="hits"></td><td class="source">        //     user.password = req.params.password;</td></tr><tr><td class="line">359</td><td class="hits"></td><td class="source">        //     user.name = req.params.name;</td></tr><tr><td class="line">360</td><td class="hits"></td><td class="source">        //     user.email = req.params.email;</td></tr><tr><td class="line">361</td><td class="hits"></td><td class="source">        //     user.planOffered = req.params.planOffered;</td></tr><tr><td class="line">362</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">363</td><td class="hits"></td><td class="source">        //     if(req.params.job) {</td></tr><tr><td class="line">364</td><td class="hits"></td><td class="source">        //         user.job.title = req.params.job.title || null;</td></tr><tr><td class="line">365</td><td class="hits"></td><td class="source">        //         user.job.company = req.params.job.company;</td></tr><tr><td class="line">366</td><td class="hits"></td><td class="source">        //         if(user.job.company.name) nbName = user.job.company.name;</td></tr><tr><td class="line">367</td><td class="hits"></td><td class="source">        //     }</td></tr><tr><td class="line">368</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">369</td><td class="hits"></td><td class="source">        //     user.enabled = true;</td></tr><tr><td class="line">370</td><td class="hits"></td><td class="source">        //     user.trial = settings.trial.tryit.days;</td></tr><tr><td class="line">371</td><td class="hits"></td><td class="source">        //     user.trialStart = new Date();</td></tr><tr><td class="line">372</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">373</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">374</td><td class="hits"></td><td class="source">        //     //now that we have a user we need to save it and then create a new notebook for them</td></tr><tr><td class="line">375</td><td class="hits"></td><td class="source">        //     var notebook = new Notebook.Model({</td></tr><tr><td class="line">376</td><td class="hits"></td><td class="source">        //         name: nbName,</td></tr><tr><td class="line">377</td><td class="hits"></td><td class="source">        //         trial : user.trial,</td></tr><tr><td class="line">378</td><td class="hits"></td><td class="source">        //         trialStart : user.trialStart,</td></tr><tr><td class="line">379</td><td class="hits"></td><td class="source">        //         type : &quot;trial&quot;,</td></tr><tr><td class="line">380</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">381</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">382</td><td class="hits"></td><td class="source">        //     if(req.params.domain_url) notebook.alertsTracking.sites.push(req.params.domain_url);</td></tr><tr><td class="line">383</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">384</td><td class="hits"></td><td class="source">        //     notebook.users.push({</td></tr><tr><td class="line">385</td><td class="hits"></td><td class="source">        //         user: user._id,</td></tr><tr><td class="line">386</td><td class="hits"></td><td class="source">        //         role: &quot;owner&quot;</td></tr><tr><td class="line">387</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">388</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">389</td><td class="hits"></td><td class="source">        //     notebook.save(function(err, savednb){</td></tr><tr><td class="line">390</td><td class="hits"></td><td class="source">        //         if(!req.params.domain_url) return saveUser();</td></tr><tr><td class="line">391</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">392</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">393</td><td class="hits"></td><td class="source">        //     if(req.params.domain_url) {</td></tr><tr><td class="line">394</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">395</td><td class="hits"></td><td class="source">        //         Notebook.getBacklinks(req.params.domain_url, function(err, urls){</td></tr><tr><td class="line">396</td><td class="hits"></td><td class="source">        //             if(err) console.log(err);</td></tr><tr><td class="line">397</td><td class="hits"></td><td class="source">        //             console.log(urls);</td></tr><tr><td class="line">398</td><td class="hits"></td><td class="source">        //             if(err) return saveUser();</td></tr><tr><td class="line">399</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">400</td><td class="hits"></td><td class="source">        //             return notebook.importUrls(urls, user, &quot;suggested&quot;, function(err, result){</td></tr><tr><td class="line">401</td><td class="hits"></td><td class="source">        //                 if(err) console.log(err);</td></tr><tr><td class="line">402</td><td class="hits"></td><td class="source">        //                 return saveUser();</td></tr><tr><td class="line">403</td><td class="hits"></td><td class="source">        //             });</td></tr><tr><td class="line">404</td><td class="hits"></td><td class="source">        //         });</td></tr><tr><td class="line">405</td><td class="hits"></td><td class="source">        //     }</td></tr><tr><td class="line">406</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">407</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">408</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">409</td><td class="hits"></td><td class="source">        //     function saveUser(){</td></tr><tr><td class="line">410</td><td class="hits"></td><td class="source">        //         user.save(function(err, saved){</td></tr><tr><td class="line">411</td><td class="hits"></td><td class="source">        //             if(err &amp;&amp; err.errors) {</td></tr><tr><td class="line">412</td><td class="hits"></td><td class="source">        //                 return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">413</td><td class="hits"></td><td class="source">        //             }</td></tr><tr><td class="line">414</td><td class="hits"></td><td class="source">        //             else if(err) return next(err);</td></tr><tr><td class="line">415</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">416</td><td class="hits"></td><td class="source">        //             saved = User.prepareForOutput(saved);</td></tr><tr><td class="line">417</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">418</td><td class="hits"></td><td class="source">        //             return res.send(saved);</td></tr><tr><td class="line">419</td><td class="hits"></td><td class="source">        //         });</td></tr><tr><td class="line">420</td><td class="hits"></td><td class="source">        //     }</td></tr><tr><td class="line">421</td><td class="hits"></td><td class="source">        // });</td></tr><tr><td class="line">422</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">423</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">424</td><td class="hits">1</td><td class="source">    var _retargetPrelimRegister = function(req, res, next) {</td></tr><tr><td class="line">425</td><td class="hits"></td><td class="source">        /*</td></tr><tr><td class="line">426</td><td class="hits"></td><td class="source">            This is where a user self-registers via the new on boarding process.</td></tr><tr><td class="line">427</td><td class="hits"></td><td class="source">        */</td></tr><tr><td class="line">428</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">429</td><td class="hits">0</td><td class="source">        if(!req.params.email) {</td></tr><tr class="miss"><td class="line">430</td><td class="hits">0</td><td class="source">            return next(new restifyErrors.InvalidInputError(&quot;Email Required&quot;));</td></tr><tr><td class="line">431</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">432</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">433</td><td class="hits">0</td><td class="source">        if(!req.params.waiting){</td></tr><tr class="miss"><td class="line">434</td><td class="hits">0</td><td class="source">            return next(new restifyErrors.InvalidInputError(&quot;You don't have permission to do that.&quot;));</td></tr><tr><td class="line">435</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">436</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">437</td><td class="hits">0</td><td class="source">        UserWaiting.Model.findOne({</td></tr><tr><td class="line">438</td><td class="hits"></td><td class="source">            _id: req.params.waiting</td></tr><tr><td class="line">439</td><td class="hits"></td><td class="source">        })</td></tr><tr><td class="line">440</td><td class="hits"></td><td class="source">        .lean()</td></tr><tr><td class="line">441</td><td class="hits"></td><td class="source">        .exec(function(err, wuser){</td></tr><tr class="miss"><td class="line">442</td><td class="hits">0</td><td class="source">            if(err) return next(err);</td></tr><tr><td class="line">443</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">444</td><td class="hits">0</td><td class="source">            if(!wuser) return next(new restifyErrors.InvalidInputError(&quot;Not found&quot;));</td></tr><tr><td class="line">445</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">446</td><td class="hits">0</td><td class="source">            User.Model.count({ //Need to make sure that there isn't someone else with that email address</td></tr><tr><td class="line">447</td><td class="hits"></td><td class="source">                email: req.params.email</td></tr><tr><td class="line">448</td><td class="hits"></td><td class="source">            }, function(err, count){</td></tr><tr class="miss"><td class="line">449</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">450</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">451</td><td class="hits">0</td><td class="source">                if(count &gt; 0) {</td></tr><tr class="miss"><td class="line">452</td><td class="hits">0</td><td class="source">                    return next(new restifyErrors.InvalidInputError(&quot;This email address is already in use&quot;));</td></tr><tr><td class="line">453</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">454</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">455</td><td class="hits">0</td><td class="source">                var nbName = &quot;My First Campaign&quot;;</td></tr><tr class="miss"><td class="line">456</td><td class="hits">0</td><td class="source">                var user = new User.Model();</td></tr><tr class="miss"><td class="line">457</td><td class="hits">0</td><td class="source">                user.password = req.params.password;</td></tr><tr class="miss"><td class="line">458</td><td class="hits">0</td><td class="source">                user.email = req.params.email;</td></tr><tr><td class="line">459</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">460</td><td class="hits">0</td><td class="source">                user.firstName = wuser.firstName;</td></tr><tr class="miss"><td class="line">461</td><td class="hits">0</td><td class="source">                user.lastName = wuser.lastName;</td></tr><tr class="miss"><td class="line">462</td><td class="hits">0</td><td class="source">                user.planOffered = req.params.planOffered || settings.defaultPlan;</td></tr><tr><td class="line">463</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">464</td><td class="hits">0</td><td class="source">                if(wuser.company) {</td></tr><tr class="miss"><td class="line">465</td><td class="hits">0</td><td class="source">                    user.job.title = wuser.company.role;</td></tr><tr class="miss"><td class="line">466</td><td class="hits">0</td><td class="source">                    user.job.company = {</td></tr><tr><td class="line">467</td><td class="hits"></td><td class="source">                        name: wuser.company.name,</td></tr><tr><td class="line">468</td><td class="hits"></td><td class="source">                        size: wuser.company.size</td></tr><tr><td class="line">469</td><td class="hits"></td><td class="source">                    };</td></tr><tr><td class="line">470</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">471</td><td class="hits">0</td><td class="source">                    if(wuser.company.name) nbName = wuser.company.name;</td></tr><tr><td class="line">472</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">473</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">474</td><td class="hits">0</td><td class="source">                user.enabled = true;</td></tr><tr class="miss"><td class="line">475</td><td class="hits">0</td><td class="source">                user.prelim = true;</td></tr><tr class="miss"><td class="line">476</td><td class="hits">0</td><td class="source">                if(req.params.externalAuth) {</td></tr><tr class="miss"><td class="line">477</td><td class="hits">0</td><td class="source">                    if(!user.externalAuth) {</td></tr><tr class="miss"><td class="line">478</td><td class="hits">0</td><td class="source">                        user.externalAuth = [];</td></tr><tr><td class="line">479</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">480</td><td class="hits">0</td><td class="source">                    user.externalAuth.push(req.params.externalAuth);</td></tr><tr><td class="line">481</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">482</td><td class="hits">0</td><td class="source">                var notebook = new Notebook.Model({</td></tr><tr><td class="line">483</td><td class="hits"></td><td class="source">                    name: nbName,</td></tr><tr><td class="line">484</td><td class="hits"></td><td class="source">                    enabled: false,</td></tr><tr><td class="line">485</td><td class="hits"></td><td class="source">                    type : &quot;paid&quot;</td></tr><tr><td class="line">486</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">487</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">488</td><td class="hits">0</td><td class="source">                notebook.users.push({</td></tr><tr><td class="line">489</td><td class="hits"></td><td class="source">                    user: user._id,</td></tr><tr><td class="line">490</td><td class="hits"></td><td class="source">                    role: &quot;campaign_owner&quot;</td></tr><tr><td class="line">491</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">492</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">493</td><td class="hits">0</td><td class="source">                notebook.save(function(err, savednb){</td></tr><tr class="miss"><td class="line">494</td><td class="hits">0</td><td class="source">                    return saveUser(savednb);</td></tr><tr><td class="line">495</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">496</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">497</td><td class="hits">0</td><td class="source">                function saveUser(savedNotebook){</td></tr><tr class="miss"><td class="line">498</td><td class="hits">0</td><td class="source">                    user.save(function(err, saved){</td></tr><tr class="miss"><td class="line">499</td><td class="hits">0</td><td class="source">                        if(err &amp;&amp; err.errors) {</td></tr><tr class="miss"><td class="line">500</td><td class="hits">0</td><td class="source">                            return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">501</td><td class="hits"></td><td class="source">                        }</td></tr><tr class="miss"><td class="line">502</td><td class="hits">0</td><td class="source">                        else if(err) return next(err);</td></tr><tr><td class="line">503</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">504</td><td class="hits">0</td><td class="source">                        saved = User.prepareForOutput(saved);</td></tr><tr class="miss"><td class="line">505</td><td class="hits">0</td><td class="source">                        var data = saved;</td></tr><tr class="miss"><td class="line">506</td><td class="hits">0</td><td class="source">                        return res.send({user:saved, notebook:savedNotebook});</td></tr><tr><td class="line">507</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">508</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">509</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">510</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">511</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">512</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">513</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">514</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">515</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">516</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">517</td><td class="hits">1</td><td class="source">    var _retargetRegisterNoInvite = function(req, res, next) {</td></tr><tr><td class="line">518</td><td class="hits"></td><td class="source">        /*</td></tr><tr><td class="line">519</td><td class="hits"></td><td class="source">            This is where a user self-registers via the new on boarding process.</td></tr><tr><td class="line">520</td><td class="hits"></td><td class="source">        */</td></tr><tr><td class="line">521</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">522</td><td class="hits">5</td><td class="source">        if(!req.params.email) {</td></tr><tr class="hit"><td class="line">523</td><td class="hits">1</td><td class="source">            return next(new restifyErrors.InvalidInputError(&quot;Email Required&quot;));</td></tr><tr><td class="line">524</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">525</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">526</td><td class="hits">4</td><td class="source">        if(!req.params.password) {</td></tr><tr class="hit"><td class="line">527</td><td class="hits">1</td><td class="source">            return next(new restifyErrors.InvalidInputError(&quot;Password required&quot;));</td></tr><tr><td class="line">528</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">529</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">530</td><td class="hits">3</td><td class="source">        if(!req.params.waiting){</td></tr><tr class="hit"><td class="line">531</td><td class="hits">1</td><td class="source">            return next(new restifyErrors.InvalidInputError(&quot;You don't have permission to do that.&quot;));</td></tr><tr><td class="line">532</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">533</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">534</td><td class="hits">2</td><td class="source">        UserWaiting.Model</td></tr><tr><td class="line">535</td><td class="hits"></td><td class="source">        .findOne({</td></tr><tr><td class="line">536</td><td class="hits"></td><td class="source">            _id: req.params.waiting</td></tr><tr><td class="line">537</td><td class="hits"></td><td class="source">        })</td></tr><tr><td class="line">538</td><td class="hits"></td><td class="source">        .lean()</td></tr><tr><td class="line">539</td><td class="hits"></td><td class="source">        .exec(function(err, wuser){</td></tr><tr class="hit"><td class="line">540</td><td class="hits">2</td><td class="source">            if(err) return next(err);</td></tr><tr><td class="line">541</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">542</td><td class="hits">2</td><td class="source">            if(!wuser) return next(new restifyErrors.InvalidInputError(&quot;Not found&quot;));</td></tr><tr><td class="line">543</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">544</td><td class="hits">2</td><td class="source">            User.Model.count({ //Need to make sure that there isn't someone else with that email address</td></tr><tr><td class="line">545</td><td class="hits"></td><td class="source">                email: req.params.email</td></tr><tr><td class="line">546</td><td class="hits"></td><td class="source">            }, function(err, count){</td></tr><tr class="hit"><td class="line">547</td><td class="hits">2</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">548</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">549</td><td class="hits">2</td><td class="source">                if(count &gt; 0) {</td></tr><tr class="hit"><td class="line">550</td><td class="hits">1</td><td class="source">                    return next(new restifyErrors.InvalidInputError(&quot;This email address is already in use&quot;));</td></tr><tr><td class="line">551</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">552</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">553</td><td class="hits">1</td><td class="source">                var nbName = req.params.name + &quot;'s Campaign&quot;;</td></tr><tr class="hit"><td class="line">554</td><td class="hits">1</td><td class="source">                var user = new User.Model();</td></tr><tr class="hit"><td class="line">555</td><td class="hits">1</td><td class="source">                user.password = req.params.password;</td></tr><tr class="hit"><td class="line">556</td><td class="hits">1</td><td class="source">                user.email = req.params.email;</td></tr><tr><td class="line">557</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">558</td><td class="hits">1</td><td class="source">                user.firstName = wuser.firstName;</td></tr><tr class="hit"><td class="line">559</td><td class="hits">1</td><td class="source">                user.lastName = wuser.lastName;</td></tr><tr class="hit"><td class="line">560</td><td class="hits">1</td><td class="source">                user.planOffered = req.params.planOffered || settings.defaultPlan;</td></tr><tr><td class="line">561</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">562</td><td class="hits">1</td><td class="source">                if(wuser.company) {</td></tr><tr class="miss"><td class="line">563</td><td class="hits">0</td><td class="source">                    user.job.title = wuser.company.role;</td></tr><tr class="miss"><td class="line">564</td><td class="hits">0</td><td class="source">                    user.job.company = {</td></tr><tr><td class="line">565</td><td class="hits"></td><td class="source">                        name: wuser.company.name,</td></tr><tr><td class="line">566</td><td class="hits"></td><td class="source">                        size: wuser.company.size</td></tr><tr><td class="line">567</td><td class="hits"></td><td class="source">                    };</td></tr><tr><td class="line">568</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">569</td><td class="hits">0</td><td class="source">                    if(wuser.company.name) nbName = wuser.company.name;</td></tr><tr><td class="line">570</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">571</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">572</td><td class="hits">1</td><td class="source">                user.enabled = true;</td></tr><tr><td class="line">573</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">574</td><td class="hits"></td><td class="source">                //now that we have a user we need to save it and then create a new notebook for them</td></tr><tr class="hit"><td class="line">575</td><td class="hits">1</td><td class="source">                var notebook = new Notebook.Model({</td></tr><tr><td class="line">576</td><td class="hits"></td><td class="source">                    name: nbName,</td></tr><tr><td class="line">577</td><td class="hits"></td><td class="source">                    enabled: false,</td></tr><tr><td class="line">578</td><td class="hits"></td><td class="source">                    type : &quot;paid&quot;</td></tr><tr><td class="line">579</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">580</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">581</td><td class="hits">1</td><td class="source">                notebook.users.push({</td></tr><tr><td class="line">582</td><td class="hits"></td><td class="source">                    user: user._id,</td></tr><tr><td class="line">583</td><td class="hits"></td><td class="source">                    role: &quot;campaign_owner&quot;</td></tr><tr><td class="line">584</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">585</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">586</td><td class="hits">1</td><td class="source">                notebook.save(function(err, savednb){</td></tr><tr class="hit"><td class="line">587</td><td class="hits">1</td><td class="source">                    return saveUser();</td></tr><tr><td class="line">588</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">589</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">590</td><td class="hits">1</td><td class="source">                function saveUser(){</td></tr><tr class="hit"><td class="line">591</td><td class="hits">1</td><td class="source">                    user.save(function(err, saved){</td></tr><tr class="hit"><td class="line">592</td><td class="hits">1</td><td class="source">                        if(err &amp;&amp; err.errors) {</td></tr><tr class="miss"><td class="line">593</td><td class="hits">0</td><td class="source">                            return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">594</td><td class="hits"></td><td class="source">                        }</td></tr><tr class="hit"><td class="line">595</td><td class="hits">1</td><td class="source">                        else if(err) return next(err);</td></tr><tr><td class="line">596</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">597</td><td class="hits">1</td><td class="source">                        saved = User.prepareForOutput(saved);</td></tr><tr><td class="line">598</td><td class="hits"></td><td class="source">                        //here is where we want to create a customer if it hasn't been created already</td></tr><tr class="hit"><td class="line">599</td><td class="hits">1</td><td class="source">                        _createCustomerRecord(user, user.planOffered, req.params.coupon,function(err, customer){</td></tr><tr class="hit"><td class="line">600</td><td class="hits">1</td><td class="source">                            console.log(&quot;created customer&quot;, err, customer);</td></tr><tr><td class="line">601</td><td class="hits"></td><td class="source">                        });</td></tr><tr class="hit"><td class="line">602</td><td class="hits">1</td><td class="source">                        var data = saved;</td></tr><tr class="hit"><td class="line">603</td><td class="hits">1</td><td class="source">                        var from = settings.email.from;</td></tr><tr class="hit"><td class="line">604</td><td class="hits">1</td><td class="source">                        var email = new Email.Model({</td></tr><tr><td class="line">605</td><td class="hits"></td><td class="source">                            to: data.email,</td></tr><tr><td class="line">606</td><td class="hits"></td><td class="source">                            from: from,</td></tr><tr><td class="line">607</td><td class="hits"></td><td class="source">                            subject: &quot;Thank you for signing up for Primeloop. Your next steps...&quot;</td></tr><tr><td class="line">608</td><td class="hits"></td><td class="source">                        });</td></tr><tr class="hit"><td class="line">609</td><td class="hits">1</td><td class="source">                        var template = &quot;new_user_welcome.mu&quot;;</td></tr><tr class="hit"><td class="line">610</td><td class="hits">1</td><td class="source">                        email.renderTemplate(data, template, &quot;html&quot;, function(err, html){</td></tr><tr class="hit"><td class="line">611</td><td class="hits">1</td><td class="source">                            console.log(&quot;Email sent to:&quot;, data.email);</td></tr><tr class="hit"><td class="line">612</td><td class="hits">1</td><td class="source">                            email.send(function(err, result){</td></tr><tr class="hit"><td class="line">613</td><td class="hits">1</td><td class="source">                                if(err) console.log(&quot;Error sending welcome email:&quot;, err);</td></tr><tr><td class="line">614</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">615</td><td class="hits"></td><td class="source">                        });</td></tr><tr class="hit"><td class="line">616</td><td class="hits">1</td><td class="source">                        return res.send(saved);</td></tr><tr><td class="line">617</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">618</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">619</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">620</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">621</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">622</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">623</td><td class="hits">1</td><td class="source">    var _retargetRegisterActivate = function(req, res, next) {</td></tr><tr class="miss"><td class="line">624</td><td class="hits">0</td><td class="source">        var email = (req.params.username) ? req.params.username.toLowerCase() : req.params.username;</td></tr><tr><td class="line">625</td><td class="hits"></td><td class="source">        //We need to look up email, if it exists then we need to generate a token and send it via email</td></tr><tr class="miss"><td class="line">626</td><td class="hits">0</td><td class="source">        User.Model</td></tr><tr><td class="line">627</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">628</td><td class="hits"></td><td class="source">                &quot;email&quot; : email</td></tr><tr><td class="line">629</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">630</td><td class="hits"></td><td class="source">            .exec(function (err, user) {</td></tr><tr class="miss"><td class="line">631</td><td class="hits">0</td><td class="source">                var token = uuid.v4();</td></tr><tr><td class="line">632</td><td class="hits"></td><td class="source">                //activate the user</td></tr><tr class="miss"><td class="line">633</td><td class="hits">0</td><td class="source">                user.enabled = true;</td></tr><tr class="miss"><td class="line">634</td><td class="hits">0</td><td class="source">                user.markModified(&quot;enabled&quot;);</td></tr><tr class="miss"><td class="line">635</td><td class="hits">0</td><td class="source">                user.save(function(err, saved){</td></tr><tr class="miss"><td class="line">636</td><td class="hits">0</td><td class="source">                    _saveResetToken(token, saved, function(err) {</td></tr><tr class="miss"><td class="line">637</td><td class="hits">0</td><td class="source">                        var data = {</td></tr><tr><td class="line">638</td><td class="hits"></td><td class="source">                            email: user.email,</td></tr><tr><td class="line">639</td><td class="hits"></td><td class="source">                            firstName: user.firstName,</td></tr><tr><td class="line">640</td><td class="hits"></td><td class="source">                            token: token</td></tr><tr><td class="line">641</td><td class="hits"></td><td class="source">                        };</td></tr><tr><td class="line">642</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">643</td><td class="hits">0</td><td class="source">                        var email = new Email.Model({</td></tr><tr><td class="line">644</td><td class="hits"></td><td class="source">                            to: data.email,</td></tr><tr><td class="line">645</td><td class="hits"></td><td class="source">                            from: settings.email.from,</td></tr><tr><td class="line">646</td><td class="hits"></td><td class="source">                            subject: &quot;Verify Email for Primeloop Account&quot;</td></tr><tr><td class="line">647</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">648</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">649</td><td class="hits">0</td><td class="source">                        email.renderTemplate(data, &quot;verify_email_set_password.mu&quot;, &quot;text&quot;, function(err, html){</td></tr><tr class="miss"><td class="line">650</td><td class="hits">0</td><td class="source">                            console.log(&quot;Email sent to:&quot;, data.email);</td></tr><tr class="miss"><td class="line">651</td><td class="hits">0</td><td class="source">                            email.send(function(err, saved){</td></tr><tr class="miss"><td class="line">652</td><td class="hits">0</td><td class="source">                                if(err) console.log(&quot;Error sending verify email:&quot;, err, err.stack);</td></tr><tr class="miss"><td class="line">653</td><td class="hits">0</td><td class="source">                                return res.send(&quot;Email sent!&quot;);</td></tr><tr><td class="line">654</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">655</td><td class="hits"></td><td class="source">                        } );</td></tr><tr><td class="line">656</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">657</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">658</td><td class="hits"></td><td class="source">                </td></tr><tr><td class="line">659</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">660</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">661</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">662</td><td class="hits">1</td><td class="source">    var _register = function(req, res, next) {</td></tr><tr><td class="line">663</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">664</td><td class="hits"></td><td class="source">        /*</td></tr><tr><td class="line">665</td><td class="hits"></td><td class="source">            This is where a user registers, require a valid invite,</td></tr><tr><td class="line">666</td><td class="hits"></td><td class="source">            email, password, and payment if they own a notebook</td></tr><tr><td class="line">667</td><td class="hits"></td><td class="source">        */</td></tr><tr><td class="line">668</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">669</td><td class="hits"></td><td class="source">        // var coupon = req.params.coupon;</td></tr><tr><td class="line">670</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">671</td><td class="hits"></td><td class="source">        // if(!req.params.email) {</td></tr><tr><td class="line">672</td><td class="hits"></td><td class="source">        //     return next(new restifyErrors.InvalidInputError(&quot;Email Required&quot;));</td></tr><tr><td class="line">673</td><td class="hits"></td><td class="source">        // }</td></tr><tr><td class="line">674</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">675</td><td class="hits"></td><td class="source">        // if(!req.params.password) {</td></tr><tr><td class="line">676</td><td class="hits"></td><td class="source">        //     return next(new restifyErrors.InvalidInputError(&quot;Password required&quot;));</td></tr><tr><td class="line">677</td><td class="hits"></td><td class="source">        // }</td></tr><tr><td class="line">678</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">679</td><td class="hits"></td><td class="source">        // User.Model.count({ //Need to make sure that there isn't someone else with that email address</td></tr><tr><td class="line">680</td><td class="hits"></td><td class="source">        //     _id: {$ne: req.params.id},</td></tr><tr><td class="line">681</td><td class="hits"></td><td class="source">        //     invite: {$ne: req.params.invite},</td></tr><tr><td class="line">682</td><td class="hits"></td><td class="source">        //     email: req.params.email</td></tr><tr><td class="line">683</td><td class="hits"></td><td class="source">        // }, function(err, count){</td></tr><tr><td class="line">684</td><td class="hits"></td><td class="source">        //     if(err) return next(err);</td></tr><tr><td class="line">685</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">686</td><td class="hits"></td><td class="source">        //     if(count &gt; 0) {</td></tr><tr><td class="line">687</td><td class="hits"></td><td class="source">        //         return next(new restifyErrors.InvalidInputError(&quot;This email address is already in use&quot;));</td></tr><tr><td class="line">688</td><td class="hits"></td><td class="source">        //     }</td></tr><tr><td class="line">689</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">690</td><td class="hits"></td><td class="source">        //     User.Model</td></tr><tr><td class="line">691</td><td class="hits"></td><td class="source">        //         .findOne({</td></tr><tr><td class="line">692</td><td class="hits"></td><td class="source">        //             _id: req.params.id,</td></tr><tr><td class="line">693</td><td class="hits"></td><td class="source">        //             enabled: false,</td></tr><tr><td class="line">694</td><td class="hits"></td><td class="source">        //             invite: req.params.invite</td></tr><tr><td class="line">695</td><td class="hits"></td><td class="source">        //         })</td></tr><tr><td class="line">696</td><td class="hits"></td><td class="source">        //         .exec(function(err, user){</td></tr><tr><td class="line">697</td><td class="hits"></td><td class="source">        //             if(err) return next(err);</td></tr><tr><td class="line">698</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">699</td><td class="hits"></td><td class="source">        //             if(!user) {</td></tr><tr><td class="line">700</td><td class="hits"></td><td class="source">        //                 return next(new restify.ResourceNotFoundError(&quot;User not found&quot;));</td></tr><tr><td class="line">701</td><td class="hits"></td><td class="source">        //             }</td></tr><tr><td class="line">702</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">703</td><td class="hits"></td><td class="source">        //             user.password = req.params.password;</td></tr><tr><td class="line">704</td><td class="hits"></td><td class="source">        //             user.name = req.params.name;</td></tr><tr><td class="line">705</td><td class="hits"></td><td class="source">        //             user.email = req.params.email;</td></tr><tr><td class="line">706</td><td class="hits"></td><td class="source">        //             user.planOffered = req.params.planOffered;</td></tr><tr><td class="line">707</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">708</td><td class="hits"></td><td class="source">        //             if(req.params.job) {</td></tr><tr><td class="line">709</td><td class="hits"></td><td class="source">        //                 user.job.title = req.params.job.title || null;</td></tr><tr><td class="line">710</td><td class="hits"></td><td class="source">        //                 user.job.company = req.params.job.company;</td></tr><tr><td class="line">711</td><td class="hits"></td><td class="source">        //             }</td></tr><tr><td class="line">712</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">713</td><td class="hits"></td><td class="source">        //             user.enabled = true;</td></tr><tr><td class="line">714</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">715</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">716</td><td class="hits"></td><td class="source">        //             Notebook.ownedNotebooks(user, function(err, owned){</td></tr><tr><td class="line">717</td><td class="hits"></td><td class="source">        //                 if(err) return next(err);</td></tr><tr><td class="line">718</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">719</td><td class="hits"></td><td class="source">        //                 if(owned &lt;= 0) return saveUser();</td></tr><tr><td class="line">720</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">721</td><td class="hits"></td><td class="source">        //                 if(user.trial &amp;&amp; user.trial &gt; 0 || req.params.trialCode == settings.trial.tryit.code) {</td></tr><tr><td class="line">722</td><td class="hits"></td><td class="source">        //                     if(req.params.trialCode == settings.trial.tryit.code) user.trial = settings.trial.tryit.days;</td></tr><tr><td class="line">723</td><td class="hits"></td><td class="source">        //                     user.trialStart = new Date();</td></tr><tr><td class="line">724</td><td class="hits"></td><td class="source">        //                     //update their currently owned notebooks with trial and trial start</td></tr><tr><td class="line">725</td><td class="hits"></td><td class="source">        //                     Notebook.forOwnedNotebooks(user, function(err, notebook, done){</td></tr><tr><td class="line">726</td><td class="hits"></td><td class="source">        //                         notebook.trial = user.trial;</td></tr><tr><td class="line">727</td><td class="hits"></td><td class="source">        //                         notebook.trialStart = user.trialStart;</td></tr><tr><td class="line">728</td><td class="hits"></td><td class="source">        //                         notebook.type = &quot;trial&quot;;</td></tr><tr><td class="line">729</td><td class="hits"></td><td class="source">        //                         notebook.anonymousAccess = false;</td></tr><tr><td class="line">730</td><td class="hits"></td><td class="source">        //                         notebook.save(done);</td></tr><tr><td class="line">731</td><td class="hits"></td><td class="source">        //                     });</td></tr><tr><td class="line">732</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">733</td><td class="hits"></td><td class="source">        //                     return saveUser();</td></tr><tr><td class="line">734</td><td class="hits"></td><td class="source">        //                 }</td></tr><tr><td class="line">735</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">736</td><td class="hits"></td><td class="source">        //                 var stripeToken = req.params.stripeToken;</td></tr><tr><td class="line">737</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">738</td><td class="hits"></td><td class="source">        //                 if(!stripeToken) return next(new restifyErrors.InvalidInputError(&quot;The credit card information you entered is invalid&quot;));</td></tr><tr><td class="line">739</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">740</td><td class="hits"></td><td class="source">        //                 Payment.createCustomer(user, stripeToken, owned, CURRENT_PLAN, coupon, function(err, customer){</td></tr><tr><td class="line">741</td><td class="hits"></td><td class="source">        //                     if(err &amp;&amp; err.name == &quot;card_error&quot;) {</td></tr><tr><td class="line">742</td><td class="hits"></td><td class="source">        //                         return next(new restifyErrors.InvalidInputError(&quot;The credit card information you entered is invalid&quot;));</td></tr><tr><td class="line">743</td><td class="hits"></td><td class="source">        //                     } else if(err) return next(err);</td></tr><tr><td class="line">744</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">745</td><td class="hits"></td><td class="source">        //                     user.customer = customer;</td></tr><tr><td class="line">746</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">747</td><td class="hits"></td><td class="source">        //                     Notebook.forOwnedNotebooks(user, function(err, notebook, done){</td></tr><tr><td class="line">748</td><td class="hits"></td><td class="source">        //                         notebook.anonymousAccess = false;</td></tr><tr><td class="line">749</td><td class="hits"></td><td class="source">        //                         notebook.save(done);</td></tr><tr><td class="line">750</td><td class="hits"></td><td class="source">        //                     });</td></tr><tr><td class="line">751</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">752</td><td class="hits"></td><td class="source">        //                     return saveUser();</td></tr><tr><td class="line">753</td><td class="hits"></td><td class="source">        //                 });</td></tr><tr><td class="line">754</td><td class="hits"></td><td class="source">        //             });</td></tr><tr><td class="line">755</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">756</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">757</td><td class="hits"></td><td class="source">        //             function saveUser(){</td></tr><tr><td class="line">758</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">759</td><td class="hits"></td><td class="source">        //                 user.save(function(err, saved){</td></tr><tr><td class="line">760</td><td class="hits"></td><td class="source">        //                     if(err &amp;&amp; err.errors) {</td></tr><tr><td class="line">761</td><td class="hits"></td><td class="source">        //                         return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">762</td><td class="hits"></td><td class="source">        //                     }</td></tr><tr><td class="line">763</td><td class="hits"></td><td class="source">        //                     else if(err) return next(err);</td></tr><tr><td class="line">764</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">765</td><td class="hits"></td><td class="source">        //                     saved = User.prepareForOutput(saved);</td></tr><tr><td class="line">766</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">767</td><td class="hits"></td><td class="source">        //                     return res.send(saved);</td></tr><tr><td class="line">768</td><td class="hits"></td><td class="source">        //                 });</td></tr><tr><td class="line">769</td><td class="hits"></td><td class="source">        //             }</td></tr><tr><td class="line">770</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">771</td><td class="hits"></td><td class="source">        //         });</td></tr><tr><td class="line">772</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">773</td><td class="hits"></td><td class="source">        // });</td></tr><tr><td class="line">774</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">775</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">776</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">777</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">778</td><td class="hits">1</td><td class="source">    var _retargetRegister = function(req, res, next) {</td></tr><tr><td class="line">779</td><td class="hits"></td><td class="source">        /*</td></tr><tr><td class="line">780</td><td class="hits"></td><td class="source">            This is where a user registers, require a valid invite,</td></tr><tr><td class="line">781</td><td class="hits"></td><td class="source">            email, password, and payment if they own a notebook</td></tr><tr><td class="line">782</td><td class="hits"></td><td class="source">        */</td></tr><tr><td class="line">783</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">784</td><td class="hits">7</td><td class="source">        if(!req.params.email) {</td></tr><tr class="hit"><td class="line">785</td><td class="hits">1</td><td class="source">            return next(new restifyErrors.InvalidInputError(&quot;Email Required&quot;));</td></tr><tr><td class="line">786</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">787</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">788</td><td class="hits">6</td><td class="source">        if(!req.params.password) {</td></tr><tr class="hit"><td class="line">789</td><td class="hits">1</td><td class="source">            return next(new restifyErrors.InvalidInputError(&quot;Password required&quot;));</td></tr><tr><td class="line">790</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">791</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">792</td><td class="hits">5</td><td class="source">        if(!req.params.firstName) {</td></tr><tr class="hit"><td class="line">793</td><td class="hits">1</td><td class="source">            return next(new restifyErrors.InvalidInputError(&quot;Name required&quot;));</td></tr><tr><td class="line">794</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">795</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">796</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">797</td><td class="hits">4</td><td class="source">        User.Model.count({ //Need to make sure that there isn't someone else with that email address</td></tr><tr><td class="line">798</td><td class="hits"></td><td class="source">            _id: {$ne: req.params.id},</td></tr><tr><td class="line">799</td><td class="hits"></td><td class="source">            invite: {$ne: req.params.invite},</td></tr><tr><td class="line">800</td><td class="hits"></td><td class="source">            email: req.params.email</td></tr><tr><td class="line">801</td><td class="hits"></td><td class="source">        }, function(err, count){</td></tr><tr class="hit"><td class="line">802</td><td class="hits">4</td><td class="source">            if(err) return next(err);</td></tr><tr><td class="line">803</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">804</td><td class="hits">4</td><td class="source">            if(count &gt; 0) {</td></tr><tr class="hit"><td class="line">805</td><td class="hits">1</td><td class="source">                return next(new restifyErrors.InvalidInputError(&quot;This email address is already in use&quot;));</td></tr><tr><td class="line">806</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">807</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">808</td><td class="hits">3</td><td class="source">            User.Model</td></tr><tr><td class="line">809</td><td class="hits"></td><td class="source">                .findOne({</td></tr><tr><td class="line">810</td><td class="hits"></td><td class="source">                    _id: req.params.id,</td></tr><tr><td class="line">811</td><td class="hits"></td><td class="source">                    enabled: false,</td></tr><tr><td class="line">812</td><td class="hits"></td><td class="source">                    invite: req.params.invite</td></tr><tr><td class="line">813</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">814</td><td class="hits"></td><td class="source">                .exec(function(err, user){</td></tr><tr class="hit"><td class="line">815</td><td class="hits">3</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">816</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">817</td><td class="hits">3</td><td class="source">                    if(!user) {</td></tr><tr class="hit"><td class="line">818</td><td class="hits">1</td><td class="source">                        return next(new restify.ResourceNotFoundError(&quot;User not found&quot;));</td></tr><tr><td class="line">819</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">820</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">821</td><td class="hits">2</td><td class="source">                    user.password = req.params.password;</td></tr><tr class="hit"><td class="line">822</td><td class="hits">2</td><td class="source">                    user.firstName = req.params.firstName;</td></tr><tr class="hit"><td class="line">823</td><td class="hits">2</td><td class="source">                    user.lastName = req.params.lastName;</td></tr><tr class="hit"><td class="line">824</td><td class="hits">2</td><td class="source">                    user.email = req.params.email;</td></tr><tr class="hit"><td class="line">825</td><td class="hits">2</td><td class="source">                    user.planOffered = req.params.planOffered || settings.defaultPlan;</td></tr><tr class="hit"><td class="line">826</td><td class="hits">2</td><td class="source">                    if(req.params.job) {</td></tr><tr class="miss"><td class="line">827</td><td class="hits">0</td><td class="source">                        user.job.title = req.params.job.title || null;</td></tr><tr class="miss"><td class="line">828</td><td class="hits">0</td><td class="source">                        user.job.company = req.params.job.company;</td></tr><tr><td class="line">829</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">830</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">831</td><td class="hits">2</td><td class="source">                    user.enabled = true;</td></tr><tr><td class="line">832</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">833</td><td class="hits">2</td><td class="source">                    return saveUser();</td></tr><tr><td class="line">834</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">835</td><td class="hits">0</td><td class="source">                    function saveUser(){</td></tr><tr><td class="line">836</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">837</td><td class="hits">2</td><td class="source">                        user.save(function(err, saved){</td></tr><tr class="hit"><td class="line">838</td><td class="hits">2</td><td class="source">                            if(err &amp;&amp; err.errors) {</td></tr><tr class="miss"><td class="line">839</td><td class="hits">0</td><td class="source">                                return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">840</td><td class="hits"></td><td class="source">                            }</td></tr><tr class="hit"><td class="line">841</td><td class="hits">2</td><td class="source">                            else if(err) return next(err);</td></tr><tr><td class="line">842</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">843</td><td class="hits">2</td><td class="source">                            saved = User.prepareForOutput(saved);</td></tr><tr><td class="line">844</td><td class="hits"></td><td class="source">                            //here is where we want to create a customer if it hasn't been created already</td></tr><tr class="hit"><td class="line">845</td><td class="hits">2</td><td class="source">                            _createCustomerRecord(user, user.planOffered, req.params.coupon,function(err, customer){</td></tr><tr class="hit"><td class="line">846</td><td class="hits">2</td><td class="source">                                console.log(&quot;created customer&quot;, err, customer);</td></tr><tr><td class="line">847</td><td class="hits"></td><td class="source">                            });</td></tr><tr class="hit"><td class="line">848</td><td class="hits">2</td><td class="source">                            var data = saved;</td></tr><tr class="hit"><td class="line">849</td><td class="hits">2</td><td class="source">                            var from = settings.email.from;</td></tr><tr class="hit"><td class="line">850</td><td class="hits">2</td><td class="source">                            var email = new Email.Model({</td></tr><tr><td class="line">851</td><td class="hits"></td><td class="source">                                to: saved.email,</td></tr><tr><td class="line">852</td><td class="hits"></td><td class="source">                                from: from,</td></tr><tr><td class="line">853</td><td class="hits"></td><td class="source">                                subject: &quot;Thank you for signing up for Primeloop. Now what?&quot;</td></tr><tr><td class="line">854</td><td class="hits"></td><td class="source">                            });</td></tr><tr class="hit"><td class="line">855</td><td class="hits">2</td><td class="source">                            var template = &quot;new_user_invite_welcome.mu&quot;;</td></tr><tr class="hit"><td class="line">856</td><td class="hits">2</td><td class="source">                            email.renderTemplate(data, template, &quot;html&quot;, function(err, html){</td></tr><tr class="hit"><td class="line">857</td><td class="hits">2</td><td class="source">                                console.log(&quot;Email sent to:&quot;, saved.email);</td></tr><tr class="hit"><td class="line">858</td><td class="hits">2</td><td class="source">                                email.send(function(err, result){</td></tr><tr class="hit"><td class="line">859</td><td class="hits">2</td><td class="source">                                    if(err) console.log(&quot;Error sending welcome email:&quot;, err);</td></tr><tr><td class="line">860</td><td class="hits"></td><td class="source">                                });</td></tr><tr><td class="line">861</td><td class="hits"></td><td class="source">                            });</td></tr><tr class="hit"><td class="line">862</td><td class="hits">2</td><td class="source">                            return res.send(saved);</td></tr><tr><td class="line">863</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">864</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">865</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">866</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">867</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">868</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">869</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">870</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">871</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">872</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">873</td><td class="hits">1</td><td class="source">    var _current = function(req, res, next) {</td></tr><tr class="hit"><td class="line">874</td><td class="hits">1</td><td class="source">        var</td></tr><tr><td class="line">875</td><td class="hits"></td><td class="source">            user = req.user;</td></tr><tr class="hit"><td class="line">876</td><td class="hits">1</td><td class="source">        Notebook.getNotebooksForUser(user, function(err, notebooks){</td></tr><tr class="hit"><td class="line">877</td><td class="hits">1</td><td class="source">            if(err) return next(err);</td></tr><tr class="hit"><td class="line">878</td><td class="hits">1</td><td class="source">            user = User.prepareForOutput(user);</td></tr><tr class="hit"><td class="line">879</td><td class="hits">1</td><td class="source">            user.notebooks = notebooks;</td></tr><tr class="hit"><td class="line">880</td><td class="hits">1</td><td class="source">            return res.send(user);</td></tr><tr><td class="line">881</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">882</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">883</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">884</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">885</td><td class="hits">1</td><td class="source">    var _invited = function(req, res, next) {</td></tr><tr><td class="line">886</td><td class="hits"></td><td class="source">        // console.log(&quot;params&quot;, req.params);</td></tr><tr class="hit"><td class="line">887</td><td class="hits">3</td><td class="source">        User.Model</td></tr><tr><td class="line">888</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">889</td><td class="hits"></td><td class="source">                $or: [</td></tr><tr><td class="line">890</td><td class="hits"></td><td class="source">                    { invite: req.params.id },</td></tr><tr><td class="line">891</td><td class="hits"></td><td class="source">                    { email: req.params.email }</td></tr><tr><td class="line">892</td><td class="hits"></td><td class="source">                ]</td></tr><tr><td class="line">893</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">894</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">895</td><td class="hits"></td><td class="source">            .exec(function(err, user){</td></tr><tr class="hit"><td class="line">896</td><td class="hits">3</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">897</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">898</td><td class="hits">3</td><td class="source">                if(!user) {</td></tr><tr class="hit"><td class="line">899</td><td class="hits">1</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;Invite not found&quot;));</td></tr><tr><td class="line">900</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">901</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">902</td><td class="hits">3</td><td class="source">                if(user.enabled) return next(new restifyErrors.UserRegisteredError(&quot;This invite code has already been used&quot;));</td></tr><tr><td class="line">903</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">904</td><td class="hits">1</td><td class="source">                user = User.prepareForOutput(user);</td></tr><tr><td class="line">905</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">906</td><td class="hits">1</td><td class="source">                Notebook.ownedNotebooks(user, function(err, owned){</td></tr><tr class="hit"><td class="line">907</td><td class="hits">1</td><td class="source">                    if(!req.params.id &amp;&amp; owned &lt;= 0) return next(new restify.ResourceNotFoundError(&quot;Invite not found&quot;));</td></tr><tr><td class="line">908</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">909</td><td class="hits">1</td><td class="source">                    user.ownedNotebooks = owned;</td></tr><tr class="hit"><td class="line">910</td><td class="hits">1</td><td class="source">                    return res.send(user);</td></tr><tr><td class="line">911</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">912</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">913</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">914</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">915</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">916</td><td class="hits">1</td><td class="source">    var _archive = function(req, res, next) {</td></tr><tr><td class="line">917</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">918</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">919</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">920</td><td class="hits">1</td><td class="source">    var _subscribe = function(req, res, next) {</td></tr><tr><td class="line">921</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">922</td><td class="hits"></td><td class="source">        // var notebooksToBuy = req.params.notebooks;</td></tr><tr><td class="line">923</td><td class="hits"></td><td class="source">        // var coupon = req.params.coupon;</td></tr><tr><td class="line">924</td><td class="hits"></td><td class="source">        // var plan = req.params.plan || settings.defaultPlan;</td></tr><tr><td class="line">925</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">926</td><td class="hits"></td><td class="source">        // var qtyPurchased = 1;</td></tr><tr><td class="line">927</td><td class="hits"></td><td class="source">        // if(notebooksToBuy &amp;&amp; notebooksToBuy.length &gt; 0) {</td></tr><tr><td class="line">928</td><td class="hits"></td><td class="source">        //     qtyPurchased = notebooksToBuy.length;</td></tr><tr><td class="line">929</td><td class="hits"></td><td class="source">        // }</td></tr><tr><td class="line">930</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">931</td><td class="hits"></td><td class="source">        // User.Model</td></tr><tr><td class="line">932</td><td class="hits"></td><td class="source">        //     .findOne({</td></tr><tr><td class="line">933</td><td class="hits"></td><td class="source">        //         _id: req.user._id</td></tr><tr><td class="line">934</td><td class="hits"></td><td class="source">        //     })</td></tr><tr><td class="line">935</td><td class="hits"></td><td class="source">        //     .exec(function(err, user){</td></tr><tr><td class="line">936</td><td class="hits"></td><td class="source">        //         if(err) return next(err);</td></tr><tr><td class="line">937</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">938</td><td class="hits"></td><td class="source">        //         if(!user) return next(new restify.ResourceNotFoundError(&quot;User not found&quot;));</td></tr><tr><td class="line">939</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">940</td><td class="hits"></td><td class="source">        //         if(user.customer &amp;&amp; user.customer.subscription) { //Update the subscription for a current customer</td></tr><tr><td class="line">941</td><td class="hits"></td><td class="source">        //             //TODO: Rethink how we're doing this since it's no longer per notebook but based on plan</td></tr><tr><td class="line">942</td><td class="hits"></td><td class="source">        //             // Payment.increaseSubscription(user.customer, user.customer.subscription.plan.id, qtyPurchased, coupon, function(err, subscription){</td></tr><tr><td class="line">943</td><td class="hits"></td><td class="source">        //             //     if(err) return next(err);</td></tr><tr><td class="line">944</td><td class="hits"></td><td class="source">        //             //     var customer = user.customer;</td></tr><tr><td class="line">945</td><td class="hits"></td><td class="source">        //             //     customer.subscription = subscription;</td></tr><tr><td class="line">946</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">947</td><td class="hits"></td><td class="source">        //             //     user.customer = customer;</td></tr><tr><td class="line">948</td><td class="hits"></td><td class="source">        //             //     user.markModified(&quot;customer&quot;);</td></tr><tr><td class="line">949</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">950</td><td class="hits"></td><td class="source">        //             //     if(notebooksToBuy &amp;&amp; notebooksToBuy.length &gt; 0) {</td></tr><tr><td class="line">951</td><td class="hits"></td><td class="source">        //             //         return updateTrialNotebooks(notebooksToBuy, saveUser);</td></tr><tr><td class="line">952</td><td class="hits"></td><td class="source">        //             //     } else {</td></tr><tr><td class="line">953</td><td class="hits"></td><td class="source">        //             //         return createNotebooks(user, saveUser);</td></tr><tr><td class="line">954</td><td class="hits"></td><td class="source">        //             //     }</td></tr><tr><td class="line">955</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">956</td><td class="hits"></td><td class="source">        //             // });</td></tr><tr><td class="line">957</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">958</td><td class="hits"></td><td class="source">        //         } else { //This is a new customer</td></tr><tr><td class="line">959</td><td class="hits"></td><td class="source">        //             // if(user.trial &amp;&amp; !notebooksToBuy) {</td></tr><tr><td class="line">960</td><td class="hits"></td><td class="source">        //             //     return next(new restifyErrors.InvalidInputError(&quot;You must select at least one notebook to purchase&quot;));</td></tr><tr><td class="line">961</td><td class="hits"></td><td class="source">        //             // }</td></tr><tr><td class="line">962</td><td class="hits"></td><td class="source">        //             var stripeToken = req.params.stripeToken;</td></tr><tr><td class="line">963</td><td class="hits"></td><td class="source">        //             if(!stripeToken) return next(new restifyErrors.InvalidInputError(&quot;The credit card information you entered is invalid.&quot;));</td></tr><tr><td class="line">964</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">965</td><td class="hits"></td><td class="source">        //             Payment.createCustomer(user, stripeToken, 1, plan, coupon, function(err, customer){</td></tr><tr><td class="line">966</td><td class="hits"></td><td class="source">        //                 if(err &amp;&amp; err.name == &quot;card_error&quot;) {</td></tr><tr><td class="line">967</td><td class="hits"></td><td class="source">        //                     return next(new restifyErrors.InvalidInputError(&quot;The credit card information you entered is invalid&quot;));</td></tr><tr><td class="line">968</td><td class="hits"></td><td class="source">        //                 } else if(err) return next(err);</td></tr><tr><td class="line">969</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">970</td><td class="hits"></td><td class="source">        //                 user.customer = customer;</td></tr><tr><td class="line">971</td><td class="hits"></td><td class="source">        //                 user.trial = null;</td></tr><tr><td class="line">972</td><td class="hits"></td><td class="source">        //                 user.trialStart = null;</td></tr><tr><td class="line">973</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">974</td><td class="hits"></td><td class="source">        //                 updateWaitingListConversion(user._id, function(err){</td></tr><tr><td class="line">975</td><td class="hits"></td><td class="source">        //                     if(err) return console.log(&quot;Error saving list conversion tracking:&quot;, err.stack || err);</td></tr><tr><td class="line">976</td><td class="hits"></td><td class="source">        //                 });</td></tr><tr><td class="line">977</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">978</td><td class="hits"></td><td class="source">        //                 if(notebooksToBuy &amp;&amp; notebooksToBuy.length &gt; 0) {</td></tr><tr><td class="line">979</td><td class="hits"></td><td class="source">        //                     // console.log(&quot;attempting to update trial notebooks&quot;);</td></tr><tr><td class="line">980</td><td class="hits"></td><td class="source">        //                     return updateTrialNotebooks(notebooksToBuy, saveUser);</td></tr><tr><td class="line">981</td><td class="hits"></td><td class="source">        //                 } else {</td></tr><tr><td class="line">982</td><td class="hits"></td><td class="source">        //                     // console.log(&quot;no trial notebooks found, creating a new one&quot;);</td></tr><tr><td class="line">983</td><td class="hits"></td><td class="source">        //                     return createNotebooks(user, saveUser);</td></tr><tr><td class="line">984</td><td class="hits"></td><td class="source">        //                 }</td></tr><tr><td class="line">985</td><td class="hits"></td><td class="source">        //             });</td></tr><tr><td class="line">986</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">987</td><td class="hits"></td><td class="source">        //         }</td></tr><tr><td class="line">988</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">989</td><td class="hits"></td><td class="source">        //         function updateWaitingListConversion(id, done) {</td></tr><tr><td class="line">990</td><td class="hits"></td><td class="source">        //             UserWaiting.Model.findOne({</td></tr><tr><td class="line">991</td><td class="hits"></td><td class="source">        //                 user: id</td></tr><tr><td class="line">992</td><td class="hits"></td><td class="source">        //             }, function(err, waitingUser){</td></tr><tr><td class="line">993</td><td class="hits"></td><td class="source">        //                 if(err) return done(err);</td></tr><tr><td class="line">994</td><td class="hits"></td><td class="source">        //                 if(!waitingUser.conversionDate) {</td></tr><tr><td class="line">995</td><td class="hits"></td><td class="source">        //                     waitingUser.conversionDate = new Date();</td></tr><tr><td class="line">996</td><td class="hits"></td><td class="source">        //                     waitingUser.markModified(&quot;conversionDate&quot;);</td></tr><tr><td class="line">997</td><td class="hits"></td><td class="source">        //                     waitingUser.save(done);</td></tr><tr><td class="line">998</td><td class="hits"></td><td class="source">        //                 } else {</td></tr><tr><td class="line">999</td><td class="hits"></td><td class="source">        //                     return done();</td></tr><tr><td class="line">1000</td><td class="hits"></td><td class="source">        //                 }</td></tr><tr><td class="line">1001</td><td class="hits"></td><td class="source">        //             });</td></tr><tr><td class="line">1002</td><td class="hits"></td><td class="source">        //         }</td></tr><tr><td class="line">1003</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1004</td><td class="hits"></td><td class="source">        //         function updateTrialNotebooks(notebooksToBuy, done) {</td></tr><tr><td class="line">1005</td><td class="hits"></td><td class="source">        //             var notebooks = [];</td></tr><tr><td class="line">1006</td><td class="hits"></td><td class="source">        //             var len = notebooksToBuy.length;</td></tr><tr><td class="line">1007</td><td class="hits"></td><td class="source">        //             var _updatedNotebook = function(err, notebook){</td></tr><tr><td class="line">1008</td><td class="hits"></td><td class="source">        //                     if(notebook) notebooks.push(notebook);</td></tr><tr><td class="line">1009</td><td class="hits"></td><td class="source">        //                     return --len || done(err, notebooks);</td></tr><tr><td class="line">1010</td><td class="hits"></td><td class="source">        //                 };</td></tr><tr><td class="line">1011</td><td class="hits"></td><td class="source">        //             for(var i = 0; i &lt; notebooksToBuy.length; i++) {</td></tr><tr><td class="line">1012</td><td class="hits"></td><td class="source">        //                 // console.log(&quot;notebook id: &quot; + notebooksToBuy[i]);</td></tr><tr><td class="line">1013</td><td class="hits"></td><td class="source">        //                 updateTrialNotebook(notebooksToBuy[i], _updatedNotebook);</td></tr><tr><td class="line">1014</td><td class="hits"></td><td class="source">        //             }</td></tr><tr><td class="line">1015</td><td class="hits"></td><td class="source">        //         }</td></tr><tr><td class="line">1016</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1017</td><td class="hits"></td><td class="source">        //         function updateTrialNotebook(id, done) {</td></tr><tr><td class="line">1018</td><td class="hits"></td><td class="source">        //             // console.log(&quot;update notebook: &quot; + id);</td></tr><tr><td class="line">1019</td><td class="hits"></td><td class="source">        //             Notebook.Model</td></tr><tr><td class="line">1020</td><td class="hits"></td><td class="source">        //                 .findOne({</td></tr><tr><td class="line">1021</td><td class="hits"></td><td class="source">        //                     _id: id</td></tr><tr><td class="line">1022</td><td class="hits"></td><td class="source">        //                 })</td></tr><tr><td class="line">1023</td><td class="hits"></td><td class="source">        //                 .exec(function(err, notebook){</td></tr><tr><td class="line">1024</td><td class="hits"></td><td class="source">        //                     if(err) return done(err);</td></tr><tr><td class="line">1025</td><td class="hits"></td><td class="source">        //                     if(!notebook) return done(null, []);</td></tr><tr><td class="line">1026</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1027</td><td class="hits"></td><td class="source">        //                     notebook.trial = null;</td></tr><tr><td class="line">1028</td><td class="hits"></td><td class="source">        //                     notebook.trialStart = null;</td></tr><tr><td class="line">1029</td><td class="hits"></td><td class="source">        //                     notebook.type = &quot;paid&quot;;</td></tr><tr><td class="line">1030</td><td class="hits"></td><td class="source">        //                     notebook.save(function(err, saved){</td></tr><tr><td class="line">1031</td><td class="hits"></td><td class="source">        //                         return done(err, saved);</td></tr><tr><td class="line">1032</td><td class="hits"></td><td class="source">        //                     });</td></tr><tr><td class="line">1033</td><td class="hits"></td><td class="source">        //                 });</td></tr><tr><td class="line">1034</td><td class="hits"></td><td class="source">        //         }</td></tr><tr><td class="line">1035</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1036</td><td class="hits"></td><td class="source">        //         function createNotebooks(user, done){</td></tr><tr><td class="line">1037</td><td class="hits"></td><td class="source">        //             // console.log(&quot;calling createNotebooks : &quot; + user.purchasedNotebooks);</td></tr><tr><td class="line">1038</td><td class="hits"></td><td class="source">        //             if(!user.purchasedNotebooks || user.purchasedNotebooks &lt;= 0) return done(null, []);</td></tr><tr><td class="line">1039</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1040</td><td class="hits"></td><td class="source">        //             var notebooks = [];</td></tr><tr><td class="line">1041</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1042</td><td class="hits"></td><td class="source">        //             Notebook.ownedNotebooks(user, function(err, count){</td></tr><tr><td class="line">1043</td><td class="hits"></td><td class="source">        //                 var</td></tr><tr><td class="line">1044</td><td class="hits"></td><td class="source">        //                     diff = user.purchasedNotebooks-count,</td></tr><tr><td class="line">1045</td><td class="hits"></td><td class="source">        //                     len = diff,</td></tr><tr><td class="line">1046</td><td class="hits"></td><td class="source">        //                     _onCreateNotebook = function(err, notebook){</td></tr><tr><td class="line">1047</td><td class="hits"></td><td class="source">        //                             if(notebook) notebooks.push(notebook);</td></tr><tr><td class="line">1048</td><td class="hits"></td><td class="source">        //                             return --len || done(err, notebooks);</td></tr><tr><td class="line">1049</td><td class="hits"></td><td class="source">        //                         };</td></tr><tr><td class="line">1050</td><td class="hits"></td><td class="source">        //                 // console.log(&quot;we need to create &quot; + diff + &quot; notebooks&quot;);</td></tr><tr><td class="line">1051</td><td class="hits"></td><td class="source">        //                 if(diff &gt; 0) {</td></tr><tr><td class="line">1052</td><td class="hits"></td><td class="source">        //                     for(var i = 0; i &lt; diff; i++) {</td></tr><tr><td class="line">1053</td><td class="hits"></td><td class="source">        //                         createNotebook(i, user, _onCreateNotebook);</td></tr><tr><td class="line">1054</td><td class="hits"></td><td class="source">        //                     }</td></tr><tr><td class="line">1055</td><td class="hits"></td><td class="source">        //                 } else {</td></tr><tr><td class="line">1056</td><td class="hits"></td><td class="source">        //                     return done(err, []);</td></tr><tr><td class="line">1057</td><td class="hits"></td><td class="source">        //                 }</td></tr><tr><td class="line">1058</td><td class="hits"></td><td class="source">        //              });</td></tr><tr><td class="line">1059</td><td class="hits"></td><td class="source">        //             //TODO: create a notebook if they don't have one they own</td></tr><tr><td class="line">1060</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1061</td><td class="hits"></td><td class="source">        //         }</td></tr><tr><td class="line">1062</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1063</td><td class="hits"></td><td class="source">        //         function createNotebook(i, user, done) {</td></tr><tr><td class="line">1064</td><td class="hits"></td><td class="source">        //             // console.log(&quot;calling createNotebook&quot;);</td></tr><tr><td class="line">1065</td><td class="hits"></td><td class="source">        //             var</td></tr><tr><td class="line">1066</td><td class="hits"></td><td class="source">        //                 append = (i!==0) ? &quot; &quot; + i.toString() : &quot;&quot;,</td></tr><tr><td class="line">1067</td><td class="hits"></td><td class="source">        //                 nb = new Notebook.Model({</td></tr><tr><td class="line">1068</td><td class="hits"></td><td class="source">        //                     name: user.name+&quot;'s Notebook&quot; + append</td></tr><tr><td class="line">1069</td><td class="hits"></td><td class="source">        //                 });</td></tr><tr><td class="line">1070</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1071</td><td class="hits"></td><td class="source">        //             nb.users.push({</td></tr><tr><td class="line">1072</td><td class="hits"></td><td class="source">        //                 user: user._id,</td></tr><tr><td class="line">1073</td><td class="hits"></td><td class="source">        //                 role: &quot;owner&quot;</td></tr><tr><td class="line">1074</td><td class="hits"></td><td class="source">        //             });</td></tr><tr><td class="line">1075</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1076</td><td class="hits"></td><td class="source">        //             return nb.save(function(err, notebook){</td></tr><tr><td class="line">1077</td><td class="hits"></td><td class="source">        //                 if(err) return done(err);</td></tr><tr><td class="line">1078</td><td class="hits"></td><td class="source">        //                 // console.log(&quot;saved notebook: &quot; + notebook);</td></tr><tr><td class="line">1079</td><td class="hits"></td><td class="source">        //                 return done(null, notebook);</td></tr><tr><td class="line">1080</td><td class="hits"></td><td class="source">        //             });</td></tr><tr><td class="line">1081</td><td class="hits"></td><td class="source">        //         }</td></tr><tr><td class="line">1082</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1083</td><td class="hits"></td><td class="source">        //         function saveUser(err, notebooks){</td></tr><tr><td class="line">1084</td><td class="hits"></td><td class="source">        //             // console.log(&quot;error saving notebook: &quot; + err);</td></tr><tr><td class="line">1085</td><td class="hits"></td><td class="source">        //             // console.log(&quot;saved notebooks: &quot; + JSON.stringify(notebooks));</td></tr><tr><td class="line">1086</td><td class="hits"></td><td class="source">        //             user.save(function(err, saved){</td></tr><tr><td class="line">1087</td><td class="hits"></td><td class="source">        //                 if(err &amp;&amp; err.errors) {</td></tr><tr><td class="line">1088</td><td class="hits"></td><td class="source">        //                     return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">1089</td><td class="hits"></td><td class="source">        //                 }</td></tr><tr><td class="line">1090</td><td class="hits"></td><td class="source">        //                 else if(err) return next(err);</td></tr><tr><td class="line">1091</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1092</td><td class="hits"></td><td class="source">        //                 next();</td></tr><tr><td class="line">1093</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1094</td><td class="hits"></td><td class="source">        //                 return res.send({</td></tr><tr><td class="line">1095</td><td class="hits"></td><td class="source">        //                     status: &quot;subscription increased&quot;,</td></tr><tr><td class="line">1096</td><td class="hits"></td><td class="source">        //                     subscriptions: saved.customer.subscription.quantity,</td></tr><tr><td class="line">1097</td><td class="hits"></td><td class="source">        //                     notebooks: notebooks,</td></tr><tr><td class="line">1098</td><td class="hits"></td><td class="source">        //                     code: 200</td></tr><tr><td class="line">1099</td><td class="hits"></td><td class="source">        //                 });</td></tr><tr><td class="line">1100</td><td class="hits"></td><td class="source">        //             });</td></tr><tr><td class="line">1101</td><td class="hits"></td><td class="source">        //         }</td></tr><tr><td class="line">1102</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1103</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">1104</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1105</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1106</td><td class="hits">1</td><td class="source">    var _unsubscribe = function(req, res, next) {</td></tr><tr><td class="line">1107</td><td class="hits"></td><td class="source">        //TODO: Require some permissions (?)</td></tr><tr><td class="line">1108</td><td class="hits"></td><td class="source">        // User.Model</td></tr><tr><td class="line">1109</td><td class="hits"></td><td class="source">        //     .findOne({</td></tr><tr><td class="line">1110</td><td class="hits"></td><td class="source">        //         _id: req.user._id</td></tr><tr><td class="line">1111</td><td class="hits"></td><td class="source">        //     })</td></tr><tr><td class="line">1112</td><td class="hits"></td><td class="source">        //     .exec(function(err, user){</td></tr><tr><td class="line">1113</td><td class="hits"></td><td class="source">        //         if(err) return next(err);</td></tr><tr><td class="line">1114</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1115</td><td class="hits"></td><td class="source">        //         if(!user) return next(new restify.ResourceNotFoundError(&quot;User not found&quot;));</td></tr><tr><td class="line">1116</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1117</td><td class="hits"></td><td class="source">        //         Notebook.ownedNotebooks(user, function(err, count){</td></tr><tr><td class="line">1118</td><td class="hits"></td><td class="source">        //             if(err) return next(err);</td></tr><tr><td class="line">1119</td><td class="hits"></td><td class="source">        //             if(user.customer &amp;&amp; user.customer.subscription &amp;&amp; user.customer.subscription.quantity &gt; 0) {</td></tr><tr><td class="line">1120</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1121</td><td class="hits"></td><td class="source">        //                 if(count &gt;= user.customer.subscription.quantity) {</td></tr><tr><td class="line">1122</td><td class="hits"></td><td class="source">        //                     return res.send({</td></tr><tr><td class="line">1123</td><td class="hits"></td><td class="source">        //                         status: &quot;subscription unchanged&quot;,</td></tr><tr><td class="line">1124</td><td class="hits"></td><td class="source">        //                         message: &quot;You must remove a notebook before you can decrease your subscriptions&quot;,</td></tr><tr><td class="line">1125</td><td class="hits"></td><td class="source">        //                         code: 200</td></tr><tr><td class="line">1126</td><td class="hits"></td><td class="source">        //                     });</td></tr><tr><td class="line">1127</td><td class="hits"></td><td class="source">        //                 }</td></tr><tr><td class="line">1128</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1129</td><td class="hits"></td><td class="source">        //                 Payment.decreaseSubscription(user.customer, user.customer.subscription.plan.id, req.params.quantity || -1, function(err, subscription){</td></tr><tr><td class="line">1130</td><td class="hits"></td><td class="source">        //                     if(err) return next(err);</td></tr><tr><td class="line">1131</td><td class="hits"></td><td class="source">        //                     var customer = user.customer;</td></tr><tr><td class="line">1132</td><td class="hits"></td><td class="source">        //                     customer.subscription = subscription;</td></tr><tr><td class="line">1133</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1134</td><td class="hits"></td><td class="source">        //                     user.customer = customer;</td></tr><tr><td class="line">1135</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1136</td><td class="hits"></td><td class="source">        //                     return saveUser();</td></tr><tr><td class="line">1137</td><td class="hits"></td><td class="source">        //                 });</td></tr><tr><td class="line">1138</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1139</td><td class="hits"></td><td class="source">        //             } else res.send({</td></tr><tr><td class="line">1140</td><td class="hits"></td><td class="source">        //                 status: &quot;subscription unchanged&quot;,</td></tr><tr><td class="line">1141</td><td class="hits"></td><td class="source">        //                 subscriptions: (saved.customer) ? saved.customer.subscription.quantity || 0 : 0,</td></tr><tr><td class="line">1142</td><td class="hits"></td><td class="source">        //                 code: 200</td></tr><tr><td class="line">1143</td><td class="hits"></td><td class="source">        //             });</td></tr><tr><td class="line">1144</td><td class="hits"></td><td class="source">        //         });</td></tr><tr><td class="line">1145</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1146</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1147</td><td class="hits"></td><td class="source">        //         function saveUser(){</td></tr><tr><td class="line">1148</td><td class="hits"></td><td class="source">        //             user.save(function(err, saved){</td></tr><tr><td class="line">1149</td><td class="hits"></td><td class="source">        //                 if(err &amp;&amp; err.errors) {</td></tr><tr><td class="line">1150</td><td class="hits"></td><td class="source">        //                     return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">1151</td><td class="hits"></td><td class="source">        //                 }</td></tr><tr><td class="line">1152</td><td class="hits"></td><td class="source">        //                 else if(err) return next(err);</td></tr><tr><td class="line">1153</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1154</td><td class="hits"></td><td class="source">        //                 //Make sure to call next so the session is updated</td></tr><tr><td class="line">1155</td><td class="hits"></td><td class="source">        //                 next();</td></tr><tr><td class="line">1156</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1157</td><td class="hits"></td><td class="source">        //                 return res.send({</td></tr><tr><td class="line">1158</td><td class="hits"></td><td class="source">        //                     status: &quot;subscription decreased&quot;,</td></tr><tr><td class="line">1159</td><td class="hits"></td><td class="source">        //                     subscriptions: saved.customer.subscription.quantity,</td></tr><tr><td class="line">1160</td><td class="hits"></td><td class="source">        //                     code: 200</td></tr><tr><td class="line">1161</td><td class="hits"></td><td class="source">        //                 });</td></tr><tr><td class="line">1162</td><td class="hits"></td><td class="source">        //             });</td></tr><tr><td class="line">1163</td><td class="hits"></td><td class="source">        //         }</td></tr><tr><td class="line">1164</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1165</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">1166</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1167</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1168</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1169</td><td class="hits">1</td><td class="source">    var _subscriptionUpdate = function(req, res, next) {</td></tr><tr><td class="line">1170</td><td class="hits"></td><td class="source">        // var</td></tr><tr><td class="line">1171</td><td class="hits"></td><td class="source">        //     plan = req.params.plan,</td></tr><tr><td class="line">1172</td><td class="hits"></td><td class="source">        //     quantity = req.params.quantity || 1,</td></tr><tr><td class="line">1173</td><td class="hits"></td><td class="source">        //     user = req.params.id;</td></tr><tr><td class="line">1174</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1175</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1176</td><td class="hits"></td><td class="source">        // if(!plan) return next(new restifyErrors.InvalidInputError(&quot;Plan required to update subscription&quot;));</td></tr><tr><td class="line">1177</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1178</td><td class="hits"></td><td class="source">        // if(user !== req.user._id &amp;&amp; req.user.permissions.indexOf(&quot;edit_subscription&quot;) &lt; 0 ) return next(new restify.NotAuthorizedError(&quot;You don't have permission to do that.&quot;));</td></tr><tr><td class="line">1179</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1180</td><td class="hits"></td><td class="source">        // User.Model.findOne({</td></tr><tr><td class="line">1181</td><td class="hits"></td><td class="source">        //     _id: user</td></tr><tr><td class="line">1182</td><td class="hits"></td><td class="source">        // })</td></tr><tr><td class="line">1183</td><td class="hits"></td><td class="source">        // .exec(function(err, user){</td></tr><tr><td class="line">1184</td><td class="hits"></td><td class="source">        //     if(err) return next(err);</td></tr><tr><td class="line">1185</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1186</td><td class="hits"></td><td class="source">        //     if(!user) return next(new restify.ResourceNotFoundError(&quot;User not found&quot;));</td></tr><tr><td class="line">1187</td><td class="hits"></td><td class="source">        //     if(!user.customer) return next(new restifyErrors.InvalidInputError(&quot;User does not currently have a subscription&quot;));</td></tr><tr><td class="line">1188</td><td class="hits"></td><td class="source">        //     //customer, plan, change, coupon, next</td></tr><tr><td class="line">1189</td><td class="hits"></td><td class="source">        //     Payment.updateSubscription(user.customer, plan, 0, null, function(err, subscription){</td></tr><tr><td class="line">1190</td><td class="hits"></td><td class="source">        //         var customer = user.customer;</td></tr><tr><td class="line">1191</td><td class="hits"></td><td class="source">        //         customer.subscription = subscription;</td></tr><tr><td class="line">1192</td><td class="hits"></td><td class="source">        //         user.customer = customer;</td></tr><tr><td class="line">1193</td><td class="hits"></td><td class="source">        //         user.markModified(&quot;customer&quot;);</td></tr><tr><td class="line">1194</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1195</td><td class="hits"></td><td class="source">        //         user.save(function(err, saved){</td></tr><tr><td class="line">1196</td><td class="hits"></td><td class="source">        //             if(err &amp;&amp; err.errors) {</td></tr><tr><td class="line">1197</td><td class="hits"></td><td class="source">        //                 return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">1198</td><td class="hits"></td><td class="source">        //             }</td></tr><tr><td class="line">1199</td><td class="hits"></td><td class="source">        //             else if(err) return next(err);</td></tr><tr><td class="line">1200</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1201</td><td class="hits"></td><td class="source">        //             //Make sure to call next so the session is updated</td></tr><tr><td class="line">1202</td><td class="hits"></td><td class="source">        //             next();</td></tr><tr><td class="line">1203</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1204</td><td class="hits"></td><td class="source">        //             return res.send({</td></tr><tr><td class="line">1205</td><td class="hits"></td><td class="source">        //                 status: &quot;subscription updated&quot;,</td></tr><tr><td class="line">1206</td><td class="hits"></td><td class="source">        //                 subscription: subscription,</td></tr><tr><td class="line">1207</td><td class="hits"></td><td class="source">        //                 code: 200</td></tr><tr><td class="line">1208</td><td class="hits"></td><td class="source">        //             });</td></tr><tr><td class="line">1209</td><td class="hits"></td><td class="source">        //         });</td></tr><tr><td class="line">1210</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1211</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">1212</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1213</td><td class="hits"></td><td class="source">        // });</td></tr><tr><td class="line">1214</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1215</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1216</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1217</td><td class="hits">1</td><td class="source">    var _retargetSubscribe = function(req, res, next) {</td></tr><tr class="miss"><td class="line">1218</td><td class="hits">0</td><td class="source">        var coupon = req.params.coupon;</td></tr><tr class="miss"><td class="line">1219</td><td class="hits">0</td><td class="source">        var plan = req.params.plan || settings.defaultPlan;</td></tr><tr><td class="line">1220</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1221</td><td class="hits">0</td><td class="source">        console.log(&quot;coupon and plan %s %s&quot;, coupon, plan);</td></tr><tr class="miss"><td class="line">1222</td><td class="hits">0</td><td class="source">        User.Model</td></tr><tr><td class="line">1223</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">1224</td><td class="hits"></td><td class="source">                _id: req.user._id</td></tr><tr><td class="line">1225</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">1226</td><td class="hits"></td><td class="source">            .exec(function(err, user){</td></tr><tr class="miss"><td class="line">1227</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">1228</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1229</td><td class="hits">0</td><td class="source">                if(!user) return next(new restify.ResourceNotFoundError(&quot;User not found&quot;));</td></tr><tr><td class="line">1230</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1231</td><td class="hits">0</td><td class="source">                function updateWaitingListConversion(id, done) {</td></tr><tr class="miss"><td class="line">1232</td><td class="hits">0</td><td class="source">                    UserWaiting.Model.findOne({</td></tr><tr><td class="line">1233</td><td class="hits"></td><td class="source">                        user: id</td></tr><tr><td class="line">1234</td><td class="hits"></td><td class="source">                    }, function(err, waitingUser){</td></tr><tr class="miss"><td class="line">1235</td><td class="hits">0</td><td class="source">                        if(err) return done(err);</td></tr><tr class="miss"><td class="line">1236</td><td class="hits">0</td><td class="source">                        if(!waitingUser.conversionDate) {</td></tr><tr class="miss"><td class="line">1237</td><td class="hits">0</td><td class="source">                            waitingUser.conversionDate = new Date();</td></tr><tr class="miss"><td class="line">1238</td><td class="hits">0</td><td class="source">                            waitingUser.markModified(&quot;conversionDate&quot;);</td></tr><tr class="miss"><td class="line">1239</td><td class="hits">0</td><td class="source">                            waitingUser.save(done);</td></tr><tr><td class="line">1240</td><td class="hits"></td><td class="source">                        } else {</td></tr><tr class="miss"><td class="line">1241</td><td class="hits">0</td><td class="source">                            return done();</td></tr><tr><td class="line">1242</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">1243</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">1244</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">1245</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1246</td><td class="hits">0</td><td class="source">                function saveUser(err){</td></tr><tr class="miss"><td class="line">1247</td><td class="hits">0</td><td class="source">                    user.save(function(err, saved){</td></tr><tr class="miss"><td class="line">1248</td><td class="hits">0</td><td class="source">                        if(err &amp;&amp; err.errors) {</td></tr><tr class="miss"><td class="line">1249</td><td class="hits">0</td><td class="source">                            return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">1250</td><td class="hits"></td><td class="source">                        }</td></tr><tr class="miss"><td class="line">1251</td><td class="hits">0</td><td class="source">                        else if(err) return next(err);</td></tr><tr><td class="line">1252</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1253</td><td class="hits">0</td><td class="source">                        next();</td></tr><tr><td class="line">1254</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1255</td><td class="hits">0</td><td class="source">                        return res.send({</td></tr><tr><td class="line">1256</td><td class="hits"></td><td class="source">                            status: &quot;subscription increased&quot;,</td></tr><tr><td class="line">1257</td><td class="hits"></td><td class="source">                            subscriptions: saved.customer.subscription.quantity,</td></tr><tr><td class="line">1258</td><td class="hits"></td><td class="source">                            code: 200</td></tr><tr><td class="line">1259</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">1260</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">1261</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">1262</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1263</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1264</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1265</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1266</td><td class="hits">1</td><td class="source">    var _addToWaitingList = function(req, res, next) {</td></tr><tr class="hit"><td class="line">1267</td><td class="hits">5</td><td class="source">        data = req.params;</td></tr><tr class="hit"><td class="line">1268</td><td class="hits">5</td><td class="source">        data.email = (data.email) ? data.email.toLowerCase() : null;</td></tr><tr class="hit"><td class="line">1269</td><td class="hits">5</td><td class="source">        var isNew = false;</td></tr><tr><td class="line">1270</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1271</td><td class="hits">5</td><td class="source">        if(data.tags) {</td></tr><tr class="hit"><td class="line">1272</td><td class="hits">1</td><td class="source">            data.tags = data.tags.split(&quot;,&quot;);</td></tr><tr><td class="line">1273</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"><td class="line">1274</td><td class="hits">4</td><td class="source">            data.tags = [];</td></tr><tr><td class="line">1275</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">1276</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1277</td><td class="hits">5</td><td class="source">        var adminEntered = req.params.admin;</td></tr><tr><td class="line">1278</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1279</td><td class="hits">5</td><td class="source">        UserWaiting.Model.findOne({</td></tr><tr><td class="line">1280</td><td class="hits"></td><td class="source">            email: data.email</td></tr><tr><td class="line">1281</td><td class="hits"></td><td class="source">        })</td></tr><tr><td class="line">1282</td><td class="hits"></td><td class="source">        .exec(function(err, wuser){</td></tr><tr class="hit"><td class="line">1283</td><td class="hits">5</td><td class="source">            if(err) return next(err);</td></tr><tr><td class="line">1284</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1285</td><td class="hits">5</td><td class="source">            if(!wuser) {</td></tr><tr class="hit"><td class="line">1286</td><td class="hits">4</td><td class="source">                isNew = true;</td></tr><tr class="hit"><td class="line">1287</td><td class="hits">4</td><td class="source">                wuser = new UserWaiting.Model(data);</td></tr><tr><td class="line">1288</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">1289</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1290</td><td class="hits">5</td><td class="source">            User.Model.findOne({</td></tr><tr><td class="line">1291</td><td class="hits"></td><td class="source">                email: data.email</td></tr><tr><td class="line">1292</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">1293</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">1294</td><td class="hits"></td><td class="source">            .exec(function(err, user){</td></tr><tr class="hit"><td class="line">1295</td><td class="hits">5</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">1296</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1297</td><td class="hits">5</td><td class="source">                if(user) {</td></tr><tr class="miss"><td class="line">1298</td><td class="hits">0</td><td class="source">                    isNew = false;</td></tr><tr class="miss"><td class="line">1299</td><td class="hits">0</td><td class="source">                    wuser.isUser = true;</td></tr><tr class="miss"><td class="line">1300</td><td class="hits">0</td><td class="source">                    wuser.user = user._id;</td></tr><tr><td class="line">1301</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">1302</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1303</td><td class="hits">10</td><td class="source">                if(data.tags) wuser.tag = data.tags;</td></tr><tr><td class="line">1304</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1305</td><td class="hits">5</td><td class="source">                if(data.industry) {</td></tr><tr class="hit"><td class="line">1306</td><td class="hits">4</td><td class="source">                    wuser.industry = data.industry;</td></tr><tr class="hit"><td class="line">1307</td><td class="hits">4</td><td class="source">                    wuser.company.industry = data.industry;</td></tr><tr><td class="line">1308</td><td class="hits"></td><td class="source">                }</td></tr><tr class="hit"><td class="line">1309</td><td class="hits">6</td><td class="source">                if(data.phone) wuser.phone = data.phone;</td></tr><tr class="hit"><td class="line">1310</td><td class="hits">5</td><td class="source">                wuser.firstName = data.firstName;</td></tr><tr class="hit"><td class="line">1311</td><td class="hits">5</td><td class="source">                wuser.lastName = data.lastName;</td></tr><tr><td class="line">1312</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1313</td><td class="hits">5</td><td class="source">                wuser.save(function(err, saved){</td></tr><tr class="hit"><td class="line">1314</td><td class="hits">5</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">1315</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1316</td><td class="hits">5</td><td class="source">                    if(settings.slack.webhook) {</td></tr><tr class="miss"><td class="line">1317</td><td class="hits">0</td><td class="source">                        var</td></tr><tr><td class="line">1318</td><td class="hits"></td><td class="source">                            name = wuser.name || wuser.email || &quot;Someone&quot;,</td></tr><tr><td class="line">1319</td><td class="hits"></td><td class="source">                            link = (wuser.user) ? &quot;/admin_x/accounts/&quot; + wuser.user || wuser._id : &quot;/admin_x/waiting/users/&quot; + wuser._id;</td></tr><tr><td class="line">1320</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1321</td><td class="hits">0</td><td class="source">                        link = &quot;https://www.primeloop.com&quot; + link;</td></tr><tr><td class="line">1322</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1323</td><td class="hits">0</td><td class="source">                        request({</td></tr><tr><td class="line">1324</td><td class="hits"></td><td class="source">                            url: settings.slack.webhook,</td></tr><tr><td class="line">1325</td><td class="hits"></td><td class="source">                            method: &quot;POST&quot;,</td></tr><tr><td class="line">1326</td><td class="hits"></td><td class="source">                            json: {</td></tr><tr><td class="line">1327</td><td class="hits"></td><td class="source">                                icon_emoji: &quot;:money_with_wings:&quot;,</td></tr><tr><td class="line">1328</td><td class="hits"></td><td class="source">                                text: name + &quot; has just signed up!&quot;</td></tr><tr><td class="line">1329</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">1330</td><td class="hits"></td><td class="source">                        }, function(err, resp, body){</td></tr><tr class="miss"><td class="line">1331</td><td class="hits">0</td><td class="source">                            if(err) console.log(err, body);</td></tr><tr><td class="line">1332</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">1333</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">1334</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1335</td><td class="hits">5</td><td class="source">                    return res.send(saved);</td></tr><tr><td class="line">1336</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">1337</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1338</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1339</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">1340</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1341</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1342</td><td class="hits">1</td><td class="source">    var _updateWaitingListUser = function(req, res, next) {</td></tr><tr class="hit"><td class="line">1343</td><td class="hits">4</td><td class="source">        var</td></tr><tr><td class="line">1344</td><td class="hits"></td><td class="source">            tag = req.params.tag,</td></tr><tr><td class="line">1345</td><td class="hits"></td><td class="source">            id = req.params.id;</td></tr><tr class="hit"><td class="line">1346</td><td class="hits">5</td><td class="source">        if(req.params.tag) req.params.tag = req.params.tag.toLowerCase();</td></tr><tr><td class="line">1347</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1348</td><td class="hits">4</td><td class="source">        UserWaiting.Model</td></tr><tr><td class="line">1349</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">1350</td><td class="hits"></td><td class="source">                _id: id</td></tr><tr><td class="line">1351</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">1352</td><td class="hits"></td><td class="source">            .exec(function(err, waiting){</td></tr><tr class="hit"><td class="line">1353</td><td class="hits">4</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">1354</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1355</td><td class="hits">4</td><td class="source">                if(!waiting){</td></tr><tr class="miss"><td class="line">1356</td><td class="hits">0</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;User not found&quot;));</td></tr><tr><td class="line">1357</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">1358</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1359</td><td class="hits">4</td><td class="source">                if(req.params.clients) {</td></tr><tr class="miss"><td class="line">1360</td><td class="hits">0</td><td class="source">                    if(waiting.clients &amp;&amp; waiting.clients.length &gt; 0) {</td></tr><tr class="miss"><td class="line">1361</td><td class="hits">0</td><td class="source">                        req.params.clients.map(function(client){</td></tr><tr class="miss"><td class="line">1362</td><td class="hits">0</td><td class="source">                            waiting.clients.push(client);</td></tr><tr><td class="line">1363</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">1364</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">1365</td><td class="hits">0</td><td class="source">                    else waiting.clients = req.params.clients;</td></tr><tr><td class="line">1366</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1367</td><td class="hits">0</td><td class="source">                    waiting.markModified(&quot;clients&quot;);</td></tr><tr><td class="line">1368</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1369</td><td class="hits">0</td><td class="source">                    delete req.params.clients;</td></tr><tr><td class="line">1370</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">1371</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1372</td><td class="hits">4</td><td class="source">                if(req.params.tags) {</td></tr><tr class="miss"><td class="line">1373</td><td class="hits">0</td><td class="source">                    if(waiting.tags &amp;&amp; waiting.tags.length &gt; 0) {</td></tr><tr class="miss"><td class="line">1374</td><td class="hits">0</td><td class="source">                        req.params.tags.map(function(tag){</td></tr><tr class="miss"><td class="line">1375</td><td class="hits">0</td><td class="source">                            waiting.tags.push(tag.toLowerCase());</td></tr><tr><td class="line">1376</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">1377</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">1378</td><td class="hits">0</td><td class="source">                    else waiting.tags = req.params.tags;</td></tr><tr><td class="line">1379</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1380</td><td class="hits">0</td><td class="source">                    waiting.markModified(&quot;tags&quot;);</td></tr><tr><td class="line">1381</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1382</td><td class="hits">0</td><td class="source">                    delete req.params.tags;</td></tr><tr><td class="line">1383</td><td class="hits"></td><td class="source">                }</td></tr><tr class="hit"><td class="line">1384</td><td class="hits">4</td><td class="source">                waiting.setAll(req.params);</td></tr><tr class="hit"><td class="line">1385</td><td class="hits">4</td><td class="source">                if(waiting.user) {</td></tr><tr class="hit"><td class="line">1386</td><td class="hits">3</td><td class="source">                    User.Model</td></tr><tr><td class="line">1387</td><td class="hits"></td><td class="source">                    .findOne({_id: waiting.user})</td></tr><tr><td class="line">1388</td><td class="hits"></td><td class="source">                    .exec(function(err, user){</td></tr><tr class="hit"><td class="line">1389</td><td class="hits">3</td><td class="source">                        if(err) return next(err);</td></tr><tr class="hit"><td class="line">1390</td><td class="hits">3</td><td class="source">                        user.setAll(req.params);</td></tr><tr class="hit"><td class="line">1391</td><td class="hits">3</td><td class="source">                        user.save(function(err, savedUser){</td></tr><tr class="hit"><td class="line">1392</td><td class="hits">3</td><td class="source">                            if(err) return next(err);</td></tr><tr class="hit"><td class="line">1393</td><td class="hits">3</td><td class="source">                            waiting.save(function(err, saved){</td></tr><tr class="hit"><td class="line">1394</td><td class="hits">3</td><td class="source">                                if(err) return next(err);</td></tr><tr class="hit"><td class="line">1395</td><td class="hits">3</td><td class="source">                                res.send(saved);</td></tr><tr><td class="line">1396</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">1397</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">1398</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">1399</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="hit"><td class="line">1400</td><td class="hits">1</td><td class="source">                    waiting.save(function(err, saved){</td></tr><tr class="hit"><td class="line">1401</td><td class="hits">1</td><td class="source">                        if(err) return next(err);</td></tr><tr class="hit"><td class="line">1402</td><td class="hits">1</td><td class="source">                        res.send(saved);</td></tr><tr><td class="line">1403</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">1404</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">1405</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1406</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1407</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1408</td><td class="hits">1</td><td class="source">    var _sendWelcomeEmail = function(req, res, next){</td></tr><tr><td class="line">1409</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1410</td><td class="hits">0</td><td class="source">        var email = (req.params.username) ? req.params.username.toLowerCase() : req.params.username;</td></tr><tr><td class="line">1411</td><td class="hits"></td><td class="source">        //We need to look up email, if it exists then we need to generate a token and send it via email</td></tr><tr class="miss"><td class="line">1412</td><td class="hits">0</td><td class="source">        User.Model</td></tr><tr><td class="line">1413</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">1414</td><td class="hits"></td><td class="source">                &quot;email&quot; : email</td></tr><tr><td class="line">1415</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">1416</td><td class="hits"></td><td class="source">            .exec(function (err, user) {</td></tr><tr class="miss"><td class="line">1417</td><td class="hits">0</td><td class="source">                var data = user;</td></tr><tr class="miss"><td class="line">1418</td><td class="hits">0</td><td class="source">                var from = settings.email.from;</td></tr><tr class="miss"><td class="line">1419</td><td class="hits">0</td><td class="source">                var email = new Email.Model({</td></tr><tr><td class="line">1420</td><td class="hits"></td><td class="source">                    to: data.email,</td></tr><tr><td class="line">1421</td><td class="hits"></td><td class="source">                    from: from,</td></tr><tr><td class="line">1422</td><td class="hits"></td><td class="source">                    subject: &quot;Thank you for signing up for Primeloop. Your next steps...&quot;</td></tr><tr><td class="line">1423</td><td class="hits"></td><td class="source">                });</td></tr><tr class="miss"><td class="line">1424</td><td class="hits">0</td><td class="source">                var template = &quot;new_user_welcome.mu&quot;;</td></tr><tr class="miss"><td class="line">1425</td><td class="hits">0</td><td class="source">                email.renderTemplate(data, template, &quot;html&quot;, function(err, html){</td></tr><tr class="miss"><td class="line">1426</td><td class="hits">0</td><td class="source">                    console.log(&quot;Email sent to:&quot;, data.email);</td></tr><tr class="miss"><td class="line">1427</td><td class="hits">0</td><td class="source">                    email.send(function(err, result){</td></tr><tr class="miss"><td class="line">1428</td><td class="hits">0</td><td class="source">                        if(err) console.log(&quot;Error sending welcome email:&quot;, err);</td></tr><tr class="miss"><td class="line">1429</td><td class="hits">0</td><td class="source">                        return res.send(&quot;Email sent!&quot;);</td></tr><tr><td class="line">1430</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">1431</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">1432</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1433</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1434</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1435</td><td class="hits">1</td><td class="source">    var _addDemoUserToNotebook = function(user, done) {</td></tr><tr><td class="line">1436</td><td class="hits"></td><td class="source">        // Notebook.Model</td></tr><tr><td class="line">1437</td><td class="hits"></td><td class="source">        //     .findOne({</td></tr><tr><td class="line">1438</td><td class="hits"></td><td class="source">        //         demo: true</td></tr><tr><td class="line">1439</td><td class="hits"></td><td class="source">        //     })</td></tr><tr><td class="line">1440</td><td class="hits"></td><td class="source">        //     .exec(function(err, notebook){</td></tr><tr><td class="line">1441</td><td class="hits"></td><td class="source">        //         if(err) return done(err);</td></tr><tr><td class="line">1442</td><td class="hits"></td><td class="source">        //         if(!notebook) return done(&quot;No demo notebooks found&quot;);</td></tr><tr><td class="line">1443</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1444</td><td class="hits"></td><td class="source">        //         notebook.inviteUser({</td></tr><tr><td class="line">1445</td><td class="hits"></td><td class="source">        //             name: user.name,</td></tr><tr><td class="line">1446</td><td class="hits"></td><td class="source">        //             email: user.email,</td></tr><tr><td class="line">1447</td><td class="hits"></td><td class="source">        //             role: &quot;viewer&quot;</td></tr><tr><td class="line">1448</td><td class="hits"></td><td class="source">        //         }, function(err, invitedUser){</td></tr><tr><td class="line">1449</td><td class="hits"></td><td class="source">        //             notebook.save(done);</td></tr><tr><td class="line">1450</td><td class="hits"></td><td class="source">        //         });</td></tr><tr><td class="line">1451</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">1452</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1453</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1454</td><td class="hits">1</td><td class="source">    var _createDemoUser = function(req, res, next) {</td></tr><tr><td class="line">1455</td><td class="hits"></td><td class="source">        // UserWaiting.Model</td></tr><tr><td class="line">1456</td><td class="hits"></td><td class="source">        //     .findOne({</td></tr><tr><td class="line">1457</td><td class="hits"></td><td class="source">        //         _id: req.params.id</td></tr><tr><td class="line">1458</td><td class="hits"></td><td class="source">        //     }, function(err, wuser){</td></tr><tr><td class="line">1459</td><td class="hits"></td><td class="source">        //         if(err) return next(err);</td></tr><tr><td class="line">1460</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1461</td><td class="hits"></td><td class="source">        //         if(!wuser) return next(new restify.ResourceNotFoundError(&quot;Could not find the waiting user.&quot;));</td></tr><tr><td class="line">1462</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1463</td><td class="hits"></td><td class="source">        //         User.findOrInvite({</td></tr><tr><td class="line">1464</td><td class="hits"></td><td class="source">        //             email: wuser.email,</td></tr><tr><td class="line">1465</td><td class="hits"></td><td class="source">        //             name: &quot;Unknown&quot;,</td></tr><tr><td class="line">1466</td><td class="hits"></td><td class="source">        //             role: &quot;general&quot;</td></tr><tr><td class="line">1467</td><td class="hits"></td><td class="source">        //         }, function(err, saved, isNew){</td></tr><tr><td class="line">1468</td><td class="hits"></td><td class="source">        //             if(err &amp;&amp; err.errors) {</td></tr><tr><td class="line">1469</td><td class="hits"></td><td class="source">        //                 return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">1470</td><td class="hits"></td><td class="source">        //             }</td></tr><tr><td class="line">1471</td><td class="hits"></td><td class="source">        //             else if(err) return next(err);</td></tr><tr><td class="line">1472</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1473</td><td class="hits"></td><td class="source">        //             if(isNew) {</td></tr><tr><td class="line">1474</td><td class="hits"></td><td class="source">        //                 // console.log(&quot;user is new %j&quot;, saved);</td></tr><tr><td class="line">1475</td><td class="hits"></td><td class="source">        //                 _addDemoUserToNotebook(saved, function(err){</td></tr><tr><td class="line">1476</td><td class="hits"></td><td class="source">        //                     if(err) return console.log(&quot;Error adding user to demo notebook&quot;, err.stack || err);</td></tr><tr><td class="line">1477</td><td class="hits"></td><td class="source">        //                     wuser.tag = &quot;dunkindemo&quot;;</td></tr><tr><td class="line">1478</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1479</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1480</td><td class="hits"></td><td class="source">        //                     _offerTrial(saved, wuser, function(err, user, wuser){</td></tr><tr><td class="line">1481</td><td class="hits"></td><td class="source">        //                         if(err) return console.log(&quot;Error updating offering trial vars&quot;, err.stack || err);</td></tr><tr><td class="line">1482</td><td class="hits"></td><td class="source">        //                         wuser.save();</td></tr><tr><td class="line">1483</td><td class="hits"></td><td class="source">        //                     });</td></tr><tr><td class="line">1484</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1485</td><td class="hits"></td><td class="source">        //                 });</td></tr><tr><td class="line">1486</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1487</td><td class="hits"></td><td class="source">        //             }</td></tr><tr><td class="line">1488</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1489</td><td class="hits"></td><td class="source">        //             saved = User.prepareForOutput(saved);</td></tr><tr><td class="line">1490</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1491</td><td class="hits"></td><td class="source">        //             return res.send(saved);</td></tr><tr><td class="line">1492</td><td class="hits"></td><td class="source">        //         });</td></tr><tr><td class="line">1493</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">1494</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1495</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1496</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1497</td><td class="hits">1</td><td class="source">    var _createFreeNotebook = function(user, done) {</td></tr><tr><td class="line">1498</td><td class="hits"></td><td class="source">        // var nb = new Notebook.Model({</td></tr><tr><td class="line">1499</td><td class="hits"></td><td class="source">        //     name: &quot;Free Notebook&quot;,</td></tr><tr><td class="line">1500</td><td class="hits"></td><td class="source">        //     type: &quot;free&quot;</td></tr><tr><td class="line">1501</td><td class="hits"></td><td class="source">        // });</td></tr><tr><td class="line">1502</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1503</td><td class="hits"></td><td class="source">        // nb.users.push({</td></tr><tr><td class="line">1504</td><td class="hits"></td><td class="source">        //     user: user._id,</td></tr><tr><td class="line">1505</td><td class="hits"></td><td class="source">        //     role: &quot;owner&quot;</td></tr><tr><td class="line">1506</td><td class="hits"></td><td class="source">        // });</td></tr><tr><td class="line">1507</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1508</td><td class="hits"></td><td class="source">        // nb.save(done);</td></tr><tr><td class="line">1509</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1510</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1511</td><td class="hits">1</td><td class="source">    var _createFreeUser = function(req, res, next) {</td></tr><tr><td class="line">1512</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1513</td><td class="hits"></td><td class="source">        // UserWaiting.Model</td></tr><tr><td class="line">1514</td><td class="hits"></td><td class="source">        //     .findOne({</td></tr><tr><td class="line">1515</td><td class="hits"></td><td class="source">        //         email: req.params.email</td></tr><tr><td class="line">1516</td><td class="hits"></td><td class="source">        //     }, function(err, wuser){</td></tr><tr><td class="line">1517</td><td class="hits"></td><td class="source">        //         if(err) return next(err);</td></tr><tr><td class="line">1518</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1519</td><td class="hits"></td><td class="source">        //         if(!wuser) {</td></tr><tr><td class="line">1520</td><td class="hits"></td><td class="source">        //             wuser = new UserWaiting.Model({</td></tr><tr><td class="line">1521</td><td class="hits"></td><td class="source">        //                 email: req.params.email,</td></tr><tr><td class="line">1522</td><td class="hits"></td><td class="source">        //                 tags: [&quot;free&quot;]</td></tr><tr><td class="line">1523</td><td class="hits"></td><td class="source">        //             });</td></tr><tr><td class="line">1524</td><td class="hits"></td><td class="source">        //             wuser.save();</td></tr><tr><td class="line">1525</td><td class="hits"></td><td class="source">        //         }</td></tr><tr><td class="line">1526</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1527</td><td class="hits"></td><td class="source">        //         User.findOrInvite({</td></tr><tr><td class="line">1528</td><td class="hits"></td><td class="source">        //             email: wuser.email,</td></tr><tr><td class="line">1529</td><td class="hits"></td><td class="source">        //             name: &quot;Unknown&quot;,</td></tr><tr><td class="line">1530</td><td class="hits"></td><td class="source">        //             role: &quot;general&quot;</td></tr><tr><td class="line">1531</td><td class="hits"></td><td class="source">        //         }, function(err, saved, isNew){</td></tr><tr><td class="line">1532</td><td class="hits"></td><td class="source">        //             if(err &amp;&amp; err.errors) {</td></tr><tr><td class="line">1533</td><td class="hits"></td><td class="source">        //                 return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">1534</td><td class="hits"></td><td class="source">        //             }</td></tr><tr><td class="line">1535</td><td class="hits"></td><td class="source">        //             else if(err) return next(err);</td></tr><tr><td class="line">1536</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1537</td><td class="hits"></td><td class="source">        //             if(isNew) {</td></tr><tr><td class="line">1538</td><td class="hits"></td><td class="source">        //                 return _createFreeNotebook(saved, function(err){</td></tr><tr><td class="line">1539</td><td class="hits"></td><td class="source">        //                     if(err &amp;&amp; err.errors) {</td></tr><tr><td class="line">1540</td><td class="hits"></td><td class="source">        //                         return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">1541</td><td class="hits"></td><td class="source">        //                     }</td></tr><tr><td class="line">1542</td><td class="hits"></td><td class="source">        //                     else if(err) return next(err);</td></tr><tr><td class="line">1543</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1544</td><td class="hits"></td><td class="source">        //                     saved = User.prepareForOutput(saved);</td></tr><tr><td class="line">1545</td><td class="hits"></td><td class="source">        //                     return res.send(saved);</td></tr><tr><td class="line">1546</td><td class="hits"></td><td class="source">        //                 });</td></tr><tr><td class="line">1547</td><td class="hits"></td><td class="source">        //             }</td></tr><tr><td class="line">1548</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1549</td><td class="hits"></td><td class="source">        //             saved = User.prepareForOutput(saved);</td></tr><tr><td class="line">1550</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1551</td><td class="hits"></td><td class="source">        //             return res.send(saved);</td></tr><tr><td class="line">1552</td><td class="hits"></td><td class="source">        //         });</td></tr><tr><td class="line">1553</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">1554</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1555</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1556</td><td class="hits">1</td><td class="source">    var _offerTrial = function(user, wuser, next) {</td></tr><tr><td class="line">1557</td><td class="hits"></td><td class="source">        // var</td></tr><tr><td class="line">1558</td><td class="hits"></td><td class="source">        //     demoCount = -1,</td></tr><tr><td class="line">1559</td><td class="hits"></td><td class="source">        //     trialCount = -1,</td></tr><tr><td class="line">1560</td><td class="hits"></td><td class="source">        //     emit = function(err){</td></tr><tr><td class="line">1561</td><td class="hits"></td><td class="source">        //         if(err) return next(err);</td></tr><tr><td class="line">1562</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1563</td><td class="hits"></td><td class="source">        //         if(demoCount &lt; 0 || trialCount &lt; 0 ) return;</td></tr><tr><td class="line">1564</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1565</td><td class="hits"></td><td class="source">        //         demoCount -= trialCount;</td></tr><tr><td class="line">1566</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1567</td><td class="hits"></td><td class="source">        //         // console.log(&quot;demoCount&quot;, demoCount, &quot;vs&quot;, &quot;trialCount&quot;, trialCount);</td></tr><tr><td class="line">1568</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1569</td><td class="hits"></td><td class="source">        //         if(demoCount &gt; trialCount) {</td></tr><tr><td class="line">1570</td><td class="hits"></td><td class="source">        //             //offer a trial yo</td></tr><tr><td class="line">1571</td><td class="hits"></td><td class="source">        //             user.trialOffer = true;</td></tr><tr><td class="line">1572</td><td class="hits"></td><td class="source">        //             wuser.tag = &quot;trial-offered&quot;;</td></tr><tr><td class="line">1573</td><td class="hits"></td><td class="source">        //             return User.Model.findByIdAndUpdate(user._id, { $set: {trialOffer: true } }, function(err, saved){</td></tr><tr><td class="line">1574</td><td class="hits"></td><td class="source">        //                 return next(err, saved, wuser);</td></tr><tr><td class="line">1575</td><td class="hits"></td><td class="source">        //             });</td></tr><tr><td class="line">1576</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1577</td><td class="hits"></td><td class="source">        //         }</td></tr><tr><td class="line">1578</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1579</td><td class="hits"></td><td class="source">        //         return next(err, user, wuser);</td></tr><tr><td class="line">1580</td><td class="hits"></td><td class="source">        //     };</td></tr><tr><td class="line">1581</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1582</td><td class="hits"></td><td class="source">        // UserWaiting.Model.count({tags: &quot;dunkindemo&quot;}, function(err, count){</td></tr><tr><td class="line">1583</td><td class="hits"></td><td class="source">        //     demoCount = count;</td></tr><tr><td class="line">1584</td><td class="hits"></td><td class="source">        //     return emit(err);</td></tr><tr><td class="line">1585</td><td class="hits"></td><td class="source">        // });</td></tr><tr><td class="line">1586</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1587</td><td class="hits"></td><td class="source">        // UserWaiting.Model.count({tags: &quot;trial-offered&quot;}, function(err, count){</td></tr><tr><td class="line">1588</td><td class="hits"></td><td class="source">        //     trialCount = count;</td></tr><tr><td class="line">1589</td><td class="hits"></td><td class="source">        //     return emit(err);</td></tr><tr><td class="line">1590</td><td class="hits"></td><td class="source">        // });</td></tr><tr><td class="line">1591</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1592</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1593</td><td class="hits">1</td><td class="source">    var _startATrial = function(req, res, next) {</td></tr><tr><td class="line">1594</td><td class="hits"></td><td class="source">        /*</td></tr><tr><td class="line">1595</td><td class="hits"></td><td class="source">            TODO:</td></tr><tr><td class="line">1596</td><td class="hits"></td><td class="source">                * Check if the user owns a notebook</td></tr><tr><td class="line">1597</td><td class="hits"></td><td class="source">                * If so, do nothing / redirect</td></tr><tr><td class="line">1598</td><td class="hits"></td><td class="source">                * If not, then create a new trial notebook</td></tr><tr><td class="line">1599</td><td class="hits"></td><td class="source">                * Tag them as trial-offered and trial</td></tr><tr><td class="line">1600</td><td class="hits"></td><td class="source">                * Set trialOffer to false</td></tr><tr><td class="line">1601</td><td class="hits"></td><td class="source">                * Redirect to trial notebook</td></tr><tr><td class="line">1602</td><td class="hits"></td><td class="source">         */</td></tr><tr><td class="line">1603</td><td class="hits"></td><td class="source">        // var user = req.user;</td></tr><tr><td class="line">1604</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1605</td><td class="hits"></td><td class="source">        // Notebook.ownedNotebooks(req.user, function(err, count){</td></tr><tr><td class="line">1606</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1607</td><td class="hits"></td><td class="source">        //     if(err) return next(err);</td></tr><tr><td class="line">1608</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1609</td><td class="hits"></td><td class="source">        //     if(count &gt; 0) return res.send(new restifyErrors.InvalidInputError(&quot;You already have a notebook.&quot;));</td></tr><tr><td class="line">1610</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1611</td><td class="hits"></td><td class="source">        //     var notebook = new Notebook.Model({</td></tr><tr><td class="line">1612</td><td class="hits"></td><td class="source">        //         name: user.name + &quot;'s Trial Notebook&quot;,</td></tr><tr><td class="line">1613</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">1614</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1615</td><td class="hits"></td><td class="source">        //     notebook.users.push({</td></tr><tr><td class="line">1616</td><td class="hits"></td><td class="source">        //         user: user._id,</td></tr><tr><td class="line">1617</td><td class="hits"></td><td class="source">        //         role: &quot;owner&quot;</td></tr><tr><td class="line">1618</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">1619</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1620</td><td class="hits"></td><td class="source">        //     notebook.trialStart = new Date();</td></tr><tr><td class="line">1621</td><td class="hits"></td><td class="source">        //     notebook.trial = settings.trial.tryit.days;</td></tr><tr><td class="line">1622</td><td class="hits"></td><td class="source">        //     notebook.type = &quot;trial&quot;;</td></tr><tr><td class="line">1623</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1624</td><td class="hits"></td><td class="source">        //     notebook.save(function(err, saved){</td></tr><tr><td class="line">1625</td><td class="hits"></td><td class="source">        //         if(err) return next(err);</td></tr><tr><td class="line">1626</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1627</td><td class="hits"></td><td class="source">        //         return res.send(saved);</td></tr><tr><td class="line">1628</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">1629</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1630</td><td class="hits"></td><td class="source">        //     UserWaiting.Model</td></tr><tr><td class="line">1631</td><td class="hits"></td><td class="source">        //         .findOne({</td></tr><tr><td class="line">1632</td><td class="hits"></td><td class="source">        //             user: user._id</td></tr><tr><td class="line">1633</td><td class="hits"></td><td class="source">        //         })</td></tr><tr><td class="line">1634</td><td class="hits"></td><td class="source">        //         .populate(&quot;user&quot;)</td></tr><tr><td class="line">1635</td><td class="hits"></td><td class="source">        //         .exec(function(err, wuser){</td></tr><tr><td class="line">1636</td><td class="hits"></td><td class="source">        //             if(err) return console.log(&quot;Error updating waiting.wuser tag 'trial' param&quot;, err.stack || err);</td></tr><tr><td class="line">1637</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1638</td><td class="hits"></td><td class="source">        //             wuser.tag = &quot;trial&quot;;</td></tr><tr><td class="line">1639</td><td class="hits"></td><td class="source">        //             wuser.tag = &quot;trial-offered&quot;;</td></tr><tr><td class="line">1640</td><td class="hits"></td><td class="source">        //             wuser.user.trialOffer = false;</td></tr><tr><td class="line">1641</td><td class="hits"></td><td class="source">        //             wuser.user.markModified(&quot;trialOffer&quot;);</td></tr><tr><td class="line">1642</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1643</td><td class="hits"></td><td class="source">        //             wuser.user.save(function(err, saved){</td></tr><tr><td class="line">1644</td><td class="hits"></td><td class="source">        //                 if(err) return console.log(&quot;Error updating user trialOffer param&quot;, err.stack || err);</td></tr><tr><td class="line">1645</td><td class="hits"></td><td class="source">        //                 next();</td></tr><tr><td class="line">1646</td><td class="hits"></td><td class="source">        //             });</td></tr><tr><td class="line">1647</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1648</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1649</td><td class="hits"></td><td class="source">        //         });</td></tr><tr><td class="line">1650</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1651</td><td class="hits"></td><td class="source">        // });</td></tr><tr><td class="line">1652</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1653</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1654</td><td class="hits">1</td><td class="source">    var _getWaitingList = function(req, res, next) {</td></tr><tr><td class="line">1655</td><td class="hits"></td><td class="source">        // if(!req.user || req.user.permissions.indexOf(&quot;view_waiting_list&quot;) &lt; 0) {</td></tr><tr><td class="line">1656</td><td class="hits"></td><td class="source">        //     return next(new restify.NotAuthorizedError(&quot;You don't have permissions to view the waiting list&quot;));</td></tr><tr><td class="line">1657</td><td class="hits"></td><td class="source">        // }</td></tr><tr><td class="line">1658</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1659</td><td class="hits"></td><td class="source">        // var</td></tr><tr><td class="line">1660</td><td class="hits"></td><td class="source">        //     sortq = req.params.sort,</td></tr><tr><td class="line">1661</td><td class="hits"></td><td class="source">        //     type = req.params.type,</td></tr><tr><td class="line">1662</td><td class="hits"></td><td class="source">        //     filter = req.params.filter,</td></tr><tr><td class="line">1663</td><td class="hits"></td><td class="source">        //     tag = req.params.tag,</td></tr><tr><td class="line">1664</td><td class="hits"></td><td class="source">        //     query = {},</td></tr><tr><td class="line">1665</td><td class="hits"></td><td class="source">        //     sort = {created: -1},</td></tr><tr><td class="line">1666</td><td class="hits"></td><td class="source">        //     onlyEnabled = false,</td></tr><tr><td class="line">1667</td><td class="hits"></td><td class="source">        //     notEnabled = false,</td></tr><tr><td class="line">1668</td><td class="hits"></td><td class="source">        //     page = parseInt(req.params.page || 0, 10) || null,</td></tr><tr><td class="line">1669</td><td class="hits"></td><td class="source">        //     per_page = parseInt(req.params.per_page || 0, 10) || null;</td></tr><tr><td class="line">1670</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1671</td><td class="hits"></td><td class="source">        // switch(sortq) {</td></tr><tr><td class="line">1672</td><td class="hits"></td><td class="source">        //     case &quot;new&quot;:</td></tr><tr><td class="line">1673</td><td class="hits"></td><td class="source">        //         sort = {created: -1};</td></tr><tr><td class="line">1674</td><td class="hits"></td><td class="source">        //     break;</td></tr><tr><td class="line">1675</td><td class="hits"></td><td class="source">        //     case &quot;old&quot;:</td></tr><tr><td class="line">1676</td><td class="hits"></td><td class="source">        //         sort = {created: 1};</td></tr><tr><td class="line">1677</td><td class="hits"></td><td class="source">        //     break;</td></tr><tr><td class="line">1678</td><td class="hits"></td><td class="source">        //     case &quot;referrals&quot;:</td></tr><tr><td class="line">1679</td><td class="hits"></td><td class="source">        //         sort = { referralCount: -1};</td></tr><tr><td class="line">1680</td><td class="hits"></td><td class="source">        //     break;</td></tr><tr><td class="line">1681</td><td class="hits"></td><td class="source">        // }</td></tr><tr><td class="line">1682</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1683</td><td class="hits"></td><td class="source">        // switch(type){</td></tr><tr><td class="line">1684</td><td class="hits"></td><td class="source">        //     case &quot;invited&quot;:</td></tr><tr><td class="line">1685</td><td class="hits"></td><td class="source">        //         query.isUser = true;</td></tr><tr><td class="line">1686</td><td class="hits"></td><td class="source">        //         notEnabled = true;</td></tr><tr><td class="line">1687</td><td class="hits"></td><td class="source">        //     break;</td></tr><tr><td class="line">1688</td><td class="hits"></td><td class="source">        //     case &quot;waiting&quot;:</td></tr><tr><td class="line">1689</td><td class="hits"></td><td class="source">        //         query.$or = [];</td></tr><tr><td class="line">1690</td><td class="hits"></td><td class="source">        //         query.$or.push({isUser: false});</td></tr><tr><td class="line">1691</td><td class="hits"></td><td class="source">        //         query.$or.push({isUser: {$exists: false}});</td></tr><tr><td class="line">1692</td><td class="hits"></td><td class="source">        //         notEnabled = true;</td></tr><tr><td class="line">1693</td><td class="hits"></td><td class="source">        //     break;</td></tr><tr><td class="line">1694</td><td class="hits"></td><td class="source">        //     case &quot;has-account&quot;:</td></tr><tr><td class="line">1695</td><td class="hits"></td><td class="source">        //         query.isUser = true;</td></tr><tr><td class="line">1696</td><td class="hits"></td><td class="source">        //         onlyEnabled = true;</td></tr><tr><td class="line">1697</td><td class="hits"></td><td class="source">        //     break;</td></tr><tr><td class="line">1698</td><td class="hits"></td><td class="source">        // }</td></tr><tr><td class="line">1699</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1700</td><td class="hits"></td><td class="source">        // if(filter) query.industry = filter.toLowerCase();</td></tr><tr><td class="line">1701</td><td class="hits"></td><td class="source">        // if(tag) query.tags = tag.toLowerCase();</td></tr><tr><td class="line">1702</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1703</td><td class="hits"></td><td class="source">        // UserWaiting.Model</td></tr><tr><td class="line">1704</td><td class="hits"></td><td class="source">        //     .find(query)</td></tr><tr><td class="line">1705</td><td class="hits"></td><td class="source">        //     .sort(sort)</td></tr><tr><td class="line">1706</td><td class="hits"></td><td class="source">        //     .limit(per_page)</td></tr><tr><td class="line">1707</td><td class="hits"></td><td class="source">        //     .skip((page-1)*per_page)</td></tr><tr><td class="line">1708</td><td class="hits"></td><td class="source">        //     .populate(&quot;refBy&quot;, &quot;email&quot;)</td></tr><tr><td class="line">1709</td><td class="hits"></td><td class="source">        //     .populate(&quot;user&quot;, &quot;enabled name&quot;)</td></tr><tr><td class="line">1710</td><td class="hits"></td><td class="source">        //     .lean()</td></tr><tr><td class="line">1711</td><td class="hits"></td><td class="source">        //     .exec(function(err, waiting){</td></tr><tr><td class="line">1712</td><td class="hits"></td><td class="source">        //         if(err) return next(err);</td></tr><tr><td class="line">1713</td><td class="hits"></td><td class="source">        //         var waiting_result = [];</td></tr><tr><td class="line">1714</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1715</td><td class="hits"></td><td class="source">        //         if(onlyEnabled) {</td></tr><tr><td class="line">1716</td><td class="hits"></td><td class="source">        //             for(var i in waiting) {</td></tr><tr><td class="line">1717</td><td class="hits"></td><td class="source">        //                 if(waiting[i].user &amp;&amp; waiting[i].user.enabled) waiting_result.push(waiting[i]);</td></tr><tr><td class="line">1718</td><td class="hits"></td><td class="source">        //             }</td></tr><tr><td class="line">1719</td><td class="hits"></td><td class="source">        //         } else if(notEnabled) {</td></tr><tr><td class="line">1720</td><td class="hits"></td><td class="source">        //             for(var j in waiting) {</td></tr><tr><td class="line">1721</td><td class="hits"></td><td class="source">        //                 if(!waiting[j].user || !waiting[j].user.enabled) waiting_result.push(waiting[j]);</td></tr><tr><td class="line">1722</td><td class="hits"></td><td class="source">        //             }</td></tr><tr><td class="line">1723</td><td class="hits"></td><td class="source">        //         }</td></tr><tr><td class="line">1724</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1725</td><td class="hits"></td><td class="source">        //         if(waiting_result.length &lt;= 0) waiting_result = waiting;</td></tr><tr><td class="line">1726</td><td class="hits"></td><td class="source">        //         return res.send(waiting_result);</td></tr><tr><td class="line">1727</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">1728</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1729</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1730</td><td class="hits">1</td><td class="source">    var _getWaitingListUser = function(req, res, next) {</td></tr><tr class="miss"><td class="line">1731</td><td class="hits">0</td><td class="source">        if(req.user.permissions.indexOf(&quot;manage_account&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">1732</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permissions to get this user's information&quot;));</td></tr><tr><td class="line">1733</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">1734</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1735</td><td class="hits">0</td><td class="source">        var fields = &quot;referrals refBy&quot;;</td></tr><tr><td class="line">1736</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1737</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1738</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">1739</td><td class="hits"></td><td class="source">            id = req.params.user_id;</td></tr><tr><td class="line">1740</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1741</td><td class="hits">0</td><td class="source">        UserWaiting.Model</td></tr><tr><td class="line">1742</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">1743</td><td class="hits"></td><td class="source">                user: id</td></tr><tr><td class="line">1744</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">1745</td><td class="hits"></td><td class="source">            .populate(fields)</td></tr><tr><td class="line">1746</td><td class="hits"></td><td class="source">            .exec(function(err, waiting){</td></tr><tr class="miss"><td class="line">1747</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">1748</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1749</td><td class="hits">0</td><td class="source">                if(!waiting){</td></tr><tr class="miss"><td class="line">1750</td><td class="hits">0</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;User not found&quot;));</td></tr><tr><td class="line">1751</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">1752</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1753</td><td class="hits">0</td><td class="source">                if(req.user.permissions.indexOf(&quot;edit_accounts&quot;) &gt;= 0) return res.send(waiting);</td></tr><tr><td class="line">1754</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1755</td><td class="hits">0</td><td class="source">                var data = {</td></tr><tr><td class="line">1756</td><td class="hits"></td><td class="source">                    referralCount: waiting.referralCount,</td></tr><tr><td class="line">1757</td><td class="hits"></td><td class="source">                    ref: waiting.ref,</td></tr><tr><td class="line">1758</td><td class="hits"></td><td class="source">                    referrals: waiting.referrals,</td></tr><tr><td class="line">1759</td><td class="hits"></td><td class="source">                    refBy: waiting.refBy</td></tr><tr><td class="line">1760</td><td class="hits"></td><td class="source">                };</td></tr><tr class="miss"><td class="line">1761</td><td class="hits">0</td><td class="source">                res.send(data);</td></tr><tr><td class="line">1762</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1763</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1764</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1765</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1766</td><td class="hits">1</td><td class="source">    var _getLead = function(req, res, next){</td></tr><tr><td class="line">1767</td><td class="hits"></td><td class="source">        // if(req.user.permissions.indexOf(&quot;edit_accounts&quot;) &lt; 0) {</td></tr><tr><td class="line">1768</td><td class="hits"></td><td class="source">        //     return next(new restify.NotAuthorizedError(&quot;You don't have permissions to get this user's information&quot;));</td></tr><tr><td class="line">1769</td><td class="hits"></td><td class="source">        // }</td></tr><tr><td class="line">1770</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1771</td><td class="hits"></td><td class="source">        // var fields = &quot;referrals refBy&quot;;</td></tr><tr><td class="line">1772</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1773</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1774</td><td class="hits"></td><td class="source">        // var</td></tr><tr><td class="line">1775</td><td class="hits"></td><td class="source">        //     id = req.params.id;</td></tr><tr><td class="line">1776</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1777</td><td class="hits"></td><td class="source">        // UserWaiting.Model</td></tr><tr><td class="line">1778</td><td class="hits"></td><td class="source">        //     .findOne({</td></tr><tr><td class="line">1779</td><td class="hits"></td><td class="source">        //         _id: id</td></tr><tr><td class="line">1780</td><td class="hits"></td><td class="source">        //     })</td></tr><tr><td class="line">1781</td><td class="hits"></td><td class="source">        //     .populate(fields)</td></tr><tr><td class="line">1782</td><td class="hits"></td><td class="source">        //     .exec(function(err, waiting){</td></tr><tr><td class="line">1783</td><td class="hits"></td><td class="source">        //         if(err) return next(err);</td></tr><tr><td class="line">1784</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1785</td><td class="hits"></td><td class="source">        //         if(!waiting){</td></tr><tr><td class="line">1786</td><td class="hits"></td><td class="source">        //             return next(new restify.ResourceNotFoundError(&quot;User not found&quot;));</td></tr><tr><td class="line">1787</td><td class="hits"></td><td class="source">        //         }</td></tr><tr><td class="line">1788</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1789</td><td class="hits"></td><td class="source">        //         if(req.user.permissions.indexOf(&quot;edit_accounts&quot;) &gt;= 0) return res.send(waiting);</td></tr><tr><td class="line">1790</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">1791</td><td class="hits"></td><td class="source">        //         var data = {</td></tr><tr><td class="line">1792</td><td class="hits"></td><td class="source">        //             referralCount: waiting.referralCount,</td></tr><tr><td class="line">1793</td><td class="hits"></td><td class="source">        //             ref: waiting.ref,</td></tr><tr><td class="line">1794</td><td class="hits"></td><td class="source">        //             referrals: waiting.referrals,</td></tr><tr><td class="line">1795</td><td class="hits"></td><td class="source">        //             refBy: waiting.refBy</td></tr><tr><td class="line">1796</td><td class="hits"></td><td class="source">        //         };</td></tr><tr><td class="line">1797</td><td class="hits"></td><td class="source">        //         res.send(data);</td></tr><tr><td class="line">1798</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">1799</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1800</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1801</td><td class="hits">1</td><td class="source">    var _addWaitingListTag = function(req, res, next) {</td></tr><tr class="miss"><td class="line">1802</td><td class="hits">0</td><td class="source">        if(!req.user || req.user.permissions.indexOf(&quot;edit_waiting_list&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">1803</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permissions to edit the waiting list&quot;));</td></tr><tr><td class="line">1804</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">1805</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1806</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">1807</td><td class="hits"></td><td class="source">            tag = req.params.tag,</td></tr><tr><td class="line">1808</td><td class="hits"></td><td class="source">            id = req.params.id;</td></tr><tr><td class="line">1809</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1810</td><td class="hits">0</td><td class="source">        if(req.params.tag) req.params.tag = req.params.tag.toLowerCase();</td></tr><tr><td class="line">1811</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1812</td><td class="hits">0</td><td class="source">        UserWaiting.Model</td></tr><tr><td class="line">1813</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">1814</td><td class="hits"></td><td class="source">                _id: id</td></tr><tr><td class="line">1815</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">1816</td><td class="hits"></td><td class="source">            .exec(function(err, waiting){</td></tr><tr class="miss"><td class="line">1817</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">1818</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1819</td><td class="hits">0</td><td class="source">                if(!waiting){</td></tr><tr class="miss"><td class="line">1820</td><td class="hits">0</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;User not found&quot;));</td></tr><tr><td class="line">1821</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">1822</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1823</td><td class="hits">0</td><td class="source">                waiting.setAll(req.params);</td></tr><tr><td class="line">1824</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1825</td><td class="hits">0</td><td class="source">                waiting.save(function(err, saved){</td></tr><tr class="miss"><td class="line">1826</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">1827</td><td class="hits"></td><td class="source">                    // console.log(&quot;waiting user %j&quot;, saved);</td></tr><tr class="miss"><td class="line">1828</td><td class="hits">0</td><td class="source">                    tag = req.params.tag;</td></tr><tr class="miss"><td class="line">1829</td><td class="hits">0</td><td class="source">                    tag = tag.trim().replace(/ /g, &quot;-&quot;);</td></tr><tr class="miss"><td class="line">1830</td><td class="hits">0</td><td class="source">                    res.send(saved);</td></tr><tr><td class="line">1831</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">1832</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1833</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1834</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1835</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1836</td><td class="hits">1</td><td class="source">    var _addWaitingListInviteTag = function(req, res, next) {</td></tr><tr class="hit"><td class="line">1837</td><td class="hits">1</td><td class="source">        var</td></tr><tr><td class="line">1838</td><td class="hits"></td><td class="source">            tag = req.params.tag;</td></tr><tr><td class="line">1839</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1840</td><td class="hits">1</td><td class="source">        User.Model</td></tr><tr><td class="line">1841</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">1842</td><td class="hits"></td><td class="source">                invite: req.params.id</td></tr><tr><td class="line">1843</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">1844</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">1845</td><td class="hits"></td><td class="source">            .exec(function(err, user){</td></tr><tr><td class="line">1846</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1847</td><td class="hits">1</td><td class="source">                if(err) return next(err);</td></tr><tr class="hit"><td class="line">1848</td><td class="hits">1</td><td class="source">                if(!user) return res.send(new restify.ResourceNotFoundError(&quot;User does not exist.&quot;));</td></tr><tr><td class="line">1849</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1850</td><td class="hits">1</td><td class="source">                UserWaiting.Model</td></tr><tr><td class="line">1851</td><td class="hits"></td><td class="source">                    .findOne({</td></tr><tr><td class="line">1852</td><td class="hits"></td><td class="source">                        user: user._id</td></tr><tr><td class="line">1853</td><td class="hits"></td><td class="source">                    })</td></tr><tr><td class="line">1854</td><td class="hits"></td><td class="source">                    .exec(function(err, wuser){</td></tr><tr class="hit"><td class="line">1855</td><td class="hits">1</td><td class="source">                        if(err) return next(err);</td></tr><tr class="hit"><td class="line">1856</td><td class="hits">1</td><td class="source">                        if(!wuser) return res.send(new restify.ResourceNotFoundError(&quot;User does not exist.&quot;));</td></tr><tr><td class="line">1857</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1858</td><td class="hits">1</td><td class="source">                        wuser.tag = tag;</td></tr><tr><td class="line">1859</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1860</td><td class="hits">1</td><td class="source">                        wuser.save(function(err, saved){</td></tr><tr class="hit"><td class="line">1861</td><td class="hits">1</td><td class="source">                            if(err) return next(err);</td></tr><tr><td class="line">1862</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1863</td><td class="hits">1</td><td class="source">                            tag = tag.trim().replace(/ /g, &quot;-&quot;);</td></tr><tr><td class="line">1864</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1865</td><td class="hits">1</td><td class="source">                            return res.send({</td></tr><tr><td class="line">1866</td><td class="hits"></td><td class="source">                                message: &quot;success&quot;,</td></tr><tr><td class="line">1867</td><td class="hits"></td><td class="source">                                tags: saved.tags</td></tr><tr><td class="line">1868</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">1869</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">1870</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">1871</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1872</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1873</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1874</td><td class="hits">1</td><td class="source">    var _removeWaitingListTag = function(req, res, next) {</td></tr><tr class="miss"><td class="line">1875</td><td class="hits">0</td><td class="source">        if(!req.user || req.user.permissions.indexOf(&quot;edit_waiting_list&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">1876</td><td class="hits">0</td><td class="source">            return next(new restify.NotAuthorizedError(&quot;You don't have permissions to edit the waiting list&quot;));</td></tr><tr><td class="line">1877</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">1878</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1879</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">1880</td><td class="hits"></td><td class="source">            tag = req.params.tag,</td></tr><tr><td class="line">1881</td><td class="hits"></td><td class="source">            id = req.params.id;</td></tr><tr><td class="line">1882</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1883</td><td class="hits">0</td><td class="source">        if(tag) tag = tag.toLowerCase();</td></tr><tr><td class="line">1884</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1885</td><td class="hits">0</td><td class="source">        UserWaiting.Model</td></tr><tr><td class="line">1886</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">1887</td><td class="hits"></td><td class="source">                _id: id</td></tr><tr><td class="line">1888</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">1889</td><td class="hits"></td><td class="source">            .exec(function(err, waiting){</td></tr><tr class="miss"><td class="line">1890</td><td class="hits">0</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">1891</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1892</td><td class="hits">0</td><td class="source">                if(!waiting){</td></tr><tr class="miss"><td class="line">1893</td><td class="hits">0</td><td class="source">                    return next(new restify.ResourceNotFoundError(&quot;User not found&quot;));</td></tr><tr><td class="line">1894</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">1895</td><td class="hits"></td><td class="source">                // console.log(&quot;tags element before removing %j, tag to remove %s&quot;, waiting.tags, tag);</td></tr><tr class="miss"><td class="line">1896</td><td class="hits">0</td><td class="source">                waiting.tags = ArrayUtils.removeElement(waiting.tags, tag);</td></tr><tr class="miss"><td class="line">1897</td><td class="hits">0</td><td class="source">                waiting.markModified(&quot;tags&quot;);</td></tr><tr><td class="line">1898</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1899</td><td class="hits">0</td><td class="source">                waiting.save(function(err, saved){</td></tr><tr class="miss"><td class="line">1900</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr class="miss"><td class="line">1901</td><td class="hits">0</td><td class="source">                    res.send(saved);</td></tr><tr><td class="line">1902</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">1903</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1904</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1905</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1906</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1907</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1908</td><td class="hits">1</td><td class="source">    var _resetPasswordStep1 = function(req, res, next) {</td></tr><tr class="miss"><td class="line">1909</td><td class="hits">0</td><td class="source">        var email = (req.params.username) ? req.params.username.toLowerCase() : req.params.username;</td></tr><tr><td class="line">1910</td><td class="hits"></td><td class="source">        //We need to look up email, if it exists then we need to generate a token and send it via email</td></tr><tr class="miss"><td class="line">1911</td><td class="hits">0</td><td class="source">        User.Model</td></tr><tr><td class="line">1912</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">1913</td><td class="hits"></td><td class="source">                &quot;email&quot; : email</td></tr><tr><td class="line">1914</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">1915</td><td class="hits"></td><td class="source">            .exec(function (err, user) {</td></tr><tr class="miss"><td class="line">1916</td><td class="hits">0</td><td class="source">                var token = uuid.v4();</td></tr><tr class="miss"><td class="line">1917</td><td class="hits">0</td><td class="source">                if(!user) return res.send(&quot;Email sent!&quot;); //only because we don't want to create a situation where people can see which emails actually exist in the system.</td></tr><tr class="miss"><td class="line">1918</td><td class="hits">0</td><td class="source">                _saveResetToken(token, user, function(err) {</td></tr><tr class="miss"><td class="line">1919</td><td class="hits">0</td><td class="source">                    _sendResetEmail({</td></tr><tr><td class="line">1920</td><td class="hits"></td><td class="source">                        email: user.email,</td></tr><tr><td class="line">1921</td><td class="hits"></td><td class="source">                        firstName: user.firstName,</td></tr><tr><td class="line">1922</td><td class="hits"></td><td class="source">                        token: token</td></tr><tr><td class="line">1923</td><td class="hits"></td><td class="source">                    }, function(err, saved){</td></tr><tr class="miss"><td class="line">1924</td><td class="hits">0</td><td class="source">                        if(err) console.log(&quot;Error sending password reset email:&quot;, err, err.stack);</td></tr><tr class="miss"><td class="line">1925</td><td class="hits">0</td><td class="source">                        return res.send(&quot;Email sent!&quot;);</td></tr><tr><td class="line">1926</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">1927</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">1928</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">1929</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1930</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1931</td><td class="hits">1</td><td class="source">    var _sendResetEmail = function(data, done){</td></tr><tr><td class="line">1932</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1933</td><td class="hits">0</td><td class="source">        var email = new Email.Model({</td></tr><tr><td class="line">1934</td><td class="hits"></td><td class="source">            to: data.email,</td></tr><tr><td class="line">1935</td><td class="hits"></td><td class="source">            from: settings.email.from,</td></tr><tr><td class="line">1936</td><td class="hits"></td><td class="source">            subject: &quot;Password reset for Primeloop Account&quot;</td></tr><tr><td class="line">1937</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">1938</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1939</td><td class="hits">0</td><td class="source">        email.renderTemplate(data, &quot;password_reset.mu&quot;, &quot;text&quot;, function(err, html){</td></tr><tr class="miss"><td class="line">1940</td><td class="hits">0</td><td class="source">            console.log(&quot;Email sent to:&quot;, data.email);</td></tr><tr class="miss"><td class="line">1941</td><td class="hits">0</td><td class="source">            email.send(done);</td></tr><tr><td class="line">1942</td><td class="hits"></td><td class="source">        } );</td></tr><tr><td class="line">1943</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">1944</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1945</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1946</td><td class="hits">1</td><td class="source">    var _saveResetToken = function(token, user, done) {</td></tr><tr class="miss"><td class="line">1947</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">1948</td><td class="hits"></td><td class="source">            id = &quot;reset:&quot; + token,</td></tr><tr><td class="line">1949</td><td class="hits"></td><td class="source">            maxAge = 60*60*1000*24;</td></tr><tr><td class="line">1950</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1951</td><td class="hits">0</td><td class="source">        user = JSON.stringify(user);</td></tr><tr><td class="line">1952</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1953</td><td class="hits">0</td><td class="source">        rclient.setex(id, maxAge, user, function(err){</td></tr><tr class="miss"><td class="line">1954</td><td class="hits">0</td><td class="source">            return done &amp;&amp; done.apply(this, arguments);</td></tr><tr><td class="line">1955</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">1956</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1957</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1958</td><td class="hits">1</td><td class="source">    var _getResetTokenData = function(token, done) {</td></tr><tr class="miss"><td class="line">1959</td><td class="hits">0</td><td class="source">        var id = &quot;reset:&quot; + token;</td></tr><tr><td class="line">1960</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1961</td><td class="hits">0</td><td class="source">        rclient.get(id, function(err, data){</td></tr><tr class="miss"><td class="line">1962</td><td class="hits">0</td><td class="source">            if (err || !data) return done(err);</td></tr><tr class="miss"><td class="line">1963</td><td class="hits">0</td><td class="source">            return JSONUtils.safeParse(data, done);</td></tr><tr><td class="line">1964</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">1965</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1966</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1967</td><td class="hits">1</td><td class="source">    var _deleteResetTokenData = function(token, done) {</td></tr><tr class="miss"><td class="line">1968</td><td class="hits">0</td><td class="source">        var id = &quot;reset:&quot; + token;</td></tr><tr><td class="line">1969</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1970</td><td class="hits">0</td><td class="source">        rclient.del(id, function(err, data) {</td></tr><tr class="miss"><td class="line">1971</td><td class="hits">0</td><td class="source">            if(err || !data) return done(err);</td></tr><tr class="miss"><td class="line">1972</td><td class="hits">0</td><td class="source">            return done();</td></tr><tr><td class="line">1973</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">1974</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1975</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1976</td><td class="hits">1</td><td class="source">    var _validateEmailToken = function(req, res, next) {</td></tr><tr class="miss"><td class="line">1977</td><td class="hits">0</td><td class="source">        var token = req.params.token;</td></tr><tr class="miss"><td class="line">1978</td><td class="hits">0</td><td class="source">        _getResetTokenData(token, function(err, data) {</td></tr><tr class="miss"><td class="line">1979</td><td class="hits">0</td><td class="source">            if(!data) return res.send({error: &quot;Could not find valid reset token. It may have expired or you didn't copy all of it from your email.&quot;});</td></tr><tr class="miss"><td class="line">1980</td><td class="hits">0</td><td class="source">            return res.send({email: data.email, name: data.name});</td></tr><tr><td class="line">1981</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">1982</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">1983</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">1984</td><td class="hits">1</td><td class="source">    var _resetPasswordStep2 = function(req, res, next) {</td></tr><tr class="miss"><td class="line">1985</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">1986</td><td class="hits"></td><td class="source">            token = req.params.token,</td></tr><tr><td class="line">1987</td><td class="hits"></td><td class="source">            password = req.params.password;</td></tr><tr><td class="line">1988</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1989</td><td class="hits">0</td><td class="source">        _getResetTokenData(token, function(err, data) {</td></tr><tr class="miss"><td class="line">1990</td><td class="hits">0</td><td class="source">            var userId = data._id;</td></tr><tr class="miss"><td class="line">1991</td><td class="hits">0</td><td class="source">            User.Model</td></tr><tr><td class="line">1992</td><td class="hits"></td><td class="source">                .findOne({</td></tr><tr><td class="line">1993</td><td class="hits"></td><td class="source">                    _id: userId</td></tr><tr><td class="line">1994</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">1995</td><td class="hits"></td><td class="source">                .exec(function(err, user){</td></tr><tr class="miss"><td class="line">1996</td><td class="hits">0</td><td class="source">                    if(err) return next(err);</td></tr><tr><td class="line">1997</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">1998</td><td class="hits">0</td><td class="source">                    if(!user) {</td></tr><tr class="miss"><td class="line">1999</td><td class="hits">0</td><td class="source">                        return next(new restify.ResourceNotFoundError(&quot;User not found&quot;));</td></tr><tr><td class="line">2000</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">2001</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">2002</td><td class="hits">0</td><td class="source">                    if(!password) {</td></tr><tr class="miss"><td class="line">2003</td><td class="hits">0</td><td class="source">                        return next(new restifyErrors.InvalidInputError(&quot;Password required&quot;));</td></tr><tr><td class="line">2004</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">2005</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">2006</td><td class="hits">0</td><td class="source">                    user.password = password;</td></tr><tr><td class="line">2007</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2008</td><td class="hits"></td><td class="source">                    //need to delete token here and then save the user</td></tr><tr class="miss"><td class="line">2009</td><td class="hits">0</td><td class="source">                    _deleteResetTokenData(token, function(err) {</td></tr><tr class="miss"><td class="line">2010</td><td class="hits">0</td><td class="source">                        return saveUser();</td></tr><tr class="miss"><td class="line">2011</td><td class="hits">0</td><td class="source">                        function saveUser(){</td></tr><tr class="miss"><td class="line">2012</td><td class="hits">0</td><td class="source">                            user.save(function(err, saved){</td></tr><tr class="miss"><td class="line">2013</td><td class="hits">0</td><td class="source">                                if(err &amp;&amp; err.errors) {</td></tr><tr class="miss"><td class="line">2014</td><td class="hits">0</td><td class="source">                                    return next(new restifyErrors.InvalidInputError(err.errors));</td></tr><tr><td class="line">2015</td><td class="hits"></td><td class="source">                                }</td></tr><tr class="miss"><td class="line">2016</td><td class="hits">0</td><td class="source">                                else if(err) return next(err);</td></tr><tr><td class="line">2017</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">2018</td><td class="hits">0</td><td class="source">                                saved = User.prepareForOutput(saved);</td></tr><tr><td class="line">2019</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">2020</td><td class="hits">0</td><td class="source">                                return res.send(saved);</td></tr><tr><td class="line">2021</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">2022</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">2023</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">2024</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2025</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2026</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">2027</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">2028</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">2029</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2030</td><td class="hits">1</td><td class="source">    var _createCustomerRecord = function(user, plan, coupon, done) {</td></tr><tr class="hit"><td class="line">2031</td><td class="hits">3</td><td class="source">        Customer.createCustomer(user, plan, coupon, function(err, customer){</td></tr><tr class="hit"><td class="line">2032</td><td class="hits">3</td><td class="source">            if(err) console.log(&quot;there was an error updating customer record for %s&quot;, user.email, err);</td></tr><tr class="hit"><td class="line">2033</td><td class="hits">3</td><td class="source">            return done(err, customer);</td></tr><tr><td class="line">2034</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">2035</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">2036</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2037</td><td class="hits">1</td><td class="source">    var _inactiveList = function(req, res, next) {</td></tr><tr><td class="line">2038</td><td class="hits"></td><td class="source">        // if(req.user.permissions.indexOf(&quot;view_all_accounts&quot;) &lt; 0) {</td></tr><tr><td class="line">2039</td><td class="hits"></td><td class="source">        //     return next(new restify.NotAuthorizedError(&quot;You don't have permisison to view another user's notebooks&quot;));</td></tr><tr><td class="line">2040</td><td class="hits"></td><td class="source">        // }</td></tr><tr><td class="line">2041</td><td class="hits"></td><td class="source">        // User.Model</td></tr><tr><td class="line">2042</td><td class="hits"></td><td class="source">        //     .find({</td></tr><tr><td class="line">2043</td><td class="hits"></td><td class="source">        //         $or: [</td></tr><tr><td class="line">2044</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2045</td><td class="hits"></td><td class="source">        //             {lastAction: {$lt: new Date().getTime() - (1000*60*60*24*60)}},</td></tr><tr><td class="line">2046</td><td class="hits"></td><td class="source">        //             {lastAction: null}</td></tr><tr><td class="line">2047</td><td class="hits"></td><td class="source">        //         ]</td></tr><tr><td class="line">2048</td><td class="hits"></td><td class="source">        //     }, &quot;name email lastAction customer purchasedNotebooks&quot;)</td></tr><tr><td class="line">2049</td><td class="hits"></td><td class="source">        //     .sort('lastAction')</td></tr><tr><td class="line">2050</td><td class="hits"></td><td class="source">        //     .lean()</td></tr><tr><td class="line">2051</td><td class="hits"></td><td class="source">        //     .exec(function(err, users){</td></tr><tr><td class="line">2052</td><td class="hits"></td><td class="source">        //         if(err) return next(err);</td></tr><tr><td class="line">2053</td><td class="hits"></td><td class="source">        //         var</td></tr><tr><td class="line">2054</td><td class="hits"></td><td class="source">        //             len = users.length;</td></tr><tr><td class="line">2055</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2056</td><td class="hits"></td><td class="source">        //         //once we have all the users we need to get their owned notebooks and match them</td></tr><tr><td class="line">2057</td><td class="hits"></td><td class="source">        //         //could either loop through each, or grab all notebooks and then loop</td></tr><tr><td class="line">2058</td><td class="hits"></td><td class="source">        //         //TODO: convert this into a common function, had to do this at least once before and it's a pain in the ass</td></tr><tr><td class="line">2059</td><td class="hits"></td><td class="source">        //         async.each(users, function(user, callback){</td></tr><tr><td class="line">2060</td><td class="hits"></td><td class="source">        //             user.ownedNotebooks = [];</td></tr><tr><td class="line">2061</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2062</td><td class="hits"></td><td class="source">        //             Notebook.Model</td></tr><tr><td class="line">2063</td><td class="hits"></td><td class="source">        //                 .find({</td></tr><tr><td class="line">2064</td><td class="hits"></td><td class="source">        //                     &quot;users.user&quot;: user._id</td></tr><tr><td class="line">2065</td><td class="hits"></td><td class="source">        //                 }).exec(function(err, nbs) {</td></tr><tr><td class="line">2066</td><td class="hits"></td><td class="source">        //                     if(err) return callback(err);</td></tr><tr><td class="line">2067</td><td class="hits"></td><td class="source">        //                     for(var i in nbs) {</td></tr><tr><td class="line">2068</td><td class="hits"></td><td class="source">        //                         idx = ArrayUtils.inArray(user._id, nbs[i].users, &quot;user&quot;);</td></tr><tr><td class="line">2069</td><td class="hits"></td><td class="source">        //                         if(idx &gt;= 0 &amp;&amp; nbs[i].users[idx].role == &quot;owner&quot;){</td></tr><tr><td class="line">2070</td><td class="hits"></td><td class="source">        //                             //console.log(&quot;adding notebook to user: &quot; + user.email + &quot;: &quot; + nbs[i].name);</td></tr><tr><td class="line">2071</td><td class="hits"></td><td class="source">        //                             user.ownedNotebooks.push(nbs[i]);</td></tr><tr><td class="line">2072</td><td class="hits"></td><td class="source">        //                         }</td></tr><tr><td class="line">2073</td><td class="hits"></td><td class="source">        //                     }</td></tr><tr><td class="line">2074</td><td class="hits"></td><td class="source">        //                     if(user.customer) {</td></tr><tr><td class="line">2075</td><td class="hits"></td><td class="source">        //                         stripe.customers.retrieve(user.customer.id,function(err, customer) {</td></tr><tr><td class="line">2076</td><td class="hits"></td><td class="source">        //                             // console.log(&quot;stripe data for customer: &quot; + JSON.stringify(customer));</td></tr><tr><td class="line">2077</td><td class="hits"></td><td class="source">        //                             if (err) {</td></tr><tr><td class="line">2078</td><td class="hits"></td><td class="source">        //                                 console.log(err.message);</td></tr><tr><td class="line">2079</td><td class="hits"></td><td class="source">        //                             }</td></tr><tr><td class="line">2080</td><td class="hits"></td><td class="source">        //                             if(customer) {</td></tr><tr><td class="line">2081</td><td class="hits"></td><td class="source">        //                                 user.paid = true;</td></tr><tr><td class="line">2082</td><td class="hits"></td><td class="source">        //                                 user.delinquent = customer.delinquent;</td></tr><tr><td class="line">2083</td><td class="hits"></td><td class="source">        //                                 user.account_balance = customer.account_balance;</td></tr><tr><td class="line">2084</td><td class="hits"></td><td class="source">        //                                 user.account_start = customer.start;</td></tr><tr><td class="line">2085</td><td class="hits"></td><td class="source">        //                             } else {</td></tr><tr><td class="line">2086</td><td class="hits"></td><td class="source">        //                                 user.paid = false;</td></tr><tr><td class="line">2087</td><td class="hits"></td><td class="source">        //                             }</td></tr><tr><td class="line">2088</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2089</td><td class="hits"></td><td class="source">        //                             return callback();</td></tr><tr><td class="line">2090</td><td class="hits"></td><td class="source">        //                         });</td></tr><tr><td class="line">2091</td><td class="hits"></td><td class="source">        //                     } else {</td></tr><tr><td class="line">2092</td><td class="hits"></td><td class="source">        //                         user.paid = false;</td></tr><tr><td class="line">2093</td><td class="hits"></td><td class="source">        //                         return callback();</td></tr><tr><td class="line">2094</td><td class="hits"></td><td class="source">        //                     }</td></tr><tr><td class="line">2095</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2096</td><td class="hits"></td><td class="source">        //                 });</td></tr><tr><td class="line">2097</td><td class="hits"></td><td class="source">        //         }, function(err){</td></tr><tr><td class="line">2098</td><td class="hits"></td><td class="source">        //             if(err) return next(err);</td></tr><tr><td class="line">2099</td><td class="hits"></td><td class="source">        //             res.send(users);</td></tr><tr><td class="line">2100</td><td class="hits"></td><td class="source">        //         });</td></tr><tr><td class="line">2101</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">2102</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">2103</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2104</td><td class="hits">1</td><td class="source">    var _cancel = function(req, res, next) {</td></tr><tr><td class="line">2105</td><td class="hits"></td><td class="source">        // if(req.user.permissions.indexOf(&quot;cancel_account&quot;) &lt; 0) {</td></tr><tr><td class="line">2106</td><td class="hits"></td><td class="source">        //     return next(new restify.NotAuthorizedError(&quot;You don't have permisison to do that.&quot;));</td></tr><tr><td class="line">2107</td><td class="hits"></td><td class="source">        // }</td></tr><tr><td class="line">2108</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2109</td><td class="hits"></td><td class="source">        // var</td></tr><tr><td class="line">2110</td><td class="hits"></td><td class="source">        //     userSaved = false,</td></tr><tr><td class="line">2111</td><td class="hits"></td><td class="source">        //     notebooksToArchive = [],</td></tr><tr><td class="line">2112</td><td class="hits"></td><td class="source">        //     notebooksToArchiveTotal = 0; //non-zero</td></tr><tr><td class="line">2113</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2114</td><td class="hits"></td><td class="source">        // User.Model.findOne({</td></tr><tr><td class="line">2115</td><td class="hits"></td><td class="source">        //     _id: req.params.id</td></tr><tr><td class="line">2116</td><td class="hits"></td><td class="source">        // })</td></tr><tr><td class="line">2117</td><td class="hits"></td><td class="source">        // .exec(function(err, user){</td></tr><tr><td class="line">2118</td><td class="hits"></td><td class="source">        //     if(err) return next(err);</td></tr><tr><td class="line">2119</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2120</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2121</td><td class="hits"></td><td class="source">        //     Payment.cancelSubscription(user.customer, function(err, subscription){</td></tr><tr><td class="line">2122</td><td class="hits"></td><td class="source">        //         if(err &amp;&amp; err.message.indexOf(&quot;No active subscriptions for customer&quot;) &lt; 0) {</td></tr><tr><td class="line">2123</td><td class="hits"></td><td class="source">        //             return next(err);</td></tr><tr><td class="line">2124</td><td class="hits"></td><td class="source">        //         }</td></tr><tr><td class="line">2125</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2126</td><td class="hits"></td><td class="source">        //         if(subscription &amp;&amp; subscription.status != &quot;canceled&quot;) {</td></tr><tr><td class="line">2127</td><td class="hits"></td><td class="source">        //             return next(new restify.InvalidArgumentError(&quot;Subscription status came back as &quot; + subscription.status));</td></tr><tr><td class="line">2128</td><td class="hits"></td><td class="source">        //         }</td></tr><tr><td class="line">2129</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2130</td><td class="hits"></td><td class="source">        //         if(user.customer) user.customer.subscription = subscription;</td></tr><tr><td class="line">2131</td><td class="hits"></td><td class="source">        //         user.enabled = false;</td></tr><tr><td class="line">2132</td><td class="hits"></td><td class="source">        //         user.save(function(err, saved){</td></tr><tr><td class="line">2133</td><td class="hits"></td><td class="source">        //             if(err) console.log(err, saved);</td></tr><tr><td class="line">2134</td><td class="hits"></td><td class="source">        //         });</td></tr><tr><td class="line">2135</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2136</td><td class="hits"></td><td class="source">        //         Notebook.Model.find({</td></tr><tr><td class="line">2137</td><td class="hits"></td><td class="source">        //             &quot;users.user&quot;: user._id</td></tr><tr><td class="line">2138</td><td class="hits"></td><td class="source">        //         })</td></tr><tr><td class="line">2139</td><td class="hits"></td><td class="source">        //         .exec(function(err, notebooks){</td></tr><tr><td class="line">2140</td><td class="hits"></td><td class="source">        //             if(err) return next(err);</td></tr><tr><td class="line">2141</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2142</td><td class="hits"></td><td class="source">        //             var removeUserFromNotebookRespond = function(err, val){</td></tr><tr><td class="line">2143</td><td class="hits"></td><td class="source">        //                 if(err) console.log(err);</td></tr><tr><td class="line">2144</td><td class="hits"></td><td class="source">        //             };</td></tr><tr><td class="line">2145</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2146</td><td class="hits"></td><td class="source">        //             for(var i = 0; i &lt; notebooks.length; i++) {</td></tr><tr><td class="line">2147</td><td class="hits"></td><td class="source">        //                 for(var j = 0; j &lt; notebooks[i].users.length; j++) {</td></tr><tr><td class="line">2148</td><td class="hits"></td><td class="source">        //                     if(notebooks[i].users[j].user == user._id &amp;&amp; notebooks[i].users[j].role == &quot;owner&quot;) {</td></tr><tr><td class="line">2149</td><td class="hits"></td><td class="source">        //                         notebooksToArchive.push(notebooks[i]);</td></tr><tr><td class="line">2150</td><td class="hits"></td><td class="source">        //                         break;</td></tr><tr><td class="line">2151</td><td class="hits"></td><td class="source">        //                     } else if(notebooks[i].users[j].user == user._id) {</td></tr><tr><td class="line">2152</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2153</td><td class="hits"></td><td class="source">        //                         Notebook.Model.update({</td></tr><tr><td class="line">2154</td><td class="hits"></td><td class="source">        //                             _id: notebooks[i]._id</td></tr><tr><td class="line">2155</td><td class="hits"></td><td class="source">        //                             },{</td></tr><tr><td class="line">2156</td><td class="hits"></td><td class="source">        //                                 $pull: { &quot;users&quot;: {&quot;user&quot;: user._id} }</td></tr><tr><td class="line">2157</td><td class="hits"></td><td class="source">        //                             },</td></tr><tr><td class="line">2158</td><td class="hits"></td><td class="source">        //                             removeUserFromNotebookRespond</td></tr><tr><td class="line">2159</td><td class="hits"></td><td class="source">        //                         );</td></tr><tr><td class="line">2160</td><td class="hits"></td><td class="source">        //                         break;</td></tr><tr><td class="line">2161</td><td class="hits"></td><td class="source">        //                     }</td></tr><tr><td class="line">2162</td><td class="hits"></td><td class="source">        //                 }</td></tr><tr><td class="line">2163</td><td class="hits"></td><td class="source">        //             }</td></tr><tr><td class="line">2164</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2165</td><td class="hits"></td><td class="source">        //             notebooksToArchiveTotal = notebooksToArchive.length;</td></tr><tr><td class="line">2166</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2167</td><td class="hits"></td><td class="source">        //             var archiveFinished = function(err, result){</td></tr><tr><td class="line">2168</td><td class="hits"></td><td class="source">        //                 if(err) return next(err);</td></tr><tr><td class="line">2169</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2170</td><td class="hits"></td><td class="source">        //                 return --notebooksToArchiveTotal || respond();</td></tr><tr><td class="line">2171</td><td class="hits"></td><td class="source">        //             };</td></tr><tr><td class="line">2172</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2173</td><td class="hits"></td><td class="source">        //             for(var k = 0; k &lt; notebooksToArchive.length; k++) {</td></tr><tr><td class="line">2174</td><td class="hits"></td><td class="source">        //                 Notebook.Archive.add(notebooksToArchive[k], archiveFinished);</td></tr><tr><td class="line">2175</td><td class="hits"></td><td class="source">        //             }</td></tr><tr><td class="line">2176</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2177</td><td class="hits"></td><td class="source">        //             if(notebooksToArchiveTotal &lt;= 0) return respond();</td></tr><tr><td class="line">2178</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2179</td><td class="hits"></td><td class="source">        //         });</td></tr><tr><td class="line">2180</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2181</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">2182</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2183</td><td class="hits"></td><td class="source">        //     function respond(){</td></tr><tr><td class="line">2184</td><td class="hits"></td><td class="source">        //         res.send({</td></tr><tr><td class="line">2185</td><td class="hits"></td><td class="source">        //             status: &quot;success&quot;,</td></tr><tr><td class="line">2186</td><td class="hits"></td><td class="source">        //             message: &quot;Account canceled. &quot; + notebooksToArchive.length + &quot; notebooks archived&quot;</td></tr><tr><td class="line">2187</td><td class="hits"></td><td class="source">        //         });</td></tr><tr><td class="line">2188</td><td class="hits"></td><td class="source">        //     }</td></tr><tr><td class="line">2189</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2190</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2191</td><td class="hits"></td><td class="source">        // });</td></tr><tr><td class="line">2192</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2193</td><td class="hits"></td><td class="source">        //Get user record</td></tr><tr><td class="line">2194</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2195</td><td class="hits"></td><td class="source">            //Turn off their subscription account in stripe</td></tr><tr><td class="line">2196</td><td class="hits"></td><td class="source">                //Verify that that worked</td></tr><tr><td class="line">2197</td><td class="hits"></td><td class="source">                    //Update user record to enabled = false, canceled = true</td></tr><tr><td class="line">2198</td><td class="hits"></td><td class="source">                    //Get all notebooks and archive them via the archive utils</td></tr><tr><td class="line">2199</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2200</td><td class="hits"></td><td class="source">                        //Respond</td></tr><tr><td class="line">2201</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">2202</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2203</td><td class="hits">1</td><td class="source">    var _sales = function(req, res, next) {</td></tr><tr><td class="line">2204</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2205</td><td class="hits"></td><td class="source">        // Notebook.Model</td></tr><tr><td class="line">2206</td><td class="hits"></td><td class="source">        //     .find({</td></tr><tr><td class="line">2207</td><td class="hits"></td><td class="source">        //         &quot;users.user&quot;: req.user._id</td></tr><tr><td class="line">2208</td><td class="hits"></td><td class="source">        //     })</td></tr><tr><td class="line">2209</td><td class="hits"></td><td class="source">        //     .populate(&quot;users.user&quot;, &quot;email name&quot;)</td></tr><tr><td class="line">2210</td><td class="hits"></td><td class="source">        //     .lean()</td></tr><tr><td class="line">2211</td><td class="hits"></td><td class="source">        //     .exec(function(err, notebooks){</td></tr><tr><td class="line">2212</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2213</td><td class="hits"></td><td class="source">        //         if(err) return next(err);</td></tr><tr><td class="line">2214</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2215</td><td class="hits"></td><td class="source">        //         var idx = -1;</td></tr><tr><td class="line">2216</td><td class="hits"></td><td class="source">        //         var ownerCheck = function(user) {</td></tr><tr><td class="line">2217</td><td class="hits"></td><td class="source">        //             return user.role == &quot;owner&quot; &amp;&amp; user.user &amp;&amp; user.user._id == req.user._id;</td></tr><tr><td class="line">2218</td><td class="hits"></td><td class="source">        //         };</td></tr><tr><td class="line">2219</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2220</td><td class="hits"></td><td class="source">        //         for(var i = 0; i &lt; notebooks.length; i++) {</td></tr><tr><td class="line">2221</td><td class="hits"></td><td class="source">        //             notebooks[i].users = notebooks[i].users.filter(ownerCheck);</td></tr><tr><td class="line">2222</td><td class="hits"></td><td class="source">        //         }</td></tr><tr><td class="line">2223</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2224</td><td class="hits"></td><td class="source">        //         //List of referred users and their owned notebooks</td></tr><tr><td class="line">2225</td><td class="hits"></td><td class="source">        //         UserWaiting.Model.findOne({</td></tr><tr><td class="line">2226</td><td class="hits"></td><td class="source">        //             user: req.user._id</td></tr><tr><td class="line">2227</td><td class="hits"></td><td class="source">        //         })</td></tr><tr><td class="line">2228</td><td class="hits"></td><td class="source">        //         .populate(&quot;referrals&quot;)</td></tr><tr><td class="line">2229</td><td class="hits"></td><td class="source">        //         .lean()</td></tr><tr><td class="line">2230</td><td class="hits"></td><td class="source">        //         .exec(function(err, wuser){</td></tr><tr><td class="line">2231</td><td class="hits"></td><td class="source">        //             if(err) return next(err);</td></tr><tr><td class="line">2232</td><td class="hits"></td><td class="source">        //             var invitedUsers = ObjectUtils.toFlatArray(wuser.referrals, &quot;user&quot;);</td></tr><tr><td class="line">2233</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2234</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2235</td><td class="hits"></td><td class="source">        //             Notebook.Model.find({</td></tr><tr><td class="line">2236</td><td class="hits"></td><td class="source">        //                 &quot;users.user&quot;: {$in: invitedUsers}</td></tr><tr><td class="line">2237</td><td class="hits"></td><td class="source">        //             }, &quot;users name type&quot;)</td></tr><tr><td class="line">2238</td><td class="hits"></td><td class="source">        //             .populate(&quot;users.user&quot;)</td></tr><tr><td class="line">2239</td><td class="hits"></td><td class="source">        //             .lean()</td></tr><tr><td class="line">2240</td><td class="hits"></td><td class="source">        //             .exec(function(err, invite_notebooks){</td></tr><tr><td class="line">2241</td><td class="hits"></td><td class="source">        //                 if(err) return next(err);</td></tr><tr><td class="line">2242</td><td class="hits"></td><td class="source">        //                 var</td></tr><tr><td class="line">2243</td><td class="hits"></td><td class="source">        //                     accounts = {}, accountsArr = [],</td></tr><tr><td class="line">2244</td><td class="hits"></td><td class="source">        //                     userFilter = function(user){</td></tr><tr><td class="line">2245</td><td class="hits"></td><td class="source">        //                         if(!user || !user.user) return false;</td></tr><tr><td class="line">2246</td><td class="hits"></td><td class="source">        //                         return ArrayUtils.inArray(user.user._id, invitedUsers) &gt;= 0 &amp;&amp; user.role == &quot;owner&quot;;</td></tr><tr><td class="line">2247</td><td class="hits"></td><td class="source">        //                     };</td></tr><tr><td class="line">2248</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2249</td><td class="hits"></td><td class="source">        //                 invite_notebooks = invite_notebooks.filter(function(nb){</td></tr><tr><td class="line">2250</td><td class="hits"></td><td class="source">        //                     nb.users = nb.users.filter(userFilter);</td></tr><tr><td class="line">2251</td><td class="hits"></td><td class="source">        //                     if(nb.users.length &gt; 0) {</td></tr><tr><td class="line">2252</td><td class="hits"></td><td class="source">        //                         if(!accounts[nb.users[0].user._id]) {</td></tr><tr><td class="line">2253</td><td class="hits"></td><td class="source">        //                             accounts[nb.users[0].user._id] = {</td></tr><tr><td class="line">2254</td><td class="hits"></td><td class="source">        //                                 user: nb.users[0].user,</td></tr><tr><td class="line">2255</td><td class="hits"></td><td class="source">        //                                 notebooks: []</td></tr><tr><td class="line">2256</td><td class="hits"></td><td class="source">        //                             };</td></tr><tr><td class="line">2257</td><td class="hits"></td><td class="source">        //                         }</td></tr><tr><td class="line">2258</td><td class="hits"></td><td class="source">        //                         accounts[nb.users[0].user._id].notebooks.push(nb);</td></tr><tr><td class="line">2259</td><td class="hits"></td><td class="source">        //                         return true;</td></tr><tr><td class="line">2260</td><td class="hits"></td><td class="source">        //                     }</td></tr><tr><td class="line">2261</td><td class="hits"></td><td class="source">        //                 });</td></tr><tr><td class="line">2262</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2263</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2264</td><td class="hits"></td><td class="source">        //                 for(var a in accounts) {</td></tr><tr><td class="line">2265</td><td class="hits"></td><td class="source">        //                     accountsArr.push(accounts[a]);</td></tr><tr><td class="line">2266</td><td class="hits"></td><td class="source">        //                 }</td></tr><tr><td class="line">2267</td><td class="hits"></td><td class="source">        //                 accounts = accountsArr;</td></tr><tr><td class="line">2268</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2269</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2270</td><td class="hits"></td><td class="source">        //                 return res.send({</td></tr><tr><td class="line">2271</td><td class="hits"></td><td class="source">        //                     notebooks: notebooks,</td></tr><tr><td class="line">2272</td><td class="hits"></td><td class="source">        //                     accounts: accounts</td></tr><tr><td class="line">2273</td><td class="hits"></td><td class="source">        //                 });</td></tr><tr><td class="line">2274</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2275</td><td class="hits"></td><td class="source">        //             });</td></tr><tr><td class="line">2276</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2277</td><td class="hits"></td><td class="source">        //         });</td></tr><tr><td class="line">2278</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2279</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2280</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">2281</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2282</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2283</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">2284</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2285</td><td class="hits">1</td><td class="source">    var _activity = function(req, res, next) {</td></tr><tr><td class="line">2286</td><td class="hits"></td><td class="source">        // if(req.user.permissions.indexOf(&quot;view_all_activity&quot;) &lt; 0) {</td></tr><tr><td class="line">2287</td><td class="hits"></td><td class="source">        //     return next(new restify.NotAuthorizedError(&quot;You don't have permisison to do that.&quot;));</td></tr><tr><td class="line">2288</td><td class="hits"></td><td class="source">        // }</td></tr><tr><td class="line">2289</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2290</td><td class="hits"></td><td class="source">        // var</td></tr><tr><td class="line">2291</td><td class="hits"></td><td class="source">        //     daysAgo = req.params.ago || 30;</td></tr><tr><td class="line">2292</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2293</td><td class="hits"></td><td class="source">        // ActivityLog.Model.find({</td></tr><tr><td class="line">2294</td><td class="hits"></td><td class="source">        //     user: req.params.id,</td></tr><tr><td class="line">2295</td><td class="hits"></td><td class="source">        //     activityTime: {$gt: Date.now() - (1000*60*60*24*daysAgo)}</td></tr><tr><td class="line">2296</td><td class="hits"></td><td class="source">        // })</td></tr><tr><td class="line">2297</td><td class="hits"></td><td class="source">        // .sort({&quot;activityTime&quot;:-1})</td></tr><tr><td class="line">2298</td><td class="hits"></td><td class="source">        // .lean()</td></tr><tr><td class="line">2299</td><td class="hits"></td><td class="source">        // .exec(function(err, logs){</td></tr><tr><td class="line">2300</td><td class="hits"></td><td class="source">        //     if(err) return next(err);</td></tr><tr><td class="line">2301</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2302</td><td class="hits"></td><td class="source">        //     return res.send(logs);</td></tr><tr><td class="line">2303</td><td class="hits"></td><td class="source">        // });</td></tr><tr><td class="line">2304</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2305</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">2306</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2307</td><td class="hits">1</td><td class="source">    var _getTags = function(req, res, next) {</td></tr><tr><td class="line">2308</td><td class="hits"></td><td class="source">        // var userTags = [];</td></tr><tr><td class="line">2309</td><td class="hits"></td><td class="source">        // var userNb = [];</td></tr><tr><td class="line">2310</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2311</td><td class="hits"></td><td class="source">        // Notebook.Model</td></tr><tr><td class="line">2312</td><td class="hits"></td><td class="source">        //     .find({</td></tr><tr><td class="line">2313</td><td class="hits"></td><td class="source">        //         &quot;users.user&quot; : req.user._id</td></tr><tr><td class="line">2314</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2315</td><td class="hits"></td><td class="source">        //     }, &quot;name _id users created&quot;)</td></tr><tr><td class="line">2316</td><td class="hits"></td><td class="source">        //     .exec(function(err, notebooks){</td></tr><tr><td class="line">2317</td><td class="hits"></td><td class="source">        //         if(err) return next(err);</td></tr><tr><td class="line">2318</td><td class="hits"></td><td class="source">        //         for(var j = 0; j &lt; notebooks.length; j++) {</td></tr><tr><td class="line">2319</td><td class="hits"></td><td class="source">        //             var nb = notebooks[j];</td></tr><tr><td class="line">2320</td><td class="hits"></td><td class="source">        //             idx = ArrayUtils.inArray(req.user._id, nb.users, &quot;user&quot;);</td></tr><tr><td class="line">2321</td><td class="hits"></td><td class="source">        //             if(idx &gt;= 0 &amp;&amp; nb.users[idx].role != &quot;viewer&quot;){</td></tr><tr><td class="line">2322</td><td class="hits"></td><td class="source">        //                 userNb.push(nb);</td></tr><tr><td class="line">2323</td><td class="hits"></td><td class="source">        //             }</td></tr><tr><td class="line">2324</td><td class="hits"></td><td class="source">        //         }</td></tr><tr><td class="line">2325</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2326</td><td class="hits"></td><td class="source">        //         async.each(userNb, getTagsForNotebook, function(err) {</td></tr><tr><td class="line">2327</td><td class="hits"></td><td class="source">        //             return res.send(userTags);</td></tr><tr><td class="line">2328</td><td class="hits"></td><td class="source">        //         });</td></tr><tr><td class="line">2329</td><td class="hits"></td><td class="source">        //         function getTagsForNotebook(notebook,done){</td></tr><tr><td class="line">2330</td><td class="hits"></td><td class="source">        //             Notebook.getTagsForNotebook(notebook._id, function(err, tags){</td></tr><tr><td class="line">2331</td><td class="hits"></td><td class="source">        //                 if(err) return done(err);</td></tr><tr><td class="line">2332</td><td class="hits"></td><td class="source">        //                 if(tags.length &gt; 0) {</td></tr><tr><td class="line">2333</td><td class="hits"></td><td class="source">        //                     userTags = userTags.concat(tags);</td></tr><tr><td class="line">2334</td><td class="hits"></td><td class="source">        //                     userTags = ArrayUtils.nonEmptyElements(userTags);</td></tr><tr><td class="line">2335</td><td class="hits"></td><td class="source">        //                     userTags = ArrayUtils.uniqueArray(userTags);</td></tr><tr><td class="line">2336</td><td class="hits"></td><td class="source">        //                 }</td></tr><tr><td class="line">2337</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2338</td><td class="hits"></td><td class="source">        //                 return done();</td></tr><tr><td class="line">2339</td><td class="hits"></td><td class="source">        //             });</td></tr><tr><td class="line">2340</td><td class="hits"></td><td class="source">        //         }</td></tr><tr><td class="line">2341</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2342</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">2343</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">2344</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2345</td><td class="hits">1</td><td class="source">    var _sendNoAnalyticsEmail = function(req, res, next) {</td></tr><tr><td class="line">2346</td><td class="hits"></td><td class="source">        // var from = settings.email.from_unsolicited;</td></tr><tr><td class="line">2347</td><td class="hits"></td><td class="source">        // UserWaiting.Model.findOne({</td></tr><tr><td class="line">2348</td><td class="hits"></td><td class="source">        //     _id: req.params.id</td></tr><tr><td class="line">2349</td><td class="hits"></td><td class="source">        // })</td></tr><tr><td class="line">2350</td><td class="hits"></td><td class="source">        // .lean()</td></tr><tr><td class="line">2351</td><td class="hits"></td><td class="source">        // .exec(function(err, wuser){</td></tr><tr><td class="line">2352</td><td class="hits"></td><td class="source">        //     if(err) return next(err);</td></tr><tr><td class="line">2353</td><td class="hits"></td><td class="source">        //     var email = new Email.Model({</td></tr><tr><td class="line">2354</td><td class="hits"></td><td class="source">        //         to: wuser.email,</td></tr><tr><td class="line">2355</td><td class="hits"></td><td class="source">        //         from: from,</td></tr><tr><td class="line">2356</td><td class="hits"></td><td class="source">        //         subject: &quot;Next steps on Primeloop&quot;,</td></tr><tr><td class="line">2357</td><td class="hits"></td><td class="source">        //         template: {</td></tr><tr><td class="line">2358</td><td class="hits"></td><td class="source">        //             name: &quot;user_no_analytics_email.mu&quot;,</td></tr><tr><td class="line">2359</td><td class="hits"></td><td class="source">        //             contentType: &quot;html&quot;,</td></tr><tr><td class="line">2360</td><td class="hits"></td><td class="source">        //             data: {</td></tr><tr><td class="line">2361</td><td class="hits"></td><td class="source">        //                 user: wuser</td></tr><tr><td class="line">2362</td><td class="hits"></td><td class="source">        //             }</td></tr><tr><td class="line">2363</td><td class="hits"></td><td class="source">        //         }</td></tr><tr><td class="line">2364</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">2365</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">2366</td><td class="hits"></td><td class="source">        //     email.send(function(err, result){</td></tr><tr><td class="line">2367</td><td class="hits"></td><td class="source">        //         if(err) console.log(&quot;Error sending new user no analytics email:&quot;, err);</td></tr><tr><td class="line">2368</td><td class="hits"></td><td class="source">        //         return res.send(result);</td></tr><tr><td class="line">2369</td><td class="hits"></td><td class="source">        //     });</td></tr><tr><td class="line">2370</td><td class="hits"></td><td class="source">        // });</td></tr><tr><td class="line">2371</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2372</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">2373</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2374</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">2375</td><td class="hits"></td><td class="source">        inactiveList: _inactiveList,</td></tr><tr><td class="line">2376</td><td class="hits"></td><td class="source">        list: _list,</td></tr><tr><td class="line">2377</td><td class="hits"></td><td class="source">        find: _find,</td></tr><tr><td class="line">2378</td><td class="hits"></td><td class="source">        view: _view,</td></tr><tr><td class="line">2379</td><td class="hits"></td><td class="source">        add: _add,</td></tr><tr><td class="line">2380</td><td class="hits"></td><td class="source">        update: _update,</td></tr><tr><td class="line">2381</td><td class="hits"></td><td class="source">        updateSettings :_updateSettings,</td></tr><tr><td class="line">2382</td><td class="hits"></td><td class="source">        register: _register,</td></tr><tr><td class="line">2383</td><td class="hits"></td><td class="source">        registerNoInvite: _registerNoInvite,</td></tr><tr><td class="line">2384</td><td class="hits"></td><td class="source">        retargetPrelimRegister: _retargetPrelimRegister,</td></tr><tr><td class="line">2385</td><td class="hits"></td><td class="source">        retargetRegister: _retargetRegister,</td></tr><tr><td class="line">2386</td><td class="hits"></td><td class="source">        retargetRegisterNoInvite: _retargetRegisterNoInvite,</td></tr><tr><td class="line">2387</td><td class="hits"></td><td class="source">        retargetRegisterActivate: _retargetRegisterActivate,</td></tr><tr><td class="line">2388</td><td class="hits"></td><td class="source">        archive: _archive,</td></tr><tr><td class="line">2389</td><td class="hits"></td><td class="source">        invited: _invited,</td></tr><tr><td class="line">2390</td><td class="hits"></td><td class="source">        cancel: _cancel,</td></tr><tr><td class="line">2391</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2392</td><td class="hits"></td><td class="source">        current: _current,</td></tr><tr><td class="line">2393</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2394</td><td class="hits"></td><td class="source">        subscribe: _subscribe,</td></tr><tr><td class="line">2395</td><td class="hits"></td><td class="source">        unsubscribe: _unsubscribe,</td></tr><tr><td class="line">2396</td><td class="hits"></td><td class="source">        subscriptionUpdate: _subscriptionUpdate,</td></tr><tr><td class="line">2397</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2398</td><td class="hits"></td><td class="source">        retargetSubscribe: _retargetSubscribe,</td></tr><tr><td class="line">2399</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2400</td><td class="hits"></td><td class="source">        addToWaitingList: _addToWaitingList,</td></tr><tr><td class="line">2401</td><td class="hits"></td><td class="source">        updateWaitingListUser: _updateWaitingListUser,</td></tr><tr><td class="line">2402</td><td class="hits"></td><td class="source">        getWaitingList: _getWaitingList,</td></tr><tr><td class="line">2403</td><td class="hits"></td><td class="source">        getWaitingListUser: _getWaitingListUser,</td></tr><tr><td class="line">2404</td><td class="hits"></td><td class="source">        addWaitingListTag: _addWaitingListTag,</td></tr><tr><td class="line">2405</td><td class="hits"></td><td class="source">        addWaitingListInviteTag: _addWaitingListInviteTag,</td></tr><tr><td class="line">2406</td><td class="hits"></td><td class="source">        removeWaitingListTag: _removeWaitingListTag,</td></tr><tr><td class="line">2407</td><td class="hits"></td><td class="source">        resetPasswordStep1: _resetPasswordStep1,</td></tr><tr><td class="line">2408</td><td class="hits"></td><td class="source">        validateEmailToken: _validateEmailToken,</td></tr><tr><td class="line">2409</td><td class="hits"></td><td class="source">        resetPasswordStep2: _resetPasswordStep2,</td></tr><tr><td class="line">2410</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2411</td><td class="hits"></td><td class="source">        createDemoUser: _createDemoUser,</td></tr><tr><td class="line">2412</td><td class="hits"></td><td class="source">        startATrial: _startATrial,</td></tr><tr><td class="line">2413</td><td class="hits"></td><td class="source">        createFreeUser: _createFreeUser,</td></tr><tr><td class="line">2414</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">2415</td><td class="hits"></td><td class="source">        sales: _sales,</td></tr><tr><td class="line">2416</td><td class="hits"></td><td class="source">        activity: _activity,</td></tr><tr><td class="line">2417</td><td class="hits"></td><td class="source">        getTags : _getTags,</td></tr><tr><td class="line">2418</td><td class="hits"></td><td class="source">        getLead: _getLead,</td></tr><tr><td class="line">2419</td><td class="hits"></td><td class="source">        sendNoAnalyticsEmail: _sendNoAnalyticsEmail,</td></tr><tr><td class="line">2420</td><td class="hits"></td><td class="source">        sendWelcomeEmail: _sendWelcomeEmail</td></tr><tr><td class="line">2421</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">2422</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">2423</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">2424</td><td class="hits">1</td><td class="source">module.exports = UsersController;</td></tr><tr><td class="line">2425</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/action.js">/Users/warner/code/clipppr/primeloop-api/models/action.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">8</div><div class="hits">8</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var ActionModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        kaster = require(&quot;kaster-mongoose&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        mongoosastic = require(&quot;mongoosastic&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;);</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        user: {type: String, ref: 'User'}, </td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        clipp: {type: String, ref: 'Clipp'},</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        notebook: {type: String, ref: 'Notebook'},</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        widget: {type:Object, es_indexed:false}, //chrome, javascript, etc</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        action: String,</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        url: String,</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        act: String, //viewed, clipped, posted</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        type: String, //right now it is one of [comments, facebook, twitter, linkedin, google+] will probably convert this into a list somewhere</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        source: String, //right now it will be just Web site &lt;- might expand further to include api/widget</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        created: {type: Date, &quot;default&quot;: Date.now}</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">25</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">    // _schema.plugin(kaster, {</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    //     region: Settings.kaster.region,</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    //     namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    //     name: &quot;Action&quot;,</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">    //     topic: Settings.kaster.topics.data</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">    // });</td></tr><tr class="hit"><td class="line">33</td><td class="hits">1</td><td class="source">    _schema.plugin(mongoosastic, {</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        index: Settings.elasticsearch.data_index,</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        protocol: Settings.elasticsearch.protocol,</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">        host: Settings.elasticsearch.host,</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        port: Settings.elasticsearch.port,</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        auth: Settings.elasticsearch.user + &quot;:&quot; + Settings.elasticsearch.password</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">41</td><td class="hits">1</td><td class="source">    var _model = mongoose.model(&quot;Action&quot;, _schema);</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">43</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">51</td><td class="hits">1</td><td class="source">module.exports = ActionModel;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/activitylog.js">/Users/warner/code/clipppr/primeloop-api/models/activitylog.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">8</div><div class="hits">8</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var ActivityLogModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        kaster = require(&quot;kaster-mongoose&quot;);</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        user: {type: String, ref: &quot;User&quot;},</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        url: String,</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        headers: String,</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        activityTime: {type: Date, &quot;default&quot;: Date.now}</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">17</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">    _schema.plugin(kaster, {</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        region: Settings.kaster.region,</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        name: &quot;ActivityLog&quot;,</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        topic: Settings.kaster.topics.activity</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">26</td><td class="hits">1</td><td class="source">    var _model = mongoose.model(&quot;ActivityLog&quot;, _schema);</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">29</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">37</td><td class="hits">1</td><td class="source">module.exports = ActivityLogModel;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/batch_import.js">/Users/warner/code/clipppr/primeloop-api/models/batch_import.js</h2><div id="stats" class="terrible"><div class="percentage">11%</div><div class="sloc">86</div><div class="hits">10</div><div class="misses">76</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var BatchImportModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        Page = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../models/page&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        Notebook = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../models/notebook&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        PageError = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../models/page_error&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        Clipp = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../models/clipp&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;);</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">    var _log = {</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        url: String,</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        processedUrl: String,</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        error: String,</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        info: String,</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        processed: {type: Boolean, &quot;default&quot;: false},</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        succeeded: {type: Boolean, &quot;default&quot;: false}</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">22</td><td class="hits">1</td><td class="source">    var _job = {</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        urls: [String]</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        user: {type: String, ref: 'User'}, </td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        raw: String,</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        notebook: {type: String, ref: 'Notebook'},</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        created: {type: Date, &quot;default&quot;: Date.now},</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        processed: {type: Boolean, &quot;default&quot;: false},</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        totalToBeProcessed: {type: Number, &quot;default&quot;: 0},</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        totalProcessed: {type: Number, &quot;default&quot;: 0},</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">        jobSize: Number,</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        numJobs: Number,</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        jobs: [_job],</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">        problemUrls :[String],</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">        logs: [_log]</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">43</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">45</td><td class="hits">1</td><td class="source">    var _model = mongoose.model(&quot;BatchImport&quot;, _schema);</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">      * This will process all the urls in a given chunk and call done(err, results)</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">      * when finished</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">      */</td></tr><tr class="hit"><td class="line">51</td><td class="hits">1</td><td class="source">    var _processChunk = function(batch, chunk, done) {</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">            notebookId = batch.notebook,</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">            user = batch.user;</td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">        var len = chunk.length;</td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">        var notebook = null;</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">        var importedClipps = [];</td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">        var processingLogs = [];</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">                _id: notebookId</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">            .populate(&quot;clipps.clipp&quot;, &quot;url&quot;)</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">            .exec(function(err, nb){</td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">                if(err) return done(err);</td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="source">                notebook = nb;</td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="source">                for(var i = 0; i &lt; chunk.length; i++) {</td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="source">                    var log = {</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">                        url: chunk[i]</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">                    };</td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">                    Page.getMetaInfo(chunk[i], log, importClipp);</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="source">        function finish(err) {</td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="source">            if(err) console.log(&quot;error on finish: &quot; + err);</td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="source">            console.log(&quot;processed &quot; + importedClipps.length + &quot; clipps&quot;);</td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">            Notebook.Model</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">                .update(</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">                    {_id:notebook.id},</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">                    {$push: {clipps: {$each: importedClipps}}}</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">                )</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">                .exec(function(err){</td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="source">                    if(err) {</td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="source">                        console.log(&quot;Error saving notebook with imported clipps&quot;, err);</td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="source">                        return done(err, {logs:processingLogs});</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">                    } </td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">                    //console.log(&quot;done saving notebook with clipps: &quot; +JSON.stringify(importedClipps));</td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="source">                    return done(null,  {message:&quot;processed &quot; + importedClipps.length + &quot; clipps&quot;, logs:processingLogs});</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="source">        function importClipp(err, data) {</td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="source">            var reviewFlag = false;</td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="source">            var pageError = null;</td></tr><tr class="miss"><td class="line">97</td><td class="hits">0</td><td class="source">            if(err) {</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">                //depending on the error we may still want to create the clip and flag it</td></tr><tr class="miss"><td class="line">99</td><td class="hits">0</td><td class="source">                if(err == &quot;No URL&quot;) {</td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="source">                    processingLogs.push(data.log);</td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="source">                    return --len || finish(null);</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">                } else {</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">                    //Any other type of error we want to create an error record as well as the clipp</td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="source">                    var error = err;</td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="source">                    if(data &amp;&amp; data.statusCode) {</td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="source">                        error += &quot; status code: &quot; + data.statusCode;</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="source">                    pageError = new PageError.Model({</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">                        _id : uuid.v4(),</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">                        error: error,</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">                        errorType: &quot;http_error&quot;,</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">                        notes: &quot;error occurred on import, batch &quot; + batch._id</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">                    });</td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="source">                    reviewFlag = true;</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">                } </td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="source">            if(!data || !data.url) {</td></tr><tr class="miss"><td class="line">120</td><td class="hits">0</td><td class="source">                if(!data) {</td></tr><tr class="miss"><td class="line">121</td><td class="hits">0</td><td class="source">                    data = {</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">                        log: {</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">                            error: &quot;no data returned&quot;,</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">                            processed: true,</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">                            succeeded:false</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">                    };</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="miss"><td class="line">129</td><td class="hits">0</td><td class="source">                    data.log.error = &quot;No url returned from Page.getMetaInfo&quot;;</td></tr><tr class="miss"><td class="line">130</td><td class="hits">0</td><td class="source">                    data.log.processed = true;</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">                </td></tr><tr class="miss"><td class="line">133</td><td class="hits">0</td><td class="source">                processingLogs.push(data.log);</td></tr><tr class="miss"><td class="line">134</td><td class="hits">0</td><td class="source">                return --len || finish(&quot;no data&quot;, data);</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">            } </td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">137</td><td class="hits">0</td><td class="source">            var log = data.log;</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">139</td><td class="hits">0</td><td class="source">            if(!data.title) data.title = data.url;</td></tr><tr class="miss"><td class="line">140</td><td class="hits">0</td><td class="source">            var clipp = new Clipp.Model({</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">                notebook: notebookId,</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">                url: data.url,</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">                title: data.title,</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">                description: data.description,</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">                batch: batch._id</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">             });</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">148</td><td class="hits">0</td><td class="source">            if(data.site_name) clipp.site.name = data.site_name;</td></tr><tr class="miss"><td class="line">149</td><td class="hits">0</td><td class="source">            if(Clipp.isDuplicate(clipp, notebook)) { //if it already exists just update the batch</td></tr><tr class="miss"><td class="line">150</td><td class="hits">0</td><td class="source">                log.info = &quot;Duplicate Clipp - updating batch&quot;;</td></tr><tr class="miss"><td class="line">151</td><td class="hits">0</td><td class="source">                return Clipp.Model.update({url: clipp.url, notebook: notebookId}, {batch: batch._id}, function(err, saved){</td></tr><tr class="miss"><td class="line">152</td><td class="hits">0</td><td class="source">                    if(err) {</td></tr><tr class="miss"><td class="line">153</td><td class="hits">0</td><td class="source">                        console.log(&quot;error updating clipp&quot;, err);</td></tr><tr class="miss"><td class="line">154</td><td class="hits">0</td><td class="source">                        log.error = &quot;mongo error updating clipp&quot; + err;</td></tr><tr class="miss"><td class="line">155</td><td class="hits">0</td><td class="source">                        processingLogs.push(log);</td></tr><tr class="miss"><td class="line">156</td><td class="hits">0</td><td class="source">                        return --len || finish(err, data); </td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">158</td><td class="hits">0</td><td class="source">                    log.processed = true;</td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="source">                    log.succeeded = true;</td></tr><tr class="miss"><td class="line">160</td><td class="hits">0</td><td class="source">                    processingLogs.push(log);</td></tr><tr class="miss"><td class="line">161</td><td class="hits">0</td><td class="source">                    return --len || finish(err);</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">               </td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">            </td></tr><tr class="miss"><td class="line">166</td><td class="hits">0</td><td class="source">            return clipp.save(function(err, saved){</td></tr><tr class="miss"><td class="line">167</td><td class="hits">0</td><td class="source">                if(err) {</td></tr><tr class="miss"><td class="line">168</td><td class="hits">0</td><td class="source">                    console.log(&quot;Error saving clipp on import:&quot;, err, data.url);</td></tr><tr class="miss"><td class="line">169</td><td class="hits">0</td><td class="source">                    log.error = &quot;mongo Error saving clipp on import:&quot; + err;</td></tr><tr class="miss"><td class="line">170</td><td class="hits">0</td><td class="source">                    processingLogs.push(log);</td></tr><tr class="miss"><td class="line">171</td><td class="hits">0</td><td class="source">                    return --len || finish(err, data); </td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="source">                console.log(&quot;saved clipp: &quot; + saved.url);</td></tr><tr class="miss"><td class="line">174</td><td class="hits">0</td><td class="source">                log.processed = true;</td></tr><tr class="miss"><td class="line">175</td><td class="hits">0</td><td class="source">                if(pageError) {</td></tr><tr class="miss"><td class="line">176</td><td class="hits">0</td><td class="source">                    log.error = &quot;There was an error getting url info: &quot; + pageError.rawError;</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="miss"><td class="line">178</td><td class="hits">0</td><td class="source">                    log.succeeded = true;</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">180</td><td class="hits">0</td><td class="source">                processingLogs.push(log);</td></tr><tr class="miss"><td class="line">181</td><td class="hits">0</td><td class="source">                if(pageError) {</td></tr><tr class="miss"><td class="line">182</td><td class="hits">0</td><td class="source">                    pageError.page = saved.page;</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">184</td><td class="hits">0</td><td class="source">                importedClipps.push({</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">                    page: saved.page,</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">                    clipp: clipp</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">189</td><td class="hits">0</td><td class="source">                if(pageError) {</td></tr><tr class="miss"><td class="line">190</td><td class="hits">0</td><td class="source">                    pageError.save(function(err) {</td></tr><tr class="miss"><td class="line">191</td><td class="hits">0</td><td class="source">                        if(err) {</td></tr><tr class="miss"><td class="line">192</td><td class="hits">0</td><td class="source">                            console.log(&quot;Error saving page error:&quot;, err, data.url);</td></tr><tr class="miss"><td class="line">193</td><td class="hits">0</td><td class="source">                            return --len || finish(err);</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">                        }</td></tr><tr class="miss"><td class="line">195</td><td class="hits">0</td><td class="source">                        return --len || finish(null, &quot;page error saved&quot;);</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">198</td><td class="hits">0</td><td class="source">                return --len || finish(null, &quot;notebook updated with new link&quot;);</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">204</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema,</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">        processChunk: _processChunk</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">213</td><td class="hits">1</td><td class="source">module.exports = BatchImportModel;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/client.js">/Users/warner/code/clipppr/primeloop-api/models/client.js</h2><div id="stats" class="high"><div class="percentage">90%</div><div class="sloc">10</div><div class="hits">9</div><div class="misses">1</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var ClientModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        kaster = require(&quot;kaster-mongoose&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        PermissionUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/permissions&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        AuthUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/auth&quot;);</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">  </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        name: String,</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        client_id: String,</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        client_secret: String,</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        host: String,</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        created: {type: Date, &quot;default&quot;: Date.now},</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        lastAuth: Date</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">22</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">24</td><td class="hits">1</td><td class="source">    _schema.plugin(kaster, {</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        name: &quot;Client&quot;,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        region: Settings.kaster.region,</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        topic: Settings.kaster.topics.data</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">31</td><td class="hits">1</td><td class="source">    var _model = mongoose.model(&quot;Client&quot;, _schema);</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">33</td><td class="hits">1</td><td class="source">    var _getPermissions = function(client) {</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        // console.log(&quot;getting permissions for : &quot; + client.name);</td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">        return PermissionUtils.getClientPermissions(client.name);</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">38</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema,</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">        getPermissions: _getPermissions</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">47</td><td class="hits">1</td><td class="source">module.exports = ClientModel;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/clipp.js">/Users/warner/code/clipppr/primeloop-api/models/clipp.js</h2><div id="stats" class="low"><div class="percentage">47%</div><div class="sloc">190</div><div class="hits">90</div><div class="misses">100</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var ClippModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        kaster = require(&quot;kaster-mongoose&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        mongoosastic = require(&quot;mongoosastic&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        ArrayUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/array&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        ObjectUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/objects&quot;),</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        URLUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/urls&quot;),</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        PageEngagement = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/./page_engagement&quot;),</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        PageErrors = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/./page_error&quot;),</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        Validations = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/validations&quot;);</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">    PageEngagement.jsonSchema._id = {type: String, ref: &quot;Page.Engagement&quot;};</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">    var _notification = {</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        engagement: PageEngagement.jsonSchema,</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        discussion: Number</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">24</td><td class="hits">1</td><td class="source">    var _comments = {</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">          _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">          user: {type: String, ref: 'User'},</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">          text: String,</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">          created: {type: Date, &quot;default&quot;: Date.now}</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">31</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        engagement: PageEngagement.jsonSchema,</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        notifications: _notification,</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        page: {type: String, ref: &quot;Page&quot;},</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">        batch: {type: String},</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        title: String,</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        comments: [_comments],</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">        published: Date,</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">        description: String,</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">        tags: [String],</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">        site: {</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">            url: String,</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">            domain_url: String,</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">            name: String</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">        source: String,</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">        created: {type: Date, &quot;default&quot;: Date.now},</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">        creator: {type: String, ref: &quot;User&quot;},</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">        url: { type: String, required: true, validate: Validations.url },</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">        notebook: {type: String, ref: &quot;Notebook&quot; },</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">        clippRank: Number,</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">        notebookUpdated: {type: String, ref: &quot;Notebook&quot; },</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">        type: {type: String},</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">        conversion: {</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">            conversion: {type: String, ref: &quot;Clipp.Conversions&quot;},</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">            goalCompletion: Number,</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">            goalRate: Number,</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">            goalValueAll: Number,</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">            visits: Number,</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">            visitors: Number,</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">            uplift: {type:Object, es_indexed:false},</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">            created: {type: Date, &quot;default&quot;: Date.now}</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">        trackingUrls: [{type: String, ref: &quot;TrackingUrl&quot;}],</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">        suggestedActions: [{type: String, ref: &quot;SuggestedAction&quot;}]</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">69</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">    // _schema.plugin(kaster, {</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">    //     name: &quot;Clipp&quot;,</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">    //     region: Settings.kaster.region,</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">    //     namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">    //     topic: Settings.kaster.topics.data</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">    // });</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">78</td><td class="hits">1</td><td class="source">    _schema.plugin(mongoosastic, {</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">        index: Settings.elasticsearch.data_index,</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">        protocol: Settings.elasticsearch.protocol,</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">        host: Settings.elasticsearch.host,</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">        port: Settings.elasticsearch.port,</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">        auth: Settings.elasticsearch.user + &quot;:&quot; + Settings.elasticsearch.password</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">86</td><td class="hits">1</td><td class="source">    var _changeNotebook = function(clipp, fromNotebook, toNotebook, done) {</td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">            Notebook = mongoose.model(&quot;Notebook&quot;),</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">            fromIndex,</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">            emitted;</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="source">        var emit = function(err, notebook){</td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="source">            if(++emitted &gt;= 2) return done(err, fromNotebook, toNotebook);</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="source">        Notebook</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">                $or: [ { _id: fromNotebook }, {_id: toNotebook } ]</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">            }, &quot;clipps&quot;)</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">            .exec(function(err, notebooks){</td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="source">                if(err) console.log(&quot;Error moving clipp to notebook:&quot;, err);</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="source">                for(var i in notebooks) {</td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="source">                    if(notebooks[i]._id == fromNotebook) fromNotebook = notebooks[i];</td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="source">                    if( notebooks[i]._id == toNotebook) toNotebook = notebooks[i];</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="source">                fromIndex = ArrayUtils.inArray(clipp._id, fromNotebook.clipps, &quot;clipp&quot;);</td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="source">                fromNotebook.clipps.splice(fromIndex, 1);</td></tr><tr class="miss"><td class="line">110</td><td class="hits">0</td><td class="source">                fromNotebook.markModified(&quot;clipps&quot;);</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">112</td><td class="hits">0</td><td class="source">                toNotebook.clipps.push({</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">                    page: clipp.page,</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">                    clipp: clipp._id</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">                });</td></tr><tr class="miss"><td class="line">116</td><td class="hits">0</td><td class="source">                toNotebook.markModified(&quot;clipps&quot;);</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">118</td><td class="hits">0</td><td class="source">                fromNotebook.save(emit);</td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="source">                toNotebook.save(emit);</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">124</td><td class="hits">1</td><td class="source">    _schema.pre(&quot;save&quot;, function(done){</td></tr><tr class="hit"><td class="line">125</td><td class="hits">1093</td><td class="source">        var </td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">            Page = mongoose.model(&quot;Page&quot;), </td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">            that = this,</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">            hasNotifications = (that.notifications &amp;&amp; that.notifications.engagement),</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">            hasPage = (that.page);</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">        //TODO: if notebook isn't saved yet, deal with notifications (?)</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">133</td><td class="hits">1093</td><td class="source">        this.site.url = URLUtils.getSiteFromURL(this.url);</td></tr><tr class="hit"><td class="line">134</td><td class="hits">1093</td><td class="source">        this.site.domain_url = URLUtils.getNakedDomain(this.url);</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">136</td><td class="hits">1093</td><td class="source">        if(this.previousNotebook) _changeNotebook(this, this.previousNotebook, this.notebook);</td></tr><tr class="hit"><td class="line">137</td><td class="hits">1093</td><td class="source">        delete this.previousNotebook;</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">139</td><td class="hits">1093</td><td class="source">        var emit = function(){</td></tr><tr class="hit"><td class="line">140</td><td class="hits">1</td><td class="source">            if(!hasNotifications || !hasPage) return;</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">            /** Propagate the notebook type to the page </td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">            and clipp for free clipps right now**/</td></tr><tr class="hit"><td class="line">144</td><td class="hits">1</td><td class="source">            var propType = function(){</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">146</td><td class="hits">1</td><td class="source">                if(that.notebook) that.type = that.notebook.type;</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">148</td><td class="hits">1</td><td class="source">                if(that.type) {</td></tr><tr class="miss"><td class="line">149</td><td class="hits">0</td><td class="source">                    Page</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">                        .findOne({</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">                            _id: that.page._id || that.page</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">                        })</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">                        .populate(&quot;clipps&quot;, &quot;type&quot;)</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">                        .exec(function(err, page){</td></tr><tr class="miss"><td class="line">155</td><td class="hits">0</td><td class="source">                            if(err) console.log(&quot;Error getting page:&quot;, err.stack || err);</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">157</td><td class="hits">0</td><td class="source">                            var isFreePage = true;</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="source">                            for(var i = 0; i &lt; page.clipps.length; i++){</td></tr><tr class="miss"><td class="line">160</td><td class="hits">0</td><td class="source">                                if(!page.clipps[i].type || page.clipps[i].type !== &quot;free&quot;) {</td></tr><tr class="miss"><td class="line">161</td><td class="hits">0</td><td class="source">                                    isFreePage = false;</td></tr><tr class="miss"><td class="line">162</td><td class="hits">0</td><td class="source">                                    break;</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">                                }</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">166</td><td class="hits">0</td><td class="source">                            if(isFreePage) {</td></tr><tr class="miss"><td class="line">167</td><td class="hits">0</td><td class="source">                                page.paymentType = that.type;</td></tr><tr class="miss"><td class="line">168</td><td class="hits">0</td><td class="source">                                return page.save(done);</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">                            } else {</td></tr><tr class="miss"><td class="line">170</td><td class="hits">0</td><td class="source">                                return done();</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">                        });</td></tr><tr class="hit"><td class="line">174</td><td class="hits">1</td><td class="source">                } else return done();</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">            };</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">         </td></tr><tr class="hit"><td class="line">177</td><td class="hits">1</td><td class="source">            if(!that.notebook || !that.notebook._id) {</td></tr><tr class="hit"><td class="line">178</td><td class="hits">1</td><td class="source">                that.populate(&quot;notebook&quot;, function(err, clipp){</td></tr><tr class="hit"><td class="line">179</td><td class="hits">1</td><td class="source">                    that.notebook = clipp.notebook;</td></tr><tr class="hit"><td class="line">180</td><td class="hits">1</td><td class="source">                    propType();</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="miss"><td class="line">183</td><td class="hits">0</td><td class="source">                propType();</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">            /** End type prop (replace with done() if we want to rip it out) **/</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">        </td></tr><tr class="hit"><td class="line">189</td><td class="hits">2185</td><td class="source">        if(hasNotifications &amp;&amp; hasPage) return done();</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">191</td><td class="hits">1</td><td class="source">        if(!hasNotifications) {</td></tr><tr class="miss"><td class="line">192</td><td class="hits">0</td><td class="source">            var</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">                Notebook = mongoose.model(&quot;Notebook&quot;);</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">195</td><td class="hits">0</td><td class="source">            Notebook.findOne({</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source">                _id: this.notebook</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">            }, &quot;users&quot;)</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">            .exec(function(err, notebook){</td></tr><tr class="miss"><td class="line">200</td><td class="hits">0</td><td class="source">                if(err) console.log(err);</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">                </td></tr><tr class="miss"><td class="line">202</td><td class="hits">0</td><td class="source">                if(!notebook || err) {</td></tr><tr class="miss"><td class="line">203</td><td class="hits">0</td><td class="source">                    hasNotifications = true;</td></tr><tr class="miss"><td class="line">204</td><td class="hits">0</td><td class="source">                    return emit();</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">207</td><td class="hits">0</td><td class="source">                for(var i in notebook.users){</td></tr><tr class="miss"><td class="line">208</td><td class="hits">0</td><td class="source">                    that.notifications.push({</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source">                        user: notebook.users[i].user,</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">                        engagement: that.engagement</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">                    });</td></tr><tr class="miss"><td class="line">212</td><td class="hits">0</td><td class="source">                    that.markModified(&quot;notifications&quot;);</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">215</td><td class="hits">0</td><td class="source">                hasNotifications = true;</td></tr><tr class="miss"><td class="line">216</td><td class="hits">0</td><td class="source">                return emit();</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">220</td><td class="hits">1</td><td class="source">        if(!hasPage) {</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">            //If it doesn't already have a page go find/create one</td></tr><tr class="hit"><td class="line">223</td><td class="hits">1</td><td class="source">            Page.</td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source">                findOne({url: this.url})</td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source">                .exec(function(err, page){</td></tr><tr class="hit"><td class="line">226</td><td class="hits">1</td><td class="source">                    if(err) throw err;</td></tr><tr class="hit"><td class="line">227</td><td class="hits">1</td><td class="source">                    if(!page) {</td></tr><tr class="hit"><td class="line">228</td><td class="hits">1</td><td class="source">                        page = new Page({</td></tr><tr><td class="line">229</td><td class="hits"></td><td class="source">                            url: that.url,</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">                            title: that.title</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">234</td><td class="hits">1</td><td class="source">                    that.page = page._id;</td></tr><tr class="hit"><td class="line">235</td><td class="hits">1</td><td class="source">                    page.clipps.push(that);</td></tr><tr class="hit"><td class="line">236</td><td class="hits">1</td><td class="source">                    page.markModified(&quot;clipps&quot;);</td></tr><tr class="hit"><td class="line">237</td><td class="hits">1</td><td class="source">                    page.save(function(err, saved){</td></tr><tr class="hit"><td class="line">238</td><td class="hits">1</td><td class="source">                        if(err) console.log(&quot;Error saving page from clipp pre:&quot;, err);</td></tr><tr class="hit"><td class="line">239</td><td class="hits">1</td><td class="source">                        hasPage = true;</td></tr><tr class="hit"><td class="line">240</td><td class="hits">1</td><td class="source">                        return emit();</td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">243</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">247</td><td class="hits">1</td><td class="source">    _schema.virtual(&quot;comment&quot;).set(function(comment){</td></tr><tr class="hit"><td class="line">248</td><td class="hits">1</td><td class="source">        this.comments.push(comment);</td></tr><tr class="hit"><td class="line">249</td><td class="hits">1</td><td class="source">        this.markModified('comments');</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">252</td><td class="hits">1</td><td class="source">    _schema.virtual(&quot;tag&quot;).set(function(tag){</td></tr><tr class="miss"><td class="line">253</td><td class="hits">0</td><td class="source">        if(!tag) return;</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">255</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source">            tags = ArrayUtils.uniqueArray(tag.toString().split(&quot;,&quot;));</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">258</td><td class="hits">0</td><td class="source">        for(var i = 0; i &lt; tags.length; i++){</td></tr><tr class="miss"><td class="line">259</td><td class="hits">0</td><td class="source">            if(this.tags.indexOf(tags[i]) &gt;= 0) tags.splice(i,1);</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">262</td><td class="hits">0</td><td class="source">        this.tags = this.tags.concat(tags);</td></tr><tr class="miss"><td class="line">263</td><td class="hits">0</td><td class="source">        this.markModified('tags');</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">266</td><td class="hits">1</td><td class="source">    _schema.path(&quot;tags&quot;).set(function(tags){</td></tr><tr class="miss"><td class="line">267</td><td class="hits">0</td><td class="source">        tags = tags.toString().split(&quot;,&quot;);</td></tr><tr class="miss"><td class="line">268</td><td class="hits">0</td><td class="source">        for(var i in tags) tags[i] = tags[i].trim().replace(/ /g, &quot;-&quot;);</td></tr><tr class="miss"><td class="line">269</td><td class="hits">0</td><td class="source">        return ArrayUtils.uniqueArray(tags);</td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">272</td><td class="hits">1</td><td class="source">    _schema.path(&quot;notebook&quot;).set(function(notebook){</td></tr><tr class="hit"><td class="line">273</td><td class="hits">462</td><td class="source">        if(this.notebook !== notebook) this.previousNotebook = this.notebook;</td></tr><tr class="hit"><td class="line">274</td><td class="hits">231</td><td class="source">        return notebook;</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">276</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">277</td><td class="hits">1</td><td class="source">    var _updateNotifications = function(diffs, notifs) {</td></tr><tr class="hit"><td class="line">278</td><td class="hits">858</td><td class="source">        var </td></tr><tr><td class="line">279</td><td class="hits"></td><td class="source">            notifications = notifs.toObject(),</td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source">            props = [</td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source">                &quot;facebook&quot;,</td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source">                &quot;twitter&quot;,</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source">                &quot;linkedin&quot;,</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source">                &quot;googleplus&quot;,</td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source">                &quot;reddit&quot;,</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source">                &quot;native_count&quot;,</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source">                &quot;comments&quot;,</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">                &quot;stumbleupon&quot;,</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source">                &quot;pinterest&quot;</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source">            ];</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source">        //console.log(&quot;diffs to update: &quot; + JSON.stringify(diffs));</td></tr><tr><td class="line">292</td><td class="hits"></td><td class="source">        //console.log(&quot;notifications to update: &quot; + JSON.stringify(notifs));</td></tr><tr class="hit"><td class="line">293</td><td class="hits">858</td><td class="source">        if(!notifications.engagement) notifications.engagement = {};</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">295</td><td class="hits">858</td><td class="source">        for(var p in props) {</td></tr><tr class="hit"><td class="line">296</td><td class="hits">7722</td><td class="source">            notifications.engagement[props[p]] = parseInt(notifications.engagement[props[p]] || 0, 10) + parseInt(diffs[props[p]] || 0, 10);</td></tr><tr class="hit"><td class="line">297</td><td class="hits">7722</td><td class="source">            if(notifications.engagement[props[p]] &lt; 0) notifications.engagement[props[p]] = 0;</td></tr><tr><td class="line">298</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">300</td><td class="hits">858</td><td class="source">        return notifications;</td></tr><tr><td class="line">301</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">302</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">303</td><td class="hits">1</td><td class="source">    _schema.methods.syncPage = function(page, done){</td></tr><tr class="hit"><td class="line">304</td><td class="hits">858</td><td class="source">        var </td></tr><tr><td class="line">305</td><td class="hits"></td><td class="source">            diffs = PageEngagement.engagementDifferences(this.engagement, page.engagement);</td></tr><tr><td class="line">306</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">307</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">308</td><td class="hits">858</td><td class="source">        var notifications = _updateNotifications(diffs, this.notifications);</td></tr><tr class="hit"><td class="line">309</td><td class="hits">858</td><td class="source">        if(notifications) {</td></tr><tr class="hit"><td class="line">310</td><td class="hits">858</td><td class="source">            this.notifications = notifications;</td></tr><tr class="hit"><td class="line">311</td><td class="hits">858</td><td class="source">            this.markModified(&quot;notifications&quot;);</td></tr><tr><td class="line">312</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">313</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">314</td><td class="hits">858</td><td class="source">        this.engagement = page.engagement;</td></tr><tr class="hit"><td class="line">315</td><td class="hits">858</td><td class="source">        this.published = page.published;</td></tr><tr class="hit"><td class="line">316</td><td class="hits">858</td><td class="source">        this.save(function(err, saved){</td></tr><tr class="hit"><td class="line">317</td><td class="hits">858</td><td class="source">            return done(err, saved);</td></tr><tr><td class="line">318</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">319</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">320</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">321</td><td class="hits">1</td><td class="source">    _schema.methods.addNotifications = function(done){</td></tr><tr class="miss"><td class="line">322</td><td class="hits">0</td><td class="source">        if(!this.notifications) {</td></tr><tr class="miss"><td class="line">323</td><td class="hits">0</td><td class="source">            this.notifications = {engagement: this.engagement};</td></tr><tr class="miss"><td class="line">324</td><td class="hits">0</td><td class="source">            this.markModified(&quot;notifications&quot;);</td></tr><tr class="miss"><td class="line">325</td><td class="hits">0</td><td class="source">        } else if(!this.notifications.engagement) {</td></tr><tr class="miss"><td class="line">326</td><td class="hits">0</td><td class="source">            this.notifications = {engagement: this.engagement};</td></tr><tr class="miss"><td class="line">327</td><td class="hits">0</td><td class="source">            this.markModified(&quot;notifications&quot;);</td></tr><tr><td class="line">328</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">329</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">330</td><td class="hits">0</td><td class="source">        return this.update({notifications:this.notifications}, done);</td></tr><tr><td class="line">331</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">332</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">333</td><td class="hits">1</td><td class="source">    _schema.methods.clearNotification = function(type, done) {</td></tr><tr class="hit"><td class="line">334</td><td class="hits">2</td><td class="source">        var </td></tr><tr><td class="line">335</td><td class="hits"></td><td class="source">            that = this;</td></tr><tr><td class="line">336</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">337</td><td class="hits">2</td><td class="source">        if(!that.notifications) return done();</td></tr><tr><td class="line">338</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">339</td><td class="hits">2</td><td class="source">        that.notifications.engagement[type] = 0;</td></tr><tr><td class="line">340</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">341</td><td class="hits">2</td><td class="source">        return that.save(done);</td></tr><tr><td class="line">342</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">343</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">344</td><td class="hits">1</td><td class="source">    _schema.methods.clearAllNotifications = function(types, done) {</td></tr><tr class="miss"><td class="line">345</td><td class="hits">0</td><td class="source">          var </td></tr><tr><td class="line">346</td><td class="hits"></td><td class="source">            that = this, </td></tr><tr><td class="line">347</td><td class="hits"></td><td class="source">            type;</td></tr><tr><td class="line">348</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">349</td><td class="hits">0</td><td class="source">        if(!that.notifications) return done();</td></tr><tr><td class="line">350</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">351</td><td class="hits">0</td><td class="source">        for(var i in types) {</td></tr><tr class="miss"><td class="line">352</td><td class="hits">0</td><td class="source">            type = types[i];</td></tr><tr class="miss"><td class="line">353</td><td class="hits">0</td><td class="source">            that.notifications.engagement[type] = 0;    </td></tr><tr><td class="line">354</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">355</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">356</td><td class="hits">0</td><td class="source">        return that.save(done);</td></tr><tr><td class="line">357</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">358</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">359</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">360</td><td class="hits"></td><td class="source">     * Sets All the properties given by the input object on the model instance</td></tr><tr><td class="line">361</td><td class="hits"></td><td class="source">     * @param  {Object} data An object with all the properties to be set</td></tr><tr><td class="line">362</td><td class="hits"></td><td class="source">     * @return {Object}      Reference to this</td></tr><tr><td class="line">363</td><td class="hits"></td><td class="source">     */</td></tr><tr class="hit"><td class="line">364</td><td class="hits">1</td><td class="source">    _schema.methods.setAll = function(data, user) {</td></tr><tr class="miss"><td class="line">365</td><td class="hits">0</td><td class="source">        if(data.comment) data.comment = {</td></tr><tr><td class="line">366</td><td class="hits"></td><td class="source">            user: user._id,</td></tr><tr><td class="line">367</td><td class="hits"></td><td class="source">            text: data.comment</td></tr><tr><td class="line">368</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">369</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">370</td><td class="hits">0</td><td class="source">        return ObjectUtils.copyAllProperties(data, this);</td></tr><tr><td class="line">371</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">372</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">373</td><td class="hits">1</td><td class="source">    var _isDuplicate = function(clipp, notebook){</td></tr><tr class="miss"><td class="line">374</td><td class="hits">0</td><td class="source">        if(!notebook) return true;</td></tr><tr><td class="line">375</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">376</td><td class="hits">0</td><td class="source">        if(!notebook.clipps) return true;</td></tr><tr class="miss"><td class="line">377</td><td class="hits">0</td><td class="source">        return ArrayUtils.inArray(clipp.url, notebook.clipps, &quot;clipp.url&quot;) &gt;= 0;</td></tr><tr><td class="line">378</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">379</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">380</td><td class="hits">1</td><td class="source">    var _ensurePositiveNotifications = function(engagement) {</td></tr><tr class="miss"><td class="line">381</td><td class="hits">0</td><td class="source">        for(var i in engagement) {</td></tr><tr class="miss"><td class="line">382</td><td class="hits">0</td><td class="source">            if(typeof engagement[i] === &quot;number&quot;) {</td></tr><tr class="miss"><td class="line">383</td><td class="hits">0</td><td class="source">                if(engagement[i] &lt; 0) engagement[i] = 0;</td></tr><tr><td class="line">384</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">385</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">386</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">387</td><td class="hits">0</td><td class="source">        return engagement;</td></tr><tr><td class="line">388</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">389</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">390</td><td class="hits">1</td><td class="source">    var _getNotifications= function(clipp) {</td></tr><tr class="miss"><td class="line">391</td><td class="hits">0</td><td class="source">        clipp = (clipp.toObject) ? clipp.toObject() : clipp;</td></tr><tr><td class="line">392</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">393</td><td class="hits">0</td><td class="source">        if(clipp.notifications &amp;&amp; clipp.notifications.engagement) {</td></tr><tr class="miss"><td class="line">394</td><td class="hits">0</td><td class="source">            clipp.notifications.engagement.total = PageEngagement.totalPoints(clipp.notifications.engagement);</td></tr><tr><td class="line">395</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">396</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">397</td><td class="hits">0</td><td class="source">        _ensurePositiveNotifications(clipp.notifications.engagement);</td></tr><tr><td class="line">398</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">399</td><td class="hits">0</td><td class="source">        delete clipp.notifications._id;    </td></tr><tr><td class="line">400</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">401</td><td class="hits">0</td><td class="source">        return clipp;</td></tr><tr><td class="line">402</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">403</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">404</td><td class="hits">1</td><td class="source">    var _getTeamDiscussionNotificiations = function(clipp, user){</td></tr><tr class="miss"><td class="line">405</td><td class="hits">0</td><td class="source">        if(!clipp) return clipp;</td></tr><tr class="miss"><td class="line">406</td><td class="hits">0</td><td class="source">        if(!user) return clipp;</td></tr><tr><td class="line">407</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">408</td><td class="hits">0</td><td class="source">        if(typeof user.discussionHistory === &quot;undefined&quot;){</td></tr><tr class="miss"><td class="line">409</td><td class="hits">0</td><td class="source">            clipp.notifications.discussion = clipp.comments.length;</td></tr><tr class="miss"><td class="line">410</td><td class="hits">0</td><td class="source">            return clipp;</td></tr><tr><td class="line">411</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">412</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">413</td><td class="hits">0</td><td class="source">        var lastViewedNotificationCount = 0;</td></tr><tr class="miss"><td class="line">414</td><td class="hits">0</td><td class="source">        for(var i = 0; i &lt; user.discussionHistory.length; i++){</td></tr><tr class="miss"><td class="line">415</td><td class="hits">0</td><td class="source">            if(user.discussionHistory[i].clippId == clipp._id &amp;&amp; user.discussionHistory[i].updatedType == &quot;viewed&quot; &amp;&amp; user.discussionHistory[i].currentCount &gt; lastViewedNotificationCount){</td></tr><tr class="miss"><td class="line">416</td><td class="hits">0</td><td class="source">                lastViewedNotificationCount = user.discussionHistory[i].currentCount;</td></tr><tr><td class="line">417</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">418</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">419</td><td class="hits">0</td><td class="source">        clipp.notifications.discussion = clipp.comments.length - lastViewedNotificationCount;</td></tr><tr><td class="line">420</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">421</td><td class="hits">0</td><td class="source">        return clipp;</td></tr><tr><td class="line">422</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">423</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">424</td><td class="hits">1</td><td class="source">    var _prepareForOutput = function(clipp, user){</td></tr><tr class="miss"><td class="line">425</td><td class="hits">0</td><td class="source">        if(!clipp) return clipp; </td></tr><tr><td class="line">426</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">427</td><td class="hits">0</td><td class="source">        clipp = (clipp.toObject) ? clipp.toObject() : clipp;</td></tr><tr class="miss"><td class="line">428</td><td class="hits">0</td><td class="source">        clipp = _getNotifications(clipp);</td></tr><tr class="miss"><td class="line">429</td><td class="hits">0</td><td class="source">        clipp = _getTeamDiscussionNotificiations(clipp, user);</td></tr><tr><td class="line">430</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">431</td><td class="hits">0</td><td class="source">        if(clipp.__v) delete clipp.__v;</td></tr><tr class="miss"><td class="line">432</td><td class="hits">0</td><td class="source">        return clipp;</td></tr><tr><td class="line">433</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">434</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">435</td><td class="hits">1</td><td class="source">    var _prepareMultipleForOutput = function(clipps, user) {</td></tr><tr class="miss"><td class="line">436</td><td class="hits">0</td><td class="source">        for(var i in clipps){</td></tr><tr class="miss"><td class="line">437</td><td class="hits">0</td><td class="source">            clipps[i] = _prepareForOutput(clipps[i], user);</td></tr><tr><td class="line">438</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">439</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">440</td><td class="hits">0</td><td class="source">        return clipps;</td></tr><tr><td class="line">441</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">442</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">443</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">444</td><td class="hits"></td><td class="source">        _model = mongoose.model(&quot;Clipp&quot;, _schema),</td></tr><tr><td class="line">445</td><td class="hits"></td><td class="source">        _archiveSchema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">446</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">447</td><td class="hits">1</td><td class="source">    _archiveSchema.plugin(kaster, {</td></tr><tr><td class="line">448</td><td class="hits"></td><td class="source">        name: &quot;ClippArchive&quot;,</td></tr><tr><td class="line">449</td><td class="hits"></td><td class="source">        region: Settings.kaster.region,</td></tr><tr><td class="line">450</td><td class="hits"></td><td class="source">        namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">451</td><td class="hits"></td><td class="source">        topic: Settings.kaster.topics.data</td></tr><tr><td class="line">452</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">453</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">454</td><td class="hits">1</td><td class="source">    var _archiveModel = mongoose.model(&quot;Clipp.Archive&quot;, _archiveSchema);</td></tr><tr><td class="line">455</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">456</td><td class="hits">1</td><td class="source">    var _archive = function(clipp, done) {</td></tr><tr class="hit"><td class="line">457</td><td class="hits">34</td><td class="source">        var archived = new _archiveModel(clipp.toObject());</td></tr><tr class="hit"><td class="line">458</td><td class="hits">34</td><td class="source">        archived.save(function(err, saved){</td></tr><tr class="hit"><td class="line">459</td><td class="hits">34</td><td class="source">            if(err) return done(err);</td></tr><tr><td class="line">460</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">461</td><td class="hits">34</td><td class="source">            return clipp.remove(done);    </td></tr><tr><td class="line">462</td><td class="hits"></td><td class="source">        });  </td></tr><tr><td class="line">463</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">464</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">465</td><td class="hits">1</td><td class="source">    var _archiveMany = function(clipp_ids, done) {</td></tr><tr class="miss"><td class="line">466</td><td class="hits">0</td><td class="source">        _model</td></tr><tr><td class="line">467</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">468</td><td class="hits"></td><td class="source">                _id : { $in : clipp_ids }</td></tr><tr><td class="line">469</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">470</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">471</td><td class="hits"></td><td class="source">            .exec(function(err, clipps){</td></tr><tr class="miss"><td class="line">472</td><td class="hits">0</td><td class="source">                if(err) return done(err);</td></tr><tr><td class="line">473</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">474</td><td class="hits">0</td><td class="source">                _archiveModel.create(clipps, function(err){</td></tr><tr class="miss"><td class="line">475</td><td class="hits">0</td><td class="source">                    if(err) return done(err);</td></tr><tr><td class="line">476</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">477</td><td class="hits">0</td><td class="source">                    return _model.remove({</td></tr><tr><td class="line">478</td><td class="hits"></td><td class="source">                        _id : { $in : clipp_ids }</td></tr><tr><td class="line">479</td><td class="hits"></td><td class="source">                    }, done);</td></tr><tr><td class="line">480</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">481</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">482</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">483</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">484</td><td class="hits">1</td><td class="source">    var _unarchive = function(){</td></tr><tr><td class="line">485</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">486</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">487</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">488</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">489</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">490</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">491</td><td class="hits"></td><td class="source">        Archive: {</td></tr><tr><td class="line">492</td><td class="hits"></td><td class="source">            Model: _archiveModel,</td></tr><tr><td class="line">493</td><td class="hits"></td><td class="source">            Schema: _schema,</td></tr><tr><td class="line">494</td><td class="hits"></td><td class="source">            add: _archive,</td></tr><tr><td class="line">495</td><td class="hits"></td><td class="source">            addMany: _archiveMany,</td></tr><tr><td class="line">496</td><td class="hits"></td><td class="source">            remove: _unarchive</td></tr><tr><td class="line">497</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">498</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema,</td></tr><tr><td class="line">499</td><td class="hits"></td><td class="source">        isDuplicate: _isDuplicate,</td></tr><tr><td class="line">500</td><td class="hits"></td><td class="source">        getNotifications: _getNotifications,</td></tr><tr><td class="line">501</td><td class="hits"></td><td class="source">        prepareMultipleForOutput: _prepareMultipleForOutput,</td></tr><tr><td class="line">502</td><td class="hits"></td><td class="source">        prepareForOutput: _prepareForOutput</td></tr><tr><td class="line">503</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">504</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">505</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">506</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">507</td><td class="hits">1</td><td class="source">module.exports = ClippModel;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/clipp_conversions.js">/Users/warner/code/clipppr/primeloop-api/models/clipp_conversions.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">14</div><div class="hits">14</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var ClippConversionsModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        kaster = require(&quot;kaster-mongoose&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        mongoosastic = require(&quot;mongoosastic&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;);</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        analytics: {type:Object, es_indexed:false},</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        created: {type: Date, &quot;default&quot;: Date.now},</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        updated: {type: Date, &quot;default&quot;: Date.now},</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        notebooks: [{type: String, ref: &quot;Notebook&quot;}],</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        profileId: String,</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        accountId: String,</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        webPropertyId: String</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">21</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    // _schema.plugin(kaster, {</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    //     name: &quot;Clipp.Conversion&quot;,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    //     region: Settings.kaster.region,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    //     namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">    //     topic: Settings.kaster.topics.data</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    // });</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">    _schema.plugin(mongoosastic, {</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        index: Settings.elasticsearch.data_index,</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        protocol: Settings.elasticsearch.protocol,</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        host: Settings.elasticsearch.host,</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        port: Settings.elasticsearch.port,</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        auth: Settings.elasticsearch.user + &quot;:&quot; + Settings.elasticsearch.password</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"><td class="line">37</td><td class="hits">1</td><td class="source">    var _model = mongoose.model(&quot;Clipp.Conversions&quot;, _schema);</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">39</td><td class="hits">1</td><td class="source">    var _jsonHistorySchema = _jsonSchema;</td></tr><tr class="hit"><td class="line">40</td><td class="hits">1</td><td class="source">    _jsonHistorySchema.conversion = {type: String, ref: &quot;Clipp.Conversions&quot;};</td></tr><tr class="hit"><td class="line">41</td><td class="hits">1</td><td class="source">    _jsonHistorySchema.clipp = {type: String, ref: &quot;Clipp&quot;};</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">44</td><td class="hits">1</td><td class="source">    var _historySchema = mongoose.Schema(_jsonHistorySchema);</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">46</td><td class="hits">1</td><td class="source">    _historySchema.plugin(kaster, {</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">        name: &quot;ClippConversionHistory&quot;,</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">        region: Settings.kaster.region,</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">        namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">        topic: Settings.kaster.topics.data</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">53</td><td class="hits">1</td><td class="source">    _historyModel = mongoose.model(&quot;Clipp.ConversionHistory&quot;, _historySchema);</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">55</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema,</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">        history: {</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">            Schema: _historySchema,</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">            Model: _historyModel</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">66</td><td class="hits">1</td><td class="source">module.exports = ClippConversionsModel;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/comment.js">/Users/warner/code/clipppr/primeloop-api/models/comment.js</h2><div id="stats" class="medium"><div class="percentage">66%</div><div class="sloc">15</div><div class="hits">10</div><div class="misses">5</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var CommentModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        ObjectUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/objects&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        request = require(&quot;request&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        cheerio = require(&quot;cheerio&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        kaster = require(&quot;kaster-mongoose&quot;),</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        mongoosastic = require(&quot;mongoosastic&quot;),</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        PageEngagement = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/./page_engagement&quot;),</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        Validations = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/validations&quot;);</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        // _id: { type: String, &quot;default&quot;: uuid.v4 },</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        page: {type: String, ref: &quot;Page&quot;, index: true},</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        id: String,</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        parentId: String,</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        html: String,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        text: String,</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        author: {type:Object, es_indexed:false},</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        updated: String,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        created: String,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        likes: Number,</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        type: String,</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        ancestorId: String,</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        annotations: {type:Object, es_indexed:false},</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        suggestedActions: [{type: String, ref: &quot;SuggestedAction&quot;}],</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        words: Number</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">35</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema, { strict: false });</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">    // _schema.plugin(kaster, {</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">    //     name: &quot;Comment&quot;,</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">    //     region: Settings.kaster.region,</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    //     namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">    //     topic: Settings.kaster.topics.data</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">    // });</td></tr><tr class="hit"><td class="line">43</td><td class="hits">1</td><td class="source">    _schema.plugin(mongoosastic, {</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">        index: Settings.elasticsearch.data_index,</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">        protocol: Settings.elasticsearch.protocol,</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        host: Settings.elasticsearch.host,</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">        port: Settings.elasticsearch.port,</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">        auth: Settings.elasticsearch.user + &quot;:&quot; + Settings.elasticsearch.password</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">    </td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">     * Sets All the properties given by the input object on the model instance</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">     * @param  {Object} data An object with all the properties to be set</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">     * @return {Object}      Reference to this</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">     */</td></tr><tr class="hit"><td class="line">56</td><td class="hits">1</td><td class="source">    _schema.methods.setAll = function(data) {</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">        return ObjectUtils.copyAllProperties(data, this);</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">61</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">        _model = mongoose.model(&quot;Comment&quot;, _schema);</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">65</td><td class="hits">1</td><td class="source">    var _decodeHTML = function(html) {</td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">        var $ = cheerio.load(&quot;&lt;body&gt;&lt;/body&gt;&quot;);</td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="source">        var ht = $('&lt;div/&gt;').html(html);</td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="source">        if(ht.text) return ht.text();</td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="source">        return ht;</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">72</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">80</td><td class="hits">1</td><td class="source">module.exports = CommentModel;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/coupon.js">/Users/warner/code/clipppr/primeloop-api/models/coupon.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">23</div><div class="hits">23</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var CouponModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        moment = require(&quot;moment&quot;);</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        name: String,</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        currency: {type:String, &quot;default&quot;: &quot;usd&quot;},</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        amount_off: Number, </td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        percent_off: Number,</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        duration: {type:String, &quot;default&quot;: &quot;once&quot;},</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        duration_in_months: Number,</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        max_redemptions: Number,</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        redeem_by: Date,</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        created: {type: Date, &quot;default&quot;: Date.now},</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        creator: {type: String, ref: &quot;User&quot;},</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">23</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">25</td><td class="hits">1</td><td class="source">    _schema.pre(&quot;save&quot;, function(done){</td></tr><tr class="hit"><td class="line">26</td><td class="hits">7</td><td class="source">        var coupon = this;</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        //first do some custom validation here so that we kick out bad combos</td></tr><tr class="hit"><td class="line">28</td><td class="hits">7</td><td class="source">        if(!coupon.amount_off &amp;&amp; !coupon.percent_off) {</td></tr><tr class="hit"><td class="line">29</td><td class="hits">1</td><td class="source">            coupon.invalidate(&quot;amount_off&quot;, &quot;must use either amount off or percent off&quot;);</td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">            return done(new Error(&quot;must use either amount off or percent off&quot;));</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">32</td><td class="hits">6</td><td class="source">        if(coupon.duration === &quot;repeating&quot;) {</td></tr><tr class="hit"><td class="line">33</td><td class="hits">3</td><td class="source">            if(!coupon.duration_in_months || coupon.duration_in_months &lt;= 0) {</td></tr><tr class="hit"><td class="line">34</td><td class="hits">1</td><td class="source">                coupon.invalidate(&quot;duration_in_months&quot;, &quot;must choose a positive value for duration in months if repeating&quot;);</td></tr><tr class="hit"><td class="line">35</td><td class="hits">1</td><td class="source">                return done(new Error(&quot;must choose a positive value for duration in months if repeating&quot;));</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">39</td><td class="hits">5</td><td class="source">        if(coupon.redeem_by) {</td></tr><tr class="hit"><td class="line">40</td><td class="hits">2</td><td class="source">            var now = moment().startOf('day');</td></tr><tr class="hit"><td class="line">41</td><td class="hits">2</td><td class="source">            var redeemBy = moment(coupon.redeem_by).startOf('day');</td></tr><tr class="hit"><td class="line">42</td><td class="hits">2</td><td class="source">            if(!redeemBy.isAfter(now)) {</td></tr><tr class="hit"><td class="line">43</td><td class="hits">1</td><td class="source">                coupon.invalidate(&quot;redeem_by&quot;, &quot;redeem by must be after today&quot;);</td></tr><tr class="hit"><td class="line">44</td><td class="hits">1</td><td class="source">                return done(new Error(&quot;Redeem By must be after today&quot;));</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">        </td></tr><tr class="hit"><td class="line">48</td><td class="hits">4</td><td class="source">        return done();</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">51</td><td class="hits">1</td><td class="source">    var _model = mongoose.model(&quot;Coupon&quot;, _schema);</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">53</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">61</td><td class="hits">1</td><td class="source">module.exports = CouponModel;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/customer.js">/Users/warner/code/clipppr/primeloop-api/models/customer.js</h2><div id="stats" class="medium"><div class="percentage">59%</div><div class="sloc">66</div><div class="hits">39</div><div class="misses">27</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var CustomerModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        ArrayUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/array&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        moment = require(&quot;moment&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        Plan = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/./plan&quot;).Model,</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        Coupon = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/./coupon&quot;).Model;</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">    var _invoice = {</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        amount: Number,</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        amountDueAfterDiscount: Number,</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        totalClicks: Number,</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        discountPercent: Number,</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        discountAmount:Number,</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        terms: String,</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        invoiceNumber: String</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">23</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        user: {type: String, ref: &quot;User&quot;}, </td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        customerId: String,</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        invoices: [_invoice],</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        plan: {type:String, ref: &quot;Plan&quot;},</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        coupon:{type:String, ref:&quot;Coupon&quot;},</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        activeCampaigns: [{type: String, ref: 'Notebook'}],</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        startDate: Date,</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        billingType: {type:String, &quot;default&quot;:'end-of-month'},</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        nextBillDue: Date,</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        status: String,</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        created: {type: Date, &quot;default&quot;: Date.now}</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">38</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">40</td><td class="hits">1</td><td class="source">    var _model = mongoose.model(&quot;Customer&quot;, _schema);</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">    //This is called whenever a campaign is marked as live or otherwise</td></tr><tr class="hit"><td class="line">43</td><td class="hits">1</td><td class="source">    var _updateCustomer = function(user, campaign, done) {</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">        //we need to see if the user record already has a customer record or not</td></tr><tr class="hit"><td class="line">45</td><td class="hits">5</td><td class="source">        _model</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">                user:user._id</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">            .populate(&quot;plan&quot;)</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">            .exec(function(err, customer){</td></tr><tr class="hit"><td class="line">51</td><td class="hits">5</td><td class="source">                if(err) return done(err);</td></tr><tr class="hit"><td class="line">52</td><td class="hits">5</td><td class="source">                if(!customer) {</td></tr><tr class="miss"><td class="line">53</td><td class="hits">0</td><td class="source">                    _createCustomer(user, user.planOffered, null, function(err, createdCustomer){</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">                        createdCustomer.activeCampaigns.push(campaign._id);</td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">                        createdCustomer.startDate = Date.now();</td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">                        createdCustomer.nextBillDue = new moment(createdCustomer.startDate).endOf('month').toDate();</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">                        createdCustomer.markModified(&quot;startDate&quot;);</td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">                        createdCustomer.markModified(&quot;nextBillDue&quot;);</td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">                        createdCustomer.markModified(&quot;activeCampaigns&quot;);</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">                        createdCustomer.save(function(err, saved){</td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="source">                            return done(err, saved);</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">                } else {</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">                    //push campaign if it isn't already in there</td></tr><tr class="hit"><td class="line">66</td><td class="hits">5</td><td class="source">                    var idx = ArrayUtils.inArray(campaign._id, customer.activeCampaigns);</td></tr><tr class="hit"><td class="line">67</td><td class="hits">5</td><td class="source">                    if(idx &lt; 0) {</td></tr><tr class="hit"><td class="line">68</td><td class="hits">3</td><td class="source">                        customer.activeCampaigns.push(campaign._id);</td></tr><tr class="hit"><td class="line">69</td><td class="hits">3</td><td class="source">                        customer.markModified(&quot;activeCampaigns&quot;);</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="hit"><td class="line">71</td><td class="hits">5</td><td class="source">                    if(customer.activeCampaigns.length == 1 &amp;&amp; !customer.startDate) {</td></tr><tr class="hit"><td class="line">72</td><td class="hits">2</td><td class="source">                        customer.startDate = Date.now();</td></tr><tr class="hit"><td class="line">73</td><td class="hits">2</td><td class="source">                        customer.nextBillDue = new moment(customer.startDate).endOf('month').toDate();</td></tr><tr class="hit"><td class="line">74</td><td class="hits">2</td><td class="source">                        customer.markModified(&quot;startDate&quot;);</td></tr><tr class="hit"><td class="line">75</td><td class="hits">2</td><td class="source">                        customer.markModified(&quot;nextBillDue&quot;);</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="hit"><td class="line">77</td><td class="hits">5</td><td class="source">                    customer.save(function(err, saved){</td></tr><tr class="hit"><td class="line">78</td><td class="hits">5</td><td class="source">                        return done(err, saved);</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">                </td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">85</td><td class="hits">1</td><td class="source">    var _createCustomer = function(user, planName, couponName, done) {</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">        //we need to see if the user record already has a customer record or not</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">        //first need to lookup plan and coupon info</td></tr><tr class="hit"><td class="line">88</td><td class="hits">3</td><td class="source">        var foundPlan, foundCoupon;</td></tr><tr class="hit"><td class="line">89</td><td class="hits">3</td><td class="source">        Plan</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">            .findOne({name: planName})</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">            .exec(function(err, plan){</td></tr><tr class="hit"><td class="line">92</td><td class="hits">3</td><td class="source">                if(err) return done(err);</td></tr><tr class="hit"><td class="line">93</td><td class="hits">3</td><td class="source">                if(!plan) return done(&quot;couldn't find plan with name &quot; + planName);</td></tr><tr class="hit"><td class="line">94</td><td class="hits">3</td><td class="source">                foundPlan = plan;</td></tr><tr class="hit"><td class="line">95</td><td class="hits">3</td><td class="source">                _model</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">                    .findOne({</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">                        user:user._id</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">                    })</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">                    .exec(function(err, customer){</td></tr><tr class="hit"><td class="line">100</td><td class="hits">3</td><td class="source">                        if(err) return done(err);</td></tr><tr class="hit"><td class="line">101</td><td class="hits">3</td><td class="source">                        var newCustomer = new _model();</td></tr><tr class="hit"><td class="line">102</td><td class="hits">3</td><td class="source">                        if(customer) {</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">                            //check fields to make sure it's complete and then exit</td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="source">                            if(customer.plan &amp;&amp; customer.billingType) {</td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="source">                                return done(null,customer);</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">                            } else {</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">                                //if those aren't set then go ahead and set, save and return</td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="source">                                customer.plan = foundPlan;</td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="source">                                customer.billingType = foundPlan.billingType;</td></tr><tr class="miss"><td class="line">110</td><td class="hits">0</td><td class="source">                                if(couponName &amp;&amp; !customer.coupon) {</td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="source">                                    _findCoupon(couponName, function(err, coupon){</td></tr><tr class="miss"><td class="line">112</td><td class="hits">0</td><td class="source">                                        if(err) return done(err);</td></tr><tr class="miss"><td class="line">113</td><td class="hits">0</td><td class="source">                                        customer.coupon = coupon;</td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="source">                                        return customer.save(done);</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">                                    });</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">                                } else {</td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="source">                                    return customer.save(done);</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">                                }</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">                                </td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">                        } else {</td></tr><tr class="hit"><td class="line">122</td><td class="hits">3</td><td class="source">                            newCustomer.user = user;</td></tr><tr class="hit"><td class="line">123</td><td class="hits">3</td><td class="source">                            newCustomer.plan = foundPlan;</td></tr><tr class="hit"><td class="line">124</td><td class="hits">3</td><td class="source">                            newCustomer.billingType = foundPlan.billingType;</td></tr><tr class="hit"><td class="line">125</td><td class="hits">3</td><td class="source">                            if(couponName) {</td></tr><tr class="miss"><td class="line">126</td><td class="hits">0</td><td class="source">                                _findCoupon(couponName, function(err, coupon){</td></tr><tr class="miss"><td class="line">127</td><td class="hits">0</td><td class="source">                                    if(err) return done(err);</td></tr><tr class="miss"><td class="line">128</td><td class="hits">0</td><td class="source">                                    newCustomer.coupon = coupon;</td></tr><tr class="miss"><td class="line">129</td><td class="hits">0</td><td class="source">                                    return newCustomer.save(done);</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">                                });</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">                            } else {</td></tr><tr class="hit"><td class="line">132</td><td class="hits">3</td><td class="source">                                return newCustomer.save(done);</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">                </td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">141</td><td class="hits">1</td><td class="source">    var _findCoupon = function(couponName, done) {</td></tr><tr class="miss"><td class="line">142</td><td class="hits">0</td><td class="source">        Coupon</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">            .findOne({name: couponName})</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">            .exec(function(err, coupon){</td></tr><tr class="miss"><td class="line">145</td><td class="hits">0</td><td class="source">                if(err) return done(err);</td></tr><tr class="miss"><td class="line">146</td><td class="hits">0</td><td class="source">                if(!coupon) return done(&quot;could not find coupon with name &quot;+ couponName);</td></tr><tr class="miss"><td class="line">147</td><td class="hits">0</td><td class="source">                return done(null, coupon);</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">151</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema,</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">        createCustomer: _createCustomer,</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">        updateCustomer: _updateCustomer</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">161</td><td class="hits">1</td><td class="source">module.exports = CustomerModel;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/email.js">/Users/warner/code/clipppr/primeloop-api/models/email.js</h2><div id="stats" class="high"><div class="percentage">90%</div><div class="sloc">40</div><div class="hits">36</div><div class="misses">4</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var EmailModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        mailgun = require(&quot;mailgun-js&quot;)(Settings.mailgun.api_key, Settings.mailgun.server),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        kaster = require(&quot;kaster-mongoose&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        mongoosastic = require(&quot;mongoosastic&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        mu = require(&quot;mu2&quot;);</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">    mu.root = __dirname + '/../templates';</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        created: {type: Date, &quot;default&quot;: Date.now},</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        from: {type: String, &quot;default&quot;: Settings.email.from},</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        to: {type: String},</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        cc: {type: String},</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        bcc: {type: String},</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        subject: {type: String},</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        text: {type: String},</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        html: String,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        template: {</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">            name: {type: String},</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">            contentType: {type: String, &quot;default&quot;: &quot;text&quot;},</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">            data: {type:Object, es_indexed:false}</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        opts: {</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">            deliverytime: {type: Date},</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">            testmode: {type: String, &quot;default&quot;: Settings.mailgun.testmode}</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        status: {type:Object, es_indexed:false}</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">37</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">    // _schema.plugin(kaster, {</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    //     name: &quot;Email&quot;,</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">    //     region: Settings.kaster.region,</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">    //     namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">    //     topic: Settings.kaster.topics.data</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">    // });</td></tr><tr class="hit"><td class="line">45</td><td class="hits">1</td><td class="source">    _schema.plugin(mongoosastic, {</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        index: Settings.elasticsearch.data_index,</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">        protocol: Settings.elasticsearch.protocol,</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">        host: Settings.elasticsearch.host,</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">        port: Settings.elasticsearch.port,</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">        auth: Settings.elasticsearch.user + &quot;:&quot; + Settings.elasticsearch.password</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"><td class="line">52</td><td class="hits">1</td><td class="source">    _schema.methods.send = function(done){</td></tr><tr class="hit"><td class="line">53</td><td class="hits">10</td><td class="source">        var</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">            data,</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">            that = this;</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">        // that.save();</td></tr><tr class="hit"><td class="line">58</td><td class="hits">10</td><td class="source">        var _sendIt = function(err){</td></tr><tr class="hit"><td class="line">59</td><td class="hits">10</td><td class="source">            if(err) return done(err);</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">61</td><td class="hits">10</td><td class="source">            data = that.toObject();</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">63</td><td class="hits">10</td><td class="source">            for(var i in data.opts){</td></tr><tr class="hit"><td class="line">64</td><td class="hits">10</td><td class="source">                data[&quot;o:&quot;+i] = that.opts[i];</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">            //Remove the fields we don't want to send</td></tr><tr class="hit"><td class="line">68</td><td class="hits">10</td><td class="source">            delete data.status;</td></tr><tr class="hit"><td class="line">69</td><td class="hits">10</td><td class="source">            delete data._id;</td></tr><tr class="hit"><td class="line">70</td><td class="hits">10</td><td class="source">            delete data.template;</td></tr><tr class="hit"><td class="line">71</td><td class="hits">10</td><td class="source">            delete data.opts;</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">73</td><td class="hits">10</td><td class="source">            mailgun.messages.send(data, function (err, response, body) {</td></tr><tr class="hit"><td class="line">74</td><td class="hits">10</td><td class="source">                if(err) {</td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="source">                    that.status = err;</td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="source">                    err.forEmail = that._id;</td></tr><tr class="hit"><td class="line">77</td><td class="hits">10</td><td class="source">                } else that.status = &quot;success&quot;;</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">79</td><td class="hits">10</td><td class="source">                that.save(done);</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">84</td><td class="hits">11</td><td class="source">        if((!that.text &amp;&amp; !that.html) &amp;&amp; that.template) that.renderTemplate(null,null,null, _sendIt);</td></tr><tr class="hit"><td class="line">85</td><td class="hits">9</td><td class="source">        else _sendIt();</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">    //TODO: Use a better templating solution</td></tr><tr class="hit"><td class="line">90</td><td class="hits">1</td><td class="source">    _schema.methods.renderTemplate = function(data, template, contentType, done){</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">92</td><td class="hits">10</td><td class="source">        var</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">            that = this;</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">95</td><td class="hits">10</td><td class="source">        that.template.name = template = template || that.template.name;</td></tr><tr class="hit"><td class="line">96</td><td class="hits">10</td><td class="source">        that.template.data = data = data || that.template.data;</td></tr><tr class="hit"><td class="line">97</td><td class="hits">10</td><td class="source">        that.template.contentType = contentType = contentType || that.template.contentType || &quot;text&quot;;</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">        // </td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">        // switch(template){</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">        //     case &quot;notebook_invite_new_user&quot;:</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">        //         that[contentType] =</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">        //             &quot;Hey &quot; + data.invitee.name +</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">        //             &quot;,\n\nYou've been invited to join Primeloop and track press with &quot; +</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">        //             data.user.name+&quot; in the &quot; + data.notebook.name +</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">        //             &quot; notebook.\n\nClick here to sign up: https://www.primeloop.com/invite/&quot; +</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">        //             data.invitee.invite + &quot;\n\n--\nIf you don't know &quot; + data.user.name +</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">        //             &quot;, or if you have any other questions or concerns about this notification from primeloop.com, please reply to let us know.&quot;;</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">        //     return done(null, that[contentType]);</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">        //     case &quot;notebook_invite&quot;:</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">        //         that[contentType] =</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">        //             &quot;Hey &quot; + data.invitee.name + &quot;,\n\n&quot; +</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">        //             data.user.name + &quot; has granted you access to the &quot; + data.notebook.name +</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">        //             &quot; notebook.\n\nCheck it out here: https://www.primeloop.com/notebooks/&quot; +</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">        //             data.notebook._id +</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">        //             &quot; \n\n--\nYou're receiving this notification from your account on primeloop.com. If you have any questions or concerns, reply to let us know.&quot;;</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">        //     return done(null, that[contentType]);</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">        //</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">        // }</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">125</td><td class="hits">10</td><td class="source">        var body = &quot;&quot;;</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">127</td><td class="hits">10</td><td class="source">        mu.compileAndRender(template, data)</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">        .on(&quot;data&quot;, function(chunk){</td></tr><tr class="hit"><td class="line">129</td><td class="hits">66</td><td class="source">            body += chunk.toString(&quot;utf8&quot;);</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">            // console.log(&quot;chunk:&quot;, chunk.toString(&quot;utf8&quot;));</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">        })</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">        .on(&quot;end&quot;, function(){</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">            // console.log(&quot;End Render&quot;)</td></tr><tr class="hit"><td class="line">134</td><td class="hits">10</td><td class="source">            that[contentType] = body;</td></tr><tr class="hit"><td class="line">135</td><td class="hits">10</td><td class="source">            return done(null, body);</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">        })</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">        .on (&quot;error&quot;, function(err){</td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="source">            console.log(&quot;Error Rendering&quot;, err.stack || err);</td></tr><tr class="miss"><td class="line">139</td><td class="hits">0</td><td class="source">            return done(err);</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">143</td><td class="hits">1</td><td class="source">    var _model = mongoose.model(&quot;Email&quot;, _schema);</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">145</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">153</td><td class="hits">1</td><td class="source">module.exports = EmailModel;</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/emailactivitylog.js">/Users/warner/code/clipppr/primeloop-api/models/emailactivitylog.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">8</div><div class="hits">8</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var EmailActivityLogModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        kaster = require(&quot;kaster-mongoose&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;);</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        email: {type: String},</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        user: {type: String, ref: &quot;User&quot;},</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        url: String,</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        action: String,</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        subject: String,</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        activityTime: {type: Date, &quot;default&quot;: Date.now}</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">21</td><td class="hits">1</td><td class="source">     _schema.plugin(kaster, {</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        name: &quot;EmailActivityLog&quot;,</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        region: Settings.kaster.region,</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        topic: Settings.kaster.topics.activity</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">28</td><td class="hits">1</td><td class="source">    var _model = mongoose.model(&quot;EmailActivityLog&quot;, _schema);</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">31</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">39</td><td class="hits">1</td><td class="source">module.exports = EmailActivityLogModel;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/notebook.js">/Users/warner/code/clipppr/primeloop-api/models/notebook.js</h2><div id="stats" class="low"><div class="percentage">37%</div><div class="sloc">325</div><div class="hits">122</div><div class="misses">203</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var NotebookModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        kaster = require(&quot;kaster-mongoose&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        mongoosastic = require(&quot;mongoosastic&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        redisq = require('redisq'),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        User = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/./user&quot;),</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        Clipp = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/./clipp&quot;),</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        Page = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/./page&quot;),</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        Moz = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../moz&quot;)(Settings.moz.access_id, Settings.moz.secret),</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        PermissionUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/permissions&quot;),</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        ArchiveUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/archive&quot;),</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        ObjectUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/objects&quot;),</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        ArrayUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/array&quot;),</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        Validations = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/validations&quot;),</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        TrackingUrl = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/./tracking_url&quot;);</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">21</td><td class="hits">1</td><td class="source">    var _users = {</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        user: {type: String, ref: &quot;User&quot;},</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        role: String,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        added: {type: Date, &quot;default&quot;: Date.now},</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        settings: {</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">            emails: {type: Boolean, &quot;default&quot;: true} //emails default to on</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">32</td><td class="hits">1</td><td class="source">    var _clipps = {</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        page: {type: String, ref: &quot;Page&quot;},</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        clipp: {type: String, ref: &quot;Clipp&quot;}</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">38</td><td class="hits">1</td><td class="source">    var _channelInfo = {</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">        name: String,</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">        url: { type: String, required: true, validate: Validations.url },</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">    //List of feeds that are auto-imported to suggested clipps</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">    //initially just RSS feeds but open for others later</td></tr><tr class="hit"><td class="line">46</td><td class="hits">1</td><td class="source">    var _suggestedImportFeed = {</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">        title: String,</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">        siteName: String,</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">        type: {type: String, default: 'rss'},</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">        lastUpdated: Date,</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">        lastImport: Date,</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">        valid: {type: Boolean, &quot;default&quot;: false},</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">        feedUrl: { type: String, required: true, validate: Validations.url },</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">        url: { type: String, validate: Validations.url },</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">        user: {type: String, ref: 'User'},</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">        errorMessages:[String]</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">60</td><td class="hits">1</td><td class="source">    var _campaign = {</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">        name: String,</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">        tags: [String],</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">        campaign_url: String,</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">        retarget_code: {type: String, sq_remove: true},</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">        retarget_type: String,</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">        enabled: {type: Boolean, &quot;default&quot;: true}</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">70</td><td class="hits">1</td><td class="source">    var _alertsTracking = {</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">        sites: [{ type: String, validate: Validations.url }],</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">        socialMedia:[{ type: String, validate: Validations.url }],</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">        keywords:[String]</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">76</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">        name: {type: String, required: true},</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">        anonymousAccess: {type: Boolean},</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">        users: [_users],</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">        created: {type: Date, &quot;default&quot;: Date.now},</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">        clipps: [_clipps],</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">        archivedClipps: [_clipps],</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">        enabled: {type: Boolean, &quot;default&quot;: false},</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">        demo: {type: Boolean, &quot;default&quot;: false},</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">        features: [String],</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">        trial: Number,</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">        trialStart: Date,</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">        type: {type: String},</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">        admin: {</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">            notes: String</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">        canReport: {&quot;default&quot;: false},</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">        google_analytics: {</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">            invites: [{type: String, ref: &quot;User&quot;}],</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">            goals: Array,</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">            keywords: [String],</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">            profileId: String,</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">            username: String,</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">            webPropertyId: String,</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">            accountId: String,</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">            gaCredentials: {type:Object, es_indexed:false}</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">        retarget: {</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">            campaigns: [_campaign]</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">        siteUrls:[{ type: String, validate: Validations.url }],</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">        notebookChannels:[_channelInfo],</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">        suggestedImportFeeds: [_suggestedImportFeed],</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">        suggestedActions: [{type: String, ref: &quot;SuggestedAction&quot;}],</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">        alertsTracking: _alertsTracking</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">114</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">116</td><td class="hits">1</td><td class="source">    _schema.plugin(mongoosastic, {</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">        index: Settings.elasticsearch.data_index,</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">        protocol: Settings.elasticsearch.protocol,</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">        host: Settings.elasticsearch.host,</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">        port: Settings.elasticsearch.port,</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">        auth: Settings.elasticsearch.user + &quot;:&quot; + Settings.elasticsearch.password</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">    // _schema.path(&quot;retarget.campaign.tags&quot;).set(function(tags){</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">    //     tags = tags.toString().split(&quot;,&quot;);</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">    //     for(var i in tags) tags[i] = tags[i].trim().replace(/ /g, &quot;-&quot;);</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">    //     return ArrayUtils.uniqueArray(tags);</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">    // });</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">130</td><td class="hits">1</td><td class="source">    _schema.virtual(&quot;alertsTracking.keyword&quot;).set(function(keyword){</td></tr><tr class="miss"><td class="line">131</td><td class="hits">0</td><td class="source">        if(!keyword) return;</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">133</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">            keywords = ArrayUtils.uniqueArray(keyword.toString().split(&quot;,&quot;));</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">136</td><td class="hits">0</td><td class="source">        for(var i = 0; i &lt; keywords.length; i++){</td></tr><tr class="miss"><td class="line">137</td><td class="hits">0</td><td class="source">            if(this.alertsTracking.keywords.indexOf(keywords[i]) &gt;= 0) keywords.splice(i,1);</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">140</td><td class="hits">0</td><td class="source">        this.alertsTracking.keywords = this.alertsTracking.keywords.concat(keywords);</td></tr><tr class="miss"><td class="line">141</td><td class="hits">0</td><td class="source">        this.markModified('keywords');</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">144</td><td class="hits">1</td><td class="source">    _schema.path(&quot;alertsTracking.keywords&quot;).set(function(keywords){</td></tr><tr class="miss"><td class="line">145</td><td class="hits">0</td><td class="source">        keywords = keywords.toString().split(&quot;,&quot;);</td></tr><tr class="miss"><td class="line">146</td><td class="hits">0</td><td class="source">        for(var i in keywords) keywords[i] = keywords[i].trim();</td></tr><tr class="miss"><td class="line">147</td><td class="hits">0</td><td class="source">        return ArrayUtils.uniqueArray(keywords);</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">150</td><td class="hits">1</td><td class="source">    _schema.post(&quot;save&quot;, function(){</td></tr><tr class="hit"><td class="line">151</td><td class="hits">55</td><td class="source">        var that = this, users = (this.users) ? this.users.toObject() : this.users;</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">154</td><td class="hits">55</td><td class="source">        if(that.google_analytics.username) {</td></tr><tr class="miss"><td class="line">155</td><td class="hits">0</td><td class="source">            User.Model.findOne({</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">                &quot;google_analytics.username&quot;: that.google_analytics.username</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">            .exec(function(err, user){</td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="source">                if(err) console.log(err);</td></tr><tr class="miss"><td class="line">160</td><td class="hits">0</td><td class="source">                if(!user) return;</td></tr><tr class="miss"><td class="line">161</td><td class="hits">0</td><td class="source">                if(!user.google_analytics) user.google_analytics = {};</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">163</td><td class="hits">0</td><td class="source">                var</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">                    connects = user.google_analytics.connections,</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">                    thatGA = that.google_analytics,</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">                    pushed = false;</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">168</td><td class="hits">0</td><td class="source">                for(var c = 0; c &lt; connects.length; c++){</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">170</td><td class="hits">0</td><td class="source">                    if(</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">                        connects[c].webPropertyId == thatGA.webPropertyId &amp;&amp;</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">                        connects[c].accountId == thatGA.accountId &amp;&amp;</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">                        connects[c].profileId == thatGA.profileId</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">                    ) {</td></tr><tr class="miss"><td class="line">175</td><td class="hits">0</td><td class="source">                        connects[c].notebooks.push(that._id);</td></tr><tr class="miss"><td class="line">176</td><td class="hits">0</td><td class="source">                        connects[c].notebooks = ArrayUtils.uniqueArray(connects[c].notebooks);</td></tr><tr class="miss"><td class="line">177</td><td class="hits">0</td><td class="source">                        pushed = true;</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">181</td><td class="hits">0</td><td class="source">                if(!pushed) connects.push({</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">                    accountId: thatGA.accountId,</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">                    webPropertyId: thatGA.webPropertyId,</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">                    profileId: thatGA.profileId,</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">                    notebooks: [that._id],</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">                    //store these so we connect multiple ga accounts</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">                    username: user.google_analytics.username,</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">                    gaCredentials: user.google_analytics.gaCredentials</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">191</td><td class="hits">0</td><td class="source">                user.markModified(&quot;google_analytics&quot;);</td></tr><tr class="miss"><td class="line">192</td><td class="hits">0</td><td class="source">                user.save(function(err){</td></tr><tr class="miss"><td class="line">193</td><td class="hits">0</td><td class="source">                    if(err) console.log(err);</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">201</td><td class="hits">1</td><td class="source">    _schema.methods.setFeatureSettingsForUsers = function(feature, done){</td></tr><tr class="miss"><td class="line">202</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">            notebook = this,</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">            len = notebook.users.length,</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source">            $set = {},</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source">            userSchema = new User.Model({}),</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">            userSetting = userSchema.settings.emails[feature],</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">            doneSavingUser = function(err){</td></tr><tr class="miss"><td class="line">209</td><td class="hits">0</td><td class="source">                if(err) console.log(err);</td></tr><tr class="miss"><td class="line">210</td><td class="hits">0</td><td class="source">                return --len || done();</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">            };</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">213</td><td class="hits">0</td><td class="source">        if(typeof userSetting === &quot;undefined&quot;) return done();</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">215</td><td class="hits">0</td><td class="source">        $set[&quot;settings.emails.&quot;+feature] = userSetting;</td></tr><tr class="miss"><td class="line">216</td><td class="hits">0</td><td class="source">        var query = {};</td></tr><tr class="miss"><td class="line">217</td><td class="hits">0</td><td class="source">        query[&quot;settings.emails.&quot;+feature] = {$exists: false};</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">219</td><td class="hits">0</td><td class="source">        notebook.users.map(function(user){</td></tr><tr class="miss"><td class="line">220</td><td class="hits">0</td><td class="source">            query._id = user.user;</td></tr><tr class="miss"><td class="line">221</td><td class="hits">0</td><td class="source">            User.Model.update(query, {</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">                $set: $set</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">            }, doneSavingUser);</td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">227</td><td class="hits">0</td><td class="source">        if(len &lt;= 0) return done();</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">229</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">230</td><td class="hits">1</td><td class="source">    _schema.methods.getPermissions = function(user){</td></tr><tr class="hit"><td class="line">231</td><td class="hits">42</td><td class="source">        var</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">            that = this,</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">            users = this.users,</td></tr><tr><td class="line">234</td><td class="hits"></td><td class="source">            user_id = user._id || user;</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">236</td><td class="hits">42</td><td class="source">        if(user_id === &quot;anonymous&quot; &amp;&amp; that.anonymousAccess === true){</td></tr><tr class="miss"><td class="line">237</td><td class="hits">0</td><td class="source">            return PermissionUtils.getNotebookPermissionsForRole(&quot;viewer&quot;);</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">240</td><td class="hits">42</td><td class="source">        for(var i in users){</td></tr><tr class="hit"><td class="line">241</td><td class="hits">104</td><td class="source">            if(</td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source">                (users[i].user &amp;&amp; users[i].user._id == user_id) ||</td></tr><tr><td class="line">243</td><td class="hits"></td><td class="source">                users[i].user == user_id</td></tr><tr class="hit"><td class="line">244</td><td class="hits">40</td><td class="source">            ) return PermissionUtils.getNotebookPermissionsForRole(users[i].role);</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">246</td><td class="hits">2</td><td class="source">        return [];</td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">249</td><td class="hits">1</td><td class="source">    _schema.methods.setAll = function(data, user) {</td></tr><tr class="hit"><td class="line">250</td><td class="hits">3</td><td class="source">        if(data.alertsTracking) {</td></tr><tr class="miss"><td class="line">251</td><td class="hits">0</td><td class="source">            if(data.alertsTracking.sites) {</td></tr><tr class="miss"><td class="line">252</td><td class="hits">0</td><td class="source">                for (var i = 0; i &lt; data.alertsTracking.sites.length; i++) {</td></tr><tr class="miss"><td class="line">253</td><td class="hits">0</td><td class="source">                    if(!this.alertsTracking) {</td></tr><tr class="miss"><td class="line">254</td><td class="hits">0</td><td class="source">                        this.alertsTracking = {sites: []};</td></tr><tr class="miss"><td class="line">255</td><td class="hits">0</td><td class="source">                    } else if(!this.alertsTracking.sites) {</td></tr><tr class="miss"><td class="line">256</td><td class="hits">0</td><td class="source">                        this.alertsTracking.sites = [];</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">258</td><td class="hits">0</td><td class="source">                    this.alertsTracking.sites.push(data.alertsTracking.sites[i]);</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">261</td><td class="hits">0</td><td class="source">            if(data.alertsTracking.socialMedia) {</td></tr><tr class="miss"><td class="line">262</td><td class="hits">0</td><td class="source">                for (var j = 0; j &lt; data.alertsTracking.socialMedia.length; j++) {</td></tr><tr class="miss"><td class="line">263</td><td class="hits">0</td><td class="source">                    if(!this.alertsTracking) {</td></tr><tr class="miss"><td class="line">264</td><td class="hits">0</td><td class="source">                        this.alertsTracking = {socialMedia: []};</td></tr><tr class="miss"><td class="line">265</td><td class="hits">0</td><td class="source">                    } else if(!this.alertsTracking.socialMedia) {</td></tr><tr class="miss"><td class="line">266</td><td class="hits">0</td><td class="source">                        this.alertsTracking.socialMedia = [];</td></tr><tr><td class="line">267</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">268</td><td class="hits">0</td><td class="source">                    this.alertsTracking.socialMedia.push(data.alertsTracking.socialMedia[j]);</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">271</td><td class="hits">0</td><td class="source">            if(data.alertsTracking.keywords) {</td></tr><tr class="miss"><td class="line">272</td><td class="hits">0</td><td class="source">                this.alertsTracking.keyword = data.alertsTracking.keywords;</td></tr><tr><td class="line">273</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">274</td><td class="hits">0</td><td class="source">            delete data.alertsTracking;</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">276</td><td class="hits">3</td><td class="source">        return ObjectUtils.copyAllProperties(data, this);</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">279</td><td class="hits">1</td><td class="source">    _schema.methods.inviteUser = function(user, done) {</td></tr><tr class="hit"><td class="line">280</td><td class="hits">8</td><td class="source">        var</td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source">            email = user.email,</td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source">            that = this;</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">284</td><td class="hits">8</td><td class="source">        email = (email &amp;&amp; email.toLowerCase) ? email.toLowerCase() : email;</td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">286</td><td class="hits">8</td><td class="source">        User.findOrInvite({</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source">            firstName: user.firstName,</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">            lastName: user.lastName,</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source">            email: email,</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source">            role: &quot;general&quot;</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source">        }, function(err, toUser, isNew){</td></tr><tr><td class="line">292</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">293</td><td class="hits">10</td><td class="source">            if(err) return done(err);</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">295</td><td class="hits">6</td><td class="source">            if(ArrayUtils.inArray(toUser._id, that.users, &quot;user&quot;) &lt; 0) {</td></tr><tr><td class="line">296</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">297</td><td class="hits">5</td><td class="source">                that.users.push({</td></tr><tr><td class="line">298</td><td class="hits"></td><td class="source">                    user: toUser,</td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source">                    role: user.role</td></tr><tr><td class="line">300</td><td class="hits"></td><td class="source">                });</td></tr><tr class="hit"><td class="line">301</td><td class="hits">5</td><td class="source">                that.markModified(&quot;users&quot;);</td></tr><tr><td class="line">302</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">303</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">304</td><td class="hits">6</td><td class="source">            return done(err, toUser, isNew);</td></tr><tr><td class="line">305</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">306</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">307</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">308</td><td class="hits">1</td><td class="source">    _schema.methods.removeUser = function(user, done){</td></tr><tr class="hit"><td class="line">309</td><td class="hits">1</td><td class="source">        var</td></tr><tr><td class="line">310</td><td class="hits"></td><td class="source">            notebook = this,</td></tr><tr><td class="line">311</td><td class="hits"></td><td class="source">            Page = mongoose.model(&quot;Page&quot;),</td></tr><tr><td class="line">312</td><td class="hits"></td><td class="source">            idx = ArrayUtils.inArray(user._id || user, notebook.users, &quot;user&quot;),</td></tr><tr><td class="line">313</td><td class="hits"></td><td class="source">            len = 0,</td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source">            saveNotebook = function(){</td></tr><tr class="hit"><td class="line">315</td><td class="hits">1</td><td class="source">                notebook.save(done);</td></tr><tr><td class="line">316</td><td class="hits"></td><td class="source">            };</td></tr><tr><td class="line">317</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">318</td><td class="hits">1</td><td class="source">        notebook.users.splice(idx, 1);</td></tr><tr><td class="line">319</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">320</td><td class="hits">1</td><td class="source">        notebook.populate(&quot;clipps.clipp&quot;, function(err, notebook){</td></tr><tr class="hit"><td class="line">321</td><td class="hits">1</td><td class="source">             var</td></tr><tr><td class="line">322</td><td class="hits"></td><td class="source">                clipps = notebook.clipps, //&quot;clipp.user param&quot;</td></tr><tr><td class="line">323</td><td class="hits"></td><td class="source">                users = notebook.users, //&quot;user&quot; param</td></tr><tr><td class="line">324</td><td class="hits"></td><td class="source">                user, idx, notifications, removeUsers = [], nidx,</td></tr><tr><td class="line">325</td><td class="hits"></td><td class="source">                _clippSaved = function(err, saved){</td></tr><tr class="miss"><td class="line">326</td><td class="hits">0</td><td class="source">                    process.nextTick(function(){</td></tr><tr class="miss"><td class="line">327</td><td class="hits">0</td><td class="source">                        return --len || saveNotebook();</td></tr><tr><td class="line">328</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">329</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">330</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">331</td><td class="hits">1</td><td class="source">                for(var i = 0; i &lt; clipps.length; i++){</td></tr><tr class="hit"><td class="line">332</td><td class="hits">7</td><td class="source">                    if(!clipps[i].clipp) continue;</td></tr><tr><td class="line">333</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">334</td><td class="hits">7</td><td class="source">                    notifications = clipps[i].clipp.notifications;</td></tr><tr><td class="line">335</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">336</td><td class="hits">7</td><td class="source">                    for(var j = 0; j &lt; notifications.length; j++){</td></tr><tr class="miss"><td class="line">337</td><td class="hits">0</td><td class="source">                        user = notifications[j].user;</td></tr><tr class="miss"><td class="line">338</td><td class="hits">0</td><td class="source">                        idx = ArrayUtils.inArray(user._id, users, &quot;user&quot;);</td></tr><tr><td class="line">339</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">340</td><td class="hits">0</td><td class="source">                        if(idx &lt; 0) {</td></tr><tr><td class="line">341</td><td class="hits"></td><td class="source">                            //remove em</td></tr><tr><td class="line">342</td><td class="hits"></td><td class="source">                            // console.log(&quot;Remove&quot;, user, &quot;from&quot;, clipps[i].clipp.title, &quot;on&quot;, notebook.name);</td></tr><tr class="miss"><td class="line">343</td><td class="hits">0</td><td class="source">                            removeUsers.push(user);</td></tr><tr><td class="line">344</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">345</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">346</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">347</td><td class="hits">7</td><td class="source">                    if(removeUsers.length &gt; 0){</td></tr><tr class="miss"><td class="line">348</td><td class="hits">0</td><td class="source">                        len++;</td></tr><tr class="miss"><td class="line">349</td><td class="hits">0</td><td class="source">                        for(var k = 0; k &lt; removeUsers.length; k++){</td></tr><tr class="miss"><td class="line">350</td><td class="hits">0</td><td class="source">                            nidx = ArrayUtils.inArray(removeUsers[k], clipps[i].clipp.notifications, &quot;user&quot;);</td></tr><tr class="miss"><td class="line">351</td><td class="hits">0</td><td class="source">                            clipps[i].clipp.notifications.splice(nidx, 1);</td></tr><tr><td class="line">352</td><td class="hits"></td><td class="source">                        }</td></tr><tr class="miss"><td class="line">353</td><td class="hits">0</td><td class="source">                        removeUsers = [];</td></tr><tr class="miss"><td class="line">354</td><td class="hits">0</td><td class="source">                        clipps[i].clipp.markModified(&quot;notifications&quot;);</td></tr><tr class="miss"><td class="line">355</td><td class="hits">0</td><td class="source">                        clipps[i].clipp.save(_clippSaved);</td></tr><tr><td class="line">356</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">357</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">358</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">359</td><td class="hits">2</td><td class="source">                if(len &lt;= 0) saveNotebook();</td></tr><tr><td class="line">360</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">361</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">362</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">363</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">364</td><td class="hits">1</td><td class="source">    _schema.methods.importUrls = function(urls, user, type, done){</td></tr><tr class="miss"><td class="line">365</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">366</td><td class="hits"></td><td class="source">            BatchImport = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/./batch_import&quot;),</td></tr><tr><td class="line">367</td><td class="hits"></td><td class="source">            SuggestedBatchImport = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/./suggested_batch_import&quot;);</td></tr><tr><td class="line">368</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">369</td><td class="hits">0</td><td class="source">        if(typeof user === &quot;function&quot;) {</td></tr><tr class="miss"><td class="line">370</td><td class="hits">0</td><td class="source">            done = user;</td></tr><tr class="miss"><td class="line">371</td><td class="hits">0</td><td class="source">            user = null;</td></tr><tr><td class="line">372</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">373</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">374</td><td class="hits">0</td><td class="source">        if(typeof type === &quot;function&quot;) {</td></tr><tr class="miss"><td class="line">375</td><td class="hits">0</td><td class="source">            done = type;</td></tr><tr class="miss"><td class="line">376</td><td class="hits">0</td><td class="source">            type = null;</td></tr><tr><td class="line">377</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">378</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">379</td><td class="hits">0</td><td class="source">        if(!type) type = &quot;clip&quot;;</td></tr><tr class="miss"><td class="line">380</td><td class="hits">0</td><td class="source">        type = type.toLowerCase();</td></tr><tr><td class="line">381</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">382</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">383</td><td class="hits"></td><td class="source">            notebook = this._id,</td></tr><tr><td class="line">384</td><td class="hits"></td><td class="source">            batch,</td></tr><tr><td class="line">385</td><td class="hits"></td><td class="source">            queue;</td></tr><tr><td class="line">386</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">387</td><td class="hits">0</td><td class="source">        switch(type){</td></tr><tr><td class="line">388</td><td class="hits"></td><td class="source">            case &quot;clip&quot;:</td></tr><tr class="miss"><td class="line">389</td><td class="hits">0</td><td class="source">                batch = new BatchImport.Model();</td></tr><tr class="miss"><td class="line">390</td><td class="hits">0</td><td class="source">                queue = Settings.jobs.link_import;</td></tr><tr class="miss"><td class="line">391</td><td class="hits">0</td><td class="source">            break;</td></tr><tr><td class="line">392</td><td class="hits"></td><td class="source">            case &quot;suggested&quot;:</td></tr><tr class="miss"><td class="line">393</td><td class="hits">0</td><td class="source">                batch = new SuggestedBatchImport.Model();</td></tr><tr class="miss"><td class="line">394</td><td class="hits">0</td><td class="source">                queue = Settings.jobs.suggested_link_import;</td></tr><tr class="miss"><td class="line">395</td><td class="hits">0</td><td class="source">            break;</td></tr><tr><td class="line">396</td><td class="hits"></td><td class="source">            default:</td></tr><tr class="miss"><td class="line">397</td><td class="hits">0</td><td class="source">                batch = new BatchImport.Model();</td></tr><tr class="miss"><td class="line">398</td><td class="hits">0</td><td class="source">                queue = Settings.jobs.link_import;</td></tr><tr class="miss"><td class="line">399</td><td class="hits">0</td><td class="source">            break;</td></tr><tr><td class="line">400</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">401</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">402</td><td class="hits">0</td><td class="source">        redisq.options({</td></tr><tr><td class="line">403</td><td class="hits"></td><td class="source">            &quot;redis&quot;: {</td></tr><tr><td class="line">404</td><td class="hits"></td><td class="source">                &quot;host&quot;: Settings.redisq.options.host,</td></tr><tr><td class="line">405</td><td class="hits"></td><td class="source">                &quot;port&quot;: Settings.redisq.options.port,</td></tr><tr><td class="line">406</td><td class="hits"></td><td class="source">                &quot;password&quot;: Settings.redisq.options.pass</td></tr><tr><td class="line">407</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">408</td><td class="hits"></td><td class="source">        });</td></tr><tr class="miss"><td class="line">409</td><td class="hits">0</td><td class="source">        var link_import_queue = redisq.queue(queue);</td></tr><tr><td class="line">410</td><td class="hits"></td><td class="source">        //assume that we've gotten this far with proper permissions since this method is not exposed publicly</td></tr><tr class="miss"><td class="line">411</td><td class="hits">0</td><td class="source">        if(!urls) return next(new restifyErrors.InvalidInputError(&quot;urls parameter is required&quot;));</td></tr><tr class="miss"><td class="line">412</td><td class="hits">0</td><td class="source">        if(!notebook) return next(new restify.ResourceNotFoundError(&quot;Notebook not found&quot;));</td></tr><tr><td class="line">413</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">414</td><td class="hits"></td><td class="source">        //only unique urls and non-empty lines</td></tr><tr class="miss"><td class="line">415</td><td class="hits">0</td><td class="source">        urls = ArrayUtils.nonEmptyElements(urls);</td></tr><tr class="miss"><td class="line">416</td><td class="hits">0</td><td class="source">        var validatedUrls = ArrayUtils.sanitizeAndValidateArray(urls);</td></tr><tr class="miss"><td class="line">417</td><td class="hits">0</td><td class="source">        urls = validatedUrls[0];</td></tr><tr class="miss"><td class="line">418</td><td class="hits">0</td><td class="source">        var badUrls = validatedUrls[1];</td></tr><tr class="miss"><td class="line">419</td><td class="hits">0</td><td class="source">        urls = ArrayUtils.uniqueArray(urls);</td></tr><tr><td class="line">420</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">421</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">422</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">423</td><td class="hits">0</td><td class="source">        var jobUrls = [];</td></tr><tr class="miss"><td class="line">424</td><td class="hits">0</td><td class="source">        var firstBatch;</td></tr><tr><td class="line">425</td><td class="hits"></td><td class="source">        //initially we only care about the first 5, the rest are going to get chunked and added as jobs</td></tr><tr class="miss"><td class="line">426</td><td class="hits">0</td><td class="source">        jobUrls = ArrayUtils.sliceIntoGroups(urls, 5);</td></tr><tr><td class="line">427</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">428</td><td class="hits"></td><td class="source">        //now that we have these created we just need to dump them into the batch</td></tr><tr class="miss"><td class="line">429</td><td class="hits">0</td><td class="source">        batch.notebook = notebook;</td></tr><tr class="miss"><td class="line">430</td><td class="hits">0</td><td class="source">        if(user) batch.user = user._id;</td></tr><tr class="miss"><td class="line">431</td><td class="hits">0</td><td class="source">        batch.jobSize = 5;</td></tr><tr class="miss"><td class="line">432</td><td class="hits">0</td><td class="source">        batch.numJobs = jobUrls.length;</td></tr><tr class="miss"><td class="line">433</td><td class="hits">0</td><td class="source">        batch.totalToBeProcessed = urls.length;</td></tr><tr class="miss"><td class="line">434</td><td class="hits">0</td><td class="source">        batch.totalProcessed = 0;</td></tr><tr class="miss"><td class="line">435</td><td class="hits">0</td><td class="source">        batch.problemUrls = badUrls;</td></tr><tr class="miss"><td class="line">436</td><td class="hits">0</td><td class="source">        for(var j in jobUrls) {</td></tr><tr class="miss"><td class="line">437</td><td class="hits">0</td><td class="source">            var job = jobUrls[j];</td></tr><tr class="miss"><td class="line">438</td><td class="hits">0</td><td class="source">            batch.jobs.push({urls: job});</td></tr><tr><td class="line">439</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">440</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">441</td><td class="hits">0</td><td class="source">        return batch.save(function(err, saved){</td></tr><tr><td class="line">442</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">443</td><td class="hits">0</td><td class="source">            for(var k = 0;  k&lt;saved.numJobs; k++) {</td></tr><tr class="miss"><td class="line">444</td><td class="hits">0</td><td class="source">                var job = {</td></tr><tr><td class="line">445</td><td class="hits"></td><td class="source">                    batch: saved._id,</td></tr><tr><td class="line">446</td><td class="hits"></td><td class="source">                    idx: k,</td></tr><tr><td class="line">447</td><td class="hits"></td><td class="source">                    id: saved.jobs[k]._id</td></tr><tr><td class="line">448</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">449</td><td class="hits"></td><td class="source">                //console.log(&quot;pushing job onto stack: &quot; + JSON.stringify(job));</td></tr><tr class="miss"><td class="line">450</td><td class="hits">0</td><td class="source">                link_import_queue.push(job, pushJob);</td></tr><tr><td class="line">451</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">452</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">453</td><td class="hits">0</td><td class="source">            var pushJob = function(err, res) {</td></tr><tr class="miss"><td class="line">454</td><td class="hits">0</td><td class="source">                if(err) console.log(&quot;Error scheduling link import job&quot;, err);</td></tr><tr><td class="line">455</td><td class="hits"></td><td class="source">            };</td></tr><tr><td class="line">456</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">457</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">458</td><td class="hits">0</td><td class="source">            return done(err, {</td></tr><tr><td class="line">459</td><td class="hits"></td><td class="source">                batch: batch._id,</td></tr><tr><td class="line">460</td><td class="hits"></td><td class="source">                count: urls.length</td></tr><tr><td class="line">461</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">462</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">463</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">464</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">465</td><td class="hits">1</td><td class="source">    _schema.methods.addShortUrl = function(clip_id, user_id, url, channel, done) {</td></tr><tr class="miss"><td class="line">466</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">467</td><td class="hits"></td><td class="source">            that = this,</td></tr><tr><td class="line">468</td><td class="hits"></td><td class="source">            retarget = false,</td></tr><tr><td class="line">469</td><td class="hits"></td><td class="source">            campaign = null;</td></tr><tr><td class="line">470</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">471</td><td class="hits">0</td><td class="source">        if(that.retarget &amp;&amp; that.retarget.campaign.tags){</td></tr><tr class="miss"><td class="line">472</td><td class="hits">0</td><td class="source">            Clipp.Model</td></tr><tr><td class="line">473</td><td class="hits"></td><td class="source">                .findOne({</td></tr><tr><td class="line">474</td><td class="hits"></td><td class="source">                    _id: clip_id,</td></tr><tr><td class="line">475</td><td class="hits"></td><td class="source">                    tags: {$in: that.retarget.campaign.tags}</td></tr><tr><td class="line">476</td><td class="hits"></td><td class="source">                }, &quot;tags&quot;)</td></tr><tr><td class="line">477</td><td class="hits"></td><td class="source">                .exec(function(err, clipp){</td></tr><tr class="miss"><td class="line">478</td><td class="hits">0</td><td class="source">                    if(err) return done(err);</td></tr><tr class="miss"><td class="line">479</td><td class="hits">0</td><td class="source">                    if(clipp) {</td></tr><tr class="miss"><td class="line">480</td><td class="hits">0</td><td class="source">                        retarget = true;</td></tr><tr class="miss"><td class="line">481</td><td class="hits">0</td><td class="source">                        campaign = this.retarget.campaign.campaign_url;</td></tr><tr><td class="line">482</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">483</td><td class="hits">0</td><td class="source">                    if(ArrayUtils.inArray(url, this.siteUrls) &lt; 0) {</td></tr><tr><td class="line">484</td><td class="hits"></td><td class="source">                        //add it and save the notebook</td></tr><tr class="miss"><td class="line">485</td><td class="hits">0</td><td class="source">                        that.siteUrls.push(url);</td></tr><tr class="miss"><td class="line">486</td><td class="hits">0</td><td class="source">                        that.markModified(&quot;siteUrls&quot;);</td></tr><tr class="miss"><td class="line">487</td><td class="hits">0</td><td class="source">                        that.save(function(err, saved){</td></tr><tr class="miss"><td class="line">488</td><td class="hits">0</td><td class="source">                            if(err) return done(err);</td></tr><tr class="miss"><td class="line">489</td><td class="hits">0</td><td class="source">                            TrackingUrl.generateUrl(user_id, clip_id, channel, url, retarget, campaign, function(er, shortUrl){</td></tr><tr class="miss"><td class="line">490</td><td class="hits">0</td><td class="source">                                return done(er, shortUrl);</td></tr><tr><td class="line">491</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">492</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">493</td><td class="hits"></td><td class="source">                    } else {</td></tr><tr class="miss"><td class="line">494</td><td class="hits">0</td><td class="source">                        TrackingUrl.generateUrl(user_id, clip_id, channel, url, retarget, campaign, function(er, shortUrl){</td></tr><tr class="miss"><td class="line">495</td><td class="hits">0</td><td class="source">                            return done(er, shortUrl);</td></tr><tr><td class="line">496</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">497</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">498</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">499</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">500</td><td class="hits">0</td><td class="source">            if(ArrayUtils.inArray(url, that.siteUrls) &lt; 0) {</td></tr><tr><td class="line">501</td><td class="hits"></td><td class="source">                //add it and save the notebook</td></tr><tr class="miss"><td class="line">502</td><td class="hits">0</td><td class="source">                that.siteUrls.push(url);</td></tr><tr class="miss"><td class="line">503</td><td class="hits">0</td><td class="source">                that.markModified(&quot;siteUrls&quot;);</td></tr><tr class="miss"><td class="line">504</td><td class="hits">0</td><td class="source">                that.save(function(err, saved){</td></tr><tr class="miss"><td class="line">505</td><td class="hits">0</td><td class="source">                    if(err) return done(err);</td></tr><tr class="miss"><td class="line">506</td><td class="hits">0</td><td class="source">                    TrackingUrl.generateUrl(user_id, clip_id, channel, url, retarget, campaign, function(er, shortUrl){</td></tr><tr class="miss"><td class="line">507</td><td class="hits">0</td><td class="source">                        return done(er, shortUrl);</td></tr><tr><td class="line">508</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">509</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">510</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="miss"><td class="line">511</td><td class="hits">0</td><td class="source">                TrackingUrl.generateUrl(user_id, clip_id, channel, url, retarget, campaign, function(err, shortUrl){</td></tr><tr class="miss"><td class="line">512</td><td class="hits">0</td><td class="source">                    return done(er, shortUrl);</td></tr><tr><td class="line">513</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">514</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">515</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">516</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">517</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">518</td><td class="hits">1</td><td class="source">    _schema.methods.addRetargetShortUrl = function(user_id, url, channel, done) {</td></tr><tr class="hit"><td class="line">519</td><td class="hits">4</td><td class="source">        var</td></tr><tr><td class="line">520</td><td class="hits"></td><td class="source">            that = this,</td></tr><tr><td class="line">521</td><td class="hits"></td><td class="source">            retarget = true,</td></tr><tr><td class="line">522</td><td class="hits"></td><td class="source">            retargetCampaigns = this.retarget.campaigns;</td></tr><tr><td class="line">523</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">524</td><td class="hits">4</td><td class="source">        if(ArrayUtils.inArray(url, that.siteUrls) &lt; 0) {</td></tr><tr><td class="line">525</td><td class="hits"></td><td class="source">            //add it and save the notebook</td></tr><tr class="hit"><td class="line">526</td><td class="hits">3</td><td class="source">            that.siteUrls.push(url);</td></tr><tr class="hit"><td class="line">527</td><td class="hits">3</td><td class="source">            that.markModified(&quot;siteUrls&quot;);</td></tr><tr class="hit"><td class="line">528</td><td class="hits">3</td><td class="source">            that.save(function(err, saved){</td></tr><tr class="hit"><td class="line">529</td><td class="hits">3</td><td class="source">                if(err) return done(err);</td></tr><tr class="hit"><td class="line">530</td><td class="hits">3</td><td class="source">                TrackingUrl.generateRetargetUrl(user_id, that._id, channel, url, retargetCampaigns, function(er, shortUrl){</td></tr><tr class="hit"><td class="line">531</td><td class="hits">3</td><td class="source">                    return done(er, shortUrl);</td></tr><tr><td class="line">532</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">533</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">534</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"><td class="line">535</td><td class="hits">1</td><td class="source">            TrackingUrl.generateRetargetUrl(user_id, that._id, channel, url, retargetCampaigns, function(err, shortUrl){</td></tr><tr class="hit"><td class="line">536</td><td class="hits">1</td><td class="source">                return done(err, shortUrl);</td></tr><tr><td class="line">537</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">538</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">539</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">540</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">541</td><td class="hits">1</td><td class="source">    var _prepareForOutput = function(notebook, user){</td></tr><tr class="hit"><td class="line">542</td><td class="hits">20</td><td class="source">        if(!notebook) return notebook;</td></tr><tr><td class="line">543</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">544</td><td class="hits">20</td><td class="source">        var permissions = notebook.getPermissions(user);</td></tr><tr><td class="line">545</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">546</td><td class="hits">20</td><td class="source">        notebook = (notebook.toObject) ? notebook.toObject() : notebook;</td></tr><tr class="hit"><td class="line">547</td><td class="hits">20</td><td class="source">        notebook.permissions = permissions;</td></tr><tr><td class="line">548</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">549</td><td class="hits">20</td><td class="source">        if(notebook.users) {</td></tr><tr class="hit"><td class="line">550</td><td class="hits">20</td><td class="source">            var roles = {</td></tr><tr><td class="line">551</td><td class="hits"></td><td class="source">                &quot;campaign_owner&quot;: 1,</td></tr><tr><td class="line">552</td><td class="hits"></td><td class="source">                &quot;campaign_manager&quot;: 2,</td></tr><tr><td class="line">553</td><td class="hits"></td><td class="source">                &quot;campaign_collaborator&quot;: 3,</td></tr><tr><td class="line">554</td><td class="hits"></td><td class="source">                &quot;general&quot;: 5</td></tr><tr><td class="line">555</td><td class="hits"></td><td class="source">            }, roleDiff = 0;</td></tr><tr><td class="line">556</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">557</td><td class="hits">20</td><td class="source">            notebook.users = notebook.users.sort(function(a,b){</td></tr><tr class="hit"><td class="line">558</td><td class="hits">16</td><td class="source">                roleDiff = roles[a.role] - roles[b.role];</td></tr><tr class="hit"><td class="line">559</td><td class="hits">25</td><td class="source">                if(roleDiff !== 0) return roleDiff;</td></tr><tr><td class="line">560</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">561</td><td class="hits">7</td><td class="source">                if(a.user &amp;&amp; a.user.firstName) {</td></tr><tr class="miss"><td class="line">562</td><td class="hits">0</td><td class="source">                    if(b.user &amp;&amp; b.user.firstName) {</td></tr><tr class="miss"><td class="line">563</td><td class="hits">0</td><td class="source">                        if(a.user.firstName.toLowerCase() &gt; b.user.firstName.toLowerCase()) return 1;</td></tr><tr class="miss"><td class="line">564</td><td class="hits">0</td><td class="source">                        else if (a.user.firstName.toLowerCase() &lt; b.user.firstName.toLowerCase()) return -1;</td></tr><tr class="miss"><td class="line">565</td><td class="hits">0</td><td class="source">                        else return 0;</td></tr><tr><td class="line">566</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">567</td><td class="hits">0</td><td class="source">                    return 1;</td></tr><tr><td class="line">568</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">569</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">570</td><td class="hits">7</td><td class="source">                return 0;</td></tr><tr><td class="line">571</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">572</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">573</td><td class="hits">20</td><td class="source">        delete notebook.archivedClipps;</td></tr><tr class="hit"><td class="line">574</td><td class="hits">29</td><td class="source">        if(notebook.__v) delete notebook.__v;</td></tr><tr class="hit"><td class="line">575</td><td class="hits">20</td><td class="source">        return notebook;</td></tr><tr><td class="line">576</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">577</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">578</td><td class="hits">1</td><td class="source">    var _prepareMultipleForOutput = function(notebook, user) {</td></tr><tr class="hit"><td class="line">579</td><td class="hits">2</td><td class="source">        for(var i in notebook){</td></tr><tr class="hit"><td class="line">580</td><td class="hits">6</td><td class="source">            notebook[i] = _prepareForOutput(notebook[i], user);</td></tr><tr><td class="line">581</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">582</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">583</td><td class="hits">2</td><td class="source">        return notebook;</td></tr><tr><td class="line">584</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">585</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">586</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">587</td><td class="hits">1</td><td class="source">    var</td></tr><tr><td class="line">588</td><td class="hits"></td><td class="source">        _model = mongoose.model(&quot;Notebook&quot;, _schema),</td></tr><tr><td class="line">589</td><td class="hits"></td><td class="source">        _archiveSchema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">590</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">591</td><td class="hits">1</td><td class="source">    _archiveSchema.plugin(kaster, {</td></tr><tr><td class="line">592</td><td class="hits"></td><td class="source">        name: &quot;NotebookArchive&quot;,</td></tr><tr><td class="line">593</td><td class="hits"></td><td class="source">        region: Settings.kaster.region,</td></tr><tr><td class="line">594</td><td class="hits"></td><td class="source">        namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">595</td><td class="hits"></td><td class="source">        topic: Settings.kaster.topics.data</td></tr><tr><td class="line">596</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">597</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">598</td><td class="hits">1</td><td class="source">    var _archiveModel = mongoose.model(&quot;Notebook.Archive&quot;, _archiveSchema);</td></tr><tr><td class="line">599</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">600</td><td class="hits">1</td><td class="source">    var _archive = function(notebook, done) {</td></tr><tr><td class="line">601</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">602</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">603</td><td class="hits"></td><td class="source">            clippIDs = ObjectUtils.toFlatArray(notebook.clipps, &quot;clipp&quot;),</td></tr><tr><td class="line">604</td><td class="hits"></td><td class="source">            archived = new _archiveModel(notebook.toObject());</td></tr><tr><td class="line">605</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">606</td><td class="hits">0</td><td class="source">        archived.save(function(err, saved){</td></tr><tr class="miss"><td class="line">607</td><td class="hits">0</td><td class="source">            if(err) return done(err);</td></tr><tr><td class="line">608</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">609</td><td class="hits"></td><td class="source">            //use utility method instead</td></tr><tr class="miss"><td class="line">610</td><td class="hits">0</td><td class="source">            ArchiveUtils.archiveClipps(clippIDs, function(err, data) {</td></tr><tr class="miss"><td class="line">611</td><td class="hits">0</td><td class="source">                if(err) return done(err);</td></tr><tr><td class="line">612</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">613</td><td class="hits">0</td><td class="source">                return notebook.remove(done);</td></tr><tr><td class="line">614</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">615</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">616</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">617</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">618</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">619</td><td class="hits">1</td><td class="source">    var _unarchive = function(notebook) {</td></tr><tr><td class="line">620</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">621</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">622</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">623</td><td class="hits"></td><td class="source">    //TODO: Make this admin query cleaner</td></tr><tr class="hit"><td class="line">624</td><td class="hits">1</td><td class="source">    var _populatePagesForUser = function(users, idx, query, done) {</td></tr><tr class="miss"><td class="line">625</td><td class="hits">0</td><td class="source">        var pages = [], user = users[idx], nidx;</td></tr><tr><td class="line">626</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">627</td><td class="hits">0</td><td class="source">        _model</td></tr><tr><td class="line">628</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">629</td><td class="hits"></td><td class="source">                &quot;users.user&quot;: user._id</td></tr><tr><td class="line">630</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">631</td><td class="hits"></td><td class="source">            .populate({</td></tr><tr><td class="line">632</td><td class="hits"></td><td class="source">                path: &quot;clipps.page&quot;,</td></tr><tr><td class="line">633</td><td class="hits"></td><td class="source">                match: query</td></tr><tr><td class="line">634</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">635</td><td class="hits"></td><td class="source">            .populate(&quot;clipps.clipp&quot;)</td></tr><tr><td class="line">636</td><td class="hits"></td><td class="source">            .exec(function(err, notebooks){</td></tr><tr class="miss"><td class="line">637</td><td class="hits">0</td><td class="source">                if(err) return done(err);</td></tr><tr><td class="line">638</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">639</td><td class="hits">0</td><td class="source">                for(var i in notebooks){</td></tr><tr><td class="line">640</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">641</td><td class="hits">0</td><td class="source">                    nidx = ArrayUtils.inArray(user._id, notebooks[i].users, &quot;user&quot;);</td></tr><tr><td class="line">642</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">643</td><td class="hits">0</td><td class="source">                    if(nidx &gt;= 0 &amp;&amp; notebooks[i].users[nidx].role == &quot;campaign_owner&quot;){</td></tr><tr><td class="line">644</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">645</td><td class="hits">0</td><td class="source">                        for(var j in notebooks[i].clipps) {</td></tr><tr><td class="line">646</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">647</td><td class="hits">0</td><td class="source">                            if(</td></tr><tr><td class="line">648</td><td class="hits"></td><td class="source">                                notebooks[i].clipps[j].clipp &amp;&amp;</td></tr><tr><td class="line">649</td><td class="hits"></td><td class="source">                                notebooks[i].clipps[j].clipp._id &amp;&amp;</td></tr><tr><td class="line">650</td><td class="hits"></td><td class="source">                                notebooks[i].clipps[j].page &amp;&amp;</td></tr><tr><td class="line">651</td><td class="hits"></td><td class="source">                                notebooks[i].clipps[j].page._id</td></tr><tr><td class="line">652</td><td class="hits"></td><td class="source">                            ){</td></tr><tr class="miss"><td class="line">653</td><td class="hits">0</td><td class="source">                                pages.push(notebooks[i].clipps[j].page);</td></tr><tr><td class="line">654</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">655</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">656</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">657</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">658</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">659</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">660</td><td class="hits">0</td><td class="source">                return done(err, pages, idx);</td></tr><tr><td class="line">661</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">662</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">663</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">664</td><td class="hits"></td><td class="source">    //TODO: Make this admin query cleaner</td></tr><tr class="hit"><td class="line">665</td><td class="hits">1</td><td class="source">    var _populatePagesForMultipleUsers = function(users, query, done){</td></tr><tr class="miss"><td class="line">666</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">667</td><td class="hits"></td><td class="source">            len = users.length;</td></tr><tr><td class="line">668</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">669</td><td class="hits">0</td><td class="source">        if(len &lt;= 0) done(null, users);</td></tr><tr><td class="line">670</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">671</td><td class="hits">0</td><td class="source">        var savePages = function(err, pages, idx) {</td></tr><tr class="miss"><td class="line">672</td><td class="hits">0</td><td class="source">            users[idx].pages = pages;</td></tr><tr class="miss"><td class="line">673</td><td class="hits">0</td><td class="source">            users[idx].pageCount = pages.length;</td></tr><tr class="miss"><td class="line">674</td><td class="hits">0</td><td class="source">            return --len || done(null, users);</td></tr><tr><td class="line">675</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">676</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">677</td><td class="hits">0</td><td class="source">        for(var i in users) _populatePagesForUser(users, i, query, savePages);</td></tr><tr><td class="line">678</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">679</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">680</td><td class="hits">1</td><td class="source">    var _getNotebooksForUser = function(user, done){</td></tr><tr class="hit"><td class="line">681</td><td class="hits">3</td><td class="source">        var</td></tr><tr><td class="line">682</td><td class="hits"></td><td class="source">            role, idx, settings, connect_analytics;</td></tr><tr><td class="line">683</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">684</td><td class="hits">3</td><td class="source">        user = user.toObject ? user.toObject() : user;</td></tr><tr><td class="line">685</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">686</td><td class="hits">3</td><td class="source">        _model</td></tr><tr><td class="line">687</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">688</td><td class="hits"></td><td class="source">                &quot;users.user&quot; : user._id</td></tr><tr><td class="line">689</td><td class="hits"></td><td class="source">            }, &quot;name users trial type google_analytics.invites features&quot;)</td></tr><tr><td class="line">690</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">691</td><td class="hits"></td><td class="source">            .sort(&quot;name&quot;)</td></tr><tr><td class="line">692</td><td class="hits"></td><td class="source">            .exec(function(err, notebooks){</td></tr><tr class="hit"><td class="line">693</td><td class="hits">3</td><td class="source">                if(err) return next(err);</td></tr><tr><td class="line">694</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">695</td><td class="hits">3</td><td class="source">                user.notebooks = [];</td></tr><tr><td class="line">696</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">697</td><td class="hits">3</td><td class="source">                for(var i in notebooks){</td></tr><tr class="hit"><td class="line">698</td><td class="hits">17</td><td class="source">                    idx = ArrayUtils.inArray(user._id, notebooks[i].users, &quot;user&quot;);</td></tr><tr class="hit"><td class="line">699</td><td class="hits">17</td><td class="source">                    role = notebooks[i].users[idx].role;</td></tr><tr class="hit"><td class="line">700</td><td class="hits">17</td><td class="source">                    settings = notebooks[i].users[idx].settings;</td></tr><tr><td class="line">701</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">702</td><td class="hits">17</td><td class="source">                    connect_analytics = (notebooks[i].google_analytics) ? ArrayUtils.inArray(user._id, notebooks[i].google_analytics.invites) &gt;= 0 : null;</td></tr><tr><td class="line">703</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">704</td><td class="hits">17</td><td class="source">                    user.notebooks.push({</td></tr><tr><td class="line">705</td><td class="hits"></td><td class="source">                        _id: notebooks[i]._id,</td></tr><tr><td class="line">706</td><td class="hits"></td><td class="source">                        role: role,</td></tr><tr><td class="line">707</td><td class="hits"></td><td class="source">                        name: notebooks[i].name,</td></tr><tr><td class="line">708</td><td class="hits"></td><td class="source">                        trial: notebooks[i].trial,</td></tr><tr><td class="line">709</td><td class="hits"></td><td class="source">                        type: notebooks[i].type,</td></tr><tr><td class="line">710</td><td class="hits"></td><td class="source">                        settings: settings,</td></tr><tr><td class="line">711</td><td class="hits"></td><td class="source">                        features: notebooks[i].features,</td></tr><tr><td class="line">712</td><td class="hits"></td><td class="source">                        connect_analytics: connect_analytics</td></tr><tr><td class="line">713</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">714</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">715</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">716</td><td class="hits">3</td><td class="source">                return done(err, user.notebooks);</td></tr><tr><td class="line">717</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">718</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">719</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">720</td><td class="hits">1</td><td class="source">    var _ownedNotebooks = function(user, done) {</td></tr><tr class="hit"><td class="line">721</td><td class="hits">1</td><td class="source">        var count = 0, idx;</td></tr><tr><td class="line">722</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">723</td><td class="hits">1</td><td class="source">        _model</td></tr><tr><td class="line">724</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">725</td><td class="hits"></td><td class="source">                &quot;users.user&quot;: user._id,</td></tr><tr><td class="line">726</td><td class="hits"></td><td class="source">                &quot;type&quot;: {$ne: &quot;free&quot;}</td></tr><tr><td class="line">727</td><td class="hits"></td><td class="source">            }, &quot;users&quot;)</td></tr><tr><td class="line">728</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">729</td><td class="hits"></td><td class="source">            .exec(function(err, nbs){</td></tr><tr class="hit"><td class="line">730</td><td class="hits">1</td><td class="source">                if(err) return done(err);</td></tr><tr><td class="line">731</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">732</td><td class="hits">1</td><td class="source">                for(var i in nbs) {</td></tr><tr class="hit"><td class="line">733</td><td class="hits">1</td><td class="source">                    idx = ArrayUtils.inArray(user._id, nbs[i].users, &quot;user&quot;);</td></tr><tr class="hit"><td class="line">734</td><td class="hits">1</td><td class="source">                    if(idx &gt;= 0 &amp;&amp; nbs[i].users[idx].role == &quot;campaign_owner&quot;) count++;</td></tr><tr><td class="line">735</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">736</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">737</td><td class="hits">1</td><td class="source">                return done(err, count);</td></tr><tr><td class="line">738</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">739</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">740</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">741</td><td class="hits">1</td><td class="source">    var _allOwnedNotebooks = function(user, done) {</td></tr><tr class="miss"><td class="line">742</td><td class="hits">0</td><td class="source">        var count = 0, idx;</td></tr><tr><td class="line">743</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">744</td><td class="hits">0</td><td class="source">        _model</td></tr><tr><td class="line">745</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">746</td><td class="hits"></td><td class="source">                &quot;users.user&quot;: user._id</td></tr><tr><td class="line">747</td><td class="hits"></td><td class="source">            }, &quot;users&quot;)</td></tr><tr><td class="line">748</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">749</td><td class="hits"></td><td class="source">            .exec(function(err, nbs){</td></tr><tr class="miss"><td class="line">750</td><td class="hits">0</td><td class="source">                if(err) return done(err);</td></tr><tr><td class="line">751</td><td class="hits"></td><td class="source">                // console.log(&quot;found %d notebooks for user %s&quot;, nbs.length, user.name);</td></tr><tr class="miss"><td class="line">752</td><td class="hits">0</td><td class="source">                for(var i in nbs) {</td></tr><tr class="miss"><td class="line">753</td><td class="hits">0</td><td class="source">                    idx = ArrayUtils.inArray(user._id, nbs[i].users, &quot;user&quot;);</td></tr><tr class="miss"><td class="line">754</td><td class="hits">0</td><td class="source">                    if(idx &gt;= 0 &amp;&amp; nbs[i].users[idx].role == &quot;campaign_owner&quot;) count++;</td></tr><tr><td class="line">755</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">756</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">757</td><td class="hits">0</td><td class="source">                return done(err, count);</td></tr><tr><td class="line">758</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">759</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">760</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">761</td><td class="hits">1</td><td class="source">    var _forOwnedNotebooks = function(user, action, done, select){</td></tr><tr class="miss"><td class="line">762</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">763</td><td class="hits"></td><td class="source">            len = 0,</td></tr><tr><td class="line">764</td><td class="hits"></td><td class="source">            idx;</td></tr><tr><td class="line">765</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">766</td><td class="hits">0</td><td class="source">        done = done || function(){};</td></tr><tr class="miss"><td class="line">767</td><td class="hits">0</td><td class="source">        select = select || &quot;&quot;;</td></tr><tr class="miss"><td class="line">768</td><td class="hits">0</td><td class="source">        select += &quot; users&quot;;</td></tr><tr><td class="line">769</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">770</td><td class="hits">0</td><td class="source">        _model</td></tr><tr><td class="line">771</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">772</td><td class="hits"></td><td class="source">                &quot;users.user&quot;: user._id</td></tr><tr><td class="line">773</td><td class="hits"></td><td class="source">            }, select)</td></tr><tr><td class="line">774</td><td class="hits"></td><td class="source">            .exec(function(err, nbs){</td></tr><tr class="miss"><td class="line">775</td><td class="hits">0</td><td class="source">                if(err) return done(err);</td></tr><tr><td class="line">776</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">777</td><td class="hits">0</td><td class="source">                if(!nbs || nbs.length &lt;= 0) return done();</td></tr><tr><td class="line">778</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">779</td><td class="hits">0</td><td class="source">                len = nbs.length;</td></tr><tr class="miss"><td class="line">780</td><td class="hits">0</td><td class="source">                var _onActionFinished = function(err){</td></tr><tr class="miss"><td class="line">781</td><td class="hits">0</td><td class="source">                    return --len || done(err);</td></tr><tr><td class="line">782</td><td class="hits"></td><td class="source">                };</td></tr><tr class="miss"><td class="line">783</td><td class="hits">0</td><td class="source">                for(var i in nbs) {</td></tr><tr class="miss"><td class="line">784</td><td class="hits">0</td><td class="source">                    idx = ArrayUtils.inArray(user._id, nbs[i].users, &quot;user&quot;);</td></tr><tr class="miss"><td class="line">785</td><td class="hits">0</td><td class="source">                    if(idx &gt;= 0 &amp;&amp; nbs[i].users[idx].role == &quot;campaign_owner&quot;){</td></tr><tr class="miss"><td class="line">786</td><td class="hits">0</td><td class="source">                        action(err, nbs[i], _onActionFinished);</td></tr><tr><td class="line">787</td><td class="hits"></td><td class="source">                    } else {</td></tr><tr class="miss"><td class="line">788</td><td class="hits">0</td><td class="source">                        return --len || done();</td></tr><tr><td class="line">789</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">790</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">791</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">792</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">793</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">794</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">795</td><td class="hits">1</td><td class="source">    var _getOwnerForNotebook = function(notebook, done){</td></tr><tr class="hit"><td class="line">796</td><td class="hits">1</td><td class="source">        _model</td></tr><tr><td class="line">797</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">798</td><td class="hits"></td><td class="source">                _id: notebook._id</td></tr><tr><td class="line">799</td><td class="hits"></td><td class="source">            }, &quot;users&quot;)</td></tr><tr><td class="line">800</td><td class="hits"></td><td class="source">            .populate(&quot;users.user&quot;)</td></tr><tr><td class="line">801</td><td class="hits"></td><td class="source">            .exec(function(err, nb){</td></tr><tr class="hit"><td class="line">802</td><td class="hits">1</td><td class="source">                if(err) return done(err);</td></tr><tr><td class="line">803</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">804</td><td class="hits">1</td><td class="source">                if(!nb) return done();</td></tr><tr class="hit"><td class="line">805</td><td class="hits">1</td><td class="source">                var users = nb.users;</td></tr><tr class="hit"><td class="line">806</td><td class="hits">1</td><td class="source">                if(!users || users.length &lt;= 0) return done();</td></tr><tr><td class="line">807</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">808</td><td class="hits">1</td><td class="source">                for(var i in users) {</td></tr><tr class="hit"><td class="line">809</td><td class="hits">2</td><td class="source">                    if(users[i].role == &quot;campaign_owner&quot;) return done(null, users[i]);</td></tr><tr><td class="line">810</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">811</td><td class="hits">0</td><td class="source">                return done(&quot;no owner found&quot;);</td></tr><tr><td class="line">812</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">813</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">814</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">815</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">816</td><td class="hits">1</td><td class="source">    var _getTagsForNotebook = function(notebookId, done) {</td></tr><tr class="miss"><td class="line">817</td><td class="hits">0</td><td class="source">        Clipp.Model</td></tr><tr><td class="line">818</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">819</td><td class="hits"></td><td class="source">                notebook: notebookId</td></tr><tr><td class="line">820</td><td class="hits"></td><td class="source">            },&quot;tags&quot;)</td></tr><tr><td class="line">821</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">822</td><td class="hits"></td><td class="source">            .exec(function(err, clipps){</td></tr><tr class="miss"><td class="line">823</td><td class="hits">0</td><td class="source">                if(err) return done(err);</td></tr><tr class="miss"><td class="line">824</td><td class="hits">0</td><td class="source">                var tags = [];</td></tr><tr><td class="line">825</td><td class="hits"></td><td class="source">                // console.log(&quot;found %d clipps %j&quot;, clipps.length, clipps);</td></tr><tr class="miss"><td class="line">826</td><td class="hits">0</td><td class="source">                for(var i = 0; i &lt; clipps.length; i++) {</td></tr><tr class="miss"><td class="line">827</td><td class="hits">0</td><td class="source">                    tags = tags.concat(clipps[i].tags);</td></tr><tr><td class="line">828</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">829</td><td class="hits">0</td><td class="source">                if(tags.length &gt; 0) {</td></tr><tr class="miss"><td class="line">830</td><td class="hits">0</td><td class="source">                    tags = ArrayUtils.nonEmptyElements(tags);</td></tr><tr class="miss"><td class="line">831</td><td class="hits">0</td><td class="source">                    tags = ArrayUtils.uniqueArray(tags);</td></tr><tr><td class="line">832</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">833</td><td class="hits">0</td><td class="source">                done(null, tags);</td></tr><tr><td class="line">834</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">835</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">836</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">837</td><td class="hits">1</td><td class="source">    var _getBacklinks = function(domain, done){</td></tr><tr class="miss"><td class="line">838</td><td class="hits">0</td><td class="source">        Moz.api({</td></tr><tr><td class="line">839</td><td class="hits"></td><td class="source">            resource: &quot;linkscape&quot;,</td></tr><tr><td class="line">840</td><td class="hits"></td><td class="source">            endpoint: &quot;links&quot;,</td></tr><tr><td class="line">841</td><td class="hits"></td><td class="source">            targetUrl: domain,</td></tr><tr><td class="line">842</td><td class="hits"></td><td class="source">            params: {</td></tr><tr><td class="line">843</td><td class="hits"></td><td class="source">                &quot;Scope&quot;: &quot;page_to_domain&quot;,</td></tr><tr><td class="line">844</td><td class="hits"></td><td class="source">                &quot;Sort&quot;: &quot;page_authority&quot;,</td></tr><tr><td class="line">845</td><td class="hits"></td><td class="source">                &quot;LinkCols&quot;: 8,</td></tr><tr><td class="line">846</td><td class="hits"></td><td class="source">                &quot;TargetCols&quot;: 4,</td></tr><tr><td class="line">847</td><td class="hits"></td><td class="source">                &quot;sourceCols&quot;: 4,</td></tr><tr><td class="line">848</td><td class="hits"></td><td class="source">                &quot;Filter&quot;: &quot;external&quot;</td></tr><tr><td class="line">849</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">850</td><td class="hits"></td><td class="source">        }, function(err, links){</td></tr><tr class="miss"><td class="line">851</td><td class="hits">0</td><td class="source">            if(links) links = links.map(function(link){</td></tr><tr class="miss"><td class="line">852</td><td class="hits">0</td><td class="source">                return &quot;http://&quot; + link.uu;</td></tr><tr><td class="line">853</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">854</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">855</td><td class="hits">0</td><td class="source">            return done(err, links);</td></tr><tr><td class="line">856</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">857</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">858</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">859</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">860</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">861</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">862</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema,</td></tr><tr><td class="line">863</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">864</td><td class="hits"></td><td class="source">        Archive: {</td></tr><tr><td class="line">865</td><td class="hits"></td><td class="source">            Model: _archiveModel,</td></tr><tr><td class="line">866</td><td class="hits"></td><td class="source">            Schema: _schema,</td></tr><tr><td class="line">867</td><td class="hits"></td><td class="source">            add: _archive,</td></tr><tr><td class="line">868</td><td class="hits"></td><td class="source">            remove: _unarchive</td></tr><tr><td class="line">869</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">870</td><td class="hits"></td><td class="source">        prepareForOutput: _prepareForOutput,</td></tr><tr><td class="line">871</td><td class="hits"></td><td class="source">        prepareMultipleForOutput: _prepareMultipleForOutput,</td></tr><tr><td class="line">872</td><td class="hits"></td><td class="source">        getNotebooksForUser: _getNotebooksForUser,</td></tr><tr><td class="line">873</td><td class="hits"></td><td class="source">        ownedNotebooks: _ownedNotebooks,</td></tr><tr><td class="line">874</td><td class="hits"></td><td class="source">        allOwnedNotebooks: _allOwnedNotebooks,</td></tr><tr><td class="line">875</td><td class="hits"></td><td class="source">        getOwnerForNotebook: _getOwnerForNotebook,</td></tr><tr><td class="line">876</td><td class="hits"></td><td class="source">        populatePagesForUser: _populatePagesForUser,</td></tr><tr><td class="line">877</td><td class="hits"></td><td class="source">        populatePagesForMultipleUsers: _populatePagesForMultipleUsers,</td></tr><tr><td class="line">878</td><td class="hits"></td><td class="source">        forOwnedNotebooks: _forOwnedNotebooks,</td></tr><tr><td class="line">879</td><td class="hits"></td><td class="source">        getTagsForNotebook: _getTagsForNotebook,</td></tr><tr><td class="line">880</td><td class="hits"></td><td class="source">        getBacklinks: _getBacklinks</td></tr><tr><td class="line">881</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">882</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">883</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">884</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">885</td><td class="hits">1</td><td class="source">module.exports = NotebookModel;</td></tr><tr><td class="line">886</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/page.js">/Users/warner/code/clipppr/primeloop-api/models/page.js</h2><div id="stats" class="medium"><div class="percentage">68%</div><div class="sloc">141</div><div class="hits">97</div><div class="misses">44</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var PageModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        ObjectUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/objects&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        request = require(&quot;request&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        kaster = require(&quot;kaster-mongoose&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        mongoosastic = require(&quot;mongoosastic&quot;),</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        cheerio = require(&quot;cheerio&quot;),</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        PageEngagement = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/./page_engagement&quot;),</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        Clipp = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/./clipp&quot;),</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        Validations = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/validations&quot;);</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">    PageEngagement.jsonSchema._id = {type: String, ref: &quot;Page.Engagement&quot;};</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">    var _timeAgo = function(hours){</td></tr><tr class="hit"><td class="line">19</td><td class="hits">2</td><td class="source">        return function(){</td></tr><tr class="hit"><td class="line">20</td><td class="hits">106</td><td class="source">            return new Date().getTime() - (1000*60*60*hours);</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">24</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        _id: { type: String, &quot;default&quot;: uuid.v4 },</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        url: { type: String, required: true, validate: Validations.url, index: true},</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        comments: {</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">            url: String,</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">            checksum: String,</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">            updated: {type: Date, index: true},</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">            service: String,</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">            status: {type: String, &quot;default&quot;: &quot;waiting&quot;}</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        urlHash: String,</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        title: String,</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">        engagement: PageEngagement.jsonSchema,</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        published: Date,</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        author: {</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">            name: String,</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">            twitter: String,</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">            email: String,</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">            website: String</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">        created: {type: Date, &quot;default&quot;: Date.now},</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">        engagementHistory: [{type: String, ref: &quot;Page.Engagement&quot;}],</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        clipps: [{type: String, ref: &quot;Clipp&quot;}],</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">        notes: String,</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">        updated: {</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">            social: {type: Date, &quot;default&quot;: _timeAgo(25), index: true},</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">            comment: {type: Date, &quot;default&quot;: _timeAgo(25), index: true}</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">        status: {</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">            social: {type: String, &quot;default&quot;: &quot;waiting&quot;},</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">            comment: {type: String, &quot;default&quot;: &quot;waiting&quot;}</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">        commentsClosed: {type: Boolean, &quot;default&quot;: false},</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">        noPubDate: {type:Boolean, &quot;default&quot;: false},</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">        commentSystem: {type: String},</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">        error:  {type: String, ref: &quot;Page.Error&quot;},</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">        paymentType: {type: String}</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">63</td><td class="hits">1</td><td class="source">    var _supportedSites = [</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">        &quot;reddit&quot;,</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">        &quot;twitter&quot;,</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">        &quot;tumblr&quot;,</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">        &quot;pinterest&quot;,</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">        &quot;vimeo&quot;,</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">        &quot;youtube&quot;,</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">        &quot;instagram&quot;</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">    ];</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">73</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">    // _schema.plugin(kaster, {</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">    //     name: &quot;Page&quot;,</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">    //     region: Settings.kaster.region,</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">    //     namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">    //     topic: Settings.kaster.topics.data</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">    // });</td></tr><tr class="hit"><td class="line">81</td><td class="hits">1</td><td class="source">    _schema.plugin(mongoosastic, {</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">        index: Settings.elasticsearch.data_index,</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">        protocol: Settings.elasticsearch.protocol,</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">        host: Settings.elasticsearch.host,</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">        port: Settings.elasticsearch.port,</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">        auth: Settings.elasticsearch.user + &quot;:&quot; + Settings.elasticsearch.password</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">    </td></tr><tr class="hit"><td class="line">89</td><td class="hits">1</td><td class="source">    _schema.index({&quot;url&quot;: 1, &quot;updated.comment&quot;: 1});</td></tr><tr class="hit"><td class="line">90</td><td class="hits">1</td><td class="source">    _schema.virtual(&quot;type&quot;).set(function(type) {</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">92</td><td class="hits">1</td><td class="source">        if(type == &quot;social&quot; || type == &quot;both&quot;){</td></tr><tr class="hit"><td class="line">93</td><td class="hits">1</td><td class="source">            this.updated.social = new Date();</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">96</td><td class="hits">1</td><td class="source">        if(type == &quot;comment&quot; || type == &quot;both&quot;) {</td></tr><tr class="miss"><td class="line">97</td><td class="hits">0</td><td class="source">            this.updated.comment = new Date();</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">101</td><td class="hits">1</td><td class="source">    _schema.methods.propagateChanges = function(done) {</td></tr><tr class="hit"><td class="line">102</td><td class="hits">45</td><td class="source">        var </td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">            Clipp = mongoose.model(&quot;Clipp&quot;),</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">            page = this,</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">            errors;</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">107</td><td class="hits">45</td><td class="source">        Clipp</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">            .find({_id: {$in: page.clipps}})</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">            .exec(function(err, clipps){</td></tr><tr class="hit"><td class="line">110</td><td class="hits">45</td><td class="source">                var len = clipps.length;</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">112</td><td class="hits">45</td><td class="source">                if(err) console.log(&quot;Error:&quot;, err);</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">114</td><td class="hits">45</td><td class="source">                var syncCallback = function(err, saved){</td></tr><tr class="hit"><td class="line">115</td><td class="hits">858</td><td class="source">                    if(!errors &amp;&amp; err) errors = [];</td></tr><tr class="hit"><td class="line">116</td><td class="hits">858</td><td class="source">                    if(err) errors.push(err);</td></tr><tr class="hit"><td class="line">117</td><td class="hits">858</td><td class="source">                    return --len || done(errors, clipps.length);</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">                };</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">120</td><td class="hits">45</td><td class="source">                for(var i in clipps) {</td></tr><tr class="hit"><td class="line">121</td><td class="hits">858</td><td class="source">                    clipps[i].syncPage(page, syncCallback);</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">126</td><td class="hits">1</td><td class="source">    var _calculateRank = function(points, date) {</td></tr><tr class="hit"><td class="line">127</td><td class="hits">45</td><td class="source">        if(typeof date == &quot;string&quot;) date = new Date(date);</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">129</td><td class="hits">45</td><td class="source">        var </td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">            days = parseFloat( (new Date().getTime() - date.getTime()) / (1000 * 60 * 60 * 24) ),</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">            gravity = 1.800000;</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">133</td><td class="hits">45</td><td class="source">        var rank = </td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">            parseFloat(points) / </td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">            parseFloat( Math.pow(parseFloat(days+2), gravity) );</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">138</td><td class="hits">45</td><td class="source">        return rank;</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">141</td><td class="hits">1</td><td class="source">    _schema.methods.updateRank = function(){</td></tr><tr class="hit"><td class="line">142</td><td class="hits">45</td><td class="source">        var </td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">            points = PageEngagement.totalPoints(this.engagement),</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">            date,</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">            rank;</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">            </td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">148</td><td class="hits">45</td><td class="source">        this.engagement.points.previous = this.engagement.points.current;</td></tr><tr class="hit"><td class="line">149</td><td class="hits">45</td><td class="source">        this.engagement.points.current = points;</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">151</td><td class="hits">45</td><td class="source">        if(this.engagement.points.current - this.engagement.points.previous &gt; 0) {</td></tr><tr class="hit"><td class="line">152</td><td class="hits">1</td><td class="source">            this.engagement.points.lastPointIncrease = new Date();</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">155</td><td class="hits">45</td><td class="source">        date = this.engagement.rank.lastPointIncrease || this.published || this.created;</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">157</td><td class="hits">45</td><td class="source">        rank = _calculateRank(points, date);</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">159</td><td class="hits">45</td><td class="source">        this.engagement.rank.change = parseFloat(rank) - parseFloat(this.engagement.rank.previous || 0.00000);</td></tr><tr class="hit"><td class="line">160</td><td class="hits">45</td><td class="source">        this.engagement.rank.previous = parseFloat(this.engagement.rank.current);</td></tr><tr class="hit"><td class="line">161</td><td class="hits">45</td><td class="source">        this.engagement.rank.current = parseFloat(rank);</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">163</td><td class="hits">45</td><td class="source">        return this.engagement;</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">    //TODO: Recalculate ranks</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">    // _schema.methods.recalculateRanks = function(){</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">    //     throw new {</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">    //         message: &quot;Not yet implemented&quot;</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">    //     };</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">    // };</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">    </td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">    //TODO: Make this recalculate the ranks</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">    // _schema.path(&quot;published&quot;).set(function(newDate){</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">    //     if(this.published != newDate) this.recalculateRanks(newDate);</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">    //     return newDate;</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">    // }); </td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">     * Sets All the properties given by the input object on the model instance</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">     * @param  {Object} data An object with all the properties to be set</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">     * @return {Object}      Reference to this</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">     */</td></tr><tr class="hit"><td class="line">185</td><td class="hits">1</td><td class="source">    _schema.methods.setAll = function(data) {</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">187</td><td class="hits">2</td><td class="source">        if(data.engagement &amp;&amp; !data.type) data.type = PageEngagement.getType(data.engagement);</td></tr><tr class="hit"><td class="line">188</td><td class="hits">1</td><td class="source">        if(data.type) {</td></tr><tr class="hit"><td class="line">189</td><td class="hits">2</td><td class="source">            if(!data.status) data.status = {};</td></tr><tr class="hit"><td class="line">190</td><td class="hits">1</td><td class="source">            data.status[data.type] = &quot;waiting&quot;;</td></tr><tr><td class="line">191</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">192</td><td class="hits">1</td><td class="source">        return ObjectUtils.copyAllProperties(data, this);</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">195</td><td class="hits">1</td><td class="source">    _schema.pre(&quot;save&quot;, function(next, done){</td></tr><tr class="hit"><td class="line">196</td><td class="hits">45</td><td class="source">        var </td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">            new_engagements = false,</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">            page = this,</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">            new_page_engagement = page.engagement.toObject();</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">        //Check for new engagements then log and save them</td></tr><tr class="hit"><td class="line">203</td><td class="hits">45</td><td class="source">        if(!ObjectUtils.isEmpty(new_page_engagement)){</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">            </td></tr><tr class="hit"><td class="line">205</td><td class="hits">45</td><td class="source">            this.updateRank(); </td></tr><tr class="hit"><td class="line">206</td><td class="hits">45</td><td class="source">            new_page_engagement = page.engagement.toObject();</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">            //We want to create a new id for this</td></tr><tr class="hit"><td class="line">209</td><td class="hits">45</td><td class="source">            delete new_page_engagement._id;</td></tr><tr class="hit"><td class="line">210</td><td class="hits">90</td><td class="source">            if(new_page_engagement.created) delete new_page_engagement.created;</td></tr><tr class="hit"><td class="line">211</td><td class="hits">45</td><td class="source">            var page_engagement = new PageEngagement.Model(new_page_engagement);</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">213</td><td class="hits">45</td><td class="source">            this.engagement._id = page_engagement._id;</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">215</td><td class="hits">45</td><td class="source">            this.engagementHistory.push(page_engagement.toObject());</td></tr><tr class="hit"><td class="line">216</td><td class="hits">45</td><td class="source">            this.markModified(&quot;engagementHistory&quot;);</td></tr><tr class="hit"><td class="line">217</td><td class="hits">45</td><td class="source">            page_engagement.site = _getSiteName(this.url);</td></tr><tr class="hit"><td class="line">218</td><td class="hits">45</td><td class="source">            page_engagement.save(function(err, saved){</td></tr><tr class="hit"><td class="line">219</td><td class="hits">45</td><td class="source">                if(err) console.log(&quot;error:&quot;, err);</td></tr><tr class="hit"><td class="line">220</td><td class="hits">45</td><td class="source">                page.engagement = saved;</td></tr><tr class="hit"><td class="line">221</td><td class="hits">45</td><td class="source">                return next();</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">227</td><td class="hits">1</td><td class="source">    var _getSiteName = function(url) {</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">229</td><td class="hits">45</td><td class="source">        var sites = [], obj = {};</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">231</td><td class="hits">45</td><td class="source">        for(var i in _supportedSites){ </td></tr><tr class="hit"><td class="line">232</td><td class="hits">315</td><td class="source">            obj[&quot;^&quot;+_supportedSites[i]] = _supportedSites[i]; //parent domains</td></tr><tr class="hit"><td class="line">233</td><td class="hits">315</td><td class="source">            obj[&quot;\\.&quot;+_supportedSites[i]] = _supportedSites[i]; //subdomains</td></tr><tr class="hit"><td class="line">234</td><td class="hits">315</td><td class="source">            sites.push(obj);</td></tr><tr class="hit"><td class="line">235</td><td class="hits">315</td><td class="source">            obj = {};</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">238</td><td class="hits">45</td><td class="source">        var </td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source">            parsedURL = require(&quot;url&quot;).parse(url),</td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source">            hostname = parsedURL.hostname.toLowerCase(),</td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source">            regex, matches;</td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">243</td><td class="hits">45</td><td class="source">        for(var j in sites) {</td></tr><tr class="hit"><td class="line">244</td><td class="hits">315</td><td class="source">            for(var key in sites[j]) {</td></tr><tr class="hit"><td class="line">245</td><td class="hits">630</td><td class="source">                regex = new RegExp(key);</td></tr><tr class="hit"><td class="line">246</td><td class="hits">630</td><td class="source">                matches = hostname.match(regex);</td></tr><tr class="hit"><td class="line">247</td><td class="hits">630</td><td class="source">                if(matches &amp;&amp; matches.length &gt; 0) return sites[j][key];</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">251</td><td class="hits">45</td><td class="source">        return &quot;unknown&quot;;</td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">253</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">254</td><td class="hits">1</td><td class="source">    _schema.post(&quot;save&quot;, function(page){</td></tr><tr class="hit"><td class="line">255</td><td class="hits">45</td><td class="source">        page.propagateChanges(function(err, result){</td></tr><tr class="hit"><td class="line">256</td><td class="hits">42</td><td class="source">            if(err) console.log(&quot;error:&quot;, err);</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source">            </td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">262</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source">        _model = mongoose.model(&quot;Page&quot;, _schema),</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source">        _archiveSchema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">266</td><td class="hits">1</td><td class="source">    _archiveSchema.plugin(kaster, {</td></tr><tr><td class="line">267</td><td class="hits"></td><td class="source">        name: &quot;PageArchive&quot;,</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source">        region: Settings.kaster.region,</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">        namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source">        topic: Settings.kaster.topics.data</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">272</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">273</td><td class="hits">1</td><td class="source">    var _archiveModel = mongoose.model(&quot;Page.Archive&quot;, _archiveSchema);</td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">275</td><td class="hits">1</td><td class="source">    var _archive = function(page, done) {</td></tr><tr class="hit"><td class="line">276</td><td class="hits">2</td><td class="source">        var archived = new _archiveModel(page.toObject());</td></tr><tr class="hit"><td class="line">277</td><td class="hits">2</td><td class="source">        archived.save(function(err, saved){</td></tr><tr class="hit"><td class="line">278</td><td class="hits">2</td><td class="source">            if(err) return done(err);</td></tr><tr><td class="line">279</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">280</td><td class="hits">2</td><td class="source">            return page.remove(done);    </td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source">        });  </td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">284</td><td class="hits">1</td><td class="source">    var _archiveMany = function(page_ids, done) {</td></tr><tr class="miss"><td class="line">285</td><td class="hits">0</td><td class="source">        _model</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source">                _id : { $in : page_ids }</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source">            .exec(function(err, pages){</td></tr><tr class="miss"><td class="line">291</td><td class="hits">0</td><td class="source">                if(err) return done(err);</td></tr><tr><td class="line">292</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">293</td><td class="hits">0</td><td class="source">                _archiveModel.create(pages, function(err){</td></tr><tr class="miss"><td class="line">294</td><td class="hits">0</td><td class="source">                    if(err) return done(err);</td></tr><tr><td class="line">295</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">296</td><td class="hits">0</td><td class="source">                    return _model.remove({</td></tr><tr><td class="line">297</td><td class="hits"></td><td class="source">                        _id : { $in : page_ids }</td></tr><tr><td class="line">298</td><td class="hits"></td><td class="source">                    }, done);</td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">300</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">301</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">302</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">303</td><td class="hits">1</td><td class="source">    var _unarchive = function(){</td></tr><tr><td class="line">304</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">305</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">306</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">307</td><td class="hits">1</td><td class="source">    var _getMetaInfo = function(url, log, done) {</td></tr><tr class="miss"><td class="line">308</td><td class="hits">0</td><td class="source">        if(!url || !url.trim()) {</td></tr><tr class="miss"><td class="line">309</td><td class="hits">0</td><td class="source">            if(log) log.error = &quot;No URL&quot;;</td></tr><tr class="miss"><td class="line">310</td><td class="hits">0</td><td class="source">            return done(&quot;No URL&quot;, {log:log});</td></tr><tr><td class="line">311</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">312</td><td class="hits"></td><td class="source">        //try Facebook first, fallback to manual request</td></tr><tr class="miss"><td class="line">313</td><td class="hits">0</td><td class="source">        request({</td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source">            url: &quot;https://graph.facebook.com?scrape=true&amp;id=&quot;+encodeURIComponent(url),</td></tr><tr><td class="line">315</td><td class="hits"></td><td class="source">            json: true,</td></tr><tr><td class="line">316</td><td class="hits"></td><td class="source">            method: &quot;POST&quot;</td></tr><tr><td class="line">317</td><td class="hits"></td><td class="source">        }, function(err, resp, body){</td></tr><tr class="miss"><td class="line">318</td><td class="hits">0</td><td class="source">            if(err || !body || body.error || !body.title) {</td></tr><tr><td class="line">319</td><td class="hits"></td><td class="source">                //Let's do something else here</td></tr><tr class="miss"><td class="line">320</td><td class="hits">0</td><td class="source">                return _getMetaInfoScrape(url, log, done);</td></tr><tr><td class="line">321</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">322</td><td class="hits">0</td><td class="source">            log.processedUrl = body.url;</td></tr><tr class="miss"><td class="line">323</td><td class="hits">0</td><td class="source">            body.log = log;</td></tr><tr class="miss"><td class="line">324</td><td class="hits">0</td><td class="source">            return done(err, body);</td></tr><tr><td class="line">325</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">326</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">327</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">328</td><td class="hits">1</td><td class="source">    var _getMetaInfoScrape = function(url, log, done) {</td></tr><tr class="miss"><td class="line">329</td><td class="hits">0</td><td class="source">        if(!url || !url.trim()) {</td></tr><tr class="miss"><td class="line">330</td><td class="hits">0</td><td class="source">            if(log) log.error = &quot;No URL&quot;;</td></tr><tr class="miss"><td class="line">331</td><td class="hits">0</td><td class="source">            return done(&quot;No URL&quot;, {log:log});</td></tr><tr><td class="line">332</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">333</td><td class="hits">0</td><td class="source">        var headers = {</td></tr><tr><td class="line">334</td><td class="hits"></td><td class="source">            'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/30.0.1599.69 Safari/537.36'</td></tr><tr><td class="line">335</td><td class="hits"></td><td class="source">        };</td></tr><tr class="miss"><td class="line">336</td><td class="hits">0</td><td class="source">        request({</td></tr><tr><td class="line">337</td><td class="hits"></td><td class="source">            url: url,</td></tr><tr><td class="line">338</td><td class="hits"></td><td class="source">            headers:headers,</td></tr><tr><td class="line">339</td><td class="hits"></td><td class="source">            method: &quot;GET&quot;,</td></tr><tr><td class="line">340</td><td class="hits"></td><td class="source">            timeout: 60000</td></tr><tr><td class="line">341</td><td class="hits"></td><td class="source">        }, function(err, resp, body){</td></tr><tr class="miss"><td class="line">342</td><td class="hits">0</td><td class="source">            if(err) {</td></tr><tr class="miss"><td class="line">343</td><td class="hits">0</td><td class="source">                console.log(&quot;error contacting site: &quot; + err, {url: url, statusCode: 500});</td></tr><tr class="miss"><td class="line">344</td><td class="hits">0</td><td class="source">                log.error = err;</td></tr><tr class="miss"><td class="line">345</td><td class="hits">0</td><td class="source">                return done(err, {url: url, statusCode: 500, log:log});  </td></tr><tr><td class="line">346</td><td class="hits"></td><td class="source">            } </td></tr><tr><td class="line">347</td><td class="hits"></td><td class="source">            //console.log(&quot;retrieved: &quot; + JSON.stringify(resp.headers) + &quot;: url : &quot; + resp.url);</td></tr><tr class="miss"><td class="line">348</td><td class="hits">0</td><td class="source">            if(resp.statusCode &gt;= 400) {</td></tr><tr class="miss"><td class="line">349</td><td class="hits">0</td><td class="source">                log.error = &quot;Problem with response code &quot; + resp.statusCode + &quot; for url &quot; + url;</td></tr><tr class="miss"><td class="line">350</td><td class="hits">0</td><td class="source">                return done(&quot;Problem with response code &quot; + resp.statusCode + &quot; for url &quot; + url, {url: url, statusCode: resp.statusCode, log:log});</td></tr><tr><td class="line">351</td><td class="hits"></td><td class="source">            } </td></tr><tr class="miss"><td class="line">352</td><td class="hits">0</td><td class="source">            if(resp.headers[&quot;content-type&quot;].toLowerCase().indexOf(&quot;text/html&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">353</td><td class="hits">0</td><td class="source">                log.info = &quot;Not HTML [&quot; +resp.headers[&quot;content-type&quot;].toLowerCase() +&quot;]&quot;;</td></tr><tr class="miss"><td class="line">354</td><td class="hits">0</td><td class="source">                return done(null, { url: url, log:log});</td></tr><tr><td class="line">355</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">356</td><td class="hits"></td><td class="source">            </td></tr><tr><td class="line">357</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">358</td><td class="hits">0</td><td class="source">            var </td></tr><tr><td class="line">359</td><td class="hits"></td><td class="source">                $ = cheerio.load(body),</td></tr><tr><td class="line">360</td><td class="hits"></td><td class="source">                data = {};</td></tr><tr class="miss"><td class="line">361</td><td class="hits">0</td><td class="source">            data.title = $(&quot;title&quot;).text().replace(/(\r\n|\n|\r)/gm,&quot; &quot;).trim();</td></tr><tr class="miss"><td class="line">362</td><td class="hits">0</td><td class="source">            data.url =  $(&quot;meta[property='og:url']&quot;).attr(&quot;content&quot;) || $(&quot;link[rel=canonical]&quot;).attr(&quot;href&quot;) || url;</td></tr><tr><td class="line">363</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">364</td><td class="hits">0</td><td class="source">            try {</td></tr><tr class="miss"><td class="line">365</td><td class="hits">0</td><td class="source">                Validations.checkUrl(data.url);</td></tr><tr><td class="line">366</td><td class="hits"></td><td class="source">            } catch (e) {</td></tr><tr class="miss"><td class="line">367</td><td class="hits">0</td><td class="source">                data.url = url;</td></tr><tr><td class="line">368</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">369</td><td class="hits">0</td><td class="source">            data.description = _decodeHTML($,$(&quot;meta[property='og:description']&quot;).attr(&quot;content&quot;)) || _decodeHTML($,$(&quot;meta[name=description]&quot;).attr(&quot;content&quot;)) || null;</td></tr><tr class="miss"><td class="line">370</td><td class="hits">0</td><td class="source">            data.site_name = _decodeHTML($,$(&quot;meta[property='og:site_name']&quot;).attr(&quot;content&quot;)) || null;</td></tr><tr class="miss"><td class="line">371</td><td class="hits">0</td><td class="source">            log.processedUrl = data.url;</td></tr><tr class="miss"><td class="line">372</td><td class="hits">0</td><td class="source">            data.log = log;</td></tr><tr class="miss"><td class="line">373</td><td class="hits">0</td><td class="source">            return done(null, data);</td></tr><tr><td class="line">374</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">375</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">376</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">377</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">378</td><td class="hits">1</td><td class="source">    var _decodeHTML = function($, html) {</td></tr><tr><td class="line">379</td><td class="hits"></td><td class="source">        //console.log(&quot;calling decode html&quot;);</td></tr><tr class="miss"><td class="line">380</td><td class="hits">0</td><td class="source">        var ht = $('&lt;div/&gt;').html(html);</td></tr><tr class="miss"><td class="line">381</td><td class="hits">0</td><td class="source">        if(ht.text) return ht.text();</td></tr><tr class="miss"><td class="line">382</td><td class="hits">0</td><td class="source">        return ht;</td></tr><tr><td class="line">383</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">384</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">385</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">386</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">387</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">388</td><td class="hits"></td><td class="source">        Archive: {</td></tr><tr><td class="line">389</td><td class="hits"></td><td class="source">            Model: _archiveModel,</td></tr><tr><td class="line">390</td><td class="hits"></td><td class="source">            Schema: _schema,</td></tr><tr><td class="line">391</td><td class="hits"></td><td class="source">            add: _archive,</td></tr><tr><td class="line">392</td><td class="hits"></td><td class="source">            addMany: _archiveMany,</td></tr><tr><td class="line">393</td><td class="hits"></td><td class="source">            remove: _unarchive</td></tr><tr><td class="line">394</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">395</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema,</td></tr><tr><td class="line">396</td><td class="hits"></td><td class="source">        getSiteName: _getSiteName,</td></tr><tr><td class="line">397</td><td class="hits"></td><td class="source">        calculateRank: _calculateRank,</td></tr><tr><td class="line">398</td><td class="hits"></td><td class="source">        getMetaInfo: _getMetaInfo,</td></tr><tr><td class="line">399</td><td class="hits"></td><td class="source">        getMetaInfoScrape: _getMetaInfoScrape</td></tr><tr><td class="line">400</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">401</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">402</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">403</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">404</td><td class="hits">1</td><td class="source">module.exports = PageModel;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/page_engagement.js">/Users/warner/code/clipppr/primeloop-api/models/page_engagement.js</h2><div id="stats" class="high"><div class="percentage">88%</div><div class="sloc">27</div><div class="hits">24</div><div class="misses">3</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var PageEngagementModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        kaster = require(&quot;kaster-mongoose&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        mongoosastic = require(&quot;mongoosastic&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;);</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        comments: Number,</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        facebook: Number,</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        twitter: Number,</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        linkedin: Number,</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        googleplus: Number,</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        stumbleupon: Number,</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        pinterest: Number, </td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        reddit: Number,</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        native_count: Number,</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        site: String,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        service: String,</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        notes: String,</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        rank: {</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">            current: Number,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">            previous: Number,</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">            change: Number</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        points: {</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">            current: Number,</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">            previous: Number,</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">            lastPointIncrease: Date</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        createdBy: {type: String, ref: &quot;User&quot;},</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        created: {type: Date, &quot;default&quot;: Date.now}</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">38</td><td class="hits">1</td><td class="source">    var _pointFilter = [</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">        &quot;facebook&quot;,</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">        &quot;twitter&quot;,</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">        &quot;linkedin&quot;,</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">        &quot;googleplus&quot;,</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">        &quot;stumbleupon&quot;,</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">        &quot;pinterest&quot;,</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">        &quot;reddit&quot;,</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        &quot;comments&quot;,</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">        &quot;native_count&quot;</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">    ];</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">50</td><td class="hits">1</td><td class="source">    var _socialType = [</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">        &quot;facebook&quot;,</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">        &quot;twitter&quot;,</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">        &quot;linkedin&quot;,</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">        &quot;googleplus&quot;,</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">        &quot;stumbleupon&quot;,</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">        &quot;reddit&quot;,</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">        &quot;native_count&quot;</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">    ];</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">60</td><td class="hits">1</td><td class="source">    var _commentType = [</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">        &quot;comments&quot;</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">    ];</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">64</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">    // _schema.plugin(kaster, {</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">    //     name: &quot;PageEngagement&quot;,</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">    //     region: Settings.kaster.region,</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">    //     namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">    //     topic: Settings.kaster.topics.data</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">    // });</td></tr><tr class="hit"><td class="line">72</td><td class="hits">1</td><td class="source">    _schema.plugin(mongoosastic, {</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">        index: Settings.elasticsearch.data_index,</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">        protocol: Settings.elasticsearch.protocol,</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">        host: Settings.elasticsearch.host,</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">        port: Settings.elasticsearch.port,</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">        auth: Settings.elasticsearch.user + &quot;:&quot; + Settings.elasticsearch.password</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"><td class="line">79</td><td class="hits">1</td><td class="source">    var _engagementDifferences = function(old_engagement, new_engagement) {</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">81</td><td class="hits">858</td><td class="source">        return {</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">            comments: (new_engagement.comments || old_engagement.comments) ? parseInt(new_engagement.comments, 10) - parseInt(old_engagement.comments || 0, 10) : null,</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">            facebook: (new_engagement.facebook || old_engagement.facebook ) ? parseInt(new_engagement.facebook, 10) - parseInt(old_engagement.facebook || 0, 10) : null,</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">            twitter: (new_engagement.twitter || old_engagement.twitter ) ? parseInt(new_engagement.twitter, 10) - parseInt(old_engagement.twitter || 0, 10) : null,</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">            linkedin: (new_engagement.linkedin || old_engagement.linkedin ) ? parseInt(new_engagement.linkedin, 10) - parseInt(old_engagement.linkedin || 0, 10) : null,</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">            googleplus: (new_engagement.googleplus || old_engagement.googleplus ) ? parseInt(new_engagement.googleplus, 10) - parseInt(old_engagement.googleplus || 0, 10) : null,</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">            stumbleupon: (new_engagement.stumbleupon || old_engagement.stumbleupon ) ? parseInt(new_engagement.stumbleupon, 10) - parseInt(old_engagement.stumbleupon || 0, 10) : null,</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">            pinterest: (new_engagement.pinterest || old_engagement.pinterest ) ? parseInt(new_engagement.pinterest, 10) - parseInt(old_engagement.pinterest || 0, 10) : null,</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">            native_count: (new_engagement.native_count || old_engagement.native_count ) ? parseInt(new_engagement.native_count, 10) - parseInt(old_engagement.native_count || 0, 10) : null,</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">            reddit: (new_engagement.reddit || old_engagement.reddit ) ? parseInt(new_engagement.reddit, 10) - parseInt(old_engagement.reddit || 0, 10) : null</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">94</td><td class="hits">1</td><td class="source">    var _totalPoints = function(engagement) {</td></tr><tr class="hit"><td class="line">95</td><td class="hits">45</td><td class="source">        var points = 0;</td></tr><tr class="hit"><td class="line">96</td><td class="hits">45</td><td class="source">        for(var i in _pointFilter) {</td></tr><tr class="hit"><td class="line">97</td><td class="hits">406</td><td class="source">            if(engagement[_pointFilter[i]]) points += parseInt(engagement[_pointFilter[i]] || 0, 10);</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">99</td><td class="hits">45</td><td class="source">        return points;</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">102</td><td class="hits">1</td><td class="source">    var _getType = function(engagement){</td></tr><tr class="hit"><td class="line">103</td><td class="hits">1</td><td class="source">        var </td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">            social = false, </td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">            comment = false; </td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">107</td><td class="hits">1</td><td class="source">        for(var i in engagement) {</td></tr><tr class="hit"><td class="line">108</td><td class="hits">2</td><td class="source">            if(_socialType.indexOf(i) &gt;= 0 &amp;&amp; engagement[i]) social = true;</td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="source">            else if(_commentType.indexOf(i) &gt;= 0 &amp;&amp; engagement[i]) comment = true;</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">111</td><td class="hits">1</td><td class="source">            if(comment &amp;&amp; social) return &quot;both&quot;;</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">114</td><td class="hits">2</td><td class="source">        if(social) return &quot;social&quot;;</td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="source">        if(comment) return &quot;comment&quot;;</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="source">        return &quot;other&quot;;</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">120</td><td class="hits">1</td><td class="source">    var _model = mongoose.model(&quot;Page.Engagement&quot;, _schema);</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">122</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema,</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">        engagementDifferences: _engagementDifferences,</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">        totalPoints: _totalPoints,</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">        getType: _getType,</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">        pointFilter: _pointFilter</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">133</td><td class="hits">1</td><td class="source">module.exports = PageEngagementModel;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/page_error.js">/Users/warner/code/clipppr/primeloop-api/models/page_error.js</h2><div id="stats" class="high"><div class="percentage">88%</div><div class="sloc">25</div><div class="hits">22</div><div class="misses">3</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var PageErrorModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        kaster = require(&quot;kaster-mongoose&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        mongoosastic = require(&quot;mongoosastic&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        ObjectUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/objects&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        Page = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/./page&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;);</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        error: String,</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        rawError: String,</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        errorType: String,</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        page: {type: String, ref: &quot;Page&quot;},</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        reviewedBy: {type: String, ref: &quot;User&quot;},</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        created: {type: Date, &quot;default&quot;: Date.now},</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        reviewed: {type: Boolean, &quot;default&quot;: false},</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        reviewedDate: {type: Date, &quot;default&quot;: null},</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        notes: String</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">25</td><td class="hits">1</td><td class="source">    var _errorTypeFilter = [</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        &quot;http_error&quot;,</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        &quot;request_timeout&quot;,</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        &quot;scraping_problem&quot;,</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        &quot;other&quot;</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    ];</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">    </td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">34</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">    // _schema.plugin(kaster, {</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">    //     name: &quot;PageError&quot;,</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">    //     region: Settings.kaster.region,</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">    //     namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    //     topic: Settings.kaster.topics.data</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">    // });</td></tr><tr class="hit"><td class="line">42</td><td class="hits">1</td><td class="source">    _schema.plugin(mongoosastic, {</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">        index: Settings.elasticsearch.data_index,</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">        protocol: Settings.elasticsearch.protocol,</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">        host: Settings.elasticsearch.host,</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        port: Settings.elasticsearch.port,</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">        auth: Settings.elasticsearch.user + &quot;:&quot; + Settings.elasticsearch.password</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">     * Saves the page with the new error once completed</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">     */</td></tr><tr class="hit"><td class="line">53</td><td class="hits">1</td><td class="source">    _schema.post(&quot;save&quot;, function(pageError){</td></tr><tr class="hit"><td class="line">54</td><td class="hits">4</td><td class="source">        Page = mongoose.model(&quot;Page&quot;);</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">56</td><td class="hits">4</td><td class="source">        if(pageError.page) {</td></tr><tr class="hit"><td class="line">57</td><td class="hits">4</td><td class="source">            Page</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">                .findOne({_id: pageError.page})</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">                .exec(function(err, page) {</td></tr><tr class="hit"><td class="line">60</td><td class="hits">4</td><td class="source">                    if(err) console.log(&quot;Error:&quot;, err);</td></tr><tr class="hit"><td class="line">61</td><td class="hits">4</td><td class="source">                    if(page) {</td></tr><tr class="hit"><td class="line">62</td><td class="hits">2</td><td class="source">                        if(!pageError.reviewed &amp;&amp; page.error !=pageError._id) {</td></tr><tr class="hit"><td class="line">63</td><td class="hits">1</td><td class="source">                            page.error = pageError._id;</td></tr><tr class="hit"><td class="line">64</td><td class="hits">1</td><td class="source">                            page.markModified(&quot;error&quot;);</td></tr><tr class="hit"><td class="line">65</td><td class="hits">1</td><td class="source">                        } else if(pageError.reviewed &amp;&amp; page.error == pageError._id) {</td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">                            page.error = null;</td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="source">                            page.markModified(&quot;error&quot;);</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">                        </td></tr><tr class="hit"><td class="line">70</td><td class="hits">2</td><td class="source">                        page.save(function(err, saved) {</td></tr><tr class="hit"><td class="line">71</td><td class="hits">2</td><td class="source">                            if(err) console.log(&quot;Error:&quot;, err);</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">                    } </td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">                    </td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">     * Sets All the properties given by the input object on the model instance</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">     * @param  {Object} data An object with all the properties to be set</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">     * @return {Object}      Reference to this</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">     */</td></tr><tr class="hit"><td class="line">84</td><td class="hits">1</td><td class="source">    _schema.methods.setAll = function(data) {</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="source">        return ObjectUtils.copyAllProperties(data, this);</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">    </td></tr><tr class="hit"><td class="line">89</td><td class="hits">1</td><td class="source">    var _model = mongoose.model(&quot;Page.Error&quot;, _schema);</td></tr><tr class="hit"><td class="line">90</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">97</td><td class="hits">1</td><td class="source">module.exports = PageErrorModel;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/payment.js">/Users/warner/code/clipppr/primeloop-api/models/payment.js</h2><div id="stats" class="low"><div class="percentage">25%</div><div class="sloc">51</div><div class="hits">13</div><div class="misses">38</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var Payment = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        stripe = require(&quot;stripe&quot;);</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">    var</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        CURRENT_PLAN = &quot;MarchBeta&quot;;</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    stripe = stripe(Settings.stripe.secret_key);</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">    var _increaseSubscription = function(customer, plan, quantity, coupon, next){</td></tr><tr class="miss"><td class="line">13</td><td class="hits">0</td><td class="source">        if(typeof coupon == &quot;function&quot; &amp;&amp; !next) next = coupon;</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">15</td><td class="hits">0</td><td class="source">        quantity = (quantity &lt; 0) ? Math.abs(quantity || 1) : quantity || 1;</td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="source">        return _updateSubscription(customer, plan, quantity, coupon, next);</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">    var _decreaseSubscription = function(customer, plan, quantity, next) {</td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="source">        quantity = (quantity &gt; 0) ? quantity * -1 : quantity || -1;</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">        var finalQuantity = parseInt(customer.subscription.quantity || 0,10) + parseInt(quantity, 10);</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">        if(finalQuantity &gt; 0) {</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">            return _updateSubscription(customer, plan, quantity, null, next);</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">            return _cancelSubscription(customer, next);</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">    var _updateSubscription = function(customer, plan, change, coupon, next) {</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">        if(typeof coupon == &quot;function&quot; &amp;&amp; !next) next = coupon;</td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">        console.log(&quot;coupsss&quot;, coupon);</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">        var data = {</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">            plan: plan || CURRENT_PLAN,</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">            quantity: parseInt(customer.subscription.quantity || 0,10) + parseInt(change, 10),</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">            prorate: true</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">        if(!data.coupon) delete data.coupon;</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">        stripe.customers.updateSubscription(</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">            customer.id,</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">            data,</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">            function(err, subscription) {</td></tr><tr class="miss"><td class="line">47</td><td class="hits">0</td><td class="source">                if (err) {</td></tr><tr class="miss"><td class="line">48</td><td class="hits">0</td><td class="source">                    console.log(&quot;Stripe Error:&quot;, err);</td></tr><tr class="miss"><td class="line">49</td><td class="hits">0</td><td class="source">                    return next(err);</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="source">                return next(err, subscription);</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">         );</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">56</td><td class="hits">1</td><td class="source">    var _cancelSubscription = function(customer, next) {</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">        //No customer to cancel so just move on</td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">        if(!customer) return process.nextTick(function(){</td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">            return next(null, null);</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="source">        stripe.customers.cancelSubscription(</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">            customer.id, </td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">            function (err, subscription) {</td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="source">                if (err) {</td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">                    console.log(&quot;Stripe Error:&quot;, err);</td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="source">                    return next(err);</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">                //subscription.status == &quot;canceled&quot;</td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="source">                return next(err, subscription);</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">        );</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">75</td><td class="hits">1</td><td class="source">    var _createCustomer = function(user, card, quantity, plan, coupon, next) {</td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="source">        quantity = (quantity &lt; 0) ? Math.abs(quantity || 1) : quantity || 1;</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="source">        if(typeof coupon == &quot;function&quot; &amp;&amp; !next) next = coupon;</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="source">        var data = {</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">            email: user.email,</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">            description: user.name + &quot; - &quot; + user.email,</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">            card: card,</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">            plan: plan,</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">            quantity: quantity,</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">            coupon: coupon</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="source">        if(!data.coupon) delete data.coupon;</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="source">        stripe.customers.create(</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">            data,</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">            function(err, customer) {</td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="source">                if (err) return next(err);</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">                </td></tr><tr class="miss"><td class="line">96</td><td class="hits">0</td><td class="source">                return next(err, customer);</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">         );</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">    };  </td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">101</td><td class="hits">1</td><td class="source">    var _getCustomer = function(user, next) {</td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="source">        if(typeof user === 'undefined' || typeof user.customer === 'undefined' || typeof user.customer.id === 'undefined') {</td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="source">            return next(&quot;Need customer ID for payment.&quot;);</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="source">        stripe.customers.retrieve(user.customer.id, function(err, customer) {</td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="source">            if (err) return next(err);</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="source">            return next(err, customer);</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">113</td><td class="hits">1</td><td class="source">    var _updateCreditCard = function(customer_id, updates, next) {</td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="source">        if(!updates.coupon) delete updates.coupon;</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">116</td><td class="hits">0</td><td class="source">        stripe.customers.update(customer_id, updates, next);</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">119</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">        createCustomer: _createCustomer,</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">        getCustomer: _getCustomer,</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">        increaseSubscription: _increaseSubscription,</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">        decreaseSubscription: _decreaseSubscription,</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">        updateSubscription: _updateSubscription,</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">        updateCreditCard: _updateCreditCard,</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">        cancelSubscription: _cancelSubscription</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">131</td><td class="hits">1</td><td class="source">module.exports = Payment;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/plan.js">/Users/warner/code/clipppr/primeloop-api/models/plan.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">7</div><div class="hits">7</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var PlanModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;);</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        name: String,</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        trial_period_days: Number, </td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        id: String,</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        currency: String,</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        amount: Number, </td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        billingType: {type:String, &quot;default&quot;: &quot;end-of-month&quot;},</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        metadata: {</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">            chargePerThousandClicks: Number,</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">            numFreeClicks: Number</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        created: {type: Date, &quot;default&quot;: Date.now}</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">23</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">25</td><td class="hits">1</td><td class="source">    var _model = mongoose.model(&quot;Plan&quot;, _schema);</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">35</td><td class="hits">1</td><td class="source">module.exports = PlanModel;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/report_additions.js">/Users/warner/code/clipppr/primeloop-api/models/report_additions.js</h2><div id="stats" class="high"><div class="percentage">90%</div><div class="sloc">10</div><div class="hits">9</div><div class="misses">1</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var ReportAdditionsModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        kaster = require(&quot;kaster-mongoose&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        mongoosastic = require(&quot;mongoosastic&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        ObjectUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/objects&quot;);</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        action: {type:Object, es_indexed:false},</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        addedBy: {type: String, ref: &quot;User&quot;},</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        notebook: {type: String, ref:&quot;Notebook&quot;},</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        clipp: {type: String, ref: &quot;Clipp&quot;},</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        created:  {type: Date, &quot;default&quot;: Date.now}</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    // _schema.plugin(kaster, {</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    //     name: &quot;ReportAddition&quot;,</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    //     region: Settings.kaster.region,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    //     namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    //     topic: Settings.kaster.topics.data</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">    // });</td></tr><tr class="hit"><td class="line">28</td><td class="hits">1</td><td class="source">    _schema.plugin(mongoosastic, {</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        index: Settings.elasticsearch.data_index,</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        protocol: Settings.elasticsearch.protocol,</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        host: Settings.elasticsearch.host,</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        port: Settings.elasticsearch.port,</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        auth: Settings.elasticsearch.user + &quot;:&quot; + Settings.elasticsearch.password</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">36</td><td class="hits">1</td><td class="source">    _schema.methods.setAll = function(data, user) {</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">        return ObjectUtils.copyAllProperties(data, this);</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">40</td><td class="hits">1</td><td class="source">    var _model = mongoose.model(&quot;Report.Additions&quot;, _schema);</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">43</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">50</td><td class="hits">1</td><td class="source">module.exports = ReportAdditionsModel;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/suggested_action.js">/Users/warner/code/clipppr/primeloop-api/models/suggested_action.js</h2><div id="stats" class="medium"><div class="percentage">52%</div><div class="sloc">23</div><div class="hits">12</div><div class="misses">11</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var SuggestedActionModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        kaster = require(&quot;kaster-mongoose&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        mongoosastic = require(&quot;mongoosastic&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        ObjectUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/objects&quot;);</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        name: String,</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        action: String,</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        action_type: String,</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        templateBody:String,</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        template: {type:String, ref:&quot;SuggestedAction.View.Template&quot;},</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        templateVersion:String,</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        data: {type:Object, es_indexed:false},</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        notebook: {type:String, ref:&quot;Notebook&quot;, index: true},</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        models:[String],</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        completedBy: {type:String, ref: &quot;User&quot;},</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        approvedAt: {type: Date},</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        assignedTo: {type:String, ref: &quot;User&quot;},</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        createdBy: {type: String, ref: &quot;User&quot;},</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        created:  {type: Date, &quot;default&quot;: Date.now},</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        updated:  {type: Date, &quot;default&quot;: Date.now},</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        priority: {type: Number, &quot;default&quot;: 5},</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        sortValue: Number,</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        status: {type:String, &quot;default&quot;:&quot;admin&quot;, enum:[&quot;admin&quot;, &quot;current&quot;, &quot;completed&quot;, &quot;ignored&quot;, &quot;assigned&quot;, &quot;admin-denied&quot;, &quot;expired&quot;]}</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">33</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">    // _schema.plugin(kaster, {</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">    //     name: &quot;SuggestedAction&quot;,</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">    //     region: Settings.kaster.region,</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">    //     namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">    //     topic: Settings.kaster.topics.data</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    // });</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">42</td><td class="hits">1</td><td class="source">    _schema.plugin(mongoosastic, {</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">        index: Settings.elasticsearch.data_index,</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">        protocol: Settings.elasticsearch.protocol,</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">        host: Settings.elasticsearch.host,</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        port: Settings.elasticsearch.port,</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">        auth: Settings.elasticsearch.user + &quot;:&quot; + Settings.elasticsearch.password</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">    </td></tr><tr class="hit"><td class="line">50</td><td class="hits">1</td><td class="source">    _schema.methods.setAll = function(data, user) {</td></tr><tr class="miss"><td class="line">51</td><td class="hits">0</td><td class="source">        return ObjectUtils.copyAllProperties(data, this);</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">54</td><td class="hits">1</td><td class="source">    var _calculateRank = function(points, date) {</td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">        if(typeof date == &quot;string&quot;) date = new Date(date);</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">            days = parseFloat( (new Date().getTime() - date.getTime()) / (1000 * 60 * 60 * 24) ),</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">            gravity = 1.800000;</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="source">        var rank = </td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">            parseFloat(points) / </td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">            parseFloat( Math.pow(parseFloat(days+2), gravity) );</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">        return rank;</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">    //TODO: Find a better dynamic place to put this... like the database</td></tr><tr class="hit"><td class="line">71</td><td class="hits">1</td><td class="source">    var _getPlainText = function(action) {</td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">        switch(action.action) {</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">            case &quot;report_add_high_conversion&quot;:</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="source">            return action.data.clipp.title + &quot; had &quot; + action.data.clipp.conversion.goalCompletion + &quot; conversions, which was &quot; + action.data.above_average + &quot;% above the average&quot;;</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">            case &quot;report_add_high_value&quot;:</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="source">            return action.data.clipp.title + &quot; generated $&quot; + action.data.clipp.conversion.goalValueAll + &quot; of value from direct conversions&quot;;</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">            case &quot;report_add_best_performing&quot;:</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">            </td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="source">            return action.data.clipp.title + &quot; had &quot;  + action.data.clipp.engagement.points.current + &quot; total engagements, which was &quot; + action.data.above_average + &quot;% above the average&quot;;</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">    }; </td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">85</td><td class="hits">1</td><td class="source">    _schema.path(&quot;priority&quot;).set(function(newPriority){</td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="source">        this.sortValue = _calculateRank(newPriority, this.created || Date.now());</td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="source">        return newPriority;</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">90</td><td class="hits">1</td><td class="source">    var _model = mongoose.model(&quot;SuggestedAction&quot;, _schema);</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">93</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema,</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">        getPlainText: _getPlainText</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">101</td><td class="hits">1</td><td class="source">module.exports = SuggestedActionModel;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/suggested_action_view_template.js">/Users/warner/code/clipppr/primeloop-api/models/suggested_action_view_template.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">8</div><div class="hits">8</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var SuggestedActionViewTemplateModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        kaster = require(&quot;kaster-mongoose&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        mongoosastic = require(&quot;mongoosastic&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;);</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        name: String,</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        templateBody: String,</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        templateVersion: {type:Number, &quot;default&quot;:1},</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        created: {type: Date, &quot;default&quot;: Date.now}</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">18</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">    // _schema.plugin(kaster, {</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    //     name: &quot;SuggestedActionViewTemplate&quot;,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">    //     region: Settings.kaster.region,</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    //     namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    //     topic: Settings.kaster.topics.data</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    // });</td></tr><tr class="hit"><td class="line">26</td><td class="hits">1</td><td class="source">    _schema.plugin(mongoosastic, {</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        index: Settings.elasticsearch.data_index,</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        protocol: Settings.elasticsearch.protocol,</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        host: Settings.elasticsearch.host,</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        port: Settings.elasticsearch.port,</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        auth: Settings.elasticsearch.user + &quot;:&quot; + Settings.elasticsearch.password</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">34</td><td class="hits">1</td><td class="source">    var _model = mongoose.model(&quot;SuggestedAction.View.Template&quot;, _schema);</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">36</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">43</td><td class="hits">1</td><td class="source">module.exports = SuggestedActionViewTemplateModel;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/suggested_batch_import.js">/Users/warner/code/clipppr/primeloop-api/models/suggested_batch_import.js</h2><div id="stats" class="terrible"><div class="percentage">7%</div><div class="sloc">144</div><div class="hits">11</div><div class="misses">133</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var SuggestedBatchImportModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        kaster = require(&quot;kaster-mongoose&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        mongoosastic = require(&quot;mongoosastic&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        Page = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../models/page&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        Notebook = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../models/notebook&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        SuggestedClippError = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../models/suggested_clipp_error&quot;),</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        Clipp = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../models/clipp&quot;),</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        SuggestedClipp = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../models/suggested_clipp&quot;),</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        SuggestedClippArchive = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../models/suggested_clipp&quot;).Archive,</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        ArrayUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/array&quot;),</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;);</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">17</td><td class="hits">1</td><td class="source">    var _log = {</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        url: String,</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        processedUrl: String,</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        error: String,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        info: String,</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        processed: {type: Boolean, &quot;default&quot;: false},</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        succeeded: {type: Boolean, &quot;default&quot;: false}</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">    var _job = {</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        urls: [String]</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">32</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        user: {type: String, ref: 'User'}, </td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        raw: String,</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">        source: {type: String, &quot;default&quot;: &quot;manual&quot;},</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        sourceURL: String,</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        notebook: {type: String, ref: 'Notebook'},</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">        created: {type: Date, &quot;default&quot;: Date.now},</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">        processed: {type: Boolean, &quot;default&quot;: false},</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">        totalToBeProcessed: {type: Number, &quot;default&quot;: 0},</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">        totalProcessed: {type: Number, &quot;default&quot;: 0},</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">        jobSize: Number,</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">        numJobs: Number,</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">        jobs: [_job],</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        problemUrls :[String],</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">        logs: [_log]</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">50</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">    // _schema.plugin(kaster, {</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">    //     name: &quot;SuggestedBatchImport&quot;,</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">    //     region: Settings.kaster.region,</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">    //     namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">    //     topic: Settings.kaster.topics.data</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">    // });</td></tr><tr class="hit"><td class="line">58</td><td class="hits">1</td><td class="source">    _schema.plugin(mongoosastic, {</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">        index: Settings.elasticsearch.data_index,</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">        protocol: Settings.elasticsearch.protocol,</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">        host: Settings.elasticsearch.host,</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">        port: Settings.elasticsearch.port,</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">        auth: Settings.elasticsearch.user + &quot;:&quot; + Settings.elasticsearch.password</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"><td class="line">65</td><td class="hits">1</td><td class="source">    var _model = mongoose.model(&quot;SuggestedBatchImport&quot;, _schema);</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">      * This will process all the urls in a given chunk and call done(err, results)</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">      * when finished</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">      */</td></tr><tr class="hit"><td class="line">71</td><td class="hits">1</td><td class="source">    var _processChunk = function(batch, chunk, done) {</td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">            notebookId = batch.notebook,</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">            user = batch.user;</td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="source">        var len = chunk.length;</td></tr><tr class="miss"><td class="line">76</td><td class="hits">0</td><td class="source">        var notebook = null;</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">78</td><td class="hits">0</td><td class="source">        var importedClipps = [];</td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">        var processingLogs = [];</td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="source">        Notebook.Model</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">                _id: notebookId</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">            .populate(&quot;clipps.clipp&quot;, &quot;url&quot;)</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">            .exec(function(err, nb){</td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="source">                if(err) return done(err);</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="source">                notebook = nb;</td></tr><tr class="miss"><td class="line">89</td><td class="hits">0</td><td class="source">                for(var i = 0; i &lt; chunk.length; i++) {</td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="source">                    var log = {</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">                        url: chunk[i]</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">                    };</td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="source">                    Page.getMetaInfo(chunk[i], log, importClipp);</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">97</td><td class="hits">0</td><td class="source">        function finish(err) {</td></tr><tr class="miss"><td class="line">98</td><td class="hits">0</td><td class="source">            if(err) console.log(&quot;error on finish: &quot; + err);</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">            //console.log(&quot;logged urls, %j&quot;, processingLogs);</td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="source">            done(null, {message:&quot;processed &quot; + importedClipps.length + &quot; clipps&quot;, logs:processingLogs});</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="source">        function importClipp(err, data) {</td></tr><tr class="miss"><td class="line">104</td><td class="hits">0</td><td class="source">            var reviewFlag = false;</td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="source">            var pageError = null;</td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="source">            if(err) {</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">                //depending on the error we may still want to create the clip and flag it</td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="source">                if(err == &quot;No URL&quot;) {</td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="source">                    processingLogs.push(data.log);</td></tr><tr class="miss"><td class="line">110</td><td class="hits">0</td><td class="source">                    return --len || finish(null);</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">                } else {</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">                    //Any other type of error we want to create an error record as well as the clipp</td></tr><tr class="miss"><td class="line">113</td><td class="hits">0</td><td class="source">                    var error = err;</td></tr><tr class="miss"><td class="line">114</td><td class="hits">0</td><td class="source">                    if(data &amp;&amp; data.statusCode) {</td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="source">                        error += &quot; status code: &quot; + data.statusCode;</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">117</td><td class="hits">0</td><td class="source">                    pageError = new SuggestedClippError.Model({</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">                        _id : uuid.v4(),</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">                        error: error,</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">                        errorType: &quot;http_error&quot;,</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">                        notes: &quot;error occurred on import, batch &quot; + batch._id</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">                    });</td></tr><tr class="miss"><td class="line">123</td><td class="hits">0</td><td class="source">                    reviewFlag = true;</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">                } </td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">128</td><td class="hits">0</td><td class="source">            if(!data || !data.url) {</td></tr><tr class="miss"><td class="line">129</td><td class="hits">0</td><td class="source">                if(!data) {</td></tr><tr class="miss"><td class="line">130</td><td class="hits">0</td><td class="source">                    data = {</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">                        log: {</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">                            error: &quot;no data returned&quot;,</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">                            processed: true,</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">                            succeeded:false</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">                    };</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="source">                    data.log.error = &quot;No url returned from Page.getMetaInfo&quot;;</td></tr><tr class="miss"><td class="line">139</td><td class="hits">0</td><td class="source">                    data.log.processed = true;</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">                </td></tr><tr class="miss"><td class="line">142</td><td class="hits">0</td><td class="source">                processingLogs.push(data.log);</td></tr><tr class="miss"><td class="line">143</td><td class="hits">0</td><td class="source">                return --len || finish(&quot;no data&quot;, data);</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">            } </td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">146</td><td class="hits">0</td><td class="source">            var log = data.log;</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">148</td><td class="hits">0</td><td class="source">            if(!data.title) data.title = data.url;</td></tr><tr class="miss"><td class="line">149</td><td class="hits">0</td><td class="source">            var suggestedClipp = new SuggestedClipp.Model({</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">                notebook: notebookId,</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">                url: data.url,</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">                title: data.title,</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">                description: data.description,</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">                batch: batch._id,</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">                source: batch.source</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">             });</td></tr><tr class="miss"><td class="line">157</td><td class="hits">0</td><td class="source">            if(batch.sourceURL) suggestedClipp.sourceURL = batch.sourceURL;</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="source">            if(data.site_name) suggestedClipp.site.name = data.site_name;</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">            //check to see if it's already been clipped</td></tr><tr class="miss"><td class="line">162</td><td class="hits">0</td><td class="source">            var archive = false;</td></tr><tr class="miss"><td class="line">163</td><td class="hits">0</td><td class="source">            var idx = ArrayUtils.inArray(suggestedClipp.url, notebook.clipps, &quot;clipp.url&quot;);</td></tr><tr class="miss"><td class="line">164</td><td class="hits">0</td><td class="source">            if(idx &gt;= 0) {</td></tr><tr class="miss"><td class="line">165</td><td class="hits">0</td><td class="source">                var clipp = notebook.clipps[idx];</td></tr><tr class="miss"><td class="line">166</td><td class="hits">0</td><td class="source">                suggestedClipp.userClipped = true;</td></tr><tr class="miss"><td class="line">167</td><td class="hits">0</td><td class="source">                suggestedClipp.clipp = clipp._id;</td></tr><tr class="miss"><td class="line">168</td><td class="hits">0</td><td class="source">                archive = true;</td></tr><tr class="miss"><td class="line">169</td><td class="hits">0</td><td class="source">                log.info = &quot;User already clipped into notebook - archiving&quot;;</td></tr><tr class="miss"><td class="line">170</td><td class="hits">0</td><td class="source">                log.processed = true;</td></tr><tr class="miss"><td class="line">171</td><td class="hits">0</td><td class="source">                log.succeeded = true;</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">            //next we need to check to see if it's already in the db</td></tr><tr class="miss"><td class="line">175</td><td class="hits">0</td><td class="source">            var saveClipp = true;</td></tr><tr class="miss"><td class="line">176</td><td class="hits">0</td><td class="source">            SuggestedClipp.Model</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">                .find({</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">                    url: suggestedClipp.url,</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">                    notebook: notebookId</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">                .exec(function(err, clipps) {</td></tr><tr class="miss"><td class="line">182</td><td class="hits">0</td><td class="source">                    if(err) {</td></tr><tr class="miss"><td class="line">183</td><td class="hits">0</td><td class="source">                        console.log(&quot;error finding dupe clipps&quot;, err);</td></tr><tr class="miss"><td class="line">184</td><td class="hits">0</td><td class="source">                        log.error = &quot;mongo error finding dupe clipps &quot; + err;</td></tr><tr class="miss"><td class="line">185</td><td class="hits">0</td><td class="source">                        processingLogs.push(log);</td></tr><tr class="miss"><td class="line">186</td><td class="hits">0</td><td class="source">                        return --len || finish(err, data); </td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">188</td><td class="hits">0</td><td class="source">                    if(clipps.length &gt; 0) {</td></tr><tr class="miss"><td class="line">189</td><td class="hits">0</td><td class="source">                        console.log(&quot;clipp already added to suggested clipps&quot;);</td></tr><tr class="miss"><td class="line">190</td><td class="hits">0</td><td class="source">                        if(archive) {</td></tr><tr class="miss"><td class="line">191</td><td class="hits">0</td><td class="source">                            clipps[0].userClipped = suggestedClipp.userClipped;</td></tr><tr class="miss"><td class="line">192</td><td class="hits">0</td><td class="source">                            clipps[0].clipp = suggestedClipp.clipp;</td></tr><tr class="miss"><td class="line">193</td><td class="hits">0</td><td class="source">                            clipps[0].batch = batch._id;</td></tr><tr class="miss"><td class="line">194</td><td class="hits">0</td><td class="source">                            return SuggestedClipp.Archive.add(clipps[0], function(err, saved) {</td></tr><tr class="miss"><td class="line">195</td><td class="hits">0</td><td class="source">                                if(err) {</td></tr><tr class="miss"><td class="line">196</td><td class="hits">0</td><td class="source">                                    log.error = &quot;mongo error finding archiving suggested clipp %j&quot;, err;</td></tr><tr class="miss"><td class="line">197</td><td class="hits">0</td><td class="source">                                    processingLogs.push(log);</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">                                }</td></tr><tr class="miss"><td class="line">199</td><td class="hits">0</td><td class="source">                                processingLogs.push(log);</td></tr><tr class="miss"><td class="line">200</td><td class="hits">0</td><td class="source">                                return --len || finish(err);</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">                        } else {</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">                            //just update the suggested clipp</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">205</td><td class="hits">0</td><td class="source">                            log.info = &quot;clipp already added to suggested clipps - updating batch&quot;;</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">207</td><td class="hits">0</td><td class="source">                            return SuggestedClipp.Model.update({url: suggestedClipp.url, notebook: notebookId}, {batch: batch._id}, function(err, saved){</td></tr><tr class="miss"><td class="line">208</td><td class="hits">0</td><td class="source">                                if(err) {</td></tr><tr class="miss"><td class="line">209</td><td class="hits">0</td><td class="source">                                    log.error = &quot;mongo error finding updating suggested clipp: &quot; + err;</td></tr><tr class="miss"><td class="line">210</td><td class="hits">0</td><td class="source">                                    processingLogs.push(log);</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">                                }</td></tr><tr class="miss"><td class="line">212</td><td class="hits">0</td><td class="source">                                log.processed = true;</td></tr><tr class="miss"><td class="line">213</td><td class="hits">0</td><td class="source">                                log.succeeded = true;</td></tr><tr class="miss"><td class="line">214</td><td class="hits">0</td><td class="source">                                processingLogs.push(log);</td></tr><tr class="miss"><td class="line">215</td><td class="hits">0</td><td class="source">                                return --len || finish(err);</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">                        </td></tr><tr class="miss"><td class="line">219</td><td class="hits">0</td><td class="source">                        saveClipp = false;</td></tr><tr class="miss"><td class="line">220</td><td class="hits">0</td><td class="source">                    } else if(archive) {</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source">                        //we just need to archive it since it's already been clipped</td></tr><tr class="miss"><td class="line">222</td><td class="hits">0</td><td class="source">                        suggestedClipp.userClipped = suggestedClipp.userClipped;</td></tr><tr class="miss"><td class="line">223</td><td class="hits">0</td><td class="source">                        suggestedClipp.batch = batch._id;</td></tr><tr class="miss"><td class="line">224</td><td class="hits">0</td><td class="source">                        return SuggestedClipp.Archive.add(suggestedClipp, function(err, saved) {</td></tr><tr class="miss"><td class="line">225</td><td class="hits">0</td><td class="source">                            if(err) {</td></tr><tr class="miss"><td class="line">226</td><td class="hits">0</td><td class="source">                                log.error = &quot;mongo error finding archiving suggested clipp: &quot; + err;</td></tr><tr class="miss"><td class="line">227</td><td class="hits">0</td><td class="source">                                processingLogs.push(log);</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source">                            }</td></tr><tr class="miss"><td class="line">229</td><td class="hits">0</td><td class="source">                            processingLogs.push(log);</td></tr><tr class="miss"><td class="line">230</td><td class="hits">0</td><td class="source">                            return --len || finish(err);</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">                    //then we need to see if this was already archived</td></tr><tr class="miss"><td class="line">234</td><td class="hits">0</td><td class="source">                    if(saveClipp) {</td></tr><tr class="miss"><td class="line">235</td><td class="hits">0</td><td class="source">                        SuggestedClippArchive.Model</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source">                            .find({</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source">                                url: suggestedClipp.url,</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">                                notebook: notebookId</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source">                            })</td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source">                            .exec(function(err, archClipps) {</td></tr><tr class="miss"><td class="line">241</td><td class="hits">0</td><td class="source">                                if(err) {</td></tr><tr class="miss"><td class="line">242</td><td class="hits">0</td><td class="source">                                    log.error = &quot;mongo error finding archived suggested clipp: &quot; + err;</td></tr><tr class="miss"><td class="line">243</td><td class="hits">0</td><td class="source">                                    processingLogs.push(log);</td></tr><tr class="miss"><td class="line">244</td><td class="hits">0</td><td class="source">                                    return --len || finish(err);</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source">                                }</td></tr><tr class="miss"><td class="line">246</td><td class="hits">0</td><td class="source">                                if(archClipps.length &gt; 0) {</td></tr><tr class="miss"><td class="line">247</td><td class="hits">0</td><td class="source">                                    console.log(&quot;clipp already archived&quot;);</td></tr><tr class="miss"><td class="line">248</td><td class="hits">0</td><td class="source">                                    log.info = &quot;clipp already archived&quot;;</td></tr><tr class="miss"><td class="line">249</td><td class="hits">0</td><td class="source">                                    saveClipp = false;</td></tr><tr class="miss"><td class="line">250</td><td class="hits">0</td><td class="source">                                    return SuggestedClippArchive.Model.update({url: suggestedClipp.url, notebook: notebookId}, {batch: batch._id}, function(err, saved){</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source">                                        //if(err) return console.log(&quot;Error updating batch for clipp:&quot;, err);</td></tr><tr class="miss"><td class="line">252</td><td class="hits">0</td><td class="source">                                        if(err) {</td></tr><tr class="miss"><td class="line">253</td><td class="hits">0</td><td class="source">                                            log.error = &quot;mongo error updating archived suggested clipp: &quot; + err;</td></tr><tr class="miss"><td class="line">254</td><td class="hits">0</td><td class="source">                                            processingLogs.push(log);</td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">                                        } else {</td></tr><tr class="miss"><td class="line">256</td><td class="hits">0</td><td class="source">                                            log.processed = true;</td></tr><tr class="miss"><td class="line">257</td><td class="hits">0</td><td class="source">                                            log.succeeded = true;</td></tr><tr class="miss"><td class="line">258</td><td class="hits">0</td><td class="source">                                            processingLogs.push(log);</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source">                                        }</td></tr><tr class="miss"><td class="line">260</td><td class="hits">0</td><td class="source">                                        return --len || finish(err);</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source">                                    });</td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source">                                }</td></tr><tr class="miss"><td class="line">263</td><td class="hits">0</td><td class="source">                                return saveSuggestedClipp(saveClipp, suggestedClipp, log, pageError);</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source">                                </td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">266</td><td class="hits"></td><td class="source">                    } else {</td></tr><tr class="miss"><td class="line">267</td><td class="hits">0</td><td class="source">                        return saveSuggestedClipp(saveClipp, suggestedClipp, log, pageError);</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">                });            </td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">272</td><td class="hits">0</td><td class="source">        function saveSuggestedClipp(saveClipp, suggestedClipp, log, pageError) {</td></tr><tr class="miss"><td class="line">273</td><td class="hits">0</td><td class="source">            console.log(&quot;calling saveSuggestedClipp&quot;);</td></tr><tr class="miss"><td class="line">274</td><td class="hits">0</td><td class="source">            if(saveClipp) {</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source">                </td></tr><tr class="miss"><td class="line">276</td><td class="hits">0</td><td class="source">                if(pageError) suggestedClipp.error = pageError._id;</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">278</td><td class="hits">0</td><td class="source">                return suggestedClipp.save(function(err, saved){</td></tr><tr class="miss"><td class="line">279</td><td class="hits">0</td><td class="source">                    console.log(&quot;saved suggested clipp&quot;);</td></tr><tr class="miss"><td class="line">280</td><td class="hits">0</td><td class="source">                    if(err) {</td></tr><tr class="miss"><td class="line">281</td><td class="hits">0</td><td class="source">                        console.log(&quot;Error saving clipp on import:&quot;, err, suggestedClipp.url);</td></tr><tr class="miss"><td class="line">282</td><td class="hits">0</td><td class="source">                        log.error = &quot;mongo error saving suggested clipp: &quot; + err;</td></tr><tr class="miss"><td class="line">283</td><td class="hits">0</td><td class="source">                        processingLogs.push(log);</td></tr><tr class="miss"><td class="line">284</td><td class="hits">0</td><td class="source">                        return --len || finish(err);</td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source">                    } else {</td></tr><tr class="miss"><td class="line">286</td><td class="hits">0</td><td class="source">                        log.processed = true;</td></tr><tr class="miss"><td class="line">287</td><td class="hits">0</td><td class="source">                        if(pageError) {</td></tr><tr class="miss"><td class="line">288</td><td class="hits">0</td><td class="source">                            log.error = &quot;There was an error getting url info: &quot; + pageError.rawError;</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source">                        } else {</td></tr><tr class="miss"><td class="line">290</td><td class="hits">0</td><td class="source">                            log.succeeded = true;</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source">                        }</td></tr><tr class="miss"><td class="line">292</td><td class="hits">0</td><td class="source">                        processingLogs.push(log);</td></tr><tr><td class="line">293</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">294</td><td class="hits">0</td><td class="source">                    console.log(&quot;saved clipp: &quot; + saved.url);</td></tr><tr class="miss"><td class="line">295</td><td class="hits">0</td><td class="source">                    if(pageError) {</td></tr><tr class="miss"><td class="line">296</td><td class="hits">0</td><td class="source">                        pageError.suggestedClipp = saved._id;</td></tr><tr><td class="line">297</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">298</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">299</td><td class="hits">0</td><td class="source">                    if(pageError) {</td></tr><tr class="miss"><td class="line">300</td><td class="hits">0</td><td class="source">                        pageError.save(function(err) {</td></tr><tr class="miss"><td class="line">301</td><td class="hits">0</td><td class="source">                            if(err) {</td></tr><tr class="miss"><td class="line">302</td><td class="hits">0</td><td class="source">                                console.log(&quot;Error saving page error:&quot;, err, suggestedClipp.url);</td></tr><tr class="miss"><td class="line">303</td><td class="hits">0</td><td class="source">                                return --len || finish(err);</td></tr><tr><td class="line">304</td><td class="hits"></td><td class="source">                            }</td></tr><tr class="miss"><td class="line">305</td><td class="hits">0</td><td class="source">                            return --len || finish(null, &quot;page error saved&quot;);</td></tr><tr><td class="line">306</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">307</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">308</td><td class="hits">0</td><td class="source">                    return --len || finish(null, &quot;suggestions updated with new link&quot;);</td></tr><tr><td class="line">309</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">310</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="miss"><td class="line">311</td><td class="hits">0</td><td class="source">                return --len || finish(null, &quot;duplicate clipp&quot;);</td></tr><tr><td class="line">312</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">313</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">315</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">316</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">317</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">318</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">319</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">320</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">321</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">322</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema,</td></tr><tr><td class="line">323</td><td class="hits"></td><td class="source">        processChunk: _processChunk</td></tr><tr><td class="line">324</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">325</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">326</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">327</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">328</td><td class="hits">1</td><td class="source">module.exports = SuggestedBatchImportModel;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/suggested_clipp.js">/Users/warner/code/clipppr/primeloop-api/models/suggested_clipp.js</h2><div id="stats" class="terrible"><div class="percentage">18%</div><div class="sloc">99</div><div class="hits">18</div><div class="misses">81</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var SuggestedClippModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        kaster = require(&quot;kaster-mongoose&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        mongoosastic = require(&quot;mongoosastic&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        ArrayUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/array&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        ObjectUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/objects&quot;),</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        Clipp  =require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../models/clipp&quot;),</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        SuggestedAction  =require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../models/suggested_action&quot;),</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        URLUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/urls&quot;),</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        fs = require(&quot;fs&quot;),</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        Validations = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/validations&quot;);</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">17</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        batch: {type: String},</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        title: String,</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        published: Date,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        description: String,</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        tags: [String],</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        site: {</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">            url: String,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">            domain_url: String,</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">            name: String</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        clipp: {type: String, ref: &quot;Clipp&quot;},</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        userClipped: {type: Boolean, &quot;default&quot;: false},</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        created: {type: Date, &quot;default&quot;: Date.now},</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        creator: {type: String, ref: &quot;User&quot;},</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        url: { type: String, required: true, validate: Validations.url },</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        notebook: {type: String, ref: &quot;Notebook&quot; },</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        source: String,</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">        sourceURL: { type: String, validate: Validations.url },</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        error:  {type: String, ref: &quot;SuggestedClipp.Error&quot;}</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">40</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">    // _schema.plugin(kaster, {</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">    //     name: &quot;SuggestedClipp&quot;,</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">    //     region: Settings.kaster.region,</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">    //     namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">    //     topic: Settings.kaster.topics.data</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">    // });</td></tr><tr class="hit"><td class="line">48</td><td class="hits">1</td><td class="source">    _schema.plugin(mongoosastic, {</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">        index: Settings.elasticsearch.data_index,</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">        protocol: Settings.elasticsearch.protocol,</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">        host: Settings.elasticsearch.host,</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">        port: Settings.elasticsearch.port,</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">        auth: Settings.elasticsearch.user + &quot;:&quot; + Settings.elasticsearch.password</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"><td class="line">55</td><td class="hits">1</td><td class="source">    _schema.pre(&quot;save&quot;, function(done){</td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">        this.site.url = URLUtils.getSiteFromURL(this.url);</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">        this.site.domain_url = URLUtils.getNakedDomain(this.url);</td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">        return done();</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">64</td><td class="hits">1</td><td class="source">    _schema.virtual(&quot;tag&quot;).set(function(tag){</td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="source">        if(!tag) return;</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">            tags = ArrayUtils.uniqueArray(tag.toString().split(&quot;,&quot;));</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="source">        for(var i = 0; i &lt; tags.length; i++){</td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="source">            if(this.tags.indexOf(tags[i]) &gt;= 0) tags.splice(i,1);</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="source">        this.tags = this.tags.concat(tags);</td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="source">        this.markModified('tags');</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">78</td><td class="hits">1</td><td class="source">    _schema.path(&quot;tags&quot;).set(function(tags){</td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">        tags = tags.toString().split(&quot;,&quot;);</td></tr><tr class="miss"><td class="line">80</td><td class="hits">0</td><td class="source">        for(var i in tags) tags[i] = tags[i].trim().replace(/ /g, &quot;-&quot;);</td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="source">        return ArrayUtils.uniqueArray(tags);</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">     * Sets All the properties given by the input object on the model instance</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">     * @param  {Object} data An object with all the properties to be set</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">     * @return {Object}      Reference to this</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">     */</td></tr><tr class="hit"><td class="line">89</td><td class="hits">1</td><td class="source">    _schema.methods.setAll = function(data, user) {</td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="source">        if(data.comment) data.comment = {</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">            user: user._id,</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">            text: data.comment</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="source">        return ObjectUtils.copyAllProperties(data, this);</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">99</td><td class="hits">1</td><td class="source">    _schema.post(&quot;save&quot;, function(){</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">        //TODO: Create an suggested action</td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="source">        var that = this;</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="source">        if(that.userClipped || that.error) return;</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">        // console.log(&quot;Adding suggested action for suggested clipp&quot;, that.title);</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">        //TODO: Why the templates should be in the database</td></tr><tr class="miss"><td class="line">106</td><td class="hits">0</td><td class="source">        fs.readFile(__dirname + &quot;/../templates/_card_suggested_clipp.html&quot;, function(err, template){</td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="source">            that.populate(&quot;notebook&quot;, function(err, suggestedClipp){</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="source">                if(suggestedClipp.notebook.features.indexOf(&quot;suggested_actions&quot;) &gt;= 0){</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">                    </td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">                    //Create a action</td></tr><tr class="miss"><td class="line">112</td><td class="hits">0</td><td class="source">                    var action = new SuggestedAction.Model({</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">                        name: &quot;Suggested Clipp - clipp this&quot;,</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">                        action: &quot;suggested_clipp&quot;,</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">                        action_type: &quot;clipp_this&quot;,</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">                        templateBody: template,</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">                        template: &quot;suggested_clipp&quot;,</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">                        data: {</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">                            notebook: {</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">                                _id: suggestedClipp.notebook._id,</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">                                name: suggestedClipp.notebook.name</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">                            },</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">                            suggested_clipp: {</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">                                _id: suggestedClipp._id,</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">                                title: suggestedClipp.title,</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">                                site: suggestedClipp.site,</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">                                url: suggestedClipp.url,</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">                                description: suggestedClipp.description</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">                        },</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">                        notebook: suggestedClipp.notebook._id,</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">                        status: &quot;current&quot;</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">135</td><td class="hits">0</td><td class="source">                    action.save(function(err){</td></tr><tr class="miss"><td class="line">136</td><td class="hits">0</td><td class="source">                        if(err) console.log(&quot;Error creating action for suggested clipp&quot;, err, action, suggestedClipp);</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">    </td></tr><tr class="hit"><td class="line">144</td><td class="hits">1</td><td class="source">    var</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">        _archiveModel = mongoose.model(&quot;SuggestedClipp.Archive&quot;, mongoose.Schema(_jsonSchema)),</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">        _model = mongoose.model(&quot;SuggestedClipp&quot;, _schema);</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">149</td><td class="hits">1</td><td class="source">    var _archive = function(clipp, done) {</td></tr><tr class="miss"><td class="line">150</td><td class="hits">0</td><td class="source">        var archived = new _archiveModel(clipp.toObject());</td></tr><tr class="miss"><td class="line">151</td><td class="hits">0</td><td class="source">        archived.save(function(err, saved){</td></tr><tr class="miss"><td class="line">152</td><td class="hits">0</td><td class="source">            if(err) return done(err);</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">154</td><td class="hits">0</td><td class="source">            return clipp.remove(done);    </td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">        });  </td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">158</td><td class="hits">1</td><td class="source">    var _archiveMany = function(clipp_ids, done) {</td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="source">        console.log(&quot;calling archive many %j&quot;, clipp_ids);</td></tr><tr class="miss"><td class="line">160</td><td class="hits">0</td><td class="source">        _model</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">                _id : { $in : clipp_ids }</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">            .exec(function(err, clipps){</td></tr><tr class="miss"><td class="line">166</td><td class="hits">0</td><td class="source">                if(err) return done(err);</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">168</td><td class="hits">0</td><td class="source">                _archiveModel.create(clipps, function(err){</td></tr><tr class="miss"><td class="line">169</td><td class="hits">0</td><td class="source">                    if(err) return done(err);</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">171</td><td class="hits">0</td><td class="source">                    return _model.remove({</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">                        _id : { $in : clipp_ids }</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">                    }, done);</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">178</td><td class="hits">1</td><td class="source">    var _convertToNormalClippsMany = function(notebook, clipp_ids, done) {</td></tr><tr class="miss"><td class="line">179</td><td class="hits">0</td><td class="source">        console.log(&quot;calling covertToNormalMany %j&quot;, clipp_ids);</td></tr><tr class="miss"><td class="line">180</td><td class="hits">0</td><td class="source">        _model</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">                _id : { $in : clipp_ids }</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">            .exec(function(err, suggClipps){</td></tr><tr class="miss"><td class="line">185</td><td class="hits">0</td><td class="source">                if(err) return done(err);</td></tr><tr class="miss"><td class="line">186</td><td class="hits">0</td><td class="source">                var clipps = [];</td></tr><tr class="miss"><td class="line">187</td><td class="hits">0</td><td class="source">                Clipp.Model.create(suggClipps, function(err){</td></tr><tr class="miss"><td class="line">188</td><td class="hits">0</td><td class="source">                    if(err) return done(err);</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">                    //now we need to loop through each, add to notebook and save the notebook</td></tr><tr class="miss"><td class="line">190</td><td class="hits">0</td><td class="source">                    for (var i=1; i&lt;arguments.length; ++i) {</td></tr><tr class="miss"><td class="line">191</td><td class="hits">0</td><td class="source">                        var clipp = arguments[i];</td></tr><tr class="miss"><td class="line">192</td><td class="hits">0</td><td class="source">                        notebook.clipps.push({</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">                            clipp: clipp,</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">                            page: clipp.page</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">                    </td></tr><tr class="miss"><td class="line">198</td><td class="hits">0</td><td class="source">                    notebook.markModified(&quot;clipps&quot;);</td></tr><tr class="miss"><td class="line">199</td><td class="hits">0</td><td class="source">                    notebook.save(function(err, nbs){</td></tr><tr class="miss"><td class="line">200</td><td class="hits">0</td><td class="source">                        if(err) return done(err);</td></tr><tr class="miss"><td class="line">201</td><td class="hits">0</td><td class="source">                        return done(null, nbs);</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">207</td><td class="hits">1</td><td class="source">    var _checkForDuplicatesAndSave = function(notebookId, suggestedClipp, clipps, done) {</td></tr><tr class="miss"><td class="line">208</td><td class="hits">0</td><td class="source">        var archive = false;</td></tr><tr class="miss"><td class="line">209</td><td class="hits">0</td><td class="source">        var idx = ArrayUtils.inArray(suggestedClipp.url, clipps, &quot;clipp.url&quot;);</td></tr><tr class="miss"><td class="line">210</td><td class="hits">0</td><td class="source">        if(idx &gt;= 0) {</td></tr><tr class="miss"><td class="line">211</td><td class="hits">0</td><td class="source">            var clipp = notebook.clipps[idx];</td></tr><tr class="miss"><td class="line">212</td><td class="hits">0</td><td class="source">            suggestedClipp.userClipped = true;</td></tr><tr class="miss"><td class="line">213</td><td class="hits">0</td><td class="source">            suggestedClipp.clipp = clipp._id;</td></tr><tr class="miss"><td class="line">214</td><td class="hits">0</td><td class="source">            archive = true;</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">        //next we need to check to see if it's already in the db</td></tr><tr class="miss"><td class="line">218</td><td class="hits">0</td><td class="source">        var saveClipp = true;</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">220</td><td class="hits">0</td><td class="source">        _model</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">                url: suggestedClipp.url,</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">                notebook: notebookId</td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source">            .exec(function(err, clipps) {</td></tr><tr class="miss"><td class="line">226</td><td class="hits">0</td><td class="source">                if(err) return done(err);</td></tr><tr class="miss"><td class="line">227</td><td class="hits">0</td><td class="source">                if(clipps.length &gt; 0) {</td></tr><tr class="miss"><td class="line">228</td><td class="hits">0</td><td class="source">                    console.log(&quot;clipp already added to suggested clipps&quot;);</td></tr><tr class="miss"><td class="line">229</td><td class="hits">0</td><td class="source">                    if(archive) {</td></tr><tr class="miss"><td class="line">230</td><td class="hits">0</td><td class="source">                        clipps[0].userClipped = suggestedClipp.userClipped;</td></tr><tr class="miss"><td class="line">231</td><td class="hits">0</td><td class="source">                        clipps[0].clipp = suggestedClipp.clipp;</td></tr><tr class="miss"><td class="line">232</td><td class="hits">0</td><td class="source">                        clipps[0].batch = batch._id;</td></tr><tr class="miss"><td class="line">233</td><td class="hits">0</td><td class="source">                        return _archiveModel.add(clipps[0], function(err, saved) {</td></tr><tr class="miss"><td class="line">234</td><td class="hits">0</td><td class="source">                            if(err) return done(err);</td></tr><tr class="miss"><td class="line">235</td><td class="hits">0</td><td class="source">                            return done(null, saved);</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source">                    } </td></tr><tr class="miss"><td class="line">238</td><td class="hits">0</td><td class="source">                    saveClipp = false;</td></tr><tr class="miss"><td class="line">239</td><td class="hits">0</td><td class="source">                } else if(archive) {</td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source">                    //we just need to archive it since it's already been clipped</td></tr><tr class="miss"><td class="line">241</td><td class="hits">0</td><td class="source">                    return _archiveModel.add(suggestedClipp, function(err, saved) {</td></tr><tr class="miss"><td class="line">242</td><td class="hits">0</td><td class="source">                        if(err) return done(err);</td></tr><tr class="miss"><td class="line">243</td><td class="hits">0</td><td class="source">                        return done(null, saved);</td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source">                //then we need to see if this was already archived</td></tr><tr class="miss"><td class="line">247</td><td class="hits">0</td><td class="source">                if(saveClipp) {</td></tr><tr class="miss"><td class="line">248</td><td class="hits">0</td><td class="source">                    _archiveModel</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">                        .find({</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source">                            url: suggestedClipp.url,</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source">                            notebook: notebookId</td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source">                        })</td></tr><tr><td class="line">253</td><td class="hits"></td><td class="source">                        .exec(function(err, archClipps) {</td></tr><tr class="miss"><td class="line">254</td><td class="hits">0</td><td class="source">                            if(err) return done(err);</td></tr><tr class="miss"><td class="line">255</td><td class="hits">0</td><td class="source">                            if(archClipps.length &gt; 0) {</td></tr><tr class="miss"><td class="line">256</td><td class="hits">0</td><td class="source">                                console.log(&quot;clipp already archived&quot;);</td></tr><tr class="miss"><td class="line">257</td><td class="hits">0</td><td class="source">                                return done();</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source">                            }</td></tr><tr class="miss"><td class="line">259</td><td class="hits">0</td><td class="source">                            suggestedClipp.save(function(err, saved) {</td></tr><tr class="miss"><td class="line">260</td><td class="hits">0</td><td class="source">                                if(err)return done(err);</td></tr><tr class="miss"><td class="line">261</td><td class="hits">0</td><td class="source">                                return done(null, saved);</td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source">                            </td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="miss"><td class="line">266</td><td class="hits">0</td><td class="source">                    suggestedClipp.save(function(err, saved) {</td></tr><tr class="miss"><td class="line">267</td><td class="hits">0</td><td class="source">                        if(err)return done(err);</td></tr><tr class="miss"><td class="line">268</td><td class="hits">0</td><td class="source">                        return done(null, saved);</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source">            });    </td></tr><tr><td class="line">272</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">273</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">274</td><td class="hits">1</td><td class="source">    var _unarchive = function(){</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">276</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">278</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">279</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source">        Archive: {</td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source">            Model: _archiveModel,</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source">            Schema: _schema,</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source">            add: _archive,</td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source">            addMany: _archiveMany,</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source">            remove: _unarchive</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">        convertToNormalClippsMany: _convertToNormalClippsMany,</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source">        checkForDuplicatesAndSave: _checkForDuplicatesAndSave,</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">292</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">293</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">295</td><td class="hits">1</td><td class="source">module.exports = SuggestedClippModel;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/suggested_clipp_error.js">/Users/warner/code/clipppr/primeloop-api/models/suggested_clipp_error.js</h2><div id="stats" class="low"><div class="percentage">44%</div><div class="sloc">25</div><div class="hits">11</div><div class="misses">14</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var SuggestedClippErrorModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        kaster = require(&quot;kaster-mongoose&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        mongoosastic = require(&quot;mongoosastic&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        ObjectUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/objects&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        SuggestedClipp = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/./suggested_clipp&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;);</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        error: String,</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        rawError: String,</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        errorType: String,</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        suggestedClipp: {type: String, ref: &quot;SuggestedClipp&quot;},</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        reviewedBy: {type: String, ref: &quot;User&quot;},</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        created: {type: Date, &quot;default&quot;: Date.now},</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        reviewed: {type: Boolean, &quot;default&quot;: false},</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        reviewedDate: {type: Date, &quot;default&quot;: null},</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        notes: String</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">25</td><td class="hits">1</td><td class="source">    var _errorTypeFilter = [</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        &quot;http_error&quot;,</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        &quot;request_timeout&quot;,</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        &quot;scraping_problem&quot;,</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        &quot;other&quot;</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    ];</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">    </td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">34</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">    // _schema.plugin(kaster, {</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">    //     name: &quot;SuggestedClippError&quot;,</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">    //     region: Settings.kaster.region,</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">    //     namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    //     topic: Settings.kaster.topics.data</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">    // });</td></tr><tr class="hit"><td class="line">42</td><td class="hits">1</td><td class="source">    _schema.plugin(mongoosastic, {</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">        index: Settings.elasticsearch.data_index,</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">        protocol: Settings.elasticsearch.protocol,</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">        host: Settings.elasticsearch.host,</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        port: Settings.elasticsearch.port,</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">        auth: Settings.elasticsearch.user + &quot;:&quot; + Settings.elasticsearch.password</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">     * Saves the page with the new error once completed</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">     */</td></tr><tr class="hit"><td class="line">53</td><td class="hits">1</td><td class="source">    _schema.post(&quot;save&quot;, function(pageError){</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">        Page = mongoose.model(&quot;Page&quot;);</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">        if(pageError.page) {</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">            Page</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">                .findOne({_id: pageError.page})</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">                .exec(function(err, page) {</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">                    if(err) console.log(&quot;Error:&quot;, err);</td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="source">                    if(page) {</td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="source">                        if(!pageError.reviewed &amp;&amp; page.error !=pageError._id) {</td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="source">                            page.error = pageError._id;</td></tr><tr class="miss"><td class="line">64</td><td class="hits">0</td><td class="source">                            page.markModified(&quot;error&quot;);</td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="source">                        } else if(pageError.reviewed &amp;&amp; page.error == pageError._id) {</td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">                            page.error = null;</td></tr><tr class="miss"><td class="line">67</td><td class="hits">0</td><td class="source">                            page.markModified(&quot;error&quot;);</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">                        </td></tr><tr class="miss"><td class="line">70</td><td class="hits">0</td><td class="source">                        page.save(function(err, saved) {</td></tr><tr class="miss"><td class="line">71</td><td class="hits">0</td><td class="source">                            if(err) console.log(&quot;Error:&quot;, err);</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">                    } </td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">                    </td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">     * Sets All the properties given by the input object on the model instance</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">     * @param  {Object} data An object with all the properties to be set</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">     * @return {Object}      Reference to this</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">     */</td></tr><tr class="hit"><td class="line">84</td><td class="hits">1</td><td class="source">    _schema.methods.setAll = function(data) {</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="source">        return ObjectUtils.copyAllProperties(data, this);</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">    </td></tr><tr class="hit"><td class="line">89</td><td class="hits">1</td><td class="source">    var _model = mongoose.model(&quot;SuggestedClipp.Error&quot;, _schema);</td></tr><tr class="hit"><td class="line">90</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">97</td><td class="hits">1</td><td class="source">module.exports = SuggestedClippErrorModel;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/tracker.js">/Users/warner/code/clipppr/primeloop-api/models/tracker.js</h2><div id="stats" class="terrible"><div class="percentage">21%</div><div class="sloc">14</div><div class="hits">3</div><div class="misses">11</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var </td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">    Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">    kaster = require(&quot;kaster&quot;);</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">6</td><td class="hits">1</td><td class="source">var TrackerModel = function(props){</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">8</td><td class="hits">0</td><td class="source">    var </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        ObjectUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/objects&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;),</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        that = this;</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">13</td><td class="hits">0</td><td class="source">    that._id = uuid.v4();</td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="source">    that.created = Date.now();</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">16</td><td class="hits">0</td><td class="source">    ObjectUtils.copyAllProperties(props, that);</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="source">    that.toObject = function(){</td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">        for(var j in that){</td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="source">            if(typeof that[j] === &quot;function&quot;) delete that[j];</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">        return that;</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">26</td><td class="hits">0</td><td class="source">    that.save = function(done){</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">28</td><td class="hits">0</td><td class="source">        kaster.send({</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">            name: &quot;Tracker&quot;,</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">            region: Settings.kaster.region,</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">            namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">            topic: Settings.kaster.topics.activity</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        }, that.toObject(), done);    </td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">36</td><td class="hits">0</td><td class="source">    return that;</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">40</td><td class="hits">1</td><td class="source">module.exports = TrackerModel;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/tracking_page.js">/Users/warner/code/clipppr/primeloop-api/models/tracking_page.js</h2><div id="stats" class="medium"><div class="percentage">73%</div><div class="sloc">118</div><div class="hits">87</div><div class="misses">31</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var TrackingPageModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        ObjectUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/objects&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        UrlUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/urls&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        request = require(&quot;request&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        cheerio = require(&quot;cheerio&quot;),</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        mongoosastic = require(&quot;mongoosastic&quot;),</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        Validations = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/validations&quot;),</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        Hashids = require(&quot;hashids&quot;),</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        rclient = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/redis&quot;);</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">17</td><td class="hits">1</td><td class="source">    var _timeAgo = function(hours){</td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="source">        return function(){</td></tr><tr class="miss"><td class="line">19</td><td class="hits">0</td><td class="source">            return new Date().getTime() - (1000*60*60*hours);</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">23</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        _id: { type: String, &quot;default&quot;: uuid.v4 },</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        url: { type: String, required: true, validate: Validations.url},</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        urlHash: {type:String, unique: true, required:true, index:true},</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        title: String,</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        published: Date,</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        author: {</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">            name: String,</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">            twitter: String,</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">            email: String,</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">            website: String</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        created: {type: Date, &quot;default&quot;: Date.now},</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">        trackingUrls: [{type: String, ref: &quot;TrackingUrl&quot;}],</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        rawHtml: String,</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        metaTags: String,</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">        pageErrors:  [{type: String}],</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">        globalHash: String,</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">        lastUpdated: Date</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">45</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">47</td><td class="hits">1</td><td class="source">    _schema.plugin(mongoosastic, {</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">        index: Settings.elasticsearch.data_index,</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">        protocol: Settings.elasticsearch.protocol,</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">        host: Settings.elasticsearch.host,</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">        port: Settings.elasticsearch.port,</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">        auth: Settings.elasticsearch.user + &quot;:&quot; + Settings.elasticsearch.password</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">    /**</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">     * Sets All the properties given by the input object on the model instance</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">     * @param  {Object} data An object with all the properties to be set</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">     * @return {Object}      Reference to this</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">     */</td></tr><tr class="hit"><td class="line">60</td><td class="hits">1</td><td class="source">    _schema.methods.setAll = function(data) {</td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="source">        return ObjectUtils.copyAllProperties(data, this);</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">    //Here is where we save to redis after it's done saving to mongo</td></tr><tr class="hit"><td class="line">65</td><td class="hits">1</td><td class="source">    _schema.post(&quot;save&quot;, function(){</td></tr><tr class="hit"><td class="line">66</td><td class="hits">54</td><td class="source">        var that = this;</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">        //now we need to save it to redis store</td></tr><tr class="hit"><td class="line">69</td><td class="hits">54</td><td class="source">        var id = Settings.redis.loopPagePrefix + that._id;</td></tr><tr class="hit"><td class="line">70</td><td class="hits">54</td><td class="source">        var newTrack = JSON.stringify(that.toObject());</td></tr><tr class="hit"><td class="line">71</td><td class="hits">54</td><td class="source">        rclient.set(id, newTrack, function(err, reply){</td></tr><tr class="hit"><td class="line">72</td><td class="hits">54</td><td class="source">            if(err) console.log(&quot;redis err &quot;, err);</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">76</td><td class="hits">1</td><td class="source">    _schema.path('url').set(function (url) {</td></tr><tr class="hit"><td class="line">77</td><td class="hits">10</td><td class="source">        this.urlHash = UrlUtils.urlToHash(url);</td></tr><tr class="hit"><td class="line">78</td><td class="hits">10</td><td class="source">        return url;</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">81</td><td class="hits">1</td><td class="source">    var</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">        _model = mongoose.model(&quot;TrackingPage&quot;, _schema);</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">84</td><td class="hits">1</td><td class="source">    var _generateOrFindTrackingPage = function(url, done) {</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">        // console.log(&quot;calling _generateOrFindTrackingPage %s&quot;, url);</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">        //this takes in a url and then either creates or finds a Page</td></tr><tr class="hit"><td class="line">87</td><td class="hits">49</td><td class="source">        var log = {</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">            url: url</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">91</td><td class="hits">49</td><td class="source">        var pageErrors = [];</td></tr><tr class="hit"><td class="line">92</td><td class="hits">49</td><td class="source">        _getMetaInfo(url, log, function(err, data){</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">            // console.log(&quot;called _getMetaInfo %j, %j&quot;, err,data);</td></tr><tr class="hit"><td class="line">94</td><td class="hits">49</td><td class="source">            if(err) {</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">                //depending on the error we may still want to create the page and flag it</td></tr><tr class="hit"><td class="line">96</td><td class="hits">2</td><td class="source">                if(err == &quot;No URL&quot;) {</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">                    // pageErrors.push(data.log);</td></tr><tr class="miss"><td class="line">98</td><td class="hits">0</td><td class="source">                    return done(&quot;No URL could be found&quot;);</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="hit"><td class="line">100</td><td class="hits">2</td><td class="source">                    return done(err, null);</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">            //do a search for the url hash to see if it already exists</td></tr><tr class="hit"><td class="line">106</td><td class="hits">47</td><td class="source">            var urlHash = UrlUtils.urlToHash(data.url);</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">            // console.log(&quot;urlHash to search on %s&quot;, urlHash);</td></tr><tr class="hit"><td class="line">108</td><td class="hits">47</td><td class="source">            _model.findOne({</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">                urlHash: urlHash</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">            .exec(function(err, trackingPage){</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">                // console.log(&quot;searched for url %j, %j&quot;, err, trackingPage);</td></tr><tr class="hit"><td class="line">113</td><td class="hits">47</td><td class="source">                if(!trackingPage) {</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">                    //create a new page</td></tr><tr class="hit"><td class="line">115</td><td class="hits">10</td><td class="source">                    if(!data.title) data.title = data.url;</td></tr><tr class="hit"><td class="line">116</td><td class="hits">10</td><td class="source">                    var page = _model({</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">                        url: data.url,</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">                        title: data.title,</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">                        description: data.description,</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">                        urlHash: urlHash</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">                    });</td></tr><tr class="hit"><td class="line">122</td><td class="hits">10</td><td class="source">                    var hashids = new Hashids(page._id, 6);</td></tr><tr class="hit"><td class="line">123</td><td class="hits">10</td><td class="source">                    page.globalHash = hashids.encrypt(0);</td></tr><tr class="hit"><td class="line">124</td><td class="hits">10</td><td class="source">                    page.save(function(err, saved){</td></tr><tr class="hit"><td class="line">125</td><td class="hits">10</td><td class="source">                        return done(null, saved);</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="hit"><td class="line">129</td><td class="hits">37</td><td class="source">                    return done(null, trackingPage);</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">135</td><td class="hits">1</td><td class="source">    var _getMetaInfo = function(url, log, done) {</td></tr><tr class="hit"><td class="line">136</td><td class="hits">49</td><td class="source">        if(!url || !url.trim()) {</td></tr><tr class="miss"><td class="line">137</td><td class="hits">0</td><td class="source">            if(log) log.error = &quot;No URL&quot;;</td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="source">            return done(&quot;No URL&quot;, {log:log});</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">        //try Facebook first, fallback to manual request</td></tr><tr class="hit"><td class="line">141</td><td class="hits">49</td><td class="source">        request({</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">            url: &quot;https://graph.facebook.com?scrape=true&amp;id=&quot;+encodeURIComponent(url),</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">            json: true,</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">            method: &quot;POST&quot;</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">        }, function(err, resp, body){</td></tr><tr class="hit"><td class="line">146</td><td class="hits">49</td><td class="source">            if(err || !body || body.error || !body.title) {</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">                // console.log(&quot;facebook didn't like the url&quot;);</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source">                //Let's do something else here</td></tr><tr class="hit"><td class="line">149</td><td class="hits">14</td><td class="source">                return _getMetaInfoScrape(url, log, done);</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">151</td><td class="hits">35</td><td class="source">            log.processedUrl = body.url;</td></tr><tr class="hit"><td class="line">152</td><td class="hits">35</td><td class="source">            body.log = log;</td></tr><tr class="hit"><td class="line">153</td><td class="hits">35</td><td class="source">            return done(err, body);</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">157</td><td class="hits">1</td><td class="source">    var _getMetaInfoScrape = function(url, log, done) {</td></tr><tr class="hit"><td class="line">158</td><td class="hits">14</td><td class="source">        if(!url || !url.trim()) {</td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="source">            if(log) log.error = &quot;No URL&quot;;</td></tr><tr class="miss"><td class="line">160</td><td class="hits">0</td><td class="source">            return done(&quot;No URL&quot;, {log:log});</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">162</td><td class="hits">14</td><td class="source">        var headers = {</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">            'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/30.0.1599.69 Safari/537.36'</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">        };</td></tr><tr class="hit"><td class="line">165</td><td class="hits">14</td><td class="source">        request({</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">            url: url,</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">            headers:headers,</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">            method: &quot;GET&quot;,</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">            timeout: 60000</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">        }, function(err, resp, body){</td></tr><tr class="hit"><td class="line">171</td><td class="hits">14</td><td class="source">            if(err) {</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">                // console.log(&quot;error contacting site: &quot; + err, {url: url, statusCode: 500});</td></tr><tr class="miss"><td class="line">173</td><td class="hits">0</td><td class="source">                log.error = &quot;Can't connect to server (500) for that url. Site may be down, inaccessible, or not be a valid domain.&quot;;</td></tr><tr class="miss"><td class="line">174</td><td class="hits">0</td><td class="source">                return done(log.error, {url: url, statusCode: 500, log:log});</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">            //console.log(&quot;retrieved: &quot; + JSON.stringify(resp.headers) + &quot;: url : &quot; + resp.url);</td></tr><tr class="hit"><td class="line">177</td><td class="hits">14</td><td class="source">            if(resp.statusCode &gt;= 400 &amp;&amp; resp.statusCode &lt; 500) {</td></tr><tr class="hit"><td class="line">178</td><td class="hits">2</td><td class="source">                log.error = &quot;We get a page access error (&quot; + resp.statusCode + &quot;) for that url. Check the URL to make sure it is accessible normally.&quot;;</td></tr><tr class="hit"><td class="line">179</td><td class="hits">2</td><td class="source">                return done(log.error, {url: url, statusCode: resp.statusCode, log:log});</td></tr><tr class="hit"><td class="line">180</td><td class="hits">12</td><td class="source">            } else if(resp.statusCode &gt;= 500) {</td></tr><tr class="miss"><td class="line">181</td><td class="hits">0</td><td class="source">                log.error = &quot;We get a server error (&quot; + resp.statusCode + &quot;) for that url. Site may be down or inaccessible.&quot;;</td></tr><tr class="miss"><td class="line">182</td><td class="hits">0</td><td class="source">                return done(log.error, {url: url, statusCode: resp.statusCode, log:log});</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">184</td><td class="hits">12</td><td class="source">            if(resp.headers[&quot;content-type&quot;]) {</td></tr><tr class="hit"><td class="line">185</td><td class="hits">12</td><td class="source">                if(resp.headers[&quot;content-type&quot;].toLowerCase().indexOf(&quot;text/html&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">186</td><td class="hits">0</td><td class="source">                    log.info = &quot;Not HTML [&quot; +resp.headers[&quot;content-type&quot;].toLowerCase() +&quot;]&quot;;</td></tr><tr class="miss"><td class="line">187</td><td class="hits">0</td><td class="source">                    return done(null, { url: url, log:log});</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">                } </td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="miss"><td class="line">190</td><td class="hits">0</td><td class="source">                console.log(&quot;missing content-type in headers for url &quot;+url);</td></tr><tr class="miss"><td class="line">191</td><td class="hits">0</td><td class="source">                log.info = &quot;missing content-type in headers&quot;;</td></tr><tr class="miss"><td class="line">192</td><td class="hits">0</td><td class="source">                return done(null, { url: url, log:log});</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">            </td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">197</td><td class="hits">12</td><td class="source">            var</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">                $ = cheerio.load(body),</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">                data = {};</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">201</td><td class="hits">12</td><td class="source">            data.rawHtml = body;</td></tr><tr class="hit"><td class="line">202</td><td class="hits">12</td><td class="source">            data.title = $(&quot;title&quot;).text().replace(/(\r\n|\n|\r)/gm,&quot; &quot;).trim();</td></tr><tr class="hit"><td class="line">203</td><td class="hits">12</td><td class="source">            data.url =  $(&quot;meta[property='og:url']&quot;).attr(&quot;content&quot;) || $(&quot;link[rel=canonical]&quot;).attr(&quot;href&quot;) || url;</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">205</td><td class="hits">12</td><td class="source">            try {</td></tr><tr class="hit"><td class="line">206</td><td class="hits">12</td><td class="source">                Validations.checkUrl(data.url);</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">            } catch (e) {</td></tr><tr class="hit"><td class="line">208</td><td class="hits">6</td><td class="source">                data.url = url;</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">210</td><td class="hits">12</td><td class="source">            data.description = _decodeHTML($,$(&quot;meta[property='og:description']&quot;).attr(&quot;content&quot;)) || _decodeHTML($,$(&quot;meta[name=description]&quot;).attr(&quot;content&quot;)) || null;</td></tr><tr class="hit"><td class="line">211</td><td class="hits">12</td><td class="source">            data.site_name = _decodeHTML($,$(&quot;meta[property='og:site_name']&quot;).attr(&quot;content&quot;)) || null;</td></tr><tr class="hit"><td class="line">212</td><td class="hits">12</td><td class="source">            log.processedUrl = data.url;</td></tr><tr class="hit"><td class="line">213</td><td class="hits">12</td><td class="source">            data.log = log;</td></tr><tr class="hit"><td class="line">214</td><td class="hits">12</td><td class="source">            return done(null, data);</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">218</td><td class="hits">1</td><td class="source">    var _getAllHeaderMetaTags = function(url, log, done) {</td></tr><tr class="hit"><td class="line">219</td><td class="hits">3</td><td class="source">        if(!url || !url.trim()) {</td></tr><tr class="miss"><td class="line">220</td><td class="hits">0</td><td class="source">            if(log) log.error = &quot;No URL&quot;;</td></tr><tr class="miss"><td class="line">221</td><td class="hits">0</td><td class="source">            return done(&quot;No URL&quot;, {log:log});</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">223</td><td class="hits">3</td><td class="source">        var headers = {</td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source">            'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/30.0.1599.69 Safari/537.36'</td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source">        };</td></tr><tr class="hit"><td class="line">226</td><td class="hits">3</td><td class="source">        request({</td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source">            url: url,</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source">            headers:headers,</td></tr><tr><td class="line">229</td><td class="hits"></td><td class="source">            method: &quot;GET&quot;,</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">            timeout: 60000</td></tr><tr><td class="line">231</td><td class="hits"></td><td class="source">        }, function(err, resp, body){</td></tr><tr class="hit"><td class="line">232</td><td class="hits">3</td><td class="source">            if(err) {</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">                // console.log(&quot;error contacting site: &quot; + err, {url: url, statusCode: 500});</td></tr><tr class="miss"><td class="line">234</td><td class="hits">0</td><td class="source">                log.error = &quot;Can't connect to server (500)  for that url - &quot; + url + &quot; Site may be down, inaccessible, or not be a valid domain.&quot;;</td></tr><tr class="miss"><td class="line">235</td><td class="hits">0</td><td class="source">                return done(log.error, {url: url, statusCode: 500, log:log});</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source">            //console.log(&quot;retrieved: &quot; + JSON.stringify(resp.headers) + &quot;: url : &quot; + resp.url);</td></tr><tr class="hit"><td class="line">238</td><td class="hits">3</td><td class="source">            if(resp.statusCode &gt;= 400 &amp;&amp; resp.statusCode &lt; 500) {</td></tr><tr class="miss"><td class="line">239</td><td class="hits">0</td><td class="source">                log.error = &quot;We get a page access error (&quot; + resp.statusCode + &quot;)  for that url - &quot; + url + &quot; Check the URL to make sure it is accessible normally.&quot;;</td></tr><tr class="miss"><td class="line">240</td><td class="hits">0</td><td class="source">                return done(log.error, {url: url, statusCode: resp.statusCode, log:log});</td></tr><tr class="hit"><td class="line">241</td><td class="hits">3</td><td class="source">            } else if(resp.statusCode &gt;= 500) {</td></tr><tr class="miss"><td class="line">242</td><td class="hits">0</td><td class="source">                log.error = &quot;We get a server error (&quot; + resp.statusCode + &quot;)  for that url - &quot; + url + &quot; Site may be down or inaccessible.&quot;;</td></tr><tr class="miss"><td class="line">243</td><td class="hits">0</td><td class="source">                return done(log.error, {url: url, statusCode: resp.statusCode, log:log});</td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">245</td><td class="hits">3</td><td class="source">            if(resp.headers[&quot;content-type&quot;]) {</td></tr><tr class="hit"><td class="line">246</td><td class="hits">3</td><td class="source">                if(resp.headers[&quot;content-type&quot;].toLowerCase().indexOf(&quot;text/html&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">247</td><td class="hits">0</td><td class="source">                    log.info = &quot;Not HTML [&quot; +resp.headers[&quot;content-type&quot;].toLowerCase() +&quot;]&quot;;</td></tr><tr class="miss"><td class="line">248</td><td class="hits">0</td><td class="source">                    return done(null, { url: url,rawHtml: resp.headers[&quot;content-type&quot;].toLowerCase(), log:log});</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="miss"><td class="line">251</td><td class="hits">0</td><td class="source">                console.log(&quot;missing content-type in headers for url &quot;+url);</td></tr><tr class="miss"><td class="line">252</td><td class="hits">0</td><td class="source">                log.info = &quot;missing content-type in headers&quot;;</td></tr><tr class="miss"><td class="line">253</td><td class="hits">0</td><td class="source">                return done(null, { url: url, log:log});</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">            </td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">257</td><td class="hits">3</td><td class="source">            var</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source">                $ = cheerio.load(body),</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source">                data = {};</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">261</td><td class="hits">3</td><td class="source">            data.rawHtml = body;</td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source">            // data.metaTags = $(&quot;meta&quot;);</td></tr><tr class="hit"><td class="line">263</td><td class="hits">3</td><td class="source">            var container = $('&lt;title/&gt;');</td></tr><tr class="hit"><td class="line">264</td><td class="hits">3</td><td class="source">            $(&quot;head meta&quot;).each(function(i,val) {</td></tr><tr class="hit"><td class="line">265</td><td class="hits">60</td><td class="source">                if(!$(val).attr('http-equiv')) {</td></tr><tr class="hit"><td class="line">266</td><td class="hits">57</td><td class="source">                    container.append(val);</td></tr><tr><td class="line">267</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source">                </td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">            });</td></tr><tr class="hit"><td class="line">270</td><td class="hits">3</td><td class="source">            data.metaTags = container.html();</td></tr><tr class="hit"><td class="line">271</td><td class="hits">3</td><td class="source">            return done(null, data);</td></tr><tr><td class="line">272</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">273</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">276</td><td class="hits">1</td><td class="source">    var _decodeHTML = function($, html) {</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source">        //console.log(&quot;calling decode html&quot;);</td></tr><tr class="hit"><td class="line">278</td><td class="hits">24</td><td class="source">        var ht = $('&lt;div/&gt;').html(html);</td></tr><tr class="hit"><td class="line">279</td><td class="hits">48</td><td class="source">        if(ht.text) return ht.text();</td></tr><tr class="miss"><td class="line">280</td><td class="hits">0</td><td class="source">        return ht;</td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">283</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema,</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source">        generateOrFindTrackingPage: _generateOrFindTrackingPage,</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">        getMetaInfo: _getMetaInfo,</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source">        getMetaInfoScrape: _getMetaInfoScrape,</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source">        getAllHeaderMetaTags: _getAllHeaderMetaTags</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">292</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">293</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">295</td><td class="hits">1</td><td class="source">module.exports = TrackingPageModel;</td></tr><tr><td class="line">296</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/tracking_url.js">/Users/warner/code/clipppr/primeloop-api/models/tracking_url.js</h2><div id="stats" class="high"><div class="percentage">96%</div><div class="sloc">59</div><div class="hits">57</div><div class="misses">2</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var TrackingUrlModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        kaster = require(&quot;kaster-mongoose&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        mongoosastic = require(&quot;mongoosastic&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        async = require(&quot;async&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        Validations = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/validations&quot;),</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        TrackingPage = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../models/tracking_page&quot;),</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        Hashids = require(&quot;hashids&quot;),</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        rclient = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/redis&quot;);</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        campaign: {type:String, ref:'Notebook'},</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        user: {type: String, ref: 'User'},</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        channel: {type: String, &quot;default&quot;:&quot;twitter&quot;},</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        url: { type: String, required: true, validate: Validations.url },</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        canonicalUrl: { type: String, required: true, validate: Validations.url },</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        generatedUrl: String,</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        retargeted: Boolean,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        retargetCampaign: String,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        retargetCampaignHtmlCodes: [String],</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        shortUrl: String,</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        globalUrl: String,</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        urlHash: {type:String, unique: true},</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        analytics: {type:Object, es_indexed:false},</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        created: {type: Date, &quot;default&quot;: Date.now},</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        trackingPage: {type: String, ref: &quot;TrackingPage&quot;},</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        campaignInactive: {type:Boolean, &quot;default&quot;:false}</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">36</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">38</td><td class="hits">1</td><td class="source">    _schema.plugin(mongoosastic, {</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">        index: Settings.elasticsearch.data_index,</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">        protocol: Settings.elasticsearch.protocol,</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">        host: Settings.elasticsearch.host,</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">        port: Settings.elasticsearch.port,</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">        auth: Settings.elasticsearch.user + &quot;:&quot; + Settings.elasticsearch.password</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">46</td><td class="hits">1</td><td class="source">    var _model = mongoose.model(&quot;TrackingUrl&quot;, _schema);</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">    //Here is where we save to redis after it's done saving to mongo</td></tr><tr class="hit"><td class="line">49</td><td class="hits">1</td><td class="source">    _schema.post(&quot;save&quot;, function(){</td></tr><tr class="hit"><td class="line">50</td><td class="hits">44</td><td class="source">        var that = this;</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">        //now we need to save it to redis store</td></tr><tr class="hit"><td class="line">53</td><td class="hits">44</td><td class="source">        var id = Settings.redis.loopTrackingPrefix + that.urlHash;</td></tr><tr class="hit"><td class="line">54</td><td class="hits">44</td><td class="source">        var newTrack = JSON.stringify(that.toObject());</td></tr><tr class="hit"><td class="line">55</td><td class="hits">44</td><td class="source">        rclient.set(id, newTrack, function(err, reply){</td></tr><tr class="hit"><td class="line">56</td><td class="hits">44</td><td class="source">            if(err) console.log(&quot;redis err &quot;, err);</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">    });</td></tr><tr class="hit"><td class="line">59</td><td class="hits">1</td><td class="source">    var _generateRetargetUrl = function(userId, campaignId, channel, url, retargetCampaigns, done) {</td></tr><tr class="hit"><td class="line">60</td><td class="hits">46</td><td class="source">        TrackingPage.generateOrFindTrackingPage(url, function(err, page){</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">            // console.log(&quot;error %j, url %s, page %j&quot;, err, url, page);</td></tr><tr class="hit"><td class="line">62</td><td class="hits">48</td><td class="source">            if(err) return done(err);</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">            // url = page.url;</td></tr><tr class="hit"><td class="line">64</td><td class="hits">44</td><td class="source">            var tracking = _model({</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">                user: userId,</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">                campaign: campaignId,</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">                channel: channel,</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">                retarget: true,</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">                retargetCampaignHtmlCodes: [],</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">                url: url,</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">                trackingPage: page._id,</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">                canonicalUrl: page.url</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">            });</td></tr><tr class="hit"><td class="line">74</td><td class="hits">44</td><td class="source">            for(var i = 0; i &lt; retargetCampaigns.length; i++) {</td></tr><tr class="hit"><td class="line">75</td><td class="hits">1852</td><td class="source">                if(retargetCampaigns[i].retarget_code &amp;&amp; retargetCampaigns[i].enabled) {</td></tr><tr class="hit"><td class="line">76</td><td class="hits">2</td><td class="source">                    tracking.retargetCampaignHtmlCodes.push(retargetCampaigns[i].retarget_code);</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">79</td><td class="hits">44</td><td class="source">            var hashids = new Hashids(tracking._id, 6);</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">            //Here's where we'll need to put in our own shortening stuff</td></tr><tr class="hit"><td class="line">81</td><td class="hits">44</td><td class="source">            var shortCode = hashids.encrypt(0);</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">84</td><td class="hits">44</td><td class="source">            tracking.urlHash = shortCode;</td></tr><tr class="hit"><td class="line">85</td><td class="hits">44</td><td class="source">            tracking.shortUrl= Settings.retarget.destination_url + &quot;/&quot; + shortCode;</td></tr><tr class="hit"><td class="line">86</td><td class="hits">44</td><td class="source">            tracking.globalUrl= Settings.retarget.destination_url + &quot;/&quot; + page.globalHash;</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">88</td><td class="hits">44</td><td class="source">            var trackingUrl = '';</td></tr><tr class="hit"><td class="line">89</td><td class="hits">44</td><td class="source">            if(url.indexOf('?') &gt; 0) {</td></tr><tr class="hit"><td class="line">90</td><td class="hits">6</td><td class="source">                trackingUrl = url + &quot;&amp;&quot;;</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="hit"><td class="line">92</td><td class="hits">38</td><td class="source">                trackingUrl = url + &quot;?&quot;;</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">94</td><td class="hits">44</td><td class="source">            trackingUrl += &quot;utm_campaign=primeloop&quot;;</td></tr><tr class="hit"><td class="line">95</td><td class="hits">44</td><td class="source">            trackingUrl += &quot;&amp;utm_medium=&quot; + channel;</td></tr><tr class="hit"><td class="line">96</td><td class="hits">44</td><td class="source">            trackingUrl += &quot;&amp;utm_source=&quot; + tracking._id;</td></tr><tr class="hit"><td class="line">97</td><td class="hits">44</td><td class="source">            tracking.generatedUrl = trackingUrl;</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">99</td><td class="hits">44</td><td class="source">            tracking.save(function(err, saved) {</td></tr><tr class="hit"><td class="line">100</td><td class="hits">44</td><td class="source">                if(err) done(err);</td></tr><tr class="hit"><td class="line">101</td><td class="hits">44</td><td class="source">                done(null, saved);</td></tr><tr class="hit"><td class="line">102</td><td class="hits">44</td><td class="source">                page.trackingUrls.push(saved._id);</td></tr><tr class="hit"><td class="line">103</td><td class="hits">44</td><td class="source">                page.save();</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">109</td><td class="hits">1</td><td class="source">    var _updateTrackingUrlsWithRetargetedCampaigns = function(campaignId, retargetCampaigns,campaignInactive, done) {</td></tr><tr class="hit"><td class="line">110</td><td class="hits">5</td><td class="source">        var htmlCodes = [];</td></tr><tr class="hit"><td class="line">111</td><td class="hits">5</td><td class="source">        for(var i = 0; i &lt; retargetCampaigns.length; i++) {</td></tr><tr class="hit"><td class="line">112</td><td class="hits">15</td><td class="source">            if(retargetCampaigns[i].retarget_code &amp;&amp; retargetCampaigns[i].enabled) {</td></tr><tr class="hit"><td class="line">113</td><td class="hits">9</td><td class="source">                htmlCodes.push(retargetCampaigns[i].retarget_code);</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">116</td><td class="hits">5</td><td class="source">        _model.update({</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">            campaign: campaignId</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">                }, </td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">                {</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">                    $set: {</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">                        retargetCampaignHtmlCodes: htmlCodes</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">                },</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">                { multi: true }</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">            )</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">            .exec(function(err){</td></tr><tr class="hit"><td class="line">127</td><td class="hits">5</td><td class="source">                if(err) return done(err);</td></tr><tr class="hit"><td class="line">128</td><td class="hits">5</td><td class="source">                return _updateTrackingUrlsWithRetargetedCampaignRedis(campaignId, done);</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">132</td><td class="hits">1</td><td class="source">    var _updateTrackingUrlsWithRetargetedCampaignRedis = function(campaignId, done) {</td></tr><tr class="hit"><td class="line">133</td><td class="hits">5</td><td class="source">        _model</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">                campaign: campaignId</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">            .exec(function(err, trackingUrls){</td></tr><tr class="hit"><td class="line">138</td><td class="hits">5</td><td class="source">                if(err) {</td></tr><tr class="miss"><td class="line">139</td><td class="hits">0</td><td class="source">                    console.log(&quot;error retrieving urls for campaign %s&quot;, campaignId);</td></tr><tr class="miss"><td class="line">140</td><td class="hits">0</td><td class="source">                    return done();</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">                }</td></tr><tr class="hit"><td class="line">142</td><td class="hits">5</td><td class="source">                async.each(trackingUrls, function(tracking, callback){</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">                    //now we need to save it to redis store</td></tr><tr class="hit"><td class="line">144</td><td class="hits">35</td><td class="source">                    var id = Settings.redis.loopTrackingPrefix + tracking.urlHash;</td></tr><tr class="hit"><td class="line">145</td><td class="hits">35</td><td class="source">                    var newTrack = JSON.stringify(tracking);</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">                    // console.log(&quot;processing track &quot; + id);</td></tr><tr class="hit"><td class="line">147</td><td class="hits">35</td><td class="source">                    rclient.set(id, newTrack, function(err, reply){</td></tr><tr class="hit"><td class="line">148</td><td class="hits">35</td><td class="source">                        return callback(err);</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">                }, function(err){</td></tr><tr class="hit"><td class="line">151</td><td class="hits">5</td><td class="source">                    if(err) return done(err);</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">                    // console.log(&quot;finished calling _updateTrackingUrlsWithRetargetedCampaignRedis&quot;);</td></tr><tr class="hit"><td class="line">153</td><td class="hits">5</td><td class="source">                    return done();</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">159</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema,</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">        generateRetargetUrl: _generateRetargetUrl,</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">        updateTrackingUrlsWithRetargetedCampaigns: _updateTrackingUrlsWithRetargetedCampaigns</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">169</td><td class="hits">1</td><td class="source">module.exports = TrackingUrlModel;</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/tracking_url_activity.js">/Users/warner/code/clipppr/primeloop-api/models/tracking_url_activity.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">8</div><div class="hits">8</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var TrackingUrlActivityModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        mongoosastic = require(&quot;mongoosastic&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        Validations = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/validations&quot;);</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        trackingId: {type:String, ref:'TrackingUrl'},</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        campaign: {type:String, ref:'Notebook'},</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        data: {type:Object, es_indexed:false},</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        created: {type: Date, &quot;default&quot;: Date.now},</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        isBot: {type:Boolean, default:false},</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        inactive: {type:Boolean, &quot;default&quot;:false}</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">22</td><td class="hits">1</td><td class="source">    _schema.plugin(mongoosastic, {</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        index: Settings.elasticsearch.data_index,</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        protocol: Settings.elasticsearch.protocol,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        host: Settings.elasticsearch.host,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        port: Settings.elasticsearch.port,</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        auth: Settings.elasticsearch.user + &quot;:&quot; + Settings.elasticsearch.password</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">    var _model = mongoose.model(&quot;TrackingUrlActivity&quot;, _schema);</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">33</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">41</td><td class="hits">1</td><td class="source">module.exports = TrackingUrlActivityModel;</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/user.js">/Users/warner/code/clipppr/primeloop-api/models/user.js</h2><div id="stats" class="medium"><div class="percentage">72%</div><div class="sloc">146</div><div class="hits">106</div><div class="misses">40</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var UserModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        kaster = require(&quot;kaster-mongoose&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        mongoosastic = require(&quot;mongoosastic&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        ArrayUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/array&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        ObjectUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/objects&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;),</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        crypto = require(&quot;crypto&quot;),</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        Validations = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/validations&quot;),</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        PermissionUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/permissions&quot;),</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        AuthUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/auth&quot;),</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        ActivityLog = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../models/activitylog&quot;),</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        intercom = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/intercom&quot;);</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">    var _job = {</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        title: String,</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        company: {</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">            name: String,</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">            size: String</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">27</td><td class="hits">1</td><td class="source">    var _googleConnection = {</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        webPropertyId: String,</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        profileId: String,</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        accountId: String,</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        username: String,</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        gaCredentials: {type:Object, es_indexed:false},</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        notebooks: [String],</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        updated: Date,</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">        error: {type:Object, es_indexed:false}</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">39</td><td class="hits">1</td><td class="source">    var _externalAuth = {</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">        type: String,</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">        tokens: {type:Object, es_indexed:false},</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">        profile: {</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">            name: String,</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">            emails: [String],</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">            extra: {type:Object, es_indexed:false}</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">50</td><td class="hits">1</td><td class="source">    var _teamDiscussion = {</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">        clippId: String,</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">        currentCount: Number,</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">        updated: {type: Date, &quot;default&quot;: Date.now},</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">        updatedType: {</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">            type: String,</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">            &quot;default&quot;: &quot;viewed&quot;,</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">            enum: [&quot;viewed&quot;, &quot;notified&quot;]</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">61</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">        firstName: {type:String, required: true},</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">        lastName: {type:String},</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">        hashedPassword: String,</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">        email: { type: String, lowercase: true, required: true, validate: Validations.email, unique: true },</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">        created: {type: Date, &quot;default&quot;: Date.now},</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">        lastLogin: Date,</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">        lastAction: {type: Date, &quot;default&quot;: Date.now},</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">        job: _job,</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">        demoComplete: {type: Boolean, &quot;default&quot;: false}, //should really be tourComplete (I think)</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">        phone: String,</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">        trialOffer: {type: Boolean, &quot;default&quot;: false},</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">        customer: {type:Object, es_indexed:false},</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">        invite: {type: String},</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">        role: {type: String, &quot;default&quot;: &quot;general&quot;},</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">        tokens: [String],</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">        superAdmin: {</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">            token: {type:String, es_indexed:false},</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">            user: {type: String, ref: &quot;User&quot;, es_indexed:false}</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">        enabled: {type: Boolean, &quot;default&quot;: false},</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">        trial: {type: Number},</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">        trialStart: {type: Date},</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">        gravatarHash: String,</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">        totalMonthlyFee: Number,</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">        planOffered: String,</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">        refBy: String,</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">        prelim: Boolean,</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">        discussionHistory: [_teamDiscussion],</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">        externalAuths: [_externalAuth],</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">        google_analytics: {</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">            username: String,</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">            gaCredentials: {</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">                access_token: String,</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">                refresh_token: String,</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">                token_type: String</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">            accounts: [String],</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">            connections: [_googleConnection]</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">        settings: {</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">            emails: {</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">                new_engagement: {</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">                    type: String,</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">                    &quot;default&quot;: &quot;daily&quot;,</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">                    enum: [&quot;daily&quot;, &quot;weekly&quot;, &quot;none&quot;]</td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">                },</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">                engagement_channels: {</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">                    facebook: {type: Boolean, &quot;default&quot;: true},</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">                    twitter: {type: Boolean, &quot;default&quot;: true},</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">                    linkedin: {type: Boolean, &quot;default&quot;: true},</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source">                    comments: {type: Boolean, &quot;default&quot;: true},</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">                    googleplus: {type: Boolean, &quot;default&quot;: true},</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">                    native_count: {type:Boolean, &quot;default&quot;: true}</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">                },</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">                team_discussion: {</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">                    type: String,</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">                    &quot;default&quot;: null,</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">                    enum: [&quot;realtime&quot;, &quot;daily&quot;, &quot;none&quot;, null]</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">                },</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">                newsletter: {</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">                    type: Boolean,</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">                    &quot;default&quot;: true</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">                },</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">                beta_features: {</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">                    type: Boolean,</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">                    &quot;default&quot;: false</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source">                },</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">                suggested_actions: {</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">                    type: Boolean,</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">                    &quot;default&quot;: true</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">        purchasedNotebooks: Number</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">139</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">    // _schema.plugin(kaster, {</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">    //     name: &quot;User&quot;,</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">    //     region: Settings.kaster.region,</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">    //     namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">    //     topic: Settings.kaster.topics.data</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">    // });</td></tr><tr class="hit"><td class="line">147</td><td class="hits">1</td><td class="source">    _schema.plugin(mongoosastic, {</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source">        index: Settings.elasticsearch.data_index,</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">        protocol: Settings.elasticsearch.protocol,</td></tr><tr><td class="line">150</td><td class="hits"></td><td class="source">        host: Settings.elasticsearch.host,</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">        port: Settings.elasticsearch.port,</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">        auth: Settings.elasticsearch.user + &quot;:&quot; + Settings.elasticsearch.password</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">155</td><td class="hits">1</td><td class="source">    _schema.pre(&quot;save&quot;, function(done){</td></tr><tr class="hit"><td class="line">156</td><td class="hits">50</td><td class="source">        var that = this;</td></tr><tr class="hit"><td class="line">157</td><td class="hits">50</td><td class="source">        _updateIntercomUser(that, function(){</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source">        });</td></tr><tr class="hit"><td class="line">160</td><td class="hits">50</td><td class="source">        return done();</td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">163</td><td class="hits">1</td><td class="source">    _schema.post(&quot;save&quot;, function(){</td></tr><tr class="hit"><td class="line">164</td><td class="hits">50</td><td class="source">        var that = this, UsersWaiting = mongoose.model(&quot;User.Waiting&quot;);</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">        //Update the waiting list after a new user is created or updated</td></tr><tr class="hit"><td class="line">167</td><td class="hits">50</td><td class="source">        UsersWaiting.findOne({</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">            $or : [</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">                {user: that._id},</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">                {email: that.email.toLowerCase()}</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">            ]</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">        }, function(err, waitingUser){</td></tr><tr class="hit"><td class="line">173</td><td class="hits">50</td><td class="source">            if(err) return console.log(err);</td></tr><tr class="hit"><td class="line">174</td><td class="hits">50</td><td class="source">            if(!waitingUser) {</td></tr><tr class="hit"><td class="line">175</td><td class="hits">15</td><td class="source">                waitingUser = new UsersWaiting({</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">                    email: that.email.toLowerCase(),</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">                    created: that.created,</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">                    firstName : that.firstName,</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">                    lastName: that.lastName,</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">                    phone: that.phone</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">183</td><td class="hits">50</td><td class="source">            waitingUser.user = that._id;</td></tr><tr class="hit"><td class="line">184</td><td class="hits">50</td><td class="source">            waitingUser.isUser = true;</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">186</td><td class="hits">50</td><td class="source">            if(waitingUser.email.toLowerCase() != that.email.toLowerCase()) {</td></tr><tr class="hit"><td class="line">187</td><td class="hits">2</td><td class="source">                waitingUser.email = that.email.toLowerCase();</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">190</td><td class="hits">50</td><td class="source">            if(that.refBy) {</td></tr><tr class="miss"><td class="line">191</td><td class="hits">0</td><td class="source">                UsersWaiting.findOne({</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">                    user: that.refBy</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">                })</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">                .exec(function(err, ruser){</td></tr><tr class="miss"><td class="line">195</td><td class="hits">0</td><td class="source">                    if(err) return console.log(err);</td></tr><tr class="miss"><td class="line">196</td><td class="hits">0</td><td class="source">                    ruser.referrals.push(waitingUser._id);</td></tr><tr class="miss"><td class="line">197</td><td class="hits">0</td><td class="source">                    waitingUser.refBy = ruser._id;</td></tr><tr class="miss"><td class="line">198</td><td class="hits">0</td><td class="source">                    waitingUser.save();</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">201</td><td class="hits">50</td><td class="source">            else waitingUser.save();</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">205</td><td class="hits">1</td><td class="source">    _schema.virtual('password').set(function (password) {</td></tr><tr class="hit"><td class="line">206</td><td class="hits">3</td><td class="source">        this.hashedPassword = AuthUtils.hashPassword(password);</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">209</td><td class="hits">1</td><td class="source">    _schema.virtual('name').set(function(name){</td></tr><tr class="hit"><td class="line">210</td><td class="hits">1</td><td class="source">        if(name) {</td></tr><tr class="miss"><td class="line">211</td><td class="hits">0</td><td class="source">            var names = name.trim().split(/\s+/);</td></tr><tr class="miss"><td class="line">212</td><td class="hits">0</td><td class="source">            this.firstName = names[0];</td></tr><tr class="miss"><td class="line">213</td><td class="hits">0</td><td class="source">            for(var i = 1; i &lt; names.length; i++) {</td></tr><tr class="miss"><td class="line">214</td><td class="hits">0</td><td class="source">                this.lastName += names[i] + &quot; &quot;;</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">216</td><td class="hits">0</td><td class="source">            this.lastName = this.lastName.trim();</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">220</td><td class="hits">1</td><td class="source">    _schema.virtual('name').get(function () {</td></tr><tr class="hit"><td class="line">221</td><td class="hits">1</td><td class="source">        return this.firstName + ' ' + this.lastName;</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">224</td><td class="hits">1</td><td class="source">    _schema.path('email').set(function (email) {</td></tr><tr class="hit"><td class="line">225</td><td class="hits">25</td><td class="source">        this.gravatarHash = crypto.createHash('md5').update(email.trim().toLowerCase()).digest(&quot;hex&quot;);</td></tr><tr class="hit"><td class="line">226</td><td class="hits">25</td><td class="source">        return email;</td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">228</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">229</td><td class="hits">1</td><td class="source">    _schema.path(&quot;customer&quot;).set(function(customer){</td></tr><tr class="hit"><td class="line">230</td><td class="hits">1</td><td class="source">        if(customer &amp;&amp; customer.subscription &amp;&amp; customer.subscription.quantity) {</td></tr><tr class="miss"><td class="line">231</td><td class="hits">0</td><td class="source">            if(customer.subscription.status == &quot;canceled&quot;) {</td></tr><tr class="miss"><td class="line">232</td><td class="hits">0</td><td class="source">                this.purchasedNotebooks = 0;</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="miss"><td class="line">234</td><td class="hits">0</td><td class="source">                this.purchasedNotebooks = customer.subscription.quantity;</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">237</td><td class="hits">0</td><td class="source">           this.totalMonthlyFee = _calculateMonthlyFee(customer);</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">240</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">241</td><td class="hits">1</td><td class="source">        return {</td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source">            subscription: customer.subscription,</td></tr><tr><td class="line">243</td><td class="hits"></td><td class="source">            id: customer.id,</td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source">            created: customer.created,</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source">            account_balance: customer.account_balance,</td></tr><tr><td class="line">246</td><td class="hits"></td><td class="source">            discount: customer.discount,</td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source">            delinquent: customer.delinquent,</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source">            metadata: customer.metadata,</td></tr><tr><td class="line">249</td><td class="hits"></td><td class="source">            description: customer.description</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">253</td><td class="hits">1</td><td class="source">    var _calculateMonthlyFee = function(customer) {</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">255</td><td class="hits">0</td><td class="source">        if(!customer.subscription.plan) return 0;</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">257</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source">            percentoff = 0,</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source">            amountoff = 0;</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">261</td><td class="hits">0</td><td class="source">        if(customer.discount &amp;&amp; customer.discount.coupon &amp;&amp; customer.discount.coupon.valid) {</td></tr><tr class="miss"><td class="line">262</td><td class="hits">0</td><td class="source">            if(customer.discount.coupon.percent_off) percentoff = customer.discount.coupon.percent_off;</td></tr><tr class="miss"><td class="line">263</td><td class="hits">0</td><td class="source">            if(customer.discount.coupon.amount_off) amountoff = customer.discount.coupon.amount_off;</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">265</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">266</td><td class="hits">0</td><td class="source">        var totalMonthlyFee =</td></tr><tr><td class="line">267</td><td class="hits"></td><td class="source">            customer.subscription.quantity *</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source">            parseFloat( (customer.subscription.plan.amount - amountoff) * ((100.0-percentoff)/100.0) )/100.0;</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">270</td><td class="hits">0</td><td class="source">        if(totalMonthlyFee &lt; 0) totalMonthlyFee = 0;</td></tr><tr><td class="line">271</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">272</td><td class="hits">0</td><td class="source">        return totalMonthlyFee;</td></tr><tr><td class="line">273</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">275</td><td class="hits">1</td><td class="source">    var _getPermissions = function(user){</td></tr><tr class="hit"><td class="line">276</td><td class="hits">150</td><td class="source">        return PermissionUtils.getUserPermissionsForRole(user.role);</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">279</td><td class="hits">1</td><td class="source">    var _trialDaysLeft = function(opts) {</td></tr><tr class="miss"><td class="line">280</td><td class="hits">0</td><td class="source">        var days = (Date.now() - new Date(opts.trialStart).getTime()) / (1000*60*60*24);</td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source">        // return -1;</td></tr><tr class="miss"><td class="line">282</td><td class="hits">0</td><td class="source">        return (opts.trial - days);</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">285</td><td class="hits">1</td><td class="source">    var _updateIntercomUser = function(user, done) {</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source">        // console.log(&quot;attempting to update intercom user %s&quot;, user.email);</td></tr><tr class="hit"><td class="line">287</td><td class="hits">50</td><td class="source">        var userSettings = {};</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">        //first check to see if they exist in intercom</td></tr><tr class="hit"><td class="line">289</td><td class="hits">50</td><td class="source">        intercom.userExists(user._id, function(found) {</td></tr><tr class="hit"><td class="line">290</td><td class="hits">50</td><td class="source">            if(!found) {</td></tr><tr class="hit"><td class="line">291</td><td class="hits">19</td><td class="source">                intercom.newUser(user, null, function(){</td></tr><tr class="hit"><td class="line">292</td><td class="hits">19</td><td class="source">                    return done();</td></tr><tr><td class="line">293</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="hit"><td class="line">295</td><td class="hits">31</td><td class="source">                userSettings = ObjectUtils.copyAllProperties(user.settings, userSettings);</td></tr><tr class="hit"><td class="line">296</td><td class="hits">31</td><td class="source">                delete user.settings.notebooks;</td></tr><tr class="hit"><td class="line">297</td><td class="hits">31</td><td class="source">                var updatedSettings = {</td></tr><tr><td class="line">298</td><td class="hits"></td><td class="source">                    custom_data : ObjectUtils.flattenObject(userSettings, 0, &quot;settings&quot;)</td></tr><tr><td class="line">299</td><td class="hits"></td><td class="source">                };</td></tr><tr class="hit"><td class="line">300</td><td class="hits">31</td><td class="source">                intercom.updateUser(user.email, updatedSettings, function(err){</td></tr><tr class="hit"><td class="line">301</td><td class="hits">62</td><td class="source">                    if(err) console.log(&quot;error updating intercom user: &quot; + err);</td></tr><tr class="hit"><td class="line">302</td><td class="hits">31</td><td class="source">                    return done();</td></tr><tr><td class="line">303</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">304</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">305</td><td class="hits">50</td><td class="source">            return;</td></tr><tr><td class="line">306</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">307</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">308</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">309</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">310</td><td class="hits">1</td><td class="source">    var _tagUser = function(user, tags) {</td></tr><tr class="miss"><td class="line">311</td><td class="hits">0</td><td class="source">        intercom.userExists(user.email, function(found) {</td></tr><tr class="miss"><td class="line">312</td><td class="hits">0</td><td class="source">            if(found) {</td></tr><tr class="miss"><td class="line">313</td><td class="hits">0</td><td class="source">                intercom.tagUser(user.email, tags, function(){});</td></tr><tr><td class="line">314</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="miss"><td class="line">315</td><td class="hits">0</td><td class="source">                intercom.newUser(user, null, function(err){</td></tr><tr class="miss"><td class="line">316</td><td class="hits">0</td><td class="source">                    intercom.tagUser(user.email, tags, function(){});</td></tr><tr><td class="line">317</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">318</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">319</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">320</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">321</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">322</td><td class="hits">1</td><td class="source">    var _untagUser = function(user, tags) {</td></tr><tr class="miss"><td class="line">323</td><td class="hits">0</td><td class="source">        intercom.userExists(user.email, function(found) {</td></tr><tr class="miss"><td class="line">324</td><td class="hits">0</td><td class="source">            if(found) {</td></tr><tr class="miss"><td class="line">325</td><td class="hits">0</td><td class="source">                intercom.untagUser(user.email, tags, function(){});</td></tr><tr><td class="line">326</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="miss"><td class="line">327</td><td class="hits">0</td><td class="source">                intercom.newUser(user, null, function(err){</td></tr><tr class="miss"><td class="line">328</td><td class="hits">0</td><td class="source">                    intercom.untagUser(user.email, tags, function(){});</td></tr><tr><td class="line">329</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">330</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">331</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">332</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">333</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">334</td><td class="hits">1</td><td class="source">    _schema.methods.trialDaysLeft = function(){</td></tr><tr class="miss"><td class="line">335</td><td class="hits">0</td><td class="source">        return _trialDaysLeft(this);</td></tr><tr><td class="line">336</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">337</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">338</td><td class="hits">1</td><td class="source">    _schema.methods.getPermissions = function(){</td></tr><tr class="hit"><td class="line">339</td><td class="hits">1</td><td class="source">        return _getPermissions(this);</td></tr><tr><td class="line">340</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">341</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">342</td><td class="hits">1</td><td class="source">    _schema.methods.setAll = function(data, user) {</td></tr><tr class="hit"><td class="line">343</td><td class="hits">5</td><td class="source">        var that = this;</td></tr><tr><td class="line">344</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">345</td><td class="hits">5</td><td class="source">        data = {</td></tr><tr><td class="line">346</td><td class="hits"></td><td class="source">            demoComplete: data.demoComplete || null,</td></tr><tr><td class="line">347</td><td class="hits"></td><td class="source">            firstName: data.firstName || null,</td></tr><tr><td class="line">348</td><td class="hits"></td><td class="source">            lastName: data.lastName || null,</td></tr><tr><td class="line">349</td><td class="hits"></td><td class="source">            email: data.email || null,</td></tr><tr><td class="line">350</td><td class="hits"></td><td class="source">            phone: data.phone || null,</td></tr><tr><td class="line">351</td><td class="hits"></td><td class="source">            job: data.job || null,</td></tr><tr><td class="line">352</td><td class="hits"></td><td class="source">            settings: data.settings || null,</td></tr><tr><td class="line">353</td><td class="hits"></td><td class="source">            // gaCredentials: data.gaCredentials || null,</td></tr><tr><td class="line">354</td><td class="hits"></td><td class="source">            google_analytics: data.google_analytics || null,</td></tr><tr><td class="line">355</td><td class="hits"></td><td class="source">            prelim: data.prelim</td></tr><tr><td class="line">356</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">357</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">358</td><td class="hits"></td><td class="source">        // if(data.gaCredentials) {</td></tr><tr><td class="line">359</td><td class="hits"></td><td class="source">        //     data.google_analytics = {</td></tr><tr><td class="line">360</td><td class="hits"></td><td class="source">        //         gaCredentials: {</td></tr><tr><td class="line">361</td><td class="hits"></td><td class="source">        //             access_token: data.gaCredentials.access_token || null,</td></tr><tr><td class="line">362</td><td class="hits"></td><td class="source">        //             refresh_token: data.gaCredentials.refresh_token || null</td></tr><tr><td class="line">363</td><td class="hits"></td><td class="source">        //         }</td></tr><tr><td class="line">364</td><td class="hits"></td><td class="source">        //     }</td></tr><tr><td class="line">365</td><td class="hits"></td><td class="source">        // }</td></tr><tr><td class="line">366</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">367</td><td class="hits">5</td><td class="source">        for(var d in data) {</td></tr><tr class="hit"><td class="line">368</td><td class="hits">45</td><td class="source">            if(data[d]){</td></tr><tr class="hit"><td class="line">369</td><td class="hits">7</td><td class="source">                that.markModified(d);</td></tr><tr><td class="line">370</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">371</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">372</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">373</td><td class="hits">5</td><td class="source">        return ObjectUtils.copyAllProperties(data, that);</td></tr><tr><td class="line">374</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">375</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">376</td><td class="hits">1</td><td class="source">    _schema.methods.clearNotification = function(clipp, done) {</td></tr><tr class="miss"><td class="line">377</td><td class="hits">0</td><td class="source">        var</td></tr><tr><td class="line">378</td><td class="hits"></td><td class="source">            that = this;</td></tr><tr><td class="line">379</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">380</td><td class="hits">0</td><td class="source">        that.discussionHistory.push({</td></tr><tr><td class="line">381</td><td class="hits"></td><td class="source">            clippId: clipp._id,</td></tr><tr><td class="line">382</td><td class="hits"></td><td class="source">            currentCount: clipp.comments.length,</td></tr><tr><td class="line">383</td><td class="hits"></td><td class="source">            updatedType: &quot;viewed&quot;</td></tr><tr><td class="line">384</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">385</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">386</td><td class="hits">0</td><td class="source">        return that.save(done);</td></tr><tr><td class="line">387</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">388</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">389</td><td class="hits">1</td><td class="source">    _schema.virtual(&quot;permissions&quot;).get(function(){</td></tr><tr class="hit"><td class="line">390</td><td class="hits">1</td><td class="source">        return this.getPermissions();</td></tr><tr><td class="line">391</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">392</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">393</td><td class="hits">1</td><td class="source">    var _model = mongoose.model(&quot;User&quot;, _schema);</td></tr><tr><td class="line">394</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">395</td><td class="hits">1</td><td class="source">    var _findOrInvite = function(data, done){</td></tr><tr class="hit"><td class="line">396</td><td class="hits">8</td><td class="source">        var isNew = false;</td></tr><tr><td class="line">397</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">398</td><td class="hits">15</td><td class="source">        if(data.email &amp;&amp; data.email.toLowerCase) data.email = data.email.toLowerCase();</td></tr><tr><td class="line">399</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">400</td><td class="hits">8</td><td class="source">        _model</td></tr><tr><td class="line">401</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">402</td><td class="hits"></td><td class="source">                email: data.email</td></tr><tr><td class="line">403</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">404</td><td class="hits"></td><td class="source">            .exec(function(err, user){</td></tr><tr class="hit"><td class="line">405</td><td class="hits">8</td><td class="source">                if(err) return done(err);</td></tr><tr><td class="line">406</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">407</td><td class="hits">8</td><td class="source">                if(!user) {</td></tr><tr class="hit"><td class="line">408</td><td class="hits">6</td><td class="source">                    isNew = true;</td></tr><tr class="hit"><td class="line">409</td><td class="hits">6</td><td class="source">                    user = new _model({</td></tr><tr><td class="line">410</td><td class="hits"></td><td class="source">                        email: data.email,</td></tr><tr><td class="line">411</td><td class="hits"></td><td class="source">                        firstName: data.firstName,</td></tr><tr><td class="line">412</td><td class="hits"></td><td class="source">                        lastName: data.lastName,</td></tr><tr><td class="line">413</td><td class="hits"></td><td class="source">                        job: data.job,</td></tr><tr><td class="line">414</td><td class="hits"></td><td class="source">                        role: data.role,</td></tr><tr><td class="line">415</td><td class="hits"></td><td class="source">                        invite: uuid.v4(),</td></tr><tr><td class="line">416</td><td class="hits"></td><td class="source">                        refBy: data.refBy</td></tr><tr><td class="line">417</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">418</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">419</td><td class="hits">6</td><td class="source">                    return user.save(function(err, saved){</td></tr><tr class="hit"><td class="line">420</td><td class="hits">6</td><td class="source">                        return done(err, saved, isNew);</td></tr><tr><td class="line">421</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">422</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">423</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">424</td><td class="hits">2</td><td class="source">                return done(err, user, isNew);</td></tr><tr><td class="line">425</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">426</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">427</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">428</td><td class="hits">1</td><td class="source">    var _prepareForOutput = function(user){</td></tr><tr class="hit"><td class="line">429</td><td class="hits">13</td><td class="source">        user = (user.toObject) ? user.toObject() : user;</td></tr><tr class="hit"><td class="line">430</td><td class="hits">13</td><td class="source">        var purchasedNotebooks = 0;</td></tr><tr><td class="line">431</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">432</td><td class="hits">13</td><td class="source">        if(user.purchasedNotebooks === null &amp;&amp; user.customer &amp;&amp; user.customer.subscription &amp;&amp; user.customer.subscription){</td></tr><tr class="miss"><td class="line">433</td><td class="hits">0</td><td class="source">            purchasedNotebooks = user.customer.subscription.quantity;</td></tr><tr><td class="line">434</td><td class="hits"></td><td class="source">        } else {</td></tr><tr class="hit"><td class="line">435</td><td class="hits">13</td><td class="source">            purchasedNotebooks = user.purchasedNotebooks;</td></tr><tr><td class="line">436</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">437</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">438</td><td class="hits">13</td><td class="source">        if(user.customer &amp;&amp; user.customer.subscription &amp;&amp; user.customer.subscription.plan) {</td></tr><tr class="miss"><td class="line">439</td><td class="hits">0</td><td class="source">            user.subscription = {</td></tr><tr><td class="line">440</td><td class="hits"></td><td class="source">                plan : user.customer.subscription.plan,</td></tr><tr><td class="line">441</td><td class="hits"></td><td class="source">                customer: user.customer.subscription.customer,</td></tr><tr><td class="line">442</td><td class="hits"></td><td class="source">                status: user.customer.subscription.status</td></tr><tr><td class="line">443</td><td class="hits"></td><td class="source">            };</td></tr><tr><td class="line">444</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">445</td><td class="hits">13</td><td class="source">        user.purchasedNotebooks = purchasedNotebooks;</td></tr><tr><td class="line">446</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">447</td><td class="hits">13</td><td class="source">        delete user.tokens;</td></tr><tr class="hit"><td class="line">448</td><td class="hits">13</td><td class="source">        delete user.hashedPassword;</td></tr><tr class="hit"><td class="line">449</td><td class="hits">13</td><td class="source">        delete user.__v;</td></tr><tr class="hit"><td class="line">450</td><td class="hits">13</td><td class="source">        delete user.customer;</td></tr><tr><td class="line">451</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">452</td><td class="hits">13</td><td class="source">        if(!user.settings) user.settings = new _model().settings;</td></tr><tr><td class="line">453</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">454</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">455</td><td class="hits">13</td><td class="source">        return user;</td></tr><tr><td class="line">456</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">457</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">458</td><td class="hits">1</td><td class="source">    var _prepareForAdminOutput = function(user){</td></tr><tr class="hit"><td class="line">459</td><td class="hits">20</td><td class="source">        user = (user.toObject) ? user.toObject() : user;</td></tr><tr class="hit"><td class="line">460</td><td class="hits">20</td><td class="source">        delete user.tokens;</td></tr><tr class="hit"><td class="line">461</td><td class="hits">20</td><td class="source">        delete user.hashedPassword;</td></tr><tr class="hit"><td class="line">462</td><td class="hits">20</td><td class="source">        delete user.__v;</td></tr><tr class="hit"><td class="line">463</td><td class="hits">20</td><td class="source">        return user;</td></tr><tr><td class="line">464</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">465</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">466</td><td class="hits">1</td><td class="source">    var _prepareMultipleForAdminOutput = function(users){</td></tr><tr class="hit"><td class="line">467</td><td class="hits">2</td><td class="source">        for(var i in users){</td></tr><tr class="hit"><td class="line">468</td><td class="hits">20</td><td class="source">            users[i] = _prepareForAdminOutput(users[i]);</td></tr><tr><td class="line">469</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">470</td><td class="hits">2</td><td class="source">        return users;</td></tr><tr><td class="line">471</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">472</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">473</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">474</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">475</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">476</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">477</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema,</td></tr><tr><td class="line">478</td><td class="hits"></td><td class="source">        getPermissions: _getPermissions,</td></tr><tr><td class="line">479</td><td class="hits"></td><td class="source">        findOrInvite: _findOrInvite,</td></tr><tr><td class="line">480</td><td class="hits"></td><td class="source">        prepareForOutput: _prepareForOutput,</td></tr><tr><td class="line">481</td><td class="hits"></td><td class="source">        prepareForAdminOutput: _prepareForAdminOutput,</td></tr><tr><td class="line">482</td><td class="hits"></td><td class="source">        prepareMultipleForAdminOutput: _prepareMultipleForAdminOutput,</td></tr><tr><td class="line">483</td><td class="hits"></td><td class="source">        calculateMonthlyFee: _calculateMonthlyFee,</td></tr><tr><td class="line">484</td><td class="hits"></td><td class="source">        trialDaysLeft: _trialDaysLeft,</td></tr><tr><td class="line">485</td><td class="hits"></td><td class="source">        updateIntercomUser: _updateIntercomUser</td></tr><tr><td class="line">486</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">487</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">488</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">489</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">490</td><td class="hits">1</td><td class="source">module.exports = UserModel;</td></tr><tr><td class="line">491</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/models/user_waiting.js">/Users/warner/code/clipppr/primeloop-api/models/user_waiting.js</h2><div id="stats" class="high"><div class="percentage">93%</div><div class="sloc">104</div><div class="hits">97</div><div class="misses">7</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var UserWaitingModel = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        kaster = require(&quot;kaster-mongoose&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        mongoosastic = require(&quot;mongoosastic&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        ArrayUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/array&quot;),</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        ObjectUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/objects&quot;),</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;),</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        crypto = require(&quot;crypto&quot;),</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        _ = require(&quot;underscore&quot;),</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        Validations = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/validations&quot;),</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        intercom = require(&quot;/Users/warner/code/clipppr/primeloop-api/models/../utils/intercom&quot;);</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">    var _generateRefCode = function(length){</td></tr><tr class="hit"><td class="line">17</td><td class="hits">69</td><td class="source">        length = length || 5;</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">19</td><td class="hits">69</td><td class="source">        var</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">            AUID = [],</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">            CHARS = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">23</td><td class="hits">69</td><td class="source">        for (var i = 0; i &lt; length; i++) {</td></tr><tr class="hit"><td class="line">24</td><td class="hits">345</td><td class="source">            AUID.push(CHARS[Math.floor(Math.random()*62)]);</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">26</td><td class="hits">69</td><td class="source">        return AUID.join('');</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        //return (&quot;00000&quot; + (Math.random()*Math.pow(36,5) &lt;&lt; 0).toString(36)).substr(-5);</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">31</td><td class="hits">1</td><td class="source">    var _client = {</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        name: String,</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        domain_url: String</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">37</td><td class="hits">1</td><td class="source">    var _googleConnection = {</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">        webPropertyId: String,</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">        profileId: String,</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">        accountId: String,</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">        username: String,</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">        gaCredentials: {type:Object, es_indexed:false},</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">        notebooks: [String],</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">        updated: Date,</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">        error: {type:Object, es_indexed:false}</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">49</td><td class="hits">1</td><td class="source">    var _jsonSchema = {</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">        _id: {type: String, &quot;default&quot;: uuid.v4},</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">        email: { type: String, lowercase: true, required: true, validate: Validations.email, unique: true },</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">        ref: {type: String, &quot;default&quot;: _generateRefCode, unique: true}, //generage this</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">        referrals: [{type:String, ref: 'User.Waiting', unique: true}],</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">        referralCount: {type: Number, &quot;default&quot;: 0},</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">        refBy: {type:String, ref: &quot;User.Waiting&quot;},</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">        refByEmail: {type: String},</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">        industry: {type: String},</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">        isUser: {type: Boolean, &quot;default&quot;: false},</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">        tags: [{type: String, lowercase: true}],</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">        user: {type: String, ref: &quot;User&quot;},</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">        created: {type: Date, &quot;default&quot;: Date.now},</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">        lrref: {type: String}, //Launch Rock Ref Code</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">        conversionDate: Date,</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">        company: {</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">            name: String,</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">            size: String,</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">            industry: String,</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">            specificIndustry: String,</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">            role: String,</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">            domain_url: String</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">        clients: [_client],</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">        other_analytics: String,</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">        google_analytics: {</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">            connectLater: {type:Boolean, &quot;default&quot;:false},</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">            inviteConnector:{</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">                name: String,</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">                email: String</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">            username: String,</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">            gaCredentials: {</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">                access_token: String,</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">                refresh_token: String,</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">                token_type: String</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">            accounts: [String],</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">            connections: [_googleConnection],</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">            forNotebook: {type:Object, es_indexed:false}</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">        },</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">        firstName: {type:String, required: true},</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">        lastName: {type:String},</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">        phone: String</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">96</td><td class="hits">1</td><td class="source">    var _schema = mongoose.Schema(_jsonSchema);</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">98</td><td class="hits">1</td><td class="source">    _schema.virtual('name').set(function(name){</td></tr><tr class="miss"><td class="line">99</td><td class="hits">0</td><td class="source">        if(name) {</td></tr><tr class="miss"><td class="line">100</td><td class="hits">0</td><td class="source">            var names = name.trim().split(/\s+/);</td></tr><tr class="miss"><td class="line">101</td><td class="hits">0</td><td class="source">            this.firstName = names[0];</td></tr><tr class="miss"><td class="line">102</td><td class="hits">0</td><td class="source">            for(var i = 1; i &lt; names.length; i++) {</td></tr><tr class="miss"><td class="line">103</td><td class="hits">0</td><td class="source">                this.lastName += names[i] + &quot; &quot;;</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">105</td><td class="hits">0</td><td class="source">            this.lastName = this.lastName.trim();</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">108</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">110</td><td class="hits">1</td><td class="source">    _schema.virtual('name').get(function () {</td></tr><tr class="hit"><td class="line">111</td><td class="hits">20</td><td class="source">        return this.firstName + ' ' + this.lastName;</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">113</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">    // _schema.plugin(kaster, {</td></tr><tr><td class="line">115</td><td class="hits"></td><td class="source">    //     name: &quot;UserWaiting&quot;,</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">    //     region: Settings.kaster.region,</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">    //     namespace: Settings.kaster.namespace,</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">    //     topic: Settings.kaster.topics.data</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">    // });</td></tr><tr class="hit"><td class="line">120</td><td class="hits">1</td><td class="source">    _schema.plugin(mongoosastic, {</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">        index: Settings.elasticsearch.data_index,</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">        protocol: Settings.elasticsearch.protocol,</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">        host: Settings.elasticsearch.host,</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source">        port: Settings.elasticsearch.port,</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">        auth: Settings.elasticsearch.user + &quot;:&quot; + Settings.elasticsearch.password</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">    //Save original doc after loading so we can use those for comparison</td></tr><tr class="hit"><td class="line">128</td><td class="hits">1</td><td class="source">    _schema.post(&quot;init&quot;, function(doc){</td></tr><tr class="hit"><td class="line">129</td><td class="hits">47</td><td class="source">        this._original = doc.toObject();</td></tr><tr class="hit"><td class="line">130</td><td class="hits">47</td><td class="source">        return;</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">133</td><td class="hits">1</td><td class="source">    var _preSave = function(data, done, tries){</td></tr><tr class="hit"><td class="line">134</td><td class="hits">64</td><td class="source">        var that = data, Model = mongoose.model(&quot;User.Waiting&quot;);</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">136</td><td class="hits">64</td><td class="source">        tries = tries || 1;</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">138</td><td class="hits">64</td><td class="source">        Model.findOne({</td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">            ref: that.ref,</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">            email: { $ne: that.email }</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">        }, function(err, user){</td></tr><tr class="hit"><td class="line">142</td><td class="hits">64</td><td class="source">            if(err) {</td></tr><tr class="miss"><td class="line">143</td><td class="hits">0</td><td class="source">                return done(err);</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">146</td><td class="hits">125</td><td class="source">            if(!user) return done();</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">            else {</td></tr><tr class="hit"><td class="line">148</td><td class="hits">3</td><td class="source">                var len = 5;</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">                //Increase the length of the ref code if there are really that many dups</td></tr><tr class="hit"><td class="line">150</td><td class="hits">3</td><td class="source">                if(tries &amp;&amp; tries &gt; 1) len += (tries-1);</td></tr><tr class="hit"><td class="line">151</td><td class="hits">3</td><td class="source">                that.ref = _generateRefCode(len);</td></tr><tr class="hit"><td class="line">152</td><td class="hits">3</td><td class="source">                return _preSave(that, done, ++tries);</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">158</td><td class="hits">1</td><td class="source">    _schema.pre(&quot;save&quot;, function(done){</td></tr><tr class="hit"><td class="line">159</td><td class="hits">61</td><td class="source">        var that = this, Model = mongoose.model(&quot;User.Waiting&quot;);</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">161</td><td class="hits">61</td><td class="source">        if(that.refBy) {</td></tr><tr class="hit"><td class="line">162</td><td class="hits">1</td><td class="source">            Model.findOne({</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">                ref: that.refBy</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">            .lean()</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">            .exec(function(err, user){</td></tr><tr class="hit"><td class="line">167</td><td class="hits">1</td><td class="source">                if(err) return done(err);</td></tr><tr class="hit"><td class="line">168</td><td class="hits">1</td><td class="source">                if(user) {</td></tr><tr class="hit"><td class="line">169</td><td class="hits">1</td><td class="source">                    that.refBy = user._id;</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">                }</td></tr><tr class="hit"><td class="line">171</td><td class="hits">1</td><td class="source">                return _preSave(that, done);</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">            });</td></tr><tr class="hit"><td class="line">173</td><td class="hits">60</td><td class="source">        } else return _preSave(this, done);</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">176</td><td class="hits">1</td><td class="source">    _schema.post(&quot;save&quot;, function(done){</td></tr><tr class="hit"><td class="line">177</td><td class="hits">61</td><td class="source">        var that = this, Model = mongoose.model(&quot;User.Waiting&quot;);</td></tr><tr class="hit"><td class="line">178</td><td class="hits">61</td><td class="source">        _updateIntercomUser(that, function(){});</td></tr><tr class="hit"><td class="line">179</td><td class="hits">61</td><td class="source">        Model.findOne({</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">            _id: that.refBy</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">        })</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">        .exec(function(err, user){</td></tr><tr class="hit"><td class="line">183</td><td class="hits">61</td><td class="source">            if(err) return console.log(err);</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">185</td><td class="hits">121</td><td class="source">            if(!user) return;</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">187</td><td class="hits">1</td><td class="source">            if(user.referrals.indexOf(that._id) &gt;= 0) return;</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">189</td><td class="hits">1</td><td class="source">            user.referrals.push(that._id);</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">            //TODO: See why this count isn't working?</td></tr><tr class="hit"><td class="line">191</td><td class="hits">1</td><td class="source">            user.referralCount = user.referrals.length;</td></tr><tr class="hit"><td class="line">192</td><td class="hits">1</td><td class="source">            user.markModified(&quot;referrals&quot;);</td></tr><tr class="hit"><td class="line">193</td><td class="hits">1</td><td class="source">            user.save();</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">199</td><td class="hits">1</td><td class="source">    _schema.virtual(&quot;tag&quot;).set(function(tag){</td></tr><tr class="hit"><td class="line">200</td><td class="hits">7</td><td class="source">        if(!tag) return;</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">202</td><td class="hits">7</td><td class="source">        var</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">            tags = ArrayUtils.uniqueArray(tag.toString().split(&quot;,&quot;));</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">205</td><td class="hits">7</td><td class="source">        for(var i = 0; i &lt; tags.length; i++){</td></tr><tr class="hit"><td class="line">206</td><td class="hits">12</td><td class="source">            if(this.tags.indexOf(tags[i]) &gt;= 0) tags.splice(i,1);</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">209</td><td class="hits">7</td><td class="source">        this.tags = this.tags.concat(tags);</td></tr><tr class="hit"><td class="line">210</td><td class="hits">7</td><td class="source">        this.markModified('tags');</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">213</td><td class="hits">1</td><td class="source">    _schema.path(&quot;tags&quot;).set(function(tags){</td></tr><tr class="hit"><td class="line">214</td><td class="hits">11</td><td class="source">        tags = tags.toString().split(&quot;,&quot;);</td></tr><tr class="hit"><td class="line">215</td><td class="hits">27</td><td class="source">        for(var i in tags) tags[i] = tags[i].trim().replace(/ /g, &quot;-&quot;);</td></tr><tr class="hit"><td class="line">216</td><td class="hits">11</td><td class="source">        var finalTags = ArrayUtils.uniqueArray(tags);</td></tr><tr class="hit"><td class="line">217</td><td class="hits">11</td><td class="source">        return finalTags;</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source">    });</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">221</td><td class="hits">1</td><td class="source">    _schema.methods.setAll = function(data) {</td></tr><tr class="hit"><td class="line">222</td><td class="hits">4</td><td class="source">        return ObjectUtils.copyAllProperties(data, this);</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">225</td><td class="hits">1</td><td class="source">    var _updateIntercomUser = function(waiting, done) {</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source">        //first check to see if they exist in intercom</td></tr><tr class="hit"><td class="line">227</td><td class="hits">61</td><td class="source">        var emailOrId = (waiting.user) ? waiting.user : waiting.email ;</td></tr><tr class="hit"><td class="line">228</td><td class="hits">61</td><td class="source">        var intercomTags = [];</td></tr><tr class="hit"><td class="line">229</td><td class="hits">61</td><td class="source">        var deletedTags = [];</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">        // console.log(&quot;original user doc %j&quot;, waiting._original);</td></tr><tr class="hit"><td class="line">231</td><td class="hits">61</td><td class="source">        if(waiting._original) {</td></tr><tr class="hit"><td class="line">232</td><td class="hits">42</td><td class="source">            deletedTags = _.difference(waiting._original.tags, waiting.tags);</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">234</td><td class="hits">61</td><td class="source">        if(waiting.tags.length &gt; 0) {</td></tr><tr class="hit"><td class="line">235</td><td class="hits">10</td><td class="source">            intercomTags = waiting.tags;</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">238</td><td class="hits">61</td><td class="source">        intercom.userExists(emailOrId, function(found) {</td></tr><tr class="hit"><td class="line">239</td><td class="hits">61</td><td class="source">            if(!found) {</td></tr><tr class="hit"><td class="line">240</td><td class="hits">20</td><td class="source">                intercom.newWaitingListUser(waiting, intercomTags, function(err){</td></tr><tr class="hit"><td class="line">241</td><td class="hits">35</td><td class="source">                    if(err) console.log(&quot;there was a problem creating new user %j&quot;, err);</td></tr><tr class="hit"><td class="line">242</td><td class="hits">20</td><td class="source">                    return done();</td></tr><tr><td class="line">243</td><td class="hits"></td><td class="source">                });</td></tr><tr class="hit"><td class="line">244</td><td class="hits">41</td><td class="source">            } else if(intercomTags.length &gt; 0 || deletedTags.length &gt; 0) {</td></tr><tr class="hit"><td class="line">245</td><td class="hits">2</td><td class="source">                updateTagsAndData(waiting, intercomTags, deletedTags, function(){</td></tr><tr class="hit"><td class="line">246</td><td class="hits">1</td><td class="source">                    return done();</td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="hit"><td class="line">249</td><td class="hits">39</td><td class="source">                updateTagsAndData(waiting, null, null, function(){</td></tr><tr class="hit"><td class="line">250</td><td class="hits">39</td><td class="source">                    return done();</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">253</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">        });</td></tr><tr class="hit"><td class="line">256</td><td class="hits">61</td><td class="source">        function updateTagsAndData(wuser, tags, deletedTags, done) {</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source">            // console.log(&quot;updating tags %j, and deleted tags %j&quot;, tags, deletedTags);</td></tr><tr class="hit"><td class="line">258</td><td class="hits">41</td><td class="source">            var data = {</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source">                custom_data: {}</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source">            };</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">262</td><td class="hits">41</td><td class="source">            if(wuser.company) {</td></tr><tr class="hit"><td class="line">263</td><td class="hits">41</td><td class="source">                data.custom_data.company_name = wuser.company.name;</td></tr><tr class="hit"><td class="line">264</td><td class="hits">41</td><td class="source">                data.custom_data.company_size = wuser.company.size;</td></tr><tr class="hit"><td class="line">265</td><td class="hits">41</td><td class="source">                data.custom_data.industry = wuser.company.industry;</td></tr><tr class="hit"><td class="line">266</td><td class="hits">41</td><td class="source">                data.custom_data.specificIndustry = wuser.company.specificIndustry;</td></tr><tr class="hit"><td class="line">267</td><td class="hits">41</td><td class="source">                data.custom_data.role = wuser.company.role;</td></tr><tr class="hit"><td class="line">268</td><td class="hits">41</td><td class="source">                data.custom_data.domain_url = wuser.company.domain_url;</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">270</td><td class="hits">41</td><td class="source">            intercom.updateUser(wuser.email, data, function(){</td></tr><tr class="hit"><td class="line">271</td><td class="hits">41</td><td class="source">                intercom.tagUser(wuser.email, tags, function(){</td></tr><tr class="hit"><td class="line">272</td><td class="hits">40</td><td class="source">                    intercom.untagUser(wuser.email, deletedTags, function(){</td></tr><tr class="hit"><td class="line">273</td><td class="hits">40</td><td class="source">                        done();</td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">276</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">279</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">282</td><td class="hits">1</td><td class="source">    var _model = mongoose.model(&quot;User.Waiting&quot;, _schema);</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">284</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source">        Schema: _schema,</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source">        Model: _model,</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source">        jsonSchema: _jsonSchema,</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">        updateIntercomUser: _updateIntercomUser</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">292</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">293</td><td class="hits">1</td><td class="source">module.exports = UserWaitingModel;</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/test/utils/data.js">/Users/warner/code/clipppr/primeloop-api/test/utils/data.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">90</div><div class="hits">90</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var TestData = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        async = require(&quot;async&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../config/settings&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        Page = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../models/page&quot;).Model,</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        PageErrors = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../models/page_error&quot;).Model,</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        Clipp = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../models/clipp&quot;).Model,</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        ClippArchive = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../models/clipp&quot;).Archive.Model,</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        NotebookArchive = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../models/notebook&quot;).Archive.Model,</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        Client = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../models/client&quot;).Model,</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        Email = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../models/email&quot;).Model,</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        Notebook = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../models/notebook&quot;).Model,</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        User = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../models/user&quot;).Model,</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        Customer = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../models/customer&quot;).Model,</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        CustomerStatic = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../models/customer&quot;),</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        Plan = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../models/plan&quot;).Model,</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        Coupon = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../models/coupon&quot;).Model,</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        UsersWaiting = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../models/user_waiting&quot;).Model,</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        BatchImport = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../models/batch_import&quot;).Model,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        SuggestedBatchImport = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../models/suggested_batch_import&quot;).Model,</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        SuggestedClippError = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../models/suggested_clipp_error&quot;).Model,</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        SuggestedClipp = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../models/suggested_clipp&quot;).Model,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        SuggestedClippArchive = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../models/suggested_clipp&quot;).Archive.Model,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        TrackingPage = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../models/tracking_page&quot;).Model,</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        TrackingUrl = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../models/tracking_url&quot;).Model,</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        TrackingUrlStatic = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../models/tracking_url&quot;),</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">        TrackingUrlActivity = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../models/tracking_url_activity&quot;).Model,</td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">        AuthUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../utils/auth&quot;),</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        uuid = require(&quot;node-uuid&quot;),</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        intercom = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../../utils/intercom&quot;);</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">34</td><td class="hits">1</td><td class="source">    var _clearDatabase = function(done){</td></tr><tr class="hit"><td class="line">35</td><td class="hits">1</td><td class="source">        async.parallel([</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">            function(cb) {</td></tr><tr class="hit"><td class="line">37</td><td class="hits">1</td><td class="source">                intercom.deleteUsers([</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">                    &quot;warner+waiting@primeloop.com&quot;,</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">                    &quot;warner@clipppr.com&quot;,</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">                    &quot;mark+expiredtrial@clipppr.com&quot;,</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">                    &quot;mark@clipppr.com&quot;,</td></tr><tr><td class="line">42</td><td class="hits"></td><td class="source">                    &quot;mark+muchplans@clipppr.com&quot;,</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">                    &quot;mark.d.cicoria@gmail.com&quot;,</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">                    &quot;mark+1@clipppr.com&quot;,</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">                    &quot;warner+reseller@primeloop.com&quot;,</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">                    &quot;mark+2@clipppr.com&quot;,</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">                    &quot;mark@clipppr.com&quot;,</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">                    &quot;mark+normaluser@clipppr.com&quot;,</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">                    &quot;mark+inviteuser@clipppr.com&quot;,</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">                    &quot;mark.cicoria@ayloo.net&quot;,</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">                    &quot;mark+newgeneraluser2@clipppr.com&quot;,</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">                    &quot;mc@ayloo.net&quot;,</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">                    &quot;mark+newuser@clipppr.com&quot;,</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">                    &quot;mark+noinvite@clipppr.com&quot;,</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">                    &quot;johnd@jd.com&quot;,</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">                    &quot;johnd+2@jd.com&quot;,</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">                    &quot;mark+newgeneraluser@clipppr.com&quot;</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">                ], cb);</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">            },</td></tr><tr class="hit"><td class="line">60</td><td class="hits">1</td><td class="source">            function(cb) { Page.remove({}, cb); },</td></tr><tr class="hit"><td class="line">61</td><td class="hits">1</td><td class="source">            function(cb) { Plan.remove({}, cb); },</td></tr><tr class="hit"><td class="line">62</td><td class="hits">1</td><td class="source">            function(cb) { Coupon.remove({}, cb); },</td></tr><tr class="hit"><td class="line">63</td><td class="hits">1</td><td class="source">            function(cb) {PageErrors.remove({}, cb);},</td></tr><tr class="hit"><td class="line">64</td><td class="hits">1</td><td class="source">            function(cb) { Client.remove({}, cb); },</td></tr><tr class="hit"><td class="line">65</td><td class="hits">1</td><td class="source">            function(cb) { Clipp.remove({}, cb); },</td></tr><tr class="hit"><td class="line">66</td><td class="hits">1</td><td class="source">            function(cb) { ClippArchive.remove({}, cb); },</td></tr><tr class="hit"><td class="line">67</td><td class="hits">1</td><td class="source">            function(cb) { Notebook.remove({}, cb); },</td></tr><tr class="hit"><td class="line">68</td><td class="hits">1</td><td class="source">            function(cb) { NotebookArchive.remove({}, cb); },</td></tr><tr class="hit"><td class="line">69</td><td class="hits">1</td><td class="source">            function(cb) { Email.remove({}, cb); },</td></tr><tr class="hit"><td class="line">70</td><td class="hits">1</td><td class="source">            function(cb) { UsersWaiting.remove({}, cb); },</td></tr><tr class="hit"><td class="line">71</td><td class="hits">1</td><td class="source">            function(cb) { User.remove({}, cb); },</td></tr><tr class="hit"><td class="line">72</td><td class="hits">1</td><td class="source">            function(cb) {Customer.remove({}, cb); },</td></tr><tr class="hit"><td class="line">73</td><td class="hits">1</td><td class="source">            function(cb) {BatchImport.remove({}, cb);},</td></tr><tr class="hit"><td class="line">74</td><td class="hits">1</td><td class="source">            function(cb) {SuggestedBatchImport.remove({}, cb);},</td></tr><tr class="hit"><td class="line">75</td><td class="hits">1</td><td class="source">            function(cb) {SuggestedClippError.remove({}, cb);},</td></tr><tr class="hit"><td class="line">76</td><td class="hits">1</td><td class="source">            function(cb) {SuggestedClipp.remove({}, cb);},</td></tr><tr class="hit"><td class="line">77</td><td class="hits">1</td><td class="source">            function(cb) {SuggestedClippArchive.remove({}, cb);},</td></tr><tr class="hit"><td class="line">78</td><td class="hits">1</td><td class="source">            function(cb) {TrackingPage.remove({}, cb);},</td></tr><tr class="hit"><td class="line">79</td><td class="hits">1</td><td class="source">            function(cb) {TrackingUrl.remove({}, cb);},</td></tr><tr class="hit"><td class="line">80</td><td class="hits">1</td><td class="source">            function(cb) {TrackingUrlActivity.remove({}, cb);}</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">        ], function(err, res){</td></tr><tr class="hit"><td class="line">82</td><td class="hits">1</td><td class="source">            if(err) throw err;</td></tr><tr class="hit"><td class="line">83</td><td class="hits">1</td><td class="source">            return done(err, res);</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">87</td><td class="hits">1</td><td class="source">    var _createTestData = function(done){</td></tr><tr class="hit"><td class="line">88</td><td class="hits">1</td><td class="source">         var</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">            clipps = [],</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">            trackingUrls = [],</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">            pages = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../data/pages.data&quot;).map(function(pg){</td></tr><tr class="hit"><td class="line">92</td><td class="hits">7</td><td class="source">                pg._id = uuid.v4();</td></tr><tr class="hit"><td class="line">93</td><td class="hits">7</td><td class="source">                pg.clipps = [];</td></tr><tr class="hit"><td class="line">94</td><td class="hits">7</td><td class="source">                return pg;</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">            }),</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">            cmTrackingUrls = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../data/tracking_urls.data&quot;).map(function(tUrl){</td></tr><tr class="hit"><td class="line">97</td><td class="hits">7</td><td class="source">                return tUrl;</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">            }),</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">            activities = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../data/tracking_urls_activity.data&quot;).map(function(activity){</td></tr><tr class="hit"><td class="line">100</td><td class="hits">7</td><td class="source">                return activity;</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">            }),</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">            notebooks = [],</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">            plans = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../data/plans.data&quot;).map(function(plan){</td></tr><tr class="hit"><td class="line">104</td><td class="hits">2</td><td class="source">                plan._id = uuid.v4();</td></tr><tr class="hit"><td class="line">105</td><td class="hits">2</td><td class="source">                return plan;</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">            }),</td></tr><tr><td class="line">107</td><td class="hits"></td><td class="source">            coupons = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../data/coupons.data&quot;).map(function(coupon){</td></tr><tr class="hit"><td class="line">108</td><td class="hits">1</td><td class="source">                return coupon;</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">            }),</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">            customers = [],</td></tr><tr><td class="line">111</td><td class="hits"></td><td class="source">            users = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../data/users.data&quot;).map(function(usr){</td></tr><tr class="hit"><td class="line">112</td><td class="hits">11</td><td class="source">                usr._id = uuid.v4();</td></tr><tr class="hit"><td class="line">113</td><td class="hits">11</td><td class="source">                usr.hashedPassword = AuthUtils.hashPassword(&quot;password&quot;);</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">115</td><td class="hits">11</td><td class="source">                var notebook_clipps = [], clipp_data, notebook_id;</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">117</td><td class="hits">11</td><td class="source">                customers.push({</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source">                    user: usr._id,</td></tr><tr><td class="line">119</td><td class="hits"></td><td class="source">                    plan: plans[0]._id,</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">                    billingType: plans[0].billingType</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">                });</td></tr><tr class="hit"><td class="line">122</td><td class="hits">11</td><td class="source">                for(var j = 1; j &lt;= 3; j++) {</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">124</td><td class="hits">33</td><td class="source">                    notebook_id = uuid.v4();</td></tr><tr class="hit"><td class="line">125</td><td class="hits">33</td><td class="source">                    notebook_clipps = [];</td></tr><tr><td class="line">126</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">                    // console.log(j, notebook_id);</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">129</td><td class="hits">33</td><td class="source">                    for(var i in pages) {</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">131</td><td class="hits">231</td><td class="source">                        clipp_data = {</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">                            _id: uuid.v4(),</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">                            title: pages[i].title,</td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">                            page: pages[i]._id,</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">                            notebook: notebook_id,</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">                            url: pages[i].url</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">                        };</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">139</td><td class="hits">231</td><td class="source">                        pages[i].clipps.push(clipp_data._id);</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">141</td><td class="hits">231</td><td class="source">                        clipps.push(clipp_data);</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">143</td><td class="hits">231</td><td class="source">                        notebook_clipps.push({</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">                            page: clipp_data.page,</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">                            clipp: clipp_data._id</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="hit"><td class="line">148</td><td class="hits">33</td><td class="source">                    if(usr.email == &quot;warner@primeloop.com&quot; || usr.email == &quot;mark@primeloop.com&quot;) {</td></tr><tr class="hit"><td class="line">149</td><td class="hits">6</td><td class="source">                        for (var k in cmTrackingUrls) {</td></tr><tr class="hit"><td class="line">150</td><td class="hits">42</td><td class="source">                            var trackingUrl = {</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">                                url: cmTrackingUrls[k].url,</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">                                user: usr._id,</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source">                                campaign : notebook_id,</td></tr><tr><td class="line">154</td><td class="hits"></td><td class="source">                                flag: cmTrackingUrls[k].flag</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">                            };</td></tr><tr class="hit"><td class="line">156</td><td class="hits">42</td><td class="source">                            trackingUrls.push(trackingUrl);</td></tr><tr><td class="line">157</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">159</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">161</td><td class="hits"></td><td class="source">                    //Create a notebook for each user x 2</td></tr><tr class="hit"><td class="line">162</td><td class="hits">33</td><td class="source">                    notebooks.push({</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">                        _id: notebook_id,</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">                        enabled:true,</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">                        name: usr.firstName + &quot;'s Notebook &quot; + j,</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">                        users: [{</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">                            user: usr._id,</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">                            role: &quot;campaign_owner&quot;</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">                        }],</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">                        anonymousAccess: (j===1) ,</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">                        clipps: notebook_clipps,</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">                        retarget :{</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">                            campaigns: [</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source">                                {</td></tr><tr><td class="line">175</td><td class="hits"></td><td class="source">                                    name: &quot;Primeloop May Campaign&quot;,</td></tr><tr><td class="line">176</td><td class="hits"></td><td class="source">                                    retarget_code: &quot;&lt;img src=\&quot;http://ad.retargeter.com/seg?add=1668550&amp;t=2\&quot; width=\&quot;1\&quot; height=\&quot;1\&quot; /&gt;&quot;,</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">                                    retarget_type: &quot;retargeter&quot;,</td></tr><tr><td class="line">178</td><td class="hits"></td><td class="source">                                    enabled: true</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">                                },</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">                                {</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">                                    name: &quot;Primeloop August Campaign (On Hold)&quot;,</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">                                    retarget_code: &quot;&lt;script type=\&quot;text/javascript\&quot; src=\&quot;//cdnjs.cloudflare.com/ajax/libs/json3/3.2.5/json3.min.js\&quot;&gt;&lt;/script&gt; &lt;script type=\&quot;text/javascript\&quot;&gt;if( typeof _rt_cgi == \&quot;undefined\&quot; ){var _rt_cgi = 608; var _rt_base_url = \&quot;https://lt.retargeter.com/\&quot;; var _rt_js_base_url = \&quot;https://s3.amazonaws.com/V3-Assets/prod/client_super_tag/\&quot;; var _rt_init_src = _rt_js_base_url+\&quot;init_super_tag.js\&quot;; var _rt_refresh_st = false;var _rt_record = function(params){if(typeof document.getElementsByTagName(\&quot;_rt_data\&quot;)[0]==\&quot;undefined\&quot;){setTimeout(function(){_rt_record(params);},25);}}; (function() {var scr = document.createElement(\&quot;script\&quot;);scr.src = _rt_init_src;document.getElementsByTagName(\&quot;head\&quot;)[0].appendChild(scr);})();}&lt;/script&gt;&quot;,</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">                                    retarget_type: &quot;retargeter&quot;,</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">                                    enabled: false</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">                                }</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">                            ]</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">                        }</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">                }</td></tr><tr class="hit"><td class="line">191</td><td class="hits">11</td><td class="source">                return usr;</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">            }),</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">            clients = [],</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">            errors = require(&quot;/Users/warner/code/clipppr/primeloop-api/test/utils/../data/errors.data&quot;).map(function(error) {</td></tr><tr class="hit"><td class="line">195</td><td class="hits">4</td><td class="source">                error._id = uuid.v4();</td></tr><tr class="hit"><td class="line">196</td><td class="hits">4</td><td class="source">                for(var i in pages) {</td></tr><tr class="hit"><td class="line">197</td><td class="hits">23</td><td class="source">                    if(pages[i].url == error.url) {</td></tr><tr class="hit"><td class="line">198</td><td class="hits">4</td><td class="source">                        error.page = pages[i]._id;</td></tr><tr class="hit"><td class="line">199</td><td class="hits">4</td><td class="source">                        pages[i].error = error._id;</td></tr><tr class="hit"><td class="line">200</td><td class="hits">4</td><td class="source">                        delete error.url;</td></tr><tr class="hit"><td class="line">201</td><td class="hits">4</td><td class="source">                        return error;</td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">203</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">206</td><td class="hits">1</td><td class="source">        clients.push({</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">            client_id: &quot;foo&quot;,</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source">            client_secret: &quot;bar&quot;,</td></tr><tr><td class="line">209</td><td class="hits"></td><td class="source">            host: &quot;foo.bar&quot;,</td></tr><tr><td class="line">210</td><td class="hits"></td><td class="source">            name: &quot;phoenix&quot;</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">213</td><td class="hits">1</td><td class="source">        clients.push({</td></tr><tr><td class="line">214</td><td class="hits"></td><td class="source">            client_id: &quot;falkor&quot;,</td></tr><tr><td class="line">215</td><td class="hits"></td><td class="source">            client_secret: &quot;cawcaw&quot;,</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">            host: &quot;falkor&quot;,</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source">            name: &quot;falkor&quot;</td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">220</td><td class="hits">1</td><td class="source">        async.parallel([</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source">            function(cb) {</td></tr><tr class="hit"><td class="line">222</td><td class="hits">1</td><td class="source">                User.create(users, cb);</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source">            function(cb) {</td></tr><tr class="hit"><td class="line">225</td><td class="hits">1</td><td class="source">                Customer.create(customers, cb);</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source">            function(cb) {</td></tr><tr class="hit"><td class="line">228</td><td class="hits">1</td><td class="source">                Notebook.create(notebooks, cb);</td></tr><tr><td class="line">229</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">            function(cb) {</td></tr><tr class="hit"><td class="line">231</td><td class="hits">1</td><td class="source">                Clipp.create(clipps, cb);</td></tr><tr><td class="line">232</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">            function(cb){</td></tr><tr class="hit"><td class="line">234</td><td class="hits">1</td><td class="source">                Page.create(pages, cb);</td></tr><tr><td class="line">235</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source">            function(cb) {</td></tr><tr class="hit"><td class="line">237</td><td class="hits">1</td><td class="source">                PageErrors.create(errors, cb);</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source">            function(cb) {</td></tr><tr class="hit"><td class="line">240</td><td class="hits">1</td><td class="source">                Client.create(clients, cb);</td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">242</td><td class="hits"></td><td class="source">            function(cb) {</td></tr><tr class="hit"><td class="line">243</td><td class="hits">1</td><td class="source">                Plan.create(plans, cb);</td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">245</td><td class="hits"></td><td class="source">            function(cb) {</td></tr><tr class="hit"><td class="line">246</td><td class="hits">1</td><td class="source">                Coupon.create(coupons, cb);</td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">248</td><td class="hits"></td><td class="source">            function(cb) {</td></tr><tr class="hit"><td class="line">249</td><td class="hits">1</td><td class="source">                async.each(trackingUrls, createTrackingUrlAndActivity,</td></tr><tr><td class="line">250</td><td class="hits"></td><td class="source">                    function(err) {</td></tr><tr class="hit"><td class="line">251</td><td class="hits">1</td><td class="source">                        return cb(err);</td></tr><tr><td class="line">252</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">253</td><td class="hits"></td><td class="source">                );</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">255</td><td class="hits"></td><td class="source">        ], function(err, res){</td></tr><tr class="hit"><td class="line">256</td><td class="hits">1</td><td class="source">            if(err) { console.log(err); return done(err); }</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">258</td><td class="hits">1</td><td class="source">            return done(err, res);</td></tr><tr><td class="line">259</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">261</td><td class="hits">1</td><td class="source">        function createTrackingUrlAndActivity(url, callback) {</td></tr><tr class="hit"><td class="line">262</td><td class="hits">42</td><td class="source">            TrackingUrlStatic.generateRetargetUrl(url.user, url.campaign, &quot;twitter&quot;, url.url, 'http://ad.retargeter.com/seg?add=xxxxxxx&amp;t=2', function(err, urlData){</td></tr><tr class="hit"><td class="line">263</td><td class="hits">42</td><td class="source">                if(err) console.log(&quot;error generating retarget url&quot;, err);</td></tr><tr class="hit"><td class="line">264</td><td class="hits">42</td><td class="source">                url.id = urlData._id;</td></tr><tr class="hit"><td class="line">265</td><td class="hits">42</td><td class="source">                async.each(activities, function(activity, done){</td></tr><tr class="hit"><td class="line">266</td><td class="hits">294</td><td class="source">                    var ac = TrackingUrlActivity({</td></tr><tr><td class="line">267</td><td class="hits"></td><td class="source">                        trackingId: url.id,</td></tr><tr><td class="line">268</td><td class="hits"></td><td class="source">                        campaign: url.campaign,</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source">                        data: activity.data</td></tr><tr><td class="line">270</td><td class="hits"></td><td class="source">                    });</td></tr><tr class="hit"><td class="line">271</td><td class="hits">294</td><td class="source">                    ac.save(function(err, saved){</td></tr><tr class="hit"><td class="line">272</td><td class="hits">294</td><td class="source">                        done();</td></tr><tr><td class="line">273</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source">                },</td></tr><tr><td class="line">275</td><td class="hits"></td><td class="source">                function(err){</td></tr><tr class="hit"><td class="line">276</td><td class="hits">42</td><td class="source">                    callback();</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">279</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">281</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">283</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source">        clearDatabase: _clearDatabase,</td></tr><tr><td class="line">285</td><td class="hits"></td><td class="source">        createTestData: _createTestData</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">290</td><td class="hits">1</td><td class="source">module.exports = TestData;</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/test/utils/helpers.js">/Users/warner/code/clipppr/primeloop-api/test/utils/helpers.js</h2><div id="stats" class="terrible"><div class="percentage">19%</div><div class="sloc">31</div><div class="hits">6</div><div class="misses">25</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var path    = require('path'),</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">    fs      = require('fs'),</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">    helpers  = exports;</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">function endsWith (string, ending) {</td></tr><tr class="miss"><td class="line">6</td><td class="hits">0</td><td class="source">  return string.length &gt;= ending.length &amp;&amp; </td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">    string.substr(string.length - ending.length) == ending;</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">function noop(){}</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">function fake_chain() {</td></tr><tr class="miss"><td class="line">13</td><td class="hits">0</td><td class="source">    return {</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        &quot;get&quot;                  : fake_chain,</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        &quot;post&quot;                 : fake_chain,</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">        &quot;delete&quot;               : fake_chain,</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        &quot;put&quot;                  : fake_chain,</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        &quot;intercept&quot;            : fake_chain,</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        &quot;done&quot;                 : fake_chain,</td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="source">        &quot;isDone&quot;               : function () { return true; },</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">        &quot;filteringPath&quot;        : fake_chain,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">        &quot;filteringRequestBody&quot; : fake_chain,</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        &quot;matchHeader&quot;          : fake_chain,</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        &quot;defaultReplyHeaders&quot;  : fake_chain,</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">        &quot;log&quot;                  : fake_chain</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">helpers.loadFixture = function helpersLoadFixture(filename, json) {</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">    var contents = fs.readFileSync(</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        path.join(__dirname, '../fixtures', filename), (json ? 'ascii' : null));</td></tr><tr class="miss"><td class="line">33</td><td class="hits">0</td><td class="source">    return json ? JSON.parse(contents): contents;</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">36</td><td class="hits">1</td><td class="source">helpers.nock = function helpersNock(url, fixture) {</td></tr><tr class="miss"><td class="line">37</td><td class="hits">0</td><td class="source">    if(process.env.NOCK) {</td></tr><tr class="miss"><td class="line">38</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">            nock    = require('nock'),</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">            nocks   = helpers.loadFixture(fixture + '.json', true);</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">        nocks.forEach(function(n) {</td></tr><tr class="miss"><td class="line">43</td><td class="hits">0</td><td class="source">            var npath      = n.path,</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">                method     = n.method     || &quot;get&quot;,</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">                status     = n.status     || 200,</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">                response   = </td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">                    n.buffer ? </td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">                    endsWith(n.buffer, '.png') ?</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">                    helpers.loadFixture(n.buffer)</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">                    : new Buffer(n.buffer, 'base64')</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">                    : n.response || &quot;&quot;,</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">                headers    = n.headers    || {},</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">                reqheaders = n.reqheaders || {},</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">                body       = </td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">                    n.base64 ?</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">                    new Buffer(n.base64, 'base64').toString()</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">                    : n.body       || &quot;&quot;;</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">            if(typeof response === &quot;string&quot; &amp;&amp; endsWith(response, '.json')) {</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">                response = helpers.loadFixture(path.join(fixture, response));</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">62</td><td class="hits">0</td><td class="source">            if(typeof headers === &quot;string&quot; &amp;&amp; endsWith(headers, '.json')) {</td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="source">                headers = helpers.loadFixture(path.join(fixture, headers));</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">66</td><td class="hits">0</td><td class="source">            if(body===&quot;*&quot;) {</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">                //console.log(&quot;path &quot; + npath + &quot; replying with : &quot; + response);</td></tr><tr class="miss"><td class="line">68</td><td class="hits">0</td><td class="source">                nock(url).filteringRequestBody(function() {</td></tr><tr class="miss"><td class="line">69</td><td class="hits">0</td><td class="source">                    return &quot;*&quot;;</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">                })[method](npath, &quot;*&quot;).reply(status, response, headers);</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="miss"><td class="line">72</td><td class="hits">0</td><td class="source">                var nk = nock(url);</td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="source">                if(reqheaders !== {}) {</td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="source">                    for (var k in reqheaders) {</td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="source">                        nk = nk.matchHeader(k, reqheaders[k]);</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">77</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">                //console.log(&quot;path &quot; + npath + &quot; replying with : &quot; + response);</td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">                nk.intercept(npath, method, body).reply(status, response, headers);</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">    });</td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="source">    nock(url).log(console.log);</td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="source">    return nock(url);</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">    } else {</td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="source">        console.log(&quot;returning fake chain&quot;);</td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="source">        return fake_chain();</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">88</td><td class="hits"></td><td class="source">};</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/utils/archive.js">/Users/warner/code/clipppr/primeloop-api/utils/archive.js</h2><div id="stats" class="high"><div class="percentage">92%</div><div class="sloc">39</div><div class="hits">36</div><div class="misses">3</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var ArchiveUtils = function(){</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">        mongoose = require(&quot;mongoose&quot;), </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Clipp = require(&quot;/Users/warner/code/clipppr/primeloop-api/utils/../models/clipp&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        Page = require(&quot;/Users/warner/code/clipppr/primeloop-api/utils/../models/page&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        async = require(&quot;async&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        ArrayUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/utils/./array&quot;);</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">    var _archiveClipp = function(clipp, done) {</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        //first we need to look up clipp and page, or maybe just page with clipp id</td></tr><tr class="hit"><td class="line">11</td><td class="hits">34</td><td class="source">        Page.Model</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">            .findOne({</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">                clipps: clipp._id</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">            .exec(function(err, page) {</td></tr><tr class="hit"><td class="line">16</td><td class="hits">34</td><td class="source">                if(err) return done(err);</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">                //this should return all pages that reference this clipp - should be one</td></tr><tr class="hit"><td class="line">18</td><td class="hits">34</td><td class="source">                if(page === null) {</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">                    //no page so just archive the clipp</td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="source">                    Clipp.Archive.add(clipp, function(err, result){</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">                        if(err) return done(err);</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">                        return done(null, {message:&quot;Clipp archived.&quot;});</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">                    });</td></tr><tr class="hit"><td class="line">24</td><td class="hits">34</td><td class="source">                } else if (page.clipps.length == 1) {</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">                    //only references one clipp, should be safe to archive</td></tr><tr class="hit"><td class="line">26</td><td class="hits">2</td><td class="source">                    Clipp.Archive.add(clipp, function(err, result){</td></tr><tr class="hit"><td class="line">27</td><td class="hits">2</td><td class="source">                        if(err) return done(err);</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">                        //need to remove the clipp from the page</td></tr><tr class="hit"><td class="line">29</td><td class="hits">2</td><td class="source">                        _removeClipp(page.clipps, clipp, function(clipps) {</td></tr><tr class="hit"><td class="line">30</td><td class="hits">2</td><td class="source">                            page.clipps = clipps;</td></tr><tr class="hit"><td class="line">31</td><td class="hits">2</td><td class="source">                            page.markModified(&quot;clipps&quot;);</td></tr><tr class="hit"><td class="line">32</td><td class="hits">2</td><td class="source">                            page.save(function(err, newPage) {</td></tr><tr class="hit"><td class="line">33</td><td class="hits">2</td><td class="source">                                Page.Archive.add(newPage, function(err, pageRes) {</td></tr><tr class="hit"><td class="line">34</td><td class="hits">2</td><td class="source">                                    if(err) return done(err);</td></tr><tr class="hit"><td class="line">35</td><td class="hits">2</td><td class="source">                                    return done(null, {message:&quot;Clipp and Page archived.&quot;});</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">                                });</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">                } else {</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">                    //just archive clipp</td></tr><tr class="hit"><td class="line">42</td><td class="hits">32</td><td class="source">                    Clipp.Archive.add(clipp, function(err, result){</td></tr><tr class="hit"><td class="line">43</td><td class="hits">32</td><td class="source">                        if(err) return done(err);</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">                        //once we're done we need to remove the clipp from the page ref</td></tr><tr class="hit"><td class="line">45</td><td class="hits">32</td><td class="source">                        _removeClipp(page.clipps, clipp, function(clipps) {</td></tr><tr class="hit"><td class="line">46</td><td class="hits">32</td><td class="source">                            page.clipps = clipps;</td></tr><tr class="hit"><td class="line">47</td><td class="hits">32</td><td class="source">                            page.markModified(&quot;clipps&quot;);</td></tr><tr class="hit"><td class="line">48</td><td class="hits">32</td><td class="source">                            page.save(function(err, newPage) {</td></tr><tr class="hit"><td class="line">49</td><td class="hits">32</td><td class="source">                                if(err) return done(err);</td></tr><tr class="hit"><td class="line">50</td><td class="hits">32</td><td class="source">                                return done(null, {message:&quot;Clipp archived.&quot;});</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">                                </td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">                            });</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">                        </td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">60</td><td class="hits">1</td><td class="source">    var _archiveClipps = function(clipp_ids, done) {</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">        //call _archiveClipp? Or just do a different query to get all pages?</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">        //After trying it for a bit I think just grab all the clipps based on id and loop through them :P</td></tr><tr class="hit"><td class="line">63</td><td class="hits">1</td><td class="source">        Clipp.Model</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">            .find({</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">                _id: {$in: clipp_ids}</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">            })</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">            .exec(function(err, clipps) {</td></tr><tr class="hit"><td class="line">68</td><td class="hits">1</td><td class="source">                async.eachSeries(clipps, _archiveClipp, function(err) {</td></tr><tr class="hit"><td class="line">69</td><td class="hits">1</td><td class="source">                    if(err) return done(err);</td></tr><tr class="hit"><td class="line">70</td><td class="hits">1</td><td class="source">                    done(null, {message: &quot;All Clipps archived.&quot;});</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">75</td><td class="hits">1</td><td class="source">    var _removeClipp = function(clipps, clipp, done) {</td></tr><tr class="hit"><td class="line">76</td><td class="hits">34</td><td class="source">        var arr = ArrayUtils.removeElement(clipps, clipp._id);</td></tr><tr class="hit"><td class="line">77</td><td class="hits">34</td><td class="source">        return done(arr);</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">80</td><td class="hits">1</td><td class="source">    var _unarchiveClipp = function(clippId, done) {</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source">        //TODO: when implementing this we need to make sure that we:</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">        //a) unarchive the clipp</td></tr><tr><td class="line">83</td><td class="hits"></td><td class="source">        //b) unarchive the page (if it is)</td></tr><tr><td class="line">84</td><td class="hits"></td><td class="source">        //c) add it back to the page</td></tr><tr><td class="line">85</td><td class="hits"></td><td class="source">        // we may need to do b) first</td></tr><tr><td class="line">86</td><td class="hits"></td><td class="source">    }; </td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">88</td><td class="hits">1</td><td class="source">    var _unarchiveNotebook = function(notebookId, done) {</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">        //TODO: when implementing this we need to make sure that we:</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">        //a) unarchive the clipp</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source">        //b) unarchive the page (if it is)</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">        //c) add it back to the page</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">        //d) unarchive notebook and add clipps back to it</td></tr><tr><td class="line">94</td><td class="hits"></td><td class="source">        // we may need to do b) first</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">97</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">        archiveClipp: _archiveClipp,</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">        archiveClipps: _archiveClipps</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">103</td><td class="hits">1</td><td class="source">module.exports = ArchiveUtils;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/utils/array.js">/Users/warner/code/clipppr/primeloop-api/utils/array.js</h2><div id="stats" class="high"><div class="percentage">78%</div><div class="sloc">56</div><div class="hits">44</div><div class="misses">12</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var ArrayUtils = function(){</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">    var check = require('validator').check;</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">    </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">    var _inArray = function(val, arr, key){</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        </td></tr><tr class="hit"><td class="line">6</td><td class="hits">241</td><td class="source">        if(arr &amp;&amp; arr.toObject) arr = arr.toObject();</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">240</td><td class="source">        if(!arr || arr.length &lt;= 0) return -1;</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">190</td><td class="source">        if(typeof arr[0] !== &quot;object&quot;) {</td></tr><tr class="hit"><td class="line">11</td><td class="hits">6</td><td class="source">            return arr.indexOf(val);</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">14</td><td class="hits">184</td><td class="source">        if(typeof arr[0] === &quot;object&quot; &amp;&amp; key){</td></tr><tr class="hit"><td class="line">15</td><td class="hits">184</td><td class="source">            key = key.split(&quot;.&quot;) || key;</td></tr><tr class="hit"><td class="line">16</td><td class="hits">184</td><td class="source">            var obj;</td></tr><tr class="hit"><td class="line">17</td><td class="hits">184</td><td class="source">            for(var i in arr) {</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">                </td></tr><tr class="hit"><td class="line">19</td><td class="hits">989</td><td class="source">                obj = arr[i];</td></tr><tr class="hit"><td class="line">20</td><td class="hits">989</td><td class="source">                for(var j in key){</td></tr><tr class="hit"><td class="line">21</td><td class="hits">1069</td><td class="source">                    obj = (obj[key[j]]) ? obj[key[j]] : obj;</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">24</td><td class="hits">1163</td><td class="source">                if(obj == val) return parseInt(i,10);      </td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">28</td><td class="hits">10</td><td class="source">        return -1;</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">30</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">32</td><td class="hits">1</td><td class="source">    var _uniqueArray = function(myArray){</td></tr><tr class="hit"><td class="line">33</td><td class="hits">30</td><td class="source">        return myArray.filter(function(elem, pos, self) {</td></tr><tr class="hit"><td class="line">34</td><td class="hits">59</td><td class="source">            return self.indexOf(elem) == pos;</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">38</td><td class="hits">1</td><td class="source">    var _removeElement = function(arr, val) {</td></tr><tr class="hit"><td class="line">39</td><td class="hits">34</td><td class="source">        var idx = arr.indexOf(val);</td></tr><tr class="hit"><td class="line">40</td><td class="hits">34</td><td class="source">        if(idx &lt; 0) return arr;</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">42</td><td class="hits">34</td><td class="source">        arr.splice(idx, 1);</td></tr><tr class="hit"><td class="line">43</td><td class="hits">34</td><td class="source">        return arr;</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">46</td><td class="hits">1</td><td class="source">    var _nonEmptyElements = function(myArray) {</td></tr><tr class="hit"><td class="line">47</td><td class="hits">6</td><td class="source">        return myArray.filter(function(elem, pos, self){</td></tr><tr class="hit"><td class="line">48</td><td class="hits">25</td><td class="source">            if(elem !== null) {</td></tr><tr class="hit"><td class="line">49</td><td class="hits">24</td><td class="source">                if(elem.trim() !== &quot;&quot;) {</td></tr><tr class="hit"><td class="line">50</td><td class="hits">19</td><td class="source">                    return true;</td></tr><tr class="hit"><td class="line">51</td><td class="hits">5</td><td class="source">                } else if(elem.trim().length &gt; 0) {</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">                    return true;</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="hit"><td class="line">55</td><td class="hits">1</td><td class="source">                return false;</td></tr><tr><td class="line">56</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">60</td><td class="hits">1</td><td class="source">    var _sliceIntoGroups = function(myArray, size) {</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">        //console.log(&quot;slicing: &quot; + JSON.stringify(myArray));</td></tr><tr class="hit"><td class="line">62</td><td class="hits">4</td><td class="source">        if(!size) {</td></tr><tr class="hit"><td class="line">63</td><td class="hits">4</td><td class="source">            size = 5;</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">65</td><td class="hits">4</td><td class="source">        var groups = [];</td></tr><tr class="hit"><td class="line">66</td><td class="hits">4</td><td class="source">        while (myArray.length &gt; size) {</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">            //console.log(&quot;array length: &quot; + myArray.length + &quot; greater than: &quot; + size);</td></tr><tr class="hit"><td class="line">68</td><td class="hits">3</td><td class="source">            groups.push(myArray.slice(0,size));</td></tr><tr class="hit"><td class="line">69</td><td class="hits">3</td><td class="source">            myArray = myArray.slice(5, myArray.length);</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">71</td><td class="hits">4</td><td class="source">        if(myArray.length &lt;= size) {</td></tr><tr class="hit"><td class="line">72</td><td class="hits">4</td><td class="source">            groups.push(myArray);</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">        //console.log(&quot;returning array: &quot; + JSON.stringify(groups));</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">77</td><td class="hits">4</td><td class="source">        return groups;</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">80</td><td class="hits">1</td><td class="source">    var _sanitizeAndValidateArray = function(myArray) {</td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="source">        var array = [];</td></tr><tr class="miss"><td class="line">82</td><td class="hits">0</td><td class="source">        var badUrls = [];</td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="source">        for(var i = 0; i &lt; myArray.length; i++) {</td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="source">            var elem = myArray[i].trim();</td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="source">            elem = elem.replace('\t','');</td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="source">            try {</td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="source">                check(elem).notNull().isUrl();</td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="source">                array.push(elem);</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">            } catch (e) {</td></tr><tr class="miss"><td class="line">90</td><td class="hits">0</td><td class="source">                console.log(e.message); //Invalid integer</td></tr><tr class="miss"><td class="line">91</td><td class="hits">0</td><td class="source">                badUrls.push(elem);</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">93</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="source">        return [array, badUrls];</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">97</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">        inArray: _inArray,</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">        uniqueArray: _uniqueArray,</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">        removeElement: _removeElement,</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">        nonEmptyElements: _nonEmptyElements,</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">        sliceIntoGroups: _sliceIntoGroups,</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">        sanitizeAndValidateArray: _sanitizeAndValidateArray</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">107</td><td class="hits">1</td><td class="source">module.exports = ArrayUtils;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/utils/auth.js">/Users/warner/code/clipppr/primeloop-api/utils/auth.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">6</div><div class="hits">6</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var AuthUtils = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">        </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/utils/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        crypto = require(&quot;crypto&quot;);</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">7</td><td class="hits">1</td><td class="source">    var _hashPassword = function(password){</td></tr><tr class="hit"><td class="line">8</td><td class="hits">42</td><td class="source">        return crypto.createHash('md5').update(password + Settings.auth.password_salt).digest(&quot;hex&quot;);</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">11</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        hashPassword: _hashPassword</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">module.exports = AuthUtils;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/utils/errors.js">/Users/warner/code/clipppr/primeloop-api/utils/errors.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">9</div><div class="hits">9</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var ErrorUtils = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">4</td><td class="hits">1</td><td class="source">    var _parseRequestForRaven = function(req){</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">6</td><td class="hits">55</td><td class="source">        var kwargs = kwargs || {};</td></tr><tr class="hit"><td class="line">7</td><td class="hits">55</td><td class="source">        kwargs['sentry.interfaces.Http'] = {</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">            method: req.method,</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">            headers: req.headers,</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">            cookies: req.cookies || '&lt;unavailable: use cookieParser middleware&gt;',</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">            data: req.params,</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">            url: (function build_absolute_url() {</td></tr><tr class="hit"><td class="line">13</td><td class="hits">55</td><td class="source">                var protocol = req.socket.encrypted ? 'https' : 'http',</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">                    host = req.headers.host || '&lt;no host&gt;';</td></tr><tr class="hit"><td class="line">15</td><td class="hits">55</td><td class="source">                return protocol+'://'+host+req.url;</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source">            }()),</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">            env: process.env</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">20</td><td class="hits">55</td><td class="source">        return kwargs;</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">23</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">        parseRequestForRaven: _parseRequestForRaven</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">28</td><td class="hits">1</td><td class="source">module.exports = ErrorUtils;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/utils/feed_parsing.js">/Users/warner/code/clipppr/primeloop-api/utils/feed_parsing.js</h2><div id="stats" class="terrible"><div class="percentage">8%</div><div class="sloc">93</div><div class="hits">8</div><div class="misses">85</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var FeedParsingUtils = function(){</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">        settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/utils/../config/settings&quot;),</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        moment = require('moment'),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        FeedParser = require(&quot;feedparser&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        Iconv = require('iconv').Iconv,</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        request = require(&quot;request&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        async = require(&quot;async&quot;);</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    function configureRequest(feedUrl, feedparser, errorHandler) {</td></tr><tr class="miss"><td class="line">11</td><td class="hits">0</td><td class="source">        var feedReq = request(feedUrl, {timeout: 10000, pool: false});</td></tr><tr class="miss"><td class="line">12</td><td class="hits">0</td><td class="source">        feedReq.setMaxListeners(50);</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">        // Some feeds do not response without user-agent and accept headers.</td></tr><tr class="miss"><td class="line">14</td><td class="hits">0</td><td class="source">        feedReq.setHeader('user-agent', 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/31.0.1650.63 Safari/537.36')</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">            .setHeader('accept', 'text/html,application/xhtml+xml');</td></tr><tr><td class="line">16</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        // Define our handlers</td></tr><tr class="miss"><td class="line">18</td><td class="hits">0</td><td class="source">        feedReq.on('error', errorHandler);</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="source">        feedReq.on('response', function(resp) {</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">            var stream = this, </td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">            iconv, </td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">            charset;</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">            // console.log(&quot;response status code: %d&quot;, resp.statusCode);</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">            if (resp.statusCode != 200) return this.emit('error', new Error('Bad status code : ' + resp.statusCode));</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">27</td><td class="hits">0</td><td class="source">            charset = _getParams(resp.headers['content-type'] || '').charset;</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source">            // Use iconv if its not utf8 already.</td></tr><tr class="miss"><td class="line">30</td><td class="hits">0</td><td class="source">            if (!iconv &amp;&amp; charset &amp;&amp; !/utf-*8/i.test(charset)) {</td></tr><tr class="miss"><td class="line">31</td><td class="hits">0</td><td class="source">                try {</td></tr><tr class="miss"><td class="line">32</td><td class="hits">0</td><td class="source">                    iconv = new Iconv(charset, 'utf-8');</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">                    // console.log('Converting from charset %s to utf-8', charset);</td></tr><tr class="miss"><td class="line">34</td><td class="hits">0</td><td class="source">                    iconv.on('error', function(err) { </td></tr><tr class="miss"><td class="line">35</td><td class="hits">0</td><td class="source">                        errorHandler(err);</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">                    });</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">                    // If we're using iconv, stream will be the output of iconv</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">                    // otherwise it will remain the output of request</td></tr><tr class="miss"><td class="line">39</td><td class="hits">0</td><td class="source">                    stream = this.pipe(iconv);</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">                } catch(err) {</td></tr><tr class="miss"><td class="line">41</td><td class="hits">0</td><td class="source">                    console.log(&quot;request error:&quot;, err);</td></tr><tr class="miss"><td class="line">42</td><td class="hits">0</td><td class="source">                    this.emit('error', err);</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">            // And boom goes the dynamite</td></tr><tr class="miss"><td class="line">47</td><td class="hits">0</td><td class="source">            stream.pipe(feedparser);</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">50</td><td class="hits">0</td><td class="source">        return feedReq;</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">53</td><td class="hits">1</td><td class="source">    function _getParams(str) {</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">        var params = str.split(';').reduce(function (params, param) {</td></tr><tr class="miss"><td class="line">55</td><td class="hits">0</td><td class="source">            var parts = param.split('=').map(function (part) { return part.trim(); });</td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">            if (parts.length === 2) {</td></tr><tr class="miss"><td class="line">57</td><td class="hits">0</td><td class="source">                params[parts[0]] = parts[1];</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">            }</td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">            return params;</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">        }, {});</td></tr><tr class="miss"><td class="line">61</td><td class="hits">0</td><td class="source">        return params;</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">    }</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">        </td></tr><tr class="hit"><td class="line">64</td><td class="hits">1</td><td class="source">    var _parseFeedAndReturnPosts = function(user, notebookId, feedUrl, feedLastUpdated, done) {</td></tr><tr class="miss"><td class="line">65</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source">            postsToProcess = [],</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">            failedPosts = [],</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">            errors =[],</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">            needsUpdate = false,</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">            lastUpdated,</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">            feedLastUpdatedMoment = moment(feedLastUpdated);</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">73</td><td class="hits">0</td><td class="source">        var feedparser = new FeedParser();</td></tr><tr class="miss"><td class="line">74</td><td class="hits">0</td><td class="source">        if(feedUrl.indexOf(&quot;http://&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">75</td><td class="hits">0</td><td class="source">            feedUrl = &quot;http://&quot; + feedUrl;</td></tr><tr><td class="line">76</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">77</td><td class="hits">0</td><td class="source">        var feedReq = configureRequest(feedUrl, feedparser, _requestError);</td></tr><tr><td class="line">78</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">79</td><td class="hits">0</td><td class="source">        feedparser.on('error', _feedParserError);</td></tr><tr><td class="line">80</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">81</td><td class="hits">0</td><td class="source">        feedparser.on('end', _finished);</td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">83</td><td class="hits">0</td><td class="source">        feedparser.on('meta', function() {</td></tr><tr class="miss"><td class="line">84</td><td class="hits">0</td><td class="source">            lastUpdated = new moment(this.meta.date);</td></tr><tr class="miss"><td class="line">85</td><td class="hits">0</td><td class="source">            if (feedLastUpdatedMoment.isBefore(lastUpdated)) {</td></tr><tr class="miss"><td class="line">86</td><td class="hits">0</td><td class="source">                needsUpdate = true;</td></tr><tr><td class="line">87</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="source">                _finished();</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">91</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">92</td><td class="hits">0</td><td class="source">        feedparser.on('readable', function() {</td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="source">            var post;</td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="source">            post = this.read();</td></tr><tr class="miss"><td class="line">95</td><td class="hits">0</td><td class="source">            while (needsUpdate &amp;&amp; post) {</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">97</td><td class="hits">0</td><td class="source">                var postData = {</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">                    title: post.title,</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source">                    url: post.link,</td></tr><tr><td class="line">100</td><td class="hits"></td><td class="source">                    author : post.author,</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">                    published : post.pubdate,</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">                    description : post.summary,</td></tr><tr><td class="line">103</td><td class="hits"></td><td class="source">                    notebook: notebookId,</td></tr><tr><td class="line">104</td><td class="hits"></td><td class="source">                    source: 'feed',</td></tr><tr><td class="line">105</td><td class="hits"></td><td class="source">                    sourceURL: this.meta.xmlurl</td></tr><tr><td class="line">106</td><td class="hits"></td><td class="source">                };</td></tr><tr class="miss"><td class="line">107</td><td class="hits">0</td><td class="source">                if(user) postData.creator = user._id;</td></tr><tr class="miss"><td class="line">108</td><td class="hits">0</td><td class="source">                if(this.meta.title) postData.site = {name: this.meta.title};</td></tr><tr class="miss"><td class="line">109</td><td class="hits">0</td><td class="source">                if(post.origlink) postData.url = post.origlink;</td></tr><tr class="miss"><td class="line">110</td><td class="hits">0</td><td class="source">                if(feedLastUpdatedMoment.isBefore(postData.published) &amp;&amp; postData.url) {</td></tr><tr class="miss"><td class="line">111</td><td class="hits">0</td><td class="source">                    postsToProcess.push(postData.url);</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="miss"><td class="line">113</td><td class="hits">0</td><td class="source">                    failedPosts.push(postData.url);</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">115</td><td class="hits">0</td><td class="source">                post = this.read();</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">118</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">119</td><td class="hits">0</td><td class="source">        function _requestError(reqError) {</td></tr><tr class="miss"><td class="line">120</td><td class="hits">0</td><td class="source">            errors.push({type:'request', error:reqError.message});</td></tr><tr><td class="line">121</td><td class="hits"></td><td class="source">            //if we hit this then finish never gets called so we have to do it manually</td></tr><tr class="miss"><td class="line">122</td><td class="hits">0</td><td class="source">            _finished();</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">124</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">125</td><td class="hits">0</td><td class="source">        function _feedParserError(fpError) {</td></tr><tr class="miss"><td class="line">126</td><td class="hits">0</td><td class="source">            errors.push({type:'feedparser', error:fpError.message});</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">            //don't think we need to manually call finish here but we might</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">129</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">130</td><td class="hits">0</td><td class="source">        function _finished() {</td></tr><tr class="miss"><td class="line">131</td><td class="hits">0</td><td class="source">            return done(errors, postsToProcess, failedPosts, lastUpdated.toDate());</td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">134</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">137</td><td class="hits">1</td><td class="source">    var _parseNewFeedAndReturnPosts = function(user, notebookId, feedUrl, done) {</td></tr><tr class="miss"><td class="line">138</td><td class="hits">0</td><td class="source">        var </td></tr><tr><td class="line">139</td><td class="hits"></td><td class="source">            postsToProcess = [],</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">            failedPosts = [],</td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">            feedData = {</td></tr><tr><td class="line">142</td><td class="hits"></td><td class="source">                url: feedUrl,</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">                feedUrl : feedUrl,</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">                valid: false,</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">                user: user._id</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">            },</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">            errors =[],</td></tr><tr><td class="line">148</td><td class="hits"></td><td class="source">            needsUpdate = false,</td></tr><tr><td class="line">149</td><td class="hits"></td><td class="source">            lastUpdated;</td></tr><tr class="miss"><td class="line">150</td><td class="hits">0</td><td class="source">        if(feedUrl.indexOf(&quot;http://&quot;) &lt; 0) {</td></tr><tr class="miss"><td class="line">151</td><td class="hits">0</td><td class="source">            feedUrl = &quot;http://&quot; + feedUrl;</td></tr><tr><td class="line">152</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">153</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">154</td><td class="hits">0</td><td class="source">        var feedparser = new FeedParser();</td></tr><tr class="miss"><td class="line">155</td><td class="hits">0</td><td class="source">        var feedReq = configureRequest(feedUrl, feedparser, _requestError);</td></tr><tr><td class="line">156</td><td class="hits"></td><td class="source">        </td></tr><tr class="miss"><td class="line">157</td><td class="hits">0</td><td class="source">        feedparser.on('error', _feedParserError);</td></tr><tr><td class="line">158</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="source">        feedparser.on('end', _finished);</td></tr><tr><td class="line">160</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">161</td><td class="hits">0</td><td class="source">        feedparser.on('meta', function() {</td></tr><tr class="miss"><td class="line">162</td><td class="hits">0</td><td class="source">            var newFeed = {</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">                url: this.meta.link,</td></tr><tr><td class="line">164</td><td class="hits"></td><td class="source">                siteName: this.meta.title,</td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">                feedUrl : this.meta.xmlurl,</td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">                lastUpdated : this.meta.date,</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">                valid: true,</td></tr><tr><td class="line">168</td><td class="hits"></td><td class="source">                user: user._id</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">            };</td></tr><tr class="miss"><td class="line">170</td><td class="hits">0</td><td class="source">            if(!newFeed.feedUrl) newFeed.feedUrl = feedUrl;</td></tr><tr class="miss"><td class="line">171</td><td class="hits">0</td><td class="source">            metaParsingFinished = true;</td></tr><tr class="miss"><td class="line">172</td><td class="hits">0</td><td class="source">            feedData  = newFeed;</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">174</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">175</td><td class="hits">0</td><td class="source">        feedparser.on('readable', function() {</td></tr><tr class="miss"><td class="line">176</td><td class="hits">0</td><td class="source">            var post;</td></tr><tr class="miss"><td class="line">177</td><td class="hits">0</td><td class="source">            post = this.read();</td></tr><tr class="miss"><td class="line">178</td><td class="hits">0</td><td class="source">            while (metaParsingFinished &amp;&amp; post) {</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">180</td><td class="hits">0</td><td class="source">                var postData = {</td></tr><tr><td class="line">181</td><td class="hits"></td><td class="source">                    title: post.title,</td></tr><tr><td class="line">182</td><td class="hits"></td><td class="source">                    url: post.link,</td></tr><tr><td class="line">183</td><td class="hits"></td><td class="source">                    author : post.author,</td></tr><tr><td class="line">184</td><td class="hits"></td><td class="source">                    published : post.pubdate,</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source">                    description : post.summary,</td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">                    creator : user._id,</td></tr><tr><td class="line">187</td><td class="hits"></td><td class="source">                    notebook: notebookId,</td></tr><tr><td class="line">188</td><td class="hits"></td><td class="source">                    source: 'feed',</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">                    sourceURL: feedData.feedUrl</td></tr><tr><td class="line">190</td><td class="hits"></td><td class="source">                };</td></tr><tr class="miss"><td class="line">191</td><td class="hits">0</td><td class="source">                if(this.meta.title) postData.site = {name: this.meta.title};</td></tr><tr class="miss"><td class="line">192</td><td class="hits">0</td><td class="source">                if(post.origlink) postData.url = post.origlink;</td></tr><tr class="miss"><td class="line">193</td><td class="hits">0</td><td class="source">                if(postData.url) {</td></tr><tr class="miss"><td class="line">194</td><td class="hits">0</td><td class="source">                    postsToProcess.push(postData.url);</td></tr><tr><td class="line">195</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="miss"><td class="line">196</td><td class="hits">0</td><td class="source">                    failedPosts.push(postData.url);</td></tr><tr><td class="line">197</td><td class="hits"></td><td class="source">                }</td></tr><tr class="miss"><td class="line">198</td><td class="hits">0</td><td class="source">                post = this.read();</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">201</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">202</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">203</td><td class="hits">0</td><td class="source">        function _requestError(reqError) {</td></tr><tr class="miss"><td class="line">204</td><td class="hits">0</td><td class="source">            errors.push({type:'request', error:reqError.message});</td></tr><tr><td class="line">205</td><td class="hits"></td><td class="source">            //if we hit this then finish never gets called so we have to do it manually</td></tr><tr class="miss"><td class="line">206</td><td class="hits">0</td><td class="source">            _finished();</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">208</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">209</td><td class="hits">0</td><td class="source">        function _feedParserError(fpError) {</td></tr><tr class="miss"><td class="line">210</td><td class="hits">0</td><td class="source">            errors.push({type:'feedparser', error:fpError.message});</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">            //don't think we need to manually call finish here but we might</td></tr><tr><td class="line">212</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">214</td><td class="hits">0</td><td class="source">        function _finished() {</td></tr><tr class="miss"><td class="line">215</td><td class="hits">0</td><td class="source">            return done(errors, postsToProcess, failedPosts, feedData);</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">217</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">218</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source">    </td></tr><tr class="hit"><td class="line">221</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">        parseFeedAndReturnPosts: _parseFeedAndReturnPosts,</td></tr><tr><td class="line">223</td><td class="hits"></td><td class="source">        parseNewFeedAndReturnPosts: _parseNewFeedAndReturnPosts</td></tr><tr><td class="line">224</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">227</td><td class="hits">1</td><td class="source">module.exports = FeedParsingUtils;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/utils/google.js">/Users/warner/code/clipppr/primeloop-api/utils/google.js</h2><div id="stats" class="medium"><div class="percentage">57%</div><div class="sloc">7</div><div class="hits">4</div><div class="misses">3</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">function GoogleOAuthSecurity(token) {</td></tr><tr class="miss"><td class="line">2</td><td class="hits">0</td><td class="source">  this._token = token;</td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">}</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">1</td><td class="source">GoogleOAuthSecurity.prototype.addHeaders = function(headers) {</td></tr><tr class="miss"><td class="line">6</td><td class="hits">0</td><td class="source">  headers.Authorization = &quot;Bearer &quot; + this._token;</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">GoogleOAuthSecurity.prototype.toXML = function() {</td></tr><tr class="miss"><td class="line">10</td><td class="hits">0</td><td class="source">  return &quot;&quot;;</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">};</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">1</td><td class="source">module.exports = GoogleOAuthSecurity;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/utils/intercom.js">/Users/warner/code/clipppr/primeloop-api/utils/intercom.js</h2><div id="stats" class="medium"><div class="percentage">69%</div><div class="sloc">132</div><div class="hits">92</div><div class="misses">40</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var IntercomUtils = function(){</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">3</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/utils/../config/settings&quot;),</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        JSONUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/utils/./json&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        ObjectUtils = require(&quot;/Users/warner/code/clipppr/primeloop-api/utils/./objects&quot;),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        async  = require(&quot;async&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        nock = require(&quot;nock&quot;),</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        moment = require('moment');</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    var intercomSettings = {</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        &quot;API_KEY&quot;: Settings.intercom.api_key,</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        &quot;APP_ID&quot;: Settings.intercom.app_id</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    };</td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">    var intercom = require('node-intercom').app(intercomSettings);</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">    var _newWaitingListUser = function(wuser, tags, done) {</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">        //nock.recorder.rec(true);    </td></tr><tr class="hit"><td class="line">19</td><td class="hits">20</td><td class="source">        var data = {</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">            email: wuser.email,</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">            name: wuser.name,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">            created_at: null,</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">            custom_data: {</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">                added_to_waiting_list: moment(wuser.created).unix(),</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">                wuser_id: wuser._id,</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">                phoneSupport: wuser.phone</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        };</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">20</td><td class="source">        if(wuser.company) {</td></tr><tr class="hit"><td class="line">31</td><td class="hits">20</td><td class="source">            data.custom_data.company_name = wuser.company.name;</td></tr><tr class="hit"><td class="line">32</td><td class="hits">20</td><td class="source">            data.custom_data.company_size = wuser.company.size;</td></tr><tr class="hit"><td class="line">33</td><td class="hits">20</td><td class="source">            data.custom_data.industry = wuser.company.industry;</td></tr><tr class="hit"><td class="line">34</td><td class="hits">20</td><td class="source">            data.custom_data.specificIndustry = wuser.company.specificIndustry;</td></tr><tr class="hit"><td class="line">35</td><td class="hits">20</td><td class="source">            data.custom_data.role = wuser.company.role;</td></tr><tr class="hit"><td class="line">36</td><td class="hits">20</td><td class="source">            data.custom_data.domain = wuser.company.domain;</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">39</td><td class="hits"></td><td class="source">        // console.log(&quot;creating new user: %j&quot;, data);</td></tr><tr class="hit"><td class="line">40</td><td class="hits">20</td><td class="source">        intercom.users.post(data, function(code, body){</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source">            // console.log(&quot;response from creating new user: %s, %j&quot;, code, body);</td></tr><tr class="hit"><td class="line">42</td><td class="hits">20</td><td class="source">            JSONUtils.safeParse(body.toString(), function(err, response){</td></tr><tr class="hit"><td class="line">43</td><td class="hits">20</td><td class="source">                if(err) return done(err);</td></tr><tr class="hit"><td class="line">44</td><td class="hits">20</td><td class="source">                if(code &gt;= 200 &amp;&amp; code &lt; 300) {</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source">                    // console.log(&quot;new intercom waiting user created %j&quot;, response);</td></tr><tr class="hit"><td class="line">46</td><td class="hits">5</td><td class="source">                    if(tags) {</td></tr><tr class="hit"><td class="line">47</td><td class="hits">5</td><td class="source">                        _tagUser(wuser.email, tags, function(err) {</td></tr><tr class="hit"><td class="line">48</td><td class="hits">5</td><td class="source">                            if(err) console.log(&quot;error tagging user: &quot; + err);</td></tr><tr class="hit"><td class="line">49</td><td class="hits">5</td><td class="source">                            return done(err);</td></tr><tr><td class="line">50</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">                    } else {</td></tr><tr class="miss"><td class="line">52</td><td class="hits">0</td><td class="source">                        return done();</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">                    </td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="hit"><td class="line">56</td><td class="hits">15</td><td class="source">                    console.log(&quot;error creating intercom user: &quot; + response._id + &quot;, code: &quot; + code + &quot;, error: &quot; + response.error);</td></tr><tr class="hit"><td class="line">57</td><td class="hits">15</td><td class="source">                    return done(response.error);</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">59</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">63</td><td class="hits">1</td><td class="source">    var _newUser = function(user, tags, done) {</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">        //console.log(&quot;creating new user: &quot; + user.email);</td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">        //nock.recorder.rec(true);  </td></tr><tr class="hit"><td class="line">66</td><td class="hits">19</td><td class="source">        var data = {</td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source">            user_id: user._id,</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source">            email: user.email,</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">            created_at: moment(user.created).unix(),</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">            custom_data: {}</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">        };</td></tr><tr class="hit"><td class="line">72</td><td class="hits">19</td><td class="source">        if(user.settings) {</td></tr><tr class="hit"><td class="line">73</td><td class="hits">19</td><td class="source">            delete user.settings.notebooks;</td></tr><tr class="hit"><td class="line">74</td><td class="hits">19</td><td class="source">            data.custom_data = ObjectUtils.flattenObject(user.settings, 0, &quot;settings&quot;);</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">76</td><td class="hits">19</td><td class="source">        if(user.job &amp;&amp; user.job.company) {</td></tr><tr class="hit"><td class="line">77</td><td class="hits">19</td><td class="source">            data.custom_data.company_name = user.job.company.name;</td></tr><tr class="hit"><td class="line">78</td><td class="hits">19</td><td class="source">            data.custom_data.company_size = user.job.company.size;</td></tr><tr><td class="line">79</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">80</td><td class="hits">19</td><td class="source">        intercom.users.post(data, function(code, body){</td></tr><tr><td class="line">81</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">82</td><td class="hits"></td><td class="source">            //console.log(&quot;nockcalls: &quot; + nock.recorder.play());  </td></tr><tr class="hit"><td class="line">83</td><td class="hits">19</td><td class="source">            JSONUtils.safeParse(body.toString(), function(err, response){</td></tr><tr class="hit"><td class="line">84</td><td class="hits">19</td><td class="source">                if(err) return done(err);</td></tr><tr class="hit"><td class="line">85</td><td class="hits">19</td><td class="source">                if(code &gt;= 200 &amp;&amp; code &lt; 300) {</td></tr><tr class="hit"><td class="line">86</td><td class="hits">19</td><td class="source">                    if(tags) {</td></tr><tr class="miss"><td class="line">87</td><td class="hits">0</td><td class="source">                        _tagUser(user._id, tags, function(err){</td></tr><tr class="miss"><td class="line">88</td><td class="hits">0</td><td class="source">                            return done(err);</td></tr><tr><td class="line">89</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">90</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="hit"><td class="line">91</td><td class="hits">19</td><td class="source">                    return done();</td></tr><tr><td class="line">92</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="miss"><td class="line">93</td><td class="hits">0</td><td class="source">                    console.log(&quot;error creating intercom user: &quot; + user._id + &quot;, code: &quot; + code + &quot;, error: &quot; + response.error);</td></tr><tr class="miss"><td class="line">94</td><td class="hits">0</td><td class="source">                    return done(response.error);</td></tr><tr><td class="line">95</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">96</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">97</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">98</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">99</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">100</td><td class="hits">1</td><td class="source">    var _updateUser = function(id, update, done) {</td></tr><tr><td class="line">101</td><td class="hits"></td><td class="source">        //grab user so we can copy stuff over that's being updated</td></tr><tr><td class="line">102</td><td class="hits"></td><td class="source">        //nock.recorder.rec(true);  </td></tr><tr class="hit"><td class="line">103</td><td class="hits">72</td><td class="source">        var data = update;</td></tr><tr class="hit"><td class="line">104</td><td class="hits">72</td><td class="source">        intercom.users.get(id,function(code, body){</td></tr><tr class="hit"><td class="line">105</td><td class="hits">72</td><td class="source">            if(body) {</td></tr><tr class="hit"><td class="line">106</td><td class="hits">72</td><td class="source">                JSONUtils.safeParse(body.toString(), function(err, response){</td></tr><tr class="hit"><td class="line">107</td><td class="hits">72</td><td class="source">                    if(err) return done(false);</td></tr><tr class="hit"><td class="line">108</td><td class="hits">72</td><td class="source">                    if(code &gt;= 200 &amp;&amp; code &lt; 300) {</td></tr><tr><td class="line">109</td><td class="hits"></td><td class="source">                        //console.log(&quot;found user: &quot; + id);</td></tr><tr><td class="line">110</td><td class="hits"></td><td class="source">                        //now we use the ObjectUtils to copy over info</td></tr><tr class="hit"><td class="line">111</td><td class="hits">2</td><td class="source">                        delete response.intercom_id;</td></tr><tr><td class="line">112</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">113</td><td class="hits">2</td><td class="source">                        var userData = ObjectUtils.copyAllProperties(data, response);</td></tr><tr><td class="line">114</td><td class="hits"></td><td class="source">                        //console.log(&quot;updating user: &quot; + JSON.stringify(userData));</td></tr><tr class="hit"><td class="line">115</td><td class="hits">2</td><td class="source">                        intercom.users.put(userData,function(code, body){</td></tr><tr><td class="line">116</td><td class="hits"></td><td class="source">                            //console.log(&quot;nockcalls: &quot; + nock.recorder.play()); </td></tr><tr><td class="line">117</td><td class="hits"></td><td class="source">                            //console.log(code, &quot;pushed data: &quot; + JSON.stringify(body.toString()));</td></tr><tr class="hit"><td class="line">118</td><td class="hits">2</td><td class="source">                            if(code &gt;= 200 &amp;&amp; code &lt; 300) {</td></tr><tr class="hit"><td class="line">119</td><td class="hits">2</td><td class="source">                                return done();</td></tr><tr><td class="line">120</td><td class="hits"></td><td class="source">                            } else {</td></tr><tr class="miss"><td class="line">121</td><td class="hits">0</td><td class="source">                                return done(code, body.toString());</td></tr><tr><td class="line">122</td><td class="hits"></td><td class="source">                            }</td></tr><tr><td class="line">123</td><td class="hits"></td><td class="source">                        });</td></tr><tr class="hit"><td class="line">124</td><td class="hits">70</td><td class="source">                    } else if (code == 404 &amp;&amp; response.error.type == &quot;not_found&quot;) {</td></tr><tr><td class="line">125</td><td class="hits"></td><td class="source">                        // console.log(&quot;intercom user not found: &quot; + id);</td></tr><tr class="hit"><td class="line">126</td><td class="hits">10</td><td class="source">                        return done(response.error);</td></tr><tr><td class="line">127</td><td class="hits"></td><td class="source">                    } else {</td></tr><tr><td class="line">128</td><td class="hits"></td><td class="source">                        // console.log(&quot;error finding intercom user: %s, code: %d, error: %j&quot;, id, code, response.error);</td></tr><tr class="hit"><td class="line">129</td><td class="hits">60</td><td class="source">                        return done(response.error);</td></tr><tr><td class="line">130</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">131</td><td class="hits"></td><td class="source">                    //console.log(&quot;nockcalls: &quot; + nock.recorder.play()); </td></tr><tr><td class="line">132</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">133</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="miss"><td class="line">134</td><td class="hits">0</td><td class="source">                return done(false);</td></tr><tr><td class="line">135</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">136</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">137</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">138</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">139</td><td class="hits">1</td><td class="source">    var _changeWaitingUserToRegularUser = function(user, tags, done) {</td></tr><tr><td class="line">140</td><td class="hits"></td><td class="source">        //nock.recorder.rec(true);  </td></tr><tr><td class="line">141</td><td class="hits"></td><td class="source">        // console.log(&quot;attempting to update a waiting list user %j&quot;, user);</td></tr><tr class="miss"><td class="line">142</td><td class="hits">0</td><td class="source">        var data = {</td></tr><tr><td class="line">143</td><td class="hits"></td><td class="source">            user_id: user._id,</td></tr><tr><td class="line">144</td><td class="hits"></td><td class="source">            email: user.email,</td></tr><tr><td class="line">145</td><td class="hits"></td><td class="source">            created_at: moment(user.created).unix(),</td></tr><tr><td class="line">146</td><td class="hits"></td><td class="source">            custom_data: {}</td></tr><tr><td class="line">147</td><td class="hits"></td><td class="source">        };</td></tr><tr class="miss"><td class="line">148</td><td class="hits">0</td><td class="source">        if(user.settings) {</td></tr><tr class="miss"><td class="line">149</td><td class="hits">0</td><td class="source">            delete user.settings.notebooks;</td></tr><tr class="miss"><td class="line">150</td><td class="hits">0</td><td class="source">            data.custom_data = ObjectUtils.flattenObject(user.settings, 0, &quot;settings&quot;);</td></tr><tr><td class="line">151</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">152</td><td class="hits">0</td><td class="source">        if(user.job &amp;&amp; user.job.company) {</td></tr><tr class="miss"><td class="line">153</td><td class="hits">0</td><td class="source">            data.custom_data.company_name = user.job.company.name;</td></tr><tr class="miss"><td class="line">154</td><td class="hits">0</td><td class="source">            data.custom_data.company_size = user.job.company.size;</td></tr><tr><td class="line">155</td><td class="hits"></td><td class="source">        }</td></tr><tr class="miss"><td class="line">156</td><td class="hits">0</td><td class="source">        intercom.users.put(data,function(code, body){</td></tr><tr class="miss"><td class="line">157</td><td class="hits">0</td><td class="source">            JSONUtils.safeParse(body.toString(), function(err, response){</td></tr><tr class="miss"><td class="line">158</td><td class="hits">0</td><td class="source">                if(code &gt;= 200 &amp;&amp; code &lt; 300) {</td></tr><tr class="miss"><td class="line">159</td><td class="hits">0</td><td class="source">                    if(tags) {</td></tr><tr class="miss"><td class="line">160</td><td class="hits">0</td><td class="source">                        _tagUser(user.email, tags, function(err){</td></tr><tr class="miss"><td class="line">161</td><td class="hits">0</td><td class="source">                            return done(err);</td></tr><tr><td class="line">162</td><td class="hits"></td><td class="source">                        });</td></tr><tr><td class="line">163</td><td class="hits"></td><td class="source">                    }</td></tr><tr class="miss"><td class="line">164</td><td class="hits">0</td><td class="source">                    return done();   </td></tr><tr><td class="line">165</td><td class="hits"></td><td class="source">                    </td></tr><tr><td class="line">166</td><td class="hits"></td><td class="source">                } else {</td></tr><tr><td class="line">167</td><td class="hits"></td><td class="source">                    // console.log(&quot;error updating intercom user: &quot; + id + &quot;, code: &quot; + code +&quot;, error: &quot; + response.error);</td></tr><tr class="miss"><td class="line">168</td><td class="hits">0</td><td class="source">                    done(response.error);</td></tr><tr><td class="line">169</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">170</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">171</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">172</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">173</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">174</td><td class="hits">1</td><td class="source">    var _tagUser = function(id_or_email, tags, done) {</td></tr><tr class="hit"><td class="line">175</td><td class="hits">86</td><td class="source">        if(!tags || tags.length &lt;=0) return done();</td></tr><tr class="hit"><td class="line">176</td><td class="hits">6</td><td class="source">        var key = (id_or_email.indexOf(&quot;@&quot;) == -1) ? &quot;user_ids&quot; : &quot;emails&quot;;</td></tr><tr><td class="line">177</td><td class="hits"></td><td class="source">        //nock.recorder.rec(true);  </td></tr><tr class="hit"><td class="line">178</td><td class="hits">6</td><td class="source">        var data = {</td></tr><tr><td class="line">179</td><td class="hits"></td><td class="source">                &quot;tag_or_untag&quot; : &quot;tag&quot;</td></tr><tr><td class="line">180</td><td class="hits"></td><td class="source">            };</td></tr><tr class="hit"><td class="line">181</td><td class="hits">6</td><td class="source">        data[key] = [id_or_email];</td></tr><tr class="hit"><td class="line">182</td><td class="hits">6</td><td class="source">        async.each(tags, function(tag, cb){</td></tr><tr class="hit"><td class="line">183</td><td class="hits">9</td><td class="source">            data.name = tag;</td></tr><tr class="hit"><td class="line">184</td><td class="hits">9</td><td class="source">            intercom.tags.post(data,function(code, body){</td></tr><tr><td class="line">185</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">186</td><td class="hits"></td><td class="source">            //console.log(&quot;nockcalls: &quot; + nock.recorder.play()); </td></tr><tr class="hit"><td class="line">187</td><td class="hits">8</td><td class="source">                if(code &gt;= 200 &amp;&amp; code &lt; 300) {</td></tr><tr class="hit"><td class="line">188</td><td class="hits">5</td><td class="source">                    cb();</td></tr><tr><td class="line">189</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="hit"><td class="line">190</td><td class="hits">3</td><td class="source">                    console.log(&quot;error tagging: &quot; + body.toString());</td></tr><tr class="hit"><td class="line">191</td><td class="hits">3</td><td class="source">                    cb();</td></tr><tr><td class="line">192</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">193</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">194</td><td class="hits"></td><td class="source">        }, function(err){</td></tr><tr class="hit"><td class="line">195</td><td class="hits">5</td><td class="source">            if(err) return done(err);</td></tr><tr><td class="line">196</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">197</td><td class="hits">5</td><td class="source">            return done();</td></tr><tr><td class="line">198</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">199</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">200</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">201</td><td class="hits">1</td><td class="source">    var _untagUser = function(id_or_email, tags, done) {</td></tr><tr class="hit"><td class="line">202</td><td class="hits">80</td><td class="source">        if(!tags || tags.length &lt;=0) return done();</td></tr><tr class="miss"><td class="line">203</td><td class="hits">0</td><td class="source">        var key = (id_or_email.indexOf(&quot;@&quot;) == -1) ? &quot;user_ids&quot; : &quot;emails&quot;;</td></tr><tr><td class="line">204</td><td class="hits"></td><td class="source">        //nock.recorder.rec(true);  </td></tr><tr class="miss"><td class="line">205</td><td class="hits">0</td><td class="source">        var data = {</td></tr><tr><td class="line">206</td><td class="hits"></td><td class="source">                &quot;tag_or_untag&quot; : &quot;untag&quot;</td></tr><tr><td class="line">207</td><td class="hits"></td><td class="source">            };</td></tr><tr class="miss"><td class="line">208</td><td class="hits">0</td><td class="source">        data[key] = [id_or_email];</td></tr><tr class="miss"><td class="line">209</td><td class="hits">0</td><td class="source">        async.each(tags, function(tag, cb){</td></tr><tr class="miss"><td class="line">210</td><td class="hits">0</td><td class="source">            data.name = tag;</td></tr><tr><td class="line">211</td><td class="hits"></td><td class="source">            //console.log(&quot;sending tags: &quot; + data.name);</td></tr><tr class="miss"><td class="line">212</td><td class="hits">0</td><td class="source">            intercom.tags.post(data,function(code, body){</td></tr><tr><td class="line">213</td><td class="hits"></td><td class="source">                //console.log(&quot;nockcalls: &quot; + nock.recorder.play()); </td></tr><tr class="miss"><td class="line">214</td><td class="hits">0</td><td class="source">                if(code &gt;= 200 &amp;&amp; code &lt; 300) {</td></tr><tr class="miss"><td class="line">215</td><td class="hits">0</td><td class="source">                    cb();</td></tr><tr><td class="line">216</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="miss"><td class="line">217</td><td class="hits">0</td><td class="source">                    console.log(&quot;error untagging: &quot; + body.toString());</td></tr><tr class="miss"><td class="line">218</td><td class="hits">0</td><td class="source">                    cb();</td></tr><tr><td class="line">219</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">220</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">221</td><td class="hits"></td><td class="source">        }, function(err){</td></tr><tr><td class="line">222</td><td class="hits"></td><td class="source">            </td></tr><tr class="miss"><td class="line">223</td><td class="hits">0</td><td class="source">            if(err) return done(err);</td></tr><tr class="miss"><td class="line">224</td><td class="hits">0</td><td class="source">            return done();</td></tr><tr><td class="line">225</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">226</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">227</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">228</td><td class="hits">1</td><td class="source">    var _getTag = function(tag, done) {</td></tr><tr class="miss"><td class="line">229</td><td class="hits">0</td><td class="source">        intercom.tags.get(tag,function(code, body){</td></tr><tr><td class="line">230</td><td class="hits"></td><td class="source">            //console.log(&quot;nockcalls: &quot; + nock.recorder.play()); </td></tr><tr class="miss"><td class="line">231</td><td class="hits">0</td><td class="source">            if(code &gt;= 200 &amp;&amp; code &lt; 300) {</td></tr><tr class="miss"><td class="line">232</td><td class="hits">0</td><td class="source">                done(body);</td></tr><tr><td class="line">233</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="miss"><td class="line">234</td><td class="hits">0</td><td class="source">                console.log(&quot;error getting tags: %j&quot;,body);</td></tr><tr class="miss"><td class="line">235</td><td class="hits">0</td><td class="source">                done(body);</td></tr><tr><td class="line">236</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">237</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">238</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">239</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">240</td><td class="hits">1</td><td class="source">    var _userExists = function(id_or_email, done) {</td></tr><tr><td class="line">241</td><td class="hits"></td><td class="source">        //nock.recorder.rec(true);  </td></tr><tr class="hit"><td class="line">242</td><td class="hits">113</td><td class="source">        intercom.users.get(id_or_email, function(code, body){</td></tr><tr class="hit"><td class="line">243</td><td class="hits">113</td><td class="source">            if(body) {</td></tr><tr><td class="line">244</td><td class="hits"></td><td class="source">                //console.log(&quot;nockcalls: &quot; + nock.recorder.play());  </td></tr><tr class="hit"><td class="line">245</td><td class="hits">113</td><td class="source">                JSONUtils.safeParse(body.toString(), function(err, response){</td></tr><tr class="hit"><td class="line">246</td><td class="hits">113</td><td class="source">                    if(err) return done(false);</td></tr><tr><td class="line">247</td><td class="hits"></td><td class="source">                    // console.log(&quot;user: %j&quot;, response);</td></tr><tr class="hit"><td class="line">248</td><td class="hits">113</td><td class="source">                    if(code &gt;= 200 &amp;&amp; code &lt; 300) {</td></tr><tr class="hit"><td class="line">249</td><td class="hits">74</td><td class="source">                        return done(true, response);</td></tr><tr class="hit"><td class="line">250</td><td class="hits">39</td><td class="source">                    } else if (code == 404 &amp;&amp; response.error.type == &quot;not_found&quot;) {</td></tr><tr><td class="line">251</td><td class="hits"></td><td class="source">                        // console.log(&quot;intercom user not found: &quot; + id_or_email);</td></tr><tr class="hit"><td class="line">252</td><td class="hits">38</td><td class="source">                        return done(false, null);</td></tr><tr><td class="line">253</td><td class="hits"></td><td class="source">                    } else {</td></tr><tr><td class="line">254</td><td class="hits"></td><td class="source">                        // console.log(&quot;error finding intercom user: &quot; + id_or_email + &quot;, code: &quot; + code +&quot;, error: &quot; + response.error);</td></tr><tr class="hit"><td class="line">255</td><td class="hits">1</td><td class="source">                        return done(false, null);</td></tr><tr><td class="line">256</td><td class="hits"></td><td class="source">                    }</td></tr><tr><td class="line">257</td><td class="hits"></td><td class="source">                });</td></tr><tr><td class="line">258</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="miss"><td class="line">259</td><td class="hits">0</td><td class="source">                return done(false);</td></tr><tr><td class="line">260</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">261</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">262</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">263</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">264</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">265</td><td class="hits">1</td><td class="source">    var _deleteUsers = function(users, done) {</td></tr><tr class="hit"><td class="line">266</td><td class="hits">1</td><td class="source">        var data = {};</td></tr><tr class="hit"><td class="line">267</td><td class="hits">1</td><td class="source">        async.each(users, function(user, cb){</td></tr><tr class="hit"><td class="line">268</td><td class="hits">20</td><td class="source">            data.email = user;</td></tr><tr><td class="line">269</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">270</td><td class="hits">20</td><td class="source">            intercom.users.delete(data,function(code, body){</td></tr><tr class="hit"><td class="line">271</td><td class="hits">20</td><td class="source">                if(code &gt;= 200 &amp;&amp; code &lt; 300) {</td></tr><tr class="hit"><td class="line">272</td><td class="hits">1</td><td class="source">                    cb();</td></tr><tr><td class="line">273</td><td class="hits"></td><td class="source">                } else {</td></tr><tr><td class="line">274</td><td class="hits"></td><td class="source">                    // console.log(&quot;error deleting: %j&quot;, body);</td></tr><tr class="hit"><td class="line">275</td><td class="hits">19</td><td class="source">                    cb();</td></tr><tr><td class="line">276</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">277</td><td class="hits"></td><td class="source">            });</td></tr><tr><td class="line">278</td><td class="hits"></td><td class="source">        }, function(err){</td></tr><tr class="hit"><td class="line">279</td><td class="hits">1</td><td class="source">            if(err) return done(err);</td></tr><tr><td class="line">280</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">281</td><td class="hits">1</td><td class="source">            return done();</td></tr><tr><td class="line">282</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">283</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">284</td><td class="hits"></td><td class="source">    </td></tr><tr class="hit"><td class="line">285</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">286</td><td class="hits"></td><td class="source">        newWaitingListUser: _newWaitingListUser,</td></tr><tr><td class="line">287</td><td class="hits"></td><td class="source">        newUser: _newUser,</td></tr><tr><td class="line">288</td><td class="hits"></td><td class="source">        updateUser: _updateUser,</td></tr><tr><td class="line">289</td><td class="hits"></td><td class="source">        updateWaitingUser: _changeWaitingUserToRegularUser,</td></tr><tr><td class="line">290</td><td class="hits"></td><td class="source">        tagUser: _tagUser,</td></tr><tr><td class="line">291</td><td class="hits"></td><td class="source">        untagUser: _untagUser,</td></tr><tr><td class="line">292</td><td class="hits"></td><td class="source">        getTag : _getTag,</td></tr><tr><td class="line">293</td><td class="hits"></td><td class="source">        userExists: _userExists,</td></tr><tr><td class="line">294</td><td class="hits"></td><td class="source">        deleteUsers: _deleteUsers</td></tr><tr><td class="line">295</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">296</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">297</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">298</td><td class="hits">1</td><td class="source">module.exports = IntercomUtils;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/utils/json.js">/Users/warner/code/clipppr/primeloop-api/utils/json.js</h2><div id="stats" class="high"><div class="percentage">88%</div><div class="sloc">17</div><div class="hits">15</div><div class="misses">2</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var JSONUtils = function(){</td></tr><tr class="hit"><td class="line">2</td><td class="hits">1</td><td class="source">    var _safeParse = function(str, done){</td></tr><tr class="hit"><td class="line">3</td><td class="hits">309</td><td class="source">        var result;</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">5</td><td class="hits">309</td><td class="source">        try {</td></tr><tr class="hit"><td class="line">6</td><td class="hits">309</td><td class="source">            result = JSON.parse(str);</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        } catch(error){</td></tr><tr class="hit"><td class="line">8</td><td class="hits">2</td><td class="source">            if(done) done(error);</td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">            return error;</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">616</td><td class="source">        if(done) done(null, result);</td></tr><tr class="hit"><td class="line">13</td><td class="hits">308</td><td class="source">        return result;</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">16</td><td class="hits">1</td><td class="source">    var _tryParseJSON = function(jsonString){</td></tr><tr class="hit"><td class="line">17</td><td class="hits">9</td><td class="source">        try {</td></tr><tr class="hit"><td class="line">18</td><td class="hits">9</td><td class="source">            var o = JSON.parse(jsonString);</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">            // Handle non-exception-throwing cases:</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">            // Neither JSON.parse(false) or JSON.parse(1234) throw errors, hence the type-checking,</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">            // but... JSON.parse(null) returns 'null', and typeof null === &quot;object&quot;, </td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">            // so we must check for that, too.</td></tr><tr class="miss"><td class="line">24</td><td class="hits">0</td><td class="source">            if (o &amp;&amp; typeof o === &quot;object&quot; &amp;&amp; o !== null) {</td></tr><tr class="miss"><td class="line">25</td><td class="hits">0</td><td class="source">                return o;</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">        catch (e) { }</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">9</td><td class="source">        return false;</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">33</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        safeParse: _safeParse,</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        tryParseJSON: _tryParseJSON</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">39</td><td class="hits">1</td><td class="source">module.exports = JSONUtils;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/utils/objects.js">/Users/warner/code/clipppr/primeloop-api/utils/objects.js</h2><div id="stats" class="high"><div class="percentage">83%</div><div class="sloc">37</div><div class="hits">31</div><div class="misses">6</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var ObjectUtils = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">    </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var _isEmpty = function(map){</td></tr><tr class="hit"><td class="line">4</td><td class="hits">49</td><td class="source">        for(var key in map) {</td></tr><tr class="hit"><td class="line">5</td><td class="hits">46</td><td class="source">            if (map.hasOwnProperty(key)) {</td></tr><tr class="hit"><td class="line">6</td><td class="hits">46</td><td class="source">                return false;</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">9</td><td class="hits">3</td><td class="source">        return true;</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">12</td><td class="hits">1</td><td class="source">    var _copyAllProperties = function(obj, dest) {</td></tr><tr class="hit"><td class="line">13</td><td class="hits">240</td><td class="source">        if(obj &amp;&amp; !dest) dest = {};</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">15</td><td class="hits">178</td><td class="source">        for(var property in obj) {</td></tr><tr class="hit"><td class="line">16</td><td class="hits">10689</td><td class="source">            if(obj.hasOwnProperty(property)) {</td></tr><tr class="hit"><td class="line">17</td><td class="hits">1885</td><td class="source">                if(typeof obj[property] == &quot;object&quot;){</td></tr><tr class="hit"><td class="line">18</td><td class="hits">132</td><td class="source">                    dest[property] = _copyAllProperties(obj[property], dest[property]);</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="hit"><td class="line">20</td><td class="hits">1753</td><td class="source">                    dest[property] = obj[property];</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">24</td><td class="hits">178</td><td class="source">        return dest;</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">26</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source">    /* This will take an object and convert sub-objects into key/value pairs</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    */</td></tr><tr class="hit"><td class="line">29</td><td class="hits">1</td><td class="source">    var _flattenObject = function(obj, depth, prevProperty, flatObj) {</td></tr><tr class="hit"><td class="line">30</td><td class="hits">231</td><td class="source">        if(!flatObj) flatObj = {};</td></tr><tr class="hit"><td class="line">31</td><td class="hits">178</td><td class="source">        if(!depth) {</td></tr><tr class="hit"><td class="line">32</td><td class="hits">53</td><td class="source">            depth = 0;</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        }</td></tr><tr class="hit"><td class="line">34</td><td class="hits">178</td><td class="source">        for(var property in obj) {</td></tr><tr class="hit"><td class="line">35</td><td class="hits">8317</td><td class="source">            var propertyName = &quot;&quot;;</td></tr><tr class="hit"><td class="line">36</td><td class="hits">8317</td><td class="source">            if(prevProperty) {</td></tr><tr class="hit"><td class="line">37</td><td class="hits">8310</td><td class="source">                propertyName = prevProperty + &quot;_&quot; + property;</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source">            } else {</td></tr><tr class="hit"><td class="line">39</td><td class="hits">7</td><td class="source">                propertyName = property;</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">            }</td></tr><tr class="hit"><td class="line">41</td><td class="hits">8317</td><td class="source">            if(obj.hasOwnProperty(property)) {</td></tr><tr class="hit"><td class="line">42</td><td class="hits">2921</td><td class="source">                if(typeof obj[property] == &quot;object&quot;){</td></tr><tr class="hit"><td class="line">43</td><td class="hits">125</td><td class="source">                    _flattenObject(obj[property], depth+1, propertyName, flatObj);</td></tr><tr><td class="line">44</td><td class="hits"></td><td class="source">                } else {</td></tr><tr class="hit"><td class="line">45</td><td class="hits">2796</td><td class="source">                    flatObj[propertyName] = obj[property];</td></tr><tr><td class="line">46</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">47</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">48</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">49</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">50</td><td class="hits">178</td><td class="source">        return flatObj;</td></tr><tr><td class="line">51</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">53</td><td class="hits">1</td><td class="source">    var _toFlatArray = function(arr, key){</td></tr><tr class="miss"><td class="line">54</td><td class="hits">0</td><td class="source">        var obj, result = [];</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">56</td><td class="hits">0</td><td class="source">        arr = (arr &amp;&amp; arr.toObject) ? arr.toObject() : arr;</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">58</td><td class="hits">0</td><td class="source">        for(var i in arr) {</td></tr><tr class="miss"><td class="line">59</td><td class="hits">0</td><td class="source">            obj = (arr[i].toObject) ? arr[i].toObject() : arr[i];</td></tr><tr class="miss"><td class="line">60</td><td class="hits">0</td><td class="source">            if(obj[key]) result.push(obj[key]);</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source"> </td></tr><tr class="miss"><td class="line">63</td><td class="hits">0</td><td class="source">        return result;</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source">       </td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">67</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">68</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">69</td><td class="hits"></td><td class="source">        isEmpty: _isEmpty,</td></tr><tr><td class="line">70</td><td class="hits"></td><td class="source">        copyAllProperties: _copyAllProperties,</td></tr><tr><td class="line">71</td><td class="hits"></td><td class="source">        flattenObject:_flattenObject,</td></tr><tr><td class="line">72</td><td class="hits"></td><td class="source">        toFlatArray: _toFlatArray</td></tr><tr><td class="line">73</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">74</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">75</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">76</td><td class="hits">1</td><td class="source">module.exports = ObjectUtils;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/utils/permissions.js">/Users/warner/code/clipppr/primeloop-api/utils/permissions.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">29</div><div class="hits">29</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var PermissionsUtils = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">    </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        Settings = require(&quot;/Users/warner/code/clipppr/primeloop-api/utils/../config/settings&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        notebooksPerms = Settings.notebooks.permissions,</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        clientPerms = Settings.clients.permissions,</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        userPerms = Settings.users.permissions;</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    var _getUserPermissionsForRole = function(role) {</td></tr><tr class="hit"><td class="line">11</td><td class="hits">150</td><td class="source">        if(!userPerms[role]) return [];</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">13</td><td class="hits">150</td><td class="source">        var permissions = userPerms[role].permissions  || [];</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">15</td><td class="hits">150</td><td class="source">        if(userPerms[role].inherits) {</td></tr><tr class="hit"><td class="line">16</td><td class="hits">99</td><td class="source">            for(var i = 0; i &lt; userPerms[role].inherits.length; i++) {</td></tr><tr class="hit"><td class="line">17</td><td class="hits">298</td><td class="source">                var addPerms = userPerms[userPerms[role].inherits[i]].permissions;</td></tr><tr class="hit"><td class="line">18</td><td class="hits">298</td><td class="source">                permissions = permissions.concat(addPerms);</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">20</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">22</td><td class="hits">150</td><td class="source">        return permissions;</td></tr><tr><td class="line">23</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">25</td><td class="hits">1</td><td class="source">    var _getClientPermissions = function(client) {</td></tr><tr class="hit"><td class="line">26</td><td class="hits">1</td><td class="source">        if(!clientPerms[client]) return [];</td></tr><tr><td class="line">27</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">28</td><td class="hits">1</td><td class="source">        var permissions = clientPerms[client].permissions  || [];</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">        if(clientPerms[client].inherits) {</td></tr><tr class="hit"><td class="line">31</td><td class="hits">1</td><td class="source">            for(var i = 0; i &lt; clientPerms[client].inherits.length; i++) {</td></tr><tr class="hit"><td class="line">32</td><td class="hits">1</td><td class="source">                var addPerms = clientPerms[clientPerms[client].inherits[i]].permissions;</td></tr><tr class="hit"><td class="line">33</td><td class="hits">1</td><td class="source">                permissions = permissions.concat(addPerms);</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source">        </td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">        // console.log(&quot;client permissions: &quot; + JSON.stringify(permissions));</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">39</td><td class="hits">1</td><td class="source">        return permissions;</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">41</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">42</td><td class="hits">1</td><td class="source">    var _getNotebookPermissionsForRole = function(role) {</td></tr><tr><td class="line">43</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">44</td><td class="hits">43</td><td class="source">        var permissions = [];</td></tr><tr><td class="line">45</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">46</td><td class="hits">43</td><td class="source">        if(notebooksPerms[role]) {</td></tr><tr class="hit"><td class="line">47</td><td class="hits">43</td><td class="source">            permissions = notebooksPerms[role].permissions;</td></tr><tr class="hit"><td class="line">48</td><td class="hits">43</td><td class="source">            if(notebooksPerms[role].inherits) {</td></tr><tr class="hit"><td class="line">49</td><td class="hits">40</td><td class="source">                for(var i = 0; i &lt; notebooksPerms[role].inherits.length; i++) {</td></tr><tr class="hit"><td class="line">50</td><td class="hits">79</td><td class="source">                    var addPerms = notebooksPerms[notebooksPerms[role].inherits[i]].permissions;</td></tr><tr class="hit"><td class="line">51</td><td class="hits">79</td><td class="source">                    permissions = permissions.concat(addPerms);</td></tr><tr><td class="line">52</td><td class="hits"></td><td class="source">                }</td></tr><tr><td class="line">53</td><td class="hits"></td><td class="source">            }</td></tr><tr><td class="line">54</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">55</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">56</td><td class="hits">43</td><td class="source">        return permissions;</td></tr><tr><td class="line">57</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">58</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">59</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">60</td><td class="hits"></td><td class="source">        getUserPermissionsForRole: _getUserPermissionsForRole,</td></tr><tr><td class="line">61</td><td class="hits"></td><td class="source">        getNotebookPermissionsForRole: _getNotebookPermissionsForRole,</td></tr><tr><td class="line">62</td><td class="hits"></td><td class="source">        getClientPermissions: _getClientPermissions</td></tr><tr><td class="line">63</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">64</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">65</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">66</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">67</td><td class="hits">1</td><td class="source">module.exports = PermissionsUtils;</td></tr><tr><td class="line">68</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/utils/smart_quote_removal.js">/Users/warner/code/clipppr/primeloop-api/utils/smart_quote_removal.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">8</div><div class="hits">8</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var SmartQuoteRemovalUtils = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var _sqRemove = function(stringToFix) {</td></tr><tr class="hit"><td class="line">4</td><td class="hits">3</td><td class="source">        s = stringToFix;</td></tr><tr class="hit"><td class="line">5</td><td class="hits">3</td><td class="source">        s = s.replace( /\u2018|\u2019|\u201A|\uFFFD/g, &quot;\'&quot; );</td></tr><tr class="hit"><td class="line">6</td><td class="hits">3</td><td class="source">        s = s.replace( /\u201c|\u201d|\u201e/g, '\&quot;' );</td></tr><tr class="hit"><td class="line">7</td><td class="hits">3</td><td class="source">        return s;</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        sqRemove: _sqRemove</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">module.exports = SmartQuoteRemovalUtils;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/utils/string.js">/Users/warner/code/clipppr/primeloop-api/utils/string.js</h2><div id="stats" class="medium"><div class="percentage">66%</div><div class="sloc">6</div><div class="hits">4</div><div class="misses">2</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var StringUtils = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">    </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var _toProperCase = function(str){</td></tr><tr class="miss"><td class="line">4</td><td class="hits">0</td><td class="source">        return str.replace(/\w\S*/g, function(txt){</td></tr><tr class="miss"><td class="line">5</td><td class="hits">0</td><td class="source">            return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        });</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">9</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">        toProperCase: _toProperCase </td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">14</td><td class="hits">1</td><td class="source">module.exports = StringUtils;</td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/utils/urls.js">/Users/warner/code/clipppr/primeloop-api/utils/urls.js</h2><div id="stats" class="high"><div class="percentage">75%</div><div class="sloc">16</div><div class="hits">12</div><div class="misses">4</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var URLUtils = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">   var</td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        URL = require(&quot;url&quot;),</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        crypto = require('crypto'),</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        qs = require(&quot;querystring&quot;),</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source">        url2pngApiKey = &quot;P51BA73EF295D6&quot;,</td></tr><tr><td class="line">8</td><td class="hits"></td><td class="source">        url2pngSecretKey= &quot;SD58D934F01832&quot;;</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">10</td><td class="hits">1</td><td class="source">    var _getSiteFromURL = function (url) {</td></tr><tr class="hit"><td class="line">11</td><td class="hits">1093</td><td class="source">        var parsedURL = URL.parse(url);</td></tr><tr class="hit"><td class="line">12</td><td class="hits">1093</td><td class="source">        return parsedURL.protocol + &quot;//&quot; + parsedURL.host;</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">15</td><td class="hits">1</td><td class="source">    var _getNakedDomain = function(url) {</td></tr><tr class="hit"><td class="line">16</td><td class="hits">1093</td><td class="source">        return URL.parse(url).host.replace(/^www\./,'');</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">19</td><td class="hits">1</td><td class="source">    var _url2png = function(url, width) {</td></tr><tr class="miss"><td class="line">20</td><td class="hits">0</td><td class="source">        var urlQuery = &quot;?url=&quot; + encodeURIComponent(url) + &quot;&amp;viewport=1024x768&amp;thumbnail_max_width=&quot; + width;</td></tr><tr class="miss"><td class="line">21</td><td class="hits">0</td><td class="source">        var urlToken = crypto.createHash('md5').update(urlQuery + url2pngSecretKey).digest(&quot;hex&quot;);</td></tr><tr class="miss"><td class="line">22</td><td class="hits">0</td><td class="source">        var url2png = &quot;https://beta.url2png.com/v6/&quot; + url2pngApiKey + &quot;/&quot; + urlToken + &quot;/png/&quot; + urlQuery;</td></tr><tr class="miss"><td class="line">23</td><td class="hits">0</td><td class="source">        return url2png;</td></tr><tr><td class="line">24</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">25</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">26</td><td class="hits">1</td><td class="source">    var _urlToHash = function(url) {</td></tr><tr class="hit"><td class="line">27</td><td class="hits">57</td><td class="source">        return crypto.createHash('md5').update(url).digest(&quot;hex&quot;);</td></tr><tr><td class="line">28</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">29</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">30</td><td class="hits">1</td><td class="source">    return {</td></tr><tr><td class="line">31</td><td class="hits"></td><td class="source">        getSiteFromURL: _getSiteFromURL,</td></tr><tr><td class="line">32</td><td class="hits"></td><td class="source">        getNakedDomain: _getNakedDomain,</td></tr><tr><td class="line">33</td><td class="hits"></td><td class="source">        url2png: _url2png,</td></tr><tr><td class="line">34</td><td class="hits"></td><td class="source">        urlToHash: _urlToHash</td></tr><tr><td class="line">35</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">36</td><td class="hits"></td><td class="source"> </td></tr><tr><td class="line">37</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">38</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">39</td><td class="hits">1</td><td class="source">module.exports = URLUtils;</td></tr><tr><td class="line">40</td><td class="hits"></td><td class="source"> </td></tr></tbody></table></div><div class="file"><h2 id="/Users/warner/code/clipppr/primeloop-api/utils/validations.js">/Users/warner/code/clipppr/primeloop-api/utils/validations.js</h2><div id="stats" class="high"><div class="percentage">100%</div><div class="sloc">6</div><div class="hits">6</div><div class="misses">0</div></div><table id="source"><thead><tr><th>Line</th><th>Hits</th><th>Source</th></tr></thead><tbody><tr class="hit"><td class="line">1</td><td class="hits">1</td><td class="source">var ValidationsUtil = function(){</td></tr><tr><td class="line">2</td><td class="hits"></td><td class="source">    </td></tr><tr class="hit"><td class="line">3</td><td class="hits">1</td><td class="source">    var </td></tr><tr><td class="line">4</td><td class="hits"></td><td class="source">        validate = require(&quot;mongoose-validator&quot;).validate,</td></tr><tr><td class="line">5</td><td class="hits"></td><td class="source">        validations,</td></tr><tr><td class="line">6</td><td class="hits"></td><td class="source">        check = require('validator').check;</td></tr><tr><td class="line">7</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">8</td><td class="hits">1</td><td class="source">    validations = {</td></tr><tr><td class="line">9</td><td class="hits"></td><td class="source">        url: validate({</td></tr><tr><td class="line">10</td><td class="hits"></td><td class="source">            message: &quot;Invalid url&quot;</td></tr><tr><td class="line">11</td><td class="hits"></td><td class="source">        }, &quot;isUrl&quot;),</td></tr><tr><td class="line">12</td><td class="hits"></td><td class="source">        email: validate({</td></tr><tr><td class="line">13</td><td class="hits"></td><td class="source">            message: &quot;Invalid email address&quot;</td></tr><tr><td class="line">14</td><td class="hits"></td><td class="source">        }, &quot;isEmail&quot;),</td></tr><tr><td class="line">15</td><td class="hits"></td><td class="source">        checkUrl: function (url){</td></tr><tr class="hit"><td class="line">16</td><td class="hits">12</td><td class="source">            check(url).isUrl();</td></tr><tr><td class="line">17</td><td class="hits"></td><td class="source">        }</td></tr><tr><td class="line">18</td><td class="hits"></td><td class="source">    };</td></tr><tr><td class="line">19</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">20</td><td class="hits">1</td><td class="source">    return validations;</td></tr><tr><td class="line">21</td><td class="hits"></td><td class="source">}();</td></tr><tr><td class="line">22</td><td class="hits"></td><td class="source"> </td></tr><tr class="hit"><td class="line">23</td><td class="hits">1</td><td class="source">module.exports = ValidationsUtil;</td></tr></tbody></table></div></div></div></body></html>